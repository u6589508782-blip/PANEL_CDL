<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>CDL · Panel de control</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --brand:#E43B3B;        /* rojo corporativo */
  --ink:#0f172a;          /* texto principal */
  --muted:#475569;        /* texto suave */
  --line:#e5e7eb;         /* líneas finas */
  --bg:#ffffff;           /* fondo general blanco */
  --hdr-h:96px;           /* altura cabecera */
  --radius:18px;
}

/* Reset */
*{box-sizing:border-box}
html,body{height:100%; background:#fff; overflow-x:hidden}
body{margin:0; font-family:Inter,system-ui,sans-serif; color:var(--ink)}
a{color:inherit; text-decoration:none}
img{display:block; max-width:100%}
button{font-family:inherit}

/* ===== Header (como cdl.es: blanco, limpio) ===== */
.header{
  position:sticky; top:0; z-index:1000; background:#fff;
  border-bottom:1px solid #eee; transition:box-shadow .25s ease;
}
.header.scrolled{ box-shadow:0 6px 14px rgba(0,0,0,.06) }
.h__in{
  height:var(--hdr-h);
  display:grid; grid-template-columns:auto 1fr auto; align-items:end;
  gap:12px; padding:10px 16px 12px;
}

/* Marca: SOLO el logo CDL (sin texto) */
.brand{ display:flex; align-items:flex-end; gap:10px; margin-left:6px }
.brand img{height:40px}

/* Chip de rol discreto */
#roleChip{position:absolute; right:16px; top:8px; font-weight:800; font-size:12px; color:#0f172a}

/* Botones cabecera minimalistas */
.hbtn{width:44px; height:44px; display:grid; place-items:center; background:transparent; border:0; padding:0; color:#0f172a}
#hamb .i{width:22px; height:16px; position:relative; display:inline-block}
#hamb .i:before,#hamb .i:after,#hamb .i span{
  content:""; position:absolute; left:0; right:0; height:2px; background:#0f172a; border-radius:2px;
}
#hamb .i:before{top:0} #hamb .i span{top:7px} #hamb .i:after{bottom:0}
#moreBtn .i{display:inline-block; width:18px; text-align:center; letter-spacing:2px; font-weight:800}
#moreBtn .i::before{content:"···"} /* símbolos simples, sin emojis */

/* ===== SideNav (pantalla completa bajo cabecera) ===== */
#sidenav{
  position:fixed; inset:var(--hdr-h) 0 0 0; background:#fff; color:#0f172a;
  transform:translateX(-100%); transition:transform .25s ease; z-index:900; box-shadow:4px 0 24px rgba(0,0,0,.08);
}
#sidenav.open{transform:none}
.sidenav__head{display:flex; align-items:center; gap:12px; padding:14px 16px}
.sidenav__head img{height:56px} /* logo_mantenimiento.png grande y nítido */
#closeNav{margin-left:auto; width:40px; height:40px; background:transparent; border:0; font-size:22px; cursor:pointer}
.sidenav__search{padding:0 16px 10px}
.sidenav__search input{width:100%; padding:12px 14px; border:1px solid #e5e7eb; border-radius:12px; font-weight:600}

/* Lista navegación */
.navlist{padding:6px 0}
.navlist a{
  display:block; padding:16px; font-weight:800; text-transform:uppercase; outline:none;
}
.navlist a:not(:last-child){position:relative}
.navlist a:not(:last-child)::after{
  content:""; position:absolute; left:10%; right:10%; bottom:-1px; height:1.5px;
  background:linear-gradient(90deg,rgba(0,0,0,0),rgba(15,23,42,.25) 50%,rgba(0,0,0,0));
}
.navlist a[aria-current="page"]{
  background:#f6f8fb; box-shadow:inset 4px 0 0 var(--brand);
}

/* Fondo desenfocado cuando el menú está abierto (no tapa cabecera) */
body.menu-open::after{
  content:""; position:fixed; inset:var(--hdr-h) 0 0 0; backdrop-filter:blur(4px); background:rgba(0,0,0,.18); z-index:800;
}

/* ===== Panel usuario (debajo cabecera) ===== */
#userPanel{
  position:fixed; right:12px; top:calc(var(--hdr-h) + 10px);
  width:360px; max-width:calc(100vw - 24px);
  background:#0f141c; color:#e6eef7;
  border:1px solid #223046; border-radius:16px; box-shadow:0 20px 36px rgba(0,0,0,.45);
  padding:14px; display:none; z-index:950;
}
#userPanel.show{display:block}
#userPanel .up__head{display:flex; align-items:center; justify-content:space-between; margin-bottom:6px}
#userPanel h3{margin:0; font-size:14px}
#closeUser{background:transparent; border:0; font-size:22px; color:#e6eef7; cursor:pointer}
#userPanel label{display:block; font-size:12px; color:#9fb0c6; margin:10px 0 6px}
#userPanel select,#userPanel input{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #243046; background:#0b101a; color:#e6eef7}

/* Ojo (símbolo simple, no emoji) */
.eyeBtn{position:absolute; right:12px; top:38px; width:24px; height:24px; border:0; background:transparent; cursor:pointer; padding:0}
.eyeBtn svg{width:22px; height:22px; fill:none; stroke:#cbd5e1; stroke-width:2}

/* ===== Títulos con angular (solo donde interese) ===== */
h1,h2,h3{
  position:relative; margin:22px 0 12px; padding-left:46px; line-height:1.12;
  white-space:nowrap; overflow:visible; text-overflow:ellipsis;
}
h1::before,h2::before,h3::before{
  content:""; position:absolute; left:0; bottom:.66em;
  width:30px; height:30px; background:url("angular.png") left bottom/contain no-repeat;
}
/* Quita angular en títulos de tarjetas dashboard */
.card .card__title{ padding-left:0 }
.card .card__title::before{ display:none }

/* ===== Utilidades de layout ===== */
.main{padding:16px; max-width:1100px; margin:0 auto}
.sep{height:1px; margin:22px 0; background:linear-gradient(90deg,rgba(15,23,42,0),rgba(15,23,42,.22) 50%,rgba(15,23,42,0))}
.card{background:#fff; border:1px solid var(--line); border-radius:18px; padding:14px; box-shadow:0 4px 12px rgba(0,0,0,.06)}
.grid{display:grid; gap:16px}

/* Botones */
.btn{border:0; border-radius:999px; padding:10px 14px; font-weight:700; cursor:pointer; transition:transform .06s ease, box-shadow .12s ease}
.btn:hover{ transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,.08) }
.btn:active{ transform:translateY(0); box-shadow:0 2px 8px rgba(0,0,0,.08) }
.btn--primary{background:var(--brand); color:#fff}
.btn--ghost{background:#0b101a; color:#e6eef7; border:1px solid #243046}

/* Píldoras estado */
.pill{display:inline-block; padding:4px 10px; font-weight:800; border-radius:999px; font-size:12px; border:1px solid var(--line); background:#eef2f7; color:#334155}
.pill--ok{    background:#e7f7ee; border-color:#c7ecd8; color:#166534 }
.pill--warn{  background:#fff4e5; border-color:#ffe1bd; color:#92400e }
.pill--stop{  background:#fdecec; border-color:#f9caca; color:#991b1b }
.pill--info{  background:#eef2ff; border-color:#dbe3ff; color:#1e3a8a }

/* Badges */
.badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-weight:800; font-size:12px; background:#eef2f7; color:#334155; border:1px solid #e2e8f0 }
/* Utilidades de color usadas en los títulos */
.red{color:var(--brand)!important}
.black{color:var(--ink)!important}

/* Skeleton loader que usas en el menú */
.skel{
  background:linear-gradient(90deg,#eee 20%,#f6f7f8 40%,#eee 60%);
  background-size:200% 100%;
  animation:shimmer 1.2s infinite;
}
@keyframes shimmer{
  0%{background-position:-200% 0}
  100%{background-position:200% 0}
}

/* Grid de categorías en Inventario */
.catgrid{
  display:grid;
  gap:12px;
  grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
}

/* ===== Dashboard ===== */
.dash-grid{ gap:20px }
.card--dash{ background:transparent; border:0; box-shadow:none; padding:6px 0 }
.card__title.big{ font-size:18px; font-weight:900; letter-spacing:.3px; padding-left:0 }
.card__title.big .badge{ margin-left:10px }
.dash-list .line-1{ padding:8px 12px; border:1px dashed var(--line); border-radius:12px; margin:8px 0; font-weight:600 }

/* Hero del dashboard (tarjeta destacada) */
.hero{
  background:linear-gradient(180deg,#fff, #f8fafc);
  border:1px solid #eef2f7; padding:20px; border-radius:20px;
}
.hero h1{ margin:0; padding-left:0 }
.hero h1::before{ display:none }
.hero .sub{ color:#64748b; font-weight:800; margin-top:4px }

/* ===== Equipos ===== */
.kalt-title{ margin:8px 0 16px }
.eq-grid{ grid-template-columns:1fr; gap:14px }
.eq-head{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between }
.eq-estado{ margin-bottom:6px; color:#64748b; font-weight:700 }
.eq-nombre{ font-weight:900; font-size:20px; letter-spacing:.2px }
.eq-meta{ color:#94a3b8 }
.actions.wrap{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px }

/* Semáforo */
.semaforo{ display:flex; flex-direction:column; gap:8px }
.bulb{
  width:24px; height:24px; border-radius:50%;
  border:2px solid rgba(0,0,0,.15); background:#e5e7eb; cursor:pointer;
  box-shadow: inset 0 0 0 6px rgba(0,0,0,.06); transition:opacity .15s, box-shadow .15s, transform .05s;
}
.bulb:active{ transform:translateY(1px) }
.bulb--ok{   background:#22c55e }
.bulb--warn{ background:#f59e0b }
.bulb--stop{ background:#ef4444 }
.semaforo .bulb{ opacity:.45 }
.semaforo .bulb.is-active{ opacity:1; box-shadow:0 0 0 3px rgba(0,0,0,.12), inset 0 0 0 4px rgba(255,255,255,.45) }

/* Listas “una línea” */
.mono-list .line-1{ padding:10px 12px; border-bottom:1px solid var(--line) }
.mono-list .line-1:last-child{ border-bottom:0 }

/* Grid helpers */
.grid.two{ grid-template-columns:1fr 1fr; gap:12px }
.grid.onecol{ grid-template-columns:1fr; gap:14px }
.full{ grid-column:1/-1 }

/* Toolbars */
.toolbar{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px}
.searchbar{display:flex; gap:8px}

/* CTA incidencias */
.cta-centrado{ display:flex; justify-content:center; margin:10px 0 18px }
.btn-big{ padding:14px 22px; font-size:14px; letter-spacing:.4px }

/* Footer negro */
.footer-dark{ background:#0f141c; color:#f8fafc; padding:18px 16px; margin-top:26px }
.footer-in{ max-width:1100px; margin:0 auto }
.footer-actions{ margin-top:8px }
.footer-actions a{ color:#fff; text-decoration:underline }

/* Modales */
.modal-backdrop{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:980; background:rgba(0,0,0,.42)}
.modal-card{max-width:560px; width:92vw; border-radius:16px; position:relative}
.x-btn{position:absolute; right:10px; top:10px; border:0; background:transparent; font-size:22px; cursor:pointer}
.ficha-grid{ grid-template-columns:160px 1fr; align-items:center }
#fichaQR{ width:160px; height:160px; object-fit:contain; border:1px solid #e5e7eb; border-radius:12px }
.ficha-nombre{ font-weight:800; margin-bottom:8px }
.ta{ resize:vertical; padding:10px; border:1px solid #e5e7eb; border-radius:10px }

/* Accesibilidad: focus visible */
:focus-visible{ outline:3px solid rgba(228,59,59,.6); outline-offset:2px; border-radius:8px }

/* Responsivo */
@media (min-width:900px){
  .eq-grid{ grid-template-columns:repeat(2,1fr) }
  .dash-grid{ grid-template-columns:repeat(2,1fr) }
}
@media (min-width:1200px){
  .dash-grid{ grid-template-columns:repeat(3,1fr) }
}
</style>
</head>
<body>

<!-- ===== CABECERA BLANCA (solo logo CDL) ===== -->
<header class="header" id="hdr" role="banner">
  <span id="roleChip">Invitado</span>
  <div class="h__in">
    <button class="hbtn" id="hamb" aria-label="Abrir menú" aria-controls="sidenav" aria-expanded="false"><span class="i"><span></span></span></button>
    <a class="brand" aria-label="Inicio" href="#dashboard">
      <img src="logo-cdl.png" alt="CDL">
    </a>
    <button class="hbtn" id="moreBtn" aria-haspopup="dialog" aria-expanded="false" aria-controls="userPanel"><span class="i"></span></button>
  </div>
</header>

<!-- ===== SideNav (ocupa toda la pantalla bajo cabecera) ===== -->
<aside id="sidenav" aria-hidden="true" aria-label="Navegación principal">
  <div class="sidenav__head">
    <img src="logo_mantenimiento.png" alt="CDL Mantenimiento">
    <button id="closeNav" aria-label="Cerrar menú">✕</button>
  </div>
  <div class="sidenav__search">
    <input id="globalSearch" placeholder="Buscar en la app…" aria-label="Buscar">
  </div>
  <nav class="navlist" id="navList">
    <!-- items se inyectan por JS -->
    <div class="skel" style="height:44px; border-radius:10px; margin:8px 16px"></div>
    <div class="skel" style="height:44px; border-radius:10px; margin:8px 16px"></div>
    <div class="skel" style="height:44px; border-radius:10px; margin:8px 16px"></div>
  </nav>
</aside>

<!-- ===== Panel usuario ===== -->
<section id="userPanel" role="dialog" aria-modal="true" aria-labelledby="upTitle">
  <div class="up__head">
    <h3 id="upTitle">Acceso de usuario</h3>
    <button id="closeUser" aria-label="Cerrar">✕</button>
  </div>

  <label for="roleSelect">Rol</label>
  <select id="roleSelect">
    <option value="invitado" selected>Invitado</option>
    <option value="administrador">Administrador</option>
    <option value="gerente">Gerente</option>
    <option value="encargado">Encargado</option>
    <option value="resp_produccion">Responsable de producción</option>
    <option value="resp_turno">Responsable de turno</option>
    <option value="externa">Empresa externa</option>
  </select>

  <label for="userPass">Contraseña</label>
  <div style="position:relative">
    <input id="userPass" type="password" placeholder="contraseña" autocomplete="current-password" aria-describedby="pwdHelp">
    <button class="eyeBtn" id="toggleEye" aria-label="Mostrar/Ocultar contraseña">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
        <circle cx="12" cy="12" r="3.5"/>
      </svg>
    </button>
  </div>
  <div id="pwdHelp" style="color:#9fb0c6; font-size:12px; margin-top:4px">Introduce la clave según tu rol</div>

  <div style="display:flex; gap:8px; margin-top:12px">
    <button class="btn btn--primary" id="loginBtn">Acceder</button>
    <button class="btn btn--ghost" id="logoutBtn">Salir</button>
  </div>

  <h3 style="margin-top:14px">Cambiar contraseña</h3>
  <label for="chgOld">Actual</label>
  <input id="chgOld" type="password" autocomplete="current-password">
  <label for="chgNew">Nueva</label>
  <input id="chgNew" type="password" autocomplete="new-password">
  <button class="btn btn--ghost" id="chgBtn" style="margin-top:8px">Guardar nueva</button>
</section>

<!-- ===== MAIN ===== -->
<main class="main" id="appRoot">

  <!-- ===== DASHBOARD TV (HOME) ===== -->
  <section id="dashboard" class="page" aria-labelledby="dashTitle">
    <!-- Tarjeta hero con títulos -->
    <article class="hero">
      <h1 id="dashTitle"><span class="black">DASHBOARD</span> <span class="red">TV</span></h1>
      <div class="sub">Panel de control</div>
    </article>

    <div class="grid dash-grid" style="margin-top:10px">
      <article class="card card--dash">
        <h2 class="card__title big">EQUIPOS EN <span class="red">PARADA</span>
          <span class="badge" id="countParadas">0</span>
        </h2>
        <div id="dash-paradas" class="dash-list"></div>
      </article>

      <article class="card card--dash">
        <h2 class="card__title big">EQUIPOS CON <span class="red">RESTRICCIONES</span>
          <span class="badge" id="countRestr">0</span>
        </h2>
        <div id="dash-restr" class="dash-list"></div>
      </article>

      <article class="card card--dash">
        <h2 class="card__title big"><span class="black">ALERTAS</span> <span class="red">STOCK</span> <span class="black">MÍNIMO</span>
          <span class="badge" id="countStock">0</span>
        </h2>
        <div id="dash-stock" class="dash-list"></div>
      </article>

      <article class="card card--dash">
        <h2 class="card__title big"><span class="black">AVISOS</span> <span class="red">SUBCONTRATAS</span>
          <span class="badge" id="countExt">0</span>
        </h2>
        <div id="dash-externas" class="dash-list"></div>
      </article>

      <article class="card card--dash">
        <h2 class="card__title big"><span class="black">SOLICITUDES</span> <span class="red">PRIORITARIAS</span>
          <span class="badge" id="countReq">0</span>
        </h2>
        <div id="dash-req" class="dash-list"></div>
      </article>
    </div>
  </section>

  <hr class="sep">

  <!-- ===== EQUIPOS ===== -->
  <section id="equipos" hidden aria-labelledby="eqTitle">
    <h1 id="eqTitle"><span class="black">EQUIPOS</span></h1>

    <!-- Imagen Línea Kaltenbach como subrama -->
    <div class="kalt-title">
      <img src="linea-kaltenbach.png" alt="LÍNEA KALTENBACH">
    </div>

    <div id="equiposGrid" class="grid eq-grid"></div>
  </section>

  <hr class="sep">

  <!-- ===== PUENTES GRÚA ===== -->
  <section id="gruas" hidden aria-labelledby="grTitle">
    <h1 id="grTitle"><span class="black">PUENTES</span> <span class="red">GRÚA</span></h1>
    <div id="gruasList" class="grid onecol"></div>
  </section>

  <hr class="sep">

  <!-- ===== AUXILIARES (OTROS) ===== -->
  <section id="auxiliares" hidden aria-labelledby="auxTitle">
    <h1 id="auxTitle"><span class="black">AUXILIARES</span> <span class="red">(OTROS)</span></h1>
    <div id="auxList" class="grid onecol"></div>
  </section>

  <hr class="sep">

  <!-- ===== INCIDENCIAS ===== -->
  <section id="incidencias" hidden aria-labelledby="incTitle">
    <h1 id="incTitle"><span class="black">GESTIÓN DE</span> <span class="red">INCIDENCIAS</span></h1>

    <div class="cta-centrado">
      <button class="btn btn--primary btn-big" id="btnNewInc">CREAR NUEVA INCIDENCIA</button>
    </div>

    <div class="card" id="incFormWrap" hidden>
      <div class="grid two">
        <div>
          <label>Equipo</label>
          <input id="incEquipo" list="equiposDatalist" placeholder="Escribe o selecciona equipo…">
          <datalist id="equiposDatalist"></datalist>

          <label>Tipo de fallo</label>
          <select id="incTipo">
            <option value="mecanico">Fallo mecánico</option>
            <option value="electrico">Fallo eléctrico</option>
            <option value="hidraulico">Fallo hidráulico</option>
            <option value="neumatico">Fallo neumático</option>
            <option value="proceso">Fallo de proceso productivo</option>
            <option value="desconocido">Origen desconocido</option>
          </select>

          <label>Descripción breve</label>
          <input id="incDesc" placeholder="Describe el problema…">
        </div>

        <div>
          <label>Solucionado</label>
          <select id="incSol">
            <option value="no">No</option>
            <option value="si">Sí</option>
            <option value="restricciones">Con restricciones</option>
          </select>

          <div id="incSiWrap" hidden>
            <label>Descripción de la solución</label>
            <input id="incSolDesc" placeholder="¿Cómo se solucionó?">
            <label>Repuestos empleados</label>
            <input id="incSolRep" placeholder="Escribe para buscar…">
          </div>

          <div id="incNoWrap">
            <label>Descripción de la intervención</label>
            <input id="incNoDesc" placeholder="¿Qué se ha hecho hasta ahora?">
            <label>Repuestos empleados</label>
            <input id="incNoRep" placeholder="Opcional">
          </div>

          <label>Reportado por (rol)</label>
          <select id="incReportadoPor">
            <option>administrador</option><option>gerente</option><option>encargado</option>
            <option>resp_produccion</option><option>resp_turno</option><option>externa</option>
          </select>

          <label>Intervenido por</label>
          <input id="incIntervenido" placeholder="Nombre del técnico…">

          <div class="grid two">
            <div>
              <label>Fecha de inicio</label>
              <input id="incIni" type="date">
            </div>
            <div>
              <label>Fecha de reparación</label>
              <input id="incFin" type="date">
            </div>
          </div>
        </div>
      </div>
      <div class="actions-row" style="display:flex;gap:8px;margin-top:10px">
        <button class="btn btn--primary" id="incGuardar">Guardar incidencia</button>
        <button class="btn btn--ghost" id="incCancelar">Cancelar</button>
      </div>
    </div>

    <div class="card">
      <div class="toolbar">
        <h2 class="card__title">Últimas incidencias</h2>
        <input id="incFilter" placeholder="Filtrar…">
      </div>
      <div id="incList" class="mono-list"></div>
    </div>
  </section>

  <hr class="sep">

  <!-- ===== INVENTARIO ===== -->
  <section id="inventario" hidden aria-labelledby="invTitle">
    <h1 id="invTitle"><span class="black">INVENTARIO DE</span> <span class="red">REPUESTOS</span></h1>

    <div class="card">
      <div id="invAlerts"></div>
    </div>

    <div class="card">
      <div class="toolbar">
        <h2 class="card__title">Buscar</h2>
        <div class="searchbar">
          <input id="invSearch" placeholder="Código, referencia, nombre…">
          <button class="btn btn--ghost" id="invClear">Limpiar</button>
        </div>
      </div>
      <div class="catgrid" id="invCats"></div>
    </div>
  </section>

  <hr class="sep">

  <!-- ===== SOLICITUD DE REPUESTO ===== -->
  <section id="solicitudes" hidden aria-labelledby="reqTitle">
    <h1 id="reqTitle"><span class="black">SOLICITUD</span> <span class="red">DE REPUESTO</span></h1>

    <div class="card">
      <h2 class="card__title">Nueva solicitud</h2>
      <div class="grid two">
        <div>
          <label>Repuesto</label>
          <input id="reqRef" placeholder="Ref o nombre…">
        </div>
        <div>
          <label>Cantidad</label>
          <input id="reqQty" type="number" min="1" value="1">
        </div>
        <div class="full">
          <label>Observaciones</label>
          <input id="reqObs" placeholder="Urgente, alternativa, etc.">
        </div>
      </div>
      <div class="actions-row" style="margin-top:12px">
        <button class="btn btn--primary" id="reqEnviar">Enviar solicitud</button>
      </div>
    </div>

    <div class="card">
      <div class="toolbar">
        <h2 class="card__title">Solicitudes</h2>
        <div class="badge" id="reqCountBadge">0</div>
      </div>
      <div id="reqList" class="mono-list"></div>
    </div>
  </section>

  <hr class="sep">

  <!-- ===== AVISOS SUBCONTRATAS ===== -->
  <section id="ot" hidden aria-labelledby="otTitle">
    <h1 id="otTitle"><span class="black">AVISOS</span> <span class="red">SUBCONTRATAS</span></h1>
    <div id="avisosList" class="grid onecol"></div>
  </section>

  <hr class="sep">

  <!-- ===== INDICADORES (gráficas visibles) ===== -->
  <section id="indicadores" hidden aria-labelledby="indTitle">
    <h1 id="indTitle"><span class="black">INDICADORES</span> <span class="red">CLAVE</span></h1>

    <div class="grid onecol">
      <div class="card">
        <h3 class="card__title">MTBF</h3>
        <canvas id="chartMtbf" height="160"></canvas>
      </div>
      <div class="card">
        <h3 class="card__title">Disponibilidad</h3>
        <canvas id="chartDisp" height="160"></canvas>
      </div>
      <div class="card">
        <h3 class="card__title">OEE</h3>
        <canvas id="chartOee" height="160"></canvas>
      </div>
    </div>
  </section>
</main>

<!-- ===== FOOTER (negro) ===== -->
<footer class="footer-dark">
  <div class="footer-in">
    <div>© <b>CDL</b> — Comercial de Laminados</div>
    <div>Gestión del mantenimiento</div>
    <div class="footer-actions">
      <a id="reportLink" href="#">Informar sobre un problema con la app/web</a>
    </div>
  </div>
</footer>

<!-- ===== Modal “Ver ficha” (QR + Ver incidencias) ===== -->
<div id="fichaModal" class="modal-backdrop" aria-hidden="true">
  <div class="card modal-card" role="dialog" aria-modal="true" aria-labelledby="fichaTitle">
    <button id="closeFicha" class="x-btn" aria-label="Cerrar">✕</button>
    <h2 class="card__title" id="fichaTitle">Ficha</h2>
    <div class="grid ficha-grid">
      <img id="fichaQR" alt="QR" src="">
      <div>
        <div id="fichaNombre" class="ficha-nombre"></div>
        <button class="btn btn--ghost" id="btnVerIncidencias">Ver incidencias</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== Modal “Reportar problema” ===== -->
<div id="reportModal" class="modal-backdrop" aria-hidden="true">
  <div class="card modal-card" role="dialog" aria-modal="true" aria-labelledby="reportTitle">
    <button id="closeReport" class="x-btn" aria-label="Cerrar">✕</button>
    <h2 class="card__title" id="reportTitle">Informar problema</h2>
    <div class="grid onecol">
      <label>Asunto</label>
      <input id="rpSubject" placeholder="Breve asunto…">
      <label>Descripción</label>
      <textarea id="rpDesc" rows="5" placeholder="Describe el problema, pasos para reproducir, pantalla, etc." class="ta"></textarea>
      <div class="actions-row" style="display:flex;gap:8px;margin-top:10px">
        <button class="btn btn--primary" id="rpEnviar">Enviar</button>
        <button class="btn btn--ghost" id="rpCancelar">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== Plantilla tarjeta EQUIPO ===== -->
<template id="tplEquipo">
  <article class="card equipo">
    <div class="eq-head">
      <div>
        <div class="eq-estado">—</div>
        <div class="eq-nombre">NOMBRE</div>
        <div class="eq-meta">—</div>
      </div>
      <!-- Semáforo -->
      <div class="semaforo">
        <button class="bulb bulb--ok"    data-state="marcha"        aria-label="En marcha"></button>
        <button class="bulb bulb--warn"  data-state="restricciones" aria-label="Restricciones"></button>
        <button class="bulb bulb--stop"  data-state="parada"        aria-label="Parada"></button>
      </div>
    </div>

    <div class="actions wrap">
      <button class="btn btn--ghost act-ficha">Ver ficha</button>
      <button class="btn btn--ghost act-prog">Parada prog.</button>
      <button class="btn btn--primary act-prolong">Parada prolongada</button>
      <button class="btn btn--ghost act-incid">Nueva incidencia</button>
    </div>
  </article>
</template>

<script>
/* ======================================================
   CMMS CDL – Lógica UI + Datos (v3.2 final)
   - Menú hamburguesa pantalla completa (bajo cabecera)
   - Autocierre al navegar + focus trap (sidenav, usuario, modales)
   - Semáforo con selección clara y formulario forzado
   - Dashboard hero + títulos sin angular en tarjetas
   - Charts visibles
   - Footer negro + report modal
====================================================== */

/* ========= CONFIG API (Apps Script) ========= */
const API_BASE = "https://script.google.com/macros/s/AKfycbycKrLO0jIEDXB_AZi91PopCj1uNXCOEu9zWHeqq_aK_DJo7TpWO_kKKWMs4exwyNRW/exec";

/* ========= UTILIDADES ========= */
const $ = (sel,ctx=document)=>ctx.querySelector(sel);
const $$ = (sel,ctx=document)=>Array.from(ctx.querySelectorAll(sel));

const debounce = (fn, wait=200)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; };

/* ========= ESTADO LOCAL ========= */
const STORE_KEY = "cdl_cache_v1";
const LAST_TAB_KEY = "cdl_last_tab";
const store = {
  state:{
    user:{rol:'invitado', nombre:'Invitado', token:''},
    equipos:[], gruas:[], auxiliares:[],
    incidencias:[], inventario:[], solicitudes:[],
    ots:[], externas:[]
  },
  save(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(this.state)); }catch{} },
  load(){ try{ Object.assign(this.state, JSON.parse(localStorage.getItem(STORE_KEY)||"{}")); }catch{} }
};

/* ========= DEMO DATA ========= */
function demoSeedIfEmpty(){
  if(!store.state.equipos?.length){
    store.state.equipos = [
      {id:'KALT-01', nombre:'SIERRA KALT 01', grupo:'LÍNEA KALTENBACH', estado:'marcha'},
      {id:'KALT-02', nombre:'TALADRO KALT 02', grupo:'LÍNEA KALTENBACH', estado:'restricciones'},
      {id:'LASER-01', nombre:'LASER TRUMP 01', grupo:'LÁSER TRUMP', estado:'parada'},
    ];
  }
  if(!store.state.gruas?.length){
    store.state.gruas = [
      {id:'GRUA-N1-01', nombre:'Puente Grúa N1-01', nave:'NAVE 1', estado:'marcha'},
      {id:'GRUA-N2-05', nombre:'Puente Grúa N2-05', nave:'NAVE 2', estado:'restricciones'},
    ];
  }
  if(!store.state.auxiliares?.length){
    store.state.auxiliares = [
      {id:'EXT-INC-01', nombre:'BIE 25mm', tipo:'CONTRA INCENDIOS', estado:'marcha'}
    ];
  }
  store.save();
}

/* ========= NAV ========= */
const PAGES = ["dashboard","equipos","gruas","auxiliares","incidencias","inventario","solicitudes","ot","indicadores"];
const TITLES = {
  dashboard:"Dashboard TV", equipos:"Equipos", gruas:"Puentes grúa", auxiliares:"Auxiliares (otros)",
  incidencias:"Incidencias", inventario:"Inventario", solicitudes:"Solicitud de repuesto",
  ot:"Avisos subcontratas", indicadores:"Indicadores"
};

function buildNav(){
  const nav = $("#navList");
  if(!nav) return;
  nav.innerHTML = PAGES.map(id=>`<a href="#${id}" data-id="${id}">${TITLES[id]}</a>`).join("");
  // Autocierre del sidenav al pulsar
  $$('a', nav).forEach(a=>{
    a.addEventListener('click', (ev)=>{
      ev.preventDefault();
      const id = a.getAttribute('data-id');
      closeSideNav();
      navTo(id);
    });
  });
  markActiveNav((location.hash||'#dashboard').slice(1));
}

function markActiveNav(id){
  const nav = $("#navList");
  if(!nav) return;
  $$('a', nav).forEach(a=>{
    const active = a.getAttribute('data-id')===id;
    if(active) a.setAttribute('aria-current','page'); else a.removeAttribute('aria-current');
  });
}

function navTo(id){
  PAGES.forEach(p=>{
    const el = document.getElementById(p);
    if(el) el.hidden = (p!==id);
  });
  if (location.hash !== '#'+id) location.hash = '#'+id;
  localStorage.setItem(LAST_TAB_KEY, id);
  markActiveNav(id);
  render();
}

function onHash(){
  const id = (location.hash||"#dashboard").replace("#","");
  if(!PAGES.includes(id)) return navTo("dashboard");
  closeSideNav();
  markActiveNav(id);
  navTo(id);
}

/* ========= FOCUS TRAP ========= */
let activeTrap = null;
function trapFocus(container){
  if(!container) return;
  const focusables = container.querySelectorAll('a[href], button, textarea, input, select, [tabindex]:not([tabindex="-1"])');
  if(!focusables.length) return;
  const first = focusables[0], last = focusables[focusables.length-1];
  function handler(e){
    if(e.key !== 'Tab') return;
    if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
    else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
  }
  container.addEventListener('keydown', handler);
  activeTrap = {container, handler};
  first.focus();
}
function releaseTrap(){
  if(activeTrap?.container) activeTrap.container.removeEventListener('keydown', activeTrap.handler);
  activeTrap = null;
}

/* ========= CABECERA / MENÚS ========= */
function setupHeaderInteractions(){
  const sidenav      = $("#sidenav");
  const hamb         = $("#hamb");
  const closeNavBtn  = $("#closeNav");
  const moreBtn      = $("#moreBtn");
  const userPanel    = $("#userPanel");
  const closeUser    = $("#closeUser");
  const roleChip     = $("#roleChip");
  const globalSearch = $("#globalSearch");

  function openSideNav(){
    sidenav?.classList.add("open");
    document.body.classList.add('menu-open');
    hamb?.setAttribute('aria-expanded','true');
    trapFocus(sidenav);
  }
  function closeSideNav(){
    sidenav?.classList.remove("open");
    document.body.classList.remove('menu-open');
    hamb?.setAttribute('aria-expanded','false');
    releaseTrap();
  }
  window.closeSideNav = closeSideNav; // por si lo necesitas externamente

  hamb?.addEventListener('click', openSideNav);
  closeNavBtn?.addEventListener('click', closeSideNav);
  // cerrar por click en backdrop del aside
  sidenav?.addEventListener('click',(e)=>{ if(e.target===sidenav) closeSideNav(); });

  // buscar: atajo "/"
  document.addEventListener('keydown',(e)=>{
    if(e.key === '/' && sidenav?.classList.contains('open')){ e.preventDefault(); globalSearch?.focus(); }
  });

  function showUserPanel(){ userPanel?.classList.add("show"); moreBtn?.setAttribute("aria-expanded","true"); trapFocus(userPanel); }
  function hideUserPanel(){ userPanel?.classList.remove("show"); moreBtn?.setAttribute("aria-expanded","false"); releaseTrap(); }
  moreBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); userPanel?.classList.contains("show")?hideUserPanel():showUserPanel(); });
  closeUser?.addEventListener('click', hideUserPanel);
  document.addEventListener("click",(e)=>{
    if(!userPanel?.classList.contains("show")) return;
    const inside = e.target.closest && e.target.closest("#userPanel,#moreBtn");
    if(!inside) hideUserPanel();
  });

  // ESC cierra todo
  document.addEventListener("keydown",(e)=>{
    if(e.key==="Escape"){ closeSideNav(); hideUserPanel(); hideModals(); }
  });

  // Ojo mostrar/ocultar contraseña
  const toggleEye = $("#toggleEye");
  const userPass  = $("#userPass");
  toggleEye && userPass && toggleEye.addEventListener('click', ()=>{ userPass.type = (userPass.type === "password") ? "text" : "password"; });

  // Login local (cuando actives servidor, engancha fetch al API_BASE)
  const loginBtn = $("#loginBtn");
  const logoutBtn= $("#logoutBtn");
  const roleSel  = $("#roleSelect");
  loginBtn && (loginBtn.onclick = ()=>{
    const role    = (roleSel?.value||"invitado").toLowerCase();
    const pass    = userPass?.value||"";
    if(!pass){ alert("Introduce la contraseña."); return; }
    store.state.user = {rol: role, nombre: role.toUpperCase(), token:""}; store.save();
    roleChip && (roleChip.textContent = role.toUpperCase());
    hideUserPanel(); render();
  });
  logoutBtn && (logoutBtn.onclick = ()=>{
    store.state.user = {rol:"invitado", nombre:"Invitado", token:""}; store.save();
    roleChip && (roleChip.textContent = "Invitado"); render();
  });
}

/* ========= HELPERS RENDER ========= */
function pill(estado){
  const s = (estado||"").toLowerCase();
  if(s.includes("parada")) return `<span class="pill pill--stop">Parada</span>`;
  if(s.includes("restr")) return `<span class="pill pill--warn">Restricciones</span>`;
  if(s.includes("marcha")) return `<span class="pill pill--ok">En marcha</span>`;
  return `<span class="pill pill--info">${estado||"—"}</span>`;
}
const emptyLine = (txt)=>`<div class="line-1" style="opacity:.7">${txt}</div>`;

/* ========= RENDERS ========= */
function renderDashboard(){
  const eqStop   = store.state.equipos.filter(x=>(x.estado||"").toLowerCase().includes("parada"));
  const eqRestr  = store.state.equipos.filter(x=>(x.estado||"").toLowerCase().includes("restr"));
  const grStop   = store.state.gruas.filter(x=>(x.estado||"").toLowerCase().includes("parada"));
  const auxRestr = store.state.auxiliares.filter(x=>(x.estado||"").toLowerCase().includes("restr"));
  const low      = store.state.inventario.filter(i=>Number(i.stock)<Number(i.stock_min));
  const reqPend  = store.state.solicitudes.filter(r=>(r.estado||"").toLowerCase()==="pendiente");

  const putText = (id,val)=>{ const el=document.getElementById(id); if(el){ el.textContent=val; el.setAttribute('aria-live','polite'); } };
  putText("countParadas", eqStop.length + grStop.length);
  putText("countRestr",   eqRestr.length + auxRestr.length);
  putText("countStock",   low.length);
  putText("countReq",     reqPend.length);
  putText("countExt",     store.state.externas.length||0);

  const put = (id, arr, map)=>{ const el=document.getElementById(id); if(el) el.innerHTML = arr.length ? arr.map(map).join("") : emptyLine("Sin datos"); };
  put("dash-paradas", eqStop.concat(grStop), x=>`<div class="line-1">${x.nombre}</div>`);
  put("dash-restr",   eqRestr.concat(auxRestr), x=>`<div class="line-1">${x.nombre}</div>`);
  put("dash-stock",   low, i=>`<div class="line-1">${i.ref||''} · ${i.nombre||''} (${i.stock||0}/${i.stock_min||0})</div>`);
  put("dash-req",     reqPend, r=>`<div class="line-1">${r.id||''} · ${r.nombre||''} (${r.qty||1})</div>`);
  put("dash-externas",(store.state.externas||[]), e=>`<div class="line-1">${e.proveedor||''} · ${e.asunto||''}</div>`);
}

function renderEquipos(){
  const grid = $("#equiposGrid"); if(!grid) return;
  grid.innerHTML = "";
  const tpl = $("#tplEquipo");
  (store.state.equipos||[]).forEach(e=>{
    const node = document.importNode(tpl.content, true);
    node.querySelector(".eq-estado").innerHTML = pill(e.estado);
    node.querySelector(".eq-nombre").textContent = e.nombre.toUpperCase();
    node.querySelector(".eq-meta").textContent = e.grupo||"";

    // Semáforo activo
    const bulbs = node.querySelectorAll(".bulb");
    bulbs.forEach(b=>{
      const st = b.getAttribute("data-state");
      const active = (st==="marcha" && e.estado==="marcha")
                  || (st==="restricciones" && e.estado==="restricciones")
                  || (st==="parada" && e.estado==="parada");
      if(active) b.classList.add("is-active");
    });

    // Acciones
    node.querySelector(".act-ficha").onclick    = ()=> openFicha(e);
    node.querySelector(".act-prog").onclick     = ()=> setEstadoAndIncid(e, "restricciones");
    node.querySelector(".act-prolong").onclick  = ()=> setEstadoAndIncid(e, "parada");
    node.querySelector(".act-incid").onclick    = ()=> openIncidFor(e);

    bulbs.forEach(b=>{
      b.onclick = ()=>{
        const st = b.getAttribute("data-state");
        const nuevo = (st==="marcha") ? "marcha" : (st==="restricciones" ? "restricciones" : "parada");
        setEstadoAndIncid(e, nuevo);
      };
    });

    grid.appendChild(node);
  });
}

function renderGruas(){
  const cont = $("#gruasList"); if(!cont) return;
  const naves = ["NAVE 1","NAVE 2","NAVE 3","NAVE 4"];
  cont.innerHTML = naves.map(n=>{
    const list = store.state.gruas.filter(x=>(x.nave||"").toUpperCase()===n);
    if(!list.length) return "";
    return `<div class="card"><h2 class="card__title">${n}</h2>${
      list.map(x=>`<div class="line-1"><div class="item__title">${x.nombre}</div>${pill(x.estado)}</div>`).join("")
    }</div>`;
  }).join("");
}

function renderAux(){
  const cont = $("#auxList"); if(!cont) return;
  const list = store.state.auxiliares||[];
  cont.innerHTML = list.length
    ? `<div class="card"><h2 class="card__title">Auxiliares</h2>${ list.map(x=>`<div class="line-1"><div class="item__title">${x.nombre}</div>${pill(x.estado)}</div>`).join("") }</div>`
    : `<div class="card">${emptyLine("No hay equipos auxiliares registrados")}</div>`;
}

function renderIncidencias(){
  const wrap = $("#incList"); if(!wrap) return;
  const filtro = ($("#incFilter")?.value||"").toLowerCase();
  const arr = (store.state.incidencias||[])
    .filter(i=>!filtro || (i.equipo+i.tipo+i.desc).toLowerCase().includes(filtro))
    .sort((a,b)=>String(b.fecha||"").localeCompare(String(a.fecha||"")));
  wrap.innerHTML = arr.length
    ? arr.map(i=>`<div class="line-1">${i.fecha||'—'} · ${i.equipo||'—'} · ${i.tipo||'—'} · ${i.desc||''}</div>`).join("")
    : emptyLine("Aún no hay incidencias");
}

const renderInventario = (function(){
  const doRender = ()=>{
    const invAlerts = $("#invAlerts");
    const qEl = $("#invSearch");
    const clear = $("#invClear");
    const catsBox = $("#invCats");
    if(!invAlerts || !catsBox) return;

    const low = (store.state.inventario||[]).filter(i=>Number(i.stock)<Number(i.stock_min));
    invAlerts.innerHTML = low.length
      ? `<span class="pill pill--stop">⚠ ${low.length} referencias por debajo del mínimo</span>`
      : `<span class="pill pill--ok">Stock correcto</span>`;

    const q = (qEl?.value||"").toLowerCase();
    const items = (store.state.inventario||[]).filter(i=>{
      const t = ((i.ref||"")+" "+(i.nombre||"")).toLowerCase();
      return !q || t.includes(q);
    });

    const cats = {};
    items.forEach(i=>{
      const c = i.categoria || "Otros";
      (cats[c] ||= []).push(i);
    });
    const keys = Object.keys(cats).sort();
    catsBox.innerHTML = keys.length
      ? keys.map(c=>`<div class="cat"><b>${c}</b><br>${cats[c].length} items</div>`).join("")
      : emptyLine(q ? "Sin resultados" : "Inventario vacío");

    clear && (clear.onclick = ()=>{ if(qEl){ qEl.value=""; doRender(); } });
  };
  return debounce(doRender, 120);
})();

function renderSolicitudes(){
  const box = $("#reqList"); const badge = $("#reqCountBadge"); if(!box) return;
  const list = store.state.solicitudes||[];
  badge && (badge.textContent = list.length);
  box.innerHTML = list.length
    ? list.map(r=>`<div class="line-1">${r.id||''} · ${r.nombre||''} (${r.qty||1}) · ${r.estado||'Pendiente'}</div>`).join("")
    : emptyLine("No hay solicitudes");
}

function renderCharts(){
  drawBarChart("chartMtbf", [8,10,7,12,11], "MTBF (h)");
  drawBarChart("chartDisp", [97,98,96,99,98], "Disponibilidad (%)");
  drawBarChart("chartOee",  [88,90,87,91,89], "OEE (%)");
}

function render(){
  const dl = $("#equiposDatalist");
  if(dl){ dl.innerHTML = (store.state.equipos||[]).map(e=>`<option value="${e.nombre}">`).join(""); }

  renderDashboard();
  renderEquipos();
  renderGruas();
  renderAux();
  renderIncidencias();
  renderInventario();
  renderSolicitudes();
  renderCharts();
}

/* ========= MODALES ========= */
function openFicha(e){
  const modal = $("#fichaModal"); if(!modal) return;
  modal.style.display = "flex";
  trapFocus(modal);
  $("#fichaTitle").textContent = "Ficha de equipo";
  $("#fichaNombre").textContent = e.nombre;
  const qr = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${encodeURIComponent(e.id||e.nombre)}`;
  $("#fichaQR").src = qr;

  $("#btnVerIncidencias").onclick = ()=>{ navTo("incidencias"); hideModals(); };
  $("#closeFicha").onclick = hideModals;
  modal.addEventListener("click",(ev)=>{ if(ev.target===modal) hideModals(); }, {once:true});
}

function hideModals(){
  ["fichaModal","reportModal"].forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display="none"; });
  releaseTrap();
}

/* ========= ACCIONES ========= */
function setEstadoAndIncid(e, nuevo){
  const target = store.state.equipos.find(x=>x.id===e.id);
  if(target){ target.estado = nuevo; store.save(); }
  openIncidFor(e);
  render();
}

function openIncidFor(e){
  navTo("incidencias");
  const iEq = $("#incEquipo"); if(iEq) iEq.value = e.nombre;
  const wrap = $("#incFormWrap"); if(wrap) wrap.hidden = false;
}

/* Reportar problema */
function setupReportModal(){
  const link = $("#reportLink");
  const modal= $("#reportModal");
  const close = $("#closeReport");
  const btnEn = $("#rpEnviar");
  const btnCa = $("#rpCancelar");

  if(!link || !modal) return;
  link.onclick = (e)=>{ e.preventDefault(); modal.style.display="flex"; trapFocus(modal); };
  close && (close.onclick = hideModals);
  btnCa && (btnCa.onclick = hideModals);
  modal.addEventListener("click",(ev)=>{ if(ev.target===modal) hideModals(); });

  btnEn && (btnEn.onclick = async ()=>{
    const sub = $("#rpSubject").value.trim();
    const des = $("#rpDesc").value.trim();
    if(!sub || !des){ alert("Describe el problema, por favor."); return; }
    alert("Aviso registrado. ¡Gracias!");
    hideModals();
    $("#rpSubject").value=""; $("#rpDesc").value="";
  });
}

/* ========= CHARTS (canvas) ========= */
function drawBarChart(id, data, label){
  const c = document.getElementById(id); if(!c) return;
  const ctx = c.getContext("2d");
  const W = c.width = c.clientWidth || 320;
  const H = c.height;
    ctx.clearRect(0,0,W,H);

  // Ejes
  ctx.strokeStyle = "#e5e7eb";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(36,10);
  ctx.lineTo(36,H-24);
  ctx.lineTo(W-10,H-24);
  ctx.stroke();

  // Barras
  const max = Math.max(...data, 1);
  const n = data.length;
  const gap = 10;
  const barW = (W-60 - (n-1)*gap) / n;
  ctx.fillStyle = "#ef4444"; // rojo corporativo

  data.forEach((v,i)=>{
    const h = (H-50) * (v/max);
    const x = 36 + i*(barW+gap);
    const y = H-24 - h;
    ctx.fillRect(x,y,barW,h);
  });

  // Etiqueta
  ctx.fillStyle = "#64748b";
  ctx.font = "12px Inter, system-ui, sans-serif";
  ctx.fillText(label, 40, 18);
}
/* ========= REFRESH ========= */
async function refresh(){
  // Aquí puedes activar lecturas reales si conectas con Apps Script:
  // const rState = await fetch(API_BASE+"?res=state&fn=list");
  // const jState = await rState.json();
  render();
}

/* ========= INIT ========= */
document.addEventListener("DOMContentLoaded", ()=>{
  // Estado
  store.load();
  demoSeedIfEmpty();

  // Sombra cabecera al hacer scroll
  document.addEventListener('scroll', ()=>{
    document.getElementById('hdr')?.classList.toggle('scrolled', window.scrollY>8);
  });

  // Menús, nav y panel usuario
  setupHeaderInteractions();
  buildNav();

  // Navegación (recupera última pestaña si no hay hash)
  const last = localStorage.getItem(LAST_TAB_KEY);
  if(!location.hash && last && PAGES.includes(last)) location.hash = '#'+last;
  window.addEventListener("hashchange", onHash);
  onHash();

  // Inventario: búsqueda con debounce
  const invSearch = document.getElementById("invSearch");
  if(invSearch){ invSearch.addEventListener('input', ()=>renderInventario()); }

  // Primer render + refresco cada minuto
  (async ()=>{ await refresh(); setInterval(refresh, 60000); })();

  // Service Worker (ruta relativa)
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
    
document.addEventListener("DOMContentLoaded", ()=>{
  // Estado
  store.load();
  demoSeedIfEmpty();

  // Sombra cabecera al hacer scroll
  document.addEventListener('scroll', ()=>{
    document.getElementById('hdr')?.classList.toggle('scrolled', window.scrollY>8);
  });

  // Menús, nav y panel usuario
  setupHeaderInteractions();
  buildNav();

  // ⬇️ AÑADE ESTO
  setupReportModal(); // activa el modal del footer

  // Botón "CREAR NUEVA INCIDENCIA" muestra el formulario
  const btnNewInc = document.getElementById("btnNewInc");
  if (btnNewInc){
    btnNewInc.addEventListener('click', ()=>{
      const wrap = document.getElementById("incFormWrap");
      if(wrap) wrap.hidden = false;
      // opcional: focus en el primer campo
      document.getElementById("incEquipo")?.focus();
    });
  }
  // ⬆️ AÑADE ESTO

  // Navegación (recupera última pestaña si no hay hash)
  const last = localStorage.getItem(LAST_TAB_KEY);
  if(!location.hash && last && PAGES.includes(last)) location.hash = '#'+last;
  window.addEventListener("hashchange", onHash);
  onHash();

  // Inventario: búsqueda con debounce
  const invSearch = document.getElementById("invSearch");
  if(invSearch){ invSearch.addEventListener('input', ()=>renderInventario()); }

  // Primer render + refresco cada minuto
  (async ()=>{ await refresh(); setInterval(refresh, 60000); })();

  // Service Worker (ruta relativa)
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }
});

</script>
</body>
</html>

