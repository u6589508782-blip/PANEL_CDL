<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>CDL · Panel de control</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="apple-touch-icon.png">

<!-- Fuente -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
/* =========================================================
   VARIABLES
========================================================= */
:root{
  --brand:#E43B3B; --ink:#0f172a; --muted:#475569; --line:#e5e7eb; --bg:#ffffff;
  --hdr-h:128px;
  --radius:18px;
  --shadow:0 4px 12px rgba(0,0,0,.06);
  --angular-size:30px;
  --angular-up:.80em;
  --angular-gap:24px;

  --carousel-h: clamp(160px, 26vw, 320px);
  --modal-bg: rgba(3,6,23,.55);
  --modal-panel: #0f141c;
}

/* =========================================================
   RESET & BASE
========================================================= */
*{box-sizing:border-box}
html,body{height:100%; background:#fff; overflow-x:hidden}
body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif; color:var(--ink)}
a{color:inherit; text-decoration:none}
img{display:block; max-width:100%}
button{font:inherit; cursor:pointer}
:focus-visible{outline:2px solid #0ea5e9; outline-offset:2px}
@media (prefers-reduced-motion:reduce){
  *{scroll-behavior:auto; transition:none!important; animation:none!important}
}

/* =========================================================
   CABECERA
========================================================= */
.header{
  position:sticky; top:0; z-index:1000; background:#fff;
  border-bottom:1px solid #eee; transition:box-shadow .25s ease;
}
.header.scrolled{ box-shadow:0 6px 14px rgba(0,0,0,.06) }
.h__in{
  height:var(--hdr-h);
  display:grid; grid-template-columns:auto 1fr auto; align-items:end;
  gap:12px; padding:10px 16px 12px; position:relative;
}
/* Fondo: logo mantenimiento atenuado */
.header::before{
  content:""; position:absolute; inset:0;
  background:
    linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.02) 60%, rgba(255,255,255,.06) 100%),
    url("logo_mantenimiento.png") center -28px / clamp(220px, 42vw, 380px) auto no-repeat;
  opacity:.12; pointer-events:none;
}

/* Marca CDL centrada */
.brand{display:flex; align-items:flex-end; gap:10px; justify-self:center}
.brand img{height:42px}

/* Chip rol */
#roleChip{position:absolute; right:16px; top:8px; font-weight:800; font-size:12px; color:var(--ink)}

/* Botones cabecera */
.hbtn{width:44px; height:44px; display:grid; place-items:center; background:transparent; border:0; color:var(--ink)}
#hamb .i{width:22px; height:16px; position:relative; display:inline-block}
#hamb .i:before,#hamb .i:after,#hamb .i span{
  content:""; position:absolute; left:0; right:0; height:2px; background:var(--ink); border-radius:2px;
}
#hamb .i:before{top:0} #hamb .i span{top:7px} #hamb .i:after{bottom:0}
#moreBtn .i{display:inline-block; width:18px; text-align:center; letter-spacing:2px; font-weight:800}
#moreBtn .i::before{content:"···"}

/* =========================================================
   CARRUSEL DE FOTOS (solo dashboard)
========================================================= */
.hero-carousel{
  position:relative; overflow:hidden; border-bottom:1px solid var(--line);
  background:linear-gradient(180deg,#fff,#f8fafc);
}
.carousel-track{
  display:flex; touch-action:pan-y; user-select:none; -webkit-user-drag:none;
  width:100%; height:var(--carousel-h); transform:translateX(0); will-change:transform;
}
.carousel-slide{ min-width:100%; height:100%; position:relative; overflow:hidden; display:grid; place-items:center; }
.carousel-slide picture, .carousel-slide img{
  width:100%; height:100%;
  object-fit:cover;        /* llena contenedor */
  object-position:center;  /* centrada vertical y horizontal */
}
/* Controles */
.carousel-ctrl{
  position:absolute; top:50%; transform:translateY(-50%); z-index:2;
  width:40px; height:40px; border-radius:999px; border:1px solid #e5e7eb;
  background:#ffffffc7; display:grid; place-items:center; opacity:.0; pointer-events:none;
}
.carousel-ctrl svg{ width:18px; height:18px }
.hero-carousel:hover .carousel-ctrl{ opacity:1; pointer-events:auto }
.carousel-prev{ left:10px } .carousel-next{ right:10px }
/* Puntos */
.carousel-dots{
  position:absolute; left:0; right:0; bottom:8px; display:flex; justify-content:center; gap:8px; z-index:2;
}
.carousel-dots button{
  width:8px; height:8px; border-radius:50%; border:1px solid rgba(0,0,0,.15); background:#fff; opacity:.7;
}
.carousel-dots button[aria-current="true"]{ opacity:1; transform:scale(1.15); }

/* =========================================================
   SIDENAV
========================================================= */
#sidenav{
  position:fixed; inset:var(--hdr-h) 0 0 0; background:#fff; color:var(--ink);
  transform:translateX(-100%); transition:transform .25s ease; z-index:900; box-shadow:4px 0 24px rgba(0,0,0,.08);
}
#sidenav.open{transform:none}
.sidenav__head{display:flex; align-items:center; gap:12px; padding:14px 16px}
.sidenav__head img{ height:120px; display:block; margin:6px 0 2px 0; }
#closeNav{margin-left:auto; width:40px; height:40px; background:transparent; border:0; font-size:22px}
.sidenav__search{padding:0 16px 10px}
.sidenav__search input{width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:12px; font-weight:600}

/* navegación */
.navlist{padding:6px 0}
.navlist a{display:block; padding:16px; font-weight:800; text-transform:uppercase; outline:none}
.navlist a:not(:last-child){position:relative}
.navlist a:not(:last-child)::after{
  content:""; position:absolute; left:10%; right:10%; bottom:-1px; height:1.5px;
  background:linear-gradient(90deg,rgba(0,0,0,0),rgba(15,23,42,.25) 50%,rgba(0,0,0,0));
}
.navlist a[aria-current="page"]{background:#f6f8fb; box-shadow:inset 4px 0 0 var(--brand)}

/* blur fondo cuando el menú está abierto */
body.menu-open::after{
  content:""; position:fixed; inset:var(--hdr-h) 0 0 0; backdrop-filter:blur(4px); background:rgba(0,0,0,.18); z-index:800;
}

/* =========================================================
   PANEL USUARIO
========================================================= */
#userPanel{
  position:fixed; right:12px; top:calc(var(--hdr-h) + 10px);
  width:360px; max-width:calc(100vw - 24px);
  background:#0f141c; color:#e6eef7;
  border:1px solid #223046; border-radius:16px; box-shadow:0 20px 36px rgba(0,0,0,.45);
  padding:14px; display:none; z-index:950;
}
#userPanel.show{display:block}
#userPanel .up__head{display:flex; align-items:center; justify-content:space-between; margin-bottom:6px}
#userPanel h3{margin:0; font-size:16px}
#closeUser{background:transparent; border:0; font-size:22px; color:#e6eef7}
#userPanel label{display:block; font-size:12px; color:#9fb0c6; margin:10px 0 6px}
#userPanel select,#userPanel input{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #243046; background:#0b101a; color:#e6eef7}

/* ojo mostrar/ocultar password */
.eyeBtn{position:absolute; right:12px; top:38px; width:24px; height:24px; border:0; background:transparent; padding:0}
.eyeBtn svg{width:22px; height:22px; fill:none; stroke:#cbd5e1; stroke-width:2}

/* botones globales más compactos */
.btn{border:0; border-radius:999px; padding:8px 12px; font-weight:800; line-height:1.1}
.btn--primary{background:var(--brand); color:#fff}
.btn--ghost{background:#fff; color:var(--ink); border:1px solid var(--line)}
.btn:active{transform:translateY(1px)}

/* =========================================================
   TÍTULOS CON ANGULAR
========================================================= */
h1,h2,h3{
  position:relative; margin:26px 0 14px; padding-left:var(--angular-gap); line-height:1.12;
  white-space:nowrap; overflow:visible; text-overflow:ellipsis;
}
h1::before,h2::before,h3::before{
  content:""; position:absolute; left:0; bottom:var(--angular-up);
  width:var(--angular-size); height:var(--angular-size);
  background:url("angular.png") left bottom/contain no-repeat;
  z-index:1; pointer-events:none;
}

/* =========================================================
   UTILIDADES & COMPONENTES
========================================================= */
.main{padding:16px; max-width:1100px; margin:0 auto}
.sep{height:1px; margin:26px 0; background:linear-gradient(90deg,rgba(15,23,42,0),rgba(15,23,42,.22) 50%,rgba(15,23,42,0))}
.card{background:#fff; border:1px solid var(--line); border-radius:18px; padding:14px; box-shadow:var(--shadow)}
.grid{display:grid; gap:16px}
.badge{display:inline-block; padding:3px 10px; border-radius:999px; font-weight:800; font-size:12px; background:#eef2f7; color:#334155; border:1px solid #e2e8f0}
.red{color:var(--brand)!important}
.black{color:var(--ink)!important}
.grid.cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
.grid.cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
@media (max-width: 900px){
  .grid.cols-2, .grid.cols-3 { grid-template-columns: 1fr; }
}

/* Dashboard TV */
.dash-grid{gap:20px}
.card--dash{background:transparent; border:0; box-shadow:none; padding:6px 0}
.card__title.big{font-size:18px; font-weight:900; letter-spacing:.3px; padding-left:0}
.card__title.big .badge{margin-left:10px}
.dash-list .line-1{padding:8px 12px; border:1px dashed var(--line); border-radius:12px; margin:8px 0; font-weight:600}

/* Hero (texto) */
.hero{
  background:linear-gradient(180deg,#fff,#f8fafc);
  border:1px solid #eef2f7; padding:20px; border-radius:20px;
}
.hero h1{margin:0; padding-left:0}
.hero h1::before{display:none}
.hero .sub{color:#64748b; font-weight:800; margin-top:4px}

/* Semáforo mini */
.sem{display:inline-block;width:10px;height:10px;border-radius:50%}
.sem--ok{background:#16a34a} .sem--warn{background:#f59e0b} .sem--err{background:#dc2626}

/* Formularios compactos */
.form-inline{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
.form-inline__label{ font-weight:800 }
.form-inline input[type="search"],
.form-inline input[type="text"],
.form-inline select{
  padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px; min-width:200px;
}

/* Helpers / Accesibilidad */
.visually-hidden{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0}
.pwd-hidden{display:none!important}

/* MODAL genérico (definición visual básica; el contenedor se añade en parte 3) */
</style>

</head>
<body>

<!-- =======================================================
     CABECERA
======================================================= -->
<header class="header" id="hdr" role="banner">
  <span id="roleChip">Invitado</span>
  <div class="h__in">
    <button class="hbtn" id="hamb" aria-label="Abrir menú" aria-controls="sidenav" aria-expanded="false"><span class="i"><span></span></span></button>
    <a class="brand" aria-label="Inicio" href="#dashboard">
      <img src="logo-cdl.png" alt="CDL">
    </a>
    <button class="hbtn" id="moreBtn" aria-haspopup="dialog" aria-expanded="false" aria-controls="userPanel"><span class="i"></span></button>
  </div>
</header>

<!-- =======================================================
     CARRUSEL DE FOTOS (solo en dashboard)
======================================================= -->
<section class="hero-carousel" aria-label="Fotos de producción" id="dashCarousel">
  <div class="carousel-track" id="hcTrack">
    <div class="carousel-slide">
      <picture>
        <source type="image/webp" srcset="./img/carrusel/corte.webp">
        <img src="./img/carrusel/corte.jpeg" alt="Corte">
      </picture>
    </div>
    <div class="carousel-slide">
      <picture>
        <source type="image/webp" srcset="./img/carrusel/kaltenbach.webp">
        <img src="./img/carrusel/kaltenbach.jpeg" alt="Kaltenbach">
      </picture>
    </div>
    <div class="carousel-slide">
      <picture>
        <source type="image/webp" srcset="./img/carrusel/trumpf.webp">
        <img src="./img/carrusel/trumpf.jpeg" alt="Trumpf">
      </picture>
    </div>
    <div class="carousel-slide">
      <picture>
        <source type="image/webp" srcset="./img/carrusel/hgg.webp">
        <img src="./img/carrusel/hgg.jpeg" alt="HGG">
      </picture>
    </div>
    <div class="carousel-slide">
      <picture>
        <source type="image/webp" srcset="./img/carrusel/tecoi.webp">
        <img src="./img/carrusel/tecoi.jpeg" alt="Tecoi">
      </picture>
    </div>
    <div class="carousel-slide">
      <picture>
        <source type="image/webp" srcset="./img/carrusel/mazzak.webp">
        <img src="./img/carrusel/mazzak.jpeg" alt="Mazzak">
      </picture>
    </div>
  </div>
  <button class="carousel-ctrl carousel-prev" id="hcPrev" aria-label="Anterior" aria-controls="hcTrack">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M15 18l-6-6 6-6"/></svg>
  </button>
  <button class="carousel-ctrl carousel-next" id="hcNext" aria-label="Siguiente" aria-controls="hcTrack">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 6l6 6-6 6"/></svg>
  </button>
  <div class="carousel-dots" id="hcDots" aria-label="Indicadores"></div>
</section>

<!-- =======================================================
     SIDENAV
======================================================= -->
<aside id="sidenav" aria-hidden="true" aria-label="Navegación principal">
  <div class="sidenav__head">
    <img src="logo_mantenimiento.png" alt="CDL Mantenimiento">
    <button id="closeNav" aria-label="Cerrar menú">✕</button>
  </div>
  <div class="sidenav__search">
    <input id="globalSearch" placeholder="Buscar en la app…" aria-label="Buscar">
    <button class="btn btn--ghost" id="goSearch" style="margin-top:8px">Ir</button>
  </div>
  <nav class="navlist" id="navList"><!-- items por JS --></nav>
</aside>

<!-- =========================================================
     PANEL USUARIO
========================================================= -->
<section id="userPanel" role="dialog" aria-modal="true" aria-labelledby="upTitle">
  <div class="up__head">
    <h3 id="upTitle">Acceso de usuario</h3>
    <button id="closeUser" aria-label="Cerrar">✕</button>
  </div>

  <label for="roleSelect">Rol</label>
  <select id="roleSelect">
    <option value="invitado" selected>Invitado</option>
    <!-- (Parte 2) Se completará con roles reales si procede -->
  </select>

  <label for="userPass">Contraseña</label>
  <div style="position:relative">
    <input id="userPass" type="password" placeholder="contraseña" autocomplete="current-password" aria-describedby="pwdHelp">
    <button class="eyeBtn" id="toggleEye" aria-label="Mostrar/Ocultar contraseña">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
        <circle cx="12" cy="12" r="3.5"/>
      </svg>
    </button>
  </div>
  <div id="pwdHelp" style="color:#9fb0c6; font-size:12px; margin-top:4px">Introduce la clave según tu rol</div>

  <div style="display:flex; gap:8px; margin-top:12px">
    <button class="btn btn--primary" id="loginBtn">Acceder</button>
    <button class="btn btn--ghost" id="logoutBtn">Salir</button>
  </div>

  <!-- Bloque "Cambiar contraseña" (colapsable) -->
  <h3 id="chgTitle" class="pwd-hidden" style="margin-top:14px">Cambiar contraseña</h3>
  <label for="chgOld" class="pwd-hidden">Actual</label>
  <input id="chgOld" class="pwd-hidden" type="password" autocomplete="current-password">
  <label for="chgNew" class="pwd-hidden">Nueva</label>
  <input id="chgNew" class="pwd-hidden" type="password" autocomplete="new-password">
  <button class="btn btn--ghost pwd-hidden" id="chgBtn" style="margin-top:8px">Guardar nueva</button>

  <button class="btn btn--ghost" id="togglePwd" style="margin-top:8px">Cambiar contraseña</button>
</section>

<!-- =======================================================
     MAIN
======================================================= -->
<main class="main" id="appRoot">

  <!-- DASHBOARD -->
  <section id="dashboard" class="page" aria-labelledby="dashTitle">
    <article class="hero">
      <h1 id="dashTitle"><span class="black">DASHBOARD</span> <span class="red">TV</span></h1>
      <div class="sub">Panel de control</div>
    </article>

    <div class="grid dash-grid" style="margin-top:10px">
      <article class="card card--dash">
        <h2 class="card__title big"><span class="black">EQUIPOS EN</span> <span class="red">PARADA</span>
          <span class="badge" id="countParadas">0</span>
        </h2>
        <div id="dash-paradas" class="dash-list"></div>
      </article>

      <article class="card card--dash">
        <h2 class="card__title big"><span class="black">EQUIPOS CON</span> <span class="red">RESTRICCIONES</span>
          <span class="badge" id="countRestr">0</span>
        </h2>
        <div id="dash-restr" class="dash-list"></div>
      </article>

      <article class="card card--dash">
        <h2 class="card__title big"><span class="black">ALERTAS</span> <span class="red">STOCK</span> <span class="black">MÍNIMO</span>
          <span class="badge" id="countStock">0</span>
        </h2>
        <div id="dash-stock" class="dash-list"></div>
      </article>

      <!-- CONSUMIBLES BAJO STOCK -->
      <article class="card card--dash" id="card-consumibles">
        <h2 class="card__title big"><span class="black">CONSUMIBLES</span> <span class="red">BAJO STOCK</span>
          <span class="badge" id="countConsLow">0</span>
        </h2>
        <div id="dash-cons" class="dash-list"></div>
      </article>

      <article class="card card--dash">
        <h2 class="card__title big"><span class="black">AVISOS</span> <span class="red">SUBCONTRATAS</span>
          <span class="badge" id="countExt">0</span>
        </h2>
        <div id="dash-externas" class="dash-list"></div>
      </article>

      <article class="card card--dash">
        <h2 class="card__title big"><span class="black">SOLICITUDES</span> <span class="red">PRIORITARIAS</span>
          <span class="badge" id="countReq">0</span>
        </h2>
        <div id="dash-req" class="dash-list"></div>
      </article>
    </div>
  </section>

  <!-- (El resto de secciones llegan en PARTES 2/3 y 3/3) -->

</main>

<!-- =======================================================
     JS BÁSICO (helpers + nav + usuario + carrusel + routing)
======================================================= -->
<script>
  /* ENDPOINT REAL (Apps Script) */
  window.API_BASE = "https://script.google.com/macros/s/AKfycbzgTZ8zMOOKiYt2JygDLX39xQoU3elE_7T8DDFhiBYk5UOvV3F4Tp6EAE3jenj3Njzr1g/exec";
  const CDL_TOKEN_KEY = "cdl_token";
  const GET  = async (p)=>{ const r=await fetch(`${API_BASE}?path=${encodeURIComponent(p)}`,{cache:"no-store"}); try{return await r.json();}catch{return [];} };
  const POST = async (body)=>{ const r=await fetch(API_BASE,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(body),cache:"no-store"}); return r.json(); };

  /* --- NAV lateral --- */
  (function(){
    const body = document.body;
    const sidenav  = document.getElementById('sidenav');
    const navList  = document.getElementById('navList');
    const hamb     = document.getElementById('hamb');
    const closeNav = document.getElementById('closeNav');
    const goSearch = document.getElementById('goSearch');
    const gSearch  = document.getElementById('globalSearch');

    const items = [
      ['#dashboard','Dashboard'],
      ['#equipos','Equipos'],
      ['#gruas','Puentes grúa'],
      ['#auxiliares','Auxiliares'],
      ['#incidencias','Incidencias'],
      ['#inventario','Inventario'],
      ['#consumibles','Consumibles'],
      ['#repuestos','Solicitudes de repuestos'],
      ['#ot','Órdenes de trabajo'],
      ['#indicadores','Indicadores'],
      ['#registro','Registro']
    ];
    navList.innerHTML = items.map(([href,label])=> `<a href="${href}">${label}</a>`).join('');

    function openNav(){ sidenav.classList.add('open'); body.classList.add('menu-open'); hamb.setAttribute('aria-expanded','true'); }
    function closeNavFn(){ sidenav.classList.remove('open'); body.classList.remove('menu-open'); hamb.setAttribute('aria-expanded','false'); }
    hamb.addEventListener('click', (e)=>{ e.stopPropagation(); openNav(); });
    closeNav.addEventListener('click', closeNavFn);
    document.addEventListener('click', (e)=>{ if(body.classList.contains('menu-open') && !sidenav.contains(e.target) && !hamb.contains(e.target)) closeNavFn(); });

    goSearch.addEventListener('click', ()=>{
      const q=(gSearch.value||'').trim();
      if(!q) return;
      // salto simple por hash si coincide con ids
      const target = q.toLowerCase().replace(/\s+/g,'');
      location.hash = '#'+target;
    });
  })();

  /* --- Panel usuario: Acceder/Salir + Cambiar contraseña colapsable --- */
  (function(){
    const roleChip  = document.getElementById('roleChip');
    const userPanel = document.getElementById('userPanel');
    const moreBtn   = document.getElementById('moreBtn');
    const closeUser = document.getElementById('closeUser');
    const roleSel   = document.getElementById('roleSelect');
    const userPass  = document.getElementById('userPass');
    const loginBtn  = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const pwdHelp   = document.getElementById('pwdHelp');
    const togglePwd = document.getElementById('togglePwd');
    const chgEls    = ['chgTitle','chgOld','chgNew','chgBtn'].map(id=>document.getElementById(id));
    const eyeBtn    = document.getElementById('toggleEye');

    function setHelp(msg, err=false){ pwdHelp.textContent = msg; pwdHelp.style.color = err ? '#ef4444' : '#9fb0c6'; }
    function ucFirst(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1).replace(/_/g,' ') : s; }

    // Mostrar rol guardado si hay token
    (function initRoleChip(){
      const tok = localStorage.getItem(CDL_TOKEN_KEY);
      const savedRole = localStorage.getItem('cdl_role');
      if (tok && savedRole) roleChip.textContent = ucFirst(savedRole);
    })();

    moreBtn.addEventListener('click', (e)=>{ e.stopPropagation(); userPanel.classList.toggle('show'); moreBtn.setAttribute('aria-expanded', userPanel.classList.contains('show')); });
    closeUser.addEventListener('click', ()=> userPanel.classList.remove('show'));
    document.addEventListener('click', (e)=>{ if (userPanel.classList.contains('show') && !userPanel.contains(e.target) && !moreBtn.contains(e.target)) userPanel.classList.remove('show'); });

    // Ojo mostrar/ocultar
    eyeBtn.addEventListener('click', (e)=>{ e.preventDefault(); userPass.type = (userPass.type==='password') ? 'text' : 'password'; });

    // Login/Logout
    loginBtn.addEventListener('click', async ()=>{
      const user = roleSel.value;
      const pass = (userPass.value||'').trim();
      if(!pass){ setHelp('Introduce la clave.', true); return; }
      setHelp('Comprobando…');
      try{
        const r = await POST({res:'auth', fn:'login', user, pass});
        if(r.ok && r.token){
          localStorage.setItem(CDL_TOKEN_KEY, r.token);
          localStorage.setItem('cdl_role', user);
          roleChip.textContent = ucFirst(user);
          userPass.value = '';
          setHelp('Acceso correcto.');
          userPanel.classList.remove('show');
          moreBtn.setAttribute('aria-expanded','false');
        }else setHelp(r.error || 'Contraseña incorrecta.', true);
      }catch{ setHelp('Error de red.', true); }
    });
    logoutBtn.addEventListener('click', ()=>{
      localStorage.removeItem(CDL_TOKEN_KEY); localStorage.removeItem('cdl_role');
      roleChip.textContent = 'Invitado'; setHelp('Sesión cerrada.');
    });

    // Cambiar contraseña: toggle + arranque oculto
    chgEls.forEach(el => el.classList.add('pwd-hidden'));
    togglePwd.textContent = 'Cambiar contraseña';
    togglePwd.addEventListener('click', ()=>{
      const show = chgEls[0].classList.contains('pwd-hidden');
      chgEls.forEach(el=> el.classList.toggle('pwd-hidden', !show));
      togglePwd.textContent = show ? 'Ocultar cambio de contraseña' : 'Cambiar contraseña';
    });
    document.getElementById('chgBtn').addEventListener('click', async ()=>{
      const oldP = (document.getElementById('chgOld').value||'').trim();
      const newP = (document.getElementById('chgNew').value||'').trim();
      if(!oldP || !newP){ setHelp('Rellena “Actual” y “Nueva”.', true); return; }
      try{
        setHelp('Guardando nueva…');
        const r = await POST({res:'auth', fn:'change', old:oldP, neu:newP});
        if(r.ok){
          setHelp('Contraseña cambiada.');
          chgEls.forEach(el=> el.classList.add('pwd-hidden'));
          togglePwd.textContent='Cambiar contraseña';
          document.getElementById('chgOld').value=''; document.getElementById('chgNew').value='';
        }else setHelp(r.error || 'No se pudo cambiar.', true);
      }catch{ setHelp('Error de red.', true); }
    });
  })();

  /* --- Carrusel (autoplay + swipe + dots; centrado lo hace CSS) --- */
  (function(){
    const track = document.getElementById('hcTrack'); if(!track) return;
    const prev  = document.getElementById('hcPrev');
    const next  = document.getElementById('hcNext');
    const dotsWrap = document.getElementById('hcDots');

    const slides = [...track.children];
    let idx = 0, timer=null, startX=0, dx=0, dragging=false;
    const AUTO_MS = 5000;

    // dots
    dotsWrap.innerHTML = slides.map((_,i)=>`<button aria-label="Ir a ${i+1}" ${i===0?'aria-current="true"':''}></button>`).join('');
    const dots = [...dotsWrap.children];

    function goTo(i){
      idx=(i+slides.length)%slides.length;
      track.style.transition='transform .35s ease';
      track.style.transform=`translateX(${-100*idx}%)`;
      dots.forEach((d,k)=> d.setAttribute('aria-current', k===idx ? 'true':'false'));
      start(); // relanza autoplay
    }
    function start(){ stop(); timer=setInterval(()=>goTo(idx+1), AUTO_MS); }
    function stop(){ if(timer){clearInterval(timer); timer=null;} }

    // Gestos
    track.addEventListener('pointerdown', e=>{ if(e.button!==0) return; dragging=true; startX=e.clientX; dx=0; track.style.transition='none'; stop(); });
    track.addEventListener('pointermove', e=>{ if(!dragging) return; dx=e.clientX-startX; track.style.transform=`translateX(calc(${-100*idx}% + ${dx}px))`; });
    window.addEventListener('pointerup', ()=>{ if(!dragging) return; dragging=false; const w=track.clientWidth; Math.abs(dx)>w*0.15 ? goTo(idx+(dx<0?1:-1)) : goTo(idx); });

    // Controles
    prev?.addEventListener('click', ()=>goTo(idx-1));
    next?.addEventListener('click', ()=>goTo(idx+1));

    // Pausa al cambiar de pestaña
    document.addEventListener('visibilitychange', ()=> document.hidden ? stop() : start());

    goTo(0); start();
  })();

  /* --- Routing simple para marcar activo y ocultar/mostrar secciones --- */
  (function(){
    function markCurrent(){
      const hash = location.hash || '#dashboard';
      document.querySelectorAll('.navlist a').forEach(a=>{
        a.setAttribute('aria-current', a.getAttribute('href')===hash ? 'page' : 'false');
      });
      document.querySelectorAll('.page').forEach(sec=>{
        sec.hidden = ('#'+sec.id) !== hash;
      });
      // Carrusel solo visible en dashboard
      const dc = document.getElementById('dashCarousel');
      if(dc) dc.style.display = (hash==='#dashboard') ? '' : 'none';
    }
    window.addEventListener('hashchange', markCurrent);
    document.addEventListener('DOMContentLoaded', markCurrent);
    markCurrent();
  })();

  // Sombra cabecera al desplazar
  window.addEventListener('scroll', ()=>{ document.getElementById('hdr')?.classList.toggle('scrolled', window.scrollY > 6); });
</script>
<!-- ==== FIN PARTE 1/3 ==== -->
  <!-- ================= EQUIPOS ================= -->
  <section id="equipos" class="page" hidden aria-labelledby="equipTitle">
    <h1 id="equipTitle">Equipos</h1>

    <!-- Tarjeta única: ficha técnica + input + desplegable + botón en UNA línea -->
    <article class="card">
      <form id="eqForm" class="form-inline" autocomplete="off">
        <label for="eqQuery" class="form-inline__label">Ficha técnica de equipo</label>
        <input id="eqQuery" type="search" placeholder="Escribe ID o nombre… (ej: KDP-1)">
        <select id="eqSelect" aria-label="Seleccionar equipo">
          <option value="">— Selecciona de la lista —</option>
        </select>
        <button type="submit" class="btn btn--primary">Ver ficha</button>
      </form>
    </article>

    <!-- Línea Kaltenbach SIEMPRE debajo de la tarjeta -->
    <h3 id="lblKaltenbach" style="margin-top:10px">Línea Kaltenbach</h3>

    <!-- Listado de tarjetas con semáforo y acciones -->
    <div class="grid" id="equiposList" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr))"></div>
  </section>

  <!-- ================= PUENTES GRÚA ================= -->
  <section id="gruas" class="page" hidden aria-labelledby="gruasTitle">
    <h1 id="gruasTitle">Puentes grúa</h1>

    <!-- Única tarjeta con buscador + desplegable -->
    <article class="card">
      <form id="grForm" class="form-inline" autocomplete="off">
        <label for="grQuery" class="form-inline__label">Ficha técnica de puente de grúa</label>
        <input id="grQuery" type="search" placeholder="Escribe ID o nombre… (ej: N2-IMAN)">
        <select id="grSelect" aria-label="Seleccionar puente">
          <option value="">— Selecciona de la lista —</option>
        </select>
        <button type="submit" class="btn btn--primary">Ver ficha</button>
      </form>
    </article>

    <!-- Listados por naves -->
    <h3>Nave 1</h3>
    <div class="grid" id="gruasN1" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr))"></div>
    <h3>Nave 2</h3>
    <div class="grid" id="gruasN2" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr))"></div>
    <h3>Nave 3</h3>
    <div class="grid" id="gruasN3" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr))"></div>
    <h3>Nave 4</h3>
    <div class="grid" id="gruasN4" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr))"></div>
  </section>

  <!-- ================= AUXILIARES ================= -->
  <section id="auxiliares" class="page" hidden aria-labelledby="auxTitle">
    <h1 id="auxTitle">Auxiliares (otros)</h1>

    <!-- Única tarjeta con buscador + desplegable -->
    <article class="card">
      <form id="axForm" class="form-inline" autocomplete="off">
        <label for="axQuery" class="form-inline__label">Ficha técnica de auxiliar</label>
        <input id="axQuery" type="search" placeholder="Escribe ID o nombre…">
        <select id="axSelect" aria-label="Seleccionar auxiliar">
          <option value="">— Selecciona de la lista —</option>
        </select>
        <button type="submit" class="btn btn--primary">Ver ficha</button>
      </form>
    </article>

    <!-- Listado con semáforos + acciones -->
    <div class="grid" id="auxList" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr))"></div>
  </section>

  <!-- ================= INCIDENCIAS ================= -->
  <section id="incidencias" class="page" hidden aria-labelledby="incTitle">
    <h1 id="incTitle">Incidencias</h1>
    <!-- Botón crear (debajo del título) -->
    <p><button class="btn btn--primary" id="btnNewInc">Crear nueva incidencia</button></p>

    <!-- Tarjeta principal: Finalizar incidencia -->
    <article class="card" id="incFinalizar">
      <h2 class="card__title">Finalizar incidencia</h2>

      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr))">
        <div>
          <label for="incCat">Categoría</label>
          <select id="incCat">
            <option value="">Selecciona…</option>
            <option value="equipos">Equipos</option>
            <option value="gruas">Grúas</option>
            <option value="auxiliares">Auxiliares</option>
          </select>
        </div>
        <div>
          <label for="incSel">Equipo / Puente / Auxiliar</label>
          <select id="incSel" disabled>
            <option value="">— Primero elige categoría —</option>
          </select>
        </div>
        <div>
          <label for="incIntervenido">Intervenido por</label>
          <input id="incIntervenido" placeholder="Técnico">
        </div>
        <div>
          <label for="incResumen">Resumen de la solución</label>
          <input id="incResumen" placeholder="Descripción breve">
        </div>
      </div>

      <div style="margin-top:10px">
        <button class="btn btn--primary" id="incMarcarOk">Marcar como solucionada</button>
      </div>
    </article>

    <!-- Tarjeta Buscador de incidencias (sustituye “Últimas incidencias”) -->
    <article class="card">
      <h2 class="card__title">Buscador de incidencias</h2>
      <form id="incFilterForm" class="form-inline" autocomplete="off">
        <label for="incTexto" class="form-inline__label">Texto</label>
        <input id="incTexto" type="search" placeholder="Palabras clave…">
        <label for="incFiltroCat" class="form-inline__label">Categoría</label>
        <select id="incFiltroCat">
          <option value="">Todas</option>
          <option value="equipos">Equipos</option>
          <option value="gruas">Grúas</option>
          <option value="auxiliares">Auxiliares</option>
        </select>
        <label for="incEstado" class="form-inline__label">Estado</label>
        <select id="incEstado">
          <option value="">Todos</option>
          <option value="abierta">Abierta</option>
          <option value="sin_resolver">Sin resolver</option>
          <option value="solucionada">Solucionada</option>
        </select>
        <label for="incFecha" class="form-inline__label">Fecha</label>
        <input id="incFecha" type="date">
        <button type="submit" class="btn btn--ghost">Buscar</button>
      </form>
    </article>

    <!-- Listado cronológico descendente -->
    <div id="incList" class="grid" style="grid-template-columns:1fr"></div>
  </section>

  <!-- ========== JS de las secciones anteriores ========== -->
  <script>
    /* ---- helpers visuales ---- */
    function semClass(estado){
      const s = String(estado||'ok').toLowerCase();
      if(/stop|parada|rojo|crit/.test(s)) return 'sem--err';
      if(/warn|restr|amar|lim/.test(s)) return 'sem--warn';
      return 'sem--ok';
    }
    function cardEquipo({id,nombre,estado}){
      return `<article class="card">
        <header style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <h4 style="margin:0">${nombre||id}</h4>
          <span class="sem ${semClass(estado)}" aria-label="${estado||'ok'}"></span>
        </header>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button class="btn btn--ghost" data-ficha="${id}">Ver ficha</button>
          <button class="btn btn--ghost" data-incidencia="${id}">Crear incidencia</button>
        </div>
      </article>`;
    }

    /* ---------- EQUIPOS ---------- */
    async function loadEquipos(){
      const data = await GET('equipos'); // [{id,nombre,linea,estado}, ...]
      // desplegable
      const sel = document.getElementById('eqSelect');
      sel.innerHTML = '<option value="">— Selecciona de la lista —</option>' +
        (data||[]).map(e=>`<option value="${e.id}">${e.nombre||e.id}</option>`).join('');
      // listado Kaltenbach
      const list = document.getElementById('equiposList');
      const kal = (data||[]).filter(e=> /kaltenbach/i.test(e.linea||''));
      list.innerHTML = kal.length ? kal.map(cardEquipo).join('') :
        '<div style="color:#64748b">No hay equipos de Línea Kaltenbach en la respuesta.</div>';
    }
    // ver ficha (input + select)
    document.getElementById('eqForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const id = (document.getElementById('eqQuery').value || document.getElementById('eqSelect').value || '').trim();
      if(!id) return alert('Escribe o elige un equipo');
      sessionStorage.setItem('cdl_ficha', id);
      location.hash = '#equipos';
      // El modal real se abre en Parte 3
      alert('Abriré la FICHA en el modal (Parte 3). ID: '+id);
    });

    /* ---------- GRÚAS ---------- */
    async function loadGruas(){
      const data = await GET('gruas'); // [{id,nave,estado}, ...]
      const sel = document.getElementById('grSelect');
      sel.innerHTML = '<option value="">— Selecciona de la lista —</option>' +
        (data||[]).map(g=>`<option value="${g.id}">${g.id}</option>`).join('');
      // por naves
      for(const n of [1,2,3,4]){
        const cont = document.getElementById('gruasN'+n);
        if(!cont) continue;
        const arr = (data||[]).filter(g=> String(g.nave)==String(n));
        cont.innerHTML = arr.length ? arr.map(cardEquipo).join('') :
          '<div style="color:#64748b">Sin puentes registrados en esta nave.</div>';
      }
    }
    document.getElementById('grForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const id = (document.getElementById('grQuery').value || document.getElementById('grSelect').value || '').trim();
      if(!id) return alert('Escribe o elige un puente');
      sessionStorage.setItem('cdl_ficha', id);
      location.hash = '#gruas';
      alert('Abriré la FICHA en el modal (Parte 3). ID: '+id);
    });

    /* ---------- AUXILIARES ---------- */
    async function loadAuxiliares(){
      const data = await GET('auxiliares'); // [{id,nombre,estado}, ...]
      const sel = document.getElementById('axSelect');
      sel.innerHTML = '<option value="">— Selecciona de la lista —</option>' +
        (data||[]).map(a=>`<option value="${a.id}">${a.nombre||a.id}</option>`).join('');
      document.getElementById('auxList').innerHTML = (data||[]).map(cardEquipo).join('');
    }
    document.getElementById('axForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const id = (document.getElementById('axQuery').value || document.getElementById('axSelect').value || '').trim();
      if(!id) return alert('Escribe o elige un auxiliar');
      sessionStorage.setItem('cdl_ficha', id);
      location.hash = '#auxiliares';
      alert('Abriré la FICHA en el modal (Parte 3). ID: '+id);
    });

    /* ---------- INCIDENCIAS ---------- */
    async function loadIncidencias(){
      const data = await GET('incidencias'); // libre; render mínimo
      renderIncList(data);
    }
    function renderIncList(arr){
      const list = document.getElementById('incList');
      const data = (arr||[]).slice().sort((a,b)=> (b.ts||0)-(a.ts||0));
      list.innerHTML = data.map(it=>`
        <article class="card">
          <header style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap">
            <strong>${it.equipo||'-'}</strong>
            <span style="font-size:12px;color:#64748b">${it.ts ? new Date(it.ts).toLocaleString() : ''}</span>
          </header>
          <p style="margin:.5rem 0">${it.resumen||it.desc||'-'}</p>
          <div style="font-size:12px;color:#64748b">Estado: ${it.estado||'-'}</div>
        </article>`).join('');
    }
    // Finalizar incidencia
    document.getElementById('incCat').addEventListener('change', async (e)=>{
      const sel = document.getElementById('incSel');
      const cat = e.target.value;
      sel.disabled = !cat;
      if(!cat){ sel.innerHTML = '<option value="">— Primero elige categoría —</option>'; return; }
      const data = await GET(cat); // reutilizamos endpoints: equipos/gruas/auxiliares
      sel.innerHTML = '<option value="">— Selecciona —</option>' +
        (data||[]).map(x=>`<option value="${x.id}">${x.nombre||x.id}</option>`).join('');
    });
    document.getElementById('incMarcarOk').addEventListener('click', async ()=>{
      const cat  = document.getElementById('incCat').value;
      const id   = document.getElementById('incSel').value;
      const tec  = (document.getElementById('incIntervenido').value||'').trim() || 'PENDIENTE';
      const res  = (document.getElementById('incResumen').value||'').trim() || 'Incidencia solucionada';
      if(!cat || !id) return alert('Elige categoría y equipo/puente/auxiliar.');
      // Parte 3 marcará en servidor; aquí dejamos rastro UX:
      alert(`Marcada como solucionada: ${id} (${cat})\nIntervenido por: ${tec}\n${res}`);
    });
    // Buscador de incidencias
    document.getElementById('incFilterForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const q   = (document.getElementById('incTexto').value||'').toLowerCase();
      const cat = document.getElementById('incFiltroCat').value;
      const est = document.getElementById('incEstado').value;
      const f   = document.getElementById('incFecha').value;
      const data = await GET('incidencias');
      const out = (data||[]).filter(it=>{
        const okTxt = !q || (`${it.equipo||''} ${it.resumen||it.desc||''}`.toLowerCase().includes(q));
        const okCat = !cat || (String(it.cat||it.categoria||'').toLowerCase()===cat);
        const okEst = !est || (String(it.estado||'').toLowerCase().includes(est));
        const okF   = !f || (it.ts && new Date(it.ts).toISOString().slice(0,10)===f);
        return okTxt && okCat && okEst && okF;
      });
      renderIncList(out);
    });

    /* ---------- Carga inicial de datos (de estas secciones) ---------- */
    document.addEventListener('DOMContentLoaded', ()=>{
      loadEquipos();
      loadGruas();
      loadAuxiliares();
      loadIncidencias();
    });

    /* Click delegados “Ver ficha” y “Crear incidencia” en tarjetas */
    document.addEventListener('click', (e)=>{
      const ficha = e.target.closest('[data-ficha]');
      if(ficha){
        sessionStorage.setItem('cdl_ficha', ficha.getAttribute('data-ficha'));
        alert('Abriré la FICHA en el modal (Parte 3). ID: '+ficha.getAttribute('data-ficha'));
      }
      const inc = e.target.closest('[data-incidencia]');
      if(inc){
        location.hash = '#incidencias';
        document.getElementById('incCat').value = 'equipos';
        document.getElementById('incCat').dispatchEvent(new Event('change'));
        setTimeout(()=>{ document.getElementById('incSel').value = inc.getAttribute('data-incidencia'); }, 200);
      }
    });
  </script>
  <!-- ==== FIN PARTE 2/3 ==== -->
    <!-- ================= INVENTARIO ================= -->
  <section id="inventario" class="page" hidden aria-labelledby="invTitle">
    <h1 id="invTitle">Inventario</h1>

    <!-- Tarjeta 1: estado + acciones rápidas -->
    <article class="card">
      <div class="card__hdr" style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <h2 class="card__title">Estado de stock</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn--primary" id="invAdd">Añadir repuesto</button>
          <button class="btn btn--ghost"   id="invSub">Descontar</button>
        </div>
      </div>
      <div id="invAlerts" style="margin-top:8px"></div>
    </article>

    <!-- Tarjeta 2: buscador 1 línea + QR -->
    <article class="card">
      <h2 class="card__title">Buscar</h2>
      <form id="invSearchForm" class="form-inline" autocomplete="off" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <input id="invQuery" type="search" placeholder="Código, referencia o nombre…">
        <button class="btn btn--ghost" type="submit">Buscar</button>
        <button class="btn btn--ghost" id="invClear" type="button">Limpiar</button>
        <button class="btn btn--ghost" id="invScan"  type="button">Escanear QR</button>
      </form>
      <video id="qrVideo" playsinline style="display:none;width:100%;max-width:420px;border:1px solid #e5e7eb;border-radius:12px;margin-top:8px"></video>
    </article>

    <!-- Catálogo estilo “ferretería online” -->
    <article class="card">
      <h2 class="card__title">Catálogo</h2>
      <div id="invCats" class="grid" style="grid-template-columns:1fr"></div>
    </article>

    <!-- Tarjeta 3 (CSV+QR) — visible solo admin -->
    <article class="card" id="invCsvCard" data-role="admin" hidden>
      <h2 class="card__title">Inventario (CSV + QR)</h2>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <input id="csvUrl" placeholder="URL CSV (opcional)" style="flex:1 1 260px">
        <button class="btn btn--ghost" id="csvLoad">Cargar CSV</button>
        <input type="file" id="csvFile" accept=".csv" style="display:none">
        <button class="btn btn--ghost" id="csvPick">Cargar archivo…</button>
        <button class="btn btn--ghost" id="csvPrintQR">Imprimir QR seleccionados</button>
      </div>
      <div id="invTableWrap" style="margin-top:10px"></div>
    </article>
  </section>

  <!-- ================= CONSUMIBLES ================= -->
  <section id="consumibles" class="page" hidden aria-labelledby="consTitle">
    <h1 id="consTitle">Consumibles</h1>

    <!-- Alarma colapsable -->
    <details id="consLow" style="margin-bottom:10px">
      <summary class="badge" style="background:#fee2e2;color:#991b1b;border-color:#fecaca;font-weight:900">
        Consumibles por debajo del mínimo (pulsa para ver)
      </summary>
      <div id="consLowList" class="grid" style="grid-template-columns:1fr;margin-top:8px"></div>
    </details>

    <!-- Única tarjeta: listado + añadir -->
    <article class="card">
      <div class="card__hdr" style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <h2 class="card__title">Listado</h2>
        <button class="btn btn--primary" id="consAdd">Añadir consumible</button>
      </div>
      <div id="consList" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr))"></div>
    </article>
  </section>

  <!-- ================= REPUESTOS (solicitudes) ================= -->
  <section id="repuestos" class="page" hidden aria-labelledby="repTitle">
    <h1 id="repTitle">Solicitudes de repuestos</h1>

    <article class="card">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr))">
        <div>
          <label for="reqRef">Repuesto (ref o nombre)</label>
          <input id="reqRef" placeholder="Ej: TOH-M12x60">
        </div>
        <div>
          <label for="reqQty">Cantidad</label>
          <input id="reqQty" type="number" min="1" value="1">
        </div>
        <div>
          <label for="reqObs">Observaciones</label>
          <input id="reqObs" placeholder="Urgente, alternativa, etc.">
        </div>
      </div>
      <div style="margin-top:10px"><button class="btn btn--primary" id="reqSend">Enviar solicitud</button></div>
    </article>

    <article class="card">
      <div class="card__hdr" style="display:flex;justify-content:space-between;align-items:center">
        <h2 class="card__title">Solicitudes</h2>
        <span class="badge" id="reqCount">0</span>
      </div>
      <div id="reqList"></div>
    </article>
  </section>

  <!-- ================= ÓRDENES DE TRABAJO ================= -->
  <section id="ot" class="page" hidden aria-labelledby="otTitle">
    <h1 id="otTitle">Órdenes de trabajo</h1>

    <article class="card">
      <h2 class="card__title">Crear OT</h2>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
        <div>
          <label for="otEq">Equipo</label>
          <input id="otEq" list="eqList" placeholder="KDP-1…">
          <datalist id="eqList"></datalist>
        </div>
        <div>
          <label for="otTipo">Tipo</label>
          <select id="otTipo">
            <option>Engrase</option><option>Lubricación</option>
            <option>Ajuste mecánico</option><option>Ajuste eléctrico</option>
          </select>
        </div>
        <div>
          <label for="otFecha">Fecha</label>
          <input id="otFecha" type="date">
        </div>
      </div>
      <label for="otTarea" style="margin-top:8px;display:block">Tarea</label>
      <input id="otTarea" placeholder="Describe la OT…">
      <div style="margin-top:10px"><button class="btn btn--primary" id="otCrear">Crear OT</button></div>
    </article>

    <article class="card">
      <div class="card__hdr" style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <h2 class="card__title">Listado</h2>
        <div style="display:flex;gap:8px">
          <input id="otFilter" placeholder="Filtrar…">
          <button class="btn btn--ghost" id="otReload">Recargar</button>
        </div>
      </div>
      <div id="otList"></div>
    </article>
  </section>

  <!-- ================= INDICADORES (KPI) ================= -->
  <section id="indicadores" class="page" hidden aria-labelledby="indTitle">
    <h1 id="indTitle">Indicadores</h1>
    <div class="grid cols-3">
      <article class="card"><h3 class="card__title">MTBF</h3><canvas id="chMtbf" width="640" height="260"></canvas></article>
      <article class="card"><h3 class="card__title">MTTR</h3><canvas id="chMttr" width="640" height="260"></canvas></article>
      <article class="card"><h3 class="card__title">Disponibilidad</h3><canvas id="chDisp" width="640" height="260"></canvas></article>
    </div>
  </section>

  <!-- ================= REGISTRO ================= -->
  <section id="registro" class="page" hidden aria-labelledby="regTitle">
    <h1 id="regTitle">Registro de mantenimiento</h1>
    <article class="card">
      <div class="card__hdr" style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <h2 class="card__title">Histórico</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <input id="regQ" placeholder="Equipo, técnico, texto…">
          <select id="regTipo">
            <option value="">Todo</option>
            <option value="incidencia">Incidencias</option>
            <option value="ot">Órdenes de trabajo</option>
          </select>
          <button class="btn btn--ghost" id="regReload">Recargar</button>
        </div>
      </div>
      <div id="regList"></div>
    </article>
  </section>

  <!-- ============ MODAL FICHA TÉCNICA ============ -->
  <div id="modalBg"   style="position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);display:none;z-index:900"></div>
  <div id="modalCard" style="position:fixed;left:50%;top:10dvh;transform:translateX(-50%);width:min(900px,92vw);background:#0f141c;color:#e6eef7;border:1px solid #223046;border-radius:16px;box-shadow:0 20px 36px rgba(0,0,0,.45);padding:14px;display:none;z-index:950">
    <header style="display:flex;justify-content:space-between;align-items:center;gap:10px">
      <h3 id="modalT" style="margin:0">Ficha</h3>
      <button id="modalX" class="btn btn--ghost">Cerrar</button>
    </header>
    <div id="modalC" style="max-height:min(65dvh,560px);overflow:auto;margin-top:8px"></div>
  </div>

  <!-- ======================== JS FINAL ======================== -->
  <script>
    /* --------------------- CONFIG API REAL --------------------- */
    window.API_BASE = "https://script.google.com/macros/s/AKfycbzgTZ8zMOOKiYt2JygDLX39xQoU3elE_7T8DDFhiBYk5UOvV3F4Tp6EAE3jenj3Njzr1g/exec";
    const GET  = async (p)=>{ const r=await fetch(`${API_BASE}?path=${encodeURIComponent(p)}`,{cache:"no-store"}); try{return await r.json();}catch{return [];} };
    const POST = async (body)=>{ const r=await fetch(API_BASE,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(body)}); return r.json(); };

    /* --------------------- MODAL helpers --------------------- */
    const bg = document.getElementById('modalBg');
    const mc = document.getElementById('modalCard');
    const mt = document.getElementById('modalT');
    const md = document.getElementById('modalC');
    function openModal(t, html){ mt.textContent=t||'Detalle'; md.innerHTML=html||''; bg.style.display=mc.style.display='block'; }
    function closeModal(){ bg.style.display=mc.style.display='none'; }
    document.getElementById('modalX').onclick = closeModal; bg.onclick = closeModal;
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

    /* --------------------- FICHA TÉCNICA --------------------- */
    async function fichaRender(id){
      // primero intentamos /equipos, luego /gruas y /auxiliares
      let e = (await GET('equipos')).find(x=>String(x.id).toLowerCase()===String(id).toLowerCase());
      if(!e) e = (await GET('gruas')).find(x=>String(x.id).toLowerCase()===String(id).toLowerCase());
      if(!e) e = (await GET('auxiliares')).find(x=>String(x.id).toLowerCase()===String(id).toLowerCase());
      if(!e) return openModal('Ficha', '<div class="badge">No encontrado</div>');

      const kv = (k,v)=>`<span class="badge"><strong>${k}:</strong> ${v ?? '—'}</span>`;
      const meta = [
        kv('Ubicación',e.ubicacion), kv('Nave',e.nave), kv('Grupo',e.grupo),
        kv('Fabricante',e.fabricante), kv('Modelo',e.modelo), kv('Año',e.anno),
        kv('Nº serie',e.numero_serie)
      ].join('');

      const html = `
        <div style="display:flex;gap:6px;flex-wrap:wrap">${meta}</div>
        <h4 style="margin:10px 0 6px">Observaciones</h4>
        <div class="card" style="background:#0b101a;color:#cfe1f7;border:1px solid #243046">${e.observaciones||'—'}</div>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <a href="./manuales/${(e.nombre||e.id||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^\w\s-]/g,'').trim().replace(/\s+/g,'_')}.pdf" target="_blank" class="btn btn--primary">Manual</a>
          <button class="btn btn--ghost" onclick="window.print()">Imprimir</button>
        </div>`;
      openModal(`${e.nombre||e.id} — Ficha técnica`, html);
    }
    // abrir ficha si viene de los formularios
    (function bootFichaFromSession(){
      const id = sessionStorage.getItem('cdl_ficha');
      if(id){ sessionStorage.removeItem('cdl_ficha'); fichaRender(id); }
    })();

    /* --------------------- INVENTARIO --------------------- */
    function renderCat(c){
      return `
        <details>
          <summary style="font-weight:900">${c.categoria||'Sin categoría'}</summary>
          <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr));margin-top:8px">
            ${(c.items||[]).map(i=>`
              <article class="card">
                <header style="display:flex;justify-content:space-between;align-items:center;gap:8px">
                  <strong>${i.ref||i.codigo}</strong>
                  <span class="badge" style="font-size:11px">${i.stock ?? '-'}</span>
                </header>
                <p style="margin:.5rem 0">${i.desc||''}</p>
                <div class="qty">
                  <button class="btn" data-act="plus1"   data-ref="${i.ref}">+1</button>
                  <button class="btn" data-act="plus10"  data-ref="${i.ref}">+10</button>
                  <button class="btn" data-act="plus100" data-ref="${i.ref}">+100</button>
                  <button class="btn" data-act="minus1"   data-ref="${i.ref}">-1</button>
                  <button class="btn" data-act="minus10"  data-ref="${i.ref}">-10</button>
                  <button class="btn" data-act="minus100" data-ref="${i.ref}">-100</button>
                </div>
              </article>`).join('')}
          </div>
        </details>`;
    }
    async function invLoad(){
      const data = await GET('inventario'); // [{categoria, items:[{ref,desc,stock,min,...}]}]
      const cats = document.getElementById('invCats');
      cats.innerHTML = (data||[]).map(renderCat).join('');
      // alertas de mínimo
      const lows = (data||[]).flatMap(c=>(c.items||[]).filter(i=>Number(i.stock)<=Number(i.min)));
      document.getElementById('invAlerts').innerHTML = lows.length
        ? `<div class="badge" style="background:#fff7ed;border-color:#fed7aa;color:#9a3412">${lows.length} referencias por debajo del mínimo</div>`
        : '<span style="color:#64748b">Sin alertas de stock mínimo</span>';
      // datalist de equipos para OTs
      const eq = await GET('equipos');
      document.getElementById('eqList').innerHTML = (eq||[]).map(x=>`<option value="${x.id}">`).join('');
    }
    // acciones sumar/restar rápidas
    document.addEventListener('click', async (e)=>{
      const b = e.target.closest('button[data-act]');
      if(!b) return;
      const act = b.dataset.act, ref = b.dataset.ref;
      const delta = {plus1:1,plus10:10,plus100:100,minus1:-1,minus10:-10,minus100:-100}[act]||0;
      if(!ref || !delta) return;
      try{
        await POST({res:'inventario', fn:'ajustar', ref, delta});
        invLoad();
      }catch{ alert('No se pudo actualizar la referencia'); }
    });
    // buscador/limpiar
    document.getElementById('invSearchForm').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const q = (document.getElementById('invQuery').value||'').toLowerCase();
      const data = await GET('inventario');
      const fil = (data||[]).map(c=>({
        categoria:c.categoria,
        items:(c.items||[]).filter(i=>
          String(i.ref||'').toLowerCase().includes(q) ||
          String(i.desc||'').toLowerCase().includes(q) ||
          String(i.codigo||'').toLowerCase().includes(q))
      })).filter(c=>c.items.length);
      document.getElementById('invCats').innerHTML = fil.length ? fil.map(renderCat).join('') : '<div style="color:#64748b">Sin resultados</div>';
    });
    document.getElementById('invClear').onclick = ()=>{ document.getElementById('invQuery').value=''; invLoad(); };

    /* --------------------- CONSUMIBLES --------------------- */
    async function consLoad(){
      const data = await GET('consumibles'); // [{ref,nombre,desc,stock,min}, ...]
      const lows = (data||[]).filter(i=>Number(i.stock)<=Number(i.min));
      const lowList = document.getElementById('consLowList');
      lowList.innerHTML = lows.length ? lows.map(i=>`
        <article class="card"><header><strong>${i.ref||i.nombre}</strong></header>
        <p>Stock: ${i.stock} · Mínimo: ${i.min}</p></article>`).join('') : '<div style="color:#64748b">Sin alertas</div>';
      const list = document.getElementById('consList');
      list.innerHTML = (data||[]).map(i=>`
        <article class="card">
          <header style="display:flex;justify-content:space-between;align-items:center"><strong>${i.ref||i.nombre}</strong><span class="badge">${i.stock ?? '-'}</span></header>
          <p style="margin:.5rem 0">${i.desc||''}</p>
          <div class="qty">
            <button class="btn" data-cons="${i.ref}" data-d="+1">+1</button>
            <button class="btn" data-cons="${i.ref}" data-d="-1">-1</button>
          </div>
        </article>`).join('');
    }
    document.addEventListener('click', async (e)=>{
      const b = e.target.closest('button[data-cons]');
      if(!b) return;
      await POST({res:'consumibles', fn:'ajustar', ref:b.dataset.cons, delta:Number(b.dataset.d)});
      consLoad();
    });

    /* --------------------- SOLICITUDES DE REPUESTOS --------------------- */
    async function reqLoad(){
      const list = await GET('repuestos') || [];
      document.getElementById('reqCount').textContent = list.length;
      document.getElementById('reqList').innerHTML = list.map(r=>`
        <article class="card">
          <header style="display:flex;justify-content:space-between;align-items:center">
            <strong>${r.ref||'-'} × ${r.qty||1}</strong>
            <span style="font-size:12px;color:#64748b">${r.fecha||''}</span>
          </header>
          <p style="margin:.5rem 0">${r.obs||''}</p>
          <div class="badge">${r.estado||'pendiente'}</div>
        </article>`).join('');
    }
    document.getElementById('reqSend').onclick = async ()=>{
      const ref = (document.getElementById('reqRef').value||'').trim();
      const qty = Number(document.getElementById('reqQty').value||1);
      const obs = (document.getElementById('reqObs').value||'').trim();
      if(!ref || qty<=0) return alert('Referencia y cantidad > 0');
      await POST({res:'repuestos', fn:'crear', ref, qty, obs});
      document.getElementById('reqRef').value=''; document.getElementById('reqQty').value=1; document.getElementById('reqObs').value='';
      reqLoad();
    };

    /* --------------------- OTs --------------------- */
    async function otLoad(){
      const list = await GET('ot');
      const q = (document.getElementById('otFilter')?.value||'').toLowerCase();
      const fil = (list||[]).filter(o=>!q || `${o.id||''} ${o.equipo||''} ${o.tarea||''}`.toLowerCase().includes(q));
      document.getElementById('otList').innerHTML = (fil||[]).map(o=>`
        <article class="card" data-ot="${o.id}">
          <header style="display:flex;justify-content:space-between;align-items:center">
            <strong>${o.id||''} — ${o.equipo||''}</strong>
            <span class="badge">${o.estado||'abierta'}</span>
          </header>
          <p style="margin:.5rem 0">${o.tarea||''}</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn btn--ghost" data-ot-fin="${o.id}">Marcar finalizada</button>
          </div>
        </article>`).join('');
    }
    document.getElementById('otCrear').onclick = async ()=>{
      const equipo = (document.getElementById('otEq').value||'').trim();
      const tipo   = document.getElementById('otTipo').value;
      const fecha  = document.getElementById('otFecha').value;
      const tarea  = (document.getElementById('otTarea').value||'').trim();
      if(!equipo || !tarea) return alert('Equipo y tarea son obligatorios.');
      await POST({res:'ot', fn:'crear', equipo, tipo, fecha, tarea});
      document.getElementById('otTarea').value=''; otLoad();
    };
    document.addEventListener('click', async (e)=>{
      const b = e.target.closest('[data-ot-fin]');
      if(!b) return;
      const id = b.getAttribute('data-ot-fin');
      const tec = prompt('Intervenido por','')||'PENDIENTE';
      const desc= prompt('Resumen final','OT finalizada')||'OT finalizada';
      await POST({res:'ot', fn:'complete', id, intervenido_por:tec, descripcion:desc});
      otLoad();
      // registrar en histórico
      await POST({res:'registro', fn:'add', item:{tipo:'ot', equipo:'', titulo:desc}});
      regLoad();
    });
    document.getElementById('otReload').onclick = otLoad;
    document.getElementById('otFilter').addEventListener('input', ()=>{ clearTimeout(window._ott); window._ott=setTimeout(otLoad,200); });

    /* --------------------- REGISTRO --------------------- */
    async function regLoad(){
      const list = await GET('registro');
      const q = (document.getElementById('regQ').value||'').toLowerCase();
      const t = document.getElementById('regTipo').value;
      const data = (list||[]).filter(x=>{
        const okT = !t || x.tipo===t;
        const okQ = !q || (`${x.equipo||''} ${x.titulo||''} ${x.intervenido_por||''}`.toLowerCase().includes(q));
        return okT && okQ;
      }).sort((a,b)=> String(b.fecha||'').localeCompare(String(a.fecha||'')));
      document.getElementById('regList').innerHTML = data.map(x=>`
        <div class="line-1" style="display:grid;grid-template-columns:1fr auto;gap:8px">
          <div><strong>${x.equipo||''}</strong> — ${x.titulo||''}<div style="font-size:12px;color:#64748b">${x.fecha||''} · ${x.intervenido_por||''}</div></div>
          <span class="badge">${x.tipo==='ot'?'OT':'Incidencia'}</span>
        </div>`).join('');
    }
    document.getElementById('regReload').onclick = regLoad;
    document.getElementById('regQ').addEventListener('input', ()=>{ clearTimeout(window._regt); window._regt=setTimeout(regLoad,200); });
    document.getElementById('regTipo').addEventListener('change', regLoad);

    /* --------------------- INICIALIZACIÓN (final) --------------------- */
    document.addEventListener('DOMContentLoaded', ()=>{
      invLoad(); consLoad(); reqLoad(); otLoad(); regLoad();
      // visibilidad de tarjeta CSV+QR según rol
      const role = localStorage.getItem('cdl_role') || 'invitado';
      document.querySelectorAll('[data-role="admin"]').forEach(el=> el.hidden = (role!=='admin'));
    });
  </script>
  <script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js');

  // Forzar activación inmediata cuando haya uno nuevo
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    // Puedes notificar al usuario o recargar suave si quieres
    // location.reload();
  });

  navigator.serviceWorker.ready.then(reg => {
    if (reg && reg.waiting) {
      reg.waiting.postMessage({ type: 'SKIP_WAITING' });
    }
    reg.addEventListener('updatefound', () => {
      const nw = reg.installing;
      if (!nw) return;
      nw.addEventListener('statechange', () => {
        if (nw.state === 'installed' && reg.waiting) {
          reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        }
      });
    });
  });
}
</script>
</body>
</html>