<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>CDL · Panel de control</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="apple-touch-icon.png">

<!-- Fuente -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- =========================================
       HEADER (Bloque 2 + ajustes)
  ========================================== -->
  <header id="appHeader" role="banner" aria-label="Cabecera de la aplicación">
    <div class="hdr-wrap">
      <!-- Marca CDL -->
      <a class="brand" href="./#dashboard" aria-label="Ir al Dashboard">
        <img src="logo-cdl.png" alt="CDL" class="brand__mark">
        <span class="brand__title">CDL · Panel de control</span>
      </a>

      <!-- Acciones: usuario/roles + hamburguesa -->
      <div class="hdr-actions">
        <!-- Área usuario/roles -->
        <div class="user-area" id="userArea">
          <button class="user-btn" id="userBtn" aria-haspopup="true" aria-expanded="false" aria-controls="userMenu">
            <span class="user-name" id="userName">Invitado</span>
            <span class="user-role-badge" id="userRoleBadge">Invitado</span>
          </button>

          <!-- Menú usuario -->
          <div class="user-menu" id="userMenu" hidden role="menu" aria-label="Menú de usuario">
            <div class="user-menu__row">
              <label for="roleSelect"><strong>Rol:</strong></label>
              <select id="roleSelect" name="roleSelect">
                <option value="invitado" selected>Invitado</option>
                <option value="mantenimiento">Mantenimiento</option>
                <option value="supervisor">Supervisor</option>
                <option value="jefe">Jefe de Mantenimiento</option>
                <option value="admin">Admin</option>
              </select>
            </div>

            <div class="user-menu__row">
              <button id="applyRole" class="btn btn--primary" role="menuitem">Aplicar rol</button>
              <button id="switchUser" class="btn btn--ghost" role="menuitem">Cambiar usuario</button>
            </div>

            <hr>

            <!-- Solo botón, panel oculto -->
            <div class="user-menu__row">
              <button id="togglePwdPanel" class="btn" role="menuitem" aria-expanded="false" aria-controls="pwdPanel">
                Cambio de contraseña
              </button>
            </div>

            <fieldset id="pwdPanel" hidden>
              <legend class="sr-only">Cambio de contraseña</legend>
              <label for="pwdOld">Actual</label>
              <input id="pwdOld" type="password" autocomplete="current-password">
              <label for="pwdNew">Nueva</label>
              <input id="pwdNew" type="password" autocomplete="new-password">
              <button id="pwdApply" class="btn btn--primary">Guardar</button>
            </fieldset>

            <hr>

            <div class="user-menu__row">
              <button id="loginBtn" class="btn btn--ghost" role="menuitem">Acceder</button>
              <button id="logoutBtn" class="btn btn--ghost" role="menuitem">Salir</button>
            </div>
          </div>
        </div>

        <!-- Botón hamburguesa -->
        <button class="btn-hamburger" id="hamburgerBtn" aria-label="Abrir menú" aria-controls="navDrawer" aria-expanded="false">☰</button>
      </div>
    </div>

    <!-- Logo MANTENIMIENTO en su fila (no tapa CDL) -->
    <div class="mant-wrap" aria-hidden="false">
      <img src="logo_mantenimiento.png" alt="MANTENIMIENTO" class="brand__mant-img" id="mantLogo">
    </div>
  </header>

  <!-- =========================================
       NAV DRAWER (menú lateral)
  ========================================== -->
  <aside id="navDrawer" class="drawer" role="dialog" aria-modal="true" aria-label="Menú de navegación" hidden>
    <div class="drawer__top">
      <!-- Buscador con Intro y X a la derecha -->
      <form id="navSearchForm" class="drawer__search" role="search">
        <input type="search" id="navSearch" name="q" placeholder="Buscar…" aria-label="Buscar en la app">
        <button type="submit" id="navSearchGo" class="btn">Intro</button>
        <button type="button" id="navClose" class="btn btn--icon" aria-label="Cerrar menú">✕</button>
      </form>
    </div>

    <nav class="drawer__nav" aria-label="Secciones">
      <a href="#dashboard" class="drawer__link">Dashboard</a>
      <a href="#equipos" class="drawer__link">Equipos</a>
      <a href="#gruas" class="drawer__link">Puentes Grúa</a>
      <a href="#auxiliares" class="drawer__link">Auxiliares</a>
      <a href="#incidencias" class="drawer__link">Incidencias</a>
      <a href="#inventario" class="drawer__link">Inventario</a>
      <a href="#solicitudes" class="drawer__link">Solicitudes de repuestos</a>
      <a href="#ots" class="drawer__link">OTs</a>
      <a href="#test" class="drawer__link">Test</a>
    </nav>
  </aside>

  <!-- =========================================
       CONTENIDO
  ========================================== -->
  <main id="appMain" role="main">
    <!-- DASHBOARD (único con carrusel) -->
    <section id="dashboard" role="region" aria-labelledby="ttl-dash">
      <header class="sec-hdr">
        <h2 id="ttl-dash">DASHBOARD TV <img src="angular.png" alt="" class="angular"></h2>
      </header>

      <!-- Carrusel (centrado por CSS en fase STYLE) -->
      <div class="carousel" id="mainCarousel" aria-label="Galería de imágenes">
        <div class="carousel__viewport" id="carouselViewport">
          <!-- JS inyecta slides <figure><img ...></figure> -->
        </div>
        <div class="carousel__controls">
          <button class="btn" id="carPrev" aria-label="Anterior">‹</button>
          <button class="btn" id="carNext" aria-label="Siguiente">›</button>
        </div>
      </div>

      <!-- KPIs/Indicadores (placeholder) -->
      <div id="dashKpis" class="cards-grid" aria-live="polite"></div>
    </section>

    <!-- EQUIPOS -->
    <section id="equipos" role="region" aria-labelledby="ttl-equipos">
      <header class="sec-hdr">
        <h2 id="ttl-equipos">EQUIPOS <img src="angular.png" alt="" class="angular"></h2>
      </header>

      <!-- Tarjeta única: ficha técnica -->
      <article class="card">
        <form id="equipoFichaForm" class="form-inline" autocomplete="off">
          <label for="equipoQuery" class="form-inline__label">Ficha técnica de equipo</label>
          <input id="equipoQuery" name="equipoQuery" type="search" placeholder="Escribe ID o nombre…">
          <select id="equipoSelect" name="equipoSelect" aria-label="Seleccionar equipo" title="Listado de equipos">
            <option value="">— Selecciona de la lista —</option>
          </select>
          <button type="submit" class="btn btn--primary">Ver ficha</button>
        </form>
      </article>

      <!-- Encabezado de línea -->
      <h3 class="line-hdr">Línea Kaltenbach</h3>

      <!-- Tarjetas de equipos (JS) -->
      <div id="equiposList" class="cards-grid" aria-live="polite"></div>
    </section>

    <!-- PUENTES GRÚA -->
    <section id="gruas" role="region" aria-labelledby="ttl-gruas">
      <header class="sec-hdr">
        <h2 id="ttl-gruas">PUENTES GRÚA <img src="angular.png" alt="" class="angular"></h2>
      </header>

      <!-- Tarjeta única: ficha técnica -->
      <article class="card">
        <form id="gruaFichaForm" class="form-inline" autocomplete="off">
          <label for="gruaQuery" class="form-inline__label">Ficha técnica de puente de grúa</label>
          <input id="gruaQuery" name="gruaQuery" type="search" placeholder="Escribe ID o nombre…">
          <select id="gruaSelect" name="gruaSelect" aria-label="Seleccionar puente grúa" title="Listado de puentes">
            <option value="">— Selecciona de la lista —</option>
          </select>
          <button type="submit" class="btn btn--primary">Ver ficha</button>
        </form>
      </article>

      <!-- Listado por naves -->
      <h3 class="line-hdr">Nave 1</h3><div id="gruasN1" class="cards-grid" aria-live="polite"></div>
      <h3 class="line-hdr">Nave 2</h3><div id="gruasN2" class="cards-grid" aria-live="polite"></div>
      <h3 class="line-hdr">Nave 3</h3><div id="gruasN3" class="cards-grid" aria-live="polite"></div>
      <h3 class="line-hdr">Nave 4</h3><div id="gruasN4" class="cards-grid" aria-live="polite"></div>
    </section>

    <!-- AUXILIARES -->
    <section id="auxiliares" role="region" aria-labelledby="ttl-aux">
      <header class="sec-hdr">
        <h2 id="ttl-aux">AUXILIARES (OTROS) <img src="angular.png" alt="" class="angular"></h2>
      </header>

      <article class="card">
        <form id="auxFichaForm" class="form-inline" autocomplete="off">
          <label for="auxQuery" class="form-inline__label">Ficha técnica de auxiliar</label>
          <input id="auxQuery" name="auxQuery" type="search" placeholder="Escribe ID o nombre…">
          <select id="auxSelect" name="auxSelect" aria-label="Seleccionar auxiliar">
            <option value="">— Selecciona de la lista —</option>
          </select>
          <button type="submit" class="btn btn--primary">Ver ficha</button>
        </form>
      </article>

      <div id="auxList" class="cards-grid" aria-live="polite"></div>
    </section>

    <!-- INCIDENCIAS -->
    <section id="incidencias" role="region" aria-labelledby="ttl-inc">
      <header class="sec-hdr">
        <h2 id="ttl-inc">INCIDENCIAS <img src="angular.png" alt="" class="angular"></h2>
      </header>

      <p><button id="btnNuevaIncidencia" class="btn btn--primary">Crear nueva incidencia</button></p>

      <!-- Tarjeta 1: Finalizar -->
      <article class="card">
        <h3>Finalizar incidencia</h3>
        <form id="finIncidenciaForm" autocomplete="off">
          <div class="form-row">
            <label for="finCat">Categoría</label>
            <select id="finCat">
              <option value="equipos">Equipos</option>
              <option value="gruas">Grúas</option>
              <option value="auxiliares">Auxiliares</option>
            </select>
          </div>

          <div class="form-row">
            <label for="finElem">Elemento</label>
            <select id="finElem">
              <option value="">— Selecciona —</option>
            </select>
          </div>

          <div class="form-row">
            <label for="finUser">Intervenido por</label>
            <input id="finUser" type="text" placeholder="Nombre del técnico">
          </div>

          <div class="form-row">
            <label for="finResumen">Resumen de la solución</label>
            <textarea id="finResumen" rows="3" placeholder="Descripción breve…"></textarea>
          </div>

          <div class="form-row">
            <button id="btnMarcarSolucionada" class="btn btn--primary" type="submit">Marcar como solucionada</button>
          </div>
        </form>
      </article>

      <!-- Tarjeta 2: Buscador -->
      <article class="card">
        <h3>Buscador de incidencias</h3>
        <form id="buscaIncForm" class="filters" autocomplete="off">
          <div class="filters__row">
            <label for="incCat">Categoría</label>
            <select id="incCat">
              <option value="">Todas</option>
              <option value="equipos">Equipos</option>
              <option value="gruas">Grúas</option>
              <option value="auxiliares">Auxiliares</option>
            </select>

            <label for="incLinea">Línea/Equipo</label>
            <input id="incLinea" type="search" placeholder="Kaltenbach, Mazak, HGG…">

            <label for="incFecha">Fecha</label>
            <input id="incFecha" type="date">

            <label for="incEstado">Estado</label>
            <select id="incEstado">
              <option value="">Todos</option>
              <option value="abierta">Abierta</option>
              <option value="sin_resolver">Sin resolver</option>
              <option value="solucionada">Solucionada</option>
            </select>

            <button class="btn" type="submit">Buscar</button>
          </div>
        </form>
      </article>

      <!-- Listado cronológico (descendente) -->
      <div id="incList" class="cards-stack" aria-live="polite"></div>
    </section>

    <!-- INVENTARIO -->
    <section id="inventario" role="region" aria-labelledby="ttl-inv">
      <header class="sec-hdr">
        <h2 id="ttl-inv">INVENTARIO <img src="angular.png" alt="" class="angular"></h2>
      </header>

      <!-- Tarjeta 1 -->
      <article class="card">
        <h3>Estado de stock</h3>
        <div class="actions">
          <button id="btnAddRep" class="btn">Añadir repuesto</button>
          <button id="btnDecRep" class="btn">Descontar</button>
        </div>
      </article>

      <!-- Tarjeta 2 -->
      <article class="card">
        <h3>Buscar repuesto</h3>
        <form id="invSearchForm" class="form-inline" autocomplete="off">
          <input id="invQuery" type="search" placeholder="Código, descripción, categoría…">
          <button type="submit" class="btn">Buscar</button>
          <button type="button" id="btnScanQR" class="btn btn--ghost">Escanear QR</button>
        </form>
      </article>

      <!-- Sólo admin -->
      <article class="card" data-role="admin" hidden>
        <h3>Inventario CSV + QR (admin)</h3>
        <div class="actions">
          <button id="btnCargarCSV" class="btn">Cargar CSV</button>
          <button id="btnImprimirQR" class="btn">Imprimir QR</button>
        </div>
      </article>

      <!-- Catálogo tipo ferretería -->
      <h3 class="line-hdr">Catálogo</h3>
      <div id="invCatalog" class="catalog"></div>
    </section>

    <!-- CONSUMIBLES -->
    <section id="consumibles" role="region" aria-labelledby="ttl-cons">
      <header class="sec-hdr">
        <h2 id="ttl-cons">CONSUMIBLES <img src="angular.png" alt="" class="angular"></h2>
      </header>

      <!-- Alarma stock bajo (colapsable) -->
      <details id="consLowWrap">
        <summary class="alert alert--danger">Consumibles por debajo del mínimo (pulsa para ver)</summary>
        <div id="consLowList" class="cards-stack"></div>
      </details>

      <p><button id="btnAddCons" class="btn">Añadir consumible</button></p>

      <div id="consList" class="cards-grid" aria-live="polite"></div>
    </section>

    <!-- SOLICITUDES DE REPUESTOS -->
    <section id="solicitudes" role="region" aria-labelledby="ttl-sol">
      <header class="sec-hdr">
        <h2 id="ttl-sol">SOLICITUDES DE REPUESTOS <img src="angular.png" alt="" class="angular"></h2>
      </header>

      <article class="card">
        <h3>Nueva solicitud</h3>
        <form id="solForm" autocomplete="off">
          <div class="form-row">
            <label for="solEq">Equipo / Área</label>
            <input id="solEq" type="text" placeholder="KDP1, Grua N2-03, …">
          </div>
          <div class="form-row">
            <label for="solDesc">Descripción del repuesto</label>
            <input id="solDesc" type="text" placeholder="Referencia / descripción">
          </div>
          <div class="form-row">
            <label for="solUrg">Urgencia</label>
            <select id="solUrg">
              <option value="normal">Normal</option>
              <option value="alta">Alta</option>
              <option value="critica">Crítica</option>
            </select>
          </div>
          <div class="form-row">
            <button class="btn btn--primary" type="submit">Enviar solicitud</button>
          </div>
        </form>
      </article>

      <article class="card">
        <h3>Solicitudes recientes</h3>
        <div id="solList" class="cards-stack" aria-live="polite"></div>
      </article>
    </section>

    <!-- OTs -->
    <section id="ots" role="region" aria-labelledby="ttl-ots">
      <header class="sec-hdr">
        <h2 id="ttl-ots">ÓRDENES DE TRABAJO (OTs) <img src="angular.png" alt="" class="angular"></h2>
      </header>

      <article class="card">
        <h3>Nueva OT</h3>
        <form id="otForm" autocomplete="off">
          <div class="form-row">
            <label for="otEq">Equipo</label>
            <input id="otEq" type="text" placeholder="ID o nombre del equipo">
          </div>
          <div class="form-row">
            <label for="otDesc">Descripción</label>
            <textarea id="otDesc" rows="3" placeholder="Trabajo a realizar…"></textarea>
          </div>
          <div class="form-row">
            <button class="btn btn--primary" type="submit">Crear OT</button>
          </div>
        </form>
      </article>

      <article class="card">
        <h3>OTs abiertas</h3>
        <div id="otList" class="cards-stack" aria-live="polite"></div>
      </article>
    </section>

    <!-- TEST (utilidad de depuración) -->
    <section id="test" role="region" aria-labelledby="ttl-test">
      <header class="sec-hdr">
        <h2 id="ttl-test">TEST <img src="angular.png" alt="" class="angular"></h2>
      </header>
      <article class="card">
        <p>Herramientas de prueba y depuración.</p>
        <div id="testArea"></div>
      </article>
    </section>
  </main>

  <!-- =========================================
       FOOTER (opcional)
  ========================================== -->
  <footer id="appFooter" role="contentinfo" aria-label="Pie de página">
    <small>CDL · Mantenimiento Sistema PWA v1.0</small>
  </footer>

  <!-- JS principal -->
  <script src="app.js"></script>

  <!-- =========================================
       CONFIG: Endpoints reales + arranque de datos
       (añadido sin eliminar nada)
  ========================================== -->
  <script>
  (function(){
    // Base real de Apps Script
    var BASE = 'https://script.google.com/macros/s/AKfycbzgTZ8zMOOKiYt2JygDLX39xQoU3elE_7T8DDFhiBYk5UOvV3F4Tp6EAE3jenj3Njzr1g/exec';

    // Endpoints esperados por loaders
    window.API = {
      equipos:     BASE + '?path=equipos',
      gruas:       BASE + '?path=gruas',
      auxiliares:  BASE + '?path=auxiliares',
      incidencias: BASE + '?path=incidencias',
      inventario:  BASE + '?path=inventario',
      consumibles: BASE + '?path=consumibles'
    };

    // Arranque de datos: usa bootData() si existe; si no, llama a loaders uno a uno
    function bootNow(){
      if (typeof bootData === 'function') {
        bootData();
      } else {
        var calls = [];
        if (typeof loadEquipos === 'function')     calls.push(loadEquipos());
        if (typeof loadGruas === 'function')       calls.push(loadGruas());
        if (typeof loadAuxiliares === 'function')  calls.push(loadAuxiliares());
        if (typeof loadInventario === 'function')  calls.push(loadInventario());
        if (typeof loadIncidencias === 'function') calls.push(loadIncidencias());
        if (typeof loadConsumibles === 'function') calls.push(loadConsumibles());
        Promise.all(calls).catch(console.warn);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', bootNow);
    } else {
      bootNow();
    }
  })();
  </script>
</body>
</html>