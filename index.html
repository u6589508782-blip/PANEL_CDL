<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">
  <title>CDL ¬∑ CMMS v2025</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0c0f14">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CDL ¬∑ CMMS">
  <link rel="icon" sizes="192x192" href="/icon-192.png">
  <link rel="icon" sizes="512x512" href="/icon-512.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

  <!-- Fuente -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style id="pwa-cdl">
:root{
  --brand1:#A60000; --brand2:#E43B3B;
  --ok:#16a34a; --warn:#f59e0b; --stop:#dc2626;
  --ink:#0b0f15; --muted:#6b7280; --line:#e5e7eb;
  --hdr-h:140px;                           /* altura fija cabecera */
  --safe-top: env(safe-area-inset-top,0px);
  --safe-bottom: env(safe-area-inset-bottom,0px);
}

/* Reset m√≠nimo */
*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  color:var(--ink);
  background:#ffffff;                      /* FONDO BLANCO UNIFICADO */
  -webkit-text-size-adjust:100%;
  padding-top:var(--safe-top);
  padding-bottom:var(--safe-bottom);
}
.hidden{ display:none !important; }
img, canvas, svg, video { max-width:100%; height:auto; }

/* ===== CABECERA ===== */
header{
  position:sticky; top:0; z-index:1200;
  background:#fff;                         /* blanca */
  height:var(--hdr-h);
  overflow:hidden;                         /* recorta el fondo difuso */
  box-shadow:0 1px 0 #eaecef;
}
#navBar{
  height:var(--hdr-h);
  display:grid;
  grid-template-columns: 56px 1fr 56px;    /* hamburguesa | t√≠tulo | men√∫ usuario */
  align-items:center;
  gap:4px;
  padding:0 8px;
}

/* Fondo difuminado "logo_mantenimiento.png" (no crece al recargar) */
header::after{
  content:"";
  position:absolute; inset:0;
  background:
    radial-gradient(1000px 500px at 50% 0%, rgba(0,0,0,.04), transparent 70%),
    url("logo_mantenimiento.png") no-repeat center 14px / clamp(180px, 42vw, 260px) auto;
  opacity:.35;
  pointer-events:none;
}

/* Men√∫ hamburguesa (izquierda, negro, m√°s grande) */
.menu.menu-pages{ align-self:center; }
#pagesBtn{
  font-size:28px; line-height:1;
  width:40px; height:40px;
  display:inline-flex; align-items:center; justify-content:center;
  color:#111; background:transparent; border:0;
}

/* T√≠tulo ‚ÄúCDL ¬∑ PANEL DE CONTROL‚Äù en una sola l√≠nea */
.hero-title{ display:flex; align-items:center; justify-content:center; }
.hero-title .hero-row{ display:flex; align-items:center; gap:12px; white-space:nowrap; }
.hero-title .hero-dot{ display:none; }                /* quitamos el punto intermedio */
.hero-title .hero-panel{ font-weight:800; letter-spacing:.02em; }

/* Logo CDL (con angular rojo) */
.hero-logo-cdl{ height:22px; width:auto; display:inline-block; margin-right:2px; }

/* Men√∫ usuario (derecha) */
.menu.menu-user{ justify-self:end; }
#userBtn{ font-size:26px; width:40px; height:40px; border:0; background:transparent; color:#111; }

/* Rol arriba a la derecha, texto simple sin p√≠ldora y m√°s peque√±o */
.rolechip{
  position:absolute; right:12px; top:8px;
  font-size:.9rem; font-weight:800; color:#111;
  background:transparent; border:0; padding:0; box-shadow:none;
}

/* ===== MEN√ö FULLSCREEN (sin cambios visuales del listado) ===== */
html.menu-open, body.menu-open{ overflow:hidden; }
.panel.menu-full{
  position:fixed !important;
  z-index:2400 !important;
  inset: calc(var(--safe-top) + var(--hdr-h)) 0 var(--safe-bottom) 0 !important;
  background:#0b0f15 !important;
  background-image:linear-gradient(180deg,#0b0f15,#121820 60%,#0b0f15) !important;
}
.panel.menu-full::before{
  content:""; position:absolute; inset:0;
  background: radial-gradient(1200px 600px at 50% -10%, rgba(255,255,255,.06), transparent 60%);
  pointer-events:none;
}
#pagesPanel.menu-full .actions{
  width:min(560px,92vw); margin:0 auto !important;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:0; height:100%;
}
#pagesPanel.menu-full .btn{
  background:none!important; border:0!important; box-shadow:none!important;
  color:#fff!important; font-weight:900; text-transform:uppercase; letter-spacing:.06em;
  font-size:clamp(18px,3vh,28px); padding:1.05rem 0; text-align:center; position:relative;
}
#pagesPanel.menu-full .btn + .btn::before{
  content:""; position:absolute; top:0; left:0; right:0; height:1px; opacity:.85;
  background:radial-gradient(circle at 50% 50%, rgba(255,255,255,.9) 0%, rgba(255,255,255,.4) 35%, rgba(255,255,255,0) 100%);
}

/* ===== STRIPS BLANCOS A PANTALLA COMPLETA ===== */
.brand-wrap{ margin:0; background:#fff; }
.brand-wrap img{
  display:block;
  width:100vw; max-width:none;             /* de borde a borde */
  margin-left:50%; transform:translateX(-50%);
}
section h2.cdl-tag{
  margin:0; padding:.65rem 16px;
  color:#111; background:#fff;             /* t√≠tulo sobre franja blanca */
  display:flex; align-items:center; gap:.55rem;
  border-top:10px solid #0b0f15;           /* separador oscuro opcional */
  border-bottom:10px solid #0b0f15;        /* separador oscuro opcional */
  text-transform:uppercase;
}
/* Icono rojo antes de EQUIPOS un poco m√°s arriba y m√°s cerca */
section h2.cdl-tag::before{
  content:""; width:18px; height:18px; flex:0 0 auto;
  background:url("logo-cdl.png") no-repeat center / contain;
  margin-right:.25rem; transform:translateY(-4px);
}

/* ===== TARJETAS (dos grises) ===== */
.card{
  position:relative; color:#e5e7eb; border-radius:16px;
  padding:.6rem .7rem; margin:.6rem 0;
  border:1px solid #2a3442;
  background: linear-gradient(180deg,#2f3339,#1c1f26) !important; /* dos tonos */
  box-shadow:inset 0 1px 0 rgba(255,255,255,.06), 0 10px 22px rgba(0,0,0,.28) !important;
}
.card::before{
  content:""; position:absolute; top:8px; bottom:8px; left:-1px; width:3px;
  background:linear-gradient(180deg, rgba(166,0,0,.9), rgba(228,59,59,.9));
  border-radius:3px;
}

/* ===== SEM√ÅFORO M√ÅS ESTRECHO + BOTONES EN L√çNEA ===== */
.semaforo{ background:#0e1422; border:1px solid #2a3546; border-radius:999px; padding:.24rem; width:min(420px,66%); }
.semaforo .opt{
  font-weight:900; border-radius:999px; padding:.36rem .72rem;
  background:linear-gradient(180deg,#111827,#0b1220);
  border:1px solid #273042;
}
.right{ display:flex; flex-wrap:wrap; gap:.4rem; align-items:center; }

/* Estados activos */
.semaforo .opt.active[data-k="ok"]{
  color:#0b2f19; background:linear-gradient(180deg,#b8ffd3,#3dd682 60%,#0b4f2a); border-color:#1d9a55;
}
.semaforo .opt.active[data-k="warn"]{
  color:#3a2503; background:linear-gradient(180deg,#ffecc2,#f0b33a 60%,#6a3f04); border-color:#d89a18;
}
.semaforo .opt.active[data-k="stop"]{
  color:#3d0b0b; background:linear-gradient(180deg,#ffd0d0,#ff4e4e 60%,#7a0f0f); border-color:#cc2a2a;
}

/* Botones */
.btn.gloss{
  display:inline-flex;align-items:center;gap:.5rem;
  padding:.32rem .55rem;border-radius:999px;border:1px solid #bbb;
  background:linear-gradient(180deg,#fdfdfd,#dfe3eb);
  color:#111;font-weight:800;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.9),0 4px 12px rgba(0,0,0,.12);
}
.btn.gloss.btn-mail{
  color:#fff !important;
  background:linear-gradient(180deg,#ff5a5a,#c10f0f) !important;
  border-color:#9f0c0c !important;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.9), 0 8px 18px rgba(178,15,15,.35) !important;
}

/* ===== TABLAS / CONTENEDORES SCROLL ===== */
#incidTableWrap, #invTableWrap, #otTableWrap, .kpi table{
  overflow-x:auto; -webkit-overflow-scrolling:touch;
}
table{ width:100%; }

/* Placeholders incidencias */
.ph-wrap{ position:relative; }
.ph-wrap .ph-label{
  position:absolute; left:14px; top:50%; transform:translateY(-50%);
  color:#6b7280; font-weight:600; pointer-events:none; opacity:.9;
}
.ph-wrap.filled .ph-label{ display:none; }
::placeholder{ color:#6b7280; opacity:1; }

/* Toast & header sombra */
header.scrolled{ box-shadow:0 4px 10px rgba(0,0,0,.06); }

/* Canvas fijos por CSS (no atributos) */
#chartMttr,#chartMtbf,#chartDisp,#chartOee{ width:100% !important; height:220px !important; }
<!-- üîß BLOQUE √öNICO (pega en <head>, reemplazando desde <!-- ===== PARCHE √öNICO --> hasta el </script> roto) -->

/* deja esta √∫ltima regla dentro del primer <style id="pwa-cdl"> */
#chartMttr,#chartMtbf,#chartDisp,#chartOee{ width:100% !important; height:220px !important; }
</style>

<!-- ===== PARCHE √öNICO (cabecera + t√≠tulos + QR en tarjetas) ===== -->
<style id="pwa-cdl-unique">
/* CABECERA: fondo arriba y fila √∫nica "CDL  PANEL DE CONTROL" */
header{
  background:#f5f6f8 !important;
  background-image:linear-gradient(180deg,#f7f8fa,#eceff3) !important;
  position:sticky; top:0; z-index:1200;
}
header::after{
  content:"";
  position:absolute; inset:0;
  background:
    radial-gradient(900px 420px at 50% 0%, rgba(0,0,0,.06), transparent 65%),
    url("logo_mantenimiento.png") no-repeat center 14px / clamp(180px,42vw,260px) auto;
  opacity:.30; pointer-events:none;
  -webkit-mask-image:linear-gradient(to bottom,rgba(0,0,0,1) 0, rgba(0,0,0,.8) 45%, rgba(0,0,0,0) 72%);
          mask-image:linear-gradient(to bottom,rgba(0,0,0,1) 0, rgba(0,0,0,.8) 45%, rgba(0,0,0,0) 72%);
}
.hero-title{ padding:10px 12px 14px; }
.hero-title .hero-row.singleline{
  display:flex; align-items:flex-end; gap:.6rem; white-space:nowrap;
}
.hero-logo-cdl{ height:1.5em; width:auto; display:inline-block; }
.hero-dot{ display:none; }
.hero-panel{ font-weight:800; letter-spacing:.02em; }

/* Rol sin p√≠ldora */
.rolechip{ background:transparent; border:0; box-shadow:none; color:#111; font-weight:800; }

/* T√≠tulos secciones: icono angular y sin bordes negros */
main section>h2.cdl-tag::before,
main section>h3.cdl-tag::before{
  content:""; width:1.05em; height:1.05em;
  background:url("angular.png") no-repeat center / contain;
  transform:translateY(6px);
}
section h2.cdl-tag, section h3.cdl-tag{ border:0 !important; }

/* Franja ‚ÄúL√çNEA KALTENBACH‚Äù full-bleed */
.brand-wrap{ margin:0; background:#fff; }
.brand-wrap img{
  display:block; width:100vw; max-width:none; margin-left:50%; transform:translateX(-50%);
}

/* Tarjeta con columna QR a la derecha + bot√≥n Ficha negro */
.card{ position:relative; display:flex; flex-wrap:wrap; gap:.6rem; align-items:flex-start; }
.card .card-main{ flex:1 1 420px; min-width:260px; }
.card .card-qr{ flex:0 0 auto; display:flex; flex-direction:column; align-items:center; gap:.4rem; }
.card .qrbox{
  width:84px; height:84px; border-radius:12px;
  background:#0f141c; border:1px solid #2a3442; overflow:hidden;
}
.btn.gloss.btn-ficha{
  background:linear-gradient(180deg,#111,#222) !important;
  color:#fff !important; border-color:#000 !important;
}

/* Nombre de m√°quina */
.card .name .linkish{ font-weight:900; font-size:1.12rem; }

/* Sem√°foro un poco m√°s estrecho */
.semaforo{ width:min(460px,68%); }

/* Gr√°ficas siempre visibles (sin datos) */
#chartMttr,#chartMtbf,#chartDisp,#chartOee{ width:100% !important; height:220px !important; }
</style>

<!-- ===== PATCH LIGERO (responsive + ordena cabecera) ===== -->
<style id="pwa-cdl-patch">
/* Evita logos gigantes en header */
header::after{
  background-size: clamp(120px, 35vw, 200px) auto !important;
  background-position: 12px 6px !important;
  background-repeat: no-repeat !important;
  opacity: .12;
}

/* Logos h√©roe / men√∫ */
.hero-logo-cdl { height: 1.6em; width: auto; display:inline-block; vertical-align:middle; }
.menu .logo-cdl  { width: 24px; height: 24px; object-fit: contain; }

/* Tablas/scroll horizontal para m√≥viles */
#incidTableWrap, #invTableWrap, #otTableWrap, .kpi table { overflow-x:auto; -webkit-overflow-scrolling:touch; }
table { width:100%; table-layout:auto; }

/* Charts obedecen CSS */
#chartMttr, #chartMtbf, #chartDisp, #chartOee { width:100% !important; height:220px !important; }

/* Medios seguros */
img, canvas, svg, video { max-width:100%; height:auto; }

/* Brand wrap centrado si falla imagen */
.brand-wrap { display:flex; justify-content:center; padding:.4rem 0; }
.brand-wrap img { width: min(680px, 92vw); height:auto; display:block; }
.brand-wrap.fallback { display:none; }

/* Tarjetas seguras */
.card { overflow:hidden; }

/* Safe areas iOS */
:root { --safe-top: env(safe-area-inset-top,0px); }
body{ padding-top:var(--safe-top); }

/* Header fijo, layout botones y t√≠tulo 1 l√≠nea */
:root{ --hdr-h: 140px; }
header{position:sticky;top:0;z-index:1200;background:#fff;height:var(--hdr-h);overflow:hidden;box-shadow:0 1px 0 #eaecef;}
header::after{
  content:"";position:absolute;inset:0;opacity:.30;pointer-events:none;
  background:
    radial-gradient(900px 420px at 50% 0%, rgba(0,0,0,.06), transparent 65%),
    url("logo_mantenimiento.png") no-repeat center 14px / clamp(180px,42vw,260px) auto;
  -webkit-mask-image:linear-gradient(to bottom,rgba(0,0,0,1) 0, rgba(0,0,0,.8) 45%, rgba(0,0,0,0) 72%);
          mask-image:linear-gradient(to bottom,rgba(0,0,0,1) 0, rgba(0,0,0,.8) 45%, rgba(0,0,0,0) 72%);
}
#navBar{height:var(--hdr-h);display:grid;grid-template-columns:56px 1fr 56px;align-items:center;padding:0 8px;}
#pagesBtn{font-size:28px;width:40px;height:40px;color:#111;background:transparent;border:0;}
.menu.menu-user{justify-self:end;}
#userBtn{font-size:26px;width:40px;height:40px;border:0;background:transparent;color:#111;}
.rolechip{position:absolute;right:12px;top:8px;font-size:.9rem;font-weight:800;color:#111;background:transparent;border:0;padding:0;box-shadow:none;}
.hero-title{display:flex;align-items:center;justify-content:center;}
.hero-title .hero-row{display:flex;align-items:center;gap:12px;white-space:nowrap;}
.hero-title .hero-dot{display:none;}
.hero-panel{font-weight:800;letter-spacing:.02em;}
.hero-logo-cdl{height:22px;width:auto;display:inline-block;margin-right:2px;}

/* T√≠tulos secci√≥n: sin bordes, con angular */
section h2.cdl-tag, section h3.cdl-tag{margin:0;padding:.65rem 16px;color:#111;background:#fff;border:0;text-transform:uppercase;display:flex;align-items:center;gap:.55rem;}
section h2.cdl-tag::before, section h3.cdl-tag::before{
  content:"";width:18px;height:18px;flex:0 0 auto;background:url("angular.png") no-repeat center/contain;transform:translateY(4px);
}

/* Franja ‚ÄúL√çNEA KALTENBACH‚Äù full-bleed */
.brand-wrap{margin:0;background:#fff;}
.brand-wrap img{display:block;width:100vw;max-width:none;margin-left:50%;transform:translateX(-50%);}

/* Tarjetas (tema oscuro) + QR + bot√≥n Ficha negro */
.card{position:relative;color:#e5e7eb;border-radius:16px;padding:.6rem .7rem;margin:.6rem 0;border:1px solid #2a3442;background:linear-gradient(180deg,#2f3339,#1c1f26)!important;box-shadow:inset 0 1px 0 rgba(255,255,255,.06),0 10px 22px rgba(0,0,0,.28)!important;display:flex;flex-wrap:wrap;gap:.6rem;align-items:flex-start;}
.card::before{content:"";position:absolute;top:8px;bottom:8px;left:-1px;width:3px;background:linear-gradient(180deg,rgba(166,0,0,.9),rgba(228,59,59,.9));border-radius:3px;}
.card .card-main{flex:1 1 420px;min-width:260px;}
.card .card-qr{flex:0 0 auto;display:flex;flex-direction:column;align-items:center;gap:.4rem;}
.card .qrbox{width:84px;height:84px;border-radius:12px;background:#0f141c;border:1px solid #2a3442;overflow:hidden;}
.card .name .linkish{font-weight:900;font-size:1.12rem;}
.btn.gloss.btn-ficha{background:linear-gradient(180deg,#111,#222)!important;color:#fff!important;border-color:#000!important;}
.semaforo{background:#0e1422;border:1px solid #2a3546;border-radius:999px;padding:.24rem;width:min(460px,68%);}
.right{display:flex;flex-wrap:wrap;gap:.4rem;align-items:center;}

/* Tablas y charts seguros en m√≥vil */
#incidTableWrap,#invTableWrap,#otTableWrap,.kpi table{overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:100%;}
#chartMttr,#chartMtbf,#chartDisp,#chartOee{width:100%!important;height:220px!important;}
</style>

<!-- ===== JS seguro (sin el script roto) ===== -->
<script>
/* Logo CDL en el hero + t√≠tulo en may√∫sculas */
(function(){
  const hero = document.querySelector('.hero-title .hero-row.singleline');
  if (hero && !hero.querySelector('.hero-logo-cdl')){
    const img = document.createElement('img');
    img.src = 'logo-cdl.png';
    img.alt = 'CDL';
    img.className = 'hero-logo-cdl';
    hero.insertBefore(img, hero.firstChild);
  }
  const hp = document.querySelector('.hero-panel');
  if (hp) hp.textContent = hp.textContent.toUpperCase();
})();

/* Placeholders fantasma incidencias */
(function(){
  function addGhostPH(id, text){
    const el = document.getElementById(id);
    if (!el) return;
    if (el.parentElement?.classList?.contains('ph-wrap')) return;
    const wrap = document.createElement('div');
    wrap.className = 'ph-wrap';
    el.parentNode.insertBefore(wrap, el);
    wrap.appendChild(el);
    const lab = document.createElement('span');
    lab.className = 'ph-label';
    lab.textContent = text;
    wrap.appendChild(lab);
    const sync = ()=> wrap.classList.toggle('filled', !!el.value);
    el.addEventListener('input', sync); el.addEventListener('change', sync); sync();
  }
  addGhostPH('iInicio','Fecha de inicio');
  addGhostPH('iFin','Fecha de fin');
  addGhostPH('iHParo','Horas parada');
  addGhostPH('iHRep','Horas reparaci√≥n');
  addGhostPH('iRep','N¬∫ repuestos utilizados');
  addGhostPH('iStock','Cantidad en stock');
  ['iHParo','iHRep','iRep','iStock'].forEach(id=>{
    const n = document.getElementById(id);
    if (n && (n.value === '0' || n.value === 0)) n.value = '';
  });
})();
</script>
<!-- /BLOQUE √öNICO -->

  /* Interacciones del sem√°foro + QR real */
  setTimeout(()=>{
    const opts = el.querySelectorAll(".semaforo .opt");
    opts.forEach(o=>{
      o.tabIndex = 0;
      o.setAttribute("role","radio");
      o.setAttribute("aria-checked", o.classList.contains("active") ? "true" : "false");
      o.addEventListener("click", async (e)=>{
        const name   = el.querySelector(".semaforo").dataset.name;
        const k      = e.currentTarget.getAttribute("data-k");
        const estado = k === "ok" ? "En marcha" : (k === "warn" ? "Restricciones" : "Parada");
        const ok = await setEstado(name, estado);
        if (!ok) return;
        opts.forEach(x=>{ x.classList.remove("active"); x.setAttribute("aria-checked","false"); });
        e.currentTarget.classList.add("active");
        e.currentTarget.setAttribute("aria-checked","true");
      });
      o.addEventListener("keydown",(e)=>{
        if (e.key==="Enter"||e.key===" "){ e.preventDefault(); o.click(); }
        if (["ArrowRight","ArrowDown","ArrowLeft","ArrowUp"].includes(e.key)){
          e.preventDefault();
          const arr = Array.from(opts); const i = arr.indexOf(o);
          const dir = (e.key==="ArrowLeft"||e.key==="ArrowUp")? -1 : 1;
          const next = arr[(i+dir+arr.length)%arr.length]; next.focus();
        }
      });
    });

    /* QR mini funcional (abre la ficha) */
    const qrHost = el.querySelector('#'+qrId);
    if (qrHost){
      const url = `${baseURL()}#/equipo/${slug}`;
      new QRCode(qrHost, { text:url, width:80, height:80, correctLevel: QRCode.CorrectLevel.M });
      qrHost.title = "Abrir ficha";
      qrHost.style.cursor = "pointer";
      qrHost.addEventListener("click", ()=> openEquipoByName(safeName));
    }
  }, 0);

  return el;
}
</script>
</style>

<script>
/* ===== Inserta logo CDL en el hero ===== */
(function(){
  const hero = document.querySelector('.hero-title .hero-row.singleline');
  if (hero && !hero.querySelector('.hero-logo-cdl')){
    const img = document.createElement('img');
    img.src = 'logo-cdl.png';
    img.alt = 'CDL';
    img.className = 'hero-logo-cdl';
    hero.insertBefore(img, hero.firstChild);
  }
  const hp = document.querySelector('.hero-panel');
  if (hp) hp.textContent = hp.textContent.toUpperCase();
})();

/* ===== Placeholders fantasma incidencias ===== */
(function(){
  function addGhostPH(id, text){
    const el = document.getElementById(id);
    if (!el) return;
    if (el.parentElement?.classList?.contains('ph-wrap')) return;
    const wrap = document.createElement('div');
    wrap.className = 'ph-wrap';
    el.parentNode.insertBefore(wrap, el);
    wrap.appendChild(el);
    const lab = document.createElement('span');
    lab.className = 'ph-label';
    lab.textContent = text;
    wrap.appendChild(lab);
    const sync = ()=> wrap.classList.toggle('filled', !!el.value);
    el.addEventListener('input', sync); el.addEventListener('change', sync); sync();
  }

  addGhostPH('iInicio','Fecha de inicio');
  addGhostPH('iFin','Fecha de fin');
  addGhostPH('iHParo','Horas parada');
  addGhostPH('iHRep','Horas reparaci√≥n');
  addGhostPH('iRep','N¬∫ repuestos utilizados');
  addGhostPH('iStock','Cantidad en stock');

  ['iHParo','iHRep','iRep','iStock'].forEach(id=>{
    const n = document.getElementById(id);
    if (n && (n.value === '0' || n.value === 0)) n.value = '';
  });
})();
<style id="pwa-cdl-patch">
/* ====== PARCHE LIGERO: ajustes visuales obligatorios y responsive ====== */

/* Evita logos gigantes en header */
header::after{
  background-size: clamp(120px, 35vw, 200px) auto !important;
  background-position: 12px 6px !important;
  background-repeat: no-repeat !important;
  opacity: .12;
}

/* Logos h√©roe / men√∫ */
.hero-logo-cdl { height: 1.6em; width: auto; display:inline-block; vertical-align:middle; }
.menu .logo-cdl  { width: 24px; height: 24px; object-fit: contain; }

/* Tablas/scroll horizontal para m√≥viles */
#incidTableWrap, #invTableWrap, #otTableWrap, .kpi table {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

/* Asegura ancho de tablas */
table { width: 100%; table-layout: auto; }

/* Evita que canvas de Chart.js fijen tama√±os raros */
#chartMttr, #chartMtbf, #chartDisp, #chartOee {
  width: 100% !important;
  height: 220px !important;
}

/* Im√°genes / canvases no desbordan y mantienen proporci√≥n */
img, canvas, svg, video { max-width: 100%; height: auto; }

/* Brand wrap: centrado y fallback por si falta la imagen */
.brand-wrap { display:flex; justify-content:center; padding:.4rem 0; }
.brand-wrap img { width: min(680px, 92vw); height:auto; display:block; }
.brand-wrap.fallback { display:none; }

/* Tablas y tarjetas seguras */
.card { overflow: hidden; }

/* Peque√±o ajuste para evitar que header empuje contenido en algunos m√≥viles */
:root { --safe-top: env(safe-area-inset-top,0px); }
body{ padding-top:var(--safe-top); }

/* Header fijo, fondo arriba y t√≠tulo en UNA sola l√≠nea */
:root{ --hdr-h: 140px; }
header{position:sticky;top:0;z-index:1200;background:#fff;height:var(--hdr-h);overflow:hidden;box-shadow:0 1px 0 #eaecef;}
header::after{
  content:"";position:absolute;inset:0;opacity:.30;pointer-events:none;
  background:
    radial-gradient(900px 420px at 50% 0%, rgba(0,0,0,.06), transparent 65%),
    url("logo_mantenimiento.png") no-repeat center 14px / clamp(180px,42vw,260px) auto;
  -webkit-mask-image:linear-gradient(to bottom,rgba(0,0,0,1) 0, rgba(0,0,0,.8) 45%, rgba(0,0,0,0) 72%);
          mask-image:linear-gradient(to bottom,rgba(0,0,0,1) 0, rgba(0,0,0,.8) 45%, rgba(0,0,0,0) 72%);
}
#navBar{height:var(--hdr-h);display:grid;grid-template-columns:56px 1fr 56px;align-items:center;padding:0 8px;}
#pagesBtn{font-size:28px;width:40px;height:40px;color:#111;background:transparent;border:0;}
.menu.menu-user{justify-self:end;}
#userBtn{font-size:26px;width:40px;height:40px;border:0;background:transparent;color:#111;}
.rolechip{position:absolute;right:12px;top:8px;font-size:.9rem;font-weight:800;color:#111;background:transparent;border:0;padding:0;box-shadow:none;}
.hero-title{display:flex;align-items:center;justify-content:center;}
.hero-title .hero-row{display:flex;align-items:center;gap:12px;white-space:nowrap;}
.hero-title .hero-dot{display:none;}
.hero-panel{font-weight:800;letter-spacing:.02em;}
.hero-logo-cdl{height:22px;width:auto;display:inline-block;margin-right:2px;}

/* T√≠tulo secciones: SIN l√≠neas negras; icono angular correcto */
section h2.cdl-tag, section h3.cdl-tag{margin:0;padding:.65rem 16px;color:#111;background:#fff;border:0;text-transform:uppercase;display:flex;align-items:center;gap:.55rem;}
section h2.cdl-tag::before, section h3.cdl-tag::before{
  content:"";width:18px;height:18px;flex:0 0 auto;background:url("angular.png") no-repeat center/contain;transform:translateY(4px);
}

/* Franja ‚ÄúL√çNEA KALTENBACH‚Äù a pantalla completa sin m√°rgenes */
.brand-wrap{margin:0;background:#fff;}
.brand-wrap img{display:block;width:100vw;max-width:none;margin-left:50%;transform:translateX(-50%);}

/* Tarjetas: 2 grises; nombre de m√°quina m√°s grande; QR a la derecha; bot√≥n Ficha negro */
.card{position:relative;color:#e5e7eb;border-radius:16px;padding:.6rem .7rem;margin:.6rem 0;border:1px solid #2a3442;background:linear-gradient(180deg,#2f3339,#1c1f26)!important;box-shadow:inset 0 1px 0 rgba(255,255,255,.06),0 10px 22px rgba(0,0,0,.28)!important;display:flex;flex-wrap:wrap;gap:.6rem;align-items:flex-start;}
.card::before{content:"";position:absolute;top:8px;bottom:8px;left:-1px;width:3px;background:linear-gradient(180deg,rgba(166,0,0,.9),rgba(228,59,59,.9));border-radius:3px;}
.card .card-main{flex:1 1 420px;min-width:260px;}
.card .card-qr{flex:0 0 auto;display:flex;flex-direction:column;align-items:center;gap:.4rem;}
.card .qrbox{width:84px;height:84px;border-radius:12px;background:#0f141c;border:1px solid #2a3442;overflow:hidden;}
.card .name .linkish{font-weight:900;font-size:1.12rem;}
.btn.gloss.btn-ficha{background:linear-gradient(180deg,#111,#222)!important;color:#fff!important;border-color:#000!important;}
.semaforo{background:#0e1422;border:1px solid #2a3546;border-radius:999px;padding:.24rem;width:min(460px,68%);}
.right{display:flex;flex-wrap:wrap;gap:.4rem;align-items:center;}

/* Tablas y charts seguros en m√≥vil */
#incidTableWrap,#invTableWrap,#otTableWrap,.kpi table{overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:100%;}
#chartMttr,#chartMtbf,#chartDisp,#chartOee{width:100%!important;height:220px!important;}
</style>

</script>
</head>

<body>

<header>
  <div class="nav" id="navBar">
    <!-- Men√∫ (hamburguesa) + Angular -->
<div class="menu menu-pages">
  <button id="pagesBtn" class="mbtn" aria-label="Men√∫" aria-expanded="false" aria-controls="pagesPanel">‚ò∞</button>
  <img class="logo-cdl" src="angular.png" alt="" aria-hidden="true">
  
  <div id="pagesPanel" class="panel hidden" aria-label="Men√∫ principal" style="min-width:260px">
    <div class="row">
      <div class="actions">
        <button class="btn" onclick="nav('equipos')">Equipos</button>
        <button class="btn" id="mGruas" onclick="nav('gruas')">Puentes Gr√∫a</button>
        <button class="btn" id="mOtros" onclick="nav('otros')">Otros</button>
        <button class="btn" id="mIncid" onclick="nav('incidencias')">Incidencias</button>
        <button class="btn" id="mIndic" onclick="nav('indicadores')">Indicadores</button>
        <button class="btn" id="mOT" onclick="nav('ot')">OT</button>
        <button class="btn" id="mInv" onclick="nav('inventario')">Inventario</button>
        <button class="btn" id="mTV" onclick="nav('tv')">Dashboard TV</button>
      </div>
    </div>
  </div>
</div>
   <!-- T√≠tulo centrado -->
<div class="hero-title">
  <div class="hero-row singleline">
    <img src="logo-cdl.png" alt="CDL" class="hero-logo-cdl">
    <span class="hero-dot">¬∑</span>
    <span class="hero-panel">PANEL DE CONTROL</span>
  </div>
</div>

<!-- Chip de rol -->
<span id="roleChip" class="rolechip" aria-label="Rol actual">Invitado</span>

<!-- Men√∫ usuario -->
<div class="menu menu-user">
  <button id="userBtn" class="mbtn" aria-label="Usuario" aria-expanded="false" aria-controls="userPanel">‚ãÆ</button>
  
  <div id="userPanel" class="panel hidden" aria-label="Panel de usuario">
    <div class="row">
      <label class="small">Usuario</label>
      <select id="userSelect">
        <option value="invitado">Invitado</option>
        <option value="admin">Administrador</option>
        <option value="gerente">Gerente</option>
        <option value="encargado">Encargado</option>
        <option value="produccion">Producci√≥n</option>
        <option value="rt11">RT1.1</option>
        <option value="rt12">RT1.2</option>
        <option value="rt21">RT2.1</option>
        <option value="rt22">RT2.2</option>
        <option value="rt31">RT3.1</option>
        <option value="rt32">RT3.2</option>
        <option value="tcoint">Tco.INT</option>
        <option value="subc">Subcontrata</option>
      </select>

      <label class="small" style="margin-top:.4rem">Contrase√±a</label>
      <div class="pw" style="display:flex;gap:.4rem;align-items:center">
        <input id="userPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="flex:1">
        <button type="button" class="pw-toggle" data-target="userPass" aria-label="Mostrar contrase√±a" aria-pressed="false"></button>
      </div>

      <div class="actions" style="margin-top:.6rem">
        <button class="btn gloss" onclick="login()"><span class="dot"></span>Entrar</button>
        <button class="btn gloss" onclick="logout()">Salir</button>
      </div>
    </div>

    <div class="row">
      <label class="small">Cambiar contrase√±a</label>
      <div class="pw" style="display:flex;gap:.4rem;align-items:center">
        <input id="oldPass" type="password" placeholder="Actual" style="flex:1">
        <button type="button" class="pw-toggle" data-target="oldPass" aria-label="Mostrar contrase√±a" aria-pressed="false"></button>
      </div>
      <div class="pw" style="margin-top:.4rem;display:flex;gap:.4rem;align-items:center">
        <input id="newPass" type="password" placeholder="Nueva" style="flex:1">
        <button type="button" class="pw-toggle" data-target="newPass" aria-label="Mostrar contrase√±a" aria-pressed="false"></button>
      </div>
      <div class="actions" style="margin-top:.6rem">
        <button class="btn gloss" onclick="changePwd()">Cambiar</button>
      </div>
      <div id="pwdMsg" class="small" style="margin-top:.4rem;color:#374151"></div>
    </div>
  </div>
</div>
</header>

<!-- ====== SECCIONES CDL ====== -->
<main>

<section id="page-equipos">
 <h2 class="cdl-tag angular">Equipos</h2>
  <div class="brand-wrap">
  <img src="linea-kaltenbach.png" alt="L√çNEA KALTENBACH"
       loading="lazy" decoding="async" fetchpriority="low"
       onerror="this.closest('.brand-wrap').classList.add('fallback'); this.remove();">
</div>
  <div id="equiposWrap"></div>
  <div class="right" style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
    <button id="btnExportIncidCSV" class="btn gloss" onclick="exportIncidCSV()">Incidencias CSV</button>
    <button id="btnExportIncidPDF" class="btn gloss" onclick="exportIncidPDF()">Incidencias PDF</button>
  </div>
</section>

<section id="page-gruas" class="hidden">
  <h2 class="cdl-tag">Puentes Gr√∫a</h2>
  <div id="gruasWrap"></div>
</section>

<section id="page-otros" class="hidden">
  <h2 class="cdl-tag">Otros (auxiliares)</h2>
  <div id="otrosWrap"></div>
</section>

<section id="page-incidencias" class="hidden">
  <h2 class="cdl-tag">Incidencias</h2>

  <div class="form-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.6rem">
    <select id="iEquipo" title="Equipo"></select>
    <select id="iTipo">
      <option>Correctivo</option><option>Preventivo</option>
      <option>Predictivo</option><option>Mejora</option>
    </select>
    <select id="iRes">
      <option>Solucionado</option><option>Con restricciones</option><option>Parada</option>
    </select>
    <select id="iRep"><option>No</option><option>S√≠</option></select>
    <input id="iRepTxt" placeholder="Repuesto (si aplica)">
    <input id="iHParo" type="number" step="0.1" value="0" placeholder="Horas parada">
    <input id="iHRep" type="number" step="0.1" value="0" placeholder="Horas reparaci√≥n">
    <input id="iInicio" type="datetime-local" placeholder="Inicio">
    <input id="iFin" type="datetime-local" placeholder="Fin">
    <input id="iReport" placeholder="Reportante">
    <input id="iAsignado" placeholder="Asignado a">
    <textarea id="iDesc" rows="2" placeholder="Descripci√≥n"></textarea>
  </div>

  <div class="actions" style="margin-top:.6rem">
    <button id="btnAddIncid" class="btn gloss" onclick="addIncid()"><span class="dot"></span>A√±adir incidencia</button>
  </div>

  <div style="margin:.8rem 0;display:flex;gap:.5rem;flex-wrap:wrap">
    <input id="filtroIncid" placeholder="Buscar..." style="min-width:220px">
    <select id="fEquipo"></select>
    <select id="fTipo"></select>
    <select id="fRes"></select>
  </div>

  <div id="incidTableWrap">
    <table aria-label="Tabla de incidencias">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Equipo</th>
          <th>Tipo</th>
          <th>Resultado</th>
          <th>Descripci√≥n</th>
          <th>Parada</th>
          <th>Reparaci√≥n</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<section id="page-indicadores" class="hidden">
  <h2 class="cdl-tag">Indicadores</h2>
  <div class="kpi">MTTR: <b id="kpiMttrG">0</b> h</div>
  <div class="kpi">MTBF: <b id="kpiMbfG">0</b> h</div>
  <div class="kpi">Disponibilidad: <b id="kpiDispG">0</b> %</div>
  <div class="kpi">OEE estimado: <b id="kpiOeeG">0</b> %</div>

  <div class="card"><canvas id="chartMttr" aria-label="MTTR" role="img"></canvas></div>
  <div class="card"><canvas id="chartMtbf" aria-label="MTBF" role="img"></canvas></div>
  <div class="card"><canvas id="chartDisp" aria-label="Disponibilidad" role="img"></canvas></div>
  <div class="card"><canvas id="chartOee" aria-label="OEE" role="img"></canvas></div>

  <div class="right" style="gap:.5rem">
    <button id="btnExportKPIPCSV" class="btn gloss" onclick="exportKPIsCSV()">KPIs CSV</button>
    <button id="btnExportKPIPDF" class="btn gloss" onclick="exportKPIPDF()">KPIs PDF</button>
  </div>
</section>

<section id="page-ot" class="hidden">
  <h2 class="cdl-tag">OT</h2>

  <div class="form-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.6rem">
    <select id="otEquipo" title="Equipo"></select>
    <select id="otPri"><option>Alta</option><option>Media</option><option>Baja</option></select>
    <input id="otTitulo" placeholder="T√≠tulo">
    <input id="otAsign" placeholder="Asignado a">
    <input id="otDue" type="date" placeholder="Vence">
    <input id="otAdj" placeholder="Adjunto (URL)">
    <textarea id="otDesc" rows="2" placeholder="Descripci√≥n"></textarea>
  </div>

  <div class="actions" style="margin-top:.6rem">
    <button id="btnAddOT" class="btn gloss" onclick="addOT()"><span class="dot"></span>Crear OT</button>
    <button id="btnExportOTPDF" class="btn gloss" onclick="exportOTPDF()">Exportar OT PDF</button>
  </div>

  <div id="otTableWrap" style="margin-top:.6rem">
    <table aria-label="Listado de √≥rdenes de trabajo">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>OT</th>
          <th>Prioridad</th>
          <th>Asignado</th>
          <th>Vence</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<section id="page-inventario" class="hidden">
  <h2 class="cdl-tag">Inventario</h2>

  <div class="inv-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.6rem">
    <input id="invNombre" placeholder="Nombre repuesto">
    <input id="invRef" placeholder="Referencia">
    <input id="invStock" type="number" min="0" step="1" placeholder="Stock">
    <input id="invMin" type="number" min="0" step="1" placeholder="M√≠nimo">
  </div>

  <div class="actions" style="margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap">
    <button id="btnAddInv" class="btn gloss" onclick="addInv()"><span class="dot"></span>A√±adir repuesto</button>
    <button id="btnExportInvCSV" class="btn gloss" onclick="exportInvCSV()">Exportar CSV</button>
    <button id="btnExportInvQR" class="btn gloss hidden" onclick="exportInvQRLabels()">Etiquetas QR</button>
    <button id="invAlertWrap" class="btn gloss hidden" onclick="toggleInvAlerts()">Alertas</button>
  </div>

  <div class="card hidden" id="invAlerts" style="margin:.6rem 0"></div>

  <div style="margin:.6rem 0">
    <input id="invSearch" placeholder="Buscar repuesto..." oninput="renderInv()" style="min-width:240px">
  </div>

  <div id="invTableWrap">
    <table aria-label="Inventario de repuestos">
      <thead>
        <tr>
          <th></th>
          <th>Repuesto</th>
          <th>Stock</th>
          <th>M√≠nimo</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<section id="page-tv" class="hidden">
  <h2 class="cdl-tag">Dashboard TV</h2>

  <div class="tv-card">
    <div class="tv-title">
      <span class="dot" style="background:#ef4444"></span> Paradas
      <span class="tv-legend">(actualizado cada 10s)</span>
    </div>
    <div id="tvParados" class="tv-list" role="list" aria-live="polite"></div>
  </div>

  <div class="tv-card">
    <div class="tv-title">
      <span class="dot" style="background:#f59e0b"></span> Restricciones
    </div>
    <div id="tvRestr" class="tv-list" role="list" aria-live="polite"></div>
  </div>

  <div class="tv-card">
    <div class="tv-title">
      <span class="dot" style="background:#60a5fa"></span> Stock bajo
    </div>
    <div id="tvStock" class="tv-list" role="list" aria-live="polite"></div>
  </div>
</section>

<section id="page-equipo" class="hidden">
  <h2 class="cdl-tag">Ficha Equipo</h2>
  <div id="equipoDetail"></div>
</section>

<section id="page-repuesto" class="hidden">
  <h2 class="cdl-tag">Ficha Repuesto</h2>
  <div id="repuestoDetail"></div>
</section>

</main>
<!-- ====== /SECCIONES CDL ====== -->

<footer>¬© CDL MANTENIMIENTO</footer>

<!-- Librer√≠as -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" integrity="sha384-4VQ4zBfT7t0mJ1X6XwVf3m3zOwgfS2k7xC9mB0F1oH6bV0k9J6wGQzH1o0y7r0yC" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" integrity="sha512-MBK3oF0vC3h3wz1l3bXK8y7S6qH3QmX0D2wQd3K3m0mB3yqC5bqD6K9m1oI3O3rB3s8rNn3d2y3o+7uOqv1YwA==" crossorigin="anonymous"></script>
<!-- ====== JS UNIFICADO (App + PWA) ====== -->
<script>
/* ========= CONFIG ========= */
const API_BASE = "https://script.google.com/macros/s/AKfycbzxW6Q5Me2xdQQw7Nk_QBtRTVJTODxLD7EhiGciBoFCwZulaCYWR2TDabcVF1TBOPFt/exec";

/* ========= UTILS ========= */
const byId = (id) => document.getElementById(id);
const esc   = (s) => String(s || "").replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
const fmt   = (n) => (Math.round((+n || 0) * 100) / 100).toFixed(2);
const fmtDate = (d) => new Date(d).toLocaleString("es-ES", { timeZone: "Europe/Madrid" });
const val   = (id) => byId(id).value;
const setTxt = (id, v) => { const n = byId(id); if (n) n.textContent = v; };
function show(id){ byId(id)?.classList.remove("hidden"); }
function hide(id){ byId(id)?.classList.add("hidden"); }

function openPopupSafe(title="") {
  const w = window.open("", "_blank", "noopener,noreferrer");
  if(!w){ alert("La ventana emergente fue bloqueada por el navegador."); return null; }
  try { w.opener = null; } catch(_) {}
  if (title){ w.document.write("<!doctype html><meta charset='utf-8'><title>"+esc(title)+"</title>"); w.document.close(); }
  return w;
}

/* ========= AUTH / ROLES ========= */
function getCID(){
  const KEY = "CDL_CID";
  let id = localStorage.getItem(KEY);
  if (!id) {
    id = (crypto.randomUUID && crypto.randomUUID()) || ("cid_" + Date.now().toString(36) + Math.random().toString(36).slice(2));
    localStorage.setItem(KEY, id);
  }
  return id;
}
const EMERGENCY_UNLOCK = false;
const ROLE_MAP = {
  "Administrador":"admin","Gerente":"gerente","Encargado":"encargado",
  "Producci√≥n":"produccion","Tco.INT":"tcoint","Subcontrata":"subc","Invitado":"guest",
  "RT":"rt","RT1.1":"rt","RT1.2":"rt","RT2.1":"rt","RT2.2":"rt","RT3.1":"rt","RT3.2":"rt"
};
function canEdit(){
  const stored = JSON.parse(localStorage.getItem("CDL_USER") || "{}");
  const g = (window.currentUser && window.currentUser.group) || stored.group || "guest";
  return EMERGENCY_UNLOCK || ["admin","gerente","encargado"].includes(g);
}
let currentUser = JSON.parse(localStorage.getItem("CDL_USER") || '{"user":"invitado","rol":"Invitado","group":"guest"}');
(function initUserFallback(){
  try{
    let u = JSON.parse(localStorage.getItem("CDL_USER") || "null");
    if (!u) {
      getCID();
      u = { user: "invitado", rol: "Invitado", group: "guest" };
      localStorage.setItem("CDL_USER", JSON.stringify(u));
    }
    byId("roleChip").textContent = (u.rol || "Invitado");
    currentUser = u;
  }catch(_){}
})();
window.setUser = function(u){
  try{
    window.currentUser = u;
    localStorage.setItem("CDL_USER", JSON.stringify(u));
    byId("roleChip").textContent = (u.rol || "Usuario");
    applyRoleUI();
  }catch(_){}
};
window.applyRoleUI = function(){
  const g = EMERGENCY_UNLOCK ? "admin" : (JSON.parse(localStorage.getItem("CDL_USER") || "{}").group || "guest");
  ["mIndic","mOT","mIncid","mInv","mGruas","mOtros","mTV"].forEach(id=>{ const el=byId(id); if (el){ el.classList.remove("hidden"); el.style.display=""; el.hidden=false; } });
  ["btnExportIncidCSV","btnExportIncidPDF","btnExportKPIPCSV","btnExportKPIPDF","btnExportInvCSV","btnExportOTPDF","btnExportInvQR"]
    .forEach(id=>{
      const el = byId(id); if(!el) return;
      const allowed = (g === "admin" || g === "gerente");
      if (id === "btnExportInvQR" || id === "btnExportOTPDF") el.classList.toggle("hidden", !allowed);
      else { el.classList.remove("hidden"); el.style.display = ""; }
    });
  const editable = canEdit();
  ["btnAddIncid","btnAddOT","btnExportInvQR","btnAddInv"].forEach(id=>{ const el=byId(id); if (el) el.disabled = !editable; });
};

/* ========= API ========= */
async function apiGet(q){ const r = await fetch(API_BASE + "?" + new URLSearchParams(q)); return r.json(); }
async function apiPost(o){ const r = await fetch(API_BASE, { method:"POST", headers:{ "Content-Type":"text/plain;charset=utf-8" }, body: JSON.stringify(o)}); return r.json(); }

/* ========= LOGIN ========= */
async function login(){
  const user = byId("userSelect").value;
  const pass = byId("userPass").value || "";
  try{
    const r = await apiPost({res:"auth", fn:"login", user, pass});
    if(!r || !r.ok){
      const code = (r && (r.code || r.error)) || "desconocido";
      const MSG = {
        badpass:"Usuario o contrase√±a incorrectos.",
        nouser:"Usuario no encontrado.",
        forbidden:"No tienes permiso para entrar.",
        locked:"Cuenta bloqueada. Contacta con un administrador.",
        rate:"Demasiados intentos. Int√©ntalo m√°s tarde.",
        desconocido:"Error de inicio de sesi√≥n."
      };
      alert(MSG[code] || ("Error login: " + code));
      return;
    }
    const rawRol = r.rol || "Invitado";
    const group  = ROLE_MAP[rawRol] || (rawRol.startsWith("RT") ? "rt" : "guest");
    setUser({ user, rol: rawRol, group });
    byId("userPanel").classList.add("hidden");
    byId("userPass").value = "";
  }catch(_){
    alert("No se pudo conectar. Revisa tu conexi√≥n e int√©ntalo de nuevo.");
  }
}
function logout(){ setUser({ user:"invitado", rol:"Invitado", group:"guest" }); }
async function changePwd(){
  const user = byId("userSelect").value;
  const old  = byId("oldPass").value || "";
  const nu   = byId("newPass").value || "";
  if(!old || !nu){ byId("pwdMsg").textContent = "Rellena ambas contrase√±as."; return; }
  const r = await apiPost({res:"auth", fn:"changepwd", user, old, nu});
  byId("pwdMsg").textContent = r.ok ? "Contrase√±a cambiada." : "Error al cambiar (credenciales).";
  if(r.ok){ byId("oldPass").value = ""; byId("newPass").value = ""; }
}

/* ========= MEN√öS ========= */
const pagesBtn   = byId("pagesBtn");
const userBtn    = byId("userBtn");
const pagesPanel = byId("pagesPanel");
const userPanel  = byId("userPanel");

/* Gesti√≥n de foco dentro del di√°logo usuario */
document.addEventListener("keydown", (e)=>{
  if (!isOpen(userPanel) || e.key !== "Tab") return;
  const f = [...userPanel.querySelectorAll('input,select,textarea,button,[tabindex]:not([tabindex="-1"])')]
    .filter(el => !el.disabled && el.offsetParent !== null);
  if (!f.length) return;
  const first = f[0], last = f[f.length-1];
  if (e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
  else if (!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
});

function setExpanded(btn, open){ if(btn) btn.setAttribute("aria-expanded", open ? "true" : "false"); }

/* Altura de header ‚Üí variable CSS (definida una sola vez) */
function syncHeaderHeightVar(){
  const h = Math.max(72, document.querySelector('header')?.offsetHeight || 0);
  document.documentElement.style.setProperty('--hdr-h', h + 'px');
}

function openPanel(panelEl, btnEl){
  if(!panelEl) return;
  panelEl.classList.remove("hidden");
  panelEl.classList.add("menu-full");

  if (panelEl === userPanel){
    panelEl.setAttribute("role","dialog");
    panelEl.setAttribute("aria-modal","true");
    panelEl.setAttribute("aria-labelledby","roleChip");
    panelEl._lastFocus = document.activeElement;
    const focusables = [...panelEl.querySelectorAll('button,[href],input:not([type="hidden"]),textarea,[tabindex]:not([tabindex="-1"])')]
      .filter(el => !el.disabled && el.offsetParent !== null);
    (focusables.find(el => el.matches('.btn, .gloss, [type="button"]')) || focusables[0])?.focus?.({ preventScroll:true });
  }

  setExpanded(btnEl, true);
  document.body.classList.add("menu-open");
  document.documentElement.classList.add("menu-open");
  syncHeaderHeightVar();
}

function closePanel(panelEl, btnEl){
  if(!panelEl) return;
  const last = panelEl._lastFocus;
  panelEl.classList.add("hidden");
  panelEl.classList.remove("menu-full");
  if (panelEl === userPanel){
    panelEl.removeAttribute("role"); panelEl.removeAttribute("aria-modal"); panelEl.removeAttribute("aria-labelledby");
  }
  setExpanded(btnEl, false);
  if (pagesPanel.classList.contains("hidden") && userPanel.classList.contains("hidden")){
    document.body.classList.remove("menu-open"); document.documentElement.classList.remove("menu-open");
  }
  last && last.focus && last.focus({ preventScroll:true });
}
function isOpen(panelEl){ return panelEl && !panelEl.classList.contains("hidden"); }
function closeAllMenus(){ closePanel(pagesPanel, pagesBtn); closePanel(userPanel, userBtn); }

/* Enlaces y cierres */
if(!document.documentElement.dataset.menusBound){
  document.documentElement.dataset.menusBound = "1";
  pagesBtn?.addEventListener("click", (e)=>{ e.stopPropagation(); closePanel(userPanel, userBtn); isOpen(pagesPanel) ? closePanel(pagesPanel, pagesBtn) : openPanel(pagesPanel, pagesBtn); });
  userBtn?.addEventListener("click", (e)=>{ e.stopPropagation(); closePanel(pagesPanel, pagesBtn); isOpen(userPanel) ? closePanel(userPanel, userBtn) : openPanel(userPanel, userBtn); });
  pagesPanel?.addEventListener("click", (e)=> e.stopPropagation());
  userPanel  ?.addEventListener("click", (e)=>{ if (e.target.closest(".row")) { e.stopPropagation(); return; } closeAllMenus(); });
  document.addEventListener("click", (e)=>{
    const t = e.target;
    const inside = (x, y)=> !!y && (y === x || y.contains(x));
    const enPages = inside(t, pagesPanel) || inside(t, pagesBtn);
    const enUser  = inside(t, userPanel)  || inside(t, userBtn);
    if (!enPages && !enUser) closeAllMenus();
  });
  document.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeAllMenus(); });
  [pagesBtn, userBtn].forEach(btn=>{
    btn?.setAttribute("role","button"); btn?.setAttribute("tabindex","0");
    btn?.addEventListener("keydown", (e)=>{ if (e.key === "Enter" || e.key === " "){ e.preventDefault(); btn.click(); } });
  });
}

/* ========= NAV ========= */
let CURRENT_PAGE = "equipos";
function nav(id){
  closeAllMenus();
  CURRENT_PAGE = id;
  ["equipos","gruas","otros","incidencias","indicadores","ot","inventario","tv","equipo","repuesto"]
    .forEach(s => byId("page-" + s).classList.add("hidden"));
  byId("page-" + id).classList.remove("hidden");

  if (id === "equipos")     loadState();
  if (id === "gruas")       renderSubGroup("Puentes Gr√∫a","gruasWrap");
  if (id === "otros")       renderSubGroup("Otros (auxiliares)","otrosWrap");
  if (id === "incidencias") loadIncid();
  if (id === "indicadores") loadIncid().then(()=>{ calcKPIs(); drawAllCharts(); });
  if (id === "ot")          loadOT();
  if (id === "inventario")  loadInv();
  if (id === "tv")          initTV();

  window.scrollTo({ top: 0, behavior: "smooth" });
}

/* ========= ESTADO EQUIPOS ========= */
let STATE = [];
function statusKey(s){ return s === "Parada" ? "stop" : (s === "Restricciones" ? "warn" : "ok"); }

async function loadState(){
  try{
    const j = await apiGet({res:"state", fn:"list"});
    if (j.ok && j.items.length){ STATE = j.items; renderState(); return; }
    await apiPost({res:"state", fn:"seed"});
    const k = await apiGet({res:"state", fn:"list"});
    STATE = k.ok ? k.items : [];
    renderState();
  }catch(e){ console.error(e); }
}
function groupItems(items){ const by = {}; items.forEach(it => { (by[it.grupo] ??= []).push(it); }); return by; }
function renderState(){
  const groups = groupItems(STATE);
  const wrap = byId("equiposWrap"); wrap.innerHTML = "";
  for (const [g, items] of Object.entries(groups)){
    if (g.startsWith("Puentes Gr√∫a") || g === "Otros (auxiliares)") continue;
    wrap.appendChild(groupBlock(g, items));
  }
  if (!byId("page-gruas").classList.contains("hidden")) renderSubGroup("Puentes Gr√∫a", "gruasWrap");
  if (!byId("page-otros").classList.contains("hidden")) renderSubGroup("Otros (auxiliares)", "otrosWrap");
}
function groupBlock(title, items){
  const d = document.createElement("div");
  const showTitle = String(title).trim().toUpperCase() !== "L√çNEA KALTENBACH";
  d.innerHTML = showTitle ? `<h3 class="grp-title cdl-tag">${esc(title)}</h3>` : "";
  items.forEach(eq => d.appendChild(cardEquipo(eq)));
  return d;
}
function renderSubGroup(match, target){
  const wrap = byId(target); if (!wrap) return;
  wrap.innerHTML = "";
  const items = STATE.filter(x => match === "Otros (auxiliares)" ? x.grupo === match : x.grupo.startsWith(match));
  const groups = groupItems(items);
  for (const [g, arr] of Object.entries(groups)) wrap.appendChild(groupBlock(g, arr));
}
function cardEquipo(eq){
  const safeName = JSON.stringify(eq.nombre).slice(1, -1);
  const slug = slugify(eq.nombre);
  const qrId = `qr-${slug}`;

  const el = document.createElement("div");
  el.className = "card";
  el.innerHTML = `
  <div class="card-main">
    <div style="display:flex;gap:.6rem;align-items:center;min-width:240px">
      <span class="pilot ${"p-" + statusKey(eq.estado)}"></span>
      <div>
        <div class="name" style="display:flex;align-items:center;gap:.4rem;flex-wrap:wrap">
          <span class="linkish" role="button" tabindex="0"
            onclick="openEquipoByName('${safeName}')"
            onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openEquipoByName('${safeName}')}">
            ${esc(eq.nombre)}
          </span>
        </div>
        <div class="sub">${esc(eq.grupo)}</div>
      </div>
    </div>

    <div class="semaforo" data-name="${safeName}" role="radiogroup" aria-label="Estado">
      <div class="opt ${statusKey(eq.estado)==="ok"?'active':''}" data-k="ok">En marcha</div>
      <div class="opt ${statusKey(eq.estado)==="warn"?'active':''}" data-k="warn">Restricciones</div>
      <div class="opt ${statusKey(eq.estado)==="stop"?'active':''}" data-k="stop">Parada</div>
    </div>

    <div class="right">
      <button class="btn gloss" onclick="estadoConIncid('${safeName}','Parada','programada')">Parada prog.</button>
      <button class="btn gloss btn-mail" onclick="accionParadaProlongada('${safeName}')">Parada prolongada</button>
      <button class="btn gloss" onclick="estadoConIncid('${safeName}','Nueva')">Nueva incidencia</button>
    </div>
  </div>

  <div class="card-qr">
    <div class="qrbox" id="${qrId}"></div>
    <button class="btn gloss btn-ficha" onclick="openEquipoByName('${safeName}')">Ficha</button>
  </div>`;

  setTimeout(()=>{
    const opts = el.querySelectorAll(".semaforo .opt");
    opts.forEach(o=>{
      o.tabIndex = 0;
      o.setAttribute("role","radio");
      o.setAttribute("aria-checked", o.classList.contains("active") ? "true" : "false");
      o.addEventListener("click", async (e)=>{
        const name   = el.querySelector(".semaforo").dataset.name;
        const k      = e.currentTarget.getAttribute("data-k");
        const estado = k === "ok" ? "En marcha" : (k === "warn" ? "Restricciones" : "Parada");
        const ok = await setEstado(name, estado);
        if (!ok) return;
        opts.forEach(x=>{ x.classList.remove("active"); x.setAttribute("aria-checked","false"); });
        e.currentTarget.classList.add("active");
        e.currentTarget.setAttribute("aria-checked","true");
      });
      o.addEventListener("keydown",(e)=>{
        if (e.key==="Enter"||e.key===" "){ e.preventDefault(); o.click(); }
        if (["ArrowRight","ArrowDown","ArrowLeft","ArrowUp"].includes(e.key)){
          e.preventDefault();
          const arr = Array.from(opts); const i = arr.indexOf(o);
          const dir = (e.key==="ArrowLeft"||e.key==="ArrowUp")? -1 : 1;
          const next = arr[(i+dir+arr.length)%arr.length]; next.focus();
        }
      });
    });

    // QR real que abre la ficha
    const qrHost = el.querySelector('#'+qrId);
    if (qrHost){
      const url = `${baseURL()}#/equipo/${slug}`;
      new QRCode(qrHost, { text:url, width:64, height:64, correctLevel: QRCode.CorrectLevel.M });
      qrHost.title = "Abrir ficha";
      qrHost.style.cursor = "pointer";
      qrHost.addEventListener("click", ()=> openEquipoByName(safeName));
    }
  }, 0);

  return el;
}
function openFicha(name){ openEquipoByName(name); }

/* ========== INCIDENCIAS ========== */
let INCIDS_ALL = [];
let INCID_PAGE=1, INCID_PAGE_SIZE=10, INCID_SORT_KEY="fecha", INCID_SORT_DIR="desc";

function resetIncidFilters(){
  ["fEquipo","fTipo","fRes","filtroIncid"].forEach(id => { const el = byId(id); if (el) el.value = ""; });
  renderIncidTable();
}

async function addIncid(){
  if (!canEdit()){ alert("Inicia sesi√≥n para registrar incidencias."); return; }
  const btn = byId("btnAddIncid"); if (btn) btn.disabled = true;

  const item = {
    equipo: val("iEquipo"), tipo: val("iTipo"), res: val("iRes"),
    rep: val("iRep"), repTxt: (val("iRepTxt") || "").trim(),
    hParo: Number(val("iHParo") || 0) || 0, hRep: Number(val("iHRep") || 0) || 0,
    inicio: val("iInicio") || "", fin: val("iFin") || "",
    reportante: (val("iReport") || "").trim(), asignado: (val("iAsignado") || "").trim(),
    adj: "", desc: (val("iDesc") || "").trim()
  };

  if (!item.equipo){ alert("Selecciona un equipo."); if (btn) btn.disabled = false; return; }

  try{
    const r = await apiPost({res:"incid", fn:"add", item, actor: currentUser.user});
    if (!r?.ok) throw new Error("No se pudo guardar");
    toast("Incidencia registrada");
    ["iRepTxt","iHParo","iHRep","iInicio","iFin","iReport","iAsignado","iDesc"].forEach(id=>{
      const el = byId(id); if (el) el.value = (id === "iHParo" || id === "iHRep") ? 0 : "";
    });
    byId("iRep").value = "No"; byId("iTipo").value = "Correctivo"; byId("iRes").value = "Solucionado";
    await loadIncid(); await loadState();
  }catch(err){
    console.error(err); alert("Error al registrar la incidencia.");
  }finally{
    if (btn) btn.disabled = false;
  }
}

async function loadIncid(){
  const st  = await apiGet({res:"state", fn:"list"});  STATE      = st.ok  ? st.items : [];
  const inc = await apiGet({res:"incid", fn:"list"});  INCIDS_ALL = inc.ok ? inc.items : [];

  byId("iEquipo").innerHTML = STATE.map(x => `<option>${esc(x.nombre)}</option>`).join("");
  buildIncidFilters();

  if (!byId("filtroIncid").dataset.bound){
    byId("filtroIncid").addEventListener("input", renderIncidTable);
    ["fEquipo","fTipo","fRes"].forEach(id => byId(id).addEventListener("change", renderIncidTable));
    byId("filtroIncid").dataset.bound = "1";
  }
  renderIncidTable();
}
function renderIncidTable(){
  const wrap = byId("incidTableWrap"); if (!wrap) return;

  const q = (byId("filtroIncid").value || "").toLowerCase();
  const fe = byId("fEquipo").value || "";
  const ft = byId("fTipo").value   || "";
  const fr = byId("fRes").value    || "";

  const data = (INCIDS_ALL || []).filter(x=>{
    const txt = (String(x.equipo||"")+String(x.tipo||"")+String(x.res||"")+String(x.desc||"")).toLowerCase();
    return (!q || txt.includes(q)) &&
           (!fe || x.equipo===fe) &&
           (!ft || x.tipo===ft) &&
           (!fr || x.res===fr);
  });

  const makeSummary = (s,max=70)=>{
    const t = String(s||"").trim().replace(/\s+/g," ");
    if (t.length<=max) return t || "‚Äî";
    const cut = t.slice(0,max);
    return cut.replace(/\s[^ ]*$/,"") + "‚Ä¶";
  };

  const rows = data.slice(0, Math.min(data.length, 300)).map(x=>{
    const full = esc(x.desc || "");
    const sum  = esc(makeSummary(x.desc));
    return `
      <tr>
        <td class="nowrap">${fmtDate(x.created)}</td>
        <td>${esc(x.equipo || "")}</td>
        <td>${esc(x.tipo || "")}</td>
        <td>${esc(x.res  || "")}</td>
        <td>
          <details class="desc">
            <summary>${sum}</summary>
            <div class="full">${full}</div>
          </details>
        </td>
        <td class="num">${fmt(x.hParo || 0)}</td>
        <td class="num">${fmt(x.hRep  || 0)}</td>
      </tr>`;
  }).join("");

  wrap.innerHTML = `
  <table aria-label="Tabla de incidencias">
    <thead>
      <tr>
        <th>Fecha</th><th>Equipo</th><th>Tipo</th>
        <th>Resultado</th><th>Descripci√≥n</th><th>Parada</th><th>Reparaci√≥n</th>
      </tr>
    </thead>
    <tbody>${rows || '<tr><td colspan="7">Sin incidencias</td></tr>'}</tbody>
  </table>`;
}
function buildIncidFilters(){
  const equipos = [...new Set(INCIDS_ALL.map(x => String(x.equipo || "").trim()))].sort((a,b)=>a.localeCompare(b,"es"));
  const tipos   = [...new Set(["Correctivo","Preventivo","Predictivo","Mejora", ...INCIDS_ALL.map(x=>String(x.tipo||"").trim())])].sort((a,b)=>a.localeCompare(b,"es"));
  const resul   = [...new Set(["Solucionado","Con restricciones","Parada", ...INCIDS_ALL.map(x=>String(x.res||"").trim())])].sort((a,b)=>a.localeCompare(b,"es"));

  byId("fEquipo").innerHTML = `<option value="">Equipo: todos</option>` + equipos.map(n => `<option value="${esc(n)}">${esc(n)}</option>`).join("");
  byId("fTipo").innerHTML   = `<option value="">Tipo: todos</option>`   + tipos.map(n => `<option>${esc(n)}</option>`).join("");
  byId("fRes").innerHTML    = `<option value="">Resultado: todos</option>` + resul.map(n => `<option>${esc(n)}</option>`).join("");
}

/* ========== KPIs + CHARTS ========== */
function isoWeekKey(d){
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = (date.getUTCDay() + 6) % 7;           // Lunes=0
  date.setUTCDate(date.getUTCDate() - dayNum + 3);     // al jueves ISO
  const week1 = new Date(Date.UTC(date.getUTCFullYear(), 0, 4));
  const week = 1 + Math.round(((date - week1) / 86400000 - 3 + ((week1.getUTCDay()+6)%7)) / 7);
  return `${date.getUTCFullYear()}-W${String(week).padStart(2,"0")}`;
}
function groupByWeek(arr){
  const g = {};
  for (const x of arr){
    const d = new Date(x.created);
    const k = isoWeekKey(d);
    (g[k] ??= []).push(x);
  }
  return g;
}
function kpiMTTR(list){ const s = list.reduce((p,x)=> p + (+x.hRep  || 0), 0); const n = list.length || 1; return s / n; }
function kpiMTBF(list){ const horas = 4 * 30 * 24; const fallas = list.length || 1; return horas / fallas; }
function kpiDisp(list){ const prodH = 120; const perd = list.reduce((p,x)=> p + (+x.hParo || 0), 0); return Math.max(0, (prodH - perd) / prodH); }
function kpiOEE(disp){ return disp * 0.9 * 0.98; }

function calcKPIs(){
  const mttr = kpiMTTR(INCIDS_ALL), mtbf = kpiMTBF(INCIDS_ALL), disp = kpiDisp(INCIDS_ALL), oee = kpiOEE(disp);
  setTxt("kpiMttrG", fmt(mttr)); setTxt("kpiMbfG", fmt(mtbf)); setTxt("kpiDispG", fmt(disp * 100)); setTxt("kpiOeeG", fmt(oee * 100));
}

/* --- util: semanas ISO recientes cuando no hay datos --- */
function lastNISOWeeks(n=8){
  const out = [];
  const today = new Date();
  for (let i = n-1; i >= 0; i--){
    const d = new Date(today);
    d.setDate(today.getDate() - i * 7);
    out.push(isoWeekKey(d));
  }
  return [...new Set(out)];
}

/* --- pinta una l√≠nea con ejes visibles, incluso sin datos --- */
window.charts = window.charts || {};
const charts = window.charts;

function draw(id, labels, data, label){
  if (!labels || !labels.length){
    labels = lastNISOWeeks(8);
    data   = new Array(labels.length).fill(0);
  }
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.add('chartjs-grid-dark');
  const ctx = el.getContext("2d");

  if (charts[id]) charts[id].destroy();

  charts[id] = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{ label, data, borderWidth: 2, pointRadius: 0, tension: 0.3 }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display:false }, tooltip:{ intersect:false, mode:'index' } },
      scales: {
        x: { grid:{ color:'rgba(255,255,255,0.08)' }, ticks:{ color:'#cbd5e1', autoSkip:true, maxTicksLimit:8 } },
        y: { grid:{ color:'rgba(255,255,255,0.08)' }, ticks:{ color:'#cbd5e1' }, suggestedMin:0 }
      }
    }
  });
}

/* --- construye todas las series; si no hay incidencias, usa 8 semanas 0 --- */
function drawAllCharts(){
  const weeks = groupByWeek(INCIDS_ALL);
  let labels = Object.keys(weeks).sort((a,b)=>{
    const [ya, wa] = a.split("-W").map(Number);
    const [yb, wb] = b.split("-W").map(Number);
    return ya === yb ? (wa - wb) : (ya - yb);
  });
  if (!labels.length) labels = lastNISOWeeks(8);
  const getW = (w)=> weeks[w] || [];
  draw("chartMttr", labels, labels.map(w => kpiMTTR(getW(w))), "MTTR");
  draw("chartMtbf", labels, labels.map(w => kpiMTBF(getW(w))), "MTBF");
  draw("chartDisp", labels, labels.map(w => kpiDisp(getW(w)) * 100), "Disponibilidad %");
  draw("chartOee",  labels, labels.map(w => kpiOEE(kpiDisp(getW(w))) * 100), "OEE %");
}

/* ========== √ìRDENES DE TRABAJO ========== */
let OTS = [];
let OT_PAGE=1, OT_PAGE_SIZE=10, OT_SORT_KEY="fecha", OT_SORT_DIR="desc";

async function loadOT(){
  const st = await apiGet({res:"state", fn:"list"}); STATE = st.ok ? st.items : [];
  const ot = await apiGet({res:"ot", fn:"list"});     OTS   = ot.ok ? ot.items : [];
  byId("otEquipo").innerHTML = STATE.map(x => `<option>${esc(x.nombre)}</option>`).join("");
  renderOT();
}

function setOTSort(key){
  if (OT_SORT_KEY === key){ OT_SORT_DIR = (OT_SORT_DIR === "asc" ? "desc" : "asc"); }
  else { OT_SORT_KEY = key; OT_SORT_DIR = (key === "fecha" ? "desc" : "asc"); }
  renderOT();
}
function setOTPage(n){ OT_PAGE = Math.max(1, n); renderOT(); }
function setOTPageSize(n){ OT_PAGE_SIZE = +n || 10; OT_PAGE = 1; renderOT(); }

function renderOT(){
  let arr = [...OTS];
  const dir = (OT_SORT_DIR === "asc" ? 1 : -1);
  arr.sort((a,b)=>{
    let A,B;
    switch(OT_SORT_KEY){
      case "fecha":     A = new Date(a.created).getTime(); B = new Date(b.created).getTime(); break;
      case "titulo":    A = a.titulo || ""; B = b.titulo || ""; break;
      case "prioridad": A = a.prioridad || ""; B = b.prioridad || ""; break;
      case "asignado":  A = a.asignado  || ""; B = b.asignado  || ""; break;
      case "vence":     A = a.vencimiento || ""; B = b.vencimiento || ""; break;
      case "estado":    A = a.estado || ""; B = b.estado || ""; break;
      default:          A = 0; B = 0;
    }
    if (typeof A === "string" && typeof B === "string") return A.localeCompare(B, "es") * dir;
    return (A === B ? 0 : (A > B ? 1 : -1)) * dir;
  });

  const total = arr.length;
  const pages = Math.max(1, Math.ceil(total / OT_PAGE_SIZE));
  OT_PAGE = Math.min(OT_PAGE, pages);
  const start = (OT_PAGE - 1) * OT_PAGE_SIZE;
  arr = arr.slice(start, start + OT_PAGE_SIZE);

  const rows = arr.map(o=>`
    <tr>
      <td class="nowrap">${fmtDate(o.created)}</td>
      <td><b>${esc(o.titulo || "")}</b><div class="sub">${esc(o.equipo)}</div></td>
      <td>${esc(o.prioridad || "")}</td>
      <td>${esc(o.asignado  || "")}</td>
      <td class="nowrap">${esc(o.vencimiento || "")}</td>
      <td>${esc(o.estado || "")}</td>
    </tr>`).join("");

  byId("otTableWrap").innerHTML = `
  <table>
    <thead>
      <tr>
        <th><button class="page-btn" onclick="setOTSort('fecha')">Fecha ${OT_SORT_KEY==='fecha'?(OT_SORT_DIR==='asc'?'‚ñ≤':'‚ñº'):'‚Üï'}</button></th>
        <th><button class="page-btn" onclick="setOTSort('titulo')">OT ${OT_SORT_KEY==='titulo'?(OT_SORT_DIR==='asc'?'‚ñ≤':'‚ñº'):'‚Üï'}</button></th>
        <th><button class="page-btn" onclick="setOTSort('prioridad')">Prioridad ${OT_SORT_KEY==='prioridad'?(OT_SORT_DIR==='asc'?'‚ñ≤':'‚ñº'):'‚Üï'}</button></th>
        <th><button class="page-btn" onclick="setOTSort('asignado')">Asignado ${OT_SORT_KEY==='asignado'?(OT_SORT_DIR==='asc'?'‚ñ≤':'‚ñº'):'‚Üï'}</button></th>
        <th><button class="page-btn" onclick="setOTSort('vence')">Vence ${OT_SORT_KEY==='vence'?(OT_SORT_DIR==='asc'?'‚ñ≤':'‚ñº'):'‚Üï'}</button></th>
        <th><button class="page-btn" onclick="setOTSort('estado')">Estado ${OT_SORT_KEY==='estado'?(OT_SORT_DIR==='asc'?'‚ñ≤':'‚ñº'):'‚Üï'}</button></th>
      </tr>
    </thead>
    <tbody>${rows || '<tr><td colspan="6">Sin √≥rdenes de trabajo</td></tr>'}</tbody>
  </table>
  <div class="pager">
    <button class="page-btn"
            onclick="setOTPage(${OT_PAGE-1})"
            aria-disabled="${OT_PAGE<=1}"
            ${OT_PAGE<=1?'disabled':''}>‚Äπ</button>

    <span>P√°gina ${OT_PAGE} de ${pages}</span>

    <button class="page-btn"
            onclick="setOTPage(${OT_PAGE+1})"
            aria-disabled="${OT_PAGE>=pages}"
            ${OT_PAGE>=pages?'disabled':''}>‚Ä∫</button>
  </div>
`;
}
/* ========== INVENTARIO ========== */
let INV = [];
let INV_PAGE=1, INV_PAGE_SIZE=10, INV_SORT_KEY="ref", INV_SORT_DIR="asc";
const QR_SEL = new Set();

async function loadInv(){
  const j = await apiGet({res:"inv", fn:"list"});
  INV = j.ok ? j.items : [];
  renderInv();
  renderInvAlerts();
}
function toggleInvAlerts(){ byId("invAlerts").classList.toggle("hidden"); }

function syncInvHeader(){
  const hdr = byId("invQrAll");
  if(!hdr) return;
  const checks = [...document.querySelectorAll("#invTableWrap .qrck")];
  if(!checks.length){ hdr.checked = false; hdr.indeterminate = false; return; }
  const refsVisible = checks.map(c => (c.closest("tr")?.querySelector("b")?.textContent || "").toUpperCase());
  const allOn  = refsVisible.every(ref => QR_SEL.has(ref));
  const noneOn = refsVisible.every(ref => !QR_SEL.has(ref));
  hdr.checked = allOn;
  hdr.indeterminate = !allOn && !noneOn;
}
function renderInvAlerts(){
  const badge = byId("invAlertWrap");
  const box   = byId("invAlerts");
  if(!badge || !box) return;
  const lows = (INV || []).filter(x => (+x.stock || 0) <= (+x.minimo || 0));
  if(!lows.length){
    badge.classList.add("hidden"); badge.textContent = "Alertas"; box.innerHTML = ""; return;
  }
  badge.classList.remove("hidden");
  badge.textContent = `Alertas (${lows.length})`;
  box.innerHTML = lows.map(x => `
    <div class="badge-chip badge-low" style="display:inline-flex;margin:4px 6px 0 0;background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.45);color:#fecaca;border-radius:999px;padding:.12rem .5rem;font-weight:900">
      <b style="margin-right:.35rem">${esc(String(x.ref || "").toUpperCase())}</b> ${esc(x.nombre || "")}
      &nbsp;¬∑&nbsp;<span>Stock: ${+x.stock || 0}/${+x.minimo || 0}</span>
    </div>`).join("");
}
function setInvSort(key){
  if (INV_SORT_KEY === key){ INV_SORT_DIR = (INV_SORT_DIR === "asc" ? "desc" : "asc"); }
  else { INV_SORT_KEY = key; INV_SORT_DIR = "asc"; }
  renderInv();
}
function setInvPage(n){ INV_PAGE = Math.max(1, n); renderInv(); }
function setInvPageSize(n){ INV_PAGE_SIZE = +n || 10; INV_PAGE = 1; renderInv(); }

function renderInv(){
  const q = (byId("invSearch").value || "").toLowerCase();
  let arr = INV.filter(x => (String(x.nombre || "") + String(x.ref || "")).toLowerCase().includes(q));

  const dir = (INV_SORT_DIR === "asc" ? 1 : -1);
  arr.sort((a,b)=>{
    let A,B;
    switch(INV_SORT_KEY){
      case "ref":    A = a.ref || "";     B = b.ref || ""; break;
      case "nombre": A = a.nombre || "";  B = b.nombre || ""; break;
      case "stock":  A = +a.stock || 0;   B = +b.stock || 0; break;
      case "minimo": A = +a.minimo || 0;  B = +b.minimo || 0; break;
      default:       A = 0;               B = 0;
    }
    if (typeof A === "string" && typeof B === "string") return A.localeCompare(B,"es") * dir;
    return (A === B ? 0 : (A > B ? 1 : -1)) * dir;
  });

  const total = arr.length;
  const pages = Math.max(1, Math.ceil(total / INV_PAGE_SIZE));
  INV_PAGE = Math.min(INV_PAGE, pages);
  const start = (INV_PAGE - 1) * INV_PAGE_SIZE;
  arr = arr.slice(start, start + INV_PAGE_SIZE);

  const rows = arr.map(x=>{
    const low = (+x.stock || 0) <= (+x.minimo || 0);
    const refRaw = String(x.ref || "").toUpperCase();
    const refEsc = JSON.stringify(refRaw).slice(1, -1);
    const checked = QR_SEL.has(refRaw) ? "checked" : "";
    return `<tr class="${low ? "row-low" : ""}">
      <td class="num" style="text-align:center;width:54px">
        <input class="qrck" type="checkbox" ${checked}
          aria-label="Seleccionar ${esc(refRaw)}"
          onchange="(this.checked?QR_SEL.add('${refEsc}'):QR_SEL.delete('${refEsc}')); syncInvHeader()">
      </td>
      <td>
        <b>${esc(refRaw)}</b>
        <div class="sub">${esc(x.nombre || "")}</div>
        ${low ? '<div class="badge-low" style="display:inline-flex;gap:.35rem;padding:.18rem .5rem;border-radius:999px;font-weight:800;background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.45);color:#fecaca">Bajo m√≠nimo</div>' : ''}
      </td>
      <td class="num"><span class="linkish" tabindex="0" onclick="editStock('${refEsc}',${+x.stock || 0})" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();editStock('${refEsc}',${+x.stock || 0});}">${+x.stock || 0}</span></td>
      <td class="num">${+x.minimo || 0}</td>
      <td>
        <button class="btn gloss" onclick="delta('${refEsc}',-1)">‚Äì1</button>
        <button class="btn gloss" onclick="delta('${refEsc}',+1)">+1</button>
        <button class="btn gloss" onclick="openRepuestoByRef('${refEsc}')">QR</button>
      </td>
    </tr>`;
  }).join("");

  const th = (label,key)=>`<button class="page-btn" onclick="setInvSort('${key}')">${label} ${INV_SORT_KEY===key?(INV_SORT_DIR==='asc'?'‚ñ≤':'‚ñº'):'‚Üï'}</button>`;

  byId("invTableWrap").innerHTML = `
    <table>
      <thead>
        <tr>
          <th style="width:54px;text-align:center">
            <input id="invQrAll" type="checkbox" aria-label="Seleccionar visibles"
              onchange="
                document.querySelectorAll('#invTableWrap .qrck').forEach(c=>{
                  c.checked = byId('invQrAll').checked;
                  const ref = (c.closest('tr')?.querySelector('b')||{}).textContent || '';
                  if(c.checked) QR_SEL.add(ref.toUpperCase()); else QR_SEL.delete(ref.toUpperCase());
                });
                syncInvHeader();
              ">
          </th>
          <th>${th("Repuesto","ref")}</th>
          <th>${th("Stock","stock")}</th>
          <th>${th("M√≠nimo","minimo")}</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>${rows || '<tr><td colspan="5">Sin repuestos</td></tr>'}</tbody>
    </table>

    <div class="pager" style="margin-top:.6rem;display:flex;align-items:center;gap:.6rem;flex-wrap:wrap">
      <button class="page-btn"
              onclick="setInvPage(${INV_PAGE-1})"
              aria-disabled="${INV_PAGE<=1}"
              ${INV_PAGE<=1?'disabled':''}>‚Äπ</button>

      <span>P√°gina ${INV_PAGE} de ${pages}</span>

      <button class="page-btn"
              onclick="setInvPage(${INV_PAGE+1})"
              aria-disabled="${INV_PAGE>=pages}"
              ${INV_PAGE>=pages?'disabled':''}>‚Ä∫</button>

      <label class="small">Filas:
        <select onchange="setInvPageSize(this.value)">
          ${[10,20,50,100].map(n=>`<option ${n===INV_PAGE_SIZE?'selected':''}>${n}</option>`).join('')}
        </select>
      </label>
    </div>
  `;

  renderInvAlerts();
  syncInvHeader();
}
async function addInv(){
  if (!canEdit()){ alert("Inicia sesi√≥n para a√±adir repuestos."); return; }
  const nombre = (val("invNombre") || "").trim();
  const ref    = (val("invRef")    || "").trim().toUpperCase();
  const stock  = Number(val("invStock"));
  const minimo = Number(val("invMin"));
  if (!ref || !nombre || !Number.isFinite(stock) || stock < 0 || !Number.isFinite(minimo) || minimo < 0){
    alert("Revisa los campos."); return;
  }
  await apiPost({res:"inv", fn:"add", item:{nombre, ref, stock:Math.floor(stock), minimo:Math.floor(minimo)}, actor: currentUser.user});
  toast("Repuesto a√±adido");
  ["invNombre","invRef","invStock","invMin"].forEach(id => byId(id).value = "");   
  await loadInv();
}
async function delta(ref,d){
  if (!canEdit()){ alert("Inicia sesi√≥n para modificar stock."); return; }
  await apiPost({res:"inv", fn:"delta", ref, delta:+d || 0, actor: currentUser.user});
  await loadInv();
}
async function editStock(ref,cur){
  if (!canEdit()){ alert("Inicia sesi√≥n para modificar stock."); return; }
  const nv = prompt("Nuevo stock para " + ref, cur); if (nv === null) return;
  const num = parseInt(nv, 10); if (!Number.isFinite(num) || num < 0){ alert("Valor inv√°lido"); return; }
  const it = INV.find(x => String(x.ref).toUpperCase() === String(ref).toUpperCase()); if (!it) return;
  const change = num - (+it.stock || 0); if (!change) return;
  await apiPost({res:"inv", fn:"delta", ref, delta: change, actor: currentUser.user});
  await loadInv();
}

/* ========== DASHBOARD TV ========== */
let TV_TIMER = null;
async function loadTVOnce(){
  const st  = await apiGet({res:"state", fn:"list"}); STATE = st.ok ? st.items : [];
  const inv = await apiGet({res:"inv", fn:"list"});   INV   = inv.ok ? inv.items : [];
  renderTV();
}
function renderTV(){
  const par = STATE.filter(x => x.estado === "Parada");
  const res = STATE.filter(x => x.estado === "Restricciones");
  const low = INV.filter(x => (+x.stock || 0) <= (+x.minimo || 0));
  byId("tvParados").innerHTML = par.length ? par.map(x => `<div class="tv-item stop" style="padding:.28rem .5rem;border-radius:8px;background:#0b1220;border:1px solid #7f1d1d;font-weight:700">PARADA ‚Äî ${esc(x.nombre)}</div>`).join("") : `<div class="tv-item">Sin paradas</div>`;
  byId("tvRestr").innerHTML   = res.length ? res.map(x => `<div class="tv-item warn" style="padding:.28rem .5rem;border-radius:8px;background:#0b1220;border:1px solid #854d0e;font-weight:700">RESTRICCIONES ‚Äî ${esc(x.nombre)}</div>`).join("") : `<div class="tv-item">Sin restricciones</div>`;
  byId("tvStock").innerHTML   = low.length ? low.map(x => `<div class="tv-item stock" style="padding:.28rem .5rem;border-radius:8px;background:#0b1220;border:1px solid #1e3a8a;font-weight:700">BAJO M√çNIMO ‚Äî ${esc(x.ref)} ¬∑ ${esc(x.nombre)} (${x.stock}/${x.minimo})</div>`).join("") : `<div class="tv-item">Stock correcto</div>`;
}
function initTV(){
  loadTVOnce();
  if (TV_TIMER) clearInterval(TV_TIMER);
  TV_TIMER = setInterval(()=>{ if (document.visibilityState === "visible") loadTVOnce(); }, 10000);
}

/* ========== DETALLES (QR / routing) ========== */
function slugify(s){
  return String(s || "")
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}
function baseURL(){ return location.origin + location.pathname; }

function ensureSectionsHidden(){
  const ids = ["equipos","gruas","otros","incidencias","indicadores","ot","inventario","tv","equipo","repuesto"];
  ids.forEach((s)=>{
    const el = byId("page-" + s);
    if (el) el.classList.add("hidden");
  });
}
function openEquipoByName(name){
  const slug = slugify(name);
  location.hash = `#/equipo/${slug}`;
  renderEquipoBySlug(slug);
}
function openRepuestoByRef(ref){
  const code = encodeURIComponent(String(ref || "").toUpperCase());
  location.hash = `#/repuesto/${code}`;
  renderRepuestoByRef(code);
}

function renderEquipoBySlug(slug){
  const eq = STATE.find(x => slugify(x.nombre) === slug);
  ensureSectionsHidden();
  const host = byId("page-equipo"); host.classList.remove("hidden");
  if (!eq){ byId("equipoDetail").innerHTML = `<div class="kpi">Equipo no encontrado.</div>`; return; }
  const inc = (window.INCIDS_ALL || []).filter(i => i.equipo === eq.nombre).sort((a,b)=> new Date(b.created) - new Date(a.created));
  const qrText = `${baseURL()}#/equipo/${slug}`;
  const htmlInc = inc.length ? inc.map(i =>
    `<tr><td class="nowrap">${fmtDate(i.created)}</td><td>${esc(i.tipo||"")}</td><td>${esc(i.res||"")}</td><td>${esc(i.desc||"")}</td><td class="num">${fmt(i.hParo||0)}</td><td class="num">${fmt(i.hRep||0)}</td></tr>`
  ).join("") : `<tr><td colspan="6">Sin incidencias registradas.</td></tr>`;
  const safeTitle = JSON.stringify(String(eq.nombre || "")).slice(1,-1);
  byId("equipoDetail").innerHTML = `
    <div class="kpi" style="background:#0f141c;color:#e5e7eb;border:1px solid #2a3442;border-radius:14px;padding:.7rem .9rem;margin:.5rem 0">
      <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
        <div id="eqQR" style="width:160px;height:160px;border:1px dashed #2a3442;border-radius:12px;display:flex;align-items:center;justify-content:center;background:#0f141c"></div>
        <div>
          <h2 style="margin:.2rem 0">${esc(eq.nombre)}</h2>
          <div class="sub">${esc(eq.grupo)}</div>
          <div style="margin-top:.5rem"><code>${qrText}</code></div>
          <div style="margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap">
            <button class="btn gloss" onclick="printQR('eqQR','${safeTitle}')">Imprimir etiqueta</button>
            <button class="btn gloss" onclick="nav('equipos')">Volver</button>
          </div>
        </div>
      </div>
    </div>
    <div class="kpi" style="margin-top:12px;background:#0f141c;color:#e5e7eb;border:1px solid #2a3442;border-radius:14px;padding:.7rem .9rem">
      <h3 class="cdl-tag">Historial de incidencias ‚Äî ${esc(eq.nombre)}</h3>
      <table><thead><tr><th>Fecha</th><th>Tipo</th><th>Resultado</th><th>Descripci√≥n</th><th>Parada</th><th>Reparaci√≥n</th></tr></thead><tbody>${htmlInc}</tbody></table>
    </div>`;
  new QRCode(byId("eqQR"), { text: qrText, width: 150, height: 150, correctLevel: QRCode.CorrectLevel.M });
}

function renderRepuestoByRef(code){
  const ref = decodeURIComponent(code).toUpperCase();
  const it  = INV.find(x => String(x.ref).toUpperCase() === ref);
  ensureSectionsHidden();
  const host = byId("page-repuesto"); host.classList.remove("hidden");
  if (!it){ byId("repuestoDetail").innerHTML = `<div class="kpi">Repuesto no encontrado.</div>`; return; }
  const qrText = `${baseURL()}#/repuesto/${encodeURIComponent(ref)}`;
  const safeRefTitle = JSON.stringify("REP-" + ref).slice(1, -1);
  byId("repuestoDetail").innerHTML = `
    <div class="kpi" style="background:#0f141c;color:#e5e7eb;border:1px solid #2a3442;border-radius:14px;padding:.7rem .9rem;margin:.5rem 0">
      <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
        <div id="repQR" style="width:160px;height:160px;border:1px dashed #2a3442;border-radius:12px;display:flex;align-items:center;justify-content:center;background:#0f141c"></div>
        <div>
          <h2 style="margin:.2rem 0">${esc(it.nombre || "")}</h2>
          <div class="sub"><b>Ref:</b> ${esc(ref)} ¬∑ <b>Stock:</b> ${+it.stock || 0} ¬∑ <b>M√≠nimo:</b> ${+it.minimo || 0}</div>
          <div style="margin-top:.5rem"><code>${qrText}</code></div>
          <div style="margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap">
            <button class="btn gloss" onclick="printQR('repQR','${safeRefTitle}')">Imprimir etiqueta</button>
            <button class="btn gloss" onclick="nav('inventario')">Volver</button>
          </div>
        </div>
      </div>
    </div>`;
  new QRCode(byId("repQR"), { text: qrText, width: 150, height: 150, correctLevel: QRCode.CorrectLevel.M });
}

/* ========== EXPORTS / IMPRESI√ìN ========== */
function downloadText(filename, text, mime="text/plain"){
  const blob = new Blob([text], { type: mime + ";charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function toCSVCell(s){ const v = (s === undefined || s === null) ? "" : s; return '"' + String(v).replace(/"/g,'""') + '"'; }

function exportInvCSV(){
  const q = (byId("invSearch").value || "").toLowerCase();
  let arr = INV.filter(x => (String(x.nombre || "") + String(x.ref || "")).toLowerCase().includes(q));
  const dir = (INV_SORT_DIR === "asc" ? 1 : -1);
  arr.sort((a,b)=>{
    let A,B;
    switch(INV_SORT_KEY){
      case "ref":    A = a.ref || "";     B = b.ref || ""; break;
      case "nombre": A = a.nombre || "";  B = b.nombre || ""; break;
      case "stock":  A = +a.stock || 0;   B = +b.stock || 0; break;
      case "minimo": A = +a.minimo || 0;  B = +b.minimo || 0; break;
      default:       A = 0;               B = 0;
    }
    if (typeof A === "string" && typeof B === "string") return A.localeCompare(B,"es") * dir;
    return (A === B ? 0 : (A > B ? 1 : -1)) * dir;
  });
  if (!arr.length){ alert("No hay resultados para exportar."); return; }
  const header = "ref,nombre,stock,minimo";
  const lines = arr.map(x => [x.ref, x.nombre, x.stock, x.minimo].map(toCSVCell).join(","));
  downloadText("inventario.csv", header + "\n" + lines.join("\n"), "text/csv");
}

function openPrintDoc(title, htmlBody){
  const w = openPopupSafe(title || "Export");
  if (!w) return;
  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>${esc(title||"Export")}</title>
  <style>
    body{font-family:Inter,system-ui,sans-serif;margin:24px;color:#111}
    h1{margin:0 0 16px 0;font-size:20px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #ddd;padding:6px 8px;text-align:left}
    th{background:#f3f4f6}
    .mt{margin-top:12px}
    @media print { .no-print{display:none} }
  </style></head><body>
  ${htmlBody}
  <div class="no-print" style="margin-top:16px"><button onclick="window.print()">Imprimir</button></div>
  </body></html>`);
  w.document.close();
  w.focus();
}

function exportIncidCSV(){
  const q = (byId("filtroIncid").value || "").toLowerCase();
  const fe = byId("fEquipo").value || "";
  const ft = byId("fTipo").value   || "";
  const fr = byId("fRes").value    || "";
  const data = (INCIDS_ALL || []).filter(x=>{
    const txt = (String(x.equipo||"")+String(x.tipo||"")+String(x.res||"")+String(x.desc||"")).toLowerCase();
    return (!q || txt.includes(q)) && (!fe || x.equipo===fe) && (!ft || x.tipo===ft) && (!fr || x.res===fr);
  });
  const header = "fecha,equipo,tipo,resultado,descripcion,horas_paro,horas_reparacion";
  const rows = data.map(x => [
    fmtDate(x.created), x.equipo||"", x.tipo||"", x.res||"", x.desc||"", fmt(x.hParo||0), fmt(x.hRep||0)
  ].map(toCSVCell).join(","));
  if (!rows.length){ alert("Sin datos para exportar."); return; }
  downloadText("incidencias.csv", header + "\n" + rows.join("\n"), "text/csv");
}

function exportIncidPDF(){
  const q = (byId("filtroIncid").value || "").toLowerCase();
  const fe = byId("fEquipo").value || "";
  const ft = byId("fTipo").value   || "";
  const fr = byId("fRes").value    || "";
  const data = (INCIDS_ALL || []).filter(x=>{
    const txt = (String(x.equipo||"")+String(x.tipo||"")+String(x.res||"")+String(x.desc||"")).toLowerCase();
    return (!q || txt.includes(q)) && (!fe || x.equipo===fe) && (!ft || x.tipo===ft) && (!fr || x.res===fr);
  });
  const rows = data.map(x=>`<tr>
    <td>${esc(fmtDate(x.created))}</td><td>${esc(x.equipo||"")}</td><td>${esc(x.tipo||"")}</td>
    <td>${esc(x.res||"")}</td><td>${esc(x.desc||"")}</td><td style="text-align:right">${fmt(x.hParo||0)}</td><td style="text-align:right">${fmt(x.hRep||0)}</td></tr>`).join("");
  openPrintDoc("Incidencias", `<h1>Incidencias</h1>
  <table><thead><tr><th>Fecha</th><th>Equipo</th><th>Tipo</th><th>Resultado</th><th>Descripci√≥n</th><th>Parada</th><th>Reparaci√≥n</th></tr></thead>
  <tbody>${rows || '<tr><td colspan="7">Sin datos</td></tr>'}</tbody></table>`);
}

function exportKPIsCSV(){
  const weeks = groupByWeek(INCIDS_ALL);
  const labels = Object.keys(weeks).sort((a,b)=>{
    const [ya, wa] = a.split("-W").map(Number);
    const [yb, wb] = b.split("-W").map(Number);
    return ya === yb ? (wa - wb) : (ya - yb);
  });
  const header = "semana,mttr,mtbf,disp_pct,oee_pct";
  const rows = labels.map(w => {
    const d = weeks[w]; const disp = kpiDisp(d);
    return [w, fmt(kpiMTTR(d)), fmt(kpiMTBF(d)), fmt(disp*100), fmt(kpiOEE(disp)*100)].join(",");
  });
  const overall = (()=>{ const disp = kpiDisp(INCIDS_ALL); return ["TOTAL", fmt(kpiMTTR(INCIDS_ALL)), fmt(kpiMTBF(INCIDS_ALL)), fmt(disp*100), fmt(kpiOEE(disp)*100)].join(","); })();
  downloadText("kpis.csv", header + "\n" + rows.join("\n") + "\n" + overall, "text/csv");
}

function exportKPIPDF(){
  const disp = kpiDisp(INCIDS_ALL), oee = kpiOEE(disp);
  const rows = `
    <tr><td>MTTR</td><td style="text-align:right">${fmt(kpiMTTR(INCIDS_ALL))} h</td></tr>
    <tr><td>MTBF</td><td style="text-align:right">${fmt(kpiMTBF(INCIDS_ALL))} h</td></tr>
    <tr><td>Disponibilidad</td><td style="text-align:right">${fmt(disp*100)} %</td></tr>
    <tr><td>OEE (estimado)</td><td style="text-align:right">${fmt(oee*100)} %</td></tr>`;
  openPrintDoc("KPIs", `<h1>KPIs</h1><table><tbody>${rows}</tbody></table>
  <p class="mt">* OEE estimado: disponibilidad √ó rendimiento 0.9 √ó calidad 0.98</p>`);
}

/* ========== √ìRDENES DE TRABAJO: alta + export PDF ========== */
async function addOT(){
  if (!canEdit()){ alert("Inicia sesi√≥n para crear OT."); return; }
  const equipo   = (byId("otEquipo")?.value || "").trim();
  const prioridad= (byId("otPri")?.value || "").trim();
  const titulo   = (byId("otTitulo")?.value || "").trim();
  const asignado = (byId("otAsign")?.value || "").trim();
  const vencimiento = (byId("otDue")?.value || "").trim();
  const adjunto  = (byId("otAdj")?.value || "").trim();
  const desc     = (byId("otDesc")?.value || "").trim();

  if (!equipo || !titulo){ alert("Equipo y t√≠tulo son obligatorios."); return; }

  try{
    const r = await apiPost({res:"ot", fn:"add", item:{equipo, prioridad, titulo, asignado, vencimiento, adjunto, desc}, actor: currentUser.user});
    if (!r?.ok) throw new Error("No guardado");
    toast("OT creada");
    ["otTitulo","otAsign","otDue","otAdj","otDesc"].forEach(id => { const el=byId(id); if(el) el.value=""; });
    await loadOT();
  }catch(e){
    console.error(e); alert("Error al crear la OT.");
  }
}

function exportOTPDF(){
  let arr = [...(OTS||[])].sort((a,b)=> new Date(b.created) - new Date(a.created));
  if (!arr.length){ alert("No hay OT para exportar."); return; }
  const rows = arr.map(o=>`
    <tr>
      <td>${esc(fmtDate(o.created))}</td>
      <td><b>${esc(o.titulo||"")}</b><div style="font-size:11px;color:#555">${esc(o.equipo||"")}</div></td>
      <td>${esc(o.prioridad||"")}</td>
      <td>${esc(o.asignado||"")}</td>
      <td>${esc(o.vencimiento||"")}</td>
      <td>${esc(o.estado||"")}</td>
    </tr>`).join("");
  openPrintDoc("√ìrdenes de trabajo", `
    <h1>√ìrdenes de trabajo</h1>
    <table>
      <thead><tr><th>Fecha</th><th>OT</th><th>Prioridad</th><th>Asignado</th><th>Vence</th><th>Estado</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`);
}

/* Parada prolongada: email preformateado */
function accionParadaProlongada(name){
  const subj = encodeURIComponent("Aviso: Parada prolongada ‚Äî " + name);
  const body = encodeURIComponent(`Equipo: ${name}\nHora: ${new Date().toLocaleString("es-ES")}\nMotivo: \nAcci√≥n tomada: \nNecesidades: `);
  location.href = `mailto:?subject=${subj}&body=${body}`;
}

/* Imprimir QR de un contenedor existente */
function printQR(containerId, title){
  const c = byId(containerId);
  if (!c){ alert("No se encontr√≥ el QR."); return; }
  const img = c.querySelector("img,canvas");
  let dataURL = "";
  try{
    if (img && img.tagName === "IMG") dataURL = img.src;
    else if (img && img.tagName === "CANVAS") dataURL = img.toDataURL("image/png");
  }catch(_){}
  const w = openPopupSafe(title || "QR");
  if (!w) return;
  w.document.write(`<!doctype html><meta charset="utf-8"><title>${esc(title||"QR")}</title>
  <style>body{margin:20px;font-family:Inter,system-ui,sans-serif;text-align:center}</style>
  ${dataURL ? `<img src="${dataURL}" width="200" height="200">` : c.outerHTML}
  <div class="no-print" style="margin-top:12px"><button onclick="print()">Imprimir</button></div>`);
  w.document.close();
}

/* Etiquetas QR (selecci√≥n visible) */
function exportInvQRLabels(){
  const refs = [...QR_SEL]; if (!refs.length){ alert("No hay referencias seleccionadas."); return; }
  const w = openPopupSafe("Etiquetas QR inventario"); if (!w) return;
  const body = `
    <h1 style="font:700 18px Inter,system-ui,sans-serif;margin:12px 0">Etiquetas QR ‚Äî Inventario</h1>
    <div id="qrs" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px"></div>
    <div class="no-print" style="margin-top:12px"><button onclick="print()">Imprimir</button></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>
    <script>
      const base = ${JSON.stringify(baseURL())};
      const refs = ${JSON.stringify(refs)};
      const host = document.getElementById('qrs');
      refs.forEach(r=>{
        const code = encodeURIComponent(String(r).toUpperCase());
        const url = base + '#/repuesto/' + code;
        const card = document.createElement('div');
        card.style.cssText='border:1px solid #ddd;border-radius:12px;padding:10px;text-align:center';
        const box = document.createElement('div'); box.style.cssText='width:130px;height:130px;margin:0 auto 8px';
        const lab = document.createElement('div'); lab.style.cssText='font:800 14px Inter,system-ui,sans-serif';
        lab.textContent = String(r).toUpperCase();
        card.appendChild(box); card.appendChild(lab); host.appendChild(card);
        new QRCode(box,{ text:url, width:128, height:128, correctLevel:QRCode.CorrectLevel.M });
      });
    <\/script>`;
  w.document.write(`<!doctype html><meta charset="utf-8"><title>Etiquetas QR</title>${body}`);
  w.document.close();
}

/* ========== TOAST + HEADER + PASSWORD TOGGLE ========== */
let TOAST_TIMER=null;
function toast(msg){
  let t = byId("toast");
  if (!t){
    t = document.createElement("div");
    t.id = "toast";
    t.className = "toast";
    t.setAttribute("role","status");
    t.setAttribute("aria-live","polite");
    t.setAttribute("aria-atomic","true");
    document.body.appendChild(t);
  }
  t.textContent = msg;
  t.style.opacity = "1";
  clearTimeout(TOAST_TIMER);
  TOAST_TIMER = setTimeout(()=>{ t.style.opacity = "0"; }, 2200);
}
function bindHeaderShadow(){
  const hdr = document.querySelector("header");
  const onScroll = ()=>{ if (window.scrollY > 2) hdr.classList.add("scrolled"); else hdr.classList.remove("scrolled"); };
  onScroll(); window.addEventListener("scroll", onScroll, { passive:true });
}
function bindPwToggles(){
  document.querySelectorAll(".pw-toggle").forEach(btn=>{
    const targetId = btn.getAttribute("data-target");
    btn.addEventListener("click", ()=>{
      const inp = byId(targetId); if (!inp) return;
      const on = inp.type === "password"; inp.type = on ? "text" : "password";
      btn.classList.toggle("on", on);
      btn.setAttribute("aria-pressed", on ? "true" : "false");
    });
  });
}

/* ========== ROUTER (hash) ========== */
function handleHash(){
  const h = location.hash || "";
  const mEq = h.match(/^#\/equipo\/([^/?#]+)/);
  const mRp = h.match(/^#\/repuesto\/([^/?#]+)/);
  if (mEq){ renderEquipoBySlug(decodeURIComponent(mEq[1])); return; }
  if (mRp){ renderRepuestoByRef(mRp[1]); return; }
  // default: volver a la p√°gina actual
  ensureSectionsHidden();
  byId("page-" + (CURRENT_PAGE || "equipos")).classList.remove("hidden");
}

/* ========== LISTENERS DE ALTURA HEADER (usa la funci√≥n ya definida) ========== */
window.addEventListener('load', syncHeaderHeightVar);
window.addEventListener('resize', syncHeaderHeightVar);
window.addEventListener('orientationchange', syncHeaderHeightVar);
if (document.fonts && document.fonts.ready) document.fonts.ready.then(syncHeaderHeightVar);

/* ========== INSTALACI√ìN PWA (prompt discreto) ========== */
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  // bot√≥n discreto de ‚ÄúInstalar‚Äù
  let btn = byId('pwaInstallBtn');
  if (!btn){
    btn = document.createElement('button');
    btn.id = 'pwaInstallBtn';
    btn.className = 'btn gloss';
    btn.style.cssText = 'position:fixed;right:12px;bottom:12px;z-index:2500';
    btn.textContent = 'Instalar app';
    btn.addEventListener('click', async ()=>{
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      btn.remove();
      toast('Gracias por instalar CDL');
    });
    document.body.appendChild(btn);
  }
});

/* ========== INIT ========= */
window.addEventListener("load", async ()=>{
  bindHeaderShadow();
  bindPwToggles();
  applyRoleUI();

  // datos iniciales en paralelo
  await Promise.allSettled([loadState(), loadIncid(), loadOT(), loadInv()]);

  // p√°gina por defecto
  nav("equipos");

  // router
  window.addEventListener("hashchange", handleHash);
  handleHash();
  // Acceso r√°pido con "/"
  document.addEventListener("keydown", (e)=>{
    if (e.key === "/" && !/input|textarea|select/i.test(document.activeElement.tagName)){
      const f = byId("filtroIncid") || byId("invSearch");
      if (f){ e.preventDefault(); f.focus(); }
    }
  });
});

(function(){
  if (!('serviceWorker' in navigator)) return;

  // Helper para avisar
  function notify(msg){
    if (typeof window.toast === 'function') toast(msg);
    else alert(msg);
  }

  // Al cambiar el controlador (nuevo SW activo), recarga una sola vez
  let hasRefreshed = false;
  navigator.serviceWorker.addEventListener('controllerchange', ()=>{
    if (hasRefreshed) return;
    hasRefreshed = true;
    location.reload();
  });

  // Registro + flujo de actualizaci√≥n
  window.addEventListener('load', async ()=>{
    try{
      const reg = await navigator.serviceWorker.register('/sw.js', { updateViaCache:'none' });

      // Si hay un SW esperando, p√≠dele activarse ya
      if (reg.waiting) {
        reg.waiting.postMessage({ type:'SKIP_WAITING' });
        notify('Actualizaci√≥n lista. Aplicando‚Ä¶');
      }

      reg.addEventListener('updatefound', ()=>{
        const nw = reg.installing;
        if (!nw) return;
        nw.addEventListener('statechange', ()=>{
          if (nw.state === 'installed') {
            // Si ya tenemos controlador, es una actualizaci√≥n
            if (navigator.serviceWorker.controller) {
              if (reg.waiting) reg.waiting.postMessage({ type:'SKIP_WAITING' });
              notify('Actualizaci√≥n lista. Aplicando‚Ä¶');
            }
          }
        });
      });

      // Opci√≥n: comprobar de vez en cuando
      setInterval(()=> reg.update().catch(()=>{}), 60*1000);
    }catch(e){
      console.error('SW register error', e);
    }
  });
})();
/* === Hotfix iOS: limpia atributos height/width en canvas y cierra men√∫s colgados === */
window.addEventListener('load', function(){
  // 1) Elimina height/width en los canvas para que solo mande el CSS
  document.querySelectorAll('#chartMttr,#chartMtbf,#chartDisp,#chartOee').forEach(cv=>{
    cv.removeAttribute('height');
    cv.removeAttribute('width');
  });
  // 2) Si alg√∫n men√∫ qued√≥ abierto por zoom/resize de iOS, ci√©rralo
  if (typeof closeAllMenus === 'function') closeAllMenus();
});
</script>
<!-- ====== /JS UNIFICADO ====== -->

</body>
</html>