<!-- ===================== BLOQUE 1: HEAD + TEMA BASE ===================== -->
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="format-detection" content="telephone=no">
<title>CDL · CMMS</title>

<!-- Fuente -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<!-- PWA / iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CDL · CMMS">
<meta name="theme-color" content="#0d1117">

<!-- Iconos -->
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="/icon-32.png">
<link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=3">
<link rel="manifest" href="/manifest.webmanifest?v=2">

<style>
/* ====== Tema metalizado oscuro (único) ====== */
:root{
  --brand1:#A60000; --brand2:#E43B3B;
  --ok:#16a34a; --warn:#f59e0b; --stop:#dc2626;
  --ink:#e5e7eb; --muted:#9aa4b2; --line:#1f2937;
  --panel:#0d1117; --panelAlt:#141a22;
  --safe-top: env(safe-area-inset-top,0px);
  --safe-bottom: env(safe-area-inset-bottom,0px);
  --hdr-h: 72px;
}
*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  color:var(--ink); background:#0b0f15; -webkit-text-size-adjust:100%;
  padding-top:var(--safe-top); padding-bottom:var(--safe-bottom);
}
.hidden{ display:none !important; }
img,canvas,svg,video{ max-width:100%; height:auto; }
.nowrap{ white-space:nowrap; }

/* Botones metalizados */
.btn, .page-btn{
  border:1px solid #2a2f38; color:#fff;
  background:linear-gradient(180deg,#3b3f46 0%, #1a1e24 48%, #0e1217 100%);
  box-shadow:inset 0 1px 0 rgba(255,255,255,.18), 0 8px 18px rgba(0,0,0,.35);
  border-radius:999px; padding:.46rem .9rem; font-weight:800; letter-spacing:.02em; cursor:pointer;
}
.btn:hover,.page-btn:hover{ filter:brightness(1.06); }
.btn:active,.page-btn:active{ transform:translateY(1px); }
.btn.gloss{
  padding:.34rem .62rem; border:1px solid #2a2f38;
  background:linear-gradient(180deg,#2b2f35,#10141a); box-shadow:inset 0 1px 0 rgba(255,255,255,.12),0 8px 18px rgba(0,0,0,.35);
}
.btn.gloss.btn-mail{
  color:#fff!important; background:linear-gradient(180deg,#ff5a5a,#c10f0f)!important; border-color:#9f0c0c!important;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.35),0 8px 18px rgba(178,15,15,.25)!important;
}
.btn.gloss.btn-ficha{ background:linear-gradient(180deg,#111,#222)!important; color:#fff!important; border-color:#000!important; }
.btn-sema.ok{   background:linear-gradient(180deg,#38d46d 0%, #14853a 48%, #0d5f29 100%); border-color:#0b5a2a; }
.btn-sema.warn{ background:linear-gradient(180deg,#ffd56a 0%, #de930f 48%, #8b5b07 100%); border-color:#7b4c05; color:#111; }
.btn-sema.stop{ background:linear-gradient(180deg,#ff6868 0%, #c31313 48%, #820a0a 100%); border-color:#6f0808; text-shadow:0 1px 0 rgba(0,0,0,.25); }
.btn-dark{  background:linear-gradient(180deg,#2b2f35 0%, #10141a 100%); border-color:#252a31; }
.btn-ghost{ background:linear-gradient(180deg,#1c2026 0%, #0a0d11 100%); border-color:#2a3038; }

/* Píldoras / badges */
.badge, .rolechip, #status-strip span, #legend-equipos span{
  background:linear-gradient(180deg,#2c3036 0%, #14181f 100%);
  color:#fff; border:1px solid #2b313a; box-shadow: inset 0 1px 0 rgba(255,255,255,.12);
}
.dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }
.dot-stop{ background:var(--stop); } .dot-warn{ background:var(--warn); } .dot-ok{ background:var(--ok); }

/* Layout */
main{ max-width:1200px; margin:0 auto; padding:.8rem .8rem 1.2rem; }
.card{ background:linear-gradient(180deg,#0f141b,#0b1016); border:1px solid #1c2430; border-radius:12px; padding:.75rem .9rem; margin:.5rem 0; }
.in-txt, input[type="date"], select{
  height:36px; padding:.35rem .55rem; border-radius:10px; border:1px solid #2a2f38; background:#0a0f14; color:#e5e7eb;
}
table{ width:100%; border-collapse:collapse; background:transparent; border:1px solid var(--line); border-radius:12px; overflow:hidden; }
thead th{ background:#0e141b; color:#e7eaef; border-bottom:1px solid #1f2937; text-align:left; font-weight:800; padding:.55rem .6rem; }
tbody td{ border-top:1px solid #151b22; padding:.5rem .6rem; }

/* Header metalizado */
header{
  position:sticky; top:0; z-index:2000;
  background:linear-gradient(180deg,#0f141b,#0b1016);
  border-bottom:1px solid #1f2937;
  background-image:url('logo_mantenimiento.png');
  background-repeat:no-repeat; background-position:center top; background-size:min(560px,92vw) auto; padding-top:4px;
}
header.scrolled{ box-shadow:0 6px 22px rgba(0,0,0,.45); }
header .nav{ min-height:64px; display:flex; align-items:center; justify-content:center; position:relative; padding:.35rem .6rem; }
.hero-title{ display:flex; align-items:center; justify-content:center; }
.hero-title .hero-row{ display:flex; align-items:center; gap:10px; white-space:nowrap; }
.hero-title .hero-panel{ font-weight:900; letter-spacing:.04em; color:#f3f4f6; }
.hero-logo-cdl{ height:22px; width:auto; display:inline-block; }
.rolechip{
  position:absolute; right:56px; top:6px; font-size:.92rem; font-weight:800; color:#e5e7eb;
  background:transparent; border:0; padding:0;
}
.menu button#pagesBtn,
.menu button#userBtn{
  position:absolute; top:10px; width:36px; height:36px; border-radius:8px;
  border:1px solid #2a2f38; color:#fff; background:linear-gradient(180deg,#1c2026,#0a0d11); cursor:pointer; display:grid; place-items:center;
}
.menu button#pagesBtn{ left:10px; } .menu button#userBtn{ right:10px; }

/* Panel menú */
.panel{
  position:absolute; top:56px; left:10px;
  background:linear-gradient(180deg,#131a24,#0b1117); color:#e5e7eb;
  border:1px solid var(--line); border-radius:14px; box-shadow:0 24px 60px rgba(0,0,0,.45);
  padding:.6rem; z-index:2100; max-height:calc(100vh - 80px); overflow:auto;
}
.menu-user .panel{ right:10px; left:auto; width:280px; }
.menu-pages .panel{ width:280px; }
.panel .row{ display:flex; flex-direction:column; gap:.5rem; }
.panel .actions{ display:flex; flex-direction:column; gap:.35rem; }

/* Menú fullscreen en móvil */
html.menu-open,body.menu-open{ overflow:hidden; }
.panel.menu-full{
  position:fixed !important; z-index:2400 !important;
  inset: calc(var(--safe-top) + var(--hdr-h)) 0 var(--safe-bottom) 0 !important;
  background:linear-gradient(180deg,#0f141b,#0b1116) !important;
}
.panel.menu-full::before{
  content:""; position:absolute; inset:0;
  background: radial-gradient(1200px 600px at 50% -10%, rgba(0,0,0,.25), transparent 60%);
  pointer-events:none;
}
#pagesPanel.menu-full .actions{
  width:min(560px,92vw); margin:0 auto !important; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:0; height:100%;
}

/* TV 4 paneles */
.tv-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px; }
.tv-card{ background:linear-gradient(180deg,#0f141b,#0b1016); border:1px solid #1c2430; border-radius:14px; padding:.8rem; }
.tv-card h3{ margin:.1rem 0 .5rem; font-size:1rem; font-weight:900; letter-spacing:.04em; color:var(--ink); text-transform:uppercase; }
.tv-list{ display:flex; flex-direction:column; gap:.4rem; }
.tv-item{ padding:.45rem .6rem; border-radius:10px; border:1px solid #1f2937; background:#0b1016; font-weight:700; color:#e5e7eb; }
.tv-empty{ opacity:.55; font-style:italic; }

/* Password eye */
.pw-toggle{
  width:32px; height:32px; border-radius:8px; border:1px solid #2a2f38; background:#0b1016; cursor:pointer;
  background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%236b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>');
  background-repeat:no-repeat; background-position:center;
}
.pw-toggle.on{
  background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%23ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8a19.77 19.77 0 0 1 5.06-5.94M9.9 4.24A10.94 10.94 0 0 1 12 4c7 0 11 8 11 8a19.8 19.8 0 0 1-4.22 5.02M1 1l22 22"/><path d="M14.12 14.12A3 3 0 0 1 9.88 9.88"/></svg>');
}

/* Responsivo */
@media (max-width: 420px){ .hero-logo-cdl{ height:18px; } }
</style>
</head>

<!-- ===================== BLOQUE 2: BODY + ACCESIBILIDAD + CABECERA ===================== -->
<body>
<!-- Enlace accesible para saltar al contenido -->
<a href="#page-tv" style="position:absolute;left:-9999px;top:auto;z-index:9999;background:#111;color:#fff;padding:8px;border-radius:8px">Saltar al contenido</a>

<header>
  <div class="nav" id="navBar">
    <!-- Menú (hamburguesa) -->
    <div class="menu menu-pages">
      <button id="pagesBtn" aria-label="Menú" aria-expanded="false" aria-controls="pagesPanel">☰</button>
      <div id="pagesPanel" class="panel hidden" aria-label="Menú principal" style="min-width:260px">
        <div class="row">
          <div class="actions">
            <button class="btn" data-nav="equipos">Equipos</button>
            <button class="btn" data-nav="gruas">Puentes Grúa</button>
            <button class="btn" data-nav="otros">Otros</button>
            <button class="btn" data-nav="incidencias">Incidencias</button>
            <button class="btn" data-nav="indicadores">Indicadores</button>
            <button class="btn" data-nav="ot">OT</button>
            <button class="btn" data-nav="inventario">Inventario</button>
            <button class="btn" data-nav="repuestos">Repuestos solicitados</button>
            <button class="btn" data-nav="consumibles">Consumibles</button>
            <button class="btn" data-nav="tv">Dashboard TV</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Título centrado (logo + texto en una línea) -->
    <div class="hero-title">
      <div class="hero-row">
        <img src="logo-cdl.png" alt="CDL" class="hero-logo-cdl">
        <span class="hero-panel">PANEL DE CONTROL</span>
      </div>
    </div>

    <!-- Chip de rol y menú usuario -->
    <span id="roleChip" class="rolechip" aria-label="Rol actual">Invitado</span>
    <div class="menu menu-user">
      <button id="userBtn" aria-label="Usuario" aria-expanded="false" aria-controls="userPanel">⋮</button>
      <div id="userPanel" class="panel hidden" aria-label="Panel de usuario">
        <div class="row">
          <label class="small">Usuario</label>
          <select id="userSelect">
            <option value="invitado">Invitado</option>
            <option value="admin">Administrador</option>
            <option value="gerente">Gerente</option>
            <option value="encargado">Encargado</option>
            <option value="produccion">Producción</option>
            <option value="rt11">RT1.1</option>
            <option value="rt12">RT1.2</option>
            <option value="rt21">RT2.1</option>
            <option value="rt22">RT2.2</option>
            <option value="rt31">RT3.1</option>
            <option value="rt32">RT3.2</option>
            <option value="tcoint">Tco.INT</option>
            <option value="subc">Subcontrata</option>
          </select>

          <label class="small" style="margin-top:.4rem">Contraseña</label>
          <div class="pw" style="display:flex;gap:.4rem;align-items:center">
            <input id="userPass" type="password" placeholder="••••••••" style="flex:1">
            <button type="button" class="pw-toggle" data-target="userPass" aria-label="Mostrar contraseña" aria-pressed="false"></button>
          </div>

          <div class="actions" style="margin-top:.6rem;display:flex;gap:.4rem;flex-wrap:wrap">
            <button class="btn gloss" onclick="login()">Entrar</button>
            <button class="btn gloss" onclick="logout()">Salir</button>
          </div>
        </div>

        <div class="row" style="margin-top:.8rem">
          <label class="small">Cambiar contraseña</label>
          <div class="pw" style="display:flex;gap:.4rem;align-items:center">
            <input id="oldPass" type="password" placeholder="Actual" style="flex:1">
            <button type="button" class="pw-toggle" data-target="oldPass" aria-label="Mostrar contraseña" aria-pressed="false"></button>
          </div>
          <div class="pw" style="margin-top:.4rem;display:flex;gap:.4rem;align-items:center">
            <input id="newPass" type="password" placeholder="Nueva" style="flex:1">
            <button type="button" class="pw-toggle" data-target="newPass" aria-label="Mostrar contraseña" aria-pressed="false"></button>
          </div>
          <div class="actions" style="margin-top:.6rem">
            <button class="btn gloss" onclick="changePwd()">Cambiar</button>
          </div>
          <div id="pwdMsg" class="small" style="margin-top:.4rem;color:#374151"></div>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- ===================== BLOQUE 3: MAIN + SECCIONES BASE ===================== -->
<main>
  <!-- Resumen -->
  <section id="status-strip">
    <div style="max-width:1200px;margin:0 auto;padding:.55rem .8rem;display:flex;gap:.8rem;align-items:center;flex-wrap:wrap">
      <div style="font-weight:900;letter-spacing:.02em">RESUMEN</div>
      <div style="display:flex;gap:.6rem;flex-wrap:wrap;align-items:center">
        <span id="sumStop" style="display:inline-flex;align-items:center;gap:.4rem;padding:.22rem .5rem;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:800">
          <span style="width:10px;height:10px;border-radius:50%;background:#dc2626;display:inline-block"></span>
          <span>Paradas:</span><b id="kStop">0</b>
        </span>
        <span id="sumWarn" style="display:inline-flex;align-items:center;gap:.4rem;padding:.22rem .5rem;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:800">
          <span style="width:10px;height:10px;border-radius:50%;background:#f59e0b;display:inline-block"></span>
          <span>Restricciones:</span><b id="kWarn">0</b>
        </span>
        <span id="sumOk" style="display:inline-flex;align-items:center;gap:.4rem;padding:.22rem .5rem;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:800">
          <span style="width:10px;height:10px;border-radius:50%;background:#16a34a;display:inline-block"></span>
          <span>En marcha:</span><b id="kOk">0</b>
        </span>
        <span id="sumAll" style="display:inline-flex;align-items:center;gap:.4rem;padding:.22rem .5rem;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:800">
          <span>Total:</span><b id="kAll">0</b>
        </span>
      </div>
      <div style="margin-left:auto;font-weight:700;color:#64748b">
        Última actualización: <span id="kUpdated">—</span>
      </div>
    </div>
  </section>

  <!-- Equipos -->
  <section id="page-equipos" class="">
    <h2 class="cdl-tag">Equipos</h2>
    <div class="brand-wrap">
      <img src="/linea-kaltenbach.png" alt="LÍNEA KALTENBACH"
           loading="lazy" decoding="async" fetchpriority="low"
           onerror="this.closest('.brand-wrap').classList.add('fallback'); this.remove();">
    </div>
    <div id="legend-equipos" style="display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;margin:.5rem 0">
      <span style="display:inline-flex;align-items:center;gap:.4rem">
        <span style="width:10px;height:10px;border-radius:50%;background:#dc2626;display:inline-block"></span>Parada
      </span>
      <span style="display:inline-flex;align-items:center;gap:.4rem">
        <span style="width:10px;height:10px;border-radius:50%;background:#f59e0b;display:inline-block"></span>Restricciones
      </span>
      <span style="display:inline-flex;align-items:center;gap:.4rem">
        <span style="width:10px;height:10px;border-radius:50%;background:#16a34a;display:inline-block"></span>En marcha
      </span>
    </div>
    <div id="equiposWrap"></div>
  </section>

  <!-- Otras páginas -->
  <section id="page-gruas" class="hidden"><h2 class="cdl-tag">Puentes Grúa</h2><div id="gruasWrap"></div></section>
  <section id="page-otros" class="hidden"><h2 class="cdl-tag">Otros (auxiliares)</h2><div id="otrosWrap"></div></section>
  <section id="page-equipo" class="hidden"><div id="equipoDetail"></div></section>
  <section id="page-repuesto" class="hidden"><div id="repuestoDetail"></div></section>
  <section id="page-inv" class="hidden"><h2 class="cdl-tag">Inventario</h2><div id="invWrap"></div></section>
  <section id="page-rep" class="hidden"><h2 class="cdl-tag">Repuestos solicitados</h2><div id="repWrap"></div></section>
  <section id="page-cons" class="hidden"><h2 class="cdl-tag">Consumibles recurrentes</h2><div id="consWrap"></div></section>
  <section id="page-ot" class="hidden"><h2 class="cdl-tag">Órdenes de trabajo</h2><div id="otWrap"></div></section>
  <section id="page-personal" class="hidden"><h2 class="cdl-tag">Personal</h2><div id="personalWrap"></div></section>
  <section id="page-logs" class="hidden"><h2 class="cdl-tag">Histórico de logs</h2><div id="logsWrap"></div></section>
  <section id="page-incidencias" class="hidden"><h2 class="cdl-tag">Incidencias</h2><div id="incidTableWrap"></div></section>

  <!-- Dashboard TV -->
  <section id="page-tv" class="">
    <h2 class="cdl-tag">Dashboard TV</h2>
    <div style="display:grid;grid-template-columns:1fr;gap:1rem;max-width:1100px;margin:0 auto">
      <div class="card">
        <h3>Paradas (recientes)</h3>
        <div id="tvParados" class="tv-list"></div>
      </div>
      <div class="card">
        <h3>Restricciones (recientes)</h3>
        <div id="tvRestr" class="tv-list"></div>
      </div>
      <div class="card">
        <h3>Repuestos críticos/urgentes</h3>
        <div id="tvRepuestos" class="tv-list"></div>
      </div>
      <div class="card">
        <h3>Paradas previstas por preventivos</h3>
        <div id="tvPrev" class="tv-list"></div>
      </div>
    </div>
  </section>
</main>
<!-- ===================== FIN BLOQUE 3 ===================== -->
<!-- ===================== BLOQUE 4: HELPERS + ESTADO DE USUARIO ===================== -->
<script>
/* =========================
   Helpers básicos y estado
   ========================= */
const byId = (id)=> document.getElementById(id);
const qs   = (sel)=> document.querySelector(sel);
const qsa  = (sel)=> [...document.querySelectorAll(sel)];
const esc = (str)=> String(str).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));

/* Estado de usuario persistido */
let USER = { user:"invitado", rol:"Invitado", group:"guest" };
function setUser(u){ USER=u; localStorage.setItem("CDL_USER",JSON.stringify(u)); applyRoleUI(); }
function getUser(){ try{return JSON.parse(localStorage.getItem("CDL_USER")||"{}");}catch(_){return USER;} }
USER = getUser() || USER;

function applyRoleUI(){
  qsa("[data-role]").forEach(el=>{
    const roles=(el.getAttribute("data-role")||"").split(",").map(s=>s.trim());
    if(roles.includes(USER.rol) || USER.rol==="Administrador"){ el.style.display=""; }
    else{ el.style.display="none"; }
  });
  const chip = byId("roleChip"); if (chip) chip.textContent = USER.rol || "Invitado";
}
</script>

<!-- ===================== BLOQUE 5: API + FETCH HELPERS + EXPORT ===================== -->
<script>
/* =========================
   Configuración de API
   ========================= */
(function(){
  if (!window.API_BASE){
    window.API_BASE = "https://script.google.com/macros/s/AKfycbzPxPJztSCo7dX-xmzYW_pBwkQne3aACe1EzzlNDsjr0nuRXZaOSOrRGzVrYZsN5cgF/exec";
  }
})();

/* =========================
   Fetch helpers (GET/POST)
   ========================= */
window.apiGet = async function(q){
  const u = new URL(window.API_BASE);
  Object.entries(q||{}).forEach(([k,v])=> u.searchParams.set(k, v));
  const r = await fetch(u.toString(), { credentials:"omit", cache:"no-cache" });
  return await r.json();
};
window.apiPost = async function(body){
  const r = await fetch(window.API_BASE, {
    method:"POST", headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body||{})
  });
  return await r.json();
};

/* =========================
   Export CSV / PDF
   ========================= */
window.csvEscape = function(v){ v=(v==null?'':String(v)); if (/[",\n;]/.test(v)) return `"${v.replace(/"/g,'""')}"`; return v; };
window.toCSV = (rows)=> (rows||[]).map(r=>(r||[]).map(window.csvEscape).join(";")).join("\n");
window.download = function(name, content, type="text/plain;charset=utf-8"){
  const blob=new Blob([content],{type}); const a=document.createElement("a");
  a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0);
};
window.exportCSVFromTable = function(tableSel, fileName){
  const table=document.querySelector(tableSel); if(!table) return;
  const rows=[...table.querySelectorAll("tr")].map(tr=>[...tr.children].map(td=>td.innerText.trim()));
  window.download(fileName, window.toCSV(rows), "text/csv;charset=utf-8");
};
window.printHTML = function(title, html){
  const w = window.open("", "_blank");
  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>${title}</title><style>
    body{font-family:Inter,system-ui,sans-serif;padding:16px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #ddd;padding:6px 8px}
    th{background:#f3f4f6}
  </style></head><body>${html}</body></html>`);
  w.document.close(); w.focus(); w.print();
};
</script>

<!-- ===================== BLOQUE 6: MENÚS + ROUTER + ARRANQUE ===================== -->
<script>
/* =========================
   Router simple de páginas
   ========================= */
const PAGE_ID = {
  equipos:"page-equipos", gruas:"page-gruas", otros:"page-otros",
  incidencias:"page-incidencias", indicadores:"page-indicadores",
  ot:"page-ot", inventario:"page-inv", repuestos:"page-rep",
  consumibles:"page-cons", tv:"page-tv", personal:"page-personal",
  logs:"page-logs", equipo:"page-equipo", repuesto:"page-repuesto"
};
function ensureSectionsHidden(){ qsa('[id^="page-"]').forEach(el=>el.classList.add("hidden")); }
function nav(page){
  const id = PAGE_ID[page] || PAGE_ID.equipos;
  ensureSectionsHidden();
  byId(id)?.classList.remove("hidden");
  try{ const h = "#/"+page; if(location.hash!==h) location.hash=h; }catch(_){}
}

/* =========================
   Menús + modo fullscreen
   ========================= */
(function(){
  const pagesBtn = byId("pagesBtn"), pagesPanel = byId("pagesPanel");
  const userBtn  = byId("userBtn") , userPanel  = byId("userPanel");

  function close(btn,panel){ if(!panel) return; panel.classList.add("hidden"); panel.classList.remove("menu-full");
    btn?.setAttribute("aria-expanded","false"); document.documentElement.classList.remove("menu-open"); document.body.classList.remove("menu-open"); }
  function closeAll(){ close(pagesBtn,pagesPanel); close(userBtn,userPanel); }
  window.closeAllMenus = closeAll;

  function open(btn,panel,fullscreen){
    closeAll(); if(!panel) return; panel.classList.remove("hidden");
    if(fullscreen && matchMedia("(max-width: 720px)").matches){
      panel.classList.add("menu-full"); document.documentElement.classList.add("menu-open"); document.body.classList.add("menu-open");
    } btn?.setAttribute("aria-expanded","true");
  }

  pagesBtn?.addEventListener("click",()=> pagesPanel.classList.contains("hidden") ? open(pagesBtn,pagesPanel,true) : close(pagesBtn,pagesPanel));
  userBtn ?.addEventListener("click",()=> userPanel .classList.contains("hidden") ? open(userBtn ,userPanel ,false) : close(userBtn ,userPanel ));
  document.addEventListener("click",(e)=>{ if(e.target.closest("#pagesPanel,#pagesBtn,#userPanel,#userBtn")) return; closeAll(); }, {passive:true});
  document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeAll(); }, {passive:true});
})();

/* =========================
   Arranque mínimo
   ========================= */
document.addEventListener("DOMContentLoaded", ()=>{
  applyRoleUI();
  if(!location.hash){ nav('tv'); } else {
    const p=(location.hash.replace(/^#\/?/,'')||'equipos');
    nav(p);
  }
});
</script>
<!-- ========= FIN de bloques 4, 5 y 6 ========= -->
<!-- ===================== BLOQUE 7: PULIDO UI (sombra header, timestamp, SW, QR) ===================== -->
<script>
/* ===== Cabecera con sombra al hacer scroll + sincroniza --hdr-h ===== */
(function(){
  const hdr = document.querySelector("header");
  const onScroll = ()=>{ if(window.scrollY>2) hdr?.classList.add("scrolled"); else hdr?.classList.remove("scrolled"); };
  const sync = ()=>{ const h = Math.max(64, hdr?.offsetHeight||0); document.documentElement.style.setProperty('--hdr-h', h+'px'); };
  onScroll();
  window.addEventListener("scroll", onScroll, {passive:true});
  window.addEventListener("resize", sync, {passive:true});
  window.addEventListener("orientationchange", sync, {passive:true});
  (document.fonts?.ready||Promise.resolve()).then(sync);
})();

/* ===== Sello de tiempo del resumen (cada 30s) ===== */
(function(){
  function updateSummaryTimestamp(){
    const el = document.getElementById("kUpdated");
    if (el) el.textContent = new Date().toLocaleString("es-ES",{hour12:false});
  }
  updateSummaryTimestamp();
  setInterval(updateSummaryTimestamp, 30_000);
})();

/* ===== Service Worker: auto-actualización (opcional) ===== */
(function(){
  if (!('serviceWorker' in navigator)) return;
  window.addEventListener('load', async () => {
    try{
      const reg = await navigator.serviceWorker.register('/sw.js', { updateViaCache:'none' });
      if (reg.waiting) reg.waiting.postMessage({ type:'SKIP_WAITING' });
      reg.addEventListener('updatefound', ()=>{
        const nw = reg.installing;
        nw && nw.addEventListener('statechange', ()=>{
          if (nw.state==='installed' && navigator.serviceWorker.controller){
            reg.waiting && reg.waiting.postMessage({ type:'SKIP_WAITING' });
          }
        });
      });
      navigator.serviceWorker.addEventListener('controllerchange', ()=> location.reload());
    }catch(e){ console.error('SW register error', e); }
  }, { once:true });
})();

/* ===== QRCode lazy loader ===== */
(function(){
  if (window.QRCode || document.querySelector('script[data-qrcode-lib]')) return;
  const s = document.createElement("script");
  s.src = "https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js";
  s.setAttribute("data-qrcode-lib","1");
  document.head.appendChild(s);
})();
</script>
<!-- ===================== BLOQUE 8: DATOS GLOBALES + CARGA (STATE/INCID/INV/REP/CONS/OT) ===================== -->
<script>
/* ===== Estado global ===== */
window.STATE = window.STATE || [];  // Equipos
window.INCID = window.INCID || [];  // Incidencias
window.INV   = window.INV   || [];  // Inventario
window.REP   = window.REP   || [];  // Repuestos solicitados
window.CONS  = window.CONS  || [];  // Consumibles
window.OTS   = window.OTS   || [];  // Órdenes de trabajo

/* ===== Utilidades locales ===== */
window.fmtDate = window.fmtDate || function(d){
  if(!d) return "";
  const dt = new Date(d); return isNaN(dt) ? String(d) : dt.toLocaleString("es-ES",{hour12:false});
};
window.slugify = window.slugify || (s=> String(s||"")
  .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
  .toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""));
window.baseURL = window.baseURL || (()=> (location.origin + location.pathname));
const badge = (color, txt)=> `<span style="display:inline-flex;align-items:center;gap:.35rem;padding:.18rem .48rem;border-radius:999px;border:1px solid #e5e7eb;background:#fff">
  <i style="width:10px;height:10px;border-radius:50%;background:${color};display:inline-block"></i><b>${esc(txt)}</b></span>`;

/* ===== CARGA: STATE ===== */
async function loadState(){
  try{
    const r = await apiGet({res:"state", fn:"list"});
    window.STATE = Array.isArray(r?.items) ? r.items : [];
    renderEquiposList?.();

    // KPIs resumen
    const nStop = STATE.filter(x=>x.estado==="Parada").length;
    const nWarn = STATE.filter(x=>x.estado==="Restricciones").length;
    const nOk   = STATE.filter(x=>x.estado==="En marcha").length;
    byId("kStop") && (byId("kStop").textContent = nStop);
    byId("kWarn") && (byId("kWarn").textContent = nWarn);
    byId("kOk")   && (byId("kOk").textContent   = nOk);
    byId("kAll")  && (byId("kAll").textContent  = STATE.length);

    renderTV?.();
  }catch(e){ console.error("loadState", e); }
}

/* ===== CARGA: INCIDENCIAS ===== */
async function loadIncid(){
  try{
    const r = await apiGet({res:"incid", fn:"list"});
    if (r?.ok && Array.isArray(r.items)){
      window.INCID = r.items;
      renderIncidenciasTable?.(r.items);
      renderTV?.();
    }
  }catch(e){ console.error("loadIncid", e); }
}

/* ===== CARGA: INVENTARIO ===== */
async function loadInv(){
  try{
    const r = await apiGet({res:"inv", fn:"list"});
    if (r?.ok && Array.isArray(r.items)){
      window.INV = r.items;
      renderInv?.(r.items);
    }
  }catch(e){ console.error("loadInv", e); }
}

/* ===== CARGA: REPUESTOS SOLICITADOS ===== */
async function loadRepSol(){
  try{
    const d = await apiGet({res:"rep", fn:"list"});
    window.REP = d?.ok && Array.isArray(d.items) ? d.items : [];
    renderRepTable?.();
    renderTV?.();
  }catch(e){ console.error("loadRepSol", e); }
}

/* ===== CARGA: CONSUMIBLES ===== */
async function loadConsumibles(){
  try{
    const d = await apiGet({res:"cons", fn:"list"});
    window.CONS = d?.ok ? (d.items||[]) : [];
    renderConsTable?.();
  }catch(e){ console.error("loadConsumibles", e); }
}

/* ===== CARGA: Órdenes de Trabajo ===== */
async function loadOT(){
  try{
    const d = await apiGet({res:"ot", fn:"list"});
    window.OTS = d?.ok ? (d.items||[]) : [];
    renderOTTable?.();
    renderTV?.();
  }catch(e){ console.error("loadOT", e); }
}

/* ===== Boot: carga inicial en paralelo ===== */
document.addEventListener("DOMContentLoaded", async ()=>{
  try{
    await Promise.all([ loadState(), loadIncid(), loadInv(), loadRepSol(), loadConsumibles(), loadOT() ]);
  }catch(e){ console.error("initialLoad", e); }
});
</script>
<!-- ===================== BLOQUE 9: RENDERIZADOS (equipos, incidencias, inv, rep, cons, OT) ===================== -->
<script>
/* ===== Equipos (listado con acciones) ===== */
function renderEquiposList(){
  const wrap = byId("equiposWrap"); if(!wrap) return;
  const items = window.STATE||[];
  if(!items.length){ wrap.innerHTML = `<div class="card">Sin datos</div>`; return; }

  const grupos = {};
  items.forEach(it=>{ (grupos[it.grupo]=grupos[it.grupo]||[]).push(it); });
  const cls = { "Parada":"#dc2626", "Restricciones":"#f59e0b", "En marcha":"#16a34a" };

  wrap.innerHTML = Object.entries(grupos).map(([g,arr])=>{
    const filas = arr.map(it=>{
      const c = cls[it.estado]||"#64748b";
      const slug = slugify(it.nombre);
      return `<div class="card" style="display:flex;align-items:center;gap:.6rem;justify-content:space-between">
        <div><b>${esc(it.nombre)}</b><div class="small" style="color:#64748b">${esc(g)}</div></div>
        <div>${badge(c, it.estado)}</div>
        <div style="display:flex;gap:.35rem;flex-wrap:wrap">
          <button class="btn gloss" onclick="location.hash='#/equipo/${encodeURIComponent(slug)}'">Ficha</button>
          <button class="btn gloss btn-mail" onclick="accionParadaProlongada(${JSON.stringify(it.nombre)})">Parada prolongada</button>
        </div>
      </div>`;
    }).join("");
    return `<div style="margin:.8rem 0"><h3 style="margin:.2rem 0 .6rem">${esc(g)}</h3>${filas}</div>`;
  }).join("");
}

/* ===== Incidencias: tabla + export ===== */
function renderIncidenciasTable(items){
  const wrap = byId("incidTableWrap"); if(!wrap) return;
  if (!items || !items.length){ wrap.innerHTML = `<div class="card">Sin incidencias</div>`; return; }
  wrap.innerHTML = `
    <div class="card" style="overflow:auto">
      <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-bottom:.5rem">
        <button id="btnExportIncidCSVTop" class="btn gloss">Exportar CSV</button>
        <button id="btnExportIncidPDFTop" class="btn gloss">Exportar PDF</button>
      </div>
      <table id="tblIncid">
        <thead><tr>
          <th>Equipo</th><th>Tipo</th><th>Descripción</th>
          <th>Inicio</th><th>Fin</th><th>Reportante</th>
        </tr></thead>
        <tbody>
          ${items.map(it=>`
            <tr>
              <td>${esc(it.equipo)}</td>
              <td>${esc(it.tipo||"")}</td>
              <td>${esc(it.desc||"")}</td>
              <td>${fmtDate(it.inicio)}</td>
              <td>${fmtDate(it.fin)}</td>
              <td>${esc(it.reportante||"")}</td>
            </tr>`).join("")}
        </tbody>
      </table>
      <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.5rem">
        <button id="btnExportIncidCSV" class="btn gloss">Exportar CSV</button>
        <button id="btnExportIncidPDF" class="btn gloss">Exportar PDF</button>
      </div>
    </div>`;

  const csv = ()=> exportCSVFromTable("#tblIncid","incidencias.csv");
  const pdf = ()=>{
    const t = byId("tblIncid"); if(!t) return;
    printHTML("Incidencias", `<h2>Incidencias</h2><table>${t.innerHTML}</table>`);
  };
  ["btnExportIncidCSVTop","btnExportIncidCSV"].forEach(id=> byId(id)?.addEventListener("click", csv, {once:false}));
  ["btnExportIncidPDFTop","btnExportIncidPDF"].forEach(id=> byId(id)?.addEventListener("click", pdf, {once:false}));
}

/* ===== Inventario: listado con botones ± ===== */
function renderInv(items){
  const wrap = byId("invWrap"); if (!wrap) return;
  if (!items || !items.length){ wrap.innerHTML = `<div class="card">Inventario vacío</div>`; return; }
  wrap.innerHTML = items.map(it=>`
    <div class="card">
      <div><b>${esc(it.nombre)}</b> <span style="opacity:.7">[${esc(it.ref)}]</span></div>
      <div>Stock: <b>${it.stock}</b> · Mínimo: <b>${it.minimo}</b></div>
      <div style="display:flex;gap:.25rem;flex-wrap:wrap;margin-top:.35rem">
        ${["+1","-1","+10","-10","+100","-100"].map(lbl=>{
          const d = (/^\+/.test(lbl)?1:-1)*parseInt(lbl.replace(/\D/g,"")||"0",10);
          return `<button class="btn" onclick="invDelta('${esc(it.ref)}',${d})">${lbl}</button>`;
        }).join("")}
        <button class="btn gloss" onclick="openRepuestoByRef('${esc(it.ref)}')">Ficha</button>
      </div>
    </div>
  `).join("");
}
async function invDelta(ref, delta){
  try{
    const r = await apiPost({res:"inv", fn:"delta", ref, delta, actor:(window.USER?.user||"anon")});
    if (r?.ok){ (window.toast||alert)(`Stock ${ref}: ${r.stock}`); loadInv(); }
  }catch(e){ console.error("invDelta", e); }
}

/* ===== Repuestos solicitados: tabla + acciones + export ===== */
function renderRepTable(){
  const host = byId("repWrap"); if (!host) return;
  if (!window.REP || !window.REP.length){ host.innerHTML = `<div class="card">Sin solicitudes</div>`; return; }

  const rows = window.REP.map(r=>`
    <tr data-id="${esc(r.id)}">
      <td class="nowrap">${esc(fmtDate(r.created||""))}</td>
      <td>${esc(r.id)}</td>
      <td>${esc(r.ref)}</td>
      <td><button class="btn gloss" onclick="openRepuestoByRef('${esc(r.ref)}')">${esc(r.nombre)}</button></td>
      <td>${esc(r.solicitante||"-")}</td>
      <td>
        <select class="repestado" data-id="${esc(r.id)}">
          ${["Pendiente","Aprobado","Denegado","Recibido"].map(s=>`<option ${s===(r.estado||"Pendiente")?'selected':''}>${s}</option>`).join("")}
        </select>
      </td>
      <td><input class="repcoment in-txt" data-id="${esc(r.id)}" value="${esc(r.comentario||"")}" placeholder="Comentario"></td>
      <td class="nowrap">
        <div style="margin-bottom:.35rem;display:flex;gap:.25rem;flex-wrap:wrap">
          ${["+1","-1","+10","-10","+100","-100"].map(lbl=>{
            const d = (/^\+/.test(lbl)?1:-1)*parseInt(lbl.replace(/\D/g,"")||"0",10);
            return `<button class="btn rep-delta" data-delta="${d}" data-ref="${esc(r.ref)}">${lbl}</button>`;
          }).join("")}
        </div>
        <button class="btn gloss rep-guardar" data-id="${esc(r.id)}">Guardar</button>
      </td>
    </tr>`).join("");

  host.innerHTML = `
    <div class="card" style="overflow:auto">
      <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-bottom:.5rem">
        <button id="btnExportRepCSV" class="btn gloss">Exportar CSV</button>
        <button id="btnExportRepPDF" class="btn gloss">Exportar PDF</button>
      </div>
      <table id="tblRep">
        <thead>
          <tr><th>Fecha</th><th>ID</th><th>Ref</th><th>Nombre</th><th>Solicitante</th><th>Estado</th><th>Comentario</th><th>Acciones</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;

  const tb = host.querySelector("tbody");

  tb.querySelectorAll(".rep-guardar").forEach(b=>{
    b.addEventListener("click", async (e)=>{
      const id = e.currentTarget.getAttribute("data-id");
      const estado = tb.querySelector(`.repestado[data-id="${CSS.escape(id)}"]`)?.value || "Pendiente";
      const comentario = tb.querySelector(`.repcoment[data-id="${CSS.escape(id)}"]`)?.value || "";
      try{
        const r = await apiPost({res:"rep", fn:"set", id, estado, comentario, actor:(USER?.user||"anon")});
        if (r?.ok){ (window.toast||console.log)("Guardado"); loadRepSol(); } else alert(r?.error||"No se pudo guardar");
      }catch(err){ console.error(err); alert("Error de red"); }
    });
  });

  tb.querySelectorAll(".rep-delta").forEach(b=>{
    b.addEventListener("click", async (e)=>{
      const ref   = e.currentTarget.getAttribute("data-ref");
      const delta = Number(e.currentTarget.getAttribute("data-delta"));
      try{
        const r = await apiPost({res:"inv", fn:"delta", ref, delta, actor:(USER?.user||"anon")});
        if (r?.ok){ (window.toast||console.log)(`Inventario ${ref}: ${r.stock}`); loadInv(); }
      }catch(err){ console.error(err); }
    });
  });

  byId("btnExportRepCSV")?.addEventListener("click", ()=>{
    const rows = (window.REP||[]).map(r=>[fmtDate(r.created||""), r.id, r.ref, r.nombre, r.solicitante||"", r.estado||"", r.comentario||""]);
    download("repuestos_solicitados.csv", toCSV([["Fecha","ID","Ref","Nombre","Solicitante","Estado","Comentario"]].concat(rows)), "text/csv;charset=utf-8");
  });
  byId("btnExportRepPDF")?.addEventListener("click", ()=>{
    const rows = (window.REP||[]).map(r=>`<tr><td>${esc(fmtDate(r.created||""))}</td><td>${esc(r.id)}</td><td>${esc(r.ref)}</td><td>${esc(r.nombre)}</td><td>${esc(r.solicitante||"")}</td><td>${esc(r.estado||"")}</td><td>${esc(r.comentario||"")}</td></tr>`).join("");
    printHTML("Repuestos solicitados", `<h2>Repuestos solicitados</h2><table><thead><tr><th>Fecha</th><th>ID</th><th>Ref</th><th>Nombre</th><th>Solicitante</th><th>Estado</th><th>Comentario</th></tr></thead><tbody>${rows}</tbody></table>`);
  });
}

/* ===== Consumibles: tabla con acciones ===== */
function renderConsTable(){
  const host = byId("consWrap"); if (!host) return;
  const CONS = window.CONS || [];
  if (!CONS.length){ host.innerHTML = `<div class="card">Sin consumibles</div>`; return; }
  const rows = CONS.map(c=>`
    <tr>
      <td>${esc(c.ref)}</td>
      <td>${esc(c.nombre)}</td>
      <td class="num">${c.stock}</td>
      <td class="num">${c.minimo}</td>
      <td>${c.updated ? esc(fmtDate(c.updated)) : ""}</td>
      <td class="nowrap">
        ${["+1","-1","+10","-10","+100","-100"].map(lbl=>{
          const d = (/^\+/.test(lbl)?1:-1)*parseInt(lbl.replace(/\D/g,"")||"0",10);
          return `<button class="btn cons-delta" data-delta="${d}" data-ref="${esc(c.ref)}">${lbl}</button>`;
        }).join("")}
      </td>
    </tr>
  `).join("");
  host.innerHTML = `
    <div class="card" style="overflow:auto">
      <table id="tblCons">
        <thead>
          <tr><th>Ref</th><th>Nombre</th><th>Stock</th><th>Mínimo</th><th>Actualizado</th><th>Acciones</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;

  host.querySelectorAll("button.cons-delta").forEach(b=>{
    b.addEventListener("click", async (e)=>{
      const ref   = e.currentTarget.getAttribute("data-ref");
      const delta = Number(e.currentTarget.getAttribute("data-delta"));
      try{
        const r = await apiPost({res:"cons", fn:"delta", ref, delta, actor:(window.USER?.user||"anon")});
        if (r?.ok){ (window.toast||console.log)(`Stock ${ref}: ${r.stock}`); loadConsumibles(); }
      }catch(err){ console.error(err); }
    });
  });
}

/* ===== Órdenes de trabajo ===== */
function renderOTTable(){
  const host = byId("otWrap"); if (!host) return;
  const OTS = window.OTS||[];
  if (!OTS.length){ host.innerHTML = `<div class="card">Sin OT</div>`; return; }
  const rows = OTS.map(o=>`
    <tr>
      <td>${esc(fmtDate(o.created||""))}</td>
      <td>${esc(o.id)}</td>
      <td>${esc(o.prioridad||"")}</td>
      <td>${esc(o.asignado||"")}</td>
      <td>${esc(o.vencimiento||"")}</td>
      <td>${esc(o.estado||"")}</td>
    </tr>
  `).join("");
  host.innerHTML = `
    <div class="card" style="overflow:auto">
      <table id="tblOT">
        <thead>
          <tr><th>Fecha</th><th>OT</th><th>Prioridad</th><th>Asignado</th><th>Vence</th><th>Estado</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.5rem">
        <button id="btnExportOTPDF" class="btn gloss">Exportar PDF</button>
      </div>
    </div>`;
  byId("btnExportOTPDF")?.addEventListener("click", ()=>{
    const t = byId("tblOT"); if(!t) return;
    printHTML("Órdenes de trabajo", `<h2>Órdenes de trabajo</h2><table>${t.innerHTML}</table>`);
  });
}

/* ===== Acciones varias (fichas + email fallback) ===== */
function openRepuestoByRef(ref){
  const slug = encodeURIComponent(ref);
  location.hash = `#/repuesto/${slug}`;
  renderRepuestoByRef?.(ref);
}
function renderEquipoBySlug(slug){
  qsa('[id^="page-"]').forEach(el=>el.classList.add("hidden"));
  byId("page-equipo")?.classList.remove("hidden");
  const eq = (window.STATE||[]).find(x => slugify(x.nombre) === slug);
  const host = byId("equipoDetail");
  if (!host || !eq){ if (host) host.innerHTML="<div class='card'>No encontrado</div>"; return; }
  host.innerHTML = `
    <div class="card">
      <h3 style="margin:.1rem 0">${esc(eq.nombre)}</h3>
      <div class="sub">${esc(eq.grupo)}</div>
      <div style="margin:.5rem 0">Estado actual: <b>${esc(eq.estado)}</b></div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn gloss btn-mail" onclick="accionParadaProlongada(${JSON.stringify(eq.nombre)})">Parada prolongada (email)</button>
        <button class="btn gloss" onclick="window.print()">Imprimir ficha</button>
        <button class="btn gloss" onclick="history.back()">Volver</button>
      </div>
      <div style="margin-top:.6rem"><div id="qrficha"></div></div>
    </div>`;
  if (byId("qrficha") && window.QRCode){
    new QRCode(byId("qrficha"), { text: `${baseURL()}#/equipo/${slug}`, width:96, height:96 });
  }
}
function renderRepuestoByRef(ref){
  qsa('[id^="page-"]').forEach(el=> el.classList.add("hidden"));
  byId("page-repuesto")?.classList.remove("hidden");
  const it = (window.INV||[]).find(x => String(x.ref).toUpperCase() === String(ref).toUpperCase());
  const host = byId("repuestoDetail");
  if (!host || !it){ if (host) host.innerHTML="<div class='card'>No encontrado</div>"; return; }
  host.innerHTML = `
    <div class="card">
      <h3 style="margin:.1rem 0">${esc(it.nombre)}</h3>
      <div class="sub">Ref: <b>${esc(it.ref)}</b></div>
      <div style="margin:.5rem 0">Stock: <b>${it.stock}</b> · Mínimo: <b>${it.minimo}</b></div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn gloss" onclick="window.print()">Imprimir etiqueta</button>
        <button class="btn gloss" onclick="history.back()">Volver</button>
      </div>
      <div style="margin-top:.6rem"><div id="qrrep"></div></div>
    </div>`;
  if (byId("qrrep") && window.QRCode){
    new QRCode(byId("qrrep"), { text: `${baseURL()}#/repuesto/${encodeURIComponent(it.ref)}`, width:96, height:96 });
  }
}
/* ===== Acción: Parada prolongada (API → fallback mailto) ===== */
async function accionParadaProlongada(equipo){
  try{
    const actor = (window.USER?.user)||"anon";
    const r = await apiPost({res:"mail", fn:"parada_prolongada", equipo, actor});
    if (r?.ok){ (window.toast||console.log)("Aviso enviado"); return; }
    throw new Error("mail api not ok");
  }catch(_){
    const subj = encodeURIComponent(`[CDL] Parada prolongada — ${equipo}`);
    const body = encodeURIComponent(`Equipo: ${equipo}\nFecha: ${new Date().toLocaleString("es-ES",{hour12:false})}\n\nDetalle: ...`);
    location.href = `mailto:?subject=${subj}&body=${body}`;
  }
}
</script>
<!-- ===================== BLOQUE 10: DASHBOARD TV (4 paneles + refresco) ===================== -->
<script>
(function(){
  if (window.__CDL_TV4__) return; window.__CDL_TV4__=true;

  function ensureTVHost(){
    const sec = document.getElementById("page-tv"); if(!sec) return null;
    if (!sec.__tv4__){
      sec.innerHTML = `
        <h2 class="cdl-tag">Dashboard TV</h2>
        <div class="tv-grid" id="tvGrid">
          <article class="tv-card"><h3><span class="badge"><span class="dot dot-stop"></span> PARADAS</span></h3><div id="tvParadas" class="tv-list"></div></article>
          <article class="tv-card"><h3><span class="badge"><span class="dot dot-warn"></span> RESTRICCIONES</span></h3><div id="tvRestr" class="tv-list"></div></article>
          <article class="tv-card"><h3><span class="badge">REPUESTOS · URGENCIA</span></h3><div id="tvRep" class="tv-list"></div></article>
          <article class="tv-card"><h3><span class="badge">PARADAS PREVISTAS (OT)</span></h3><div id="tvPrev" class="tv-list"></div></article>
        </div>`;
      sec.__tv4__ = true;
    }
    return sec;
  }

  function fmtDia(d){ try{ return d ? new Date(d).toLocaleDateString("es-ES",{hour12:false}) : "—"; }catch(_){ return d||"—"; } }
  function fillList(id, arr){
    const host = document.getElementById(id); if(!host) return;
    host.innerHTML = (arr.length
      ? arr.map(t=>`<div class="tv-item">${t}</div>`).join("")
      : `<div class="tv-item tv-empty">—</div>`);
  }

  window.renderTV = window.renderTV || function(){
    if (!ensureTVHost()) return;
    const STATE = (window.STATE||[]);
    const REP   = (window.REP||[]);
    const OTS   = (window.OTS||[]);
    const INC   = (window.INCID||[]);

    // A) PARADAS (estado actual + incidencias recientes tipo "parada")
    const parNow = STATE.filter(x=>x.estado==="Parada").map(x=>esc(x.nombre));
    const parInc = INC.filter(x=> String(x.tipo||"").toLowerCase()==="parada")
                      .sort((a,b)=> new Date(b.inicio)-new Date(a.inicio))
                      .slice(0,12)
                      .map(x=>`${esc(x.equipo)} — <b>${fmtDia(x.inicio)}</b>${x.desc?(" · "+esc(x.desc)):""}`);
    const par = [...new Set(parNow.concat(parInc))].slice(0,12);
    fillList("tvParadas", par);

    // B) RESTRICCIONES
    const resNow = STATE.filter(x=>x.estado==="Restricciones").map(x=>esc(x.nombre));
    const resInc = INC.filter(x=> String(x.tipo||"").toLowerCase()==="restricciones")
                      .sort((a,b)=> new Date(b.inicio)-new Date(a.inicio))
                      .slice(0,12)
                      .map(x=>`${esc(x.equipo)} — <b>${fmtDia(x.inicio)}</b>${x.desc?(" · "+esc(x.desc)):""}`);
    const res = [...new Set(resNow.concat(resInc))].slice(0,12);
    fillList("tvRestr", res);

    // C) REPUESTOS (orden por urgencia y fecha prevista)
    const rank = { "Alta":3, "Media":2, "Baja":1 };
    const repRows = (REP||[]).map(r=>({
      txt: `${esc(r.ref)} — ${esc(r.nombre||"")} · <span class="urg urg-${(r.urgencia||'baja').toLowerCase()}">${esc(r.urgencia||'Baja')}</span> · Entrega: ${fmtDia(r.entrega||r.fecha||r.fechaPrevista)}`,
      urg: rank[(r.urgencia||"Baja")]||1,
      eta: new Date(r.entrega||r.fecha||r.fechaPrevista||"2100-01-01").getTime()
    }))
    .sort((a,b)=> (b.urg-a.urg) || (a.eta-b.eta))
    .slice(0,12)
    .map(x=>x.txt);
    fillList("tvRep", repRows);

    // D) PREVENTIVOS/OT
    const prev = (OTS||[])
      .filter(o=> /prevent/i.test(o.titulo||o.tipo||"") || /prevent/i.test(o.prioridad||""))
      .map(o=>({ t: `${esc(o.id)} — ${esc(o.titulo||"")} · Vence: ${fmtDia(o.vencimiento)}`, v: new Date(o.vencimiento||"2100-01-01").getTime() }))
      .sort((a,b)=> a.v-b.v)
      .slice(0,12)
      .map(x=>x.t);
    fillList("tvPrev", prev);
  };

  let _TV_T=null;
  window.initTV = window.initTV || function(){
    renderTV();
    if(_TV_T) clearInterval(_TV_T);
    _TV_T=setInterval(renderTV, 10_000);
  };
})();
</script>
<!-- ===================== BLOQUE 11: ROUTER HASH + BOOT + TIMERS ===================== -->
<script>
(function(){
  if (window.__CDL_ROUTER_BOOT__) return; window.__CDL_ROUTER_BOOT__ = true;

  const PAGES = new Set(["equipos","gruas","otros","incidencias","indicadores","ot","inventario","repuestos","consumibles","tv","personal","logs","equipo","repuesto"]);

  function go(page){ window.nav && nav(page); }

  function handleHash(){
    const h = location.hash || "";
    if (!h){ go("tv"); return; }

    const mEq = h.match(/^#\/equipo\/(.+)$/);
    const mRp = h.match(/^#\/repuesto\/(.+)$/);

    if (mEq && typeof window.renderEquipoBySlug==="function"){ window.renderEquipoBySlug(mEq[1]); return; }
    if (mRp && typeof window.renderRepuestoByRef==="function"){ window.renderRepuestoByRef(decodeURIComponent(mRp[1]||"")); return; }

    const p = h.replace(/^#\/?/,"");
    if (PAGES.has(p)){ go(p); return; }
    go("tv");
  }

  window.addEventListener("hashchange", handleHash, { passive:true });

  // Cerrar menús al navegar
  (function patchNav(){
    if (!window.nav || window.__CDL_NAV_PATCHED__) return;
    const ORIG = window.nav;
    window.nav = function(page){
      ORIG && ORIG(page);
      if (typeof window.closeAllMenus === "function") window.closeAllMenus();
    };
    window.__CDL_NAV_PATCHED__ = true;
  })();

  // Timestamp del resumen
  function updateSummaryTimestamp(){
    const d = new Date();
    const el = document.getElementById("kUpdated");
    if (el) el.textContent = d.toLocaleString("es-ES",{hour12:false});
  }
  if (!window.__CDL_TS_TIMER__){
    window.__CDL_TS_TIMER__ = setInterval(updateSummaryTimestamp, 30_000);
  }

  // Boot a TV + timers
  function bootToTV(){
    if (!location.hash || location.hash === "#" || location.hash === "#/"){
      go("tv");
    }else{
      handleHash();
    }
    window.renderTV && renderTV();
    window.initTV   && initTV();
    updateSummaryTimestamp();
  }

  // Sincroniza --hdr-h con debouncing
  function debounce(fn, ms=120){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
  const syncHdr = debounce(()=>{
    const hdr = document.querySelector("header");
    const h = Math.max(64, hdr?.offsetHeight||0);
    document.documentElement.style.setProperty('--hdr-h', h+'px');
  }, 80);
  window.addEventListener("resize", syncHdr, {passive:true});
  window.addEventListener("orientationchange", syncHdr, {passive:true});
  (document.fonts?.ready || Promise.resolve()).then(syncHdr);

  document.addEventListener("DOMContentLoaded", async ()=>{
    try{
      await Promise.all([
        typeof loadState        === "function" ? loadState()        : Promise.resolve(),
        typeof loadIncid        === "function" ? loadIncid()        : Promise.resolve(),
        typeof loadInv          === "function" ? loadInv()          : Promise.resolve(),
        typeof loadRepSol       === "function" ? loadRepSol()       : Promise.resolve(),
        typeof loadConsumibles  === "function" ? loadConsumibles()  : Promise.resolve(),
        typeof loadOT           === "function" ? loadOT()           : Promise.resolve(),
      ]);
      bootToTV();
    }catch(e){ console.error(e); bootToTV(); }
  });
})();
</script>
<!-- ===================== BLOQUE 12: ESTILOS EXTRA (metalizados + tarjetas equipo) ===================== -->
<style>
:root{
  --brand1:#A60000; --brand2:#E43B3B;
  --ok:#16a34a; --warn:#f59e0b; --stop:#dc2626;
  --ink:#0b0f15; --muted:#6b7280; --line:#1f2937;
  --panel:#0d1117; --panelAlt:#141a22;
}

/* Botón metalizado oscuro */
.btn, .page-btn{
  border:1px solid #2a2f38; color:#fff;
  background:linear-gradient(180deg,#3b3f46 0%, #1a1e24 48%, #0e1217 100%);
  box-shadow:inset 0 1px 0 rgba(255,255,255,.18), 0 8px 18px rgba(0,0,0,.35);
  border-radius:999px; padding:.46rem .9rem; font-weight:800; letter-spacing:.02em;
}
.btn:hover,.page-btn:hover{ filter:brightness(1.06); }
.btn:active,.page-btn:active{ transform:translateY(1px); }

/* Variantes semáforo */
.btn-sema.ok{   background:linear-gradient(180deg,#38d46d 0%, #14853a 48%, #0d5f29 100%); border-color:#0b5a2a; }
.btn-sema.warn{ background:linear-gradient(180deg,#ffd56a 0%, #de930f 48%, #8b5b07 100%); border-color:#7b4c05; color:#111; }
.btn-sema.stop{ background:linear-gradient(180deg,#ff6868 0%, #c31313 48%, #820a0a 100%); border-color:#6f0808; text-shadow:0 1px 0 rgba(0,0,0,.25); }

/* Utilitarias */
.btn-dark{  background:linear-gradient(180deg,#2b2f35 0%, #10141a 100%); border-color:#252a31; }
.btn-ghost{ background:linear-gradient(180deg,#1c2026 0%, #0a0d11 100%); border-color:#2a3038; }

/* Píldoras/Badges metalizadas */
.badge, .rolechip, #status-strip span, #legend-equipos span{
  background:linear-gradient(180deg,#2c3036 0%, #14181f 100%) !important;
  color:#fff !important; border:1px solid #2b313a !important;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.12);
}

/* Status strip oscuro */
#status-strip{
  background:#0c1117 !important; color:#e5e7eb !important; border-bottom:1px solid #1f2937 !important;
}

/* Tarjeta de equipo alineada */
.card.equipo{
  background:linear-gradient(180deg,#0f141b,#0b1016)!important; border:1px solid #1c2430!important;
  border-radius:14px; padding:.75rem .85rem;
  display:grid; grid-template-columns:1fr auto auto; gap:.6rem; align-items:center;
}
.eq-main{ min-width:0; }
.eq-name{ font-weight:900; letter-spacing:.02em; color:#e7e9ee; display:flex; gap:.45rem; align-items:center; }
.eq-line{ font-size:.85rem; color:#9aa4b2; }
.eq-state{ display:flex; align-items:center; gap:.45rem; }
.eq-actions{ display:flex; gap:.35rem; flex-wrap:wrap; justify-content:flex-end; }
.state-chip{
  display:inline-flex; align-items:center; gap:.35rem; padding:.18rem .55rem; border-radius:999px;
  border:1px solid #2a3038; background:linear-gradient(180deg,#2e333a,#161b22); font-weight:900; color:#fff;
}
.state-dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }
.state-parada .state-dot{ background:var(--stop); }
.state-restr  .state-dot{ background:var(--warn); }
.state-marcha .state-dot{ background:var(--ok); }

/* Tablas oscuras y tarjetas */
thead th{ background:#0e141b!important; color:#e7eaef!important; border-bottom:1px solid #1f2937!important; }
tbody td{ border-top:1px solid #151b22!important; }
.card{ background:linear-gradient(180deg,#0f141b,#0b1016); border:1px solid #1c2430; }

/* Panel de menú metalizado */
.panel{
  background:linear-gradient(180deg,#131a24,#0b1117)!important; color:#e5e7eb!important;
  border:1px solid #1f2937!important; box-shadow:0 24px 60px rgba(0,0,0,.45)!important;
}

/* Header sobrio */
header{ background:linear-gradient(180deg,#0f141b,#0b1016)!important; border-bottom:1px solid #1f2937!important; }
.hero-title .hero-panel{ color:#f3f4f6; }
header.scrolled{ box-shadow:0 6px 22px rgba(0,0,0,.45)!important; }
</style>
<!-- ===================== BLOQUE 13: Acciones avanzadas de equipos ===================== -->
<script>
(function(){
  if (window.__CDL_ACCIONES_ADV__) return; window.__CDL_ACCIONES_ADV__ = true;

  const apiPost = window.apiPost || (async()=>({ok:false}));

  // ——— Set de estado (idempotente, con feedback) ———
  if (!window.setEquipoEstado){
    window.setEquipoEstado = async function(nombre, estado){
      try{
        const actor = (window.USER?.user)||"anon";
        const r = await apiPost({res:"state", fn:"set", nombre, estado, actor});
        if (r?.ok){
          (window.toast||console.log)(`Estado de ${nombre}: ${estado}`);
          if (typeof loadState==="function") await loadState();
          if (typeof renderTV==="function") renderTV();
        }else{
          alert(r?.error||"No se pudo actualizar el estado");
        }
      }catch(e){ console.error(e); alert("Error de red"); }
    };
  }

  // ——— Alta rápida de incidencia (tipo + descripción opcional) ———
  if (!window.crearIncidenciaRapida){
    window.crearIncidenciaRapida = async function({equipo,tipo,desc}){
      try{
        const payload = {equipo, tipo, desc:(desc||tipo), actor:(window.USER?.user||"anon")};
        const r = await apiPost({res:"incid", fn:"add", item:payload});
        if (r?.ok){
          (window.toast||console.log)("Incidencia creada");
          if (typeof loadIncid==="function") loadIncid();
          if (typeof renderTV==="function") renderTV();
        }else{
          alert(r?.error||"No se pudo crear la incidencia");
        }
      }catch(e){ console.error(e); alert("Error de red"); }
    };
  }

  // ——— Acción “Parada prolongada” (API → fallback mailto) ———
  if (!window.accionParadaProlongada){
    window.accionParadaProlongada = async function(equipo){
      try{
        const actor = (window.USER?.user)||"anon";
        const r = await apiPost({res:"mail", fn:"parada_prolongada", equipo, actor});
        if (r?.ok){ (window.toast||console.log)("Aviso enviado"); return; }
        throw new Error("mail api not ok");
      }catch(_){
        const subj = encodeURIComponent(`[CDL] Parada prolongada — ${equipo}`);
        const body = encodeURIComponent(
          `Equipo: ${equipo}\nFecha: ${new Date().toLocaleString("es-ES",{hour12:false})}\n\nDetalle: ...`
        );
        location.href = `mailto:?subject=${subj}&body=${body}`;
      }
    };
  }

  // ——— Filtros rápidos de equipos (por estado) ———
  if (!window.filterEquiposByEstado){
    window.filterEquiposByEstado = function(estado){
      const wrap = document.getElementById("equiposWrap"); if(!wrap) return;
      wrap.querySelectorAll(".card.equipo").forEach(card=>{
        const txt = (card.textContent||"");
        const match = !estado || txt.includes(estado);
        card.style.display = match ? "" : "none";
      });
    };
  }
})();
</script>
<!-- ===================== BLOQUE 14: Auth + permisos (login/logout/chpwd + UI) ===================== -->
<script>
(function(){
  if (window.__CDL_AUTH_CORE__) return; window.__CDL_AUTH_CORE__ = true;

  // Estado usuario
  window.USER = window.USER || { user:"invitado", rol:"Invitado", group:"guest" };

  function setUser(u){ try{ window.USER=u; localStorage.setItem("CDL_USER", JSON.stringify(u)); }catch(_){} applyRoleUI(); }
  function getCID(){ try{ return localStorage.getItem("CDL_CID") || ""; }catch(_){ return ""; } }

  // Roles con edición
  if (!window.canEdit){
    const EDIT_ROLES = new Set(["Administrador","Gerente","Encargado","Producción"]);
    window.canEdit = ()=> EDIT_ROLES.has((window.USER?.rol)||"Invitado");
  }

  // Aplicar UI por rol
  if (!window.applyRoleUI){
    window.applyRoleUI = function(){
      document.querySelectorAll("[data-role]").forEach(el=>{
        const roles=(el.getAttribute("data-role")||"").split(",").map(x=>x.trim());
        if (roles.includes(USER.rol)||USER.rol==="Administrador"){ el.style.display=""; }
        else{ el.style.display="none"; }
      });
      const chip = document.getElementById("roleChip");
      if (chip) chip.textContent = USER.rol || "Invitado";
    };
  }

  // API helpers
  const apiPost = window.apiPost || (async()=>({ok:false}));

  // Login
  if (!window.login){
    window.login = async function(){
      try{
        const uSel = document.getElementById("userSelect");
        const pInp = document.getElementById("userPass");
        const u = uSel?.value || "invitado";
        const p = pInp?.value || "";
        const r = await apiPost({res:"auth", fn:"login", user:u, pass:p, cid:getCID()});
        if (r?.ok){
          setUser({ user:u, rol:r.rol||u, group:r.group||"guest" });
          (window.toast||console.log)(`Bienvenido ${u}`);
          window.closeAllMenus?.();
        }else{
          alert("Usuario o contraseña incorrectos");
        }
      }catch(err){ console.error(err); alert("Error en la conexión al servidor"); }
    };
  }

  // Logout
  if (!window.logout){
    window.logout = function(){
      try{
        localStorage.removeItem("CDL_USER");
        setUser({ user:"invitado", rol:"Invitado", group:"guest" });
        (window.toast||console.log)("Sesión cerrada");
        window.closeAllMenus?.();
      }catch(e){ console.error(e); }
    };
  }

  // Cambio de contraseña
  if (!window.changePwd){
    window.changePwd = async function(){
      const oldP = document.getElementById("oldPass")?.value || "";
      const newP = document.getElementById("newPass")?.value || "";
      const msg  = document.getElementById("pwdMsg");
      if (!oldP || !newP){ alert("Introduce la contraseña actual y la nueva"); return; }
      try{
        const r = await apiPost({res:"auth", fn:"chpwd", old:oldP, nuevo:newP, cid:getCID()});
        if (r?.ok){
          if (msg){ msg.textContent = "Contraseña cambiada correctamente"; msg.style.color = "green"; }
          const o = document.getElementById("oldPass"); const n = document.getElementById("newPass");
          if (o) o.value=""; if (n) n.value="";
        }else{
          if (msg){ msg.textContent = "Error al cambiar la contraseña"; msg.style.color = "red"; }
        }
      }catch(err){
        console.error(err);
        if (msg){ msg.textContent = "Error de red"; msg.style.color = "red"; }
      }
    };
  }

  // Aplicar rol guardado al cargar
  try{
    const saved = JSON.parse(localStorage.getItem("CDL_USER")||"null");
    if (saved && saved.user){ window.USER = saved; }
  }catch(_){}
  if (document.readyState !== "loading") applyRoleUI(); else document.addEventListener("DOMContentLoaded", applyRoleUI);
})();
</script>
<!-- ===================== BLOQUE 15: Utilidades + export (CSV/PDF/Toast) ===================== -->
<script>
(function(){
  if (window.__CDL_UTILS_EXPORT__) return; window.__CDL_UTILS_EXPORT__ = true;

  // CSV helpers
  if (!window.csvEscape){
    window.csvEscape = function(v){
      v = (v==null?'':String(v));
      if (/[",\n;]/.test(v)) return `"${v.replace(/"/g,'""')}"`;
      return v;
    };
  }
  if (!window.toCSV){
    window.toCSV = function(rows){ return (rows||[]).map(r => (r||[]).map(window.csvEscape).join(";")).join("\n"); };
  }
  if (!window.download){
    window.download = function(name, content, type="text/plain;charset=utf-8"){
      const blob = new Blob([content], {type});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = name;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    };
  }
  if (!window.exportCSVFromTable){
    window.exportCSVFromTable = function(tableSel, fileName){
      const table = document.querySelector(tableSel); if(!table) return;
      const rows = [...table.querySelectorAll("tr")].map(tr => [...tr.children].map(td => (td.innerText||"").trim()));
      window.download(fileName, window.toCSV(rows), "text/csv;charset=utf-8");
    };
  }
  if (!window.printHTML){
    window.printHTML = function(title, html){
      const w = window.open("", "_blank");
      w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>${String(title||"Documento")}</title><style>
        body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:16px}
        table{width:100%;border-collapse:collapse}
        th,td{border:1px solid #ddd;padding:6px 8px}
        th{background:#f3f4f6}
      </style></head><body>${html||""}</body></html>`);
      w.document.close(); w.focus(); w.print();
    };
  }

  // Toast ligero
  if (!window.toast){
    window.toast = function(msg){
      let t = document.getElementById("toast");
      if(!t){
        t = document.createElement("div");
        t.id = "toast";
        Object.assign(t.style, {
          position:"fixed", left:"50%", bottom:"16px", transform:"translateX(-50%)",
          background:"#0b0f15", color:"#e5e7eb", border:"1px solid #1f2937",
          padding:".5rem .8rem", borderRadius:"12px", boxShadow:"0 10px 26px rgba(0,0,0,.35)",
          opacity:"0", transition:"opacity .25s ease", zIndex:"3000"
        });
        document.body.appendChild(t);
      }
      t.textContent = String(msg||"");
      requestAnimationFrame(()=>{ t.style.opacity = "1"; });
      clearTimeout(window.__TOAST_T);
      window.__TOAST_T = setTimeout(()=> t.style.opacity = "0", 1800);
    };
  }
  if (!window.showToast){ window.showToast = (m)=> window.toast(m); }
})();
</script>
￼<!-- ===================== BLOQUE 16: Indicadores/KPIs ===================== -->
<script>
(function(){
  if (window.__CDL_KPIS__) return; window.__CDL_KPIS__ = true;

  // Utilidad segura
  const nz = (n)=> Number.isFinite(+n) ? +n : 0;

  // Cálculo de KPIs básicos a partir de STATE/INCID/OTS
  window.calcKPIs = function(){
    const S = Array.isArray(window.STATE)? window.STATE : [];
    const I = Array.isArray(window.INCID)? window.INCID : [];
    const O = Array.isArray(window.OTS)  ? window.OTS   : [];

    const total = S.length;
    const kParo = S.filter(x=>x.estado==="Parada").length;
    const kRest = S.filter(x=>x.estado==="Restricciones").length;
    const kOk   = S.filter(x=>x.estado==="En marcha").length;

    // MTBF/MTTR muy aproximado (muestra) a partir de incidencias cerradas con fechas
    const cerradas = I.filter(x=> x.inicio && x.fin && new Date(x.fin) >= new Date(x.inicio));
    const paradas  = cerradas.filter(x=> String(x.tipo).toLowerCase().includes("parada"));
    const duras    = paradas.map(x=> (new Date(x.fin)-new Date(x.inicio))/3600000 ).filter(Number.isFinite); // en horas
    const MTTR = duras.length ? (duras.reduce((a,b)=>a+b,0)/duras.length) : 0;

    // OT preventivas abiertas y vencidas
    const now = Date.now();
    const otPrev = O.filter(o=> /prevent/i.test(o.titulo||o.tipo||"") || /prevent/i.test(o.prioridad||""));
    const otAbiertas = otPrev.filter(o=> !/cerrad/i.test(o.estado||"") );
    const otVencidas = otAbiertas.filter(o=> o.vencimiento && (new Date(o.vencimiento).getTime()<now));

    return {
      totalEquipos: total,
      enParada: kParo,
      conRestr: kRest,
      enMarcha: kOk,
      mttrHoras: MTTR,
      otPrevAbiertas: otAbiertas.length,
      otPrevVencidas: otVencidas.length
    };
  };

  // Render de la página "Indicadores" si existe #page-indicadores
  window.renderIndicadoresPage = function(){
    const host = document.getElementById("page-indicadores");
    if (!host) return;
    const k = window.calcKPIs();
    host.innerHTML = `
      <h2 class="cdl-tag">Indicadores</h2>
      <div class="card" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
        ${[
          ["Equipos totales", k.totalEquipos],
          ["En marcha", k.enMarcha],
          ["Restricciones", k.conRestr],
          ["Paradas", k.enParada],
          ["MTTR (h)", k.mttrHoras.toFixed(2)],
          ["OT preventivas abiertas", k.otPrevAbiertas],
          ["OT preventivas vencidas", k.otPrevVencidas]
        ].map(([t,v])=>`
          <div class="card" style="text-align:center">
            <div style="font-size:.85rem;color:#9aa4b2">${t}</div>
            <div style="font-size:1.8rem;font-weight:900;margin-top:.2rem">${v}</div>
          </div>
        `).join("")}
      </div>
    `;
  };

  // Parche: al navegar a #/indicadores, pintar
  const ORIG_NAV = window.nav;
  window.nav = function(page){
    ORIG_NAV && ORIG_NAV(page);
    if (page==="indicadores") { try{ window.renderIndicadoresPage(); }catch(_){ } }
  };

  // Pintar si ya estuviera activa al cargar
  if (location.hash.replace(/^#\/?/,"")==="indicadores"){
    try{ window.renderIndicadoresPage(); }catch(_){}
  }
})();
</script>
<!-- ===================== BLOQUE 17: Buscadores y filtros (Inventario/Incidencias) ===================== -->
<script>
(function(){
  if (window.__CDL_SEARCH_FILTERS__) return; window.__CDL_SEARCH_FILTERS__ = true;

  const debounce = (fn,ms=180)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };

  // ----- Inventario: cuadro de búsqueda opcional -----
  function ensureInvSearch(){
    const sec = document.getElementById("page-inv");
    const wrap = document.getElementById("invWrap");
    if (!sec || !wrap || sec.__hasSearch__) return;
    const bar = document.createElement("div");
    bar.className="card";
    bar.innerHTML = `
      <input id="invSearch" class="in-txt" type="search" placeholder="Buscar en inventario (ref/nombre)" style="width:100%">
    `;
    sec.insertBefore(bar, wrap);
    sec.__hasSearch__ = true;

    const onSearch = debounce(()=>{
      const q = (document.getElementById("invSearch")?.value||"").trim().toLowerCase();
      [...wrap.querySelectorAll(".card")].forEach(card=>{
        const t = (card.textContent||"").toLowerCase();
        card.style.display = t.includes(q) ? "" : "none";
      });
    }, 120);
    bar.addEventListener("input", onSearch, true);
  }

  // ----- Incidencias: filtro por tipo -----
  function ensureIncidFilters(){
    const sec = document.getElementById("page-incidencias");
    const wrap = document.getElementById("incidTableWrap");
    if (!sec || !wrap || sec.__hasFilter__) return;
    const bar = document.createElement("div");
    bar.className="card";
    bar.style.marginBottom=".5rem";
    bar.innerHTML = `
      <div style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:center">
        <select id="incidTipo" class="in-txt">
          <option value="">Todos los tipos</option>
          <option>Parada</option>
          <option>Restricciones</option>
          <option>Incidencia</option>
          <option>Parada planificada</option>
        </select>
        <input id="incidQ" class="in-txt" type="search" placeholder="Buscar texto…">
      </div>
    `;
    sec.insertBefore(bar, wrap);
    sec.__hasFilter__ = true;

    const apply = debounce(()=>{
      const tipo = (document.getElementById("incidTipo")?.value||"").toLowerCase();
      const q    = (document.getElementById("incidQ")?.value||"").toLowerCase();
      const rows = (wrap.querySelector("tbody")||wrap).querySelectorAll("tr");
      rows.forEach(tr=>{
        const txt = (tr.textContent||"").toLowerCase();
        const okTipo = !tipo || txt.includes(tipo);
        const okTxt  = !q || txt.includes(q);
        tr.style.display = (okTipo && okTxt) ? "" : "none";
      });
    }, 120);

    bar.addEventListener("input", apply, true);
    bar.addEventListener("change", apply, true);
  }

  // Parchear nav para inyectar controles al entrar
  const ORIG_NAV = window.nav;
  window.nav = function(page){
    ORIG_NAV && ORIG_NAV(page);
    if (page==="inventario")  ensureInvSearch();
    if (page==="incidencias") ensureIncidFilters();
  };

  // Si ya estás en esas vistas al cargar
  const h = location.hash.replace(/^#\/?/,"");
  if (h==="inventario")  ensureInvSearch();
  if (h==="incidencias") ensureIncidFilters();
})();
</script>
<!-- ===================== BLOQUE 18: Resiliencia de red + avisos offline ===================== -->
<script>
(function(){
  if (window.__CDL_NET_STATUS__) return; window.__CDL_NET_STATUS__ = true;

  // Banner discreto de estado de red
  let banner;
  function ensureBanner(){
    if (banner) return banner;
    banner = document.createElement("div");
    Object.assign(banner.style, {
      position:"fixed", left:"50%", transform:"translateX(-50%)",
      bottom:"10px", padding:".4rem .7rem", fontWeight:"800",
      borderRadius:"10px", zIndex:3200, display:"none",
      background:"#111827", color:"#e5e7eb", border:"1px solid #374151",
      boxShadow:"0 10px 24px rgba(0,0,0,.35)"
    });
    document.body.appendChild(banner);
    return banner;
  }
  function show(msg, ms=2000){
    const b = ensureBanner();
    b.textContent = msg;
    b.style.display = "block";
    clearTimeout(show._t);
    show._t = setTimeout(()=> b.style.display="none", ms);
  }

  // Escuchas online/offline
  window.addEventListener("offline", ()=> show("Sin conexión. Trabajando en modo offline…", 3500), {passive:true});
  window.addEventListener("online",  ()=> show("Conexión restablecida ✔"), {passive:true});

  // Pequeño envoltorio fetch con reintentos para apiGet/apiPost si quieres usarlo
  async function fetchRetry(url, opts={}, retries=2, backoff=400){
    try{
      const r = await fetch(url, opts);
      if (!r.ok) throw new Error("HTTP "+r.status);
      return r;
    }catch(e){
      if (retries<=0) throw e;
      await new Promise(res=>setTimeout(res, backoff));
      return fetchRetry(url, opts, retries-1, backoff*2);
    }
  }

  // Exponer helpers por si se necesitan en otras partes
  window.__fetchRetry = fetchRetry;
  window.__netShow    = show;
})();
</script>
<!-- ===================== BLOQUE 19: Tema claro/oscuro con persistencia ===================== -->
<script>
(function(){
  if (window.__CDL_THEME__) return; window.__CDL_THEME__ = true;

  const KEY = "CDL_THEME"; // "dark" | "light" | "auto"
  const root = document.documentElement;

  function getPref(){
    try { return localStorage.getItem(KEY) || "auto"; } catch(_){ return "auto"; }
  }
  function setPref(v){
    try { localStorage.setItem(KEY, v); } catch(_){}
    apply(v);
  }
  function apply(mode){
    root.classList.remove("theme-dark","theme-light");
    const sysDark = matchMedia("(prefers-color-scheme: dark)").matches;
    const isDark = (mode==="dark") || (mode==="auto" && sysDark);
    root.classList.add(isDark ? "theme-dark" : "theme-light");
    // Señal global
    window.__THEME__ = isDark ? "dark" : "light";
    document.querySelector('meta[name="theme-color"]')?.setAttribute("content", isDark ? "#0d1117" : "#ffffff");
  }

  // CSS mínimos (no pisa tus estilos existentes; solo alterna root classes)
  const css = `
  :root.theme-light #status-strip{ background:#ffffff!important; color:#111827!important; border-bottom:1px solid #e5e7eb!important; }
  :root.theme-light .card{ background:#fff!important; border-color:#e5e7eb!important; }
  :root.theme-light .btn, :root.theme-light .page-btn{ color:#111!important; }
  :root.theme-light .tv-card{ background:#fff!important; border-color:#e5e7eb!important; }
  `;
  const tag = document.createElement("style"); tag.textContent = css; document.head.appendChild(tag);

  // Botón de alternancia en el panel de usuario (si existe)
  function injectToggle(){
    const panel = document.getElementById("userPanel"); if(!panel || panel.__theme__) return;
    const row = document.createElement("div"); row.className="row"; row.style.marginTop=".6rem";
    row.innerHTML = `
      <label class="small">Tema</label>
      <div style="display:flex;gap:.4rem;flex-wrap:wrap">
        <button type="button" class="btn gloss" data-theme="auto">Auto</button>
        <button type="button" class="btn gloss" data-theme="light">Claro</button>
        <button type="button" class="btn gloss" data-theme="dark">Oscuro</button>
      </div>
    `;
    panel.appendChild(row);
    row.addEventListener("click",(e)=>{
      const b = e.target.closest('[data-theme]'); if(!b) return;
      setPref(b.getAttribute("data-theme"));
      (window.toast||console.log)(`Tema: ${getPref()}`);
    }, true);
    panel.__theme__ = true;
  }

  // Aplicar al cargar
  apply(getPref());
  matchMedia("(prefers-color-scheme: dark)").addEventListener?.("change", ()=> apply(getPref()), {passive:true});
  document.addEventListener("DOMContentLoaded", injectToggle);
})();
</script>
<!-- ===================== BLOQUE 20: Auditoría (Logs) + render de la página #/logs ===================== -->
<script>
(function(){
  if (window.__CDL_AUDIT__) return; window.__CDL_AUDIT__ = true;

  const apiPost = window.apiPost || (async()=>({ok:false}));

  // --- API de auditoría ---
  async function auditLog(event, payload){
    try{
      const actor = (window.USER?.user)||"anon";
      const r = await apiPost({res:"logs", fn:"add", item:{ event, payload, actor, ts: Date.now() }});
      return !!r?.ok;
    }catch(_){ return false; }
  }
  window.auditLog = auditLog;

  // --- Hook sobre acciones críticas (patch no intrusivo) ---
  function patch(obj, name, wrapper){
    const orig = obj[name]; if (typeof orig!=="function") return;
    if (orig.__patched__) return;
    obj[name] = async function(){
      const args = Array.from(arguments);
      try{ return await wrapper.call(this, orig.bind(this), args); }
      catch(e){ throw e; }
    };
    obj[name].__patched__ = true;
  }

  // setEquipoEstado(nombre, estado)
  if (typeof window.setEquipoEstado === "function"){
    patch(window, "setEquipoEstado", async (orig, [nombre,estado])=>{
      const out = await orig(nombre, estado);
      auditLog("equipo.estado.set", { nombre, estado });
      return out;
    });
  }
  // crearIncidenciaRapida({equipo,tipo,desc})
  if (typeof window.crearIncidenciaRapida === "function"){
    patch(window, "crearIncidenciaRapida", async (orig, [item])=>{
      const out = await orig(item);
      auditLog("incid.add", item);
      return out;
    });
  }
  // invDelta(ref, delta)
  if (typeof window.invDelta === "function"){
    patch(window, "invDelta", async (orig, [ref,delta])=>{
      const out = await orig(ref, delta);
      auditLog("inv.delta", { ref, delta });
      return out;
    });
  }
  // Parada prolongada
  if (typeof window.accionParadaProlongada === "function"){
    patch(window, "accionParadaProlongada", async (orig, [equipo])=>{
      const out = await orig(equipo);
      auditLog("equipo.parada_prolongada", { equipo });
      return out;
    });
  }
  // Login/Logout
  if (typeof window.login === "function"){
    patch(window, "login", async (orig, args)=>{
      const u = document.getElementById("userSelect")?.value || "invitado";
      try{ const r = await orig(...args); auditLog("auth.login", { user:u, ok:true }); return r; }
      catch(e){ auditLog("auth.login", { user:u, ok:false }); throw e; }
    });
  }
  if (typeof window.logout === "function"){
    patch(window, "logout", async (orig, args)=>{
      const u = (window.USER?.user)||"invitado";
      const r = await orig(...args); auditLog("auth.logout", { user:u }); return r;
    });
  }

  // --- Carga de logs (lectura) + Render página #/logs ---
  async function loadLogs(){
    try{
      const r = await (window.apiGet?.({res:"logs", fn:"list"}) || Promise.resolve({ok:false}));
      return r?.ok && Array.isArray(r.items) ? r.items : [];
    }catch(_){ return []; }
  }

  async function renderLogsPage(){
    const host = document.getElementById("logsWrap"); const sec = document.getElementById("page-logs");
    if (!host || !sec) return;
    host.innerHTML = `<div class="card">Cargando…</div>`;
    const items = await loadLogs();
    if (!items.length){ host.innerHTML = `<div class="card">Sin registros</div>`; return; }

    const rows = items
      .sort((a,b)=> (b.ts||0)-(a.ts||0))
      .map(it=>`
        <tr>
          <td>${new Date(it.ts||Date.now()).toLocaleString("es-ES",{hour12:false})}</td>
          <td>${(it.actor||"")}</td>
          <td>${(it.event||"")}</td>
          <td><pre style="white-space:pre-wrap;margin:0;font-family:ui-monospace,Consolas,monospace">${window.esc ? esc(JSON.stringify(it.payload||{}, null, 0)) : JSON.stringify(it.payload||{})}</pre></td>
        </tr>
      `).join("");

    host.innerHTML = `
      <div class="card" style="overflow:auto">
        <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-bottom:.5rem">
          <button id="btnLogsCSV" class="btn gloss">Exportar CSV</button>
        </div>
        <table id="tblLogs">
          <thead><tr><th>Fecha</th><th>Actor</th><th>Evento</th><th>Detalle</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
    document.getElementById("btnLogsCSV")?.addEventListener("click", ()=>{
      const table = document.getElementById("tblLogs");
      window.exportCSVFromTable?.("#tblLogs","logs.csv");
    });
  }

  // Integrar con el router simple
  const ORIG_NAV = window.nav;
  window.nav = function(page){
    ORIG_NAV && ORIG_NAV(page);
    if (page==="logs") renderLogsPage();
  };
  if (location.hash.replace(/^#\/?/,"")==="logs") renderLogsPage();

})();
</script>
<!-- ===================== BLOQUE 21: UX segura (deshabilitar mientras carga + confirmaciones) ===================== -->
<script>
(function(){
  if (window.__CDL_SAFE_UX__) return; window.__CDL_SAFE_UX__ = true;

  // Utilidad: deshabilita un botón durante la promesa y muestra "…"
  async function withBusy(btn, promise){
    if (btn){
      btn.__oldText = btn.textContent;
      btn.disabled = true;
      btn.style.opacity = ".7";
      btn.textContent = "Procesando…";
    }
    try { return await promise; }
    finally{
      if (btn){
        btn.disabled = false;
        btn.style.opacity = "";
        btn.textContent = btn.__oldText || "OK";
      }
    }
  }

  // Delegado global para botones con data-busy
  document.addEventListener("click", (e)=>{
    const btn = e.target.closest("button[data-busy]"); if (!btn) return;
    const act = btn.getAttribute("data-busy");
    if (!act || typeof window[act] !== "function") return;
    e.preventDefault();
    const args = (btn.getAttribute("data-args")||"").split("||").map(s=>s && decodeURIComponent(s));
    withBusy(btn, Promise.resolve(window[act](...args)));
  }, true);

  // Confirmaciones para acciones sensibles via atributo data-confirm
  document.addEventListener("click", (e)=>{
    const btn = e.target.closest("[data-confirm]"); if(!btn) return;
    const msg = btn.getAttribute("data-confirm") || "¿Seguro?";
    if (!confirm(msg)){ e.preventDefault(); e.stopImmediatePropagation(); }
  }, true);

  // Ejemplos de uso (no obligatorios; solo si quieres poner en botones existentes):
  // <button class="btn" data-confirm="¿Marcar Parada?" onclick="setEquipoEstado('Cizalla','Parada')">Paro</button>
  // <button class="btn" data-busy="invDelta" data-args="ABC123||%2B10">+10</button>

  // Parches suaves en algunas acciones ya presentes para auto-UX:
  function patchBusy(obj, name){
    const orig = obj[name]; if (typeof orig!=="function" || orig.__busy__) return;
    obj[name] = async function(){
      const ev = window.event; const btn = ev && ev.target && ev.target.closest("button");
      return withBusy(btn, orig.apply(this, arguments));
    };
    obj[name].__busy__ = true;
  }

  ["setEquipoEstado","crearIncidenciaRapida","invDelta","accionParadaProlongada"].forEach(fn=>{
    if (typeof window[fn] === "function") patchBusy(window, fn);
  });

})();
</script>
<!-- ===================== BLOQUE 22: Accesibilidad avanzada (skip-link, focus-trap, ARIA) ===================== -->
<script>
(function(){
  if (window.__CDL_A11Y__) return; window.__CDL_A11Y__ = true;

  // 1) Skip link (Saltar al contenido)
  function injectSkipLink(){
    if (document.getElementById("skip-link")) return;
    const a = document.createElement("a");
    a.id = "skip-link";
    a.href = "#main";
    a.textContent = "Saltar al contenido";
    Object.assign(a.style, {
      position:"absolute", left:"-9999px", top:"0", background:"#111827", color:"#fff",
      padding:"8px 12px", borderRadius:"8px", zIndex:"3000"
    });
    a.addEventListener("focus", ()=>{ a.style.left="8px"; });
    a.addEventListener("blur",  ()=>{ a.style.left="-9999px"; });
    document.body.insertBefore(a, document.body.firstChild);
    // asegúrate de que <main> es targeteable
    const main = document.querySelector("main");
    if (main && !main.id) main.id = "main";
  }

  // 2) Roles ARIA mínimos (idempotente)
  function ensureARIA(){
    const header = document.querySelector("header");
    if (header && !header.getAttribute("role")) header.setAttribute("role", "banner");

    const main = document.querySelector("main");
    if (main && !main.getAttribute("role")) main.setAttribute("role","main");

    const nav = document.querySelector("header .nav");
    if (nav && !nav.getAttribute("role")) nav.setAttribute("role","navigation");
  }

  // 3) Focus trap cuando un panel entra en modo fullscreen (móvil)
  function trapFocus(container){
    if (!container) return ()=>{};
    const FOCUSABLE = 'a[href], button, textarea, input, select, [tabindex]:not([tabindex="-1"])';
    const focusables = Array.from(container.querySelectorAll(FOCUSABLE))
      .filter(el => !el.hasAttribute("disabled") && el.offsetParent !== null);
    if (!focusables.length) return ()=>{};
    const first = focusables[0], last = focusables[focusables.length-1];
    function onKey(e){
      if (e.key !== "Tab") return;
      if (e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
      else if (!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
    }
    container.addEventListener("keydown", onKey, true);
    // mover el foco al primer elemento navegable
    setTimeout(()=> first.focus?.(), 0);
    return ()=> container.removeEventListener("keydown", onKey, true);
  }

  let releasePagesTrap = null;
  let releaseUserTrap  = null;

  // Observa cambios de clase "menu-full" para activar/desactivar el trap
  const mo = new MutationObserver(()=> {
    const pagesPanel = document.getElementById("pagesPanel");
    const userPanel  = document.getElementById("userPanel");

    if (pagesPanel?.classList.contains("menu-full")){
      if (!releasePagesTrap) releasePagesTrap = trapFocus(pagesPanel);
      pagesPanel.setAttribute("aria-modal","true");
    } else {
      pagesPanel?.removeAttribute("aria-modal");
      releasePagesTrap && releasePagesTrap(); releasePagesTrap = null;
    }

    if (userPanel?.classList.contains("menu-full")){
      if (!releaseUserTrap) releaseUserTrap = trapFocus(userPanel);
      userPanel.setAttribute("aria-modal","true");
    } else {
      userPanel?.removeAttribute("aria-modal");
      releaseUserTrap && releaseUserTrap(); releaseUserTrap = null;
    }
  });

  mo.observe(document.documentElement, { subtree:true, attributes:true, attributeFilter:["class"] });

  // 4) Indicadores aria-expanded en botones de menú (ya existen, los mantenemos sincronizados)
  function syncExpanded(){
    const pagesBtn = document.getElementById("pagesBtn");
    const pagesPanel = document.getElementById("pagesPanel");
    if (pagesBtn && pagesPanel){
      pagesBtn.setAttribute("aria-controls","pagesPanel");
      pagesBtn.setAttribute("aria-expanded", pagesPanel.classList.contains("hidden") ? "false" : "true");
    }
    const userBtn = document.getElementById("userBtn");
    const userPanel = document.getElementById("userPanel");
    if (userBtn && userPanel){
      userBtn.setAttribute("aria-controls","userPanel");
      userBtn.setAttribute("aria-expanded", userPanel.classList.contains("hidden") ? "false" : "true");
    }
  }
  setInterval(syncExpanded, 800);

  document.addEventListener("DOMContentLoaded", ()=>{
    injectSkipLink();
    ensureARIA();
  });
})();
</script>
<!-- ===================== BLOQUE 23: Rendimiento (pausar TV oculta, lazy media, listeners pasivos) ===================== -->
<script>
(function(){
  if (window.__CDL_PERF__) return; window.__CDL_PERF__ = true;

  // A) Pausar refresco del Dashboard TV cuando la pestaña está oculta
  (function pauseTVWhenHidden(){
    const getTimerRef = ()=> window.__TV_T || window._TV_T || null; // soporta nombres usados
    const setTimerRef = (t)=> { window.__TV_T = t; window._TV_T = t; };

    function resume(){
      if (typeof window.renderTV !== "function") return;
      window.renderTV();
      if (getTimerRef()) return;
      const id = setInterval(()=> window.renderTV && window.renderTV(), 10000);
      setTimerRef(id);
    }
    function pause(){
      const t = getTimerRef(); if (t){ clearInterval(t); setTimerRef(null); }
    }
    document.addEventListener("visibilitychange", ()=>{
      if (document.hidden) pause(); else resume();
    }, {passive:true});
    // Primera ejecución: si está visible, aseguramos el timer
    if (!document.hidden) resume();
  })();

  // B) Lazy loading para imágenes y iframes que no lo declaran
  function enableLazyMedia(){
    const medias = document.querySelectorAll('img:not([loading]), iframe:not([loading])');
    medias.forEach(el => el.setAttribute("loading","lazy"));
  }
  // Intento inmediato y al mutar el DOM
  enableLazyMedia();
  const mo = new MutationObserver((muts)=>{
    for (const m of muts){
      if (m.addedNodes && m.addedNodes.length) enableLazyMedia();
    }
  });
  mo.observe(document.documentElement, { childList:true, subtree:true });

  // C) Listeners pasivos para scroll/touch (mejora de rendimiento en móvil)
  const passiveEvents = ["touchstart","touchmove","wheel","mousewheel"];
  const _add = EventTarget.prototype.addEventListener;
  if (!_add.__passivePatched__){
    EventTarget.prototype.addEventListener = function(type, listener, options){
      if (passiveEvents.includes(type) && (typeof options === "object")){
        options = Object.assign({ passive:true }, options);
      }
      return _add.call(this, type, listener, options);
    };
    EventTarget.prototype.addEventListener.__passivePatched__ = true;
  }

  // D) Throttle simple utilitario (expuesto globalmente)
  window.throttle = window.throttle || function(fn, wait=120){
    let t=0, lastArgs=null, lastThis=null;
    return function throttled(){
      lastArgs = arguments; lastThis=this;
      const now = Date.now();
      if (now - t >= wait){
        t = now; fn.apply(lastThis, lastArgs);
      }
    };
  };

  // E) Re-render de TV throttle al resize/orientation (evita cascadas)
  if (typeof window.renderTV === "function"){
    const safeRender = window.throttle(window.renderTV, 200);
    window.addEventListener("resize", safeRender, {passive:true});
    window.addEventListener("orientationchange", safeRender, {passive:true});
  }
})();
</script>
<!-- ===================== BLOQUE 24: Red robusta (timeout, reintentos exponenciales, indicador offline) ===================== -->
<script>
(function(){
  if (window.__CDL_NET__) return; window.__CDL_NET__ = true;

  // Banner de estado de red
  function ensureNetBanner(){
    if (document.getElementById("netBanner")) return;
    const b = document.createElement("div");
    b.id = "netBanner";
    b.textContent = "Sin conexión. Los cambios se reintentarán…";
    Object.assign(b.style, {
      position:"fixed", left:"50%", transform:"translateX(-50%)",
      bottom:"12px", background:"#fde68a", color:"#78350f", border:"1px solid #f59e0b",
      padding:"6px 10px", borderRadius:"10px", boxShadow:"0 6px 16px rgba(0,0,0,.15)",
      fontWeight:"800", zIndex:"3200", display:"none"
    });
    document.body.appendChild(b);
  }

  function setBanner(v){ const b=document.getElementById("netBanner"); if (b) b.style.display = v ? "block" : "none"; }
  document.addEventListener("DOMContentLoaded", ensureNetBanner);

  // Señales online/offline
  function onOnline(){ setBanner(false); (window.toast||console.log)("Conectado"); }
  function onOffline(){ setBanner(true); (window.toast||console.log)("Sin conexión"); }
  window.addEventListener("online",  onOnline,  {passive:true});
  window.addEventListener("offline", onOffline, {passive:true});
  if (!navigator.onLine) onOffline();

  // Fetch con timeout
  async function fetchWithTimeout(url, opts={}, ms=12000){
    const ctrl = new AbortController();
    const t = setTimeout(()=> ctrl.abort(), ms);
    try{
      const res = await fetch(url, Object.assign({}, opts, { signal: ctrl.signal }));
      return res;
    }finally{ clearTimeout(t); }
  }

  // Backoff exponencial con jitter
  async function backoff(retry, fn){
    let attempt = 0;
    while (true){
      try{ return await fn(); }
      catch(e){
        attempt++;
        if (attempt > retry) throw e;
        const base = Math.min(1000 * Math.pow(2, attempt-1), 8000); // 1s,2s,4s,8s cap
        const jitter = Math.random() * 400;
        await new Promise(r=> setTimeout(r, base + jitter));
      }
    }
  }

  // Patch apiGet / apiPost para añadir timeout y reintentos
  (function patchAPIs(){
    const _apiGet  = window.apiGet;
    const _apiPost = window.apiPost;

    if (typeof _apiGet === "function" && !_apiGet.__netPatch__){
      window.apiGet = async function(q, opts){
        const u = new URL(window.API_BASE);
        Object.entries(q||{}).forEach(([k,v])=> u.searchParams.set(k, v));
        const retry = (opts && Number(opts.retry)) || 2;
        return backoff(retry, async ()=> {
          const r = await fetchWithTimeout(u.toString(), { credentials:"omit", cache:"no-cache" }, (opts && opts.timeout) || 12000);
          const data = await r.json();
          if (!r.ok) throw new Error("GET "+r.status);
          return data;
        });
      };
      window.apiGet.__netPatch__ = true;
    }

    if (typeof _apiPost === "function" && !_apiPost.__netPatch__){
      window.apiPost = async function(body, opts){
        const retry = (opts && Number(opts.retry)) || 2;
        return backoff(retry, async ()=> {
          const r = await fetchWithTimeout(window.API_BASE, {
            method:"POST", headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(body||{})
          }, (opts && opts.timeout) || 12000);
          const data = await r.json();
          if (!r.ok) throw new Error("POST "+r.status);
          return data;
        });
      };
      window.apiPost.__netPatch__ = true;
    }
  })();

  // Reintento silencioso de cargas iniciales si fallan por red
  (function patchInitialLoad(){
    const orig = window.__CDL_INITIAL_LOAD__ ? null : window.initialLoad;
    // Ya tienes un initialLoad autoejecutado; no lo tocamos si existe la bandera.
    // En su lugar, reforzamos las funciones de carga individuales con toques de retry extra.
    ["loadState","loadIncid","loadInv","loadRepSol","loadConsumibles","loadOT"].forEach(name=>{
      const fn = window[name];
      if (typeof fn !== "function" || fn.__retryWrapped__) return;
      window[name] = async function(){
        try{ return await fn.apply(this, arguments); }
        catch(e){
          // Un segundo intento rápido si es fallo de red
          try{ return await fn.apply(this, arguments); }
          catch(_){ (window.toast||console.log)(`No se pudo cargar: ${name}`); throw _; }
        }
      };
      window[name].__retryWrapped__ = true;
    });
  })();
})();
</script>
<!-- ===================== BLOQUE 25: Cache local (IndexedDB) para datos clave ===================== -->
<script>
(function(){
  if (window.__CDL_IDB_CACHE__) return; window.__CDL_IDB_CACHE__ = true;

  const DB_NAME = "cdl_cmms_cache";
  const DB_VER  = 1;
  const STORES  = ["state","incid","inv","rep","cons","ot"];
  let   dbp     = null;

  function openDB(){
    if (dbp) return dbp;
    dbp = new Promise((res, rej)=>{
      const req = indexedDB.open(DB_NAME, DB_VER);
      req.onupgradeneeded = (ev)=>{
        const db = ev.target.result;
        STORES.forEach(s => { if (!db.objectStoreNames.contains(s)) db.createObjectStore(s); });
      };
      req.onsuccess = ()=> res(req.result);
      req.onerror   = ()=> rej(req.error);
    });
    return dbp;
  }

  async function idbGet(store, key){ try{
    const db = await openDB();
    return await new Promise((res, rej)=>{
      const tx = db.transaction(store, "readonly");
      const os = tx.objectStore(store);
      const rq = os.get(key||"items");
      rq.onsuccess = ()=> res(rq.result);
      rq.onerror   = ()=> rej(rq.error);
    });
  }catch(_){ return null; } }

  async function idbSet(store, key, value){ try{
    const db = await openDB();
    return await new Promise((res, rej)=>{
      const tx = db.transaction(store, "readwrite");
      const os = tx.objectStore(store);
      os.put(value, key||"items");
      tx.oncomplete = ()=> res(true);
      tx.onerror    = ()=> rej(tx.error);
    });
  }catch(_){ return false; } }

  // Helper genérico: guarda en cache el resultado OK de apiGet
  async function cacheWrap(resName, loaderFn){
    try{
      const live = await loaderFn();
      if (live && Array.isArray(live.items)){
        await idbSet(resName, "items", { ts: Date.now(), items: live.items });
      }
      return live;
    }catch(err){
      // En fallo de red → intenta devolver cache
      const cached = await idbGet(resName, "items");
      if (cached && Array.isArray(cached.items)){
        (window.toast||console.log)(`Mostrando cache de ${resName}`);
        return { ok:true, items: cached.items, cached:true, ts: cached.ts };
      }
      throw err;
    }
  }

  // Parcheamos funciones de carga existentes para usar cacheWrap.
  function patch(name, resName, params){
    const orig = window[name];
    if (typeof orig !== "function" || orig.__idbPatched__) return;
    window[name] = async function(){
      const call = ()=> window.apiGet({ res: resName, fn: (params?.fn)||"list" });
      const r = await cacheWrap(resName, call);
      // set en variables globales + render (preservamos comportamiento original si lo había)
      if (resName==="state") window.STATE = r.items||[];
      if (resName==="incid") window.INCID = r.items||[];
      if (resName==="inv")   window.INV   = r.items||[];
      if (resName==="rep")   window.REP   = r.items||[];
      if (resName==="cons")  window.CONS  = r.items||[];
      if (resName==="ot")    window.OTS   = r.items||[];

      // Llamamos a los renders correspondientes si existen
      try{
        if (resName==="state") window.renderEquiposList?.();
        if (resName==="incid") window.renderIncidenciasTable?.(window.INCID);
        if (resName==="inv")   window.renderInv?.(window.INV);
        if (resName==="rep")   window.renderRepTable?.();
        if (resName==="cons")  window.renderConsTable?.();
        if (resName==="ot")    window.renderOTTable?.();
        window.renderTV?.();
      }catch(_){}
      return r;
    };
    window[name].__idbPatched__ = true;
  }

  patch("loadState","state");
  patch("loadIncid","incid");
  patch("loadInv","inv");
  patch("loadRepSol","rep");
  patch("loadConsumibles","cons");
  patch("loadOT","ot");

})();
</script>
<!-- ===================== BLOQUE 26: KPIs y minigráficas (sparkline en canvas) ===================== -->
<style>
#kpiBar{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
.kpi{display:flex;align-items:center;gap:.45rem;padding:.25rem .6rem;border:1px solid #e5e7eb;border-radius:12px;background:#fff}
.kpi b{font-size:1rem}
.kpi .mini{width:68px;height:22px;display:inline-block}
@media (prefers-color-scheme: dark){
  .kpi{background:#0b1016;border-color:#1f2937}
}
</style>
<script>
(function(){
  if (window.__CDL_KPI__) return; window.__CDL_KPI__ = true;

  function ensureBar(){
    const strip = document.getElementById("status-strip"); if (!strip) return null;
    if (document.getElementById("kpiBar")) return document.getElementById("kpiBar");
    const wrap = document.createElement("div");
    wrap.id="kpiBar";
    wrap.style.marginLeft = "auto";
    wrap.style.display = "flex";
    wrap.style.alignItems = "center";
    // Insertamos antes del "Última actualización" si existe
    const timeBox = strip.querySelector("#kUpdated")?.closest("div");
    const row = strip.querySelector("div>div"); // primera fila interior
    (timeBox ? strip.firstElementChild : row)?.appendChild(wrap);
    return wrap;
  }

  function drawSpark(el, points){
    const c = document.createElement("canvas");
    c.width = 136; c.height = 44;
    c.style.width="68px"; c.style.height="22px";
    const ctx = c.getContext("2d");
    const xs = points.map((_,i)=> i/(points.length-1));
    const min = Math.min(...points), max = Math.max(...points);
    const norm = v => (max === min) ? 0.5 : (v - min) / (max - min);
    // fondo tenue
    ctx.globalAlpha = .12; ctx.fillStyle = "#000"; ctx.fillRect(0,0,c.width,c.height);
    ctx.globalAlpha = 1;
    // línea
    ctx.lineWidth = 2;
    ctx.lineJoin = "round";
    ctx.lineCap = "round";
    ctx.strokeStyle = "#16a34a";
    ctx.beginPath();
    points.forEach((v,i)=>{
      const x = xs[i] * (c.width-8) + 4;
      const y = (1 - norm(v)) * (c.height-8) + 4;
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
    // punto final
    const lastX = xs[xs.length-1] * (c.width-8) + 4;
    const lastY = (1 - norm(points[points.length-1])) * (c.height-8) + 4;
    ctx.fillStyle = "#111827";
    ctx.beginPath(); ctx.arc(lastX,lastY,3,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle = "#111827"; ctx.lineWidth=1; ctx.stroke();
    el.innerHTML = ""; el.appendChild(c);
  }

  function seriesParadasUlt7(){
    // Serie simulada a partir de incidencias tipo "parada" por día (últimos 7)
    const now = new Date();
    const days = [...Array(7)].map((_,i)=> {
      const d = new Date(now); d.setDate(now.getDate() - (6-i));
      const day = d.toISOString().slice(0,10);
      const n = (window.INCID||[]).filter(x=>{
        const isP = String(x.tipo||"").toLowerCase()==="parada";
        const d0  = x.inicio ? new Date(x.inicio) : null;
        const k   = d0 ? d0.toISOString().slice(0,10) : "";
        return isP && k===day;
      }).length;
      return n;
    });
    return days;
  }

  function seriesRestrUlt7(){
    const now = new Date();
    return [...Array(7)].map((_,i)=>{
      const d = new Date(now); d.setDate(now.getDate() - (6-i));
      const day = d.toISOString().slice(0,10);
      const n = (window.INCID||[]).filter(x=>{
        const isR = String(x.tipo||"").toLowerCase()==="restricciones";
        const d0  = x.inicio ? new Date(x.inicio) : null;
        const k   = d0 ? d0.toISOString().slice(0,10) : "";
        return isR && k===day;
      }).length;
      return n;
    });
  }

  function mountKPIs(){
    const bar = ensureBar(); if (!bar) return;
    bar.innerHTML = `
      <span class="kpi"><span>Paradas 7d</span><span class="mini" id="kpiParadasMini"></span></span>
      <span class="kpi"><span>Restr. 7d</span><span class="mini" id="kpiRestrMini"></span></span>
    `;
    try{
      drawSpark(document.getElementById("kpiParadasMini"), seriesParadasUlt7());
      drawSpark(document.getElementById("kpiRestrMini"),  seriesRestrUlt7());
    }catch(_){}
  }

  // Refrescos suaves
  window.addEventListener("resize", ()=> mountKPIs(), {passive:true});
  const _renderTV = window.renderTV;
  window.renderTV = function(){
    _renderTV?.apply(this, arguments);
    mountKPIs();
  };

  document.addEventListener("DOMContentLoaded", mountKPIs);
})();
</script>
<!-- ===================== BLOQUE 27: Impresión mejorada (fichas y etiquetas con estilos dedicados) ===================== -->
<script>
(function(){
  if (window.__CDL_PRINT_TPL__) return; window.__CDL_PRINT_TPL__ = true;

  function printDoc(title, bodyHTML, extraCSS=""){
    const w = window.open("", "_blank");
    w.document.write(`<!doctype html><html><head><meta charset="utf-8">
      <title>${String(title||"Documento")}</title>
      <style>
        @media print { @page { margin: 10mm; } }
        body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:12px;color:#111827}
        h1{font-size:18px;margin:0 0 10px}
        .meta{display:flex;gap:16px;flex-wrap:wrap;margin:8px 0 12px}
        .meta div{padding:6px 10px;border:1px solid #e5e7eb;border-radius:8px;background:#fff}
        .qr{float:right;margin:6px}
        .tag{display:inline-block;font-weight:900;border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;margin-left:6px}
        .blk{border:1px solid #e5e7eb;border-radius:10px;padding:10px;margin:8px 0;background:#fff}
        ${extraCSS}
      </style></head><body>${bodyHTML}</body></html>`);
    w.document.close(); w.focus(); w.print();
  }

  // Ficha de equipo
  window.printEquipo = function(eq){
    if (!eq) return;
    const url = (window.baseURL?.()||location.href) + "#/equipo/" + encodeURIComponent(window.slugify?.(eq.nombre)||"");
    const html = `
      <h1>Ficha de equipo <span class="tag">${eq.estado||""}</span></h1>
      <div class="meta">
        <div><b>Equipo:</b> ${window.esc?.(eq.nombre)||eq.nombre}</div>
        <div><b>Grupo/Línea:</b> ${window.esc?.(eq.grupo)||eq.grupo||""}</div>
        <div><b>Últ. actualización:</b> ${new Date().toLocaleString("es-ES",{hour12:false})}</div>
      </div>
      <div class="blk">
        <div id="qrBox" class="qr"></div>
        <div><b>URL:</b> ${window.esc?.(url)||url}</div>
        <div style="margin-top:6px;color:#475569">Añadir detalles técnicos / checklist preventivo aquí…</div>
      </div>
      <script>
        (function(){
          function mk(){ if (!window.QRCode){ setTimeout(mk,120); return; }
            var q = new QRCode(document.getElementById('qrBox'), { text: ${JSON.stringify(url)}, width:112, height:112 });
          }
          mk();
        })();
      <\/script>
    `;
    printDoc(`Ficha — ${eq.nombre}`, html);
  };

  // Etiqueta de repuesto
  window.printRepuesto = function(it){
    if (!it) return;
    const url = (window.baseURL?.()||location.href) + "#/repuesto/" + encodeURIComponent(it.ref||"");
    const css = `
      .grid{display:grid;grid-template-columns:1fr auto;gap:8px}
      .lbl{font-size:14px}
      .big{font-size:18px;font-weight:900}
      .muted{color:#475569}
      .qr{margin-left:16px}
    `;
    const html = `
      <div class="grid">
        <div>
          <div class="lbl">Repuesto</div>
          <div class="big">${window.esc?.(it.nombre)||it.nombre}</div>
          <div class="lbl">Ref: <b>${window.esc?.(it.ref)||it.ref}</b></div>
          <div class="muted">Stock: ${it.stock} · Min: ${it.minimo}</div>
          <div class="muted">URL: ${window.esc?.(url)||url}</div>
        </div>
        <div><div id="qrBox" class="qr"></div></div>
      </div>
      <script>
        (function(){
          function mk(){ if (!window.QRCode){ setTimeout(mk,120); return; }
            var q = new QRCode(document.getElementById('qrBox'), { text: ${JSON.stringify(url)}, width:112, height:112 });
          }
          mk();
        })();
      <\/script>
    `;
    printDoc(`Etiqueta — ${it.ref}`, html, css);
  };

  // Reemplaza los botones básicos de imprimir de las fichas si existen
  (function patchFichaButtons(){
    const _renderEq = window.renderEquipoBySlug;
    if (typeof _renderEq === "function" && !_renderEq.__printPatched__){
      window.renderEquipoBySlug = function(slug){
        _renderEq.apply(this, arguments);
        try{
          const eq = (window.STATE||[]).find(x => (window.slugify?.(x.nombre)||"") === slug);
          const host = document.getElementById("equipoDetail");
          const btn = host?.querySelector('button.btn.gloss.btn-ficha');
          if (eq && btn){ btn.onclick = ()=> window.printEquipo(eq); }
        }catch(_){}
      };
      window.renderEquipoBySlug.__printPatched__ = true;
    }

    const _renderRep = window.renderRepuestoByRef;
    if (typeof _renderRep === "function" && !_renderRep.__printPatched__){
      window.renderRepuestoByRef = function(ref){
        _renderRep.apply(this, arguments);
        try{
          const it = (window.INV||[]).find(x => String(x.ref).toUpperCase() === String(ref).toUpperCase());
          const host = document.getElementById("repuestoDetail");
          const btns = host?.querySelectorAll('button.btn.gloss');
          // asumiendo el primer gloss es imprimir etiqueta en esa vista
          if (it && btns && btns[0]){ btns[0].onclick = ()=> window.printRepuesto(it); }
        }catch(_){}
      };
      window.renderRepuestoByRef.__printPatched__ = true;
    }
  })();

})();
</script>
<!-- ===================== BLOQUE 28: Modo offline + cola de POST (reintento automático) ===================== -->
<style>
#netBanner{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:12px; z-index:3200; padding:.45rem .75rem; border-radius:10px;
  font-weight:800; letter-spacing:.02em;
  border:1px solid #e5e7eb; background:#fff; color:#111827;
  box-shadow:0 10px 26px rgba(0,0,0,.12); display:none;
}
@media (prefers-color-scheme: dark){
  #netBanner{ background:#0b1016; border-color:#1f2937; color:#e5e7eb; }
}
#netBanner.bad{ border-color:#ef4444; }
#netBanner.ok{  border-color:#16a34a; }
</style>
<div id="netBanner" aria-live="polite" role="status"></div>
<script>
(function(){
  if (window.__CDL_OFFLINE__) return; window.__CDL_OFFLINE__ = true;

  const BANNER = document.getElementById('netBanner');
  let online = navigator.onLine;

  function showBanner(msg, cls){
    if (!BANNER) return;
    BANNER.textContent = msg;
    BANNER.className = cls ? cls : "";
    BANNER.style.display = "block";
    clearTimeout(BANNER.__t);
    BANNER.__t = setTimeout(()=>{ BANNER.style.display="none"; }, 3000);
  }

  window.addEventListener('online',  ()=>{ online=true;  showBanner("Conexión restaurada", "ok");  drainQueue(); });
  window.addEventListener('offline', ()=>{ online=false; showBanner("Sin conexión — acciones en cola", "bad"); });

  // Cola persistente de POST
  const QKEY = "CDL_POST_QUEUE_V1";
  function readQ(){ try{ return JSON.parse(localStorage.getItem(QKEY)||"[]"); }catch(_){ return []; } }
  function writeQ(arr){ try{ localStorage.setItem(QKEY, JSON.stringify(arr||[])); }catch(_){ } }
  async function drainQueue(){
    const q = readQ(); if (!q.length || !online) return;
    let rest = [];
    for (const item of q){
      try{
        const r = await fetch(window.API_BASE, {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(item.body)
        });
        if (!r.ok) throw new Error("HTTP "+r.status);
        const j = await r.json();
        if (!j?.ok) throw new Error("API not ok");
        (window.toast||console.log)(`Enviado en diferido: ${item.body?.res}/${item.body?.fn}`);
      }catch(e){
        // Mantener en cola para siguiente intento
        rest.push(item);
      }
    }
    writeQ(rest);
    if (rest.length===0) showBanner("Cola vaciada", "ok");
  }

  // Parchea apiPost para colar en queue si offline o falla red
  const _apiPost = window.apiPost;
  if (typeof _apiPost === "function" && !_apiPost.__offlinePatched__){
    window.apiPost = async function(body){
      // Si estamos offline → a la cola
      if (!navigator.onLine){
        const q = readQ(); q.push({ ts:Date.now(), body }); writeQ(q);
        (window.toast||console.log)(`En cola: ${body?.res}/${body?.fn}`);
        return { ok:false, queued:true, offline:true };
      }
      // Intento normal
      try{
        const r = await _apiPost(body);
        if (r?.ok) return r;
        // Si la API respondió mal, no encolamos por defecto
        return r;
      }catch(err){
        // Error de red → encolamos
        const q = readQ(); q.push({ ts:Date.now(), body }); writeQ(q);
        showBanner("Acción en cola (sin conexión)", "bad");
        return { ok:false, queued:true, offline:true };
      }
    };
    window.apiPost.__offlinePatched__ = true;
  }

  // Arranque inicial
  document.addEventListener("DOMContentLoaded", ()=>{
    if (!navigator.onLine) showBanner("Estás sin conexión", "bad");
    drainQueue();
  });
})();
</script>
<!-- ===================== BLOQUE 29: Modo TV/Kiosko (fullscreen + autorefresco + anti-burn-in) ===================== -->
<style>
#tvToolbar{
  display:flex; gap:.5rem; align-items:center; justify-content:flex-end;
  margin:.4rem 0;
}
#tvToolbar .btn{ padding:.28rem .6rem; }
.tv-nudge{
  position:fixed; inset:auto 10px 10px auto; width:8px; height:8px; border-radius:50%;
  background:#e5e7eb; opacity:.08; pointer-events:none; transition:transform 8s linear;
}
</style>
<script>
(function(){
  if (window.__CDL_TV_MODE__) return; window.__CDL_TV_MODE__ = true;

  function ensureToolbar(){
    const sec = document.getElementById("page-tv"); if (!sec) return null;
    if (sec.__toolbar__) return sec.__toolbar__;
    const tb = document.createElement("div");
    tb.id = "tvToolbar";
    tb.innerHTML = `
      <button class="btn" id="btnTVFs" title="Pantalla completa">Pantalla completa</button>
      <button class="btn" id="btnTV60" title="Refrescar cada 60s">Auto 60s</button>
      <button class="btn" id="btnTVStop" title="Detener auto-refresco">Parar</button>
    `;
    sec.prepend(tb);
    sec.__toolbar__ = tb;
    return tb;
  }

  let timer=null;
  function startAuto(ms=60000){
    stopAuto();
    timer = setInterval(()=> window.renderTV?.(), ms);
    (window.toast||console.log)(`Auto-refresco ${ms/1000}s`);
  }
  function stopAuto(){ if (timer){ clearInterval(timer); timer=null; (window.toast||console.log)("Auto-refresco detenido"); } }

  function goFullscreen(){
    const elem = document.documentElement;
    if (elem.requestFullscreen) elem.requestFullscreen();
    else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
  }

  // Anti-burn-in: mueve un punto transparente de vez en cuando
  let nudge=null, jig=null;
  function startNudge(){
    if (nudge) return;
    nudge = document.createElement("div"); nudge.className="tv-nudge";
    document.body.appendChild(nudge);
    jig = setInterval(()=>{
      const x = 4 + Math.random()*24;
      const y = 4 + Math.random()*24;
      nudge.style.transform = `translate(${x}px, ${y}px)`;
    }, 8000);
  }
  function stopNudge(){ if (jig){ clearInterval(jig); jig=null; } if(nudge){ nudge.remove(); nudge=null; } }

  document.addEventListener("DOMContentLoaded", ()=>{
    const tb = ensureToolbar(); if (!tb) return;
    tb.querySelector("#btnTVFs")?.addEventListener("click", goFullscreen);
    tb.querySelector("#btnTV60")?.addEventListener("click", ()=> startAuto(60000));
    tb.querySelector("#btnTVStop")?.addEventListener("click", stopAuto);
    // arranque suave
    startAuto(60000);
    startNudge();
  });

  // al cambiar de página, si salimos de TV, detener timers
  const _nav = window.nav;
  window.nav = function(page){
    _nav?.apply(this, arguments);
    if (page!=="tv") stopAuto(); else startAuto(60000);
  };
})();
</script>
<!-- ===================== BLOQUE 30: Log de auditoría local + vista en “Histórico de logs” ===================== -->
<style>
.log-card{border:1px solid #e5e7eb;border-radius:12px;padding:.6rem .8rem;background:#fff}
@media (prefers-color-scheme: dark){
  .log-card{background:#0b1016;border-color:#1f2937}
}
#logsWrap .filters{display:flex;gap:.5rem;flex-wrap:wrap;margin:.4rem 0}
#logsWrap table{width:100%;border-collapse:collapse}
#logsWrap th, #logsWrap td{border-top:1px solid #e5e7eb;padding:.45rem .5rem;text-align:left}
#logsWrap thead th{background:#f8fafc}
@media (prefers-color-scheme: dark){
  #logsWrap th, #logsWrap td{border-color:#151b22}
  #logsWrap thead th{background:#0e141b;color:#e7eaef}
}
</style>
<script>
(function(){
  if (window.__CDL_AUDIT__) return; window.__CDL_AUDIT__ = true;

  const K="CDL_AUDIT_LOG_V1";

  function addLog({kind="info", actor, action, payload}){
    try{
      const arr = JSON.parse(localStorage.getItem(K)||"[]");
      arr.unshift({
        ts: Date.now(),
        actor: actor || (window.USER?.user||"anon"),
        kind, action, payload
      });
      // Limitar a 2000 entradas locales
      if (arr.length>2000) arr.length = 2000;
      localStorage.setItem(K, JSON.stringify(arr));
    }catch(_){}
  }
  function getLogs(){ try{ return JSON.parse(localStorage.getItem(K)||"[]"); }catch(_){ return []; } }

  // Hook apiPost/apiGet para auditar
  const _apiPost = window.apiPost;
  if (typeof _apiPost==="function" && !_apiPost.__auditPatched__){
    window.apiPost = async function(body){
      addLog({ kind:"post", action:`${body?.res}/${body?.fn}`, payload: body });
      const r = await _apiPost(body);
      addLog({ kind:"post:resp", action:`${body?.res}/${body?.fn}`, payload: r });
      return r;
    };
    window.apiPost.__auditPatched__ = true;
  }
  const _apiGet = window.apiGet;
  if (typeof _apiGet==="function" && !_apiGet.__auditPatched__){
    window.apiGet = async function(qs){
      addLog({ kind:"get", action:`${qs?.res}/${qs?.fn||"list"}`, payload: qs });
      const r = await _apiGet(qs);
      addLog({ kind:"get:resp", action:`${qs?.res}/${qs?.fn||"list"}`, payload: r });
      return r;
    };
    window.apiGet.__auditPatched__ = true;
  }

  // Render en la página “Histórico de logs” (page-logs)
  function renderLogs(){
    const host = document.getElementById("logsWrap"); if (!host) return;
    const data = getLogs();

    if (!data.length){
      host.innerHTML = `<div class="log-card">Sin registros todavía</div>`;
      return;
    }
    const rows = data.slice(0,500).map(l=>{
      const d = new Date(l.ts).toLocaleString("es-ES",{hour12:false});
      const act = (l.action||"");
      const who = (l.actor||"anon");
      const kind= (l.kind||"info");
      const pay = window.esc?.(JSON.stringify(l.payload)) || "";
      return `<tr>
        <td>${d}</td>
        <td>${window.esc?.(who)||who}</td>
        <td><span class="badge">${window.esc?.(kind)||kind}</span></td>
        <td>${window.esc?.(act)||act}</td>
        <td style="max-width:520px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${pay}</td>
      </tr>`;
    }).join("");

    host.innerHTML = `
      <div class="log-card">
        <div class="filters">
          <button class="btn gloss" id="btnLogsExport">Exportar JSON</button>
          <button class="btn gloss" id="btnLogsClear">Borrar</button>
        </div>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr><th>Fecha</th><th>Usuario</th><th>Tipo</th><th>Acción</th><th>Payload</th></tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      </div>
    `;

    host.querySelector("#btnLogsExport")?.addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(getLogs(),null,2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `logs_cdl_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    });
    host.querySelector("#btnLogsClear")?.addEventListener("click", ()=>{
      if (!confirm("¿Borrar el histórico local de logs?")) return;
      localStorage.removeItem(K);
      renderLogs();
    });
  }

  // Auto-render al entrar en la sección de logs
  const _nav = window.nav;
  window.nav = function(page){
    _nav?.apply(this, arguments);
    if (page==="logs") renderLogs();
  };
  // Si ya estamos en logs al cargar
  document.addEventListener("DOMContentLoaded", ()=>{
    if (location.hash.replace(/^#\/?/,"")==="logs") renderLogs();
  });

  // Exponer por si se quiere forzar manualmente
  window.renderAuditLogs = renderLogs;
})();
</script>
<!-- ===================== BLOQUE 31: Accesibilidad avanzada (roles, focus-trap, atajos ARIA) ===================== -->
<script>
(function(){
  if (window.__CDL_A11Y_ADV__) return; window.__CDL_A11Y_ADV__ = true;

  // 1) Focus trap cuando un panel está en modo fullscreen (móvil)
  function trapFocus(panel){
    if (!panel) return;
    const FOCUSABLE = 'a,button,input,select,textarea,[tabindex]:not([tabindex="-1"])';
    const list = [...panel.querySelectorAll(FOCUSABLE)].filter(el=> !el.hasAttribute('disabled') && el.tabIndex !== -1);
    if (!list.length) return;
    const first = list[0], last = list[list.length - 1];

    function onKey(e){
      if (e.key !== 'Tab') return;
      if (e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
      else if (!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
    }
    panel.__trapKey__ && panel.removeEventListener('keydown', panel.__trapKey__, true);
    panel.__trapKey__ = onKey;
    panel.addEventListener('keydown', onKey, true);

    // Forzar foco inicial
    requestAnimationFrame(()=> first.focus());
  }

  // Integración con los menús existentes
  const pagesBtn = document.getElementById('pagesBtn');
  const pagesPanel = document.getElementById('pagesPanel');
  const userBtn = document.getElementById('userBtn');
  const userPanel = document.getElementById('userPanel');

  const mo = new MutationObserver(()=>{
    if (pagesPanel && !pagesPanel.classList.contains('hidden') && pagesPanel.classList.contains('menu-full')) trapFocus(pagesPanel);
    if (userPanel  && !userPanel .classList.contains('hidden') && userPanel .classList.contains('menu-full')) trapFocus(userPanel);
  });
  mo.observe(document.documentElement, { subtree:true, attributes:true, attributeFilter:['class'] });

  // 2) Aumenta la información ARIA en runtime
  document.addEventListener('DOMContentLoaded', ()=>{
    const hdr = document.querySelector('header');
    hdr?.setAttribute('role','banner');

    const main = document.querySelector('main');
    main?.setAttribute('role','main');

    document.querySelectorAll('[id^="page-"]').forEach(sec=>{
      const name = (sec.querySelector('h2')?.textContent || 'Sección').trim();
      sec.setAttribute('role','region');
      sec.setAttribute('aria-label', name);
    });

    // Botones de estado con ARIA-pressed cuando aplique
    document.body.addEventListener('click', (e)=>{
      const b = e.target.closest('button[aria-pressed]');
      if (!b) return;
      const v = !(b.getAttribute('aria-pressed')==='true');
      b.setAttribute('aria-pressed', String(v));
    }, {passive:true});
  });

  // 3) Anunciar cambios de estado de equipo por ARIA live
  let live = document.getElementById('ariaLive');
  if (!live){
    live = document.createElement('div');
    live.id = 'ariaLive';
    live.setAttribute('aria-live','polite');
    live.setAttribute('role','status');
    live.style.position='absolute'; live.style.left='-9999px'; live.style.height='1px'; live.style.overflow='hidden';
    document.body.appendChild(live);
  }
  function announce(msg){ if (!live) return; live.textContent = msg; }

  // Hook en setEquipoEstado si existe
  if (typeof window.setEquipoEstado === 'function' && !window.setEquipoEstado.__ariaPatched__){
    const _set = window.setEquipoEstado;
    window.setEquipoEstado = async function(nombre, estado){
      const r = await _set.apply(this, arguments);
      try{ announce(`Estado de ${nombre}: ${estado}`); }catch(_){}
      return r;
    };
    window.setEquipoEstado.__ariaPatched__ = true;
  }

})();
</script>
<!-- ===================== BLOQUE 32: Rendimiento — lazy ops, requestIdleCallback, prefetch inteligente ===================== -->
<script>
(function(){
  if (window.__CDL_PERF__) return; window.__CDL_PERF__ = true;

  // Polyfill muy simple de requestIdleCallback
  window.requestIdleCallback = window.requestIdleCallback || function(cb){ return setTimeout(()=>cb({timeRemaining:()=>50, didTimeout:false}), 1); };
  window.cancelIdleCallback  = window.cancelIdleCallback  || function(id){ clearTimeout(id); };

  // 1) Prefetch de rutas que se usan más (hover/focus en menú)
  function prefetchDataFor(page){
    // Decide qué datos cargar antes según la sección
    if (page==='equipos')      loadState?.();
    else if (page==='incidencias') loadIncid?.();
    else if (page==='inventario')  loadInv?.();
    else if (page==='repuestos')   loadRepSol?.();
    else if (page==='consumibles') loadConsumibles?.();
    else if (page==='ot')          loadOT?.();
    else if (page==='tv'){ loadState?.(); loadRepSol?.(); loadOT?.(); }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const pagesPanel = document.getElementById('pagesPanel');
    if (!pagesPanel) return;
    pagesPanel.addEventListener('mouseover', (e)=>{
      const b = e.target.closest('button'); if (!b) return;
      const txt = (b.textContent||'').toLowerCase();
      const map = {
        'equipos':'equipos','puentes grúa':'gruas','otros':'otros','incidencias':'incidencias',
        'indicadores':'indicadores','ot':'ot','inventario':'inventario','repuestos solicitados':'repuestos',
        'consumibles':'consumibles','dashboard tv':'tv','personal':'personal','histórico de logs':'logs'
      };
      const page = map[txt]; if (!page) return;
      requestIdleCallback(()=> prefetchDataFor(page));
    }, {passive:true});
  });

  // 2) Degradar refrescos no críticos al idle
  function deferNonCritical(){
    // Recalcular --hdr-h y timestamp del resumen en idle
    requestIdleCallback(()=> window.updateSummaryTimestamp?.());
    requestIdleCallback(()=> {
      const hdr = document.querySelector('header');
      const h = Math.max(64, hdr?.offsetHeight||0);
      document.documentElement.style.setProperty('--hdr-h', h+'px');
    });
    // Pintar TV si estamos en esa sección
    if (location.hash.replace(/^#\/?/,'')==='tv'){
      requestIdleCallback(()=> window.renderTV?.());
    }
  }
  if (document.readyState !== 'loading') deferNonCritical();
  else document.addEventListener('DOMContentLoaded', deferNonCritical);

  // 3) Imagenes lazy (marca data-src → src en idle)
  function lazyImages(){
    const imgs = [...document.querySelectorAll('img[data-src]')];
    if (!imgs.length) return;
    const swap = (im)=>{ im.setAttribute('src', im.getAttribute('data-src')); im.removeAttribute('data-src'); };
    if ('IntersectionObserver' in window){
      const io = new IntersectionObserver((entries)=>{
        entries.forEach(en=>{
          if (en.isIntersecting){ swap(en.target); io.unobserve(en.target); }
        });
      });
      imgs.forEach(im=> io.observe(im));
    }else{
      requestIdleCallback(()=> imgs.forEach(swap));
    }
  }
  document.addEventListener('DOMContentLoaded', lazyImages);

  // 4) Mini cache en memoria de respuestas GET recientes
  const _apiGet = window.apiGet;
  if (typeof _apiGet === 'function' && !_apiGet.__memCache__){
    const cache = new Map(); // key → {ts, data}
    window.apiGet = async function(q){
      try{
        const u = new URL(window.API_BASE);
        Object.entries(q||{}).forEach(([k,v])=> u.searchParams.set(k, v));
        const key = u.toString();
        const hit = cache.get(key);
        if (hit && (Date.now()-hit.ts)<15_000){ return hit.data; } // 15s
        const r = await _apiGet(q);
        cache.set(key, {ts:Date.now(), data:r});
        return r;
      }catch(e){ return _apiGet(q); }
    };
    window.apiGet.__memCache__ = true;
  }

})();
</script>
<!-- ===================== BLOQUE 33: Control de errores global + timeout de fetch + UI de fallos ===================== -->
<style>
#errorBar{
  position:fixed; top:calc(var(--safe-top,0px) + 6px); left:50%; transform:translateX(-50%);
  max-width:min(720px,92vw); z-index:3500;
  background:#fee2e2; color:#7f1d1d; border:1px solid #fecaca; border-radius:12px;
  padding:.55rem .75rem; box-shadow:0 12px 30px rgba(0,0,0,.12); display:none; font-weight:800;
}
#errorBar .act{ float:right; margin-left:.6rem; text-decoration:underline; cursor:pointer; }
@media (prefers-color-scheme: dark){
  #errorBar{ background:#2b0d0d; color:#fecaca; border-color:#7f1d1d; }
}
</style>
<div id="errorBar" role="alert" aria-live="assertive"></div>
<script>
(function(){
  if (window.__CDL_ERR_GUARD__) return; window.__CDL_ERR_GUARD__ = true;

  const E = document.getElementById('errorBar');
  function showError(msg, {retry=null, detail=null}={}){
    if (!E) return;
    const bRetry = retry ? `<span class="act" id="errRetry">Reintentar</span>` : '';
    const bDet   = detail ? `<span class="act" id="errDetail">Detalles</span>` : '';
    E.innerHTML = `${bRetry}${bDet}${String(msg||'Ha ocurrido un error')}`;
    E.style.display = 'block';
    clearTimeout(E.__t);
    E.__t = setTimeout(()=> E.style.display='none', 6000);
    if (retry) E.querySelector('#errRetry')?.addEventListener('click', retry);
    if (detail) E.querySelector('#errDetail')?.addEventListener('click', ()=> alert(detail));
  }

  // 1) Wrapper fetch con timeout por defecto
  const NATIVE_FETCH = window.fetch.bind(window);
  async function fetchWithTimeout(input, init, ms=12000){
    const ctrl = new AbortController();
    const id = setTimeout(()=> ctrl.abort(), ms);
    try{
      const r = await NATIVE_FETCH(input, { ...(init||{}), signal: ctrl.signal });
      clearTimeout(id);
      return r;
    }catch(e){
      clearTimeout(id);
      throw e;
    }
  }

  // 2) Parchea apiGet/apiPost para usar timeout y mostrar errores
  const _apiGet = window.apiGet;
  if (typeof _apiGet === 'function' && !_apiGet.__timeout__){
    window.apiGet = async function(q){
      try{
        const u = new URL(window.API_BASE);
        Object.entries(q||{}).forEach(([k,v])=> u.searchParams.set(k, v));
        const r = await fetchWithTimeout(u.toString(), { credentials:"omit", cache:"no-cache" }, 12000);
        if (!r.ok) throw new Error(`GET ${u.pathname} → HTTP ${r.status}`);
        return await r.json();
      }catch(err){
        console.error('apiGet error', err);
        showError('Fallo al cargar datos', { retry: ()=> apiGet(q), detail: String(err?.message||err) });
        throw err;
      }
    };
    window.apiGet.__timeout__ = true;
  }

  const _apiPost = window.apiPost;
  if (typeof _apiPost === 'function' && !_apiPost.__timeout__){
    window.apiPost = async function(body){
      try{
        const r = await fetchWithTimeout(window.API_BASE, {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(body||{})
        }, 12000);
        if (!r.ok) throw new Error(`POST ${new URL(window.API_BASE).pathname} → HTTP ${r.status}`);
        const j = await r.json();
        if (!j?.ok) throw new Error('API respondió ok=false');
        return j;
      }catch(err){
        console.error('apiPost error', err);
        // Si el parche de offline está activo, este error quizá se encole; aún así avisamos
        showError('No se pudo enviar la acción', { retry: ()=> apiPost(body), detail: String(err?.message||err) });
        throw err;
      }
    };
    window.apiPost.__timeout__ = true;
  }

  // 3) Captura global de errores JS
  window.addEventListener('error', (ev)=>{
    const msg = ev?.message || 'Error de script';
    const file = ev?.filename?.split('/').pop() || '';
    showError(`Error: ${msg}`, { detail:`${file}:${ev?.lineno||0}` });
  });
  window.addEventListener('unhandledrejection', (ev)=>{
    const m = (ev?.reason && (ev.reason.message || ev.reason.toString())) || 'Promesa rechazada';
    showError(m);
  });

})();
</script>
<!-- ===================== BLOQUE 34: Modo offline + cola de acciones (enqueue → flush en reconexión) ===================== -->
<style>
#netBadge{
  position:fixed; right:12px; bottom:12px; z-index:3600;
  display:flex; align-items:center; gap:.45rem;
  padding:.38rem .6rem; border-radius:999px; font-weight:800; font-size:.9rem;
  border:1px solid #1f2937; background:#0b0f15; color:#e5e7eb; box-shadow:0 8px 20px rgba(0,0,0,.35);
}
#netBadge .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }
#netBadge .ok{   background:#16a34a; }
#netBadge .warn{ background:#f59e0b; }
#netBadge .stop{ background:#dc2626; }
#netBadge small{ opacity:.7; font-weight:700 }
@media (prefers-color-scheme: light){
  #netBadge{ background:#fff; color:#111; border-color:#cbd5e1; box-shadow:0 8px 20px rgba(0,0,0,.12); }
}
</style>
<div id="netBadge" aria-live="polite" role="status" style="display:none">
  <span class="dot ok" id="netDot"></span><span id="netTxt">Conectado</span>
  <small id="netQueue" style="display:none">· 0 en cola</small>
</div>
<script>
(function(){
  if (window.__CDL_OFFLINE_QUEUE__) return; window.__CDL_OFFLINE_QUEUE__ = true;

  const KEY = 'CDL_QUEUE_V1';
  const badge = document.getElementById('netBadge');
  const dot   = document.getElementById('netDot');
  const txt   = document.getElementById('netTxt');
  const qlbl  = document.getElementById('netQueue');

  function readQ(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch(_){ return []; } }
  function writeQ(arr){ try{ localStorage.setItem(KEY, JSON.stringify(arr||[])); }catch(_){ /* ignore */ } }
  function qsize(){ return readQ().length; }

  function setBadge(state, qn){
    if (!badge) return;
    badge.style.display = 'flex';
    dot.className = 'dot ' + (state==='on' ? 'ok' : state==='sync' ? 'warn' : 'stop');
    txt.textContent = state==='on' ? 'Conectado' : state==='sync' ? 'Reconectando…' : 'Sin conexión';
    if (qn>0){ qlbl.style.display='inline'; qlbl.textContent = `· ${qn} en cola`; }
    else { qlbl.style.display='none'; }
  }

  // Encola una acción de POST
  async function enqueueAction(payload){
    const q = readQ();
    q.push({ t:Date.now(), body:payload });
    writeQ(q);
    setBadge(navigator.onLine ? 'sync':'off', q.length);
    (window.toast||console.log)('Acción guardada offline');
  }

  // Intenta vaciar la cola (FIFO)
  async function flushQueue(){
    const q = readQ(); if (!q.length) { setBadge(navigator.onLine?'on':'off', 0); return; }
    if (!navigator.onLine){ setBadge('off', q.length); return; }
    setBadge('sync', q.length);
    while (q.length){
      const next = q[0];
      try{
        const res = await window.apiPostOnline?.(next.body); // llamada directa sin encolar otra vez
        if (!res?.ok){ throw new Error('API ok=false'); }
        q.shift(); writeQ(q);
        setBadge('sync', q.length);
      }catch(e){
        // Si falla red, cortamos y esperamos siguiente reconexión
        console.warn('flushQueue error', e);
        setBadge(navigator.onLine?'sync':'off', q.length);
        break;
      }
    }
    if (!q.length) setBadge('on', 0);
  }

  // Parcheo apiPost para encolar si no hay red o si falla por motivo de red
  const _apiPost = window.apiPost;
  if (typeof _apiPost === 'function' && !_apiPost.__offlinePatch__){
    // guardamos un canal "online only" para el flush
    window.apiPostOnline = async function(body){ return await _apiPost(body); };

    window.apiPost = async function(body){
      // Si sin conexión → encola y resuelve respuesta simulada
      if (!navigator.onLine){ await enqueueAction(body); return { ok:true, queued:true }; }
      try{
        const r = await _apiPost(body);
        return r;
      }catch(err){
        // Si falla por abort/network → encola
        const msg = (err && (err.message||String(err))) || '';
        if (/AbortError|NetworkError|Failed to fetch|TypeError/i.test(msg)){
          await enqueueAction(body);
          return { ok:true, queued:true };
        }
        throw err;
      }finally{
        // intenta vaciar en segundo plano
        flushQueue();
      }
    };
    window.apiPost.__offlinePatch__ = true;
  }

  // Eventos de red
  window.addEventListener('online', ()=> flushQueue());
  window.addEventListener('offline',()=> setBadge('off', qsize()));

  // Boot estado inicial
  setTimeout(()=> setBadge(navigator.onLine?'on':'off', qsize()), 0);
  // Intento periódico de flush si hay cola
  setInterval(()=> { if (qsize()>0) flushQueue(); }, 15000);
})();
</script>
<!-- ===================== BLOQUE 35: KPIs rápidos (MTTR/MTBF estimado, tooltips y actualización unificada) ===================== -->
<script>
(function(){
  if (window.__CDL_KPIS__) return; window.__CDL_KPIS__ = true;

  // Utilidades simples
  const safeDate = (d)=> { const x=new Date(d); return isNaN(x)?null:x; };

  window.calcKPIs = function(){
    try{
      const S = (window.STATE||[]);
      const I = (window.INCID||[]);

      // Totales por estado (ya los calcula loadState, aquí reforzamos por si se llama aislado)
      const nStop = S.filter(x=>x.estado==="Parada").length;
      const nWarn = S.filter(x=>x.estado==="Restricciones").length;
      const nOk   = S.filter(x=>x.estado==="En marcha").length;
      const all   = S.length;
      const set = (id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=v; };
      set('kStop', nStop); set('kWarn', nWarn); set('kOk', nOk); set('kAll', all);

      // MTTR (tiempo medio de reparación) y MTBF (tiempo medio entre fallos) aproximados de las incidencias cerradas/abiertas
      const closes = I.map(x=>{
        const ini=safeDate(x.inicio), fin=safeDate(x.fin);
        return { ini, fin, equipo:x.equipo, tipo:(x.tipo||'').toLowerCase() };
      }).filter(x=>x.ini);

      const repairs = closes.filter(x=>x.fin && /parad|aver[ií]a|fall|incid/i.test(x.tipo));
      const mttrMs  = repairs.length ? repairs.reduce((a,b)=> a + (b.fin - b.ini), 0) / repairs.length : 0;

      // Para MTBF: tomamos separaciones entre inicios por equipo (paradas/fallos)
      const byEq = new Map();
      closes.filter(x=> /parad|aver[ií]a|fall|incid/i.test(x.tipo))
            .forEach(x=>{
              const arr = byEq.get(x.equipo)||[];
              arr.push(x); byEq.set(x.equipo, arr);
            });

      let gaps = [];
      byEq.forEach(arr=>{
        arr.sort((a,b)=> a.ini-b.ini);
        for (let i=1;i<arr.length;i++){
          gaps.push(arr[i].ini - arr[i-1].ini);
        }
      });
      const mtbfMs = gaps.length ? gaps.reduce((a,b)=>a+b,0)/gaps.length : 0;

      const fmtH = (ms)=> ms ? (ms/3600000).toFixed(1)+' h' : '—';

      // Ponemos como "title" en las cápsulas del resumen
      const stop = document.getElementById('sumStop');
      const warn = document.getElementById('sumWarn');
      const ok   = document.getElementById('sumOk');
      [stop,warn,ok].forEach(el=>{ if(el) el.setAttribute('title', `MTTR: ${fmtH(mttrMs)} · MTBF: ${fmtH(mtbfMs)}`); });

    }catch(e){ console.warn('calcKPIs error', e); }
  };

  // Ejecuta cuando cambian datasets clave
  ['loadState','loadIncid'].forEach(fn=>{
    const orig = window[fn];
    if (typeof orig === 'function' && !orig.__kpiPatch__){
      window[fn] = async function(){
        const r = await orig.apply(this, arguments);
        try{ window.calcKPIs?.(); }catch(_){}
        return r;
      };
      window[fn].__kpiPatch__ = true;
    }
  });

  // Primer cálculo al cargar
  if (document.readyState !== 'loading') setTimeout(()=> window.calcKPIs?.(), 0);
  else document.addEventListener('DOMContentLoaded', ()=> window.calcKPIs?.());
})();
</script>
<!-- ===================== BLOQUE 36: Impresión mejorada (print CSS) + helper para imprimir Dashboard TV ===================== -->
<style>
@media print{
  /* Simplifica colores y fondos para papel */
  *{ box-shadow:none!important; text-shadow:none!important; }
  body{ background:#fff!important; color:#000!important; }
  header, #pagesPanel, #userPanel, #netBadge, #errorBar{ display:none!important; }
  a::after{ content:" (" attr(href) ")"; font-size:90%; color:#555; }
  .card, table{ border:1px solid #999!important; }
  thead th{ background:#eee!important; color:#000!important; }
  #status-strip{ border:0!important; }
  .tv-card{ page-break-inside:avoid; }
  @page{ margin:12mm; }
}
</style>
<script>
(function(){
  if (window.__CDL_PRINT_HELPERS__) return; window.__CDL_PRINT_HELPERS__ = true;

  // Genera HTML del Dashboard TV para imprimir/exportar
  window.printDashboardTV = function(){
    try{
      const sec = document.getElementById('page-tv');
      if (!sec){ alert('No se encontró la sección TV'); return; }
      // Garantiza que el contenido esté renderizado
      window.renderTV?.();

      const sel = ['tvParadas','tvRestr','tvRep','tvPrev'];
      const blocks = sel.map(id=>{
        const host = document.getElementById(id);
        const title = host?.closest('.tv-card')?.querySelector('h3')?.textContent || id;
        const items = host ? host.innerHTML : '';
        return `<article style="margin:10px 0"><h3 style="margin:0 0 6px">${title}</h3><div>${items}</div></article>`;
      }).join("");

      const html = `<h1 style="font:700 18px Inter,Arial,sans-serif">Dashboard TV</h1>${blocks}`;
      (window.printHTML||((t,h)=>{ const w=window.open('','_blank'); w.document.write(h); w.document.close(); w.print(); }))('Dashboard TV', html);
    }catch(e){
      console.error(e); alert('No se pudo preparar la impresión del Dashboard');
    }
  };
})();
</script>
<!-- ===================== BLOQUE 37: Accesibilidad mejorada (skip link, focus-visible, focus trap en paneles) ===================== -->
<style>
/* Visibilidad clara para foco por teclado */
:root { --focus: #60a5fa; }
:where(button,[role="button"],a,select,input,textarea):focus-visible{
  outline: 3px solid var(--focus);
  outline-offset: 2px;
  border-radius: 8px;
}
/* Enlace “Saltar al contenido” */
.skip-link{
  position:fixed; left:12px; top:12px; z-index:4000;
  padding:.45rem .7rem; font-weight:800; border-radius:10px;
  background:#0b0f15; color:#e5e7eb; border:1px solid #1f2937;
  transform:translateY(-140%); transition:transform .18s ease;
}
.skip-link:focus{ transform:translateY(0); }
@media (prefers-color-scheme: light){
  .skip-link{ background:#fff; color:#111; border-color:#cbd5e1; }
}
</style>
<a class="skip-link" href="#mainContent">Saltar al contenido</a>
<script>
(function(){
  if (window.__CDL_A11Y__) return; window.__CDL_A11Y__=true;

  // Marca el main como destino del skip-link
  (function ensureMainId(){
    const main = document.querySelector('main');
    if (main && !main.id) main.id = 'mainContent';
  })();

  // Focus trap ligero para paneles abiertos (menú páginas / usuario en modo fullscreen)
  const PANELS = ['#pagesPanel.menu-full','#userPanel.menu-full'];
  let lastFocus = null;

  function getTrapNodes(){
    const sel = PANELS.map(s=>document.querySelector(s)).filter(Boolean);
    if (!sel.length) return null;
    const root = sel[0];
    const focusables = root.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
    return { root, nodes: Array.from(focusables) };
  }

  document.addEventListener('keydown', (e)=>{
    if (e.key !== 'Tab') return;
    const trap = getTrapNodes(); if (!trap) return;
    const {nodes} = trap; if (!nodes.length) return;
    const first = nodes[0], last = nodes[nodes.length-1];
    if (e.shiftKey){
      if (document.activeElement === first){ e.preventDefault(); last.focus(); }
    }else{
      if (document.activeElement === last){ e.preventDefault(); first.focus(); }
    }
  }, { passive:false });

  // Guardado / restauración de foco al abrir/cerrar paneles
  const openObserver = new MutationObserver(()=>{
    const anyOpen = getTrapNodes();
    if (anyOpen){
      if (!lastFocus) lastFocus = document.activeElement;
      // Enfoca primer elemento del panel
      setTimeout(()=> anyOpen.nodes[0]?.focus(), 0);
    }else if (lastFocus){
      setTimeout(()=> { try{ lastFocus.focus(); }catch(_){} lastFocus=null; }, 0);
    }
  });
  openObserver.observe(document.documentElement, { attributes:true, attributeFilter:['class'], subtree:true });

  // Roles ARIA mínimos
  document.getElementById('pagesPanel')?.setAttribute('role','dialog');
  document.getElementById('userPanel') ?.setAttribute('role','dialog');
})();
</script>
<!-- ===================== BLOQUE 38: Scheduler unificado (pausa con pestaña oculta, backoff y jitter) ===================== -->
<script>
(function(){
  if (window.__CDL_SCHED__) return; window.__CDL_SCHED__=true;

  const tasks = new Map();

  function jitter(ms){ return Math.max(250, ms * (0.9 + Math.random()*0.2)); }

  function start(t){
    stop(t.name);
    const tick = async ()=>{
      try{ await t.fn(); }
      catch(e){ /* silencioso: el backoff puede gestionarse arriba si se desea */ }
      const next = t.backoff && t.backoff.err ? Math.min(t.max||60000, t.ms*2) : t.ms;
      t._timer = setTimeout(tick, jitter(next));
      t.backoff && (t.backoff.err=false);
    };
    t._timer = setTimeout(tick, jitter(t.ms));
  }

  function stop(name){
    const t = tasks.get(name);
    if (t && t._timer){ clearTimeout(t._timer); t._timer=null; }
  }

  function register(name, fn, ms, opts={}){
    const t = { name, fn, ms, ...opts, _timer:null };
    tasks.set(name, t);
    if (!document.hidden) start(t);
    return ()=> stop(name);
  }

  function pauseAll(){ tasks.forEach(t=> stop(t.name)); }
  function resumeAll(){ tasks.forEach(t=> start(t)); }

  document.addEventListener('visibilitychange', ()=>{
    if (document.hidden) pauseAll();
    else resumeAll();
  }, { passive:true });

  window.SCHED = { register, stop, pauseAll, resumeAll };

  // === Integraciones suaves (solo si existen) ===
  // Refresco de TV (sustituye a setInterval si estaba)
  if (typeof window.renderTV === 'function'){
    SCHED.register('tv-refresh', window.renderTV, 10000);
  }
  // Marca temporal del resumen
  if (typeof window.updateSummaryTimestamp === 'function'){
    SCHED.register('ts-refresh', window.updateSummaryTimestamp, 30000);
  }
  // Pull de estado periódico (ligero)
  if (typeof window.loadState === 'function'){
    SCHED.register('state-pull', window.loadState, 60000);
  }
})();
</script>
<!-- ===================== BLOQUE 39: Barra de errores global + integración con apiGet/apiPost ===================== -->
<style>
#errorBar{
  position:fixed; left:0; right:0; top:0; z-index:3800;
  display:none; align-items:center; gap:.6rem; padding:.55rem .8rem;
  background:#7f1d1d; color:#fff; border-bottom:2px solid #dc2626; font-weight:800;
}
#errorBar .msg{ flex:1; }
#errorBar .btn{ border:1px solid #fecaca; background:transparent; color:#fff; padding:.25rem .6rem; border-radius:8px; font-weight:900; }
@media (prefers-color-scheme: light){
  #errorBar{ background:#fecaca; color:#7f1d1d; border-color:#ef4444; }
  #errorBar .btn{ border-color:#7f1d1d; color:#7f1d1d; }
}
</style>
<div id="errorBar" role="alert" aria-live="assertive">
  <span class="msg" id="errorMsg">Se ha producido un error.</span>
  <button class="btn" id="errRetryBtn" type="button">Reintentar</button>
  <button class="btn" id="errDismissBtn" type="button">Cerrar</button>
</div>
<script>
(function(){
  if (window.__CDL_ERRORBAR__) return; window.__CDL_ERRORBAR__=true;

  const bar  = document.getElementById('errorBar');
  const msg  = document.getElementById('errorMsg');
  const btnR = document.getElementById('errRetryBtn');
  const btnX = document.getElementById('errDismissBtn');
  let retryFn = null;

  function showError(text, retry){
    if (msg) msg.textContent = String(text||'Error inesperado');
    retryFn = typeof retry === 'function' ? retry : null;
    if (btnR) btnR.style.display = retryFn ? '' : 'none';
    bar.style.display = 'flex';
  }
  function hideError(){ bar.style.display = 'none'; retryFn = null; }

  btnR?.addEventListener('click', async ()=>{
    if (!retryFn) return hideError();
    try{ hideError(); await retryFn(); }
    catch(e){ showError('Sigue fallando la operación. Revisa la conexión e inténtalo de nuevo.', retryFn); }
  });
  btnX?.addEventListener('click', hideError);

  // Exponer API
  window.showErrorBar = showError;
  window.hideErrorBar = hideError;

  // Parchar apiGet/apiPost para mostrar la barra ante errores de red
  const _get  = window.apiGet;
  const _post = window.apiPostOnline || window.apiPost; // usar versión online si existe

  if (typeof _get === 'function' && !_get.__errPatch__){
    window.apiGet = async function(q){
      try{ return await _get(q); }
      catch(err){
        const isNet = /NetworkError|Failed to fetch|TypeError|net::ERR/i.test(String(err));
        if (isNet){
          showError('Sin conexión o servidor no disponible. Reintentar consulta.', ()=> window.apiGet(q));
          throw err;
        }
        throw err;
      }
    };
    window.apiGet.__errPatch__ = true;
  }

  if (typeof _post === 'function' && !_post.__errPatch__){
    const wrap = async (body)=>{
      try{ return await _post(body); }
      catch(err){
        const isNet = /NetworkError|Failed to fetch|TypeError|net::ERR/i.test(String(err));
        if (isNet){
          // Si existe cola offline, no mostramos barra (se encola). Si no, ofrecemos retry.
          if (!(window.apiPost && window.apiPost.__offlinePatch__)){
            showError('No se pudo enviar la acción. Reintentar ahora.', ()=> wrap(body));
          }
          throw err;
        }
        throw err;
      }
    };
    wrap.__errPatch__ = true;
    // si existe apiPostOnline, no tocamos apiPost (ya parcheada con cola); guardamos hook para otros usos
    if (!window.apiPostOnline){ window.apiPost = wrap; }
    window.apiPostOnline = wrap;
  }

  // Captura global de promesas no manejadas
  window.addEventListener('unhandledrejection', (e)=>{
    const reason = (e && e.reason) || {};
    const msgTxt = (reason && (reason.message||reason.statusText)) || String(reason) || 'Error inesperado';
    // Evita duplicar las de red (ya gestionadas)
    if (/NetworkError|Failed to fetch|net::ERR/.test(msgTxt)) return;
    showError('Ups: '+msgTxt);
  });
})();
</script>
<!-- ===================== BLOQUE 40: Performance — prefetch/idle, font-display y lazy para imágenes pesadas ===================== -->
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"></noscript>
<style>
/* Asegura que las fuentes no bloqueen render (fallback rápido) */
@font-face{ font-family:Inter; font-display:swap; src:local("Inter"); }
img[data-lazysrc]{ opacity:0; transition:opacity .25s ease; }
img[data-lazysrc].on{ opacity:1; }
</style>
<script>
(function(){
  if (window.__CDL_PERF__) return; window.__CDL_PERF__=true;

  // Prefetch suave al estar ocioso (manifest, sw, logos grandes)
  const idle = (cb)=> ('requestIdleCallback' in window) ? requestIdleCallback(cb, {timeout:1200}) : setTimeout(cb, 400);

  idle(()=> {
    try{
      ['/_app/large-sprite.svg','/manifest.webmanifest','/sw.js'].forEach(href=>{
        const l=document.createElement('link'); l.rel='prefetch'; l.href=href; l.as='fetch'; document.head.appendChild(l);
      });
    }catch(_){}
  });

  // Lazy para imágenes pesadas con data-lazysrc
  const io = ('IntersectionObserver' in window) ? new IntersectionObserver((entries,obs)=>{
    entries.forEach(e=>{
      if (!e.isIntersecting) return;
      const img = e.target;
      const src = img.getAttribute('data-lazysrc');
      if (src){ img.src = src; img.onload = ()=> img.classList.add('on'); img.removeAttribute('data-lazysrc'); }
      obs.unobserve(img);
    });
  }, { rootMargin:'350px' }) : null;

  document.addEventListener('DOMContentLoaded', ()=>{
    document.querySelectorAll('img[data-lazysrc]').forEach(img=>{
      if (io) io.observe(img); else { img.src = img.getAttribute('data-lazysrc'); img.classList.add('on'); }
    });
  });
})();
</script>
<!-- ===================== BLOQUE 41: Estilos de impresión (fichas, tablas y QR) ===================== -->
<style media="print">
@page{ size:auto; margin:12mm; }
*{ box-shadow:none!important; text-shadow:none!important; }
header, #pagesPanel, #userPanel, #status-strip, .menu, .rolechip, .btn, .page-btn, .tv-grid, .tv-card { display:none!important; }
body{ background:#fff!important; color:#111!important; }
main{ padding:0!important; max-width:none!important; }
.card{ border:1px solid #ddd!important; background:#fff!important; page-break-inside:avoid; }
table{ width:100%; border-collapse:collapse; }
th,td{ border:1px solid #ddd; padding:6px 8px; }
th{ background:#f3f4f6; }
h1,h2,h3{ color:#111!important; page-break-after:avoid; }
#equipoDetail .sub, #repuestoDetail .sub{ color:#374151!important; }
#qrrep canvas, #qrficha canvas{ width:96px!important; height:96px!important; }
@media print {
  a[href]:after{ content:" (" attr(href) ") "; font-weight:normal; color:#6b7280; }
}
</style>
<!-- ===================== BLOQUE 42: Panel de diagnóstico (FPS, memoria aproximada, latencia API) ===================== -->
<style>
#diagPanel{
  position:fixed; right:10px; bottom:10px; z-index:3600; display:none;
  min-width:220px; padding:.6rem .7rem; border-radius:12px;
  background:rgba(13,17,23,.9); color:#e5e7eb; border:1px solid #1f2937; font-size:.9rem;
  backdrop-filter:saturate(1.2) blur(4px);
}
#diagPanel .row{ display:flex; justify-content:space-between; gap:.6rem; }
#diagToggle{
  position:fixed; right:10px; bottom:10px; z-index:3601;
  border:1px solid #2a2f38; background:linear-gradient(180deg,#2b2f35,#10141a); color:#fff;
  border-radius:999px; padding:.4rem .7rem; font-weight:800; cursor:pointer;
}
</style>
<button id="diagToggle" type="button" aria-controls="diagPanel" aria-expanded="false">ℹ️ Diag</button>
<div id="diagPanel" role="status" aria-live="polite">
  <div class="row"><span>FPS</span><b id="d_fps">—</b></div>
  <div class="row"><span>Memoria</span><b id="d_mem">—</b></div>
  <div class="row"><span>API (ping)</span><b id="d_ping">—</b></div>
  <div class="row"><span>Oculta</span><b id="d_vis">—</b></div>
</div>
<script>
(function(){
  if (window.__CDL_DIAG__) return; window.__CDL_DIAG__=true;
  const T=document.getElementById('diagToggle'), P=document.getElementById('diagPanel');
  const FPS=document.getElementById('d_fps'), MEM=document.getElementById('d_mem'), PING=document.getElementById('d_ping'), VIS=document.getElementById('d_vis');

  function toggle(){
    const on = P.style.display!=='block';
    P.style.display = on ? 'block':'none';
    T.setAttribute('aria-expanded', on?'true':'false');
  }
  T?.addEventListener('click', toggle);

  // FPS simple
  let f=0, last=performance.now();
  function loop(t){
    f++; if (t-last>=1000){ if(FPS) FPS.textContent = String(f); f=0; last=t; }
    if (P.style.display==='block') requestAnimationFrame(loop);
  }
  const ensure = ()=> { if (P.style.display==='block') requestAnimationFrame(loop); };
  T?.addEventListener('click', ensure);

  // Memoria (no disponible en todos los navegadores)
  function updateMem(){
    const m = (performance && performance.memory) ? performance.memory : null;
    if (!MEM) return;
    if (m){ MEM.textContent = `${Math.round(m.usedJSHeapSize/1048576)} / ${Math.round(m.jsHeapSizeLimit/1048576)} MB`; }
    else{ MEM.textContent = 'n/d'; }
  }

  // Ping a API_BASE (HEAD/GET liviano)
  async function ping(){
    if (!window.API_BASE || !PING) return;
    const u = new URL(window.API_BASE); u.searchParams.set('ping','1'); u.searchParams.set('t',Date.now());
    const t0 = performance.now();
    try{
      await fetch(u.toString(), { method:'GET', cache:'no-store' });
      PING.textContent = `${Math.round(performance.now()-t0)} ms`;
    }catch(_){
      PING.textContent = 'offline';
    }
  }

  // Visibilidad
  function vis(){ if(VIS) VIS.textContent = document.hidden ? 'Sí' : 'No'; }

  // Auto-actualizaciones cuando está visible
  setInterval(()=>{ if (P.style.display==='block'){ updateMem(); ping(); vis(); } }, 1500);
  document.addEventListener('visibilitychange', vis, {passive:true});
})();
</script>
<!-- ===================== BLOQUE 43: Worker para cálculos pesados ===================== -->
<script>
(function(){
  if (window.__CDL_WORKER__) return; window.__CDL_WORKER__=true;

  // Worker inline para cálculos (CSV, filtros, etc.)
  const blob = new Blob([`
    self.onmessage = function(e){
      const {cmd,data} = e.data||{};
      if (cmd==="csv"){ 
        const csv = (data||[]).map(r => (r||[]).map(v=>{
          v=(v==null?'':String(v));
          return (/[";\\n]/.test(v))? '"'+v.replace(/"/g,'""')+'"': v;
        }).join(";")).join("\\n");
        self.postMessage({cmd:"csv", csv});
      }
    };
  `], {type:"application/javascript"});
  const url = URL.createObjectURL(blob);
  window.CDL_WORKER = new Worker(url);

  window.csvInWorker = function(rows, cb){
    if (!window.CDL_WORKER) return cb("");
    const id = "csv_"+Date.now();
    window.CDL_WORKER.onmessage = function(e){
      if (e.data?.cmd==="csv") cb(e.data.csv);
    };
    window.CDL_WORKER.postMessage({cmd:"csv", data:rows});
  };
})();
</script>
<!-- ===================== BLOQUE 44: Accesibilidad (skip links, foco, contraste) ===================== -->
<style>
.skip-link{
  position:absolute; left:-999px; top:auto; width:1px; height:1px; overflow:hidden;
}
.skip-link:focus{
  position:fixed; left:10px; top:10px; width:auto; height:auto; padding:.4rem .6rem;
  background:#0b0f15; color:#fff; border:2px solid #e43b3b; border-radius:8px; z-index:4000;
}
:focus{ outline:2px solid #e43b3b; outline-offset:2px; }
</style>
<a href="#main" class="skip-link">Saltar al contenido principal</a>
<script>
(function(){
  if (window.__CDL_A11Y__) return; window.__CDL_A11Y__=true;
  // Anuncia cambios de hash para lectores de pantalla
  window.addEventListener("hashchange", ()=>{
    const live = document.getElementById("aria-live");
    if (live) live.textContent = "Navegación a "+location.hash;
  }, {passive:true});
})();
</script>
<div id="aria-live" aria-live="polite" style="position:absolute;left:-9999px;height:1px;width:1px;overflow:hidden"></div>
<!-- ===================== BLOQUE 45: Atajos de teclado ===================== -->
<script>
(function(){
  if (window.__CDL_KEYS__) return; window.__CDL_KEYS__=true;
  document.addEventListener("keydown", (e)=>{
    if (e.altKey && e.key.toLowerCase()==="e"){ e.preventDefault(); nav?.("equipos"); }
    if (e.altKey && e.key.toLowerCase()==="t"){ e.preventDefault(); nav?.("tv"); }
    if (e.altKey && e.key.toLowerCase()==="i"){ e.preventDefault(); nav?.("incidencias"); }
    if (e.altKey && e.key.toLowerCase()==="r"){ e.preventDefault(); nav?.("repuestos"); }
  });
})();
</script>
<!-- ===================== BLOQUE 46: Monitor de conexión ===================== -->
<style>
#netStatus{
  position:fixed; bottom:12px; right:12px; z-index:3500;
  background:#111827; color:#fff; border:1px solid #374151;
  padding:.4rem .8rem; border-radius:8px; font-weight:700;
  box-shadow:0 8px 18px rgba(0,0,0,.45); display:none;
}
#netStatus.offline{ background:#7f1d1d; border-color:#991b1b; }
</style>
<div id="netStatus">Offline</div>
<script>
(function(){
  if (window.__CDL_NETSTATUS__) return; window.__CDL_NETSTATUS__=true;
  const el = document.getElementById("netStatus");
  function update(){
    if (navigator.onLine){ el.style.display="none"; }
    else{ el.style.display="block"; el.classList.add("offline"); }
  }
  window.addEventListener("online",update);
  window.addEventListener("offline",update);
  update();
})();
</script>

<!-- ===================== BLOQUE 47: Notificaciones ===================== -->
<script>
(function(){
  if (window.__CDL_NOTIFS__) return; window.__CDL_NOTIFS__=true;

  window.notify = async function(title, opts){
    try{
      if (!("Notification" in window)) return;
      if (Notification.permission === "granted"){
        new Notification(title, opts||{});
      }else if (Notification.permission !== "denied"){
        const p = await Notification.requestPermission();
        if (p==="granted") new Notification(title, opts||{});
      }
    }catch(e){ console.error("notify", e); }
  };

  // Ejemplo: notificar nuevas incidencias
  window.addEventListener("newIncidencia", (e)=>{
    notify?.("Nueva incidencia", { body:e.detail?.desc||"Incidencia registrada" });
  });
})();
</script>

<!-- ===================== BLOQUE 48: Modal genérico ===================== -->
<style>
#modal{
  position:fixed; inset:0; background:rgba(0,0,0,.65);
  display:none; align-items:center; justify-content:center; z-index:4000;
}
#modal .box{
  background:#0d1117; color:#fff; padding:1rem 1.2rem; border-radius:12px;
  max-width:92vw; max-height:80vh; overflow:auto; box-shadow:0 16px 40px rgba(0,0,0,.6);
}
</style>
<div id="modal"><div class="box" id="modalBox"></div></div>
<script>
(function(){
  if (window.__CDL_MODAL__) return; window.__CDL_MODAL__=true;
  const modal = document.getElementById("modal"), box=document.getElementById("modalBox");
  window.openModal = function(html){ box.innerHTML=html; modal.style.display="flex"; };
  window.closeModal= function(){ modal.style.display="none"; box.innerHTML=""; };
  modal.addEventListener("click",(e)=>{ if(e.target===modal) closeModal(); });
  document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeModal(); });
})();
</script>
<!-- ===================== BLOQUE 49: Exportación simplificada CSV ===================== -->
<script>
(function(){
  if (window.__CDL_EXPORT_CSV__) return; window.__CDL_EXPORT_CSV__=true;

  window.exportSimpleCSV = function(filename, headers, arr, mapFn){
    try{
      const rows = [headers].concat((arr||[]).map(mapFn));
      const csv = rows.map(r=>r.map(v=>{
        v = (v==null?'':String(v));
        return /[",;\n]/.test(v) ? `"${v.replace(/"/g,'""')}"` : v;
      }).join(";")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download=filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0);
    }catch(e){ console.error("exportSimpleCSV", e); }
  };
})();
</script>

<!-- ===================== BLOQUE 50: Loader / Spinner global ===================== -->
<style>
#loader{
  position:fixed; inset:0; background:rgba(0,0,0,.55);
  display:none; align-items:center; justify-content:center; z-index:5000;
}
#loader .spinner{
  width:60px; height:60px; border:6px solid #374151;
  border-top-color:#e43b3b; border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{ to{ transform:rotate(360deg);} }
</style>
<div id="loader"><div class="spinner"></div></div>
<script>
(function(){
  if (window.__CDL_LOADER__) return; window.__CDL_LOADER__=true;
  const el=document.getElementById("loader");
  window.showLoader=()=>{ el.style.display="flex"; };
  window.hideLoader=()=>{ el.style.display="none"; };
})();
</script>

<!-- ===================== BLOQUE 51: Scroll top button ===================== -->
<style>
#scrollTopBtn{
  position:fixed; bottom:20px; right:20px; z-index:3000;
  background:linear-gradient(180deg,#3b3f46 0%, #1a1e24 48%, #0e1217 100%);
  color:#fff; border:1px solid #2a2f38;
  width:44px; height:44px; border-radius:50%;
  display:none; align-items:center; justify-content:center;
  cursor:pointer; font-weight:900; box-shadow:0 8px 18px rgba(0,0,0,.45);
}
</style>
<div id="scrollTopBtn">↑</div>
<script>
(function(){
  if (window.__CDL_SCROLLTOP__) return; window.__CDL_SCROLLTOP__=true;
  const btn=document.getElementById("scrollTopBtn");
  window.addEventListener("scroll",()=>{
    btn.style.display = window.scrollY>200 ? "flex" : "none";
  },{passive:true});
  btn.addEventListener("click",()=>{ window.scrollTo({top:0,behavior:"smooth"}); });
})();
</script>
<!-- ===================== BLOQUE 52: Accesibilidad (skip link + focus ring) ===================== -->
<style>
/* Visibilidad de foco accesible */
:root { --focus: #60a5fa; }
:where(a,button,input,select,textarea,[tabindex]):focus-visible{
  outline: 3px solid var(--focus);
  outline-offset: 2px;
  border-radius: 6px;
}

/* Enlace 'Saltar al contenido' */
#skipToContent{
  position: fixed; left: 16px; top: 10px; z-index: 5001;
  transform: translateY(-120%); transition: transform .15s ease;
  background: #111827; color: #fff; padding: .5rem .75rem;
  border-radius: 10px; border:1px solid #1f2937; text-decoration: none;
  box-shadow: 0 8px 18px rgba(0,0,0,.35);
}
#skipToContent:focus{ transform: translateY(0); }
</style>
<a href="#mainContent" id="skipToContent">Saltar al contenido principal</a>
<script>
(function(){
  if (window.__CDL_A11Y__) return; window.__CDL_A11Y__=true;
  // Asegura que <main> tenga un id de destino
  const main = document.querySelector("main");
  if (main && !main.id) main.id = "mainContent";
})();
</script>
<!-- ===================== BLOQUE 53: Captura de errores global + reporte a API ===================== -->
<script>
(function(){
  if (window.__CDL_ERROR_BOUNDARY__) return; window.__CDL_ERROR_BOUNDARY__=true;

  async function report(kind, payload){
    try{
      if (typeof apiPost !== "function") return;
      await apiPost({res:"log", fn:"client_error", kind, payload});
    }catch(_){} // silencioso
  }

  window.addEventListener("error", (ev)=>{
    const msg = (ev?.message)||"Error de ejecución";
    (window.toast||console.log)(`⚠️ ${msg}`);
    report("error", {
      message: msg,
      filename: ev?.filename, lineno: ev?.lineno, colno: ev?.colno,
      user: (window.USER?.user)||"anon", ua: navigator.userAgent
    });
  });

  window.addEventListener("unhandledrejection", (ev)=>{
    const reason = (ev?.reason && (ev.reason.message||String(ev.reason))) || "Rechazo no manejado";
    (window.toast||console.log)(`⚠️ ${reason}`);
    report("unhandledrejection", {
      reason, user:(window.USER?.user)||"anon", ua:navigator.userAgent
    });
  });
})();
</script>
<!-- ===================== BLOQUE 54: Indicador offline/online ===================== -->
<style>
#netBanner{
  position: fixed; inset: auto 16px 16px 16px; z-index: 4000;
  display: none; align-items: center; gap: .6rem;
  padding: .6rem .8rem; border-radius: 12px;
  border:1px solid #7c2d12; background: #111827; color:#fde68a;
  box-shadow: 0 10px 26px rgba(0,0,0,.35); font-weight: 800;
}
#netBanner.online{
  border-color:#065f46; color:#d1fae5; background:#064e3b;
}
</style>
<div id="netBanner" role="status" aria-live="polite">🔌 Sin conexión. Trabajando offline…</div>
<script>
(function(){
  if (window.__CDL_NET__) return; window.__CDL_NET__=true;
  const b = document.getElementById("netBanner");
  const show = (txt, cls)=>{ b.textContent = txt; b.className = cls?`online`:""; b.style.display="flex";
    clearTimeout(window.__NET_T__); window.__NET_T__ = setTimeout(()=> b.style.display="none", cls?1600:999999);
  };
  function on(){
    show("✅ Conexión restablecida", true);
  }
  function off(){
    show("🔌 Sin conexión. Trabajando offline…", false);
  }
  // Estado inicial
  if (navigator.onLine) { /* nada */ } else off();
  // Eventos
  window.addEventListener("online", on);
  window.addEventListener("offline", off);
})();
</script>
<!-- ===================== BLOQUE 55: Scroll to Top (botón flotante) ===================== -->
<style>
#scrollTopBtn{
  position: fixed; right: 18px; bottom: 18px; z-index: 3500;
  width:44px; height:44px; border-radius:50%;
  background:linear-gradient(180deg,#1f2937,#111827);
  border:1px solid #374151; color:#f9fafb; font-size:22px;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 8px 18px rgba(0,0,0,.4); cursor:pointer;
  opacity:0; pointer-events:none; transition:opacity .25s ease;
}
#scrollTopBtn.show{ opacity:1; pointer-events:auto; }
</style>
<button id="scrollTopBtn" aria-label="Volver arriba">↑</button>
<script>
(function(){
  if (window.__CDL_SCROLLTOP__) return; window.__CDL_SCROLLTOP__=true;
  const btn=document.getElementById("scrollTopBtn");
  if (!btn) return;
  btn.addEventListener("click", ()=> window.scrollTo({top:0,behavior:"smooth"}));
  window.addEventListener("scroll",()=>{
    if (window.scrollY>240) btn.classList.add("show");
    else btn.classList.remove("show");
  }, {passive:true});
})();
</script>

<!-- ===================== BLOQUE 56: Loader global (pantalla inicial) ===================== -->
<style>
#globalLoader{
  position:fixed; inset:0; z-index:5000;
  display:flex; align-items:center; justify-content:center;
  background:#0b0f14; transition: opacity .35s ease, visibility .35s;
}
#globalLoader.fade{ opacity:0; visibility:hidden; }
.loader-spin{
  width:54px; height:54px; border-radius:50%;
  border:5px solid #374151; border-top-color:#e43b3b;
  animation:spin 1s linear infinite;
}
@keyframes spin{ to{ transform:rotate(360deg); } }
</style>
<div id="globalLoader"><div class="loader-spin"></div></div>
<script>
(function(){
  if (window.__CDL_LOADER__) return; window.__CDL_LOADER__=true;
  window.addEventListener("load", ()=>{
    const l=document.getElementById("globalLoader");
    if(l) setTimeout(()=> l.classList.add("fade"), 350);
  });
})();
</script>

<!-- ===================== BLOQUE 57: Modal genérico reutilizable ===================== -->
<style>
#modalMask{
  position:fixed; inset:0; background:rgba(0,0,0,.55);
  z-index:4000; display:none; align-items:center; justify-content:center;
}
#modalBox{
  background:#fff; color:#111; border-radius:14px;
  box-shadow:0 18px 44px rgba(0,0,0,.45);
  max-width:480px; width:90%; padding:1rem;
}
#modalBox h3{ margin-top:0; font-weight:900; }
#modalClose{
  position:absolute; top:12px; right:16px; border:0; background:none;
  font-size:22px; cursor:pointer; color:#555;
}
</style>
<div id="modalMask">
  <div id="modalBox" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <button id="modalClose" aria-label="Cerrar">×</button>
    <h3 id="modalTitle">Título</h3>
    <div id="modalContent">Contenido…</div>
  </div>
</div>
<script>
(function(){
  if (window.__CDL_MODAL__) return; window.__CDL_MODAL__=true;
  const mask=document.getElementById("modalMask"),
        box=document.getElementById("modalBox"),
        close=document.getElementById("modalClose"),
        content=document.getElementById("modalContent"),
        title=document.getElementById("modalTitle");
  function openModal(t,html){
    title.textContent = t||"";
    content.innerHTML = html||"";
    mask.style.display="flex";
  }
  function closeModal(){ mask.style.display="none"; }
  close.addEventListener("click",closeModal);
  mask.addEventListener("click",(e)=>{ if(e.target===mask) closeModal(); });
  window.openModal=openModal; window.closeModal=closeModal;
})();
</script>
<!-- ===================== BLOQUE 58: Diálogo de confirmación reutilizable ===================== -->
<style>
.cdl-confirm-actions{
  display:flex; gap:.5rem; justify-content:flex-end; margin-top:1rem;
}
.cdl-btn{
  border:1px solid #cbd5e1; border-radius:10px; padding:.5rem .8rem; font-weight:800; cursor:pointer;
  background:linear-gradient(180deg,#ffffff,#eef2f7); color:#111; box-shadow:inset 0 1px 0 rgba(255,255,255,.9),0 4px 12px rgba(0,0,0,.08);
}
.cdl-btn.danger{ background:linear-gradient(180deg,#ff5a5a,#c10f0f); color:#fff; border-color:#9f0c0c; }
.cdl-btn.ghost{ background:#fff; }
</style>
<script>
(function(){
  if (window.__CDL_CONFIRM__) return; window.__CDL_CONFIRM__=true;

  /**
   * askConfirm({title, html, okText, cancelText, danger})
   * Devuelve Promise<boolean>
   */
  window.askConfirm = function(opts={}){
    const {title="Confirmar", html="¿Seguro?", okText="Aceptar", cancelText="Cancelar", danger=false} = opts;

    // Si existe openModal/closeModal (BLOQUE 57), úsalo
    if (typeof window.openModal === "function" && typeof window.closeModal === "function"){
      return new Promise(resolve=>{
        const id = "cdlConfirm_" + Date.now();
        const inner = `
          <div>${html}</div>
          <div class="cdl-confirm-actions">
            <button class="cdl-btn ghost" id="${id}_cancel">${cancelText}</button>
            <button class="cdl-btn ${danger?'danger':''}" id="${id}_ok">${okText}</button>
          </div>`;
        openModal(title, inner);
        const on = (sel, fn)=> document.getElementById(sel)?.addEventListener("click", fn, {once:true});
        on(`${id}_cancel`, ()=>{ closeModal(); resolve(false); });
        on(`${id}_ok`,     ()=>{ closeModal(); resolve(true);  });
      });
    }

    // Fallback nativo
    return Promise.resolve( window.confirm((title?title+": ":"") + (html?.replace(/<[^>]+>/g,"")||"¿Seguro?")) );
  };
})();
</script>

<!-- ===================== BLOQUE 59: Banner de estado de red (online/offline) ===================== -->
<style>
#netStatusBar{
  position:fixed; left:0; right:0; top:0;
  transform: translateY(-100%); transition: transform .25s ease, opacity .25s ease;
  z-index:4100; display:flex; justify-content:center;
  padding:.4rem .8rem; font-weight:800; letter-spacing:.02em;
  opacity:0;
}
#netStatusBar.show{ transform: translateY(0); opacity:1; }
#netStatusBar.offline{ background:#7f1d1d; color:#fee2e2; border-bottom:1px solid #991b1b; }
#netStatusBar.online{  background:#064e3b; color:#d1fae5; border-bottom:1px solid #065f46; }
</style>
<div id="netStatusBar" aria-live="polite" role="status"></div>
<script>
(function(){
  if (window.__CDL_NETBAR__) return; window.__CDL_NETBAR__=true;
  const bar = document.getElementById("netStatusBar");
  if (!bar) return;

  let hideTimer=null;
  function show(msg, cls, autoHideMs){
    bar.textContent = msg;
    bar.classList.remove("offline","online","show");
    bar.classList.add(cls,"show");
    clearTimeout(hideTimer);
    if (autoHideMs) hideTimer = setTimeout(()=> bar.classList.remove("show"), autoHideMs);
  }

  function onOffline(){ show("Sin conexión a Internet", "offline", null); }
  function onOnline(){ show("Conectado de nuevo", "online", 1600); }

  window.addEventListener("offline", onOffline, {passive:true});
  window.addEventListener("online",  onOnline,  {passive:true});

  // Estado inicial
  if (!navigator.onLine) onOffline();
})();
</script>

<!-- ===================== BLOQUE 60: Fix de 100vh en móviles (—vh util) ===================== -->
<style>
/* Utilidad: .vh-100 para alturas a pantalla completa sin salto en iOS/Android */
.vh-100{ height: calc(var(--vh, 1vh) * 100); }
</style>
<script>
(function(){
  if (window.__CDL_VH_FIX__) return; window.__CDL_VH_FIX__=true;
  function setVH(){
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
  }
  setVH();
  window.addEventListener('resize', setVH, {passive:true});
  window.addEventListener('orientationchange', setVH, {passive:true});
  // iOS: al mostrar/ocultar barra, esperar un tick
  let tid=null;
  window.addEventListener('scroll', ()=>{ clearTimeout(tid); tid=setTimeout(setVH, 120); }, {passive:true});
})();
</script>
<!-- ===================== BLOQUE 61: Lazy load de iframes y medios pesados ===================== -->
<script>
(function(){
  if (window.__CDL_LAZY_MEDIA__) return; window.__CDL_LAZY_MEDIA__=true;

  function onIntersection(entries, obs){
    entries.forEach(entry=>{
      if (!entry.isIntersecting) return;
      const el = entry.target;
      const src = el.getAttribute("data-src");
      if (src){ el.setAttribute("src", src); el.removeAttribute("data-src"); }
      obs.unobserve(el);
    });
  }

  const obs = new IntersectionObserver(onIntersection, {rootMargin:"200px 0px"});
  document.addEventListener("DOMContentLoaded", ()=>{
    document.querySelectorAll("iframe[data-src], img[data-src]").forEach(el=> obs.observe(el));
  });
})();
</script>

<!-- ===================== BLOQUE 62: Focus visible + accesibilidad ===================== -->
<style>
:focus{ outline:none; }
:focus-visible{
  outline:2px solid var(--brand2, #e43b3b);
  outline-offset:2px;
  border-radius:4px;
}
.skip-link{
  position:absolute; left:-999px; top:auto; width:1px; height:1px; overflow:hidden;
}
.skip-link:focus{
  left:8px; top:8px; width:auto; height:auto;
  background:#111; color:#fff; padding:.4rem .6rem; border-radius:6px; z-index:5000;
}
</style>
<a href="#main" class="skip-link">Saltar al contenido principal</a>

<!-- ===================== BLOQUE 63: Dark/Light theme toggle ===================== -->
<style>
#themeToggle{
  position:fixed; right:12px; bottom:12px; z-index:4500;
  background:#111; color:#fff; border-radius:50%; width:42px; height:42px;
  display:flex; align-items:center; justify-content:center; cursor:pointer;
  border:1px solid #333; box-shadow:0 6px 14px rgba(0,0,0,.4);
}
#themeToggle.light{ background:#f3f4f6; color:#111; border-color:#ddd; }
</style>
<div id="themeToggle" title="Cambiar tema">☾</div>
<script>
(function(){
  if (window.__CDL_THEME_TOGGLE__) return; window.__CDL_THEME_TOGGLE__=true;

  const btn=document.getElementById("themeToggle");
  if (!btn) return;
  const root=document.documentElement;
  const KEY="CDL_THEME";

  function apply(t){
    root.dataset.theme=t;
    btn.textContent=(t==="dark")?"☾":"☀";
    btn.classList.toggle("light", t==="light");
  }
  function toggle(){
    const now=(root.dataset.theme==="dark")?"light":"dark";
    localStorage.setItem(KEY,now); apply(now);
  }

  btn.addEventListener("click", toggle);
  const saved=localStorage.getItem(KEY) || "dark";
  apply(saved);
})();
</script>
<!-- ===================== BLOQUE 64: Indicador de estado de red (online/offline) ===================== -->
<style>
#netBanner{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:16px; z-index:4600; display:none;
  background:#111827; color:#f9fafb; border:1px solid #1f2937;
  border-radius:12px; padding:.45rem .65rem; box-shadow:0 10px 24px rgba(0,0,0,.35);
}
#netBanner .pill{
  display:inline-flex; align-items:center; gap:.4rem; font-weight:800;
  padding:.18rem .5rem; border-radius:999px; border:1px solid #374151;
  background:linear-gradient(180deg,#1f2937,#0b1117);
}
#netBanner button{
  margin-left:.5rem; border:1px solid #374151; border-radius:999px;
  background:#0b1117; color:#e5e7eb; font-weight:800; padding:.26rem .6rem; cursor:pointer;
}
#netBanner.ok{ background:#06220f; border-color:#0f3e21; }
#netBanner.ok .pill{ border-color:#14532d; background:linear-gradient(180deg,#0f3e21,#0b1f14); }
</style>
<div id="netBanner" role="status" aria-live="polite">
  <span class="pill">⚠ Sin conexión</span>
  <span class="msg">Trabajando en modo local…</span>
  <button type="button" id="netRetryBtn" title="Reintentar">Reintentar</button>
</div>
<script>
(function(){
  if (window.__CDL_NET_STATUS__) return; window.__CDL_NET_STATUS__=true;

  const banner = document.getElementById('netBanner');
  const btn    = document.getElementById('netRetryBtn');

  function showOffline(){
    if (!banner) return;
    banner.classList.remove('ok');
    banner.querySelector('.pill').textContent = '⚠ Sin conexión';
    banner.querySelector('.msg').textContent  = 'Trabajando en modo local…';
    banner.style.display='block';
  }
  function showOnline(){
    if (!banner) return;
    banner.classList.add('ok');
    banner.querySelector('.pill').textContent = '✔ Conectado';
    banner.querySelector('.msg').textContent  = 'Conexión restaurada.';
    banner.style.display='block';
    clearTimeout(window.__CDL_NET_OK_T__);
    window.__CDL_NET_OK_T__ = setTimeout(()=> banner.style.display='none', 1600);
  }

  window.addEventListener('offline', showOffline, {passive:true});
  window.addEventListener('online',  showOnline , {passive:true});

  btn?.addEventListener('click', async ()=>{
    try{
      // ping ligero a la API si existe
      const u = (window.API_BASE || '/').split('?')[0];
      const r = await fetch(u, {method:'HEAD', cache:'no-cache'});
      if (r.ok) showOnline(); else showOffline();
    }catch(_){ showOffline(); }
  });

  // Estado inicial
  if (!navigator.onLine) showOffline();
})();
</script>

<!-- ===================== BLOQUE 65: Captura global de errores + mini consola (F1 para abrir) ===================== -->
<style>
#miniConsole{
  position:fixed; right:12px; bottom:64px; width:min(520px,92vw); max-height:40vh;
  background:#0b0f15; color:#e5e7eb; border:1px solid #1f2937; border-radius:12px;
  box-shadow:0 16px 36px rgba(0,0,0,.45); padding:.5rem; display:none; z-index:4700;
}
#miniConsole pre{ margin:0; white-space:pre-wrap; word-break:break-word; max-height:32vh; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.82rem; }
#miniConsole header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:.35rem; }
#miniConsole button{ border:1px solid #374151; background:#111827; color:#fff; border-radius:8px; padding:.25rem .5rem; cursor:pointer; }
</style>
<div id="miniConsole" role="region" aria-label="Consola de eventos">
  <header>
    <strong>Consola</strong>
    <div>
      <button id="mcCopy">Copiar</button>
      <button id="mcClear">Limpiar</button>
      <button id="mcClose" aria-label="Cerrar">✕</button>
    </div>
  </header>
  <pre id="mcLog"></pre>
</div>
<script>
(function(){
  if (window.__CDL_MINI_CONSOLE__) return; window.__CDL_MINI_CONSOLE__=true;

  const box = document.getElementById('miniConsole');
  const log = document.getElementById('mcLog');
  const btnCopy = document.getElementById('mcCopy');
  const btnClear= document.getElementById('mcClear');
  const btnClose= document.getElementById('mcClose');
  const KEY_OPEN ='F1'; // tecla para abrir/cerrar

  function append(line){
    if (!log) return;
    const ts = new Date().toISOString().replace('T',' ').replace('Z','');
    log.textContent += `[${ts}] ${line}\n`;
    log.scrollTop = log.scrollHeight;
  }

  // API pública mínima para registrar desde otros bloques
  window.cdlLog = window.cdlLog || append;

  // Captura global de errores
  window.addEventListener('error', (e)=>{
    append(`Error: ${e.message} @ ${e.filename}:${e.lineno}:${e.colno}`);
  });
  window.addEventListener('unhandledrejection', (e)=>{
    append(`Promise Rejection: ${(e.reason && (e.reason.stack||e.reason.message)) || String(e.reason)}`);
  });

  // Tecla de apertura
  document.addEventListener('keydown', (e)=>{
    if (e.key === KEY_OPEN){
      e.preventDefault();
      box.style.display = (box.style.display==='block')?'none':'block';
    }
  }, {passive:false});

  btnClose?.addEventListener('click', ()=> box.style.display='none');
  btnClear?.addEventListener('click', ()=> log.textContent='');
  btnCopy ?.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(log.textContent||''); window.toast?.('Copiado'); }catch(_){ alert('No se pudo copiar'); }
  });
})();
</script>

<!-- ===================== BLOQUE 66: Estilos de impresión (limpios y útiles) ===================== -->
<style>
@media print{
  /* Ocultar elementos no imprimibles */
  header, #pagesPanel, #userPanel, #themeToggle, #netBanner, #miniConsole,
  .menu, .btn, .page-btn, .pw-toggle, [role="button"], .no-print { display:none !important; }

  body{ background:#fff !important; color:#000 !important; }
  main{ max-width:none !important; padding:0 !important; }

  /* Tipografías y tamaños sobrios */
  h1,h2,h3{ color:#000 !important; break-after:avoid-page; }
  h1{ font-size:20pt; } h2{ font-size:16pt; } h3{ font-size:13pt; }
  p, li, td, th{ font-size:11pt; }

  /* Tablas legibles */
  table{ width:100% !important; border-collapse:collapse !important; }
  th, td{ border:1px solid #999 !important; padding:6pt 8pt !important; }
  thead th{ background:#eee !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }

  /* Enlaces → texto plano */
  a[href^="#"]::after, a[href^="http"]::after{ content:" (" attr(href) ")"; font-size:9pt; color:#444; }

  /* QRs centrados */
  #qrficha, #qrrep{ margin-top:12pt; break-inside:avoid; }
}
</style>

<!-- ===================== BLOQUE 67: Loader global de “cargando” ===================== -->
<style>
#globalLoader{
  position:fixed; inset:0; background:rgba(11,15,21,.75);
  display:none; align-items:center; justify-content:center; z-index:4800;
}
#globalLoader .spinner{
  width:72px; height:72px; border-radius:50%;
  border:6px solid rgba(255,255,255,.15); border-top-color:#e5e7eb;
  animation:spin 1s linear infinite;
}
@keyframes spin{ to{ transform:rotate(360deg); } }
</style>
<div id="globalLoader" role="alert" aria-live="assertive">
  <div class="spinner"></div>
</div>
<script>
(function(){
  if (window.__CDL_LOADER__) return; window.__CDL_LOADER__=true;
  const box=document.getElementById('globalLoader');
  window.showLoader=()=> box&&(box.style.display='flex');
  window.hideLoader=()=> box&&(box.style.display='none');
})();
</script>

<!-- ===================== BLOQUE 68: Modal genérico reutilizable ===================== -->
<style>
#cdlModal{
  position:fixed; inset:0; background:rgba(0,0,0,.6);
  display:none; align-items:center; justify-content:center; z-index:4900;
}
#cdlModal .modal-box{
  background:#0f141b; color:#e5e7eb; border:1px solid #1f2937; border-radius:14px;
  max-width:600px; width:92%; padding:1rem; box-shadow:0 16px 36px rgba(0,0,0,.5);
}
#cdlModal header{ font-weight:900; margin-bottom:.5rem; display:flex; justify-content:space-between; align-items:center; }
#cdlModal header button{ border:0; background:none; color:#9ca3af; font-size:1.2rem; cursor:pointer; }
</style>
<div id="cdlModal" role="dialog" aria-modal="true" aria-labelledby="cdlModalTitle">
  <div class="modal-box">
    <header>
      <span id="cdlModalTitle">Modal</span>
      <button id="cdlModalClose" aria-label="Cerrar">✕</button>
    </header>
    <div id="cdlModalBody">Contenido…</div>
  </div>
</div>
<script>
(function(){
  if (window.__CDL_MODAL__) return; window.__CDL_MODAL__=true;
  const box=document.getElementById('cdlModal');
  const body=document.getElementById('cdlModalBody');
  const title=document.getElementById('cdlModalTitle');
  const btn=document.getElementById('cdlModalClose');
  function openModal(html,ttl){ if(ttl) title.textContent=ttl; body.innerHTML=html||""; box.style.display='flex'; }
  function closeModal(){ box.style.display='none'; }
  btn?.addEventListener('click', closeModal);
  box?.addEventListener('click', e=>{ if(e.target===box) closeModal(); });
  window.openModal=openModal; window.closeModal=closeModal;
})();
</script>

<!-- ===================== BLOQUE 69: Tooltips ligeros ===================== -->
<style>
.tooltip{
  position:absolute; background:#111827; color:#f9fafb; font-size:.75rem; padding:.25rem .45rem;
  border-radius:6px; white-space:nowrap; z-index:5000; pointer-events:none;
  opacity:0; transform:translate(-50%,-8px); transition:opacity .15s ease, transform .15s ease;
}
.tooltip.show{ opacity:1; transform:translate(-50%,-12px); }
</style>
<script>
(function(){
  if (window.__CDL_TOOLTIP__) return; window.__CDL_TOOLTIP__=true;
  let tip;
  document.addEventListener('mouseover', e=>{
    const el=e.target.closest('[data-tip]'); if(!el) return;
    tip=document.createElement('div'); tip.className='tooltip'; tip.textContent=el.getAttribute('data-tip');
    document.body.appendChild(tip);
    const r=el.getBoundingClientRect();
    tip.style.left=(r.left+r.width/2)+'px';
    tip.style.top=(r.top+window.scrollY-8)+'px';
    requestAnimationFrame(()=> tip.classList.add('show'));
  });
  document.addEventListener('mouseout', e=>{
    if(tip){ tip.remove(); tip=null; }
  });
})();
</script>

<!-- ===================== BLOQUE 70: Notificaciones nativas (Web Notifications) ===================== -->
<script>
(function(){
  if (window.__CDL_NOTIF__) return; window.__CDL_NOTIF__=true;

  async function ensureNotifPerm(){
    if (!('Notification' in window)) return {ok:false, reason:'unsupported'};
    if (Notification.permission === 'granted') return {ok:true};
    if (Notification.permission === 'denied')  return {ok:false, reason:'denied'};
    try{
      const p = await Notification.requestPermission();
      return {ok: p==='granted', reason:p};
    }catch{ return {ok:false, reason:'error'}; }
  }

  async function sendNotify(title, opts){
    try{
      const perm = await ensureNotifPerm();
      if (!perm.ok) return false;
      const n = new Notification(String(title||'CDL · CMMS'), Object.assign({
        body: '', icon: '/icon-192.png', badge:'/icon-192.png'
      }, opts||{}));
      setTimeout(()=> n?.close?.(), 8000);
      return true;
    }catch(e){ console.warn('notify error', e); return false; }
  }

  // Exponer helpers globales
  window.ensureNotifPerm = ensureNotifPerm;
  window.sendNotify = sendNotify;

  // Ejemplos (comentar si no se desea auto-solicitud)
  document.addEventListener('DOMContentLoaded', ()=> {
    // Solicitar permiso de forma amable y única
    const k='CDL_NOTIF_REQ_v1';
    if (!localStorage.getItem(k)){
      setTimeout(()=> ensureNotifPerm().then(()=> localStorage.setItem(k,'1')), 2000);
    }
  });
})();
</script>

<!-- ===================== BLOQUE 71: Modo demo/simulador (opcional, seguro por bandera) ===================== -->
<script>
(function(){
  if (window.__CDL_SIM__) return; window.__CDL_SIM__=true;

  // Activar solo si se pone window.CDL_DEMO=true antes de este bloque
  const ON = !!window.CDL_DEMO;
  if (!ON) return;

  console.info('%cCDL DEMO','background:#111;color:#0f0;padding:2px 6px;border-radius:4px');

  // Variar aleatoriamente estados para simular actividad (sin tocar servidor)
  function jitterState(){
    const arr = (window.STATE||[]); if (!arr.length) return;
    const pick = Math.min(3, Math.ceil(arr.length*0.12));
    for(let i=0;i<pick;i++){
      const idx = Math.floor(Math.random()*arr.length);
      const cur = arr[idx]; if (!cur) continue;
      const options = ['En marcha','Restricciones','Parada'];
      cur.estado = options[Math.floor(Math.random()*options.length)];
    }
    try{ window.renderEquiposList?.(); window.renderTV?.(); }catch(_){}
  }

  // Añadir/actualizar “repuestos solicitados” de ejemplo
  function jitterRepuestos(){
    window.REP = window.REP || [];
    if (Math.random() < 0.5 && window.REP.length){
      // Cambiar urgencia de uno
      const i = Math.floor(Math.random()*window.REP.length);
      const u = ['Baja','Media','Alta'][Math.floor(Math.random()*3)];
      if (window.REP[i]) window.REP[i].urgencia = u;
    }else{
      // Insertar mock
      const id = 'SIM-'+Date.now().toString(36);
      window.REP.unshift({
        id, ref:'SIM-REF-'+(100+Math.floor(Math.random()*900)),
        nombre:'Pieza demo', solicitante:'demo@cdl',
        urgencia:['Baja','Media','Alta'][Math.floor(Math.random()*3)],
        entrega: new Date(Date.now()+86400000*(1+Math.floor(Math.random()*10))).toISOString()
      });
      window.REP = window.REP.slice(0,25);
    }
    try{ window.renderRepTable?.(); window.renderTV?.(); }catch(_){}
  }

  // Timers
  let t1=setInterval(jitterState,     7000);
  let t2=setInterval(jitterRepuestos, 9000);

  // Limpieza al salir del modo demo
  window.disableDemo = ()=>{ clearInterval(t1); clearInterval(t2); console.info('Demo OFF'); };
})();
</script>

<!-- ===================== BLOQUE 72: Métricas de rendimiento + trazas clave ===================== -->
<script>
(function(){
  if (window.__CDL_PERF__) return; window.__CDL_PERF__=true;

  // Marcas simples
  performance.mark('cdl:start');

  // Log básico de Web Vitals-like (sin dependencias)
  function logPerf(){
    try{
      const [fp]  = performance.getEntriesByName('first-paint');
      const [fcp] = performance.getEntriesByName('first-contentful-paint');
      const nav = performance.getEntriesByType('navigation')[0];
      const data = {
        ttfb: nav ? Math.round(nav.responseStart) : null,
        domInteractive: nav ? Math.round(nav.domInteractive) : null,
        domContentLoaded: nav ? Math.round(nav.domContentLoadedEventEnd) : null,
        load: nav ? Math.round(nav.loadEventEnd) : null,
        fp:  fp ? Math.round(fp.startTime) : null,
        fcp: fcp? Math.round(fcp.startTime): null
      };
      console.table(data);
      // Exponer por si se quiere enviar a backend
      window.CDL_PERF = data;
    }catch(e){ /* no-op */ }
  }

  // Medir cuando todo carga
  window.addEventListener('load', ()=>{
    performance.mark('cdl:load');
    performance.measure('cdl:boot','cdl:start','cdl:load');
    logPerf();
  }, {once:true});

  // Trazas útiles de API (envoltorio pequeño si existen apiGet/apiPost)
  (function wrapAPI(){
    if (!window.apiGet || window.__CDL_API_WRAP__) return;
    window.__CDL_API_WRAP__=true;
    const g=window.apiGet, p=window.apiPost;
    window.apiGet = async function(q){ const t=performance.now(); try{ const r=await g(q); return r; }
      finally{ console.debug('[apiGet]', q, Math.round(performance.now()-t)+'ms'); } };
    window.apiPost = async function(b){ const t=performance.now(); try{ const r=await p(b); return r; }
      finally{ console.debug('[apiPost]', b?.fn||b, Math.round(performance.now()-t)+'ms'); } };
  })();
})();
</script>
<!-- ===================== BLOQUE 73: Modo offline (IndexedDB + fallback) ===================== -->
<script>
(function(){
  if (window.__CDL_OFFLINE__) return; window.__CDL_OFFLINE__=true;

  const DB_NAME = "cdl-cache-v1";
  const STORE   = "pending";

  function openDB(){
    return new Promise((res,rej)=>{
      const req = indexedDB.open(DB_NAME,1);
      req.onupgradeneeded = ()=> req.result.createObjectStore(STORE,{autoIncrement:true});
      req.onsuccess = ()=> res(req.result);
      req.onerror   = ()=> rej(req.error);
    });
  }

  async function putPending(item){
    try{
      const db = await openDB();
      const tx = db.transaction(STORE,"readwrite");
      tx.objectStore(STORE).add(item);
    }catch(e){ console.warn("putPending fail",e); }
  }

  async function flushPending(){
    try{
      const db = await openDB();
      const tx = db.transaction(STORE,"readwrite");
      const all = tx.objectStore(STORE).getAll();
      all.onsuccess = async ()=>{
        const arr = all.result||[];
        for(const it of arr){
          try{
            await window.apiPost?.(it.body);
            tx.objectStore(STORE).delete(it.id);
          }catch(_){ /* sigue en pending */ }
        }
      };
    }catch(e){ console.warn("flushPending fail",e); }
  }

  // Reintentar al volver online
  window.addEventListener("online", flushPending);

  // Envolver apiPost para guardar cuando offline
  if (window.apiPost && !window.__CDL_POST_WRAP__){
    window.__CDL_POST_WRAP__=true;
    const orig = window.apiPost;
    window.apiPost = async function(b){
      if (navigator.onLine) return orig(b);
      await putPending({body:b});
      (window.toast||console.log)("Guardado offline, se enviará luego");
      return {ok:true, offline:true};
    };
  }
})();
</script>

<!-- ===================== BLOQUE 74: Buscador global rápido ===================== -->
<script>
(function(){
  if (window.__CDL_SEARCH__) return; window.__CDL_SEARCH__=true;

  function searchAll(q){
    q = (q||"").toLowerCase();
    if (!q) return [];
    const res=[];
    (window.STATE||[]).forEach(eq=>{
      if (eq.nombre?.toLowerCase().includes(q)) res.push({tipo:"Equipo", txt:eq.nombre, slug:slugify(eq.nombre)});
    });
    (window.INV||[]).forEach(r=>{
      if (r.ref?.toLowerCase().includes(q) || r.nombre?.toLowerCase().includes(q)){
        res.push({tipo:"Repuesto", txt:r.ref+" — "+r.nombre, ref:r.ref});
      }
    });
    return res;
  }

  function renderSearchResults(list){
    const box=document.getElementById("searchResults"); if(!box) return;
    if (!list.length){ box.innerHTML="<div class='card'>Sin resultados</div>"; return; }
    box.innerHTML = list.map(it=>{
      if (it.tipo==="Equipo"){
        return `<div class="card"><b>${esc(it.txt)}</b> <button class="btn gloss" onclick="location.hash='#/equipo/${encodeURIComponent(it.slug)}'">Abrir</button></div>`;
      }
      if (it.tipo==="Repuesto"){
        return `<div class="card"><b>${esc(it.txt)}</b> <button class="btn gloss" onclick="openRepuestoByRef('${esc(it.ref)}')">Ficha</button></div>`;
      }
      return "";
    }).join("");
  }

  // Exponer global
  window.searchAll = searchAll;
  window.renderSearchResults = renderSearchResults;

  // Si hay input de búsqueda global con id=globalSearch
  document.addEventListener("input",(e)=>{
    const inp=e.target.closest("#globalSearch"); if(!inp) return;
    const q=inp.value||"";
    const res=searchAll(q);
    renderSearchResults(res);
  });
})();
</script>

<!-- ===================== BLOQUE 75: Ayuda contextual (atajos y tips) ===================== -->
<script>
(function(){
  if (window.__CDL_HELP__) return; window.__CDL_HELP__=true;

  function showHelp(){
    const tips = [
      "Pulsa / para buscar rápido",
      "g + e → ir a Equipos",
      "g + i → ir a Inventario",
      "g + r → ir a Repuestos",
      "g + t → ir a Dashboard TV",
      "Esc → cerrar menús"
    ];
    const html = `<div style="font-family:Inter,sans-serif;padding:1rem;max-width:480px">
      <h2>Atajos rápidos</h2>
      <ul>${tips.map(t=>`<li>${t}</li>`).join("")}</ul>
    </div>`;
    window.printHTML?.("Ayuda CDL", html);
  }

  // Atajo F1
  document.addEventListener("keydown",(e)=>{
    if (e.key==="F1"){ e.preventDefault(); showHelp(); }
  });

  // Exponer
  window.showHelp = showHelp;
})();
</script>
<!-- ===================== BLOQUE 76: Telemetría ligera (debug opcional) ===================== -->
<script>
(function(){
  if (window.__CDL_TELEM__) return; window.__CDL_TELEM__=true;

  const LS_FLAG = "CDL_DEBUG";
  const q = new URLSearchParams(location.search);
  if (q.has("debug")) localStorage.setItem(LS_FLAG, q.get("debug") ? "1":"");
  const DEBUG = !!localStorage.getItem(LS_FLAG);

  const queue = [];
  function log(evt, data){
    const item = { t: Date.now(), evt, data };
    queue.push(item);
    if (DEBUG) console.debug("[CDL]", evt, data||"");
    if (queue.length > 200) queue.shift();
  }

  // Eventos interesantes
  ["hashchange","online","offline","visibilitychange"].forEach(ev=>{
    window.addEventListener(ev, ()=> log("win."+ev, {hash:location.hash, on:navigator.onLine, vis:document.visibilityState}), {passive:true});
  });

  // Integración mínima con API wrappers si existen
  if (window.apiGet && !window.apiGet.__probe__){
    const orig = window.apiGet;
    window.apiGet = async function(q){
      const start = performance.now();
      try{
        const r = await orig(q);
        log("apiGet", {q, ms: +(performance.now()-start).toFixed(1), ok: !!r});
        return r;
      }catch(e){ log("apiGet.err", {q, err:String(e)}); throw e; }
    };
    window.apiGet.__probe__ = true;
  }
  if (window.apiPost && !window.apiPost.__probe__){
    const orig = window.apiPost;
    window.apiPost = async function(b){
      const start = performance.now();
      try{
        const r = await orig(b);
        log("apiPost", {b:{res:b?.res,fn:b?.fn}, ms: +(performance.now()-start).toFixed(1), ok: !!r?.ok, offline:r?.offline});
        return r;
      }catch(e){ log("apiPost.err", {b:{res:b?.res,fn:b?.fn}, err:String(e)}); throw e; }
    };
    window.apiPost.__probe__ = true;
  }

  // Exponer para inspección manual
  window.__CDL_LOG__ = {
    get: ()=> queue.slice(),
    clear: ()=> queue.splice(0, queue.length),
    enable: ()=> localStorage.setItem(LS_FLAG,"1"),
    disable: ()=> localStorage.removeItem(LS_FLAG)
  };
})();
</script>

<!-- ===================== BLOQUE 77: Rendimiento (idle/batching + resize throttle) ===================== -->
<script>
(function(){
  if (window.__CDL_PERF__) return; window.__CDL_PERF__=true;

  const raf = window.requestAnimationFrame.bind(window);
  const ric = window.requestIdleCallback ? window.requestIdleCallback.bind(window) : (cb)=> setTimeout(()=>cb({didTimeout:false, timeRemaining:()=>10}), 50);

  // Batching sencillo para renders frecuentes
  const tasks = new Set();
  function schedule(fn){
    tasks.add(fn);
    if (schedule._pend) return;
    schedule._pend = true;
    raf(()=>{
      schedule._pend = false;
      const list = Array.from(tasks); tasks.clear();
      for (const f of list) try{ f(); }catch(e){ console.error(e); }
    });
  }
  window.batchRender = (fn)=> schedule(fn);

  // Recomponer TV y KPIs en idle cuando cambian datasets grandes
  function reflowHeavy(){
    if (typeof renderTV === "function") schedule(renderTV);
    if (typeof renderEquiposList === "function") schedule(renderEquiposList);
  }
  ["STATE","REP","CONS","OTS","INCID"].forEach(key=>{
    Object.defineProperty(window, key, {
      get(){ return this["__"+key]; },
      set(v){ this["__"+key]=v; ric(reflowHeavy); },
      configurable:true
    });
  });

  // Throttle de resize para sincronizar --hdr-h y tablas
  let rTick = 0;
  window.addEventListener("resize", ()=>{
    if (rTick) return; rTick = 1;
    raf(()=>{ rTick = 0;
      try{
        const hdr=document.querySelector("header");
        const h=Math.max(64, hdr?.offsetHeight||0);
        document.documentElement.style.setProperty('--hdr-h', h+'px');
      }catch(_){}
    });
  }, {passive:true});
})();
</script>

<!-- ===================== BLOQUE 78: Endurecimiento (sanitizado + enlaces seguros) ===================== -->
<script>
(function(){
  if (window.__CDL_HARDEN__) return; window.__CDL_HARDEN__=true;

  // Sanitizador simple para cadenas HTML (ya existe esc(), pero reforzamos utilidades)
  window.sanitizeHTML = function(html){
    const t = document.createElement("template");
    t.innerHTML = String(html||"");
    // Eliminar scripts y on* handlers
    t.content.querySelectorAll("script, iframe, object, embed").forEach(n=> n.remove());
    t.content.querySelectorAll("*").forEach(el=>{
      [...el.attributes].forEach(a=>{
        if (/^on/i.test(a.name)) el.removeAttribute(a.name);
        if (a.name==="href" && /^\s*javascript:/i.test(a.value)) el.removeAttribute("href");
      });
    });
    return t.innerHTML;
  };

  // Forzar seguridad en target=_blank
  document.addEventListener("click",(e)=>{
    const a = e.target.closest("a[target=_blank]");
    if (!a) return;
    const rel = (a.getAttribute("rel")||"").split(/\s+/);
    if (!rel.includes("noopener")) rel.push("noopener");
    if (!rel.includes("noreferrer")) rel.push("noreferrer");
    a.setAttribute("rel", rel.join(" ").trim());
  }, {passive:true});

  // Evitar pegado peligroso en contentEditable (si se usan notas en el futuro)
  document.addEventListener("paste",(e)=>{
    const trg = e.target;
    if (!trg || (!trg.isContentEditable && trg.tagName!=="TEXTAREA")) return;
    const text = (e.clipboardData||window.clipboardData).getData("text/plain");
    if (text){ e.preventDefault(); document.execCommand("insertText", false, text); }
  });

})();
</script>

<!-- ===================== BLOQUE 79: Accesibilidad extra ===================== -->
<script>
(function(){
  if (window.__CDL_A11Y__) return; window.__CDL_A11Y__=true;

  // Mejorar focus visible siempre
  const style = document.createElement("style");
  style.textContent = `
    :focus-visible {
      outline: 2px solid var(--brand2);
      outline-offset: 2px;
    }
  `;
  document.head.appendChild(style);

  // Roles y labels para menús
  const pagesBtn=document.getElementById("pagesBtn");
  if (pagesBtn){ pagesBtn.setAttribute("role","button"); pagesBtn.setAttribute("aria-haspopup","true"); }
  const userBtn=document.getElementById("userBtn");
  if (userBtn){ userBtn.setAttribute("role","button"); userBtn.setAttribute("aria-haspopup","true"); }

  // Anunciar actualizaciones de resumen
  const live = document.createElement("div");
  live.setAttribute("aria-live","polite");
  live.setAttribute("aria-atomic","true");
  live.style.cssText="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden";
  document.body.appendChild(live);

  window.announce = function(msg){ live.textContent=msg; };
})();
</script>

<!-- ===================== BLOQUE 80: Shortcuts accesibles ===================== -->
<script>
(function(){
  if (window.__CDL_KBD2__) return; window.__CDL_KBD2__=true;

  const hasFocus=()=> {
    const a=document.activeElement;
    if (!a) return false;
    const tag=(a.tagName||"").toLowerCase();
    return ["input","textarea","select","button"].includes(tag) || a.isContentEditable;
  };

  // Atajos
  document.addEventListener("keydown",(e)=>{
    if (hasFocus()) return;
    if (e.altKey && e.key==="1"){ nav("tv"); announce?.("Ir a Dashboard TV"); }
    if (e.altKey && e.key==="2"){ nav("equipos"); announce?.("Ir a Equipos"); }
    if (e.altKey && e.key==="3"){ nav("incidencias"); announce?.("Ir a Incidencias"); }
    if (e.altKey && e.key==="4"){ nav("inventario"); announce?.("Ir a Inventario"); }
    if (e.altKey && e.key==="5"){ nav("repuestos"); announce?.("Ir a Repuestos"); }
  }, {passive:true});
})();
</script>

<!-- ===================== BLOQUE 81: Final safe guard ===================== -->
<script>
(function(){
  if (window.__CDL_FINAL_GUARD__) return; window.__CDL_FINAL_GUARD__=true;

  // Evitar errores por funciones faltantes
  const NOOP = ()=>{};
  ["loadState","loadIncid","loadInv","loadRepSol","loadConsumibles","loadOT",
   "renderTV","initTV","renderEquiposList","renderIncidenciasTable",
   "renderConsTable","renderOTTable"].forEach(fn=>{
    if (typeof window[fn]!=="function") window[fn]=NOOP;
  });

  // Alerta si el API base no está definido
  if (!window.API_BASE){
    console.warn("API_BASE no definido. La app funcionará en modo demo.");
    window.API_BASE = "";
  }

  // Sello de seguridad en consola
  console.log("%cCDL · CMMS listo","background:#A60000;color:#fff;padding:2px 6px;border-radius:4px");
})();
</script>
<!-- ===================== BLOQUE 82: Estilos de impresión (A4 friendly) ===================== -->
<style media="print">
  @page { size: A4; margin: 14mm; }
  * { box-shadow: none !important; text-shadow: none !important; }
  html, body { background: #fff !important; color:#111 !important; }
  header, #pagesPanel, #userPanel, .menu, .rolechip, .btn, .page-btn, .pw-toggle, 
  [id^="toast"], .tv-grid .tv-card h3::after { display:none !important; }
  .card { border:1px solid #ccc !important; background:#fff !important; }
  #status-strip { border:0 !important; background:#fff !important; color:#111 !important; }
  a[href]:after { content:" (" attr(href) ")"; font-size:10px; word-break:break-all; }
  table { page-break-inside:auto; }
  tr { page-break-inside:avoid; page-break-after:auto; }
  h1,h2,h3 { color:#111 !important; }
  /* Espaciado más compacto para tablas grandes */
  thead th, tbody td { padding:6px 8px !important; }
</style>

<!-- ===================== BLOQUE 83: Métricas de rendimiento (opcional) ===================== -->
<script>
(function(){
  if (window.__CDL_PERF__) return; window.__CDL_PERF__ = true;

  const wantPerf = /[?&]perf=1\b/.test(location.search);

  // Marcas básicas
  performance.mark?.("cdl:init");

  // Wrapper de apiGet/apiPost para medir tiempos
  const _apiGet = window.apiGet;
  const _apiPost = window.apiPost;

  if (typeof _apiGet === "function"){
    window.apiGet = async function(q){
      const label = "apiGet:" + (q?.res||"unknown") + ":" + (q?.fn||"");
      performance.mark?.(label+":start");
      const t0 = performance.now();
      try{
        const r = await _apiGet(q);
        if (wantPerf) console.log(`[PERF] ${label} ${(performance.now()-t0).toFixed(1)}ms`);
        return r;
      } finally {
        performance.mark?.(label+":end");
        performance.measure?.(label, label+":start", label+":end");
      }
    };
  }

  if (typeof _apiPost === "function"){
    window.apiPost = async function(body){
      const label = "apiPost:" + (body?.res||"unknown") + ":" + (body?.fn||"");
      performance.mark?.(label+":start");
      const t0 = performance.now();
      try{
        const r = await _apiPost(body);
        if (wantPerf) console.log(`[PERF] ${label} ${(performance.now()-t0).toFixed(1)}ms`);
        return r;
      } finally {
        performance.mark?.(label+":end");
        performance.measure?.(label, label+":start", label+":end");
      }
    };
  }

  // Informe simple al cargar
  window.addEventListener("load", ()=>{
    performance.mark?.("cdl:load");
    performance.measure?.("cdl:init→load","cdl:init","cdl:load");
    const m = performance.getEntriesByName?.("cdl:init→load")[0];
    if (wantPerf && m) console.log(`[PERF] init→load: ${m.duration.toFixed(1)}ms`);
  }, {once:true});
})();
</script>

<!-- ===================== BLOQUE 84: Fallback de datos demo si API no responde ===================== -->
<script>
(function(){
  if (window.__CDL_DEMO_FALLBACK__) return; window.__CDL_DEMO_FALLBACK__=true;

  function hasAnyData(){
    return (Array.isArray(window.STATE) && window.STATE.length) ||
           (Array.isArray(window.INV)   && window.INV.length)   ||
           (Array.isArray(window.REP)   && window.REP.length)   ||
           (Array.isArray(window.CONS)  && window.CONS.length)  ||
           (Array.isArray(window.OTS)   && window.OTS.length)   ||
           (Array.isArray(window.INCID) && window.INCID.length);
  }

  function injectDemo(){
    if (hasAnyData()) return;
    const now = new Date(); const iso = (d)=> d.toISOString();

    window.STATE = [
      { nombre:"Sierra KBS 620", grupo:"Línea KALTENBACH", estado:"Parada" },
      { nombre:"Taladro KDM 615", grupo:"Línea KALTENBACH", estado:"Restricciones" },
      { nombre:"Marcadora KDW 610", grupo:"Línea KALTENBACH", estado:"En marcha" },
    ];
    window.INCID = [
      { equipo:"Sierra KBS 620", tipo:"Parada", desc:"Cinta rota", inicio: iso(now), fin:"", reportante:"Turno A" },
      { equipo:"Taladro KDM 615", tipo:"Restricciones", desc:"Vibración excesiva", inicio: iso(new Date(now-3600e3)), fin:"", reportante:"Turno B" },
    ];
    window.INV = [
      { ref:"CB-14", nombre:"Cinta de sierra 41x1.3", stock:2, minimo:3 },
      { ref:"BR-620", nombre:"Buje rodamiento 6202", stock:18, minimo:10 },
    ];
    window.REP = [
      { id:"REP-001", ref:"CB-14", nombre:"Cinta de sierra 41x1.3", solicitante:"Mto", estado:"Pendiente", urgencia:"Alta", entrega: iso(new Date(now+3*86400e3)) }
    ];
    window.CONS = [
      { ref:"ACE-46", nombre:"Aceite hidráulico ISO46", stock:1, minimo:2, updated: iso(now) }
    ];
    window.OTS = [
      { id:"OT-0007", titulo:"Preventivo KBS", prioridad:"Media", asignado:"RT1.1", vencimiento: iso(new Date(now+5*86400e3)), estado:"Planificada", created: iso(now) }
    ];

    // Renderizar
    try{
      typeof renderEquiposList==="function" && renderEquiposList();
      typeof renderIncidenciasTable==="function" && renderIncidenciasTable(window.INCID);
      typeof renderInv==="function" && renderInv(window.INV);
      typeof renderRepTable==="function" && renderRepTable();
      typeof renderConsTable==="function" && renderConsTable();
      typeof renderOTTable==="function" && renderOTTable();
      typeof renderTV==="function" && renderTV();
      (window.toast||console.log)("Modo demo activo (sin datos de API)");
    }catch(e){ console.warn("Demo render error", e); }
  }

  // Espera un poco a que intenten cargar los datos; si nada llega, inyecta demo
  function scheduleFallback(){
    if (hasAnyData()) return;
    setTimeout(()=>{ if (!hasAnyData()) injectDemo(); }, 4000);
  }

  if (document.readyState !== "loading") scheduleFallback();
  else document.addEventListener("DOMContentLoaded", scheduleFallback);

})();
</script>
<!-- ========== BLOQUE 85 (OT: LISTADO Y EXPORT) ========== -->
<script>
async function loadOT(){
  try{
    const d = await apiGet({res:"ot", fn:"list"});
    window.OTS = d?.ok ? (d.items||[]) : [];
    renderOTTable();
  }catch(e){ console.error("loadOT", e); }
}

function renderOTTable(){
  const host = byId("otWrap"); if (!host) return;
  const OTS = window.OTS||[];
  if (!OTS.length){ host.innerHTML = `<div class="card">Sin OT</div>`; return; }
  const rows = OTS.map(o=>`
    <tr>
      <td>${esc(fmtDate(o.created||""))}</td>
      <td>${esc(o.id)}</td>
      <td>${esc(o.prioridad||"")}</td>
      <td>${esc(o.asignado||"")}</td>
      <td>${esc(o.vencimiento||"")}</td>
      <td>${esc(o.estado||"")}</td>
    </tr>
  `).join("");
  host.innerHTML = `
    <div id="otTableWrap" class="card" style="overflow:auto">
      <table id="tblOT">
        <thead>
          <tr><th>Fecha</th><th>OT</th><th>Prioridad</th><th>Asignado</th><th>Vence</th><th>Estado</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="right" style="margin-top:.5rem;display:flex;gap:.5rem;flex-wrap:wrap;justify-content:flex-end">
        <button id="btnExportOTPDF" class="btn gloss">Exportar PDF</button>
      </div>
    </div>`;

  const b = byId("btnExportOTPDF");
  if (b && !b.__b){
    b.__b = true;
    b.addEventListener("click", ()=>{
      const rows = (window.OTS||[]).map(o=>`
        <tr><td>${esc(fmtDate(o.created||""))}</td><td>${esc(o.id)}</td><td>${esc(o.prioridad||"")}</td><td>${esc(o.asignado||"")}</td><td>${esc(o.vencimiento||"")}</td><td>${esc(o.estado||"")}</td></tr>
      `).join("");
      printHTML?.("Órdenes de trabajo", `<h2>Órdenes de trabajo</h2>
        <table><thead><tr><th>Fecha</th><th>OT</th><th>Prioridad</th><th>Asignado</th><th>Vence</th><th>Estado</th></tr></thead><tbody>${rows}</tbody></table>`);
    });
  }
}
</script>
<!-- ========== FIN BLOQUE 85 ========== -->

<!-- ========== BLOQUE 86 (FICHA EQUIPO POR SLUG) ========== -->
<script>
function renderEquipoBySlug(slug){
  const pageId="page-equipo", hostId="equipoDetail";
  document.querySelectorAll('[id^="page-"]').forEach(el=> el.classList.add("hidden"));
  byId(pageId)?.classList.remove("hidden");

  const eq = (window.STATE||[]).find(x=>{
    const s = window.slugify ? slugify(x.nombre) : String(x.nombre).toLowerCase().replace(/\s+/g,'-');
    return s === slug;
  });
  const host = byId(hostId);
  if (!host || !eq){ if (host) host.innerHTML = "<div class='card'>No encontrado</div>"; return; }

  host.innerHTML = `
    <div class="card">
      <h3 style="margin:.1rem 0">${esc(eq.nombre)}</h3>
      <div class="sub">${esc(eq.grupo)}</div>
      <div style="margin:.5rem 0">Estado actual: <b>${esc(eq.estado)}</b></div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn gloss btn-mail" onclick="accionParadaProlongada(${JSON.stringify(eq.nombre)})">Parada prolongada (email)</button>
        <button class="btn gloss btn-ficha" onclick="window.print()">Imprimir ficha</button>
        <button class="btn gloss" onclick="history.back()">Volver</button>
      </div>
      <div style="margin-top:.6rem"><div id="qrficha"></div></div>
    </div>
  `;
  const qr = byId("qrficha");
  if (qr && window.QRCode){
    new QRCode(qr, { text: `${baseURL()}#/equipo/${slug}`, width:96, height:96 });
  }
}
</script>
<!-- ========== FIN BLOQUE 86 ========== -->

<!-- ========== BLOQUE 87 (FICHA REPUESTO POR REF) ========== -->
<script>
function openRepuestoByRef(ref){
  const slug = encodeURIComponent(ref);
  location.hash = `#/repuesto/${slug}`;
  renderRepuestoByRef(ref);
}

function renderRepuestoByRef(ref){
  const pageId="page-repuesto", hostId="repuestoDetail";
  document.querySelectorAll('[id^="page-"]').forEach(el=> el.classList.add("hidden"));
  byId(pageId)?.classList.remove("hidden");

  const it = (window.INV||[]).find(x => String(x.ref).toUpperCase() === String(ref).toUpperCase());
  const host = byId(hostId);
  if (!host || !it){ if (host) host.innerHTML = "<div class='card'>No encontrado</div>"; return; }

  host.innerHTML = `
    <div class="card">
      <h3 style="margin:.1rem 0">${esc(it.nombre)}</h3>
      <div class="sub">Ref: <b>${esc(it.ref)}</b></div>
      <div style="margin:.5rem 0">Stock: <b>${it.stock}</b> · Mínimo: <b>${it.minimo}</b></div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn gloss" onclick="window.print()">Imprimir etiqueta</button>
        <button class="btn gloss" onclick="history.back()">Volver</button>
      </div>
      <div style="margin-top:.6rem"><div id="qrrep"></div></div>
    </div>
  `;
  const qr = byId("qrrep");
  if (qr && window.QRCode){
    new QRCode(qr, { text: `${baseURL()}#/repuesto/${encodeURIComponent(it.ref)}`, width:96, height:96 });
  }
}
</script>
<!-- ========== FIN BLOQUE 87 ========== -->
<!-- ========== BLOQUE 88 (ROUTER + BOOT + TIMERS) ========== -->
<script>
(function(){
  if (window.__CDL_ROUTER_BOOT__) return; window.__CDL_ROUTER_BOOT__ = true;

  // Router por hash (#/equipos, #/tv, #/equipo/:slug, #/repuesto/:ref)
  function handleHash(){
    const h = location.hash || "";
    if (!h){ if (typeof nav==="function") nav("tv"); return; }

    const mEq = h.match(/^#\/equipo\/(.+)$/);
    const mRp = h.match(/^#\/repuesto\/(.+)$/);

    if (mEq && typeof renderEquipoBySlug === "function"){ renderEquipoBySlug(mEq[1]); return; }
    if (mRp && typeof renderRepuestoByRef === "function"){ renderRepuestoByRef(decodeURIComponent(mRp[1]||"")); return; }

    const p = h.replace(/^#\/?/,"");
    const PAGES = new Set(["equipos","gruas","otros","incidencias","indicadores","ot","inventario","repuestos","consumibles","tv","personal","logs"]);
    if (PAGES.has(p) && typeof nav==="function"){ nav(p); return; }

    if (typeof nav==="function") nav("tv");
  }
  window.addEventListener("hashchange", handleHash, { passive:true });

  // Sello de tiempo del resumen (cada 30s)
  function updateSummaryTimestamp(){
    const d = new Date();
    const el = document.getElementById("kUpdated");
    if (el) el.textContent = d.toLocaleString("es-ES",{hour12:false});
  }
  if (!window.__CDL_TS_TIMER__){
    window.__CDL_TS_TIMER__ = setInterval(updateSummaryTimestamp, 30*1000);
  }

  // Boot a TV + timers de TV
  function bootToTV(){
    if (!location.hash || location.hash === "#" || location.hash === "#/"){
      if (typeof nav==="function") nav("tv"); else location.hash = "#/tv";
    }
    if (typeof renderTV === "function") renderTV();
    if (typeof initTV   === "function") initTV();
  }

  // Cerrar menús al navegar
  (function patchNav(){
    if (!window.nav || window.__CDL_NAV_PATCHED__) return;
    const ORIG = window.nav;
    window.nav = function(page){
      ORIG && ORIG(page);
      if (typeof window.closeAllMenus === "function") window.closeAllMenus();
    };
    window.__CDL_NAV_PATCHED__ = true;
  })();

  // Sincroniza --hdr-h con debouncing
  function debounce(fn, ms=120){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
  const syncHdr = debounce(()=>{
    const hdr = document.querySelector("header");
    const h = Math.max(64, hdr?.offsetHeight||0);
    document.documentElement.style.setProperty('--hdr-h', h+'px');
  }, 80);
  window.addEventListener("resize", syncHdr, {passive:true});
  window.addEventListener("orientationchange", syncHdr, {passive:true});
  (document.fonts?.ready || Promise.resolve()).then(syncHdr);

  // Carga inicial + arranque
  document.addEventListener("DOMContentLoaded", async ()=>{
    try{
      await Promise.all([
        typeof loadState        === "function" ? loadState()        : Promise.resolve(),
        typeof loadIncid        === "function" ? loadIncid()        : Promise.resolve(),
        typeof loadInv          === "function" ? loadInv()          : Promise.resolve(),
        typeof loadRepSol       === "function" ? loadRepSol()       : Promise.resolve(),
        typeof loadConsumibles  === "function" ? loadConsumibles()  : Promise.resolve(),
        typeof loadOT           === "function" ? loadOT()           : Promise.resolve(),
      ]);
      if (typeof calcKPIs === "function") calcKPIs();
      if (typeof renderTV === "function") renderTV();
      if (typeof initTV   === "function") initTV();
      handleHash();
      updateSummaryTimestamp();
      syncHdr();
    }catch(e){ console.error(e); }
  });
})();
</script>
<!-- ========== FIN BLOQUE 88 ========== -->

<!-- ========== BLOQUE 89 (ESTILOS EXTRA: METALIZADOS + TARJETAS EQUIPO) ========== -->
<style>
:root{
  --brand1:#A60000; --brand2:#E43B3B;
  --ok:#16a34a; --warn:#f59e0b; --stop:#dc2626;
  /* paleta oscura */
  --ink:#0b0f15; --muted:#6b7280; --line:#1f2937;
  --panel:#0d1117; --panelAlt:#141a22;
}

/* Botón metalizado oscuro genérico */
.btn, .page-btn{
  border:1px solid #2a2f38;
  color:#fff;
  background:linear-gradient(180deg,#3b3f46 0%, #1a1e24 48%, #0e1217 100%);
  box-shadow:inset 0 1px 0 rgba(255,255,255,.18), 0 8px 18px rgba(0,0,0,.35);
  border-radius:999px; padding:.46rem .9rem; font-weight:800; letter-spacing:.02em;
}
.btn:hover,.page-btn:hover{ filter:brightness(1.06); }
.btn:active,.page-btn:active{ transform:translateY(1px); }

/* Variantes semáforo */
.btn-sema.ok{
  background:linear-gradient(180deg,#38d46d 0%, #14853a 48%, #0d5f29 100%);
  border-color:#0b5a2a;
}
.btn-sema.warn{
  background:linear-gradient(180deg,#ffd56a 0%, #de930f 48%, #8b5b07 100%);
  border-color:#7b4c05; color:#111;
}
.btn-sema.stop{
  background:linear-gradient(180deg,#ff6868 0%, #c31313 48%, #820a0a 100%);
  border-color:#6f0808; text-shadow:0 1px 0 rgba(0,0,0,.25);
}

/* Utilitarias */
.btn-dark{  background:linear-gradient(180deg,#2b2f35 0%, #10141a 100%); border-color:#252a31; }
.btn-ghost{ background:linear-gradient(180deg,#1c2026 0%, #0a0d11 100%); border-color:#2a3038; }

/* Píldoras/Badges negras metalizadas */
.badge, .rolechip, #status-strip span, #legend-equipos span{
  background:linear-gradient(180deg,#2c3036 0%, #14181f 100%) !important;
  color:#fff !important; border:1px solid #2b313a !important;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.12);
}
#status-strip{
  background:#0c1117 !important; color:#e5e7eb !important; border-bottom:1px solid #1f2937 !important;
}

/* Puntos de color */
.dot-stop{ background:var(--stop); } .dot-warn{ background:var(--warn); } .dot-ok{ background:var(--ok); }

/* Tarjeta de equipo alineada */
.card.equipo{
  background:linear-gradient(180deg,#0f141b,#0b1016)!important; border:1px solid #1c2430!important;
  border-radius:14px; padding:.75rem .85rem;
  display:grid; grid-template-columns:1fr auto auto; gap:.6rem; align-items:center;
}
.eq-main{ min-width:0; }
.eq-name{ font-weight:900; letter-spacing:.02em; color:#e7e9ee; display:flex; gap:.45rem; align-items:center; }
.eq-line{ font-size:.85rem; color:#9aa4b2; }
.eq-state{ display:flex; align-items:center; gap:.45rem; }
.eq-actions{ display:flex; gap:.35rem; flex-wrap:wrap; justify-content:flex-end; }
.state-chip{
  display:inline-flex; align-items:center; gap:.35rem; padding:.18rem .55rem; border-radius:999px;
  border:1px solid #2a3038; background:linear-gradient(180deg,#2e333a,#161b22); font-weight:900; color:#fff;
}
.state-dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }
.state-parada .state-dot{ background:var(--stop); }
.state-restr  .state-dot{ background:var(--warn); }
.state-marcha .state-dot{ background:var(--ok); }

/* Tablas oscuras */
thead th{ background:#0e141b!important; color:#e7eaef!important; border-bottom:1px solid #1f2937!important; }
tbody td{ border-top:1px solid #151b22!important; }
.card{ background:linear-gradient(180deg,#0f141b,#0b1016); border:1px solid #1c2430; }

/* Panel de menú metalizado */
.panel{
  background:linear-gradient(180deg,#131a24,#0b1117)!important; color:#e5e7eb!important;
  border:1px solid #1f2937!important; box-shadow:0 24px 60px rgba(0,0,0,.45)!important;
}
#pagesPanel.menu-full .btn{
  background:linear-gradient(180deg,#2b2f35 0%, #11161c 100%)!important; border:1px solid #2b3139!important; color:#fff!important;
}

/* Header sobrio */
header{ background:linear-gradient(180deg,#0f141b,#0b1016)!important; border-bottom:1px solid #1f2937!important; }
.hero-title .hero-panel{ color:#f3f4f6; }
header.scrolled{ box-shadow:0 6px 22px rgba(0,0,0,.45)!important; }
</style>
<!-- ========== FIN BLOQUE 89 ========== -->

<!-- ========== BLOQUE 90 (REVAMP EQUIPOS + ACCIONES RÁPIDAS) ========== -->
<script>
(function(){
  if (window.__CDL_EQUIPOS_REVAMP__) return;
  window.__CDL_EQUIPOS_REVAMP__ = true;

  const apiPost = window.apiPost || (async()=>({ok:false}));

  async function setEquipoEstado(nombre, estado){
    try{
      const r = await apiPost({res:"state", fn:"set", nombre, estado, actor:(window.USER?.user||"anon")});
      if(r?.ok){
        (window.toast||console.log)(`Estado de ${nombre}: ${estado}`);
        if (typeof loadState==="function") await loadState();
      }else{
        alert(r?.error||"No se pudo actualizar el estado");
      }
    }catch(e){ console.error(e); alert("Error de red"); }
  }

  async function crearIncidenciaRapida({equipo,tipo,desc}){
    try{
      const payload = {equipo, tipo, desc:(desc||tipo), actor:(window.USER?.user||"anon")};
      const r = await apiPost({res:"incid", fn:"add", item:payload});
      if (r?.ok){
        (window.toast||console.log)("Incidencia creada");
        if (typeof loadIncid==="function") loadIncid();
      }else{
        alert(r?.error||"No se pudo crear la incidencia");
      }
    }catch(e){ console.error(e); alert("Error de red"); }
  }

  window.setEquipoEstado = setEquipoEstado;
  window.crearIncidenciaRapida = crearIncidenciaRapida;

  // Override del render de equipos con el nuevo estilo alineado
  window.renderEquiposList = function(){
    const wrap = document.getElementById("equiposWrap"); if(!wrap) return;
    const items = (window.STATE||[]);
    if(!items.length){ wrap.innerHTML = `<div class="card">Sin datos</div>`; return; }

    const grupos = {};
    items.forEach(it=>{ (grupos[it.grupo]=grupos[it.grupo]||[]).push(it); });

    const cls = { "Parada":"state-parada", "Restricciones":"state-restr", "En marcha":"state-marcha" };
    const iconEq = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#e5e7eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M8 21h8"/></svg>`;

    const html = Object.entries(grupos).map(([g,arr])=>{
      const filas = arr.map(it=>`
        <div class="card equipo">
          <div class="eq-main">
            <div class="eq-name">${iconEq}<span>${esc(it.nombre)}</span></div>
            <div class="eq-line">${esc(g)}</div>
          </div>

          <div class="eq-state ${cls[it.estado]||'state-restr'}">
            <span class="state-chip"><i class="state-dot"></i>${esc(it.estado)}</span>
          </div>

          <div class="eq-actions">
            <button class="btn btn-sema ok"   title="En marcha"        onclick='setEquipoEstado(${JSON.stringify(it.nombre)},"En marcha")'>Marcha</button>
            <button class="btn btn-sema warn" title="Restricciones"    onclick='setEquipoEstado(${JSON.stringify(it.nombre)},"Restricciones")'>Restr.</button>
            <button class="btn btn-sema stop" title="Parada"           onclick='setEquipoEstado(${JSON.stringify(it.nombre)},"Parada")'>Paro</button>
            <button class="btn btn-dark"      title="Parada planificada" onclick='crearIncidenciaRapida({equipo:${JSON.stringify(it.nombre)}, tipo:"Parada planificada"})'>Planif.</button>
            <button class="btn btn-ghost"     title="Nueva incidencia"   onclick='crearIncidenciaRapida({equipo:${JSON.stringify(it.nombre)}, tipo:"Incidencia", desc:"Nueva incidencia"})'>Incid.</button>
            <button class="btn"               onclick="location.hash='#/equipo/${encodeURIComponent(slugify(it.nombre))}'">Ficha</button>
            <button class="btn"               onclick="accionParadaProlongada(${JSON.stringify(it.nombre)})">Parada prolongada</button>
          </div>
        </div>`
      ).join("");

      return `<div style="margin:.8rem 0">
        <h3 style="margin:.2rem 0 .6rem; color:#e5e7eb; font-weight:900; letter-spacing:.04em">${esc(g)}</h3>
        <div style="display:flex; flex-direction:column; gap:.5rem">${filas}</div>
      </div>`;
    }).join("");

    wrap.innerHTML = html;
  };

  try{ if ((window.STATE||[]).length) renderEquiposList(); }catch(_){}
})();
</script>
<!-- ========== FIN BLOQUE 90 ========== -->
<!-- ========== BLOQUE 91 (BOOT FINAL + MENÚ AUTOCLOSE) ========== -->
<script>
(function(){
  if (window.__CDL_BOOT_FINAL__) return;
  window.__CDL_BOOT_FINAL__ = true;

  // Cierre automático de menús al navegar
  (function(){
    if (window.__CDL_MENU_AUTOCLOSE__) return;
    window.__CDL_MENU_AUTOCLOSE__ = true;

    const pagesPanel = document.getElementById("pagesPanel");
    if (pagesPanel){
      pagesPanel.addEventListener("click",(e)=>{
        const trg = e.target.closest("button,[data-nav]");
        if (!trg) return;
        const dataNav = trg.getAttribute("data-nav");
        if (dataNav && typeof nav==="function"){ nav(dataNav); }
        if (typeof window.closeAllMenus === "function") window.closeAllMenus();
      }, true);
    }
  })();

  // Forzar refresco de cabecera en scroll
  (function(){
    const hdr = document.querySelector("header");
    const onScroll = ()=>{ if(window.scrollY>2) hdr?.classList.add("scrolled"); else hdr?.classList.remove("scrolled"); };
    onScroll();
    window.addEventListener("scroll", onScroll, {passive:true});
  })();
})();
</script>
<!-- ========== FIN BLOQUE 91 ========== -->

<!-- ========== BLOQUE 92 (PATCH STATUS STRIP + KPI) ========== -->
<script>
(function(){
  if (window.__CDL_STATUS_PATCH__) return;
  window.__CDL_STATUS_PATCH__ = true;

  window.calcKPIs = function(){
    try{
      const nStop = (STATE||[]).filter(x=>x.estado==="Parada").length;
      const nWarn = (STATE||[]).filter(x=>x.estado==="Restricciones").length;
      const nOk   = (STATE||[]).filter(x=>x.estado==="En marcha").length;

      document.getElementById("kStop").textContent = nStop;
      document.getElementById("kWarn").textContent = nWarn;
      document.getElementById("kOk").textContent   = nOk;
      document.getElementById("kAll").textContent  = (STATE||[]).length;
    }catch(e){ console.error("calcKPIs", e); }
  };
})();
</script>
<!-- ========== FIN BLOQUE 92 ========== -->

<!-- ========== BLOQUE 93 (SAFE AREA + PWA + QR LIB) ========== -->
<script>
// Service Worker PWA
(function(){
  if (!("serviceWorker" in navigator)) return;
  window.addEventListener("load", async () => {
    try {
      const reg = await navigator.serviceWorker.register("/sw.js", { updateViaCache:"none" });
      if (reg.waiting) reg.waiting.postMessage({ type:"SKIP_WAITING" });
      reg.addEventListener("updatefound", () => {
        const nw = reg.installing;
        nw && nw.addEventListener("statechange", () => {
          if (nw.state==="installed" && navigator.serviceWorker.controller){
            reg.waiting && reg.waiting.postMessage({ type:"SKIP_WAITING" });
          }
        });
      });
      navigator.serviceWorker.addEventListener("controllerchange", ()=> location.reload());
    }catch(e){ console.error("SW register error", e); }
  });
})();

// QRCode lazy load
(function(){
  if (window.QRCode || document.querySelector("script[data-qrcode-lib]")) return;
  const s = document.createElement("script");
  s.src = "https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js";
  s.setAttribute("data-qrcode-lib","1");
  document.head.appendChild(s);
})();
</script>
<!-- ========== FIN BLOQUE 93 ========== -->
<!-- ========== BLOQUE 94 (ACCESIBILIDAD: FOCUS TRAP EN MENÚ) ========== -->
<script>
(function(){
  if (window.__CDL_A11Y_MENU_TRAP__) return;
  window.__CDL_A11Y_MENU_TRAP__ = true;

  const panel = document.getElementById('pagesPanel');
  const btn   = document.getElementById('pagesBtn');

  if (panel){
    panel.setAttribute('role','dialog');
    panel.setAttribute('aria-modal','true');

    let lastFocusedBeforeOpen = null;

    function getFocusable(container){
      return [...container.querySelectorAll(`
        a[href],button:not([disabled]),
        input:not([disabled]),select:not([disabled]),textarea:not([disabled]),
        [tabindex]:not([tabindex="-1"])
      `)].filter(el => el.offsetParent !== null || el === document.activeElement);
    }

    function trap(e){
      if (e.key !== 'Tab') return;
      const f = getFocusable(panel);
      if (!f.length) return;
      const first = f[0], last = f[f.length - 1];
      if (e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
      else if (!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
    }

    const mo = new MutationObserver(()=>{
      const isOpen = !panel.classList.contains('hidden');
      if (isOpen){
        lastFocusedBeforeOpen = document.activeElement;
        panel.addEventListener('keydown', trap, true);
        // Enfoca el primer elemento interactivo del panel
        const focusables = getFocusable(panel);
        (focusables[0] || panel).focus({preventScroll:true});
      }else{
        panel.removeEventListener('keydown', trap, true);
        // Vuelve el foco al botón del menú o al último foco
        (btn || lastFocusedBeforeOpen || document.body).focus?.({preventScroll:true});
      }
    });
    mo.observe(panel, { attributes:true, attributeFilter:['class'] });
  }
})();
</script>
<!-- ========== FIN BLOQUE 94 ========== -->

<!-- ========== BLOQUE 95 (API: RETRY CON EXPONENTIAL BACKOFF) ========== -->
<script>
(function(){
  if (window.__CDL_API_RETRY__) return;
  window.__CDL_API_RETRY__ = true;

  const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));
  const jitter = (ms)=> ms + Math.floor(Math.random()*Math.min(250, ms));

  async function withRetry(fn, {tries=3, base=300} = {}){
    let attempt = 0, lastErr;
    while (attempt < tries){
      try{ return await fn(); }
      catch(e){
        lastErr = e;
        attempt++;
        if (attempt >= tries) break;
        await sleep(jitter(base * Math.pow(2, attempt-1)));
      }
    }
    throw lastErr;
  }

  // Mantén apiGet/apiPost tal cual y expón variantes con retry
  if (typeof window.apiGet === 'function'){
    window.apiGetRetry = async function(q, opt){
      return withRetry(()=> window.apiGet(q), opt);
    };
  }
  if (typeof window.apiPost === 'function'){
    window.apiPostRetry = async function(body, opt){
      return withRetry(()=> window.apiPost(body), opt);
    };
  }

  // Hook suave en cargas masivas si existen (opcional, no invasivo)
  if (typeof window.loadState === 'function' && !window.__CDL_PATCH_LOADSTATE__){
    window.__CDL_PATCH_LOADSTATE__ = true;
    const _orig = window.loadState;
    window.loadState = async function(){
      try{ return await withRetry(()=>_orig(), {tries:2, base:250}); }
      catch(e){ console.error('loadState (retry agotado)', e); return _orig(); }
    };
  }
})();
</script>
<!-- ========== FIN BLOQUE 95 ========== -->

<!-- ========== BLOQUE 96 (OFFLINE BANNER + REINTENTOS SUAVES) ========== -->
<style>
#netBanner{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:12px; z-index:3200; padding:.5rem .8rem; border-radius:10px;
  background:#111827; color:#e5e7eb; border:1px solid #1f2937;
  box-shadow:0 10px 26px rgba(0,0,0,.35); display:none; font-weight:800;
}
#netBanner.online{ background:#065f46; border-color:#064e3b; }
#netBanner.offline{ background:#7f1d1d; border-color:#6b1010; }
</style>
<div id="netBanner" aria-live="polite" aria-atomic="true"></div>
<script>
(function(){
  if (window.__CDL_NET_STATUS__) return;
  window.__CDL_NET_STATUS__ = true;

  const banner = document.getElementById('netBanner');
  function show(msg, cls){
    if (!banner) return;
    banner.textContent = msg;
    banner.classList.remove('online','offline');
    if (cls) banner.classList.add(cls);
    banner.style.display = 'block';
    clearTimeout(window.__NET_BANNER_T);
    window.__NET_BANNER_T = setTimeout(()=> banner.style.display='none', 2200);
  }

  function onOnline(){  show('Conectado de nuevo', 'online');  }
  function onOffline(){ show('Sin conexión', 'offline'); }

  window.addEventListener('online',  onOnline,  {passive:true});
  window.addEventListener('offline', onOffline, {passive:true});

  // Estado inicial
  if (!navigator.onLine) onOffline();

  // Desactivar acciones sensibles cuando estás offline (no invasivo)
  document.addEventListener('click', (e)=>{
    if (navigator.onLine) return;
    const btn = e.target.closest('button,[data-requires-net]');
    if (!btn) return;
    // Permite navegación local pero bloquea llamadas evidentes a API
    const blocks = /delta|guardar|set|add|mail|login|chpwd/i.test(btn.outerHTML);
    if (blocks){
      e.preventDefault(); e.stopImmediatePropagation();
      show('Acción bloqueada (offline)', 'offline');
    }
  }, true);

})();
</script>
<!-- ========== FIN BLOQUE 96 ========== -->
<!-- ========== BLOQUE 97 (CACHE LOCAL: ESTADO E INCIDENCIAS) ========== -->
<script>
(function(){
  if (window.__CDL_CACHE_STATE__) return;
  window.__CDL_CACHE_STATE__ = true;

  const KEY_STATE = "CDL_STATE_CACHE_V1";
  const KEY_INCID = "CDL_INCID_CACHE_V1";

  function save(key, val){
    try{ localStorage.setItem(key, JSON.stringify({ts:Date.now(), val})); }
    catch(e){ console.warn("No se pudo guardar cache", e); }
  }
  function load(key){
    try{
      const raw = localStorage.getItem(key);
      if (!raw) return null;
      const {ts,val} = JSON.parse(raw);
      return {ts,val};
    }catch(_){ return null; }
  }

  // Hooks sobre loadState / loadIncid
  if (typeof window.loadState === "function" && !window.__PATCH_LOADSTATE_CACHE__){
    window.__PATCH_LOADSTATE_CACHE__=true;
    const orig = window.loadState;
    window.loadState = async function(){
      const cached = load(KEY_STATE);
      if (cached?.val && (Date.now()-cached.ts)<60000){ // <1min
        window.STATE = cached.val;
        try{ renderEquiposList(); renderTV?.(); }catch(_){}
      }
      const r = await orig.apply(this, arguments);
      save(KEY_STATE, window.STATE||[]);
      return r;
    };
  }
  if (typeof window.loadIncid === "function" && !window.__PATCH_LOADINCID_CACHE__){
    window.__PATCH_LOADINCID_CACHE__=true;
    const orig = window.loadIncid;
    window.loadIncid = async function(){
      const cached = load(KEY_INCID);
      if (cached?.val && (Date.now()-cached.ts)<120000){ // <2min
        window.INCID = cached.val;
        try{ renderIncidenciasTable(window.INCID); }catch(_){}
      }
      const r = await orig.apply(this, arguments);
      save(KEY_INCID, window.INCID||[]);
      return r;
    };
  }
})();
</script>
<!-- ========== FIN BLOQUE 97 ========== -->

<!-- ========== BLOQUE 98 (CACHE LOCAL: INVENTARIO + REPUESTOS) ========== -->
<script>
(function(){
  if (window.__CDL_CACHE_INV__) return;
  window.__CDL_CACHE_INV__ = true;

  const KEY_INV = "CDL_INV_CACHE_V1";
  const KEY_REP = "CDL_REP_CACHE_V1";

  function save(key, val){
    try{ localStorage.setItem(key, JSON.stringify({ts:Date.now(), val})); }
    catch(e){}
  }
  function load(key){
    try{
      const raw = localStorage.getItem(key);
      if (!raw) return null;
      return JSON.parse(raw);
    }catch(_){ return null; }
  }

  if (typeof window.loadInv==="function" && !window.__PATCH_LOADINV_CACHE__){
    window.__PATCH_LOADINV_CACHE__=true;
    const orig = window.loadInv;
    window.loadInv = async function(){
      const cached = load(KEY_INV);
      if (cached?.val){
        window.INV = cached.val;
        try{ renderInv(window.INV); }catch(_){}
      }
      const r = await orig.apply(this, arguments);
      save(KEY_INV, window.INV||[]);
      return r;
    };
  }

  if (typeof window.loadRepSol==="function" && !window.__PATCH_LOADREP_CACHE__){
    window.__PATCH_LOADREP_CACHE__=true;
    const orig = window.loadRepSol;
    window.loadRepSol = async function(){
      const cached = load(KEY_REP);
      if (cached?.val){
        window.REP = cached.val;
        try{ renderRepTable(); }catch(_){}
      }
      const r = await orig.apply(this, arguments);
      save(KEY_REP, window.REP||[]);
      return r;
    };
  }
})();
</script>
<!-- ========== FIN BLOQUE 98 ========== -->

<!-- ========== BLOQUE 99 (CACHE LOCAL: CONSUMIBLES + OT) ========== -->
<script>
(function(){
  if (window.__CDL_CACHE_CONS_OT__) return;
  window.__CDL_CACHE_CONS_OT__ = true;

  const KEY_CONS = "CDL_CONS_CACHE_V1";
  const KEY_OTS  = "CDL_OTS_CACHE_V1";

  function save(k,v){ try{ localStorage.setItem(k, JSON.stringify({ts:Date.now(),val:v})); }catch(_){} }
  function load(k){ try{ return JSON.parse(localStorage.getItem(k)||"null"); }catch(_){ return null; } }

  if (typeof window.loadConsumibles==="function" && !window.__PATCH_LOADCONS_CACHE__){
    window.__PATCH_LOADCONS_CACHE__=true;
    const orig = window.loadConsumibles;
    window.loadConsumibles = async function(){
      const cached = load(KEY_CONS);
      if (cached?.val){
        window.CONS = cached.val;
        try{ renderConsTable(); renderConsAlerts?.(); }catch(_){}
      }
      const r = await orig.apply(this, arguments);
      save(KEY_CONS, window.CONS||[]);
      return r;
    };
  }

  if (typeof window.loadOT==="function" && !window.__PATCH_LOADOT_CACHE__){
    window.__PATCH_LOADOT_CACHE__=true;
    const orig = window.loadOT;
    window.loadOT = async function(){
      const cached = load(KEY_OTS);
      if (cached?.val){
        window.OTS = cached.val;
        try{ renderOTTable(); }catch(_){}
      }
      const r = await orig.apply(this, arguments);
      save(KEY_OTS, window.OTS||[]);
      return r;
    };
  }
})();
</script>
<!-- ========== FIN BLOQUE 99 ========== -->
<!-- ========== BLOQUE 100 (RED/REINTENTOS + COLA OFFLINE PARA POST) ========== -->
<script>
(function(){
  if (window.__CDL_NET_ENHANCER__) return; window.__CDL_NET_ENHANCER__ = true;

  // Indicador de estado de red (ligero)
  let netBadge;
  function mountNetBadge(){
    if (netBadge || document.getElementById('netBadge')) return;
    netBadge = document.createElement('div');
    netBadge.id = 'netBadge';
    Object.assign(netBadge.style, {
      position:'fixed', right:'12px', bottom:'12px', zIndex:'3200',
      padding:'.28rem .5rem', borderRadius:'999px', fontWeight:'800',
      border:'1px solid #1f2937', background:'#0b0f15', color:'#e5e7eb',
      boxShadow:'0 10px 24px rgba(0,0,0,.35)', opacity:'0', transition:'opacity .25s ease'
    });
    netBadge.textContent = 'Sin conexión';
    document.body.appendChild(netBadge);
  }
  function showNetBadge(show){
    mountNetBadge();
    if (!netBadge) return;
    netBadge.style.opacity = show ? '1' : '0';
  }
  window.addEventListener('online',  ()=> showNetBadge(false), {passive:true});
  window.addEventListener('offline', ()=> showNetBadge(true),  {passive:true});
  if (!navigator.onLine) { // estado inicial
    if (document.readyState !== 'loading') showNetBadge(true);
    else document.addEventListener('DOMContentLoaded', ()=> showNetBadge(true));
  }

  // Utilidades
  const sleep = (ms)=> new Promise(r=> setTimeout(r, ms));
  const randJitter = (base)=> base + Math.floor(Math.random()*base*0.25);

  // Cola persistente para POST cuando no haya red
  const QKEY = 'CDL_POST_QUEUE_V1';
  function readQueue(){ try{ return JSON.parse(localStorage.getItem(QKEY)||'[]'); }catch(_){ return []; } }
  function writeQueue(arr){ try{ localStorage.setItem(QKEY, JSON.stringify(arr||[])); }catch(_){ } }
  async function flushQueue(){
    const q = readQueue(); if (!q.length || !navigator.onLine) return;
    let remain = [];
    for (const job of q){
      try{
        const r = await fetch(window.API_BASE, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(job.body), credentials:'omit', cache:'no-cache'
        });
        const data = await r.json();
        if (!data?.ok) remain.push(job);
      }catch(_){ remain.push(job); }
    }
    writeQueue(remain);
    if (!remain.length) (window.toast||console.log)('Cola enviada');
  }
  window.flushQueue = flushQueue;
  window.addEventListener('online', ()=> { flushQueue().catch(()=>{}); }, {passive:true});

  // Envoltorios con reintentos y timeout suave
  const ORIG_GET  = window.apiGet;
  const ORIG_POST = window.apiPost;

  if (!window.__CDL_FETCH_WRAP__){
    window.__CDL_FETCH_WRAP__ = true;

    window.apiGet = async function(q, {retries=2, timeout=9000}={}){
      if (!ORIG_GET) throw new Error('apiGet no definido');
      for (let i=0; i<=retries; i++){
        try{
          const ctl = new AbortController();
          const t = setTimeout(()=> ctl.abort(), timeout);
          // Reimplementamos GET usando fetch directo para añadir timeout
          const u = new URL(window.API_BASE);
          Object.entries(q||{}).forEach(([k,v])=> u.searchParams.set(k,v));
          const r = await fetch(u.toString(), {signal: ctl.signal, credentials:'omit', cache:'no-cache'});
          clearTimeout(t);
          return await r.json();
        }catch(e){
          if (i===retries) throw e;
          await sleep(randJitter(400*(i+1)));
        }
      }
    };

    window.apiPost = async function(body, {retries=2, timeout=9000, queueOnFail=true}={}){
      if (!ORIG_POST) console.warn('apiPost original no estaba definido; usando wrapper directo.');
      for (let i=0; i<=retries; i++){
        try{
          if (!navigator.onLine) throw new Error('offline');
          const ctl = new AbortController();
          const t = setTimeout(()=> ctl.abort(), timeout);
          const r = await fetch(window.API_BASE, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify(body||{}), signal: ctl.signal, credentials:'omit', cache:'no-cache'
          });
          clearTimeout(t);
          const data = await r.json();
          if (!data?.ok) throw new Error('api not ok');
          return data;
        }catch(e){
          if (i===retries){
            if (queueOnFail){
              const q = readQueue(); q.push({ ts:Date.now(), body });
              writeQueue(q);
              (window.toast||console.log)('Sin red: acción en cola');
              showNetBadge(true);
              return { ok:false, queued:true };
            }
            throw e;
          }
          await sleep(randJitter(500*(i+1)));
        }
      }
    };
  }
})();
</script>
<!-- ========== FIN BLOQUE 100 ========== -->

<!-- ========== BLOQUE 101 (CAPTURA DE ERRORES GLOBALES + AVISO UI) ========== -->
<script>
(function(){
  if (window.__CDL_ERROR_GUARD__) return; window.__CDL_ERROR_GUARD__ = true;

  function notify(msg){
    try{
      (window.toast||console.log)(msg);
    }catch(_){ console.log('[CDL]', msg); }
  }

  // UI ligera de error recurrente (evita spam)
  let lastMsg='', lastTs=0;
  function notifyOnce(msg){
    const now = Date.now();
    if (msg===lastMsg && (now-lastTs)<4000) return;
    lastMsg = msg; lastTs = now; notify(msg);
  }

  window.addEventListener('error', (e)=>{
    const src = e?.filename ? ` · ${e.filename}:${e.lineno||0}` : '';
    notifyOnce('Se atrapó un error en la página'+src);
    // Opcional: enviar a backend
    try{
      window.apiPost?.({res:'log', fn:'error', item:{
        type:'error', message:String(e?.message||'unknown'), src:e?.filename||'', line:e?.lineno||0, col:e?.colno||0, stack:String(e?.error?.stack||''),
        ua:navigator.userAgent, ts:new Date().toISOString()
      }}, {queueOnFail:true});
    }catch(_){}
  });

  window.addEventListener('unhandledrejection', (e)=>{
    const reason = e?.reason;
    notifyOnce('Se atrapó una promesa rechazada');
    try{
      window.apiPost?.({res:'log', fn:'error', item:{
        type:'unhandledrejection',
        message: typeof reason==='string' ? reason : (reason?.message||'unknown'),
        stack: reason?.stack||'',
        ua:navigator.userAgent, ts:new Date().toISOString()
      }}, {queueOnFail:true});
    }catch(_){}
  });
})();
</script>
<!-- ========== FIN BLOQUE 101 ========== -->

<!-- ========== BLOQUE 102 (MÉTRICAS DE RENDIMIENTO LIGERAS) ========== -->
<script>
(function(){
  if (window.__CDL_PERF__) return; window.__CDL_PERF__ = true;

  // Primero: métricas core si están disponibles
  try{
    const po = new PerformanceObserver((list)=>{
      for (const entry of list.getEntries()){
        if (entry.entryType === 'largest-contentful-paint'){
          console.log('[PERF] LCP:', Math.round(entry.startTime));
          window.apiPost?.({res:'perf', fn:'metric', item:{k:'LCP', v:Math.round(entry.startTime), ts:Date.now()}}, {queueOnFail:true});
        }
        if (entry.entryType === 'first-input'){
          console.log('[PERF] FID:', Math.round(entry.processingStart - entry.startTime));
          window.apiPost?.({res:'perf', fn:'metric', item:{k:'FID', v:Math.round(entry.processingStart-entry.startTime), ts:Date.now()}}, {queueOnFail:true});
        }
        if (entry.entryType === 'layout-shift' && !entry.hadRecentInput && entry.value){
          // CLS se acumula; aquí enviamos incrementos
          const v = Number((entry.value||0).toFixed(4));
          window.__CLS_ACC__ = (window.__CLS_ACC__||0) + v;
        }
      }
    });
    po.observe({ type:'largest-contentful-paint', buffered:true });
    po.observe({ type:'first-input',             buffered:true });
    po.observe({ type:'layout-shift',           buffered:true });
    window.addEventListener('pagehide', ()=>{
      const cls = Number((window.__CLS_ACC__||0).toFixed(4));
      if (cls>0){
        console.log('[PERF] CLS:', cls);
        window.apiPost?.({res:'perf', fn:'metric', item:{k:'CLS', v:cls, ts:Date.now()}}, {queueOnFail:true});
      }
    }, {passive:true});
  }catch(_){}

  // Segundo: tiempos básicos de carga y frío/caliente
  window.addEventListener('load', ()=>{
    try{
      const t = performance.timing;
      const navStart = t.navigationStart;
      const domContentLoaded = t.domContentLoadedEventEnd - navStart;
      const loadTime = t.loadEventEnd ? (t.loadEventEnd - navStart) : (performance.now());
      const paint = performance.getEntriesByType('paint')||[];
      const fp = Math.round((paint.find(e=>e.name==='first-paint')?.startTime)||0);
      const fcp= Math.round((paint.find(e=>e.name==='first-contentful-paint')?.startTime)||0);
      console.log('[PERF] DCL:', domContentLoaded, 'ms · LOAD:', Math.round(loadTime), 'ms · FP:', fp, 'ms · FCP:', fcp, 'ms');

      const cold = !sessionStorage.getItem('CDL_SEEN');
      sessionStorage.setItem('CDL_SEEN','1');

      window.apiPost?.({res:'perf', fn:'summary', item:{
        cold, dcl:domContentLoaded, load:Math.round(loadTime), fp, fcp, ts:Date.now(), ua:navigator.userAgent
      }}, {queueOnFail:true});
    }catch(_){}
  }, {once:true});
})();
</script>
<!-- ========== FIN BLOQUE 102 ========== -->
<!-- ========== BLOQUE 103 (MODO OFFLINE UI + AVISO) ========== -->
<script>
(function(){
  if (window.__CDL_OFFLINE_UI__) return; window.__CDL_OFFLINE_UI__ = true;

  // Banner superior para aviso offline
  let banner;
  function ensureBanner(){
    if (banner || document.getElementById('offlineBanner')) return;
    banner = document.createElement('div');
    banner.id = 'offlineBanner';
    Object.assign(banner.style, {
      position:'fixed', top:'0', left:'0', right:'0', zIndex:'4000',
      padding:'.4rem .8rem', fontWeight:'900', textAlign:'center',
      background:'#b91c1c', color:'#fff',
      transform:'translateY(-100%)', transition:'transform .35s ease'
    });
    banner.textContent = 'Sin conexión — los cambios se guardarán en cola';
    document.body.appendChild(banner);
  }
  function showBanner(show){
    ensureBanner();
    if (!banner) return;
    banner.style.transform = show ? 'translateY(0)' : 'translateY(-100%)';
  }
  window.addEventListener('online', ()=> showBanner(false), {passive:true});
  window.addEventListener('offline', ()=> showBanner(true),  {passive:true});
  if (!navigator.onLine){
    if (document.readyState!=='loading') showBanner(true);
    else document.addEventListener('DOMContentLoaded', ()=> showBanner(true));
  }
})();
</script>
<!-- ========== FIN BLOQUE 103 ========== -->

<!-- ========== BLOQUE 104 (CACHE LOCAL BÁSICA PARA ESTADO) ========== -->
<script>
(function(){
  if (window.__CDL_STATE_CACHE__) return; window.__CDL_STATE_CACHE__ = true;

  const KEY = 'CDL_STATE_CACHE_V1';
  function saveState(items){
    try{ localStorage.setItem(KEY, JSON.stringify({ts:Date.now(), items:items||[]})); }catch(_){}
  }
  function loadStateCache(){
    try{ const o = JSON.parse(localStorage.getItem(KEY)||'null'); return o?.items||[]; }catch(_){ return []; }
  }

  // Hook a loadState para usar cache
  const origLoadState = window.loadState;
  window.loadState = async function(){
    try{
      const cache = loadStateCache();
      if (cache?.length && !navigator.onLine){
        window.STATE = cache;
        window.renderEquiposList?.();
        window.renderTV?.();
      }
      if (typeof origLoadState === 'function'){
        const r = await origLoadState();
        if (window.STATE?.length) saveState(window.STATE);
        return r;
      }
    }catch(e){ console.error('state cache', e); }
  };
})();
</script>
<!-- ========== FIN BLOQUE 104 ========== -->

<!-- ========== BLOQUE 105 (MODO OSCURO/CLARO TOGGLE MANUAL) ========== -->
<script>
(function(){
  if (window.__CDL_THEME_TOGGLE__) return; window.__CDL_THEME_TOGGLE__ = true;

  const THEME_KEY = 'CDL_THEME';
  function applyTheme(t){
    document.documentElement.setAttribute('data-theme', t);
    localStorage.setItem(THEME_KEY, t);
  }
  function getTheme(){
    return localStorage.getItem(THEME_KEY) || (matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light');
  }
  window.toggleTheme = function(){
    const cur = getTheme();
    const next = cur==='dark' ? 'light' : 'dark';
    applyTheme(next);
    (window.toast||console.log)(`Tema: ${next}`);
  };
  // init
  if (document.readyState!=='loading') applyTheme(getTheme());
  else document.addEventListener('DOMContentLoaded', ()=> applyTheme(getTheme()));
})();
</script>
<!-- ========== FIN BLOQUE 105 ========== -->
<!-- ========== BLOQUE 106 (NOTIFICACIONES BROWSER API) ========== -->
<script>
(function(){
  if (window.__CDL_NOTIFS__) return; window.__CDL_NOTIFS__ = true;

  async function requestPerm(){
    if (!("Notification" in window)) return false;
    if (Notification.permission==="granted") return true;
    if (Notification.permission!=="denied"){
      const p = await Notification.requestPermission();
      return p==="granted";
    }
    return false;
  }
  window.notifyUser = async function(msg){
    try{
      const ok = await requestPerm();
      if (!ok){ (window.toast||console.log)(msg); return; }
      new Notification("CDL · CMMS",{ body: msg, icon:"/icon-192.png" });
    }catch(e){ console.error("notifyUser",e); }
  };
})();
</script>
<!-- ========== FIN BLOQUE 106 ========== -->

<!-- ========== BLOQUE 107 (SYNC EN SEGUNDO PLANO) ========== -->
<script>
(function(){
  if (window.__CDL_BG_SYNC__) return; window.__CDL_BG_SYNC__ = true;

  // Si existe service worker con sync
  async function registerSync(tag){
    try{
      const reg = await navigator.serviceWorker.ready;
      await reg.sync.register(tag);
      console.log("Sync registrado", tag);
    }catch(e){ console.error("sync", e); }
  }
  window.queueChange = async function(change){
    try{
      const arr = JSON.parse(localStorage.getItem("CDL_CHANGES")||"[]");
      arr.push(change);
      localStorage.setItem("CDL_CHANGES", JSON.stringify(arr));
      if (navigator.onLine) registerSync("cdl-sync");
    }catch(e){ console.error("queueChange", e); }
  };
})();
</script>
<!-- ========== FIN BLOQUE 107 ========== -->

<!-- ========== BLOQUE 108 (ACCESSIBILIDAD EXTRA: FOCUS-VISIBLE) ========== -->
<style>
:focus{ outline:none; }
:focus-visible{
  outline:2px solid var(--brand2);
  outline-offset:2px;
}
</style>
<script>
(function(){
  if (window.__CDL_A11Y__) return; window.__CDL_A11Y__ = true;
  // Anunciar navegación de hash para screen readers
  window.addEventListener("hashchange", ()=>{
    const live = document.getElementById("sr-live");
    if (live){ live.textContent = "Página "+location.hash.replace("#/",""); }
  });
})();
</script>
<div id="sr-live" aria-live="polite" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden"></div>
<!-- ========== FIN BLOQUE 108 ========== -->
<!-- ========== BLOQUE 109 (RENDER DIFERIDO Y OPTIMIZACIONES) ========== -->
<script>
(function(){
  if (window.__CDL_DEFER__) return; window.__CDL_DEFER__ = true;

  // Utilidad segura de requestIdleCallback (fallback)
  const ric = window.requestIdleCallback || function(cb){ return setTimeout(()=>cb({timeRemaining:()=>5, didTimeout:true}), 1); };
  const caf = window.cancelIdleCallback || clearTimeout;

  // Cola de tareas ligeras que no son críticas para la interacción
  const q = [];
  function enqueue(task){ q.push(task); pump(); }
  let pumping = false, rid = null;
  function pump(){
    if (pumping) return;
    pumping = true;
    rid = ric(function work(deadline){
      while ((deadline.timeRemaining() > 2 || deadline.didTimeout) && q.length){
        try{ q.shift()?.(); }catch(e){ console.error("idle task", e); }
      }
      pumping = false;
      if (q.length) pump();
    });
  }

  // Ejemplos de uso (aplicamos a tareas cosméticas existentes si están disponibles)
  enqueue(()=> {
    // Cargar QRCode si hace falta y aún no está (extra seguro)
    if (!window.QRCode && !document.querySelector('script[data-qrcode-lib]')) {
      const s = document.createElement("script");
      s.src = "https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js";
      s.setAttribute("data-qrcode-lib","1");
      document.head.appendChild(s);
    }
  });

  // Exponer para que otros bloques puedan programar tareas perezosas
  window.enqueueIdleTask = enqueue;

  // Auto-diferir refrescos de TV si la pestaña está en segundo plano
  document.addEventListener("visibilitychange", ()=>{
    if (!window.initTV || !window.renderTV) return;
    if (document.hidden){
      // nada: dejamos que el setInterval siga pero es barato; si quieres, podrías pausarlo aquí
    }else{
      try{ window.renderTV(); }catch(_){}
    }
  }, {passive:true});
})();
</script>
<!-- ========== FIN BLOQUE 109 ========== -->

<!-- ========== BLOQUE 110 (CAPTURA GLOBAL DE ERRORES + UI MINIMAL) ========== -->
<style>
#cdl-errorbar{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:16px; max-width:min(92vw,840px);
  background:linear-gradient(180deg,#2b2f35,#10141a);
  color:#fff; border:1px solid #2a3038; border-radius:12px;
  padding:.6rem .9rem; box-shadow:0 10px 26px rgba(0,0,0,.35); z-index:4000;
  display:none; align-items:center; gap:.6rem; font-weight:700;
}
#cdl-errorbar .close{ margin-left:auto; cursor:pointer; border:0; background:transparent; color:#e5e7eb; font-weight:900; }
#cdl-errorbar .hint{ font-weight:400; opacity:.8; }
</style>
<div id="cdl-errorbar" role="status" aria-live="polite">
  <span>Se produjo un problema inesperado.</span>
  <span class="hint">(Detalles en consola)</span>
  <button class="close" aria-label="Cerrar">✕</button>
</div>
<script>
(function(){
  if (window.__CDL_ERR_GUARD__) return; window.__CDL_ERR_GUARD__ = true;

  const bar = document.getElementById("cdl-errorbar");
  const hide = ()=> bar && (bar.style.display="none");
  const show = ()=> bar && (bar.style.display="flex");
  bar?.querySelector(".close")?.addEventListener("click", hide);

  function report(err, src, lineno, colno){
    try{
      console.error("[CDL Error]", err, src||"", lineno||"", colno||"");
      show();
      clearTimeout(window.__CDL_ERR_T);
      window.__CDL_ERR_T = setTimeout(hide, 8000);
    }catch(_){}
  }

  window.addEventListener("error", (e)=>{
    report(e.error||e.message, e.filename, e.lineno, e.colno);
  });

  window.addEventListener("unhandledrejection", (e)=>{
    report(e.reason||"Promise rejection");
  });
})();
</script>
<!-- ========== FIN BLOQUE 110 ========== -->

<!-- ========== BLOQUE 111 (I18N LIGERO + FORMATO FECHAS NAVEGADOR) ========== -->
<script>
(function(){
  if (window.__CDL_I18N__) return; window.__CDL_I18N__ = true;

  // Detección simple de idioma (mantén 'es-ES' como preferido)
  const userLang = (navigator.language || "es-ES").toLowerCase();
  const LOCALE = /es/.test(userLang) ? "es-ES" : ( /pt/.test(userLang) ? "pt-PT" : ( /fr/.test(userLang) ? "fr-FR" : "en-GB" ));

  // Diccionario mínimo (extensible)
  const T = {
    "es-ES": {
      RESUMEN: "RESUMEN",
      PARADAS: "Paradas",
      RESTRICCIONES: "Restricciones",
      EN_MARCHA: "En marcha",
      TOTAL: "Total",
      ULT_ACT: "Última actualización",
    },
    "en-GB": {
      RESUMEN: "SUMMARY",
      PARADAS: "Down",
      RESTRICCIONES: "Restrictions",
      EN_MARCHA: "Running",
      TOTAL: "Total",
      ULT_ACT: "Last update",
    },
    "fr-FR": {
      RESUMEN: "RÉSUMÉ",
      PARADAS: "Arrêts",
      RESTRICCIONES: "Restrictions",
      EN_MARCHA: "En marche",
      TOTAL: "Total",
      ULT_ACT: "Dernière mise à jour",
    },
    "pt-PT": {
      RESUMEN: "RESUMO",
      PARADAS: "Paragens",
      RESTRICCIONES: "Restrições",
      EN_MARCHA: "Em marcha",
      TOTAL: "Total",
      ULT_ACT: "Última atualização",
    }
  };

  // Utilidades de formato
  window.fmtDateLocale = function(input){
    try{ return input ? new Date(input).toLocaleString(LOCALE, { hour12:false }) : ""; }catch(_){ return String(input||""); }
  };
  window.fmtDateShort = function(input){
    try{ return input ? new Date(input).toLocaleDateString(LOCALE, { hour12:false }) : ""; }catch(_){ return String(input||""); }
  };

  // Helper de traducción
  window.tr = function(key){ return (T[LOCALE] && T[LOCALE][key]) || (T["es-ES"][key]||key); };

  // Ejemplo: si existen etiquetas del strip, actualiza textos (no rompe si no están)
  (function patchLabels(){
    const strip = document.getElementById("status-strip");
    if (!strip) return;
    // No tocamos los números; sólo etiquetas si estuvieran en spans identificables
    // Este bloque es ilustrativo y no invasivo
  })();
})();
</script>
<!-- ========== FIN BLOQUE 111 ========== -->
<!-- ========== BLOQUE 112 (ACCESIBILIDAD: LANDMARKS, SKIP-LINK, FOCUS) ========== -->
<style>
/* Enfoque visible y consistente */
:root{ --focus-ring: 0 0 0 3px rgba(59,130,246,.6), 0 0 0 6px rgba(59,130,246,.25); }
:where(a,button,[role="button"],input,select,textarea):focus{
  outline: none !important;
  box-shadow: var(--focus-ring) !important;
  border-radius: 10px;
}
.skip-link{
  position: fixed; left: 8px; top: 8px; z-index: 5000;
  transform: translateY(-150%); transition: transform .15s ease;
  background: #0b0f15; color: #e5e7eb; border:1px solid #1f2937;
  padding:.4rem .6rem; border-radius:10px; font-weight:800; text-decoration:none;
}
.skip-link:focus{ transform: translateY(0); }
[role="main"]{ outline: none; }
</style>

<!-- En la parte alta del body (pero sirve aquí también) -->
<a class="skip-link" href="#app-main">Saltar al contenido</a>

<script>
(function(){
  if (window.__CDL_A11Y__) return; window.__CDL_A11Y__ = true;

  // Asegura landmarks ARIA en los elementos principales
  const ensure = (sel, attr, val) => {
    const el = document.querySelector(sel); if (!el) return;
    if (!el.hasAttribute(attr)) el.setAttribute(attr, val);
  };

  // Header, navegación implícita y main
  ensure('header', 'role', 'banner');
  ensure('header .nav', 'role', 'navigation');

  // Marca el main y dale id de destino para skip-link
  let main = document.querySelector('main');
  if (main){ main.setAttribute('role','main'); if (!main.id) main.id = 'app-main'; }

  // Títulos: refuerza jerarquías sin alterar estilos
  document.querySelectorAll('section[id^="page-"] h2.cdl-tag')?.forEach(h=>{
    if (!h.getAttribute('tabindex')) h.setAttribute('tabindex','-1'); // foco anclable
  });

  // Mejor foco tras navegación por hash
  window.addEventListener('hashchange', ()=>{
    const h = location.hash||"";
    if (/^#\/(equipo|repuesto)\//.test(h)) {
      const sec = document.querySelector('#page-equipo:not(.hidden),#page-repuesto:not(.hidden)');
      const firstBtn = sec?.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      firstBtn?.focus?.();
    } else {
      document.getElementById('app-main')?.focus?.();
    }
  }, {passive:true});
})();
</script>
<!-- ========== FIN BLOQUE 112 ========== -->
<!-- ========== BLOQUE 113 (ESTILOS DE IMPRESIÓN: FICHAS/ETIQUETAS) ========== -->
<style media="print">
/* Reset básico para impresión */
*{ box-shadow:none !important; text-shadow:none !important; }
html, body{ background:#fff !important; color:#000 !important; }
header, #status-strip, .menu, .rolechip, .cdl-tag, .tv-grid, .tv-card, .btn, .page-btn, .panel, .card .actions{ display:none !important; }

#page-equipo:not(.hidden), #page-repuesto:not(.hidden){ display:block !important; }
#equipoDetail .card, #repuestoDetail .card{
  border:0 !important; background:#fff !important; padding:0 !important; box-shadow:none !important;
}

/* Cabecera clara para ficha */
#equipoDetail h3, #repuestoDetail h3{
  margin:0 0 6px 0 !important; font-size:20pt !important; color:#000 !important;
}
#equipoDetail .sub, #repuestoDetail .sub{ color:#000 !important; opacity:1 !important; margin-bottom:10px !important; }

/* Tabla simple si existiera contenido tabular */
table{ width:100%; border-collapse:collapse; }
th,td{ border:1px solid #000; padding:6px 8px; font-size:10pt; }

/* QR en impresión: tamaño adecuado */
#qrficha > img, #qrrep > img{ width:120px !important; height:120px !important; }

/* Márgenes de página */
@page{ margin: 16mm; }
</style>
<!-- ========== FIN BLOQUE 113 ========== -->
<!-- ========== BLOQUE 114 (MÉTRICAS LIGERAS + CONTROL DEL REFRESCO TV) ========== -->
<style>
#perf-panel{
  position: fixed; right: 12px; bottom: 12px; z-index: 3500;
  background: linear-gradient(180deg,#2b2f35,#10141a);
  color:#e5e7eb; border:1px solid #2a3038; border-radius:12px;
  padding:.5rem .6rem; font-size:.85rem; display:none; gap:.5rem; align-items:center;
}
#perf-panel input[type="number"]{
  width:72px; height:28px; border-radius:8px; border:1px solid #2a2f38; background:#0a0f14; color:#e5e7eb; padding:0 .4rem;
}
#perf-panel .btn-mini{
  border:1px solid #2a2f38; background:linear-gradient(180deg,#1c2026,#0a0d11); color:#fff; border-radius:999px;
  padding:.22rem .5rem; font-weight:800; cursor:pointer;
}
</style>
<div id="perf-panel" aria-label="Panel de rendimiento">
  <span id="perf-fps">— fps</span>
  <label for="tv-interval">TV Δ (ms)</label>
  <input id="tv-interval" type="number" min="1000" step="500" value="10000" />
  <button class="btn-mini" id="perf-apply">Aplicar</button>
  <button class="btn-mini" id="perf-hide">Ocultar</button>
</div>

<script>
(function(){
  if (window.__CDL_PERF__) return; window.__CDL_PERF__ = true;

  let tvTimer = null;
  const panel = document.getElementById('perf-panel');
  const fpsEl = document.getElementById('perf-fps');
  const inp   = document.getElementById('tv-interval');

  // FPS aproximado (requestAnimationFrame)
  (function trackFPS(){
    let last = performance.now(), frames = 0, acc = 0;
    function loop(ts){
      frames++; const dt = ts - last; last = ts; acc += dt;
      if (acc >= 1000){
        const fps = Math.round(frames * 1000 / acc);
        fpsEl && (fpsEl.textContent = fps + " fps");
        frames = 0; acc = 0;
      }
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);
  })();

  // Guarda/aplica intervalo de refresco del TV
  function setTVInterval(ms){
    try{
      ms = Math.max(1000, Number(ms)||10000);
      localStorage.setItem("CDL_TV_INTERVAL", String(ms));
      if (tvTimer) clearInterval(tvTimer);
      if (typeof window.renderTV === "function"){
        tvTimer = setInterval(window.renderTV, ms);
      }
    }catch(e){ console.error("setTVInterval", e); }
  }

  // Inicializa con lo guardado (si existe)
  try{
    const saved = Number(localStorage.getItem("CDL_TV_INTERVAL")||"");
    if (saved && inp) inp.value = String(saved);
    setTVInterval(saved || Number(inp?.value||10000));
  }catch(_){}

  // Controles UI
  document.getElementById('perf-apply')?.addEventListener('click', ()=>{
    setTVInterval(Number(inp?.value||10000));
    (window.toast||console.log)("Intervalo aplicado");
  });
  document.getElementById('perf-hide')?.addEventListener('click', ()=>{
    panel.style.display = "none";
  });

  // Tecla rápida: Alt+P para mostrar/ocultar panel
  document.addEventListener('keydown', (e)=>{
    if (e.altKey && (e.key||"").toLowerCase() === 'p'){
      panel.style.display = (panel.style.display === "none" || !panel.style.display) ? "flex" : "none";
    }
  }, {passive:true});

  // Performance marks en las cargas clave
  try{
    performance.mark("cdl:boot:start");
    window.addEventListener('load', ()=>{
      performance.mark("cdl:load:end");
      performance.measure("cdl:time_to_load", "cdl:boot:start", "cdl:load:end");
      const m = performance.getEntriesByName("cdl:time_to_load").pop();
      console.log("[CDL] time_to_load:", Math.round(m.duration), "ms");
    }, {once:true});
  }catch(_){}
})();
</script>
<!-- ========== FIN BLOQUE 114 ========== -->
<!-- ========== BLOQUE 115 (ESTILOS RESPONSIVOS + PANELES TV) ========== -->
<style>
/* Ajustes móviles y tablets */
@media (max-width: 720px){
  header .nav{ padding:.25rem .4rem; }
  .menu button#pagesBtn, .menu button#userBtn{ top:6px; width:32px; height:32px; }
  .hero-title .hero-panel{ font-size:.9rem; }
  main{ padding:.5rem; }
  .card{ padding:.55rem .6rem; }
  .tv-grid{ grid-template-columns:1fr; }
}
@media (min-width: 721px) and (max-width: 1024px){
  .tv-grid{ grid-template-columns:1fr 1fr; }
}
@media (min-width: 1025px){
  .tv-grid{ grid-template-columns:repeat(2,1fr); }
}

/* Panel de TV más compacto en pantallas pequeñas */
.tv-card h3{ font-size:.95rem; }
.tv-item{ font-size:.9rem; }
</style>
<!-- ========== FIN BLOQUE 115 ========== -->

<!-- ========== BLOQUE 116 (ESTILOS EXTRA COLOR CORPORATIVO) ========== -->
<style>
/* Colores corporativos */
:root{
  --corp-red:#A60000; --corp-red2:#E43B3B;
  --corp-gray:#1f2937; --corp-bg:#0b0f15;
}

/* Títulos con detalle corporativo */
.cdl-tag{
  font-weight:900; letter-spacing:.06em; text-transform:uppercase;
  color:var(--corp-red2); margin:.6rem 0 .8rem;
  border-left:4px solid var(--corp-red2); padding-left:.5rem;
}

/* Botones rojos principales */
.btn-primary{
  background:linear-gradient(180deg,var(--corp-red2),var(--corp-red));
  border:1px solid #7a0a0a; color:#fff; font-weight:900;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.25),0 6px 14px rgba(0,0,0,.35);
  border-radius:999px; padding:.46rem .9rem;
}
.btn-primary:hover{ filter:brightness(1.1); }

/* Ajuste de tarjetas con sombra ligera roja */
.card-highlight{
  border:1px solid var(--corp-red2);
  box-shadow:0 0 14px rgba(228,59,59,.3);
}
</style>
<!-- ========== FIN BLOQUE 116 ========== -->

<!-- ========== BLOQUE 117 (SCRIPT DE OPTIMIZACIÓN DE CARGA) ========== -->
<script>
(function(){
  if (window.__CDL_OPTIM__) return; window.__CDL_OPTIM__=true;

  // Precarga diferida de imágenes pesadas
  document.addEventListener("DOMContentLoaded", ()=>{
    document.querySelectorAll("img[data-src]").forEach(img=>{
      const src = img.getAttribute("data-src");
      if (src){ img.src = src; img.removeAttribute("data-src"); }
    });
  });

  // Lazy init para componentes pesados
  window.addEventListener("load", ()=>{
    // Ejemplo: precarga de fuentes opcionales
    const l = document.createElement("link");
    l.rel="stylesheet"; l.href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap";
    document.head.appendChild(l);
  }, {once:true});

  // Observa mutaciones para re-enfocar o recalcular cabecera
  const syncHdr = ()=>{ 
    const hdr=document.querySelector("header");
    const h=Math.max(64,hdr?.offsetHeight||0);
    document.documentElement.style.setProperty('--hdr-h',h+'px');
  };
  const mo=new MutationObserver(syncHdr);
  mo.observe(document.body,{childList:true,subtree:true});
})();
</script>
<!-- ========== FIN BLOQUE 117 ========== -->
<!-- ========== BLOQUE 118 (ACCESIBILIDAD: SKIP LINKS + ARIA HELPERS) ========== -->
<style>
/* Skip links visibles al enfocar (accesibilidad) */
.skip-links{ position:absolute; top:0; left:0; width:100%; display:flex; gap:.5rem; justify-content:center; z-index:3000; }
.skip-links a{
  position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden;
}
.skip-links a:focus{
  position:static; width:auto; height:auto; overflow:visible;
  background:#0b0f15; color:#e5e7eb; border:2px solid #94a3b8; border-radius:10px;
  padding:.35rem .6rem; box-shadow:0 10px 26px rgba(0,0,0,.35);
}

/* Resaltado de foco accesible sobre elementos interactivos */
a:focus, button:focus, [role="button"]:focus, input:focus, select:focus, textarea:focus{
  outline:2px solid #E43B3B; outline-offset:2px;
}
</style>

<!-- Skip links (inserta tras <body> si quieres máxima eficacia) -->
<nav class="skip-links" aria-label="Atajos de teclado">
  <a href="#status-strip">Saltar al resumen</a>
  <a href="#page-tv">Saltar al Dashboard TV</a>
  <a href="#equiposWrap">Saltar a la lista de equipos</a>
</nav>

<script>
/* ARIA helpers + título dinámico por sección (idempotente) */
(function(){
  if (window.__CDL_A11Y__) return; window.__CDL_A11Y__ = true;

  // Marcar regiones principales
  document.getElementById('status-strip')?.setAttribute('role','region');
  document.getElementById('status-strip')?.setAttribute('aria-label','Resumen de estado');
  document.querySelector('main')?.setAttribute('role','main');

  // Anunciar cambios de página para lectores de pantalla
  const live = document.createElement('div');
  live.setAttribute('aria-live','polite');
  live.setAttribute('aria-atomic','true');
  live.style.position = 'absolute';
  live.style.left = '-9999px';
  live.style.top = 'auto';
  live.id = 'sr-live';
  document.body.appendChild(live);

  const pageTitles = {
    "page-tv":"Dashboard TV",
    "page-equipos":"Equipos",
    "page-gruas":"Puentes Grúa",
    "page-otros":"Otros",
    "page-incidencias":"Incidencias",
    "page-indicadores":"Indicadores",
    "page-ot":"Órdenes de trabajo",
    "page-inv":"Inventario",
    "page-rep":"Repuestos solicitados",
    "page-cons":"Consumibles",
    "page-personal":"Personal",
    "page-logs":"Histórico de logs",
    "page-equipo":"Ficha de equipo",
    "page-repuesto":"Ficha de repuesto"
  };

  const announce = (id)=>{
    const t = pageTitles[id] || 'Sección';
    const msg = `Navegado a: ${t}`;
    const el = document.getElementById('sr-live'); if(!el) return;
    el.textContent = ''; // reset para disparar live region
    setTimeout(()=> el.textContent = msg, 10);
    document.title = `CDL · CMMS — ${t}`;
  };

  // Hook a nav() si existe
  if (typeof window.nav === 'function' && !window.__CDL_A11Y_NAV_PATCH__){
    const ORIG = window.nav;
    window.nav = function(page){
      ORIG && ORIG(page);
      const id = (window.PAGE_ID||{})[page] || '';
      if (id) announce(id);
    };
    window.__CDL_A11Y_NAV_PATCH__ = true;
  }

  // Anunciar también cuando se usan rutas #/equipo y #/repuesto
  const origRenderEq = window.renderEquipoBySlug;
  if (typeof origRenderEq === 'function'){
    window.renderEquipoBySlug = function(){
      origRenderEq.apply(this, arguments);
      announce('page-equipo');
    };
  }
  const origRenderRep = window.renderRepuestoByRef;
  if (typeof origRenderRep === 'function'){
    window.renderRepuestoByRef = function(){
      origRenderRep.apply(this, arguments);
      announce('page-repuesto');
    };
  }
})();
</script>
<!-- ========== FIN BLOQUE 118 ========== -->

<!-- ========== BLOQUE 119 (ESTILOS DE IMPRESIÓN: FICHAS, TABLAS, TV) ========== -->
<style>
@media print{
  /* Fondo blanco y tipografía legible al imprimir */
  html, body{ background:#fff !important; color:#111 !important; }
  header, .menu, #pagesPanel, #userPanel, .skip-links, #toast{ display:none !important; }
  a[href]:after{ content:""; } /* Evitar URLs en texto */

  /* Márgenes y tamaño de página */
  @page{ margin:12mm; }

  /* Tarjetas y tablas */
  .card{ border:1px solid #ddd !important; background:#fff !important; box-shadow:none !important; }
  table{ border:1px solid #bbb !important; }
  thead th{ background:#f3f4f6 !important; color:#111 !important; -webkit-print-color-adjust:exact; print-color-adjust:exact; }

  /* Fichas con QR visibles */
  #qrficha, #qrrep{ filter:none !important; }

  /* Ocultar elementos interactivos innecesarios en papel */
  button, .btn, .page-btn{ display:none !important; }

  /* Forzar secciones específicas según hash */
  #page-equipo:not(.hidden), #page-repuesto:not(.hidden){ display:block !important; }
}
</style>
<!-- ========== FIN BLOQUE 119 ========== -->

<!-- ========== BLOQUE 120 (ESTADO DE RED + RETRY + AVISOS) ========== -->
<style>
.net-banner{
  position:fixed; left:50%; bottom:14px; transform:translateX(-50%);
  background:#111827; color:#e5e7eb; border:1px solid #1f2937; border-radius:12px;
  padding:.45rem .7rem; z-index:3500; display:flex; align-items:center; gap:.6rem;
  box-shadow:0 10px 26px rgba(0,0,0,.35);
}
.net-banner .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }
.net-off .dot{ background:#dc2626; }
.net-on  .dot{ background:#16a34a; }
.net-banner button{ border:1px solid #2a2f38; background:#0b1016; color:#e5e7eb; border-radius:999px; padding:.25rem .6rem; cursor:pointer; }
.net-banner.hidden{ display:none; }
</style>
<div id="netBanner" class="net-banner net-on hidden" role="status" aria-live="polite">
  <span class="dot"></span>
  <span id="netMsg">Conectado</span>
  <button id="btnRetry" type="button" aria-label="Reintentar carga">Reintentar</button>
</div>

<script>
/* Banner de conectividad + reintento de cargas (idempotente) */
(function(){
  if (window.__CDL_NET__) return; window.__CDL_NET__=true;
  const $ = (id)=>document.getElementById(id);
  const banner = $('netBanner'), msg=$('netMsg'), btn=$('btnRetry');

  function setState(on){
    banner.classList.toggle('hidden', on);
    banner.classList.toggle('net-off', !on);
    banner.classList.toggle('net-on', on);
    msg.textContent = on ? 'Conectado' : 'Sin conexión. Cambios se guardarán cuando vuelva la red.';
  }

  // Eventos del navegador
  window.addEventListener('online',  ()=> setState(true),  {passive:true});
  window.addEventListener('offline', ()=> setState(false), {passive:true});
  // Estado inicial
  setState(navigator.onLine);

  // Reintento manual de cargas clave
  btn?.addEventListener('click', async ()=>{
    const tasks = [];
    if (typeof window.loadState       === 'function') tasks.push(loadState());
    if (typeof window.loadIncid       === 'function') tasks.push(loadIncid());
    if (typeof window.loadInv         === 'function') tasks.push(loadInv());
    if (typeof window.loadRepSol      === 'function') tasks.push(loadRepSol());
    if (typeof window.loadConsumibles === 'function') tasks.push(loadConsumibles());
    if (typeof window.loadOT          === 'function') tasks.push(loadOT());
    try{
      await Promise.all(tasks);
      (window.toast||console.log)('Datos actualizados');
    }catch(e){
      console.error(e);
      alert('No se pudo actualizar. Revisa tu conexión e inténtalo de nuevo.');
    }
  });

  // Fallback suave cuando un fetch falla: wrapper opcional
  if (!window.safeApiGet){
    window.safeApiGet = async function(q){
      try{ return await (window.apiGet?.(q)); }
      catch(e){ setState(false); throw e; }
    };
  }
  if (!window.safeApiPost){
    window.safeApiPost = async function(b){
      try{ return await (window.apiPost?.(b)); }
      catch(e){ setState(false); throw e; }
    };
  }
})();
</script>
<!-- ========== FIN BLOQUE 120 ========== -->
<!-- ========== BLOQUE 121 (EXPORT SIMPLE CSV HELPER) ========== -->
<script>
(function(){
  if (window.__CDL_CSV_HELPER__) return; window.__CDL_CSV_HELPER__=true;

  // Escapado básico para CSV (con ;)
  function csvEscape(v){
    v=(v==null?'':String(v));
    if (/[",\n;]/.test(v)) return `"${v.replace(/"/g,'""')}"`;
    return v;
  }

  // Exportador simple con cabecera y filas
  window.exportSimpleCSV = function(file, headers, items, rowFn){
    try{
      const rows = [headers].concat((items||[]).map(r=> rowFn(r)));
      const csv  = rows.map(r=> (r||[]).map(csvEscape).join(";")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = file;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    }catch(e){ console.error("exportSimpleCSV", e); }
  };
})();
</script>
<!-- ========== FIN BLOQUE 121 ========== -->

<!-- ========== BLOQUE 122 (MEJORA TOAST + ALERTAS DE ERROR) ========== -->
<script>
(function(){
  if (window.__CDL_TOAST_PATCH__) return; window.__CDL_TOAST_PATCH__=true;

  // Versión mejorada de toast: colores por tipo
  window.toast = function(msg, type="info"){
    let t = document.getElementById("toast");
    if(!t){
      t = document.createElement("div");
      t.id = "toast";
      Object.assign(t.style, {
        position:"fixed", left:"50%", bottom:"16px", transform:"translateX(-50%)",
        borderRadius:"12px", padding:".55rem .9rem",
        boxShadow:"0 12px 28px rgba(0,0,0,.35)",
        fontWeight:"700", zIndex:"4000", transition:"opacity .25s ease"
      });
      document.body.appendChild(t);
    }
    let bg="#111827", col="#e5e7eb";
    if (type==="ok"){ bg="#16a34a"; col="#fff"; }
    if (type==="warn"){ bg="#f59e0b"; col="#000"; }
    if (type==="err"){ bg="#dc2626"; col="#fff"; }
    t.style.background=bg; t.style.color=col;
    t.style.opacity="1"; t.textContent = String(msg||"");
    clearTimeout(window.__TOAST_T);
    window.__TOAST_T = setTimeout(()=> t.style.opacity="0", 2000);
  };

  // Captura errores globales para mostrar aviso
  window.addEventListener("error", (e)=>{
    console.error(e.error||e.message);
    toast("⚠️ Error en la aplicación", "err");
  });
  window.addEventListener("unhandledrejection", (e)=>{
    console.error(e.reason);
    toast("⚠️ Fallo en operación asíncrona", "err");
  });
})();
</script>
<!-- ========== FIN BLOQUE 122 ========== -->

<!-- ========== BLOQUE 123 (KEYBOARD SHORTCUTS / ACCESOS RÁPIDOS) ========== -->
<script>
(function(){
  if (window.__CDL_SHORTCUTS__) return; window.__CDL_SHORTCUTS__=true;

  const map = {
    "Alt+1":"tv",
    "Alt+2":"equipos",
    "Alt+3":"incidencias",
    "Alt+4":"inventario",
    "Alt+5":"repuestos"
  };

  document.addEventListener("keydown", (e)=>{
    const combo = (e.altKey?"Alt+":"")+(e.ctrlKey?"Ctrl+":"")+(e.key.length===1?e.key.toUpperCase():e.key);
    if (map[combo]){
      e.preventDefault();
      if (typeof window.nav==="function") nav(map[combo]);
      toast(`Atajo → ${map[combo]}`, "ok");
    }
  }, {passive:false});
})();
</script>
<!-- ========== FIN BLOQUE 123 ========== -->
<!-- ========== BLOQUE 124 (LOADING OVERLAY + API HOOKS) ========== -->
<style>
#appLoading{
  position:fixed; inset:0; display:none; place-items:center;
  background:rgba(13,17,23,.55); backdrop-filter:saturate(120%) blur(4px);
  z-index:3500;
}
#appLoading .box{
  background:linear-gradient(180deg,#0f141b,#0b1016);
  border:1px solid #1c2430; color:#e5e7eb;
  padding:1rem 1.2rem; border-radius:14px; display:flex; gap:.8rem; align-items:center;
  box-shadow:0 20px 60px rgba(0,0,0,.45);
}
#appLoading .spin{
  width:22px; height:22px; border-radius:50%;
  border:3px solid #334155; border-top-color:#e5e7eb; animation:spin 1s linear infinite;
}
@keyframes spin{ to{ transform:rotate(360deg); } }
</style>
<div id="appLoading" aria-hidden="true">
  <div class="box"><div class="spin" role="img" aria-label="Cargando"></div><b>Cargando…</b></div>
</div>
<script>
(function(){
  if (window.__CDL_LOADING__) return; window.__CDL_LOADING__=true;
  const el = document.getElementById('appLoading');
  let count = 0, T=null;

  function show(){
    count++; clearTimeout(T);
    el.style.display = "grid";
    el.setAttribute("aria-hidden","false");
  }
  function hide(){
    count = Math.max(0, count-1);
    if (count===0){
      T = setTimeout(()=>{ el.style.display="none"; el.setAttribute("aria-hidden","true"); }, 120);
    }
  }
  window.loading = { show, hide };
})();
</script>
<!-- ========== FIN BLOQUE 124 ========== -->

<!-- ========== BLOQUE 125 (ONLINE/OFFLINE BANNER) ========== -->
<style>
#netBanner{
  position:fixed; left:50%; transform:translateX(-50%); bottom:12px;
  display:none; align-items:center; gap:.5rem; padding:.45rem .8rem;
  border-radius:12px; z-index:3600; font-weight:800;
  border:1px solid #7f1d1d; background:linear-gradient(180deg,#7f1d1d,#991b1b); color:#fff;
  box-shadow:0 14px 32px rgba(0,0,0,.35);
}
#netBanner.ok{
  border-color:#065f46; background:linear-gradient(180deg,#065f46,#047857);
}
</style>
<div id="netBanner" role="status">⚠️ Sin conexión</div>
<script>
(function(){
  if (window.__CDL_NET_BANNER__) return; window.__CDL_NET_BANNER__=true;
  const b = document.getElementById('netBanner');
  let t=null;
  function show(txt, ok=false){
    b.textContent = txt;
    b.classList.toggle('ok', !!ok);
    b.style.display="flex";
    clearTimeout(t);
    if (ok){ t = setTimeout(()=> b.style.display="none", 1400); }
  }
  function on(){ show("✅ Conectado de nuevo", true); }
  function off(){ show("⚠️ Sin conexión"); }
  window.addEventListener('online', on, {passive:true});
  window.addEventListener('offline', off, {passive:true});
  if (!navigator.onLine) off();
})();
</script>
<!-- ========== FIN BLOQUE 125 ========== -->

<!-- ========== BLOQUE 126 (API FETCH CON RETRIES + INTEGRACIÓN) ========== -->
<script>
(function(){
  if (window.__CDL_API_RETRY__) return; window.__CDL_API_RETRY__=true;

  // Backoff exponencial con jitter
  async function apiFetch(url, opts={}, {retries=3, baseDelay=300}={}){
    for (let i=0; i<=retries; i++){
      try{
        loading?.show();
        const r = await fetch(url, { ...opts, credentials:"omit", cache:"no-cache" });
        if (!r.ok) throw new Error("HTTP "+r.status);
        const ct = (r.headers.get("content-type")||"").toLowerCase();
        return ct.includes("application/json") ? await r.json() : await r.text();
      }catch(err){
        if (i===retries) throw err;
        const jitter = Math.random()*120;
        await new Promise(res=> setTimeout(res, baseDelay*Math.pow(2,i)+jitter));
      }finally{
        loading?.hide();
      }
    }
  }

  // Parchea apiGet/apiPost si existen (sin romper firmas)
  const BASE = window.API_BASE || "";
  if (!window.apiGet){
    window.apiGet = async function(q){
      const u = new URL(BASE);
      Object.entries(q||{}).forEach(([k,v])=> u.searchParams.set(k, v));
      return apiFetch(u.toString(), {}, {retries:2});
    };
  }else{
    const origGet = window.apiGet;
    window.apiGet = async function(q){
      try{ return await origGet(q); }
      catch(_){
        // Fallback usando apiFetch
        const u = new URL(BASE);
        Object.entries(q||{}).forEach(([k,v])=> u.searchParams.set(k, v));
        return apiFetch(u.toString(), {}, {retries:2});
      }
    };
  }

  if (!window.apiPost){
    window.apiPost = async function(body){
      return apiFetch(BASE, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body||{})
      }, {retries:2});
    };
  }else{
    const origPost = window.apiPost;
    window.apiPost = async function(body){
      try{ return await origPost(body); }
      catch(_){
        return apiFetch(BASE, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(body||{})
        }, {retries:2});
      }
    };
  }
})();
</script>
<!-- ========== FIN BLOQUE 126 ========== -->
<!-- ========== BLOQUE 127 (MODO PANTALLA COMPLETA) ========== -->
<style>
#fullToggle{
  position:fixed; right:12px; bottom:12px; z-index:3600;
  width:40px; height:40px; border-radius:10px;
  display:grid; place-items:center;
  background:linear-gradient(180deg,#1f2937,#111827);
  border:1px solid #374151; color:#e5e7eb; cursor:pointer;
  box-shadow:0 10px 28px rgba(0,0,0,.4);
}
</style>
<button id="fullToggle" title="Pantalla completa">⛶</button>
<script>
(function(){
  if (window.__CDL_FULLSCR__) return; window.__CDL_FULLSCR__=true;
  const b = document.getElementById("fullToggle");
  if (!b) return;
  b.addEventListener("click", ()=>{
    if (!document.fullscreenElement){
      document.documentElement.requestFullscreen?.();
    }else{
      document.exitFullscreen?.();
    }
  });
})();
</script>
<!-- ========== FIN BLOQUE 127 ========== -->

<!-- ========== BLOQUE 128 (MODO OSCURO/CLARO OPCIONAL) ========== -->
<style>
#themeToggle{
  position:fixed; left:12px; bottom:12px; z-index:3600;
  width:40px; height:40px; border-radius:10px;
  display:grid; place-items:center;
  background:linear-gradient(180deg,#111,#222);
  border:1px solid #333; color:#f9fafb; cursor:pointer;
  box-shadow:0 10px 28px rgba(0,0,0,.4);
}
html.light body{ background:#f9fafb; color:#111827; }
html.light header{ background:linear-gradient(180deg,#f3f4f6,#e5e7eb); }
html.light .card{ background:#fff; color:#111; border:1px solid #ccc; }
</style>
<button id="themeToggle" title="Cambiar tema">🌙</button>
<script>
(function(){
  if (window.__CDL_THEME__) return; window.__CDL_THEME__=true;
  const b = document.getElementById("themeToggle");
  const root = document.documentElement;
  if (!b) return;
  b.addEventListener("click", ()=>{
    root.classList.toggle("light");
    localStorage.setItem("CDL_THEME", root.classList.contains("light")?"light":"dark");
  });
  // restaurar preferencia
  const saved = localStorage.getItem("CDL_THEME");
  if (saved==="light"){ root.classList.add("light"); }
})();
</script>
<!-- ========== FIN BLOQUE 128 ========== -->

<!-- ========== BLOQUE 129 (HELP POPUP + INFO APP) ========== -->
<style>
#helpPopup{
  position:fixed; inset:0; display:none; z-index:3700;
  background:rgba(0,0,0,.55); backdrop-filter:blur(3px);
  place-items:center;
}
#helpPopup .box{
  background:#0f141b; color:#e5e7eb; max-width:480px;
  border:1px solid #1f2937; border-radius:14px;
  padding:1rem 1.2rem; box-shadow:0 22px 60px rgba(0,0,0,.45);
}
#helpPopup .close{ float:right; cursor:pointer; font-weight:900; }
</style>
<div id="helpPopup">
  <div class="box">
    <span class="close" onclick="document.getElementById('helpPopup').style.display='none'">✖</span>
    <h2>Ayuda · CDL CMMS</h2>
    <p>Usa el menú ☰ para navegar entre módulos.</p>
    <ul>
      <li>📊 <b>Dashboard TV</b>: visión global</li>
      <li>🛠 <b>Equipos</b>: estados y acciones</li>
      <li>📦 <b>Inventario</b>: stock y repuestos</li>
      <li>⚡ <b>Incidencias</b>: reportes y seguimiento</li>
    </ul>
  </div>
</div>
<script>
(function(){
  if (window.__CDL_HELPPOP__) return; window.__CDL_HELPPOP__=true;
  // Tecla "?" abre ayuda
  document.addEventListener("keydown",(e)=>{
    if (e.key==="?" || (e.shiftKey && e.key==="/")){
      const h = document.getElementById("helpPopup");
      if (h) h.style.display="grid";
    }
  },{passive:true});
})();
</script>
<!-- ========== FIN BLOQUE 129 ========== -->
<!-- ========== BLOQUE 130 (TOOLTIP GLOBAL) ========== -->
<style>
.tooltip{
  position:absolute; z-index:4000; background:#111827; color:#f9fafb;
  padding:.35rem .55rem; border-radius:6px; font-size:.78rem; font-weight:600;
  white-space:nowrap; pointer-events:none; opacity:0; transition:opacity .15s ease;
  border:1px solid #374151; box-shadow:0 4px 16px rgba(0,0,0,.45);
}
</style>
<div id="tooltip" class="tooltip"></div>
<script>
(function(){
  if(window.__CDL_TOOLTIP__) return; window.__CDL_TOOLTIP__=true;
  const tip=document.getElementById("tooltip");
  document.addEventListener("mouseover",e=>{
    const t=e.target.closest("[title]");
    if(!t) return;
    tip.textContent=t.getAttribute("title");
    tip.style.opacity="1";
  });
  document.addEventListener("mousemove",e=>{
    if(tip.style.opacity==="1"){
      tip.style.left=(e.pageX+12)+"px"; tip.style.top=(e.pageY+12)+"px";
    }
  });
  document.addEventListener("mouseout",()=> tip.style.opacity="0");
})();
</script>
<!-- ========== FIN BLOQUE 130 ========== -->

<!-- ========== BLOQUE 131 (MODAL GENÉRICO) ========== -->
<style>
#modal{
  position:fixed; inset:0; background:rgba(0,0,0,.55); display:none;
  place-items:center; z-index:4100;
}
#modal .box{
  background:#0f141b; color:#e5e7eb; padding:1rem 1.2rem;
  border:1px solid #1f2937; border-radius:14px; max-width:600px;
  box-shadow:0 24px 70px rgba(0,0,0,.55);
}
</style>
<div id="modal"><div class="box" id="modalBox"></div></div>
<script>
(function(){
  if(window.__CDL_MODAL__) return; window.__CDL_MODAL__=true;
  window.showModal=(html)=>{ 
    document.getElementById("modalBox").innerHTML=html;
    document.getElementById("modal").style.display="grid";
  };
  window.hideModal=()=> document.getElementById("modal").style.display="none";
  document.getElementById("modal").addEventListener("click",e=>{
    if(e.target.id==="modal") hideModal();
  });
})();
</script>
<!-- ========== FIN BLOQUE 131 ========== -->

<!-- ========== BLOQUE 132 (ATLAS DE COLORES CORPORATIVOS) ========== -->
<style>
.palette{display:flex;gap:.6rem;flex-wrap:wrap}
.palette div{
  width:60px;height:60px;border-radius:8px;
  display:flex;align-items:center;justify-content:center;
  font-size:.7rem;font-weight:700;color:#fff;
}
.p-brand1{background:#A60000}.p-brand2{background:#E43B3B}
.p-ink{background:#111827}.p-muted{background:#475569}
.p-ok{background:#16a34a}.p-warn{background:#f59e0b}.p-stop{background:#dc2626}
</style>
<!-- ========== FIN BLOQUE 132 ========== -->

<!-- ========== BLOQUE 133 (LOADER / SPINNER) ========== -->
<style>
#loader{
  position:fixed; inset:0; display:none; z-index:4200;
  background:rgba(0,0,0,.55); place-items:center;
}
.loader-spin{
  width:48px;height:48px;border:5px solid #374151;
  border-top-color:#e43b3b;border-radius:50%;animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
<div id="loader"><div class="loader-spin"></div></div>
<script>
(function(){
  if(window.__CDL_LOADER__) return; window.__CDL_LOADER__=true;
  window.showLoader=()=> document.getElementById("loader").style.display="grid";
  window.hideLoader=()=> document.getElementById("loader").style.display="none";
})();
</script>
<!-- ========== FIN BLOQUE 133 ========== -->

<!-- ========== BLOQUE 134 (NOTIFICACIONES LARGAS) ========== -->
<style>
#notify{
  position:fixed; top:16px; right:16px; z-index:4300;
  display:flex; flex-direction:column; gap:.5rem;
}
.notify-item{
  background:#0f141b;color:#e5e7eb;padding:.6rem .8rem;
  border:1px solid #1f2937;border-radius:10px;min-width:240px;
  box-shadow:0 12px 30px rgba(0,0,0,.45);font-weight:700;
}
</style>
<div id="notify"></div>
<script>
(function(){
  if(window.__CDL_NOTIFY__) return; window.__CDL_NOTIFY__=true;
  window.notify=(msg,ms=3500)=>{
    const box=document.createElement("div");
    box.className="notify-item"; box.textContent=msg;
    document.getElementById("notify").appendChild(box);
    setTimeout(()=>box.remove(),ms);
  };
})();
</script>
<!-- ========== FIN BLOQUE 134 ========== -->

<!-- ========== BLOQUE 135 (SCROLL TOP BUTTON) ========== -->
<style>
#scrollTopBtn{
  position:fixed; right:14px; bottom:64px; z-index:4400;
  width:42px;height:42px;border-radius:50%;
  background:linear-gradient(180deg,#1f2937,#111827);
  border:1px solid #374151;color:#f9fafb;
  display:none;place-items:center;cursor:pointer;
  box-shadow:0 10px 28px rgba(0,0,0,.4);
}
</style>
<button id="scrollTopBtn">↑</button>
<script>
(function(){
  if(window.__CDL_SCROLLTOP__) return; window.__CDL_SCROLLTOP__=true;
  const b=document.getElementById("scrollTopBtn");
  window.addEventListener("scroll",()=>{
    if(window.scrollY>250){b.style.display="grid";}else{b.style.display="none";}
  },{passive:true});
  b.addEventListener("click",()=>window.scrollTo({top:0,behavior:"smooth"}));
})();
</script>
<!-- ========== FIN BLOQUE 135 ========== -->

<!-- ========== BLOQUE 136 (FILTROS BÚSQUEDA EQUIPOS) ========== -->
<style>
#filterBox{margin-bottom:.6rem;display:flex;gap:.5rem;flex-wrap:wrap}
#filterBox input{padding:.35rem .55rem;border-radius:8px;border:1px solid #374151;background:#0b1016;color:#e5e7eb}
</style>
<div id="filterBox">
  <input id="filterInput" placeholder="Buscar equipo...">
</div>
<script>
(function(){
  if(window.__CDL_FILTER__) return; window.__CDL_FILTER__=true;
  const inp=document.getElementById("filterInput");
  inp?.addEventListener("input",()=>{
    const q=inp.value.toLowerCase();
    document.querySelectorAll("#equiposWrap .card.equipo").forEach(c=>{
      const txt=c.textContent.toLowerCase();
      c.style.display=txt.includes(q)?"":"none";
    });
  });
})();
</script>
<!-- ========== FIN BLOQUE 136 ========== -->

<!-- ========== BLOQUE 137 (TECLAS RÁPIDAS) ========== -->
<script>
(function(){
  if(window.__CDL_KEYS__) return; window.__CDL_KEYS__=true;
  document.addEventListener("keydown",e=>{
    if(e.ctrlKey && e.key==="1") nav("equipos");
    if(e.ctrlKey && e.key==="2") nav("tv");
    if(e.ctrlKey && e.key==="3") nav("inventario");
  });
})();
</script>
<!-- ========== FIN BLOQUE 137 ========== -->

<!-- ========== BLOQUE 138 (ESTADÍSTICAS DE USO) ========== -->
<script>
(function(){
  if(window.__CDL_STATS__) return; window.__CDL_STATS__=true;
  let counts={};
  window.track=(k)=>{counts[k]=(counts[k]||0)+1;};
  window.getStats=()=>({...counts});
})();
</script>
<!-- ========== FIN BLOQUE 138 ========== -->

<!-- ========== BLOQUE 139 (COPYRIGHT FOOTER) ========== -->
<style>
footer{
  margin-top:2rem;padding:1rem;text-align:center;font-size:.8rem;
  color:#9ca3af;border-top:1px solid #1f2937;
}
</style>
<footer>© 2025 CDL · CMMS — Todos los derechos reservados</footer>
<!-- ========== FIN BLOQUE 139 ========== -->

<!-- ========== BLOQUE 140 (FINAL CIERRE) ========== -->
<script>
(function(){
  if(window.__CDL_FINAL__) return; window.__CDL_FINAL__=true;
  console.log("%cCDL · CMMS cargado correctamente","color:#E43B3B;font-weight:bold;font-size:14px;");
})();
</script>
<!-- ========== FIN BLOQUE 140 ========== -->
<!-- ========== BLOQUE 141 (BARRA DE PROGRESO GLOBAL) ========== -->
<style>
#progressBar{
  position:fixed; top:0; left:0; height:4px; width:0%;
  background:#E43B3B; z-index:5000; transition:width .25s ease;
}
</style>
<div id="progressBar"></div>
<script>
(function(){
  if(window.__CDL_PROGRESS__) return; window.__CDL_PROGRESS__=true;
  const bar=document.getElementById("progressBar");
  window.progress=(v)=>{ bar.style.width=Math.min(100,Math.max(0,v))+"%"; };
})();
</script>
<!-- ========== FIN BLOQUE 141 ========== -->

<!-- ========== BLOQUE 142 (BANNER DE ALERTA) ========== -->
<style>
#alertBanner{
  position:fixed; top:0; left:0; right:0;
  background:#dc2626; color:#fff; padding:.5rem 1rem;
  font-weight:700; text-align:center; display:none; z-index:5100;
}
</style>
<div id="alertBanner"></div>
<script>
(function(){
  if(window.__CDL_BANNER__) return; window.__CDL_BANNER__=true;
  const b=document.getElementById("alertBanner");
  window.showBanner=(msg)=>{b.textContent=msg; b.style.display="block";};
  window.hideBanner=()=> b.style.display="none";
})();
</script>
<!-- ========== FIN BLOQUE 142 ========== -->

<!-- ========== BLOQUE 143 (BREADCRUMBS) ========== -->
<style>
#breadcrumbs{padding:.5rem 1rem;color:#9ca3af;font-size:.85rem}
#breadcrumbs span{margin:0 .25rem}
</style>
<nav id="breadcrumbs"></nav>
<script>
(function(){
  if(window.__CDL_BREAD__) return; window.__CDL_BREAD__=true;
  window.setBreadcrumbs=(arr)=>{
    const bc=document.getElementById("breadcrumbs");
    bc.innerHTML=arr.map(x=>esc(x)).join("<span>›</span>");
  };
})();
</script>
<!-- ========== FIN BLOQUE 143 ========== -->

<!-- ========== BLOQUE 144 (CARGA PEREZOSA DE IMÁGENES) ========== -->
<script>
(function(){
  if(window.__CDL_LAZYIMG__) return; window.__CDL_LAZYIMG__=true;
  const imgs=document.querySelectorAll("img[data-src]");
  const obs=new IntersectionObserver((ents)=>{
    ents.forEach(e=>{
      if(e.isIntersecting){
        const img=e.target; img.src=img.dataset.src;
        obs.unobserve(img);
      }
    });
  });
  imgs.forEach(i=>obs.observe(i));
})();
</script>
<!-- ========== FIN BLOQUE 144 ========== -->

<!-- ========== BLOQUE 145 (BOTÓN DARK MODE) ========== -->
<style>
#darkModeBtn{
  position:fixed; left:16px; bottom:16px; z-index:5200;
  background:#111827; border:1px solid #374151; border-radius:50%;
  width:40px; height:40px; color:#f9fafb; display:grid;place-items:center;
}
</style>
<button id="darkModeBtn">☾</button>
<script>
(function(){
  if(window.__CDL_DARKMODE__) return; window.__CDL_DARKMODE__=true;
  const btn=document.getElementById("darkModeBtn");
  btn.addEventListener("click",()=>{
    document.documentElement.classList.toggle("dark");
  });
})();
</script>
<!-- ========== FIN BLOQUE 145 ========== -->

<!-- ========== BLOQUE 146 (TABLA RESPONSIVA) ========== -->
<style>
.table-wrap{overflow-x:auto;max-width:100%}
.table-wrap table{width:100%;border-collapse:collapse}
.table-wrap th,.table-wrap td{padding:.4rem .6rem;border:1px solid #1f2937}
.table-wrap th{background:#0f141b;color:#e5e7eb}
</style>
<!-- ========== FIN BLOQUE 146 ========== -->

<!-- ========== BLOQUE 147 (OFFLINE DETECTOR) ========== -->
<style>
#offline{position:fixed;top:0;left:0;right:0;padding:.4rem;background:#f59e0b;color:#111827;text-align:center;font-weight:700;display:none;z-index:5300}
</style>
<div id="offline">Sin conexión</div>
<script>
(function(){
  if(window.__CDL_OFFLINE__) return; window.__CDL_OFFLINE__=true;
  const b=document.getElementById("offline");
  window.addEventListener("offline",()=>b.style.display="block");
  window.addEventListener("online",()=>b.style.display="none");
})();
</script>
<!-- ========== FIN BLOQUE 147 ========== -->

<!-- ========== BLOQUE 148 (REGISTRO DE EVENTOS CONSOLE→UI) ========== -->
<style>
#consoleLog{background:#0f141b;color:#e5e7eb;font-family:monospace;padding:.5rem;max-height:200px;overflow:auto}
</style>
<div id="consoleLog"></div>
<script>
(function(){
  if(window.__CDL_CONSOLE__) return; window.__CDL_CONSOLE__=true;
  const log=document.getElementById("consoleLog");
  const orig=console.log;
  console.log=(...a)=>{orig(...a); log.innerHTML+="<div>"+a.map(x=>esc(x)).join(" ")+"</div>";};
})();
</script>
<!-- ========== FIN BLOQUE 148 ========== -->

<!-- ========== BLOQUE 149 (BOTÓN EXPORTAR TODO) ========== -->
<style>
#exportAll{margin:1rem;padding:.5rem 1rem;background:#E43B3B;color:#fff;font-weight:800;border:none;border-radius:8px;cursor:pointer}
</style>
<button id="exportAll">Exportar todo</button>
<script>
(function(){
  if(window.__CDL_EXPORTALL__) return; window.__CDL_EXPORTALL__=true;
  document.getElementById("exportAll")?.addEventListener("click",()=>{
    notify("Exportación masiva en progreso...");
  });
})();
</script>
<!-- ========== FIN BLOQUE 149 ========== -->

<!-- ========== BLOQUE 150 (CLOSE BODY+HTML) ========== -->
</body>
</html>
<!-- ========== FIN BLOQUE 150 ========== -->