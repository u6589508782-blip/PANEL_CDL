<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>CDL ¬∑ Panel de control</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
/* ============ Variables base ============ */
:root{
  --brand1:#A60000; --brand2:#E43B3B;         /* rojo corporativo */
  --ink:#0f172a; --muted:#475569; --line:#e5e7eb;
  --bg:#ffffff;                                /* blanco unificado */
  --panel:#ffffff;
  --hdr-h:100px; --nav-w:360px; --radius:18px; --gap:16px;
}

/* Reset */
*{box-sizing:border-box}
html,body{height:100%; background:var(--bg); overflow-x:hidden}
body{margin:0; font-family:Inter,system-ui,sans-serif; color:var(--ink)}
img{max-width:100%; display:block}
a{color:inherit; text-decoration:none}

/* ============ Cabecera ============ */
.header{ position:sticky; top:0; z-index:1000; min-height:var(--hdr-h); background:#fff; border-bottom:1px solid #eee; }
.header::before{
  content:""; position:absolute; inset:0;
  background:url("logo_mantenimiento.png") center top/70% no-repeat;
  opacity:.12; pointer-events:none;
}
.h__in{height:var(--hdr-h); display:flex; align-items:flex-end; gap:12px; padding:10px 14px; position:relative; z-index:1}

/* Rol arriba-derecha, sin p√≠ldora */
#roleChip{ position:absolute; right:12px; top:6px; font-weight:800; font-size:12px }

/* Botones cabecera sin p√≠ldora */
#hamb,#moreBtn{
  width:44px; height:44px; display:grid; place-items:center;
  background:transparent; border:0; border-radius:0; color:#0f172a; padding:6px;
}

/* Icono hamburguesa compacto (3 l√≠neas normales) */
#hamb .i{ display:inline-block; width:22px; height:16px; position:relative }
#hamb .i::before,#hamb .i::after,#hamb .i span{
  content:""; position:absolute; left:0; right:0; height:2px; background:#0f172a;
}
#hamb .i::before{ top:0 } 
#hamb .i span{ top:7px; display:block } 
#hamb .i::after{ bottom:0 }

/* Icono ‚ãØ compacto */
#moreBtn .i{ display:inline-block; width:18px; text-align:center; letter-spacing:2px; font-weight:800 }
#moreBtn .i::before{ content:"¬∑¬∑¬∑" }

/* Marca */
.brand{display:flex; align-items:center; gap:10px; transform:translateY(10px)}
.brand img{height:44px}
.brand__title{font-weight:800; letter-spacing:.02em; white-space:nowrap; text-transform:uppercase}

/* ============ SideNav (izquierda, no tapa cabecera) ============ */
#sidenav{
  position:fixed; left:0; top:var(--hdr-h); height:calc(100% - var(--hdr-h));
  width:min(92vw,var(--nav-w)); background:#fff; color:#0f172a;
  border-right:1px solid #e5e7eb; transform:translateX(-100%);
  transition:transform .25s ease; z-index:998; box-shadow:4px 0 18px rgba(0,0,0,.06);
}
#sidenav.open{ transform:none }

/* Cabecera del men√∫ lateral (logo + buscador + X) */
.sidenav__head{display:flex; align-items:center; gap:10px; padding:12px 14px}
.sidenav__head img{height:38px}
#btnCloseNav{
  margin-left:auto; width:40px; height:40px; display:grid; place-items:center;
  background:transparent; border:0; font-size:22px; line-height:1; cursor:pointer; color:#0f172a;
}
.sidenav__search{ padding:0 14px 8px }
.sidenav__search input{
  width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; font-weight:600;
}

/* Lista de secciones del men√∫ (MAY√öSCULAS) */
.navlist{ padding:8px 0 }
.navlist a{
  display:block; padding:14px 16px; font-weight:800; text-transform:uppercase; letter-spacing:.3px;
}
.navlist a:hover{ background:#f8fafc }

/* Separador con degradado (grueso en el centro, fino a los extremos) */
.sep{ height:1px; margin:6px 14px; background:
  linear-gradient(90deg, rgba(15,23,42,0) 0%, rgba(15,23,42,.22) 50%, rgba(15,23,42,0) 100%);
}

/* ============ Panel usuario (debajo cabecera, no la tapa) ============ */
#userPanel{
  position:fixed; right:10px; top:calc(var(--hdr-h) + 8px);
  width:360px; max-width:calc(100vw - 20px);
  background:#0f141c; color:#e6eef7; border:1px solid #223046; border-radius:14px;
  box-shadow:0 18px 36px rgba(0,0,0,.45); padding:14px; display:none; z-index:999;
}
#userPanel.show{ display:block }
#userPanel h3{ margin:6px 0 10px; font-size:14px; color:#cbd5e1 }
#userPanel label{ display:block; font-size:12px; color:#9fb0c6; margin:10px 0 6px }
#userPanel input,#userPanel select{
  width:100%; padding:10px 12px; border-radius:10px; border:1px solid #243046; background:#0b101a; color:#e6eef7
}
/* Bot√≥n/ojito: SVG sencillo (sin emoticonos) */
.eyeBtn{
  position:absolute; right:12px; top:36px; width:24px; height:24px; border:0; background:transparent; cursor:pointer; padding:0;
}
.eyeBtn svg{ width:22px; height:22px; display:block; fill:none; stroke:#cbd5e1; stroke-width:2 }

/* Botones */
.btn{border:0; border-radius:999px; padding:10px 14px; font-weight:700; cursor:pointer}
.btn--primary{background:var(--brand2); color:#fff}
.btn--ghost{background:#0b101a; color:#e6eef7; border:1px solid #243046}

/* ============ Layout / Tarjetas / Utilidades ============ */
.main{padding:16px; max-width:1100px; margin:0 auto}
.grid{display:grid; gap:16px}
.card{ background:#fff; color:#0f172a; border:1px solid #e5e7eb; border-radius:18px; padding:14px; box-shadow:0 4px 12px rgba(0,0,0,.06) }

/* P√≠ldoras estado */
.pill{display:inline-block; padding:4px 10px; border-radius:999px; font-weight:800; font-size:12px}
.pill--ok{background:#dcfce7;color:#065f46;border:1px solid #bbf7d0}
.pill--warn{background:#fef9c3;color:#854d0e;border:1px solid #fde68a}
.pill--stop{background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca}
.pill--info{background:#dbeafe;color:#1e3a8a;border:1px solid #bfdbfe}

/* Listas 1 l√≠nea */
.line-1{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; border-bottom:1px dashed #e5e7eb; padding:10px 6px; cursor:pointer}
.line-1:hover{background:#f8fafc}
.details{display:none; padding:8px 6px; color:#475569}
.open + .details{display:block}

/* Tarjeta equipo */
.item{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px; border-radius:12px; border:1px solid #e5e7eb; background:#fff}
.item__title{font-weight:800}
.item__meta{color:#64748b; font-size:12px}
.actions{display:flex; gap:8px; flex-wrap:wrap}

/* Inventario */
.catgrid{display:grid; gap:12px; grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}
.cat{padding:16px; border-radius:12px; border:1px solid #e5e7eb; background:#f8fafc; font-weight:800}
.searchbar{display:flex; gap:8px; margin:10px 0}
.searchbar input{flex:1}

/* Dashboard integrado en fondo (sin borde/sombra) + contadores */
.card--dash{ background:transparent; border:0; box-shadow:none; padding:8px 0 6px }
.card--dash .card__title{ font-weight:800 }
.red{ color:var(--brand2)!important } .black{ color:var(--ink)!important }
.badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-weight:800; font-size:12px;
        background:#eef2f7; color:#334155; border:1px solid #e2e8f0; margin-left:8px }
.cards-grid{ display:grid; gap:18px }
@media(min-width:1100px){ .cards-grid{ grid-template-columns:repeat(2,1fr) } }

/* Angular corporativo en H1/H2/H3, alineado 2/3 y sin cortar */
h1,h2,h3{
  position:relative; margin:22px 0 10px; padding-left:42px; line-height:1.15;
  white-space:nowrap; overflow:visible; text-overflow:ellipsis;
}
h1::before,h2::before,h3::before{
  content:""; position:absolute; left:0; bottom:.36em;
  width:30px; height:30px; background:url("angular.png") left bottom/contain no-repeat;
}

/* T√≠tulo gr√°fico L√≠nea KALTENBACH */
.kalt-title{display:flex; align-items:center; margin:6px 0 10px}
.kalt-title img{max-width:100%; opacity:.85}
</style>
</head>
<body>

<header class="header" id="hdr">
  <span id="roleChip">Invitado</span>
  <div class="h__in">
    <button id="hamb" aria-label="Abrir men√∫"><span class="i"><span></span></span></button>
    <div class="brand" aria-label="Inicio">
      <img src="logo-cdl.png" alt="CDL">
      <span class="brand__title">PANEL DE CONTROL</span>
    </div>
    <div style="flex:1"></div>
    <button id="moreBtn" aria-haspopup="true" aria-expanded="false" aria-controls="userPanel"><span class="i"></span></button>
  </div>
</header>

<!-- ========== Men√∫ lateral (izquierda) ========== -->
<aside id="sidenav" aria-hidden="true">
  <div class="sidenav__head">
    <img src="logo_mantenimiento.png" alt="CDL Mantenimiento">
    <button id="btnCloseNav" aria-label="Cerrar">‚úï</button>
  </div>
  <div class="sidenav__search">
    <input id="globalSearch" placeholder="Buscar en la app‚Ä¶">
  </div>
  <div class="sep"></div>
  <nav class="navlist" id="navList"></nav>
</aside>

<!-- ========== Panel usuario (debajo de cabecera) ========== -->
<section id="userPanel" role="dialog" aria-modal="true" aria-labelledby="upTitle">
  <h3 id="upTitle">Acceso de usuario</h3>

  <label>Rol</label>
  <select id="roleSelect">
    <option value="invitado">Invitado</option>
    <option value="administrador">Administrador</option>
    <option value="gerente">Gerente</option>
    <option value="encargado">Encargado</option>
    <option value="resp_produccion">Responsable de producci√≥n</option>
    <option value="resp_turno">Responsable de turno</option>
    <option value="externa">Empresa externa</option>
  </select>

  <label>Usuario</label>
  <input id="userName" placeholder="usuario (opcional)" autocomplete="username">

  <label>Contrase√±a</label>
  <div style="position:relative">
    <input id="userPass" type="password" placeholder="contrase√±a (opcional)" autocomplete="current-password">
    <button class="eyeBtn" id="toggleEye" aria-label="Mostrar/Ocultar contrase√±a">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
        <circle cx="12" cy="12" r="3.5"/>
      </svg>
    </button>
  </div>

  <div style="display:flex; gap:8px; margin-top:12px">
    <button class="btn btn--primary" id="loginBtn">Acceder</button>
    <button class="btn btn--ghost" id="logoutBtn">Salir</button>
  </div>

  <h3 style="margin-top:14px">Cambiar contrase√±a</h3>
  <label>Actual</label>
  <input id="chgOld" type="password" autocomplete="current-password">
  <label>Nueva</label>
  <input id="chgNew" type="password" autocomplete="new-password">
  <button class="btn btn--ghost" id="chgBtn" style="margin-top:8px">Guardar nueva</button>
</section>

<main class="main" id="appRoot">
  <!-- ========== DASHBOARD TV (HOME) ========== -->
  <section id="dashboard" class="page active">
    <div class="cards-grid">

      <!-- 1 -->
      <article class="card card--dash" onclick="navTo('equipos')">
        <h2 class="card__title"><span class="black">EQUIPOS EN</span> <span class="red">PARADA</span>
          <span class="badge" id="countParadas">0</span></h2>
      </article>

      <!-- 2 -->
      <article class="card card--dash" onclick="navTo('equipos')">
        <h2 class="card__title"><span class="black">EQUIPOS CON</span> <span class="red">RESTRICCIONES</span>
          <span class="badge" id="countRestr">0</span></h2>
      </article>

      <!-- 3 -->
      <article class="card card--dash" onclick="navTo('inventario')">
        <h2 class="card__title"><span class="black">ALERTAS</span> <span class="red">STOCK</span> <span class="black">M√çNIMO</span>
          <span class="badge" id="countStock">0</span></h2>
      </article>

      <!-- 4 -->
      <article class="card card--dash" onclick="navTo('ot')">
        <h2 class="card__title"><span class="black">AVISOS</span> <span class="red">SUBCONTRATAS</span>
          <span class="badge" id="countExt">0</span></h2>
      </article>

      <!-- 5 -->
      <article class="card card--dash" onclick="navTo('repuestos')">
        <h2 class="card__title"><span class="black">SOLICITUDES</span> <span class="red">PRIORITARIAS</span>
          <span class="badge" id="countReq">0</span></h2>
      </article>

    </div>
  </section>

  <hr class="sep">

  <!-- ========== EQUIPOS ========== -->
  <section id="equipos" hidden>
    <div class="kalt-title">
      <img src="linea-kaltenbach.png" alt="L√çNEA KALTENBACH">
    </div>
    <h1><span class="black">EQUIPOS</span> <span class="red">EN L√çNEA</span></h1>
    <div id="equiposList" class="grid cols-2"></div>
  </section>

  <hr class="sep">

  <!-- ========== GR√öAS ========== -->
  <section id="gruas" hidden>
    <h1><span class="black">PUENTES</span> <span class="red">GR√öA</span></h1>
    <div id="gruasList" class="grid cols-2"></div>
  </section>

  <hr class="sep">

  <!-- ========== AUXILIARES ========== -->
  <section id="auxiliares" hidden>
    <h1><span class="black">AUXILIARES</span> <span class="red">(OTROS)</span></h1>
    <div id="auxList" class="grid cols-2"></div>
  </section>

  <hr class="sep">

  <!-- ========== INCIDENCIAS ========== -->
  <section id="incidencias" hidden>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
      <h1 class="card__title"><span class="black">INCIDENCIAS</span></h1>
      <button class="btn btn--primary" id="btnNewInc">Crear nueva incidencia</button>
    </div>

    <div class="card" id="incFormWrap" hidden>
      <div class="grid cols-2">
        <div>
          <label>Equipo</label>
          <div class="searchbar">
            <input id="incEquipo" list="equiposDatalist" placeholder="Escribe o selecciona equipo‚Ä¶">
          </div>
          <datalist id="equiposDatalist"></datalist>

          <label>Tipo de fallo</label>
          <select id="incTipo">
            <option value="mecanico">Fallo mec√°nico</option>
            <option value="electrico">Fallo el√©ctrico</option>
            <option value="hidraulico">Fallo hidr√°ulico</option>
            <option value="neumatico">Fallo neum√°tico</option>
            <option value="proceso">Fallo de proceso productivo</option>
            <option value="desconocido">Origen desconocido</option>
          </select>

          <label>Descripci√≥n breve</label>
          <input id="incDesc" placeholder="Describe el problema‚Ä¶">
        </div>

        <div>
          <label>Solucionado</label>
          <select id="incSol">
            <option value="no">No</option>
            <option value="si">S√≠</option>
            <option value="restricciones">Con restricciones</option>
          </select>

          <div id="incSiWrap" hidden>
            <label>Descripci√≥n de la soluci√≥n</label>
            <input id="incSolDesc" placeholder="¬øC√≥mo se solucion√≥?">
            <label>Repuestos empleados</label>
            <input id="incSolRep" placeholder="Escribe para buscar‚Ä¶">
          </div>

          <div id="incNoWrap">
            <label>Descripci√≥n de la intervenci√≥n</label>
            <input id="incNoDesc" placeholder="¬øQu√© se ha hecho hasta ahora?">
            <label>Repuestos empleados</label>
            <input id="incNoRep" placeholder="Opcional">
          </div>

          <label>Reportado por</label>
          <select id="incReportadoPor">
            <option>administrador</option><option>gerente</option><option>encargado</option>
            <option>resp_produccion</option><option>resp_turno</option><option>externa</option>
          </select>

          <label>Intervenido por</label>
          <input id="incIntervenido" placeholder="Nombre del t√©cnico‚Ä¶">

          <div class="grid cols-2">
            <div>
              <label>Fecha de inicio</label>
              <input id="incIni" type="date">
            </div>
            <div>
              <label>Fecha de reparaci√≥n</label>
              <input id="incFin" type="date">
            </div>
          </div>
        </div>
      </div>
      <div style="display:flex; gap:8px; margin-top:10px">
        <button class="btn btn--primary" id="incGuardar">Guardar incidencia</button>
        <button class="btn btn--ghost" id="incCancelar">Cancelar</button>
      </div>
    </div>

    <div class="card">
      <div class="card__hdr">
        <h2 class="card__title">√öltimas incidencias</h2>
        <div style="display:flex; gap:8px">
          <input id="incFilter" placeholder="Filtrar‚Ä¶">
          <button class="btn btn--ghost" id="incRecargar">Recargar</button>
        </div>
      </div>
      <div id="incList"></div>
    </div>
  </section>

  <hr class="sep">

  <!-- ========== INVENTARIO ========== -->
  <section id="inventario" hidden>
    <h1><span class="black">INVENTARIO DE</span> <span class="red">REPUESTOS</span></h1>
    <div class="card">
      <div class="card__hdr">
        <h2 class="card__title">Alertas</h2>
      </div>
      <div id="invAlerts"></div>
    </div>

    <div class="card">
      <div class="card__hdr"><h2 class="card__title">Buscar</h2></div>
      <div class="searchbar">
        <input type="text" id="invSearch" placeholder="C√≥digo, referencia, nombre‚Ä¶">
        <button class="btn btn--ghost" id="invClear">Limpiar</button>
      </div>
      <div id="invCats" class="catgrid"></div>
    </div>
  </section>

  <hr class="sep">

  <!-- ========== REPUESTOS (SOLICITUDES) ========== -->
  <section id="repuestos" hidden>
    <h1><span class="black">SOLICITUDES</span> <span class="red">PRIORITARIAS</span></h1>
    <div class="card">
      <div class="card__hdr"><h2 class="card__title">Solicitar repuesto</h2></div>
      <div class="grid cols-2">
        <div>
          <label>Repuesto</label>
          <input id="reqRef" placeholder="Ref o nombre‚Ä¶">
          <label>Cantidad</label>
          <input id="reqQty" type="number" min="1" value="1">
        </div>
        <div>
          <label>Observaciones</label>
          <input id="reqObs" placeholder="Urgente, alternativa, etc.">
          <button class="btn btn--primary" id="reqEnviar" style="margin-top:12px">Enviar solicitud</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card__hdr">
        <h2 class="card__title">Solicitudes</h2>
        <div class="badge" id="reqCountBadge">0</div>
      </div>
      <div id="reqList"></div>
    </div>
  </section>

  <hr class="sep">

  <!-- ========== INDICADORES ========== -->
  <section id="indicadores" hidden>
    <h1><span class="black">INDICADORES</span></h1>
    <div class="grid cols-3">
      <div class="card"><h3 class="card__title">MTBF</h3><div class="kpi" id="kpiMtbf">‚Äî</div></div>
      <div class="card"><h3 class="card__title">Disponibilidad</h3><div class="kpi" id="kpiDisp">‚Äî</div></div>
      <div class="card"><h3 class="card__title">OEE</h3><div class="kpi" id="kpiOee">‚Äî</div></div>
    </div>
    <div style="margin-top:10px">
      <button class="btn btn--ghost" id="btnExpCSV">Exportar CSV</button>
    </div>
  </section>

  <hr class="sep">

  <!-- ========== √ìRDENES DE TRABAJO (OT) ========== -->
  <section id="ot" hidden>
    <h1><span class="black">√ìRDENES</span> <span class="red">DE TRABAJO</span></h1>
    <div class="card">
      <div class="card__hdr"><h2 class="card__title">Crear OT</h2></div>
      <div class="grid cols-3">
        <div>
          <label>Equipo</label>
          <input id="otEquipo" list="equiposDatalist" placeholder="Escribe o selecciona‚Ä¶">
        </div>
        <div>
          <label>Tipo</label>
          <select id="otTipo">
            <option>Engrase</option><option>Lubricaci√≥n</option>
            <option>Ajuste mec√°nico</option><option>Ajuste el√©ctrico</option>
          </select>
        </div>
        <div>
          <label>Fecha</label>
          <input id="otFecha" type="date">
        </div>
      </div>
      <label>Tarea</label>
      <input id="otTarea" placeholder="Describe la OT‚Ä¶">
      <div style="margin-top:10px">
        <button class="btn btn--primary" id="otCrear">Crear OT</button>
      </div>
    </div>

    <div class="card">
      <div class="card__hdr">
        <h2 class="card__title">Listado de OT</h2>
        <div class="searchbar">
          <input id="otFilter" placeholder="Filtrar‚Ä¶">
          <button class="btn btn--ghost" id="otBorrarMode">Modo borrar</button>
        </div>
      </div>
      <div id="otList"></div>
    </div>
  </section>
</main>

<!-- ========== SCRIPT ========== -->
<script>
/* =========================
   CONFIG + API (Apps Script)
========================= */
/* ‚ö†Ô∏è Ajusta si cambias el despliegue */
const API_BASE = "https://script.google.com/macros/s/AKfycbz9kkvafoc65UBOqZQq8mKA0eeYsreOuHE3W4HDjZ3GK-Ihr8Uoq574a1_LQyl3ANTG/exec";
const API_KEY  = ""; // opcional (puedes dejarlo vac√≠o)

const STORE_KEY = "cdl_cache_v1";
const store = {
  state:{
    user:{rol:'invitado', nombre:'Invitado', token:''},
    equipos:[], gruas:[], auxiliares:[],
    incidencias:[], inventario:[], solicitudes:[],
    ots:[], externas:[]
  },
  save(){ localStorage.setItem(STORE_KEY, JSON.stringify(this.state)); },
  load(){ try{ Object.assign(this.state, JSON.parse(localStorage.getItem(STORE_KEY)||"{}")); }catch{} }
};

// Helpers HTTP contra router ?res=..&fn=..
async function apiGet(res, params={}){
  try{
    const url = new URL(API_BASE);
    url.searchParams.set("res", res);
    if(params.fn) url.searchParams.set("fn", params.fn);
    if(API_KEY)   url.searchParams.set("key", API_KEY);
    for(const k in params) if(k!=="fn") url.searchParams.set(k, params[k]);
    const tok = store?.state?.user?.token; if(tok) url.searchParams.set("token", tok);
    const r = await fetch(url.toString(), {method:"GET"}); return await r.json();
  }catch(e){ console.warn("GET error/offline", e); return {ok:false,error:String(e)}; }
}
async function apiPost(res, body={}){
  try{
    const url = new URL(API_BASE);
    url.searchParams.set("res", res);
    if(body.fn) url.searchParams.set("fn", body.fn);
    const payload = {...body}; if(API_KEY) payload.key = API_KEY;
    const tok2 = store?.state?.user?.token; if(tok2) payload.token = tok2;
    const r = await fetch(url.toString(), {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    return await r.json();
  }catch(e){ console.warn("POST error/offline", e); return {ok:false,error:String(e)}; }
}
const apiList  = (res, extra={})      => apiGet(res, Object.assign({fn:"list"}, extra));
const apiAdd   = (res, item)          => apiPost(res, {fn:"add",  item});
const apiSet   = (res, obj)           => apiPost(res, Object.assign({fn:"set"}, obj));
const apiDelta = (res, ref, delta)    => apiPost(res, {fn:"delta", ref, delta});

/* =========================
   ROLES Y PERMISOS (front)
========================= */
const PERMS = {
  administrador:["*"],
  gerente:["view:*","write:*"],
  encargado:["view:*","write:incidencias","write:ot","write:inv","write:req"],
  resp_produccion:["view:*","write:req:gestionar","write:inv"],
  resp_turno:["view:*","write:incidencias"],
  externa:["view:equipos","view:gruas","view:auxiliares","view:incidencias"],
  invitado:["view:dashboard","view:equipos","view:gruas","view:auxiliares"]
};
function can(perm){
  const rol = store.state.user.rol||"invitado";
  const list = PERMS[rol]||[];
  return list.includes("*") || list.includes(perm) || (list.includes("view:*") && perm.startsWith("view:"));
}

/* =========================
   ROUTER + NAV
========================= */
const PAGES = ["dashboard","equipos","gruas","auxiliares","incidencias","inventario","repuestos","ot","indicadores"];
const TITLES = {
  dashboard:"Dashboard TV", equipos:"Equipos", gruas:"Puentes gr√∫a", auxiliares:"Auxiliares (otros)",
  incidencias:"Incidencias", inventario:"Inventario", repuestos:"Repuestos", ot:"√ìrdenes de trabajo", indicadores:"Indicadores"
};
function buildNav(){
  const nav = document.getElementById("navList");
  nav.innerHTML = PAGES.map(id=>`<a href="#${id}" data-id="${id}">${TITLES[id]}</a>`).join("");
}
function navTo(id){
  PAGES.forEach(p=>document.getElementById(p).hidden = (p!==id));
  location.hash = "#"+id;
}
function onHash(){
  const id = (location.hash||"#dashboard").replace("#","");
  if(!PAGES.includes(id)) return navTo("dashboard");
  navTo(id);
  render();
}

/* =========================
   HELPERS DE UI
========================= */
function pill(estado){
  const s = (estado||"").toLowerCase();
  if(s.includes("parada")) return `<span class="pill pill--stop">Parada</span>`;
  if(s.includes("restr")) return `<span class="pill pill--warn">Restricciones</span>`;
  if(s.includes("marcha")) return `<span class="pill pill--ok">En marcha</span>`;
  return `<span class="pill pill--info">${estado||"‚Äî"}</span>`;
}
function cardEquipo(e){
  return `<div class="item">
    <div>
      <div>${pill(e.estado)}</div>
      <div class="item__title">${e.nombre}</div>
      <div class="item__meta">${e.linea||e.grupo||e.nave||e.tipo||""}</div>
    </div>
    <div class="actions">
      <button class="btn btn--ghost" data-act="ficha" data-id="${e.id}">Ficha</button>
      <button class="btn btn--ghost" data-act="prog" data-id="${e.id}">Parada prog.</button>
      <button class="btn btn--primary" data-act="prolong" data-id="${e.id}">Parada prolongada</button>
      <button class="btn btn--ghost" data-act="incid" data-id="${e.id}">Nueva incidencia</button>
    </div>
  </div>`;
}

/* =========================
   RENDER P√ÅGINAS
========================= */
function renderEquipos(){
  const cont = document.getElementById("equiposList"); if(!cont) return;
  const grupos = ["L√çNEA KALTENBACH","L√ÅSER TRUMP","M√ÅQUINAS INDEPENDIENTES"];
  const out = [];
  grupos.forEach(g=>{
    const list = store.state.equipos.filter(x=>x.grupo?.toUpperCase()===g);
    if(!list.length) return;
    out.push(`<div class="card"><h2 class="card__title">${g}</h2>${list.map(cardEquipo).join("")}</div>`);
  });
  cont.innerHTML = out.join("");
}
function renderGruas(){
  const cont = document.getElementById("gruasList"); if(!cont) return;
  const naves = ["NAVE 1","NAVE 2","NAVE 3","NAVE 4"];
  cont.innerHTML = naves.map(n=>{
    const list = store.state.gruas.filter(x=>x.nave?.toUpperCase()===n);
    if(!list.length) return "";
    return `<div class="card"><h2 class="card__title">${n}</h2>${list.map(cardEquipo).join("")}</div>`;
  }).join("");
}
function renderAux(){
  const cont = document.getElementById("auxList"); if(!cont) return;
  const list = store.state.auxiliares||[];
  cont.innerHTML = `<div class="card"><h2 class="card__title">Auxiliares</h2>${list.map(cardEquipo).join("")}</div>`;
}
function renderIncidencias(){
  const wrap = document.getElementById("incList"); if(!wrap) return;
  const filtro = (document.getElementById("incFilter")?.value||"").toLowerCase();
  const arr = (store.state.incidencias||[])
    .filter(i=>!filtro || (i.equipo+i.tipo+i.desc).toLowerCase().includes(filtro))
    .sort((a,b)=>String(b.fecha).localeCompare(String(a.fecha)));
  wrap.innerHTML = arr.map(i=>`<div class="line-1">${i.fecha} ¬∑ ${i.equipo} ¬∑ ${i.tipo} ¬∑ ${i.desc}</div>`).join("");
}
function renderInventario(){
  const alertBox = document.getElementById("invAlerts");
  const search = document.getElementById("invSearch");
  const catsBox = document.getElementById("invCats");
  if(!alertBox||!catsBox) return;

  const low = (store.state.inventario||[]).filter(i=>Number(i.stock)<Number(i.stock_min));
  alertBox.innerHTML = low.length
    ? `<span class="pill pill--stop">‚ö† ${low.length} referencias por debajo del m√≠nimo</span>`
    : `<span class="pill pill--ok">Stock correcto</span>`;

  const q = (search?.value||"").toLowerCase();
  const items = (store.state.inventario||[]).filter(i=>{
    const text = (i.ref+" "+i.nombre).toLowerCase();
    return !q || text.includes(q);
  });

  const cats = {};
  items.forEach(i=>{
    const c = i.categoria || "Otros";
    (cats[c] ||= []).push(i);
  });

  const html = Object.keys(cats).sort().map(c=>{
    const n = cats[c].length;
    return `<div class="cat"><b>${c}</b><br>${n} items</div>`;
  }).join("");
  catsBox.innerHTML = html;
}
function renderRepuestos(){
  const list = store.state.solicitudes||[];
  const body = list.map(r=>{
    const v = (r.estado||"pendiente").toLowerCase();
    return `<div class="line-1">
      ${r.id} ¬∑ ${r.nombre} (${r.qty||1})
      ¬∑ <select class="reqState" data-req="${r.id}">
          <option ${v==="pendiente"?"selected":""} value="Pendiente">Pendiente</option>
          <option ${v==="aceptado"?"selected":""} value="Aceptado">Aceptado</option>
          <option ${v==="denegado"?"selected":""} value="Denegado">Denegado</option>
          <option ${v==="en camino"?"selected":""} value="En camino">En camino</option>
          <option ${v==="pendiente de entrega"?"selected":""} value="Pendiente de entrega">Pendiente de entrega</option>
          <option ${v==="recibido"?"selected":""} value="Recibido">Recibido</option>
        </select>
    </div>`;
  }).join("");
  const box = document.getElementById("reqList");
  const badge = document.getElementById("reqCountBadge");
  if(box) box.innerHTML = body;
  if(badge) badge.textContent = list.length;

  document.querySelectorAll(".reqState").forEach(sel=>{
    sel.onchange = async ()=>{
      const id = sel.getAttribute("data-req");
      const rr = await apiSet("rep", {id, estado: sel.value, comentario: ""});
      if(!rr?.ok) alert("Error actualizando solicitud");
      await refresh();
    };
  });
}
function renderOT(){
  const q = (document.getElementById("otFilter")?.value||"").toLowerCase();
  const list = (store.state.ots||[])
    .filter(o=>!q || (o.id+o.equipo+o.tipo+o.tarea).toLowerCase().includes(q));
  const box = document.getElementById("otList");
  if(box) box.innerHTML = list.map(o=>
    `<div class="line-1">${o.id} ¬∑ ${o.equipo} ¬∑ ${o.tipo} ¬∑ ${o.fecha} ¬∑ ${o.tarea}</div>`
  ).join("");
}
function renderIndicadores(){
  const incs = store.state.incidencias||[];
  const mtbf = document.getElementById("kpiMtbf");
  const disp = document.getElementById("kpiDisp");
  const oee  = document.getElementById("kpiOee");
  if(mtbf) mtbf.textContent = (incs.length ? (200/incs.length).toFixed(1)+' h' : '‚Äî');
  if(disp) disp.textContent = "98.6%";
  if(oee)  oee.textContent  = "91.2%";
}
function renderDashboard(){
  const eqStop  = store.state.equipos.filter(x=>(x.estado||"").toLowerCase().includes("parada"));
  const eqRestr = store.state.equipos.filter(x=>(x.estado||"").toLowerCase().includes("restr"));
  const grStop  = store.state.gruas.filter(x=>(x.estado||"").toLowerCase().includes("parada"));
  const auxRestr= store.state.auxiliares.filter(x=>(x.estado||"").toLowerCase().includes("restr"));
  const low     = store.state.inventario.filter(i=>i.stock<i.stock_min);
  const reqPend = store.state.solicitudes.filter(r=>(r.estado||"").toLowerCase()==="pendiente");

  const set = (id,val)=>{ const el=document.getElementById(id); if(el) el.textContent = val; };
  set("countParadas", eqStop.length + grStop.length);
  set("countRestr",  eqRestr.length + auxRestr.length);
  set("countStock",  low.length);
  set("countReq",    reqPend.length);
  set("countExt",    store.state.externas.length);
}
function render(){
  const dl = document.getElementById("equiposDatalist");
  if(dl){ dl.innerHTML = (store.state.equipos||[]).map(e=>`<option value="${e.nombre}">`).join(""); }
  renderEquipos(); renderGruas(); renderAux();
  renderIncidencias(); renderInventario(); renderRepuestos();
  renderOT(); renderIndicadores(); renderDashboard();
}

/* =========================
   CARGA DESDE API
========================= */
function splitByGrupo(items){
  const equipos=[], gruas=[], auxiliares=[];
  for(const it of (items||[])){
    const g = (it.grupo||"").toUpperCase();
    const row = { id: it.nombre, nombre: it.nombre, grupo: it.grupo, estado: it.estado };
    if(g.startsWith("NAVE ")) gruas.push(Object.assign({nave: it.grupo}, row));
    else if(g.includes("KALTENBACH") || g.includes("L√ÅSER") || g.includes("LASER") || g.includes("M√ÅQUINAS"))
      equipos.push(row);
    else auxiliares.push(Object.assign({tipo: it.grupo}, row));
  }
  return {equipos, gruas, auxiliares};
}
async function loadAllFromAPI(){
  const [st, incid, inv, rep, cons, ot] = await Promise.all([
    apiList("state"),
    apiList("incid"),
    apiList("inv"),
    apiList("rep"),
    apiList("cons"),
    apiList("ot")
  ]);

  if(st?.ok){
    const {equipos, gruas, auxiliares} = splitByGrupo(st.items||[]);
    store.state.equipos = equipos;
    store.state.gruas = gruas;
    store.state.auxiliares = auxiliares;
  }
  if(incid?.ok) store.state.incidencias = (incid.items||[]).map(x=>({
    id:x.id, fecha:(x.created||"").slice(0,10), equipo:x.equipo, tipo:x.tipo, desc:x.desc||x.repTxt||"",
    solucionado: (x.res||"").toLowerCase().includes("solucionado") ? "si" :
                 (x.res||"").toLowerCase().includes("restr") ? "restricciones" :
                 (x.res||"").toLowerCase().includes("parada") ? "no" : "no"
  }));

  const invItems = inv?.ok ? (inv.items||[]).map(i=>({
    id:i.ref, ref:i.ref, nombre:i.nombre, stock:i.stock, stock_min:i.minimo,
    categoria: (i.ref||"").includes("GRASA") ? "Lubricantes" :
               (i.ref||"").includes("TORX")  ? "Torniller√≠a" : "Otros"
  })) : [];
  store.state.inventario = invItems;

  if(rep?.ok) store.state.solicitudes = (rep.items||[]).map(r=>({
    id:r.id, ref:r.ref, nombre:r.nombre, qty:1, estado:(r.estado||"Pendiente").toLowerCase(), fecha_entrega:""
  }));

  if(ot?.ok) store.state.ots = (ot.items||[]).map(o=>({
    id:o.id, equipo:o.equipo, tipo:o.titulo||"OT", fecha:(o.vencimiento||"").slice(0,10), tarea:o.desc||o.titulo||""
  }));

  store.save();
}

/* =========================
   ACCIONES
========================= */
// Dashboard colapsables (si los activas en el futuro)
document.querySelectorAll(".collapse-head")?.forEach(el=>{
  el.onclick = ()=>{ const id = el.dataset.coll; const box = document.getElementById(id); if(box) box.hidden = !box.hidden; };
});

// Incidencias
document.getElementById("btnNewInc").onclick = ()=>{ document.getElementById("incFormWrap").hidden = false; };
document.getElementById("incCancelar").onclick = ()=>{ document.getElementById("incFormWrap").hidden = true; };
document.getElementById("incGuardar").onclick = async ()=>{
  const sol = document.getElementById("incSol").value;
  const mapRes = sol==="si" ? "Solucionado" : (sol==="restricciones" ? "Restricciones" : "Parada");
  const inc = {
    equipo: document.getElementById("incEquipo").value,
    tipo:   document.getElementById("incTipo").value,
    res:    mapRes,
    rep:    (sol==="si" ? (document.getElementById("incSolRep").value ? "S√≠" : "No")
                        : (document.getElementById("incNoRep").value ? "S√≠" : "No")),
    repTxt: document.getElementById("incSolRep").value || document.getElementById("incNoRep").value || "",
    inicio: document.getElementById("incIni").value || "",
    fin:    document.getElementById("incFin").value || "",
    reportante: store.state.user?.nombre || "web",
    asignado:   document.getElementById("incIntervenido").value || "",
    desc:       document.getElementById("incDesc").value
  };
  const r = await apiAdd("incid", inc);
  if(!r?.ok) return alert("Error guardando incidencia (¬øsesi√≥n?)");
  await refresh();
  document.getElementById("incFormWrap").hidden = true;
};

// Repuestos (solicitudes)
document.getElementById("reqEnviar").onclick = async ()=>{
  if(!can("write:req")) return alert("Sin permiso para solicitar.");
  const item = { ref: (reqRef.value||"").toUpperCase(), nombre: reqRef.value };
  const r = await apiAdd("rep", item);
  if(!r?.ok) return alert("Error solicitando repuesto (¬øsesi√≥n?)");
  reqRef.value=""; reqQty.value=1; reqObs.value="";
  await refresh();
};

// OT
document.getElementById("otCrear").onclick = async ()=>{
  if(!can("write:ot")) return alert("Sin permiso para crear OT.");
  const item = {
    equipo: otEquipo.value, prioridad:"A",
    titulo: `${otTipo.value} ¬∑ ${otTarea.value}`.trim(),
    vencimiento: otFecha.value,
    desc: otTarea.value
  };
  const r = await apiAdd("ot", item);
  if(!r?.ok) return alert("Error creando OT (¬øsesi√≥n?)");
  otTarea.value="";
  await refresh();
};

// Acciones r√°pidas en tarjetas de equipo
document.addEventListener("click", async (ev)=>{
  const btn = ev.target.closest("[data-act]");
  if(!btn) return;
  const act = btn.getAttribute("data-act");
  const id  = btn.getAttribute("data-id");
  if(act==="prolong"){
    const rr = await apiPost("alert", {fn:"parada", equipo:id});
    if(!rr?.ok) return alert("Error registrando parada (¬øsesi√≥n?)");
    await refresh();
  }
  if(act==="incid"){
    document.getElementById("incEquipo").value = id;
    document.getElementById("incFormWrap").hidden = false;
    location.hash = "#incidencias";
  }
});

/* =========================
   INIT (√∫nico y limpio)
========================= */
async function refresh(){ await loadAllFromAPI(); render(); }

document.addEventListener("DOMContentLoaded", ()=>{
  // 1) Estado + navegaci√≥n
  store.load(); buildNav();

  // 2) Cabecera / men√∫s
  document.body.style.overflowX = "hidden";
  const sidenav   = document.getElementById("sidenav");
  const hamb      = document.getElementById("hamb");
  const btnClose  = document.getElementById("btnCloseNav");
  const moreBtn   = document.getElementById("moreBtn");
  const userPanel = document.getElementById("userPanel");

  if (sidenav) sidenav.classList.remove("open");

  // üçî Hamburguesa
  if (hamb && sidenav){
    hamb.onclick = ()=> sidenav.classList.toggle("open");
  }
  // ‚úï cerrar
  if(btnClose && sidenav){ btnClose.onclick = ()=> sidenav.classList.remove("open"); }
  // cerrar tocando backdrop del aside (si lo ampl√≠as a overlay)
  // document.addEventListener("click",(e)=>{ if(e.target.id==="sidenav") sidenav.classList.remove("open"); });

  // ‚ãØ Men√∫ usuario
  if (moreBtn && userPanel){
    moreBtn.onclick = ()=>{
      userPanel.classList.toggle("show");
      moreBtn.setAttribute("aria-expanded", userPanel.classList.contains("show"));
    };
  }
  // Ojo password
  const toggleEye = document.getElementById("toggleEye");
  const userPass  = document.getElementById("userPass");
  if (toggleEye && userPass){
    toggleEye.onclick = ()=>{ userPass.type = (userPass.type === "password") ? "text" : "password"; };
  }

  // 3) Navegaci√≥n por hash + primer render
  window.addEventListener("hashchange", onHash);
  onHash();
  (async ()=>{ await refresh(); setInterval(refresh, 60000); })();

  // 4) Service Worker (ruta relativa para GitHub Pages / static)
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }
});
</script>
</body>
</html>