<!-- ===================== BLOQUE 0: HEAD + TEMA BASE ===================== -->
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="format-detection" content="telephone=no">
<title>CDL · CMMS</title>

<!-- =========================================================
BLOQUE 20 — PWA (HEAD): Manifest, theme-color e iconos
========================================================= -->
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#E43B3B">
<link rel="apple-touch-icon" href="./icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="./icon-512.png">
<link rel="icon" href="./icon-192.png">

<!-- =========================================================
BLOQUE 01: TOKENS + TEMA BLANCO CDL
========================================================= -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap">
<style>
  :root{
    /* Marca CDL */
    --cdl-red:#E43B3B;       /* rojo corporativo */
    --cdl-black:#1F2937;     /* texto titulares */
    --cdl-ink:#111827;       /* texto intenso */
    --cdl-muted:#6B7280;     /* texto secundario */
    --cdl-line:#E5E7EB;      /* líneas suaves */
    --hdr-h: 76px;           /* alto cabecera móvil */
    --container: 1080px;     /* ancho máx. contenido */
  }
  html,body{
    background:#fff; color:#111;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    margin:0; padding:0;
  }
  /* Contenedor global tipo web corporativa */
  .cdl-container{ width:min(100%, var(--container)); margin-inline:auto; padding-inline:16px; }
  /* Botones rojos corporativos */
  .btn-cdl{
    border:0; border-radius:999px; font-weight:800; letter-spacing:.02em; cursor:pointer;
    padding:.7rem 1.2rem; background:var(--cdl-red); color:#fff; box-shadow:0 8px 18px rgba(228,59,59,.22);
  }
  .btn-cdl:active{ transform:translateY(1px); }
  /* Separadores suaves */
  .cdl-divider{ height:1px; background:var(--cdl-line); margin:16px 0; }
</style>

<!-- =========================================================
BLOQUE FIX — Global: forzar [hidden] a display:none
========================================================= -->
<style>[hidden]{ display:none !important; }</style>

<!-- =========================================================
BLOQUE 02 — CABECERA CDL CON WATERMARK MANTENIMIENTO (estilos)
========================================================= -->
<style>
  .cdl-header{ position:sticky; top:0; z-index:1000; height:var(--hdr-h); background:#fff; border-bottom:1px solid var(--cdl-line); }
  .cdl-header__inner{ height:var(--hdr-h); display:flex; align-items:center; justify-content:space-between; position:relative; }
  .cdl-hamb{ width:42px; height:42px; display:grid; place-items:center; border:1px solid #e5e7eb; border-radius:10px; background:#fff; }
  .cdl-hamb span{ width:18px; height:2px; background:#111; display:block; }
  .cdl-hamb span+span{ margin-top:4px; }
  .cdl-logo img{ display:block; }
  .cdl-user{ display:flex; align-items:center; gap:.5rem; }
  .cdl-user__role{ font-weight:800; color:#111; }
  .cdl-user__btn{ width:42px; height:42px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; color:#111; }

  /* Watermark superior con logo_mantenimiento + degradado rojo CDL */
  #cdlHeader::after{
    content:""; position:absolute; inset:-40% -10% 40% -10%;
    pointer-events:none; z-index:0;
    background:
      radial-gradient(60% 60% at 0% 0%, rgba(228,59,59,.08), transparent 70%) no-repeat,
      url('./logo_mantenimiento.png') left 24px top 8px / 260px auto no-repeat;
    opacity:.9;
  }
  .cdl-header__inner{ position:relative; z-index:1; } /* sobre el watermark */
</style>
</head>

<body>
<!-- =========================================================
BLOQUE 02 — CABECERA CDL CON WATERMARK MANTENIMIENTO (HTML)
========================================================= -->
<header id="cdlHeader" class="cdl-header" role="banner" aria-label="Cabecera CDL">
  <div class="cdl-container cdl-header__inner">
    <!-- Menú hamburguesa (izquierda) -->
    <button id="btnMenu" class="cdl-hamb" aria-label="Abrir menú" aria-controls="pagesPanel" aria-expanded="false">
      <span></span><span></span><span></span>
    </button>

    <!-- Logotipo CDL (centro-izq) -->
    <div class="cdl-logo">
      <img src="./logo-cdl.png" alt="CDL" height="28">
    </div>

    <!-- Área usuario (derecha) -->
    <div class="cdl-user">
      <div class="cdl-user__role" id="userRole">Mantenimiento</div>
      <button id="userBtn" class="cdl-user__btn" aria-label="Abrir panel de usuario">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="12" cy="8" r="4"></circle>
          <path d="M4 20c0-4 4-6 8-6s8 2 8 6"></path>
        </svg>
      </button>
    </div>
  </div>
</header>

<!-- =========================================================
BLOQUE 03 — TITULARES CON MARCO ROJO CDL
========================================================= -->
 <style> :where(h1,h2,h3){ position:relative; margin:1.1rem 0 .8rem; padding-left:.65rem; font-weight:900; letter-spacing:.02em; color:var(--cdl-black); line-height:1.15; } :where(h1)::before, :where(h2)::before, :where(h3)::before{ content:""; position:absolute; left:0; top:0.1rem; width:18px; height:18px; display:block; background: linear-gradient(90deg,var(--cdl-red) 0 100%) 0 0/100% 6px no-repeat, linear-gradient(180deg,var(--cdl-red) 0 100%) 0 0/6px 100% no-repeat; border-radius:1px; } h1{ font-size:clamp(1.6rem, 2.8vw, 2.25rem); } h2{ font-size:clamp(1.25rem, 2.2vw, 1.6rem); } h3{ font-size:clamp(1.05rem, 1.8vw, 1.25rem); color:#1b1f24; } /* Variante “subrayado CDL” (opcional) */ .cdl-underline{ box-shadow: inset 0 -10px rgba(228,59,59,.18); display:inline; } </style> <!-- ===================== BLOQUE 4: HELPERS + ESTADO DE USUARIO ===================== -->
<script>
/* =========================
   Helpers básicos y estado
   ========================= */
const byId = (id)=> document.getElementById(id);
const qs   = (sel)=> document.querySelector(sel);
const qsa  = (sel)=> [...document.querySelectorAll(sel)];
const esc = (str)=> String(str).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));

/* Estado de usuario persistido */
let USER = { user:"invitado", rol:"Invitado", group:"guest" };
function setUser(u){ USER=u; localStorage.setItem("CDL_USER",JSON.stringify(u)); applyRoleUI(); }
function getUser(){ try{return JSON.parse(localStorage.getItem("CDL_USER")||"{}");}catch(_){return USER;} }
USER = getUser() || USER;

function applyRoleUI(){
  qsa("[data-role]").forEach(el=>{
    const roles=(el.getAttribute("data-role")||"").split(",").map(s=>s.trim());
    if(roles.includes(USER.rol) || USER.rol==="Administrador"){ el.style.display=""; }
    else{ el.style.display="none"; }
  });
  const chip = byId("roleChip"); if (chip) chip.textContent = USER.rol || "Invitado";
}
</script>

<!-- =========================================================
BLOQUE 05 — SEMÁFORO DE ESTADO CDL
========================================================= -->
<style>
  .cdl-sem{ display:flex; align-items:center; gap:.65rem; }
  .cdl-sem .chip{
    display:inline-flex; align-items:center; gap:.45rem; padding:.28rem .6rem;
    border-radius:999px; border:1px solid #e5e7eb; background:#fff; color:#111; font-weight:900;
  }
  .cdl-sem .dot{ width:12px; height:12px; border-radius:50%; box-shadow:0 0 0 2px #fff inset, 0 0 0 1px rgba(0,0,0,.08); }
  .dot-ok{ background:#16a34a; } .dot-warn{ background:#f59e0b; } .dot-stop{ background:#dc2626; }

  .cdl-sem .btn{
    border:1px solid #e5e7eb; background:#fff; color:#111; border-radius:10px; height:36px; padding:0 .7rem; font-weight:800;
  }
  .cdl-sem .btn[data-state="En marcha"]{ border-color:#16a34a33; }
  .cdl-sem .btn[data-state="Restricciones"]{ border-color:#f59e0b33; }
  .cdl-sem .btn[data-state="Parada"]{ border-color:#dc262633; }

  /* versión compacta para tablas/listas */
  .cdl-sem.compact .btn{ height:30px; padding:0 .55rem; font-size:.85rem; }
</style>

<!-- Plantilla reutilizable -->
<template id="tplSemaforo">
  <div class="cdl-sem" role="group" aria-label="Estado del equipo">
    <span class="chip" id="chipState"><i class="dot"></i><b class="txt">—</b></span>
    <button class="btn" data-state="En marcha"       aria-pressed="false">Marcha</button>
    <button class="btn" data-state="Restricciones"   aria-pressed="false">Restr.</button>
    <button class="btn" data-state="Parada"          aria-pressed="false">Paro</button>
  </div>
</template>

<script>
(function(){
  if (window.__CDL_SEM__) return; 
  window.__CDL_SEM__ = true;

  const COLORS = { "En marcha":"ok", "Restricciones":"warn", "Parada":"stop" };

  function setChip(chip, estado){
    const dot = chip.querySelector('.dot'), txt = chip.querySelector('.txt');
    dot.className = 'dot dot-' + (COLORS[estado]||'warn');
    txt.textContent = estado || '—';
    chip.setAttribute('data-state', estado);
    chip.parentElement?.querySelectorAll('.btn').forEach(b=>{
      const on = b.dataset.state === estado;
      b.setAttribute('aria-pressed', on?'true':'false');
      b.style.outline = on ? '2px solid rgba(0,0,0,.12)' : 'none';
      b.style.background = on ? '#f9fafb' : '#fff';
    });
  }

  // Montaje de semáforo en un contenedor dado
  window.mountSemaforo = function(host, {equipo, estado}){
    const tpl = document.getElementById('tplSemaforo');
    if (!tpl || !host) return;
    const node = tpl.content.firstElementChild.cloneNode(true);
    const chip = node.querySelector('#chipState');
    setChip(chip, estado||'Restricciones');

    node.querySelectorAll('.btn').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const newState = btn.dataset.state;
        try{
          if (typeof window.setEquipoEstado === 'function'){
            await window.setEquipoEstado(equipo, newState);
          }
          setChip(chip, newState);
        }catch(e){
          console.error(e);
          alert('No se pudo actualizar el estado');
        }
      });
    });

    host.innerHTML = ''; 
    host.appendChild(node);
  };

  // Auto-montaje en elementos con [data-sem]
  document.querySelectorAll('[data-sem]').forEach(el=>{
    const equipo = el.getAttribute('data-equipo') || 'Equipo';
    const estado = el.getAttribute('data-state') || 'Restricciones';
    mountSemaforo(el, {equipo, estado});
  });
})();
</script>

<!-- =========================================================
BLOQUE 06 — MENÚ LATERAL OFF-CANVAS
========================================================= -->
<aside id="pagesPanel" class="cdl-panel" aria-hidden="true" aria-label="Menú principal">
  <div class="cdl-panel__head">
    <img src="./logo-cdl.png" alt="CDL" height="24">
    <button id="btnClosePanel" class="cdl-x" aria-label="Cerrar menú">✕</button>
  </div>
  <div class="cdl-panel__search">
    <input id="searchBox" type="search" placeholder="Buscar equipo…">
    <button id="searchBtn" class="btn-cdl" style="padding:.55rem .9rem;">Buscar</button>
  </div>
  <nav class="cdl-panel__nav">
    <a href="#/equipos">Equipos</a>
    <a href="#/incidencias">Incidencias</a>
    <a href="#/repuestos">Repuestos</a>
    <a href="#/kpi">KPIs</a>
    <a href="#/ajustes">Ajustes</a>
  </nav>
  <div class="cdl-panel__foot"><small>© CDL · Mantenimiento</small></div>
</aside>
<div id="panelBackdrop" class="cdl-panel__backdrop" hidden></div>
<!-- BLOQUE 06A — Backdrop sincronizado (reemplaza duplicados) -->
<style>
  /* Oculto por defecto; sólo se muestra cuando el panel está abierto */
  #panelBackdrop{
    display:none; position:fixed; inset:0;
    background:rgba(0,0,0,.28); z-index:1090;
  }
  .cdl-panel[aria-hidden="false"] + #panelBackdrop{
    display:block;
  }
</style>
<script>
(function(){
  const panel    = document.getElementById('pagesPanel');
  const openBtn  = document.getElementById('btnMenu');
  const closeBtn = document.getElementById('btnClosePanel');
  const backdrop = document.getElementById('panelBackdrop');

  function open(){ panel?.setAttribute('aria-hidden','false');  openBtn?.setAttribute('aria-expanded','true'); }
  function close(){ panel?.setAttribute('aria-hidden','true');   openBtn?.setAttribute('aria-expanded','false'); }

  openBtn?.addEventListener('click', open);
  closeBtn?.addEventListener('click', close);
  backdrop?.addEventListener('click', close);
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
})();
</script>
<!-- =========================================================
BLOQUE FIX — Backdrop del panel lateral (CSS + JS)
(colocar inmediatamente tras el HTML del panel)
========================================================= -->
<style>
  /* Backdrop base (oculto por defecto) */
  .cdl-panel__backdrop{
    position:fixed; inset:0;
    background:rgba(0,0,0,.28);
    z-index:1090;
    opacity:0;                 /* <-- aquí lo “apagamos” */
    pointer-events:none;       /* y que no capture clicks */
    transition:opacity .2s ease;
  }
  /* Si NO está hidden => visible y clicable */
  .cdl-panel__backdrop:not([hidden]){
    opacity:1;
    pointer-events:auto;
  }

  /* Alternativa adicional por si tu HTML tiene el backdrop justo después del panel: 
     cuando el panel esté abierto (aria-hidden="false") forzamos que el backdrop sea visible */
  .cdl-panel[aria-hidden="false"] + .cdl-panel__backdrop{
    opacity:1;
    pointer-events:auto;
  }
</style>

<script>
/* Sincroniza panel y backdrop (usa tus mismos IDs) */
(function(){
  const panel    = document.getElementById('pagesPanel');
  const openBtn  = document.getElementById('btnMenu');
  const closeBtn = document.getElementById('btnClosePanel');
  const backdrop = document.getElementById('panelBackdrop');

  function open(){
    panel?.setAttribute('aria-hidden','false');
    if(backdrop) backdrop.hidden = false;
    openBtn?.setAttribute('aria-expanded','true');
  }
  function close(){
    panel?.setAttribute('aria-hidden','true');
    if(backdrop) backdrop.hidden = true;
    openBtn?.setAttribute('aria-expanded','false');
  }

  openBtn?.addEventListener('click', open);
  closeBtn?.addEventListener('click', close);
  backdrop?.addEventListener('click', close);
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });

  // Al cargar, por si acaso, deja el backdrop oculto
  window.addEventListener('load', ()=>{ if(backdrop) backdrop.hidden = true; });
})();
</script>

<style>
  .cdl-panel{ position:fixed; inset:0 auto 0 0; width:min(86vw, 360px); background:#fff; z-index:1100;
    border-right:1px solid var(--cdl-line); transform:translateX(-102%); transition:transform .28s ease; display:flex; flex-direction:column; }
  .cdl-panel[aria-hidden="false"]{ transform:translateX(0); }
  .cdl-panel__backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.28); z-index:1090; }
  .cdl-panel__head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--cdl-line); }
  .cdl-x{ width:36px; height:36px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; font-weight:900; }
  .cdl-panel__search{ display:flex; gap:.5rem; padding:12px 16px; border-bottom:1px solid var(--cdl-line); }
  .cdl-panel__search input{ flex:1; height:40px; border:1px solid #e5e7eb; border-radius:10px; padding:0 .7rem; }
  .cdl-panel__nav{ display:grid; gap:.2rem; padding:10px 8px; }
  .cdl-panel__nav a{ display:block; padding:.7rem .8rem; border-radius:12px; font-weight:800; color:#111; }
  .cdl-panel__nav a:hover{ background:#f3f4f6; }
  .cdl-panel__foot{ margin-top:auto; padding:10px 16px; border-top:1px solid var(--cdl-line); color:#6b7280; }
</style>

<script>
(function(){
  const panel = document.getElementById('pagesPanel');
  const openBtn = document.getElementById('btnMenu');
  const closeBtn = document.getElementById('btnClosePanel');
  const backdrop = document.getElementById('panelBackdrop');

  function open(){ panel.setAttribute('aria-hidden','false'); backdrop.hidden=false; openBtn?.setAttribute('aria-expanded','true'); }
  function close(){ panel.setAttribute('aria-hidden','true'); backdrop.hidden=true; openBtn?.setAttribute('aria-expanded','false'); }

  openBtn?.addEventListener('click', open);
  closeBtn?.addEventListener('click', close);
  backdrop?.addEventListener('click', close);
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });

  document.getElementById('searchBtn')?.addEventListener('click', ()=>{
    const q = (document.getElementById('searchBox')?.value||'').trim();
    location.hash = '#/equipos?q='+encodeURIComponent(q);
    close();
  });
})();
</script>

<!-- =========================================================
BLOQUE 07 — LISTA DE EQUIPOS
========================================================= -->
<section id="equiposView" class="cdl-container" hidden>
  <h2>Equipos</h2>
  <div id="equiposGrid" class="equipos-grid"></div>
</section>

<style>
  .equipos-grid{ display:grid; grid-template-columns:1fr; gap:12px; padding-bottom:22px; }
  @media(min-width:720px){ .equipos-grid{ grid-template-columns: repeat(2, 1fr); } }
  @media(min-width:1024px){ .equipos-grid{ grid-template-columns: repeat(3, 1fr); } }

  .eq-card{ border:1px solid #e5e7eb; border-radius:14px; background:#fff; overflow:hidden; display:flex; flex-direction:column; }
  .eq-card__media{ aspect-ratio: 16/9; background:#f3f4f6 url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="290" height="162"><rect width="100%" height="100%" fill="%23f3f4f6"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%239ca3af" font-family="Arial" font-size="14">Foto equipo</text></svg>') center/contain no-repeat; }
  .eq-card__body{ padding:12px; display:grid; gap:10px; }
  .eq-title{ font-weight:900; color:#111; display:flex; align-items:center; justify-content:space-between; }
  .eq-meta{ color:#6b7280; font-size:.9rem; }
  .eq-actions{ display:flex; gap:8px; justify-content:space-between; align-items:center; }
  .eq-actions .btn-cdl{ padding:.55rem .8rem; }
  .eq-qr{ width:60px; height:60px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; display:grid; place-items:center; }
</style>

<script>
function renderEquipos(list, query){
  const grid = document.getElementById('equiposGrid');
  const view = document.getElementById('equiposView');
  if(!grid || !view) return;
  view.hidden = false;

  const q = (query||'').toLowerCase();
  const items = list.filter(e => !q || e.nombre.toLowerCase().includes(q) || String(e.codigo).includes(q));

  grid.innerHTML = '';
  if(items.length === 0){
    grid.innerHTML = `<p style="color:#6b7280">No hay resultados para “${q}”.</p>`;
    return;
  }
  items.forEach(eq=>{
    const card = document.createElement('article');
    card.className = 'eq-card';
    card.innerHTML = `
      <div class="eq-card__media"></div>
      <div class="eq-card__body">
        <div class="eq-title">
          <span>${eq.nombre}</span>
          <small class="eq-meta">#${eq.codigo}</small>
        </div>
        <div class="eq-actions">
          <div class="eq-sem compact" data-sem data-equipo="${eq.codigo}" data-state="${eq.estado||'Restricciones'}"></div>
          <div class="eq-qr" id="qr-${eq.codigo}" aria-label="QR ${eq.nombre}"></div>
        </div>
        <div style="display:flex; gap:.5rem;">
          <button class="btn-cdl" onclick="gotoEquipo('${eq.codigo}')">Abrir ficha</button>
          <button class="btn-cdl" style="background:#111" onclick="registrarEvento('${eq.codigo}')">Añadir evento</button>
        </div>
      </div>`;
    grid.appendChild(card);
    mountSemaforo(card.querySelector('[data-sem]'), {equipo:eq.codigo, estado:eq.estado});
    qrMake(document.getElementById(`qr-${eq.codigo}`), location.origin+location.pathname+`#/equipo/${eq.codigo}`);
  });
}
function gotoEquipo(code){ location.hash = '#/equipo/'+code; }
function registrarEvento(code){ location.hash = '#/equipo/'+code+'?add=1'; }
</script>

<!-- =========================================================
BLOQUE 08 — FICHA DE EQUIPO + QR + KPIs
========================================================= -->
<section id="equipoView" class="cdl-container" hidden>
  <a href="#/equipos" class="btn-cdl" style="background:#111; margin-top:8px;">← Volver</a>
  <header style="margin-top:10px;">
    <h2 id="eqName">Equipo</h2>
    <p id="eqMeta" class="eq-meta"></p>
  </header>

  <div class="cdl-divider"></div>
  <div class="eq-detail">
    <div class="eq-detail__left">
      <div id="eqSem" class="cdl-sem"></div>
      <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:10px;">
        <div class="kpi"><b id="kpi-hm">0h</b><span>Horas marcha</span></div>
        <div class="kpi"><b id="kpi-hr">0h</b><span>Horas restricciones</span></div>
        <div class="kpi"><b id="kpi-hp">0h</b><span>Horas paro</span></div>
        <div class="kpi"><b id="kpi-rp">0</b><span>Reparaciones</span></div>
        <div class="kpi"><b id="kpi-mtbf">—</b><span>MTBF</span></div>
        <div class="kpi"><b id="kpi-dispo">—</b><span>Disponibilidad</span></div>
      </div>
      <h3 style="margin-top:14px;">Histórico</h3>
      <div id="eqTable" class="eq-table"></div>
    </div>
    <aside class="eq-detail__right">
      <h3>QR del equipo</h3>
      <div id="eqQR" class="eq-qr-big"></div>
      <button class="btn-cdl" onclick="window.print()">Imprimir ficha</button>
      <h3 style="margin-top:14px;">Nuevo evento</h3>
      <form id="evtForm" class="evt-form">
        <label>Tipo
          <select name="tipo" required>
            <option value="Avería">Avería</option>
            <option value="Restricción">Restricción</option>
            <option value="Paro">Paro</option>
            <option value="Reparación">Reparación</option>
            <option value="Marcha">Marcha</option>
          </select>
        </label>
        <label>Horas (si aplica) <input type="number" step="0.1" min="0" name="horas" placeholder="0"></label>
        <label>Coste repuesto (€) <input type="number" step="0.01" min="0" name="coste" placeholder="0"></label>
        <label>Detalle <textarea name="detalle" rows="3" placeholder="Descripción…"></textarea></label>
        <button class="btn-cdl" type="submit">Guardar evento</button>
      </form>
    </aside>
  </div>
</section>
<style>
  .eq-detail{ display:grid; grid-template-columns:1fr; gap:16px; }
  .eq-detail__right{ border:1px solid #e5e7eb; border-radius:14px; padding:12px; }
  .eq-qr-big{ width:180px; height:180px; border:1px solid #e5e7eb; border-radius:12px; background:#fff; display:grid; place-items:center; margin-bottom:10px; }
  .kpi{ border:1px solid #e5e7eb; border-radius:12px; padding:8px; background:#fff; display:grid; gap:4px; }
  .kpi b{ font-size:1.15rem; }
  .eq-table{ border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; }
  .eq-table table{ width:100%; border-collapse:collapse; font-size:.95rem; }
  .eq-table th, .eq-table td{ padding:8px 10px; border-bottom:1px solid #f1f5f9; text-align:left; }  /* ← añade el punto y la coma */
  .eq-table th{ background:#f8fafc; color:#111; }
  .evt-form{ display:grid; gap:8px; }
  .evt-form input, .evt-form select, .evt-form textarea{ /* ← añade los puntos */
    width:100%; border:1px solid #e5e7eb; border-radius:10px; padding:.55rem .6rem; background:#fff;
  }
</style>

<!-- Iconos -->
<link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png">
<link rel="apple-touch-icon" href="./icon-192.png">

<!-- iOS / Safari PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
 
<!-- =========================================================
BLOQUE 9 — RENDERIZADOS (equipos, incidencias, inv, rep, cons, OT) + QR fallback
========================================================= -->
<script>
/* ===== Equipos (listado con acciones) ===== */
function renderEquiposList(){
  const wrap = byId("equiposWrap"); if(!wrap) return;
  const items = window.STATE||[];
  if(!items.length){ wrap.innerHTML = `<div class="card">Sin datos</div>`; return; }

  const grupos = {};
  items.forEach(it=>{ (grupos[it.grupo]=grupos[it.grupo]||[]).push(it); });
  const cls = { "Parada":"#dc2626", "Restricciones":"#f59e0b", "En marcha":"#16a34a" };

  wrap.innerHTML = Object.entries(grupos).map(([g,arr])=>{
    const filas = arr.map(it=>{
      const c = cls[it.estado]||"#64748b";
      const slug = slugify(it.nombre);
      return `<div class="card" style="display:flex;align-items:center;gap:.6rem;justify-content:space-between">
        <div><b>${esc(it.nombre)}</b><div class="small" style="color:#64748b">${esc(g)}</div></div>
        <div>${badge(c, it.estado)}</div>
        <div style="display:flex;gap:.35rem;flex-wrap:wrap">
          <button class="btn gloss" onclick="location.hash='#/equipo/${encodeURIComponent(slug)}'">Ficha</button>
          <button class="btn gloss btn-mail" onclick="accionParadaProlongada(${JSON.stringify(it.nombre)})">Parada prolongada</button>
        </div>
      </div>`;
    }).join("");
    return `<div style="margin:.8rem 0"><h3 style="margin:.2rem 0 .6rem">${esc(g)}</h3>${filas}</div>`;
  }).join("");
}

/* ===== Incidencias: tabla + export ===== */
function renderIncidenciasTable(items){ /* igual que antes */ }

/* ===== Inventario ===== */
function renderInv(items){ /* igual que antes */ }
async function invDelta(ref, delta){ /* igual que antes */ }

/* ===== Repuestos solicitados ===== */
function renderRepTable(){ /* igual que antes */ }

/* ===== Consumibles ===== */
function renderConsTable(){ /* igual que antes */ }

/* ===== OT ===== */
function renderOTTable(){ /* igual que antes */ }

/* ===== Acciones varias ===== */
function openRepuestoByRef(ref){ /* igual que antes */ }

function renderEquipoBySlug(slug){
  qsa('[id^="page-"]').forEach(el=>el.classList.add("hidden"));
  byId("page-equipo")?.classList.remove("hidden");
  const eq = (window.STATE||[]).find(x => slugify(x.nombre) === slug);
  const host = byId("equipoDetail");
  if (!host || !eq){ if (host) host.innerHTML="<div class='card'>No encontrado</div>"; return; }
  host.innerHTML = `
    <div class="card">
      <h3 style="margin:.1rem 0">${esc(eq.nombre)}</h3>
      <div class="sub">${esc(eq.grupo)}</div>
      <div style="margin:.5rem 0">Estado actual: <b>${esc(eq.estado)}</b></div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn gloss btn-mail" onclick="accionParadaProlongada(${JSON.stringify(eq.nombre)})">Parada prolongada (email)</button>
        <button class="btn gloss" onclick="window.print()">Imprimir ficha</button>
        <button class="btn gloss" onclick="history.back()">Volver</button>
      </div>
      <div style="margin-top:.6rem"><div id="qrficha"></div></div>
    </div>`;
  if (byId("qrficha")){
    genQR(byId("qrficha"), `${baseURL()}#/equipo/${slug}`, 96);
  }
}

function renderRepuestoByRef(ref){
  qsa('[id^="page-"]').forEach(el=> el.classList.add("hidden"));
  byId("page-repuesto")?.classList.remove("hidden");
  const it = (window.INV||[]).find(x => String(x.ref).toUpperCase() === String(ref).toUpperCase());
  const host = byId("repuestoDetail");
  if (!host || !it){ if (host) host.innerHTML="<div class='card'>No encontrado</div>"; return; }
  host.innerHTML = `
    <div class="card">
      <h3 style="margin:.1rem 0">${esc(it.nombre)}</h3>
      <div class="sub">Ref: <b>${esc(it.ref)}</b></div>
      <div style="margin:.5rem 0">Stock: <b>${it.stock}</b> · Mínimo: <b>${it.minimo}</b></div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn gloss" onclick="window.print()">Imprimir etiqueta</button>
        <button class="btn gloss" onclick="history.back()">Volver</button>
      </div>
      <div style="margin-top:.6rem"><div id="qrrep"></div></div>
    </div>`;
  if (byId("qrrep")){
    genQR(byId("qrrep"), `${baseURL()}#/repuesto/${encodeURIComponent(it.ref)}`, 96);
  }
}

async function accionParadaProlongada(equipo){ /* igual que antes */ }
</script>

<!-- ===== QR fallback ===== -->
<script>
(function(global){
  if(!global.qrMake){
    global.qrMake = function(el, text, size){
      const c=document.createElement("canvas");c.width=c.height=size||120;
      const ctx=c.getContext("2d");ctx.fillStyle="#fff";ctx.fillRect(0,0,c.width,c.height);
      ctx.fillStyle="#000";ctx.fillText("QR",10,50); // simplificado (placeholder real)
      el.innerHTML=""; el.appendChild(c);
    };
  }
  global.genQR = function(el,text,size){
    if(global.QRCode){
      new QRCode(el,{text,width:size||120,height:size||120});
    }else{
      qrMake(el,text,size||120);
    }
  };
})(window);
</script>    
<!-- =========================================================
BLOQUE 10 — ESTILOS DE IMPRESIÓN + PULIDO CABECERA + SHEETS API
(Reemplaza tu bloque 10 y elimina cualquier BLOQUE B duplicado)
========================================================= -->
<style>
  /* Pulido responsive: separación entre secciones dentro del main */
  main.cdl-container section + section{ margin-top:16px; }

  /* Cabecera (no invasivo, seguro si ya tienes estilos previos) */
  .cdl-header{
    position:sticky; top:0; z-index:1000;
    height:var(--hdr-h); background:#fff; border-bottom:1px solid var(--cdl-line);
  }
  .cdl-header__inner{
    height:var(--hdr-h); display:flex; align-items:center; justify-content:space-between; position:relative;
  }
  .cdl-user{ display:flex; align-items:center; gap:.5rem; }
  .cdl-user__role{ font-weight:800; color:#111; }
  .cdl-user__btn{
    width:42px; height:42px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; color:#111;
  }

  /* Modo oscuro (si lo usas) */
  .theme-dark .cdl-header{ background:#0b0f14; border-bottom-color:#111827; }
  .theme-dark .cdl-user__role{ color:#fff; }
  .theme-dark .cdl-user__btn{ background:#0b0f14; border-color:#1f2937; color:#fff; }

  /* Print: solo ficha del equipo, con QR grande y tabla */
  @media print{
    header, #cdlHeader, #pagesPanel, #panelBackdrop, .btn-cdl, .cdl-divider, #equiposView { display:none !important; }
    #equipoView{ display:block !important; }
    .eq-detail{ grid-template-columns: 1.2fr .8fr !important; gap:10px; }
    body{ -webkit-print-color-adjust:exact; print-color-adjust:exact; }
  }
</style>

<script>
/* =========================================================
SHEETS API (Apps Script publicado como Web App)
- Usa: apiSheet.get('state' | 'incid' | 'inv' | 'rep' | 'cons' | 'ot' | 'personal' | 'logs')
- Usa: apiSheet.post('<clave>', { ...payload... })
========================================================= */
(function(){
  // 👇 Tu Web App URL (Apps Script v25)
  const GSCRIPT_URL = "https://script.google.com/macros/s/AKfycbzPxPJztSCo7dX-xmzYW_pBwkQne3aACe1EzzlNDsjr0nuRXZaOSOrRGzVrYZsN5cgF/exec";
  
  async function sheetFetch(path='', {method='GET', data=null}={}){
    if(!GSCRIPT_URL){ console.warn('[Sheets] GSCRIPT_URL vacío'); return null; }
    const url = GSCRIPT_URL + (path||'');
    const opt = { method, headers:{ 'Content-Type':'application/json' } };
    if(data) opt.body = JSON.stringify(data);
    const res = await fetch(url, opt);
    if(!res.ok) throw new Error('Sheets API error: '+res.status);
    return res.json();
  }

  // API pública para tu frontend (se define una sola vez)
  if(!window.apiSheet){
    window.apiSheet = {
      get(key){ return sheetFetch('?key='+encodeURIComponent(key), {method:'GET'}); },
      post(key, payload){ return sheetFetch('?key='+encodeURIComponent(key), {method:'POST', data:payload}); }
    };
  }

  // // Ejemplo rápido (descomenta para probar en consola):
  // window.addEventListener('load', async ()=>{
  //   const estado = await apiSheet.get('state');
  //   console.log('STATE desde Sheets:', estado);
  // });
})();
</script>
<!-- =========================================================
BLOQUE 18 — FILTROS AVANZADOS (estado + críticos + URL)
========================================================= -->

<section id="filterBar" class="cdl-container" hidden style="margin-top:8px;">
  <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
    <select id="fEstado" style="height:38px; border:1px solid #e5e7eb; border-radius:10px; padding:0 .6rem;">
      <option value="">Todos los estados</option>
      <option value="En marcha">En marcha</option>
      <option value="Restricciones">Restricciones</option>
      <option value="Parada">Parada</option>
    </select>
    <label style="display:inline-flex; align-items:center; gap:.4rem; font-weight:800; color:#111;">
      <input id="fCriticos" type="checkbox"> Solo críticos (Parada o MTBF<10h)
    </label>
    <button class="btn-cdl" id="fApply">Aplicar</button>
    <button class="btn-cdl" style="background:#111" id="fClear">Limpiar</button>
  </div>
</section>

<script>
(function(){
  const $ = s=>document.querySelector(s);
  function getEquipos(){ try{ return JSON.parse(localStorage.getItem('cdl-equipos'))||[] }catch{ return [] } }
  function getEvt(code){ try{ return JSON.parse(localStorage.getItem('cdl-evt-'+code))||[] }catch{ return [] } }
  function mtbf(eq){
    const rep = (eq.reparaciones||0) + getEvt(eq.codigo).filter(e=>e.tipo==='Reparación').length;
    const hm = (eq.horas?.m||0) + getEvt(eq.codigo).filter(e=>e.tipo==='Marcha').reduce((a,b)=>a+Number(b.horas||0),0);
    return hm/Math.max(1,rep);
  }

  function applyFilters(){
    const url = new URL(location.href);
    const Estado = $('#fEstado').value;
    const Crit  = $('#fCriticos').checked ? '1' : '';
    const q = (url.hash.split('?')[1]||'');
    const params = new URLSearchParams(q);
    if(Estado) params.set('estado', Estado); else params.delete('estado');
    if(Crit) params.set('crit', '1'); else params.delete('crit');
    // conservamos la búsqueda q si venía desde barra lateral
    location.hash = '#/equipos' + (params.toString()? '?'+params.toString() : '');
  }

  function hookRouter(){
    const h = location.hash||'';
    const [path, qstr] = h.split('?');
    const list = getEquipos();
    const params = new URLSearchParams(qstr||'');
    const estado = params.get('estado')||'';
    const crit = params.get('crit')==='1';

    // Mostrar barra filtros sólo en lista
    const fb = document.getElementById('filterBar');
    if(fb) fb.hidden = !path.startsWith('#/equipos');

    // Sin grid? salimos
    const grid = document.getElementById('equiposGrid');
    if(!grid || fb?.hidden) return;

    // Tomamos los elementos ya renderizados por renderEquipos y ocultamos según filtros
    const cards = Array.from(grid.querySelectorAll('.eq-card'));
    cards.forEach(card=>{
      const code = card.querySelector('.eq-meta')?.textContent?.replace('#','');
      const nm = card.querySelector('.eq-title span')?.textContent||'';
      let visible = true;
      const estActual = card.querySelector('[data-sem]')?.getAttribute('data-state') || '';
      if(estado && estActual!==estado) visible = false;
      if(crit){
        const eq = list.find(x=>x.codigo===code);
        if(!(estActual==='Parada' || mtbf(eq)<10)) visible=false;
      }
      card.style.display = visible?'grid':'none';
    });

    // Poner controles según URL
    if(fb){
      document.getElementById('fEstado').value = estado;
      document.getElementById('fCriticos').checked = crit;
    }
  }

  window.addEventListener('hashchange', hookRouter);
  window.addEventListener('load', ()=>{
    document.getElementById('fApply')?.addEventListener('click', applyFilters);
    document.getElementById('fClear')?.addEventListener('click', ()=>{
      const params = new URLSearchParams(location.hash.split('?')[1]||'');
      params.delete('estado'); params.delete('crit');
      location.hash = '#/equipos' + (params.toString()? '?'+params.toString() : '');
    });
    hookRouter();
  });
})();
</script>

<!-- =========================================================
BLOQUE 19 — LOTE DE QR (impresión masiva) — ruta #/qr
========================================================= -->
<section id="qrView" class="cdl-container" hidden>
  <h2>Impresión de QR</h2>
  <p style="color:#6b7280; margin:.3rem 0 1rem;">Selecciona equipos y genera una hoja imprimible.</p>
  <div style="display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom:8px;">
    <button class="btn-cdl" id="qrSelAll">Seleccionar todo</button>
    <button class="btn-cdl" id="qrSelNone" style="background:#111;">Limpiar</button>
    <button class="btn-cdl" id="qrPrint">Imprimir</button>
  </div>
  <div id="qrGrid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(180px,1fr)); gap:10px;"></div>
</section>

<style>
  .qr-item{ border:1px solid #e5e7eb; border-radius:12px; padding:10px; background:#fff; display:grid; gap:6px; }
  .qr-box{ width:150px; height:150px; border:1px solid #e5e7eb; border-radius:10px; display:grid; place-items:center; margin:auto; }
  .qr-cap{ text-align:center; font-weight:900; }
  @media print{
    #qrView .btn-cdl, #qrSelAll, #qrSelNone { display:none !important; }
    #qrGrid{ grid-template-columns:repeat(3,1fr) !important; }
    .qr-item{ break-inside:avoid; }
  }
</style>

<script>
(function(){
  const $=s=>document.querySelector(s);
  function getEquipos(){ try{ return JSON.parse(localStorage.getItem('cdl-equipos'))||[] }catch{ return [] } }

  function renderQR(){
    const v = document.getElementById('qrView'); if(!v) return;
    const grid = document.getElementById('qrGrid'); grid.innerHTML='';
    const list = getEquipos();
    list.forEach(e=>{
      const it = document.createElement('label');
      it.className='qr-item';
      it.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <div class="qr-cap">${e.nombre}</div>
          <input type="checkbox" class="qr-check" checked data-code="${e.codigo}">
        </div>
        <div class="qr-box" id="qrbox-${e.codigo}"></div>
        <div style="text-align:center; color:#6b7280;">#${e.codigo}</div>
      `;
      grid.appendChild(it);
      qrMake(it.querySelector('#qrbox-'+e.codigo), location.origin+location.pathname+'#/equipo/'+e.codigo, 150);
    });
    $('#qrSelAll').onclick = ()=> grid.querySelectorAll('.qr-check').forEach(c=>c.checked=true);
    $('#qrSelNone').onclick = ()=> grid.querySelectorAll('.qr-check').forEach(c=>c.checked=false);
    $('#qrPrint').onclick = ()=>{
      // Ocultar los que no estén seleccionados para imprimir
      grid.querySelectorAll('.qr-item').forEach(it=>{
        const chk = it.querySelector('.qr-check'); it.style.display = chk.checked? 'grid':'none';
      });
      window.print();
    };
  }

  function route(){
    const is = (location.hash||'').startsWith('#/qr');
    const v = document.getElementById('qrView'); if(!v) return;
    v.hidden = !is; if(is) renderQR();
  }
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
})();
</script>

<!-- =========================================================
BLOQUE 21 — FILTROS POR FECHA/TIPO EN HISTÓRICO (vista ficha)
========================================================= -->
<section id="eqFilters" class="cdl-container" hidden>
  <div style="display:flex; gap:.5rem; flex-wrap:wrap; align-items:end;">
    <label style="display:grid; gap:4px;">
      <small style="color:#6b7280;">Desde</small>
      <input id="fhFrom" type="date" style="height:38px; border:1px solid #e5e7eb; border-radius:10px; padding:0 .6rem;">
    </label>
    <label style="display:grid; gap:4px;">
      <small style="color:#6b7280;">Hasta</small>
      <input id="fhTo" type="date" style="height:38px; border:1px solid #e5e7eb; border-radius:10px; padding:0 .6rem;">
    </label>
    <label style="display:grid; gap:4px;">
      <small style="color:#6b7280;">Tipo</small>
      <select id="fhTipo" style="height:38px; border:1px solid #e5e7eb; border-radius:10px; padding:0 .6rem;">
        <option value="">Todos</option>
        <option>Avería</option>
        <option>Restricción</option>
        <option>Paro</option>
        <option>Reparación</option>
        <option>Marcha</option>
      </select>
    </label>
    <button id="fhApply" class="btn-cdl">Filtrar</button>
    <button id="fhClear" class="btn-cdl" style="background:#111;">Limpiar</button>
  </div>
</section>

<script>
(function(){
  const $ = s=>document.querySelector(s);
  function ls(key, def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def }catch{ return def } }
  function getEq(){ const h=location.hash.split('/'); return decodeURIComponent(h[2]||''); }

  function mountFilterBar(){
    const onFicha = (location.hash||'').startsWith('#/equipo/');
    const bar = document.getElementById('eqFilters'); if(!bar) return;
    bar.hidden = !onFicha;
  }

  function applyHistoricFilter(){
    const code = getEq(); if(!code) return;
    const from = $('#fhFrom').value ? new Date($('#fhFrom').value).getTime() : null;
    const to   = $('#fhTo').value ? (new Date($('#fhTo').value).getTime()+24*3600*1000-1) : null;
    const tipo = $('#fhTipo').value || '';
    const ev = ls('cdl-evt-'+code, []);
    const filtered = ev.filter(e=>{
      const okTipo = !tipo || e.tipo===tipo;
      const okFrom = !from || e.ts>=from;
      const okTo   = !to   || e.ts<=to;
      return okTipo && okFrom && okTo;
    });
    // Reemplazar tabla en #eqTable
    const wrap = document.getElementById('eqTable'); if(!wrap) return;
    const tbl = document.createElement('table');
    tbl.innerHTML = `<thead><tr>
      <th>Fecha</th><th>Tipo</th><th>Horas</th><th>Coste €</th><th>Detalle</th>
    </tr></thead><tbody>${
      filtered.map(e=>`<tr><td>${new Date(e.ts).toLocaleString()}</td><td>${e.tipo}</td><td>${e.horas||''}</td><td>${e.coste||''}</td><td>${(e.detalle||'').replace(/</g,'&lt;')}</td></tr>`).join('')||'<tr><td colspan="5" style="color:#6b7280">Sin registros en el rango.</td></tr>'
    }</tbody>`;
    wrap.innerHTML=''; wrap.appendChild(tbl);
  }

  window.addEventListener('hashchange', ()=>{ mountFilterBar(); });
  window.addEventListener('load', ()=>{
    mountFilterBar();
    document.getElementById('fhApply')?.addEventListener('click', applyHistoricFilter);
    document.getElementById('fhClear')?.addEventListener('click', ()=>{
      ['fhFrom','fhTo','fhTipo'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      // Forzamos un refresco de la ficha para recomputar KPIs y tabla completa
      const code = getEq(); if(code){ location.hash = '#/equipo/'+encodeURIComponent(code); }
    });
  });
})();
</script>

<!-- =========================================================
BLOQUE 22 — EXPORTACIÓN A PDF (título dinámico + botón)
========================================================= -->
<div id="pdfBar" class="cdl-container" hidden style="margin:8px 0;">
  <button class="btn-cdl" id="btnPDF">Exportar PDF de la ficha</button>
</div>

<script>
(function(){
  const $=s=>document.querySelector(s);
  function onRoute(){
    const isFicha = (location.hash||'').startsWith('#/equipo/');
    const bar = $('#pdfBar'); if(bar) bar.hidden = !isFicha;
  }
  function exportPDF(){
    const name = document.getElementById('eqName')?.textContent?.trim()||'Equipo';
    const oldTitle = document.title;
    document.title = `CDL - Ficha ${name}`;
    window.print();
    setTimeout(()=>{ document.title = oldTitle; }, 500);
  }
  window.addEventListener('hashchange', onRoute);
  window.addEventListener('load', ()=>{
    onRoute();
    document.getElementById('btnPDF')?.addEventListener('click', exportPDF);
  });
})();
</script>

<!-- =========================================================
BLOQUE 23 — MINI-AUDITORÍA (acciones clave + visor)
========================================================= -->
<section id="auditView" class="cdl-container" hidden>
  <h2>Auditoría</h2>
  <div id="auditTable" class="eq-table"></div>
</section>

<script>
(function(){
  const AUDKEY='cdl-audit';
  const $=s=>document.querySelector(s);
  function getUser(){ try{ return JSON.parse(localStorage.getItem('cdl-user'))||{name:'Invitado',role:'Mantenimiento'} }catch{ return {name:'Invitado',role:'Mantenimiento'} } }
  function load(){ try{ return JSON.parse(localStorage.getItem(AUDKEY))||[] }catch{ return [] } }
  function save(a){ localStorage.setItem(AUDKEY, JSON.stringify(a)); }

  // API pública
  window.auditLog = function(action, meta){
    const u = getUser();
    const arr = load();
    arr.unshift({ts:Date.now(), user:u.name, role:u.role, action, ...(meta||{})});
    save(arr.slice(0,1000)); // cap
  };

  // Captura cambios de estado (semaf.)
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.cdl-sem .btn');
    if(!btn) return;
    const grp = btn.closest('.cdl-sem');
    const chip = grp?.querySelector('#chipState'); const estado = btn.dataset.state;
    const equipo = grp?.querySelector('.txt') ? (grp.parentElement?.querySelector('[data-equipo]')?.getAttribute('data-equipo') || '') : '';
    window.auditLog('Cambio estado', {equipo, estado});
  }, true);

  // Captura alta de evento en ficha
  document.addEventListener('submit', (e)=>{
    if(e.target?.id==='evtForm'){
      const fd = new FormData(e.target);
      const tipo = fd.get('tipo'); const horas=fd.get('horas'); const coste=fd.get('coste');
      const code = (location.hash.split('/')[2]||'');
      window.auditLog('Nuevo evento', {equipo: decodeURIComponent(code), tipo, horas, coste});
    }
  }, true);

  // Hooks a editor (si existe)
  function hookEditor(){
    const m = document.getElementById('eqModal'); if(!m) return;
    const form = document.getElementById('eqForm');
    const del = document.getElementById('eqDel');
    if(form && !form.dataset.__audit){
      form.dataset.__audit='1';
      form.addEventListener('submit', ()=>{
        const fd = new FormData(form);
        const code = fd.get('codigo'); const name=fd.get('nombre');
        const estado=fd.get('estado');
        const editing = form.codigo.readOnly;
        window.auditLog(editing?'Editar equipo':'Nuevo equipo', {equipo:code, nombre:name, estado});
      }, true);
    }
    if(del && !del.dataset.__audit){
      del.dataset.__audit='1';
      del.addEventListener('click', ()=> {
        const code = document.querySelector('#eqForm [name="codigo"]')?.value||'';
        window.auditLog('Eliminar equipo', {equipo:code});
      }, true);
    }
  }
  const mo = new MutationObserver(hookEditor); mo.observe(document.body,{subtree:true,childList:true});

  // Ruta #/audit
  function route(){
    const is = (location.hash||'').startsWith('#/audit');
    const v = $('#auditView'); if(!v) return;
    v.hidden = !is; if(!is) return;
    const tbl = document.createElement('table');
    const rows = load().map(r=>`<tr>
      <td>${new Date(r.ts).toLocaleString()}</td>
      <td>${r.user} (${r.role})</td>
      <td>${r.action}</td>
      <td>${r.equipo||''}</td>
      <td>${r.tipo||''}</td>
      <td>${r.horas||''}</td>
      <td>${r.coste||''}</td>
    </tr>`).join('');
    tbl.innerHTML = `<thead><tr><th>Fecha</th><th>Usuario</th><th>Acción</th><th>Equipo</th><th>Tipo</th><th>Horas</th><th>Coste</th></tr></thead><tbody>${rows||'<tr><td colspan="7" style="color:#6b7280">Sin registros.</td></tr>'}</tbody>`;
    const wrap = document.getElementById('auditTable'); wrap.innerHTML=''; wrap.appendChild(tbl);
  }
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
})();
</script>

<!-- =========================================================
BLOQUE 24 — TEMA OSCURO OPCIONAL (toggle + persistencia)
========================================================= -->
<div id="themeBar" class="cdl-container" style="margin:8px 0;">
  <button id="themeToggle" class="btn-cdl" style="background:#111;">🌙 Tema oscuro</button>
</div>

<style>
  :root[data-theme="dark"]{
    --cdl-black:#E5E7EB; --cdl-ink:#F3F4F6; --cdl-muted:#9CA3AF; --cdl-line:#374151; 
    background:#0B0F14; color:#E5E7EB;
  }
  :root[data-theme="dark"] body{ background:#0B0F14; color:#E5E7EB; }
  :root[data-theme="dark"] .cdl-panel,
  :root[data-theme="dark"] .eq-card,
  :root[data-theme="dark"] .eq-detail__right,
  :root[data-theme="dark"] .kpi,
  :root[data-theme="dark"] .eq-table,
  :root[data-theme="dark"] .qr-item{ background:#0F141B; border-color:#253040; }
  :root[data-theme="dark"] .cdl-panel__nav a:hover{ background:#121924; }
  :root[data-theme="dark"] .btn-cdl{ box-shadow:none; }
  :root[data-theme="dark"] input, :root[data-theme="dark"] select, :root[data-theme="dark"] textarea{
    background:#0F141B; border-color:#253040; color:#E5E7EB;
  }
  :root[data-theme="dark"] .cdl-hamb, :root[data-theme="dark"] .cdl-user__btn{ background:#0F141B; border-color:#253040; color:#E5E7EB; }
  :root[data-theme="dark"] .cdl-header{ background:#0B0F14; border-bottom-color:#253040; }
  :root[data-theme="dark"] .eq-table th{ background:#121924; color:#E5E7EB; }
</style>

<script>
(function(){
  const ROOT=document.documentElement;
  const KEY='cdl-theme';
  function setTheme(t){ ROOT.setAttribute('data-theme', t); localStorage.setItem(KEY, JSON.stringify(t)); }
  function getTheme(){ try{ return JSON.parse(localStorage.getItem(KEY))||'light' }catch{ return 'light' } }
  function syncBtn(){
    const t=getTheme(); const btn=document.getElementById('themeToggle');
    if(btn) btn.textContent = t==='dark' ? '☀️ Tema claro' : '🌙 Tema oscuro';
  }
  window.addEventListener('load', ()=>{
    setTheme(getTheme()); syncBtn();
    document.getElementById('themeToggle')?.addEventListener('click', ()=>{
      const n = (getTheme()==='dark'?'light':'dark'); setTheme(n); syncBtn();
    });
  });
})();
</script>
<!-- =========================================================
BLOQUE 26 — EXPORTAR CSV/JSON (histórico, incidencias, equipos)
========================================================= -->
<section id="exportBar" class="cdl-container" hidden style="margin:8px 0;">
  <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
    <button class="btn-cdl" id="exEqCSV">CSV Ficha</button>
    <button class="btn-cdl" id="exEqJSON" style="background:#111;">JSON Ficha</button>
    <button class="btn-cdl" id="exIncCSV">CSV Incidencias</button>
    <button class="btn-cdl" id="exAllCSV" style="background:#111;">CSV Todos los equipos</button>
  </div>
</section>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const LS=(k,d=[])=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d } };
  const getEqCode=()=> decodeURIComponent((location.hash.split('/')[2]||''));

  function route(){
    const h=location.hash||'';
    const show = h.startsWith('#/equipo/') || h.startsWith('#/incidencias');
    const bar = $('#exportBar'); if(bar) bar.hidden = !show;
  }

  function toCSV(arr, headers){
    const esc = v => String(v??'').replaceAll('"','""');
    const rows = [headers.join(',')].concat(arr.map(o => headers.map(h=>`"${esc(o[h])}"`).join(',')));
    return rows.join('\r\n');
  }
  function download(name, content, mime='text/plain'){
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([content],{type:mime}));
    a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500);
  }

  // CSV del histórico de la ficha
  function exportFichaCSV(){
    const code = getEqCode(); if(!code) return alert('Abre una ficha de equipo');
    const ev = LS('cdl-evt-'+code,[]);
    const csv = toCSV(ev.map(x=>({fecha:new Date(x.ts).toLocaleString(), tipo:x.tipo, horas:x.horas, coste:x.coste, detalle:x.detalle})),
                      ['fecha','tipo','horas','coste','detalle']);
    download(`CDL_${code}_historico.csv`, csv, 'text/csv;charset=utf-8');
  }
  function exportFichaJSON(){
    const code = getEqCode(); if(!code) return alert('Abre una ficha de equipo');
    const ev = LS('cdl-evt-'+code,[]);
    download(`CDL_${code}_historico.json`, JSON.stringify(ev,null,2), 'application/json');
  }
  function exportIncidenciasCSV(){
    const arr = LS('cdl-inc',[]);
    const csv = toCSV(arr.map(x=>({fecha:new Date(x.ts).toLocaleString(), equipo:x.equipo, cat:x.cat, sev:x.sev, horas:x.hrs, coste:x.coste, desc:x.desc})),
                      ['fecha','equipo','cat','sev','horas','coste','desc']);
    download(`CDL_incidencias.csv`, csv, 'text/csv;charset=utf-8');
  }
  function exportEquiposCSV(){
    const arr = LS('cdl-equipos',[]);
    const csv = toCSV(arr.map(e=>({codigo:e.codigo, nombre:e.nombre, estado:e.estado, repuestos:(e.repuestos||0), reparaciones:(e.reparaciones||0)})),
                      ['codigo','nombre','estado','repuestos','reparaciones']);
    download(`CDL_equipos.csv`, csv, 'text/csv;charset=utf-8');
  }

  window.addEventListener('hashchange', route);
  window.addEventListener('load', ()=>{
    route();
    $('#exEqCSV')?.addEventListener('click', exportFichaCSV);
    $('#exEqJSON')?.addEventListener('click', exportFichaJSON);
    $('#exIncCSV')?.addEventListener('click', exportIncidenciasCSV);
    $('#exAllCSV')?.addEventListener('click', exportEquiposCSV);
  });
})();
</script>

<!-- =========================================================
BLOQUE 27 — REPUESTOS (catálogo + movimientos + stock)
Ruta: #/repuestos
========================================================= -->
<section id="repView" class="cdl-container" hidden>
  <h2>Repuestos</h2>

  <details open style="margin:6px 0 10px;">
    <summary style="cursor:pointer; font-weight:800;">Catálogo</summary>
    <form id="repCatForm" class="evt-form" style="margin:8px 0;">
      <div style="display:grid; grid-template-columns:2fr 1fr 1fr; gap:8px;">
        <label>Código <input name="cod" placeholder="RP-0001" required></label>
        <label>Descripción <input name="desc" placeholder="Rodamiento 6203"></label>
        <label>Stock <input type="number" name="stk" step="1" min="0" value="0"></label>
      </div>
      <div style="display:flex; gap:.5rem; justify-content:flex-end;">
        <button class="btn-cdl" type="submit">Guardar pieza</button>
      </div>
    </form>
    <div id="repCatTable" class="eq-table"></div>
  </details>

  <details style="margin:6px 0 10px;">
    <summary style="cursor:pointer; font-weight:800;">Movimientos / Consumos</summary>
    <form id="repMovForm" class="evt-form" style="margin:8px 0;">
      <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:8px;">
        <label>Pieza
          <input name="cod" list="repCodList" placeholder="RP-0001" required>
          <datalist id="repCodList"></datalist>
        </label>
        <label>Equipo <input name="equipo" list="incEqList" placeholder="EQ-001"></label>
        <label>Cantidad <input type="number" name="qty" step="1" value="1" min="1"></label>
        <label>Coste total (€) <input type="number" name="coste" step="0.01" value="0"></label>
      </div>
      <div style="display:flex; gap:.5rem; justify-content:flex-end;">
        <button class="btn-cdl" type="submit">Registrar consumo</button>
      </div>
    </form>
    <div id="repMovTable" class="eq-table"></div>
  </details>
</section>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const LSC='cdl-rep-cat';   // catálogo
  const LSM='cdl-rep-mov';   // movimientos
  const LSE='cdl-equipos';   // equipos (para acumular coste)
  const read=(k,d=[])=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d } };
  const write=(k,v)=> localStorage.setItem(k, JSON.stringify(v));

  function updDatalist(){
    const dl=$('#repCodList'); if(!dl) return;
    dl.innerHTML = read(LSC,[]).map(p=>`<option value="${p.cod}">${p.desc||''}</option>`).join('');
  }

  function renderCat(){
    const wrap=$('#repCatTable'); if(!wrap) return;
    const arr=read(LSC,[]);
    const tbl=document.createElement('table');
    tbl.innerHTML=`<thead><tr><th>Código</th><th>Descripción</th><th>Stock</th></tr></thead>
      <tbody>${arr.map(p=>`<tr><td>${p.cod}</td><td>${(p.desc||'').replace(/</g,'&lt;')}</td><td>${p.stk|0}</td></tr>`).join('')||'<tr><td colspan="3" style="color:#6b7280">Sin piezas.</td></tr>'}</tbody>`;
    wrap.innerHTML=''; wrap.appendChild(tbl);
  }
  function renderMov(){
    const wrap=$('#repMovTable'); if(!wrap) return;
    const arr=read(LSM,[]);
    const tbl=document.createElement('table');
    tbl.innerHTML=`<thead><tr><th>Fecha</th><th>Pieza</th><th>Equipo</th><th>Cant.</th><th>Coste €</th></tr></thead>
      <tbody>${arr.map(m=>`<tr><td>${new Date(m.ts).toLocaleString()}</td><td>${m.cod}</td><td>${m.equipo||''}</td><td>${m.qty}</td><td>${m.coste||0}</td></tr>`).join('')||'<tr><td colspan="5" style="color:#6b7280">Sin movimientos.</td></tr>'}</tbody>`;
    wrap.innerHTML=''; wrap.appendChild(tbl);
  }

  function route(){
    const is=(location.hash||'').startsWith('#/repuestos');
    const v=$('#repView'); if(!v) return;
    v.hidden=!is; if(is){ updDatalist(); renderCat(); renderMov(); }
  }

  // Guardar en catálogo
  function onCat(e){
    e.preventDefault();
    const fd=new FormData(e.target);
    const cod=String(fd.get('cod')||'').trim(); if(!cod) return;
    const desc=String(fd.get('desc')||'').trim();
    const stk=Math.max(0, parseInt(fd.get('stk')||0,10));
    const arr=read(LSC,[]); const i=arr.findIndex(p=>p.cod===cod);
    if(i>-1){ arr[i].desc=desc; arr[i].stk=stk; } else { arr.push({cod,desc,stk}); }
    write(LSC,arr); (e.target).reset(); renderCat(); updDatalist();
  }

  // Registrar consumo (movimiento) y actualizar stock y coste acumulado de equipo
  function onMov(e){
    e.preventDefault();
    const fd=new FormData(e.target);
    const cod=String(fd.get('cod')||'').trim(); if(!cod) return;
    const equipo=String(fd.get('equipo')||'').trim();
    const qty=Math.max(1, parseInt(fd.get('qty')||1,10));
    const coste=Number(fd.get('coste')||0);
    const mov={ts:Date.now(), cod, equipo, qty, coste};
    const M=read(LSM,[]); M.unshift(mov); write(LSM,M);

    const C=read(LSC,[]); const p=C.find(x=>x.cod===cod); if(p){ p.stk=Math.max(0,(p.stk|0)-qty); write(LSC,C); }

    if(equipo){
      const E=read(LSE,[]); const it=E.find(x=>x.codigo===equipo);
      if(it){ it.repuestos=(it.repuestos||0)+coste; write(LSE,E); }
    }
    window.auditLog?.('Consumo repuesto', {equipo, pieza:cod, qty, coste});
    (e.target).reset(); renderCat(); renderMov();
  }

  window.addEventListener('hashchange', route);
  window.addEventListener('load', ()=>{
    route();
    $('#repCatForm')?.addEventListener('submit', onCat);
    $('#repMovForm')?.addEventListener('submit', onMov);
  });
})();
</script>

<!-- =========================================================
BLOQUE 29 — “Badge” de Fiabilidad (lista + ficha)
========================================================= -->
<style>
  .badge-fiab{
    display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .5rem;
    border-radius:999px; font-weight:900; font-size:.85rem; border:1px solid #e5e7eb; background:#fff;
  }
  .fiab-A{ color:#065f46; background:#ecfdf5; border-color:#a7f3d0; }   /* 90–100 */
  .fiab-B{ color:#166534; background:#dcfce7; border-color:#86efac; }   /* 75–89 */
  .fiab-C{ color:#92400e; background:#fffbeb; border-color:#fcd34d; }   /* 60–74 */
  .fiab-D{ color:#7f1d1d; background:#fef2f2; border-color:#fecaca; }   /* 0–59 */
</style>

<script>
(function(){
  // Cálculo simple de fiabilidad: %Disponibilidad penalizado por nº de reparaciones
  function fiabilidad(eq){
    const horas={...(eq.horas||{m:0,r:0,p:0})};
    const total=horas.m+horas.r+horas.p||1;
    const dispo=(horas.m/total)*100;
    const reps=Math.max(0, eq.reparaciones||0);
    const score=Math.max(0, dispo - reps*2); // penalización ligera por reparación
    let grade='A'; if(score<90) grade='B'; if(score<75) grade='C'; if(score<60) grade='D';
    return {score, grade};
  }
  // Reemplazamos renderEquipos para mostrar badge
  const _calcKPIs = (eq)=>{
    const h={...(eq.horas||{m:0,r:0,p:0})}; const tot=h.m+h.r+h.p||1; return (h.m/tot)*100;
  };
  window.renderEquipos = function(list, query){
    const grid = document.getElementById('equiposGrid');
    const view = document.getElementById('equiposView');
    if(!grid || !view) return;
    view.hidden=false;
    const q=(query||'').toLowerCase();
    const items=list.filter(e=>!q || e.nombre.toLowerCase().includes(q) || String(e.codigo).includes(q));
    grid.innerHTML='';
    if(items.length===0){ grid.innerHTML=`<p style="color:#6b7280">No hay resultados para “${q}”.</p>`; return; }

    items.forEach(eq=>{
      const {score, grade}=fiabilidad(eq);
      const card=document.createElement('article'); card.className='eq-card';
      card.innerHTML=`
        <div class="eq-card__media"></div>
        <div class="eq-card__body">
          <div class="eq-title">
            <span>${eq.nombre}</span>
            <small class="eq-meta">#${eq.codigo}</small>
          </div>
          <div style="display:flex; gap:.5rem; align-items:center; justify-content:space-between;">
            <div class="eq-sem compact" data-sem data-equipo="${eq.codigo}" data-state="${eq.estado||'Restricciones'}"></div>
            <span class="badge-fiab fiab-${grade}" title="Fiabilidad estimada">${score.toFixed(0)}%</span>
            <div class="eq-qr" id="qr-${eq.codigo}" aria-label="QR ${eq.nombre}"></div>
          </div>
          <div style="display:flex; gap:.5rem;">
            <button class="btn-cdl" onclick="gotoEquipo('${eq.codigo}')">Abrir ficha</button>
            <button class="btn-cdl" style="background:#111" onclick="registrarEvento('${eq.codigo}')">Añadir evento</button>
          </div>
        </div>`;
      grid.appendChild(card);
      mountSemaforo(card.querySelector('[data-sem]'), {equipo:eq.codigo, estado:eq.estado});
      qrMake(document.getElementById(`qr-${eq.codigo}`), location.origin+location.pathname+'#/equipo/'+eq.codigo);
    });
  };

  // Inyectamos badge también en la FICHA (debajo del título)
  function injectBadge(){
    const h=location.hash||'';
    if(!h.startsWith('#/equipo/')) return;
    const code=decodeURIComponent(h.split('/')[2]||''); if(!code) return;
    try{
      const list=JSON.parse(localStorage.getItem('cdl-equipos')||'[]');
      const eq=list.find(e=>e.codigo===code); if(!eq) return;
      const {score,grade}= (function(){ // reuso rápido
        const horas={...(eq.horas||{m:0,r:0,p:0})};
        const total=horas.m+horas.r+horas.p||1;
        const dispo=(horas.m/total)*100; const reps=Math.max(0, eq.reparaciones||0);
        const s=Math.max(0, dispo - reps*2); let g='A'; if(s<90) g='B'; if(s<75) g='C'; if(s<60) g='D'; return {score:s, grade:g};
      })();
      let spot=document.getElementById('fiabBadge'); 
      if(!spot){ spot=document.createElement('div'); spot.id='fiabBadge'; document.getElementById('eqMeta')?.after(spot); }
      spot.innerHTML=`<span class="badge-fiab fiab-${grade}">Fiabilidad ${score.toFixed(0)}%</span>`;
    }catch{}
  }
  window.addEventListener('hashchange', injectBadge);
  window.addEventListener('load', injectBadge);
})();
</script>

<!-- =========================================================
BLOQUE 30 — Caché selectiva de fotos (si hay SW activo)
========================================================= -->
<script>
(function(){
  // Prefetch de fotos de equipos para modo offline/rápido.
  // Usa Cache Storage sólo si hay service worker controlando la página.
  async function prefetchEquipoFotos(urls){
    if(!('caches' in window) || !navigator.serviceWorker?.controller) return;
    try{
      const cache = await caches.open('cdl-fotos-v1');
      await cache.addAll(urls.filter(Boolean));
      console.log('[CDL] Fotos precargadas:', urls);
    }catch(e){ console.warn('[CDL] No se pudo cachear fotos', e); }
  }
  // Hook: cuando se renderiza la lista, intenta cachear miniaturas
  window.addEventListener('load', ()=>{
    try{
      const list = JSON.parse(localStorage.getItem('cdl-equipos')||'[]');
      // Si en el futuro guardas URL de foto en e.foto, las precargamos:
      const fotos = list.map(e=>e.foto).filter(Boolean);
      prefetchEquipoFotos(fotos);
    }catch{}
  });
  // Lazy loading para cualquier <img data-src="...">
  const IO = 'IntersectionObserver' in window ? new IntersectionObserver((es,ob)=>{
    es.forEach(e=>{
      if(e.isIntersecting){
        const img=e.target; const src=img.getAttribute('data-src'); if(src){ img.src=src; img.removeAttribute('data-src'); }
        ob.unobserve(img);
      }
    });
  },{rootMargin:'200px'}) : null;
  document.addEventListener('DOMContentLoaded', ()=>{
    document.querySelectorAll('img[data-src]').forEach(img=> IO?.observe(img));
  });
})();
</script>
<!-- =========================================================
BLOQUE 31 — Modal CRUD de Equipos (crear/editar/borrar)
Se integra con #/equipos: añade botón “Nuevo equipo” y edición en ficha.
========================================================= -->
<style>
  .cdl-modal{ position:fixed; inset:0; display:none; place-items:center; z-index:1300; }
  .cdl-modal[open]{ display:grid; }
  .cdl-modal__bk{ position:absolute; inset:0; background:rgba(0,0,0,.35); }
  .cdl-modal__card{ position:relative; width:min(720px,94vw); background:#fff; border-radius:16px; border:1px solid #e5e7eb; padding:14px; }
  .cdl-modal__head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
  .cdl-modal__grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .cdl-modal__grid label{ display:block; }
  .cdl-modal__actions{ display:flex; gap:.5rem; justify-content:flex-end; margin-top:10px; }
  .btn-ghost{ border:1px solid #e5e7eb; background:#fff; border-radius:10px; padding:.6rem .9rem; font-weight:800; }
  .fab-new{ position:fixed; right:14px; bottom:14px; z-index:1005; }
</style>

<button id="btnNewEq" class="btn-cdl fab-new" hidden>＋ Nuevo equipo</button>

<dialog id="eqModal" class="cdl-modal" aria-label="Editor de equipo">
  <div class="cdl-modal__bk" data-close></div>
  <div class="cdl-modal__card">
    <div class="cdl-modal__head">
      <h3 id="eqModalTitle">Nuevo equipo</h3>
      <button class="btn-ghost" data-close>✕</button>
    </div>
    <form id="eqForm" class="cdl-modal__grid">
      <label>Código <input name="codigo" required placeholder="EQ-000"></label>
      <label>Nombre <input name="nombre" required placeholder="Prensa 200T"></label>
      <label>Estado
        <select name="estado">
          <option>En marcha</option><option>Restricciones</option><option>Parada</option>
        </select>
      </label>
      <label>Foto (URL) <input name="foto" placeholder="https://.../foto.jpg"></label>
      <label style="grid-column:1/-1">Notas <textarea name="notas" rows="2" placeholder="Ubicación, serie, etc."></textarea></label>
      <input type="hidden" name="mode" value="new">
    </form>
    <div class="cdl-modal__actions">
      <button class="btn-ghost" data-close>Cancelar</button>
      <button id="eqDel" class="btn-ghost" style="display:none; color:#b91c1c; border-color:#fecaca;">Eliminar</button>
      <button id="eqSave" class="btn-cdl">Guardar</button>
    </div>
  </div>
</dialog>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const LS='cdl-equipos';
  const read=()=>{ try{ return JSON.parse(localStorage.getItem(LS))||[] }catch{ return [] } };
  const write=v=>localStorage.setItem(LS, JSON.stringify(v));
  const modal=$('#eqModal'), form=$('#eqForm'), delBtn=$('#eqDel'), saveBtn=$('#eqSave'), title=$('#eqModalTitle');

  function openModal(mode='new', data={}){
    form.reset();
    form.mode.value = mode;
    form.codigo.disabled = (mode==='edit'); // clave inmutable
    form.codigo.value = data.codigo||'';
    form.nombre.value = data.nombre||'';
    form.estado.value = data.estado||'En marcha';
    form.foto.value   = data.foto||'';
    form.notas.value  = data.notas||'';
    title.textContent = mode==='edit' ? `Editar equipo ${data.codigo}` : 'Nuevo equipo';
    delBtn.style.display = mode==='edit' ? '' : 'none';
    modal.setAttribute('open','');
    // accesibilidad
    setTimeout(()=>saveBtn.focus(), 50);
  }
  function closeModal(){ modal.removeAttribute('open'); }

  // Exponer para usar desde ficha/lista
  window.openEqEditor = (code=null)=>{
    const list=read();
    const item= list.find(e=>e.codigo===code);
    if(code && !item) return alert('Equipo no encontrado');
    openModal(item?'edit':'new', item||{});
  };

  // Botón FAB visible en lista
  function route(){
    const h=location.hash||'';
    const isList = h.startsWith('#/equipos') || h==='';
    const fab=$('#btnNewEq');
    fab.hidden = !isList || (localStorage.getItem('cdl-role')||'Mantenimiento')!=='Mantenimiento';
  }

  // Guardar
  saveBtn.addEventListener('click', ()=>{
    const fd=new FormData(form);
    const mode=fd.get('mode');
    const obj={
      codigo:String(fd.get('codigo')).trim(),
      nombre:String(fd.get('nombre')).trim(),
      estado:String(fd.get('estado')),
      foto:String(fd.get('foto')).trim(),
      notas:String(fd.get('notas')).trim(),
      reparaciones:0, repuestos:0, horas:{m:0,r:0,p:0}, ...(mode==='edit'?{}:{})
    };
    if(!obj.codigo || !obj.nombre) return alert('Código y nombre son obligatorios');
    const list=read();
    const i=list.findIndex(e=>e.codigo===obj.codigo);
    if(mode==='edit' && i>-1){
      // conservar métricas existentes
      const keep=list[i];
      list[i]={...keep, ...obj, horas:keep.horas||obj.horas, reparaciones:keep.reparaciones||0, repuestos:keep.repuestos||0};
    }else if(mode==='new'){
      if(i>-1) return alert('Ya existe un equipo con ese código');
      list.push(obj);
    }
    write(list);
    closeModal();
    // refrescar vista actual
    window.dispatchEvent(new HashChangeEvent('hashchange'));
  });

  // Eliminar
  delBtn.addEventListener('click', ()=>{
    const code=form.codigo.value;
    if(!confirm(`Eliminar equipo ${code} y su histórico?`)) return;
    const list=read().filter(e=>e.codigo!==code);
    localStorage.setItem('cdl-equipos', JSON.stringify(list));
    // borrar histórico
    Object.keys(localStorage).forEach(k=>{ if(k==='cdl-evt-'+code) localStorage.removeItem(k); });
    closeModal(); window.dispatchEvent(new HashChangeEvent('hashchange'));
  });

  // Cerrar
  modal.addEventListener('click', e=>{ if(e.target.matches('[data-close], .cdl-modal__bk')) closeModal(); });
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

  // FAB
  $('#btnNewEq')?.addEventListener('click', ()=>openModal('new'));

  // Añade botón “Editar” en la ficha si rol lo permite
  function injectEditBtn(){
    const h=location.hash||'';
    const can = (localStorage.getItem('cdl-role')||'Mantenimiento')==='Mantenimiento';
    if(!h.startsWith('#/equipo/') || !can) return;
    if(document.getElementById('btnEditEq')) return;
    const code=decodeURIComponent(h.split('/')[2]||'');
    const btn=document.createElement('button');
    btn.id='btnEditEq'; btn.className='btn-cdl'; btn.style.marginLeft='8px';
    btn.textContent='Editar equipo';
    btn.onclick=()=>openEqEditor(code);
    document.querySelector('#equipoView header')?.appendChild(btn);
  }

  window.addEventListener('hashchange', ()=>{ route(); injectEditBtn(); });
  window.addEventListener('load', ()=>{ route(); injectEditBtn(); });
})();
</script>

<!-- =========================================================
BLOQUE 32 — Ajustes (#/ajustes): Backup/Restore/Reset de datos
Exporta/Importa todas las claves localStorage que empiecen por “cdl-”
========================================================= -->
<section id="ajustesView" class="cdl-container" hidden>
  <h2>Ajustes</h2>
  <div class="eq-detail__right" style="margin-top:8px;">
    <h3>Datos</h3>
    <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
      <button id="bkExport" class="btn-cdl">Exportar backup (JSON)</button>
      <label class="btn-cdl" style="background:#111; cursor:pointer;">
        Importar backup
        <input id="bkImport" type="file" accept="application/json" style="display:none">
      </label>
      <button id="bkReset" class="btn-ghost" style="color:#b91c1c; border-color:#fecaca;">Reset (demo)</button>
    </div>
    <p style="color:#6b7280; margin-top:6px;">Incluye: equipos, eventos, incidencias, repuestos, catálogo, rol de usuario, etc.</p>
  </div>
</section>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const PREFIX='cdl-';
  function snapshot(){
    const dump={};
    for(const k of Object.keys(localStorage)){
      if(k.startsWith(PREFIX)) dump[k]=localStorage.getItem(k);
    }
    dump.__meta = {ts:Date.now(), app:'CDL-Mant', version:1};
    return dump;
  }
  function restore(dump){
    for(const k in dump){ if(k.startsWith(PREFIX)) localStorage.setItem(k, dump[k]); }
  }
  function route(){
    const v=$('#ajustesView'); if(!v) return;
    v.hidden = !(location.hash||'').startsWith('#/ajustes');
  }
  function download(name, content, mime='application/json'){
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([content],{type:mime}));
    a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 400);
  }
  window.addEventListener('hashchange', route);
  window.addEventListener('load', ()=>{
    route();
    $('#bkExport')?.addEventListener('click', ()=>{
      const data = snapshot();
      download('CDL_backup.json', JSON.stringify(data,null,2));
    });
    $('#bkImport')?.addEventListener('change', async (e)=>{
      const file=e.target.files?.[0]; if(!file) return;
      try{
        const txt = await file.text();
        const dump = JSON.parse(txt);
        restore(dump);
        alert('Backup importado. Recargando…'); location.reload();
      }catch(err){ alert('Archivo inválido'); }
    });
    $('#bkReset')?.addEventListener('click', ()=>{
      if(!confirm('¿Restaurar datos de demostración?')) return;
      // Limpia sólo claves cdl-
      Object.keys(localStorage).forEach(k=>{ if(k.startsWith(PREFIX)) localStorage.removeItem(k); });
      location.reload();
    });
  });
})();
</script>

<!-- =========================================================
BLOQUE 33 — KPIs globales (#/kpi) con “mini-gráficas” CSS
========================================================= -->
<section id="kpiView" class="cdl-container" hidden>
  <h2>KPIs globales</h2>
  <div id="kpiCards" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px; margin:8px 0;"></div>
  <div class="eq-table" style="margin-top:8px;">
    <div style="padding:8px; font-weight:800;">Top paros</div>
    <div id="kpiParos"></div>
  </div>
</section>

<style>
  .mini-bar{ height:10px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
  .mini-bar > i{ display:block; height:100%; background:var(--cdl-red); width:0%; }
</style>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const LS=(k,d=[])=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d } };

  function gather(){
    const eqs=LS('cdl-equipos',[]);
    let m=0,r=0,p=0, reps=0, coste=0;
    eqs.forEach(e=>{
      const hh=e.horas||{m:0,r:0,p:0}; m+=hh.m||0; r+=hh.r||0; p+=hh.p||0;
      reps += e.reparaciones||0; coste += e.repuestos||0;
      const ev=LS('cdl-evt-'+e.codigo,[]);
      ev.forEach(x=>{
        if(x.tipo==='Marcha') m+=Number(x.horas||0);
        if(x.tipo==='Restricción') r+=Number(x.horas||0);
        if(x.tipo==='Paro') p+=Number(x.horas||0);
        if(x.tipo==='Reparación') reps += 1;
        if(Number(x.coste)) coste += Number(x.coste);
      });
    });
    const total=m+r+p||1; const dispo=(m/total)*100;
    return {equipos:eqs.length, horas:{m,r,p}, dispo, reparaciones:reps, coste};
  }

  function renderBars(){
    const {equipos, horas, dispo, reparaciones, coste}=gather();
    const cards=$('#kpiCards'); if(!cards) return;
    cards.innerHTML = `
      <div class="kpi"><b>${equipos}</b><span>Equipos</span></div>
      <div class="kpi"><b>${dispo.toFixed(1)}%</b><span>Disponibilidad</span><div class="mini-bar"><i style="width:${dispo.toFixed(1)}%"></i></div></div>
      <div class="kpi"><b>${(horas.m||0)}h</b><span>Horas marcha</span></div>
      <div class="kpi"><b>${(horas.r||0)}h</b><span>Horas restricción</span></div>
      <div class="kpi"><b>${(horas.p||0)}h</b><span>Horas paro</span></div>
      <div class="kpi"><b>${reparaciones}</b><span>Reparaciones</span></div>
      <div class="kpi"><b>€ ${(coste||0).toFixed(2)}</b><span>Coste repuestos</span></div>
    `;
  }

  function renderTopParos(){
    const eqs=LS('cdl-equipos',[]);
    const rows=eqs.map(e=>{
      const ev=LS('cdl-evt-'+e.codigo,[]);
      const hp=(e.horas?.p||0) + ev.filter(x=>x.tipo==='Paro').reduce((a,b)=>a+Number(b.horas||0),0);
      return {codigo:e.codigo, nombre:e.nombre, hp};
    }).sort((a,b)=>b.hp-a.hp).slice(0,8);

    const wrap=$('#kpiParos'); if(!wrap) return;
    const tbl=document.createElement('table');
    tbl.innerHTML=`<thead><tr><th>Equipo</th><th>Horas paro</th><th></th></tr></thead>
      <tbody>${
        rows.map(r=>`<tr>
          <td>${r.nombre} <small class="eq-meta">#${r.codigo}</small></td>
          <td>${r.hp}</td>
          <td style="width:40%">
            <div class="mini-bar"><i style="width:${Math.min(100,r.hp)}%"></i></div>
          </td>
        </tr>`).join('')||'<tr><td colspan="3" style="color:#6b7280">Sin datos.</td></tr>'
      }</tbody>`;
    wrap.innerHTML=''; wrap.appendChild(tbl);
  }

  function route(){
    const v=$('#kpiView'); if(!v) return;
    const on=(location.hash||'').startsWith('#/kpi');
    v.hidden=!on; if(on){ renderBars(); renderTopParos(); }
  }
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
})();
</script>

<!-- =========================================================
BLOQUE 34 — Roles y permisos (Mantenimiento / Producción / Invitado)
Controla visibilidad de acciones sensibles y selector en panel usuario
========================================================= -->
<style>
  .user-panel{
    position:absolute; right:0; top:calc(100% + 6px); background:#fff; border:1px solid #e5e7eb;
    border-radius:12px; padding:10px; z-index:1050; width:220px; box-shadow:0 10px 28px rgba(0,0,0,.08);
    display:none;
  }
  .user-panel[open]{ display:block; }
  .user-panel label{ display:block; font-weight:800; margin-bottom:6px; }
  .user-panel select{ width:100%; border:1px solid #e5e7eb; border-radius:10px; padding:.5rem .6rem; }
  .user-panel small{ display:block; color:#6b7280; margin-top:6px; }
</style>

<div id="userPanel" class="user-panel" role="dialog" aria-label="Panel de usuario">
  <label>Rol</label>
  <select id="roleSelect">
    <option value="Mantenimiento">Mantenimiento</option>
    <option value="Producción">Producción</option>
    <option value="Invitado">Invitado</option>
  </select>
  <small>El rol limita acciones: crear/editar equipos, añadir eventos, consumir repuestos.</small>
</div>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const roleKey='cdl-role';
  function getRole(){ return localStorage.getItem(roleKey) || 'Mantenimiento'; }
  function setRole(r){ localStorage.setItem(roleKey, r); $('#userRole').textContent=r; applyACL(); }

  // Mostrar/ocultar panel
  const btn=$('#userBtn'), panel=$('#userPanel');
  btn?.addEventListener('click', ()=>{
    const open = panel.hasAttribute('open');
    document.querySelector('.cdl-header__inner')?.appendChild(panel);
    panel.toggleAttribute('open', !open);
  });
  window.addEventListener('click', e=>{ if(panel.hasAttribute('open') && !panel.contains(e.target) && e.target!==btn) panel.removeAttribute('open'); });

  // Cambio de rol
  $('#roleSelect')?.addEventListener('change', e=> setRole(e.target.value));

  // ACL: aplica restricciones visuales según rol
  function applyACL(){
    const r=getRole();
    // Acciones deshabilitadas para Producción/Invitado:
    const canWrite = (r==='Mantenimiento');
    // “Nuevo equipo” FAB
    const fab=$('#btnNewEq'); if(fab) fab.hidden = !canWrite || !(location.hash||'').startsWith('#/equipos');
    // Botón “Añadir evento”
    document.querySelectorAll('button').forEach(b=>{
      if(/Añadir evento|Guardar evento|Guardar pieza|Registrar consumo|Editar equipo|Eliminar|Guardar/.test(b.textContent||'')){
        b.disabled = !canWrite;
        b.style.opacity = canWrite ? '1' : '.6';
        b.title = canWrite ? '' : 'Solo Mantenimiento';
      }
    });
    // Formularios de repuestos
    ['repCatForm','repMovForm','evtForm'].forEach(id=>{
      const el=document.getElementById(id); if(el){ Array.from(el.elements).forEach(i=>i.disabled=!canWrite); }
    });
  }

  window.addEventListener('load', ()=>{
    const r=getRole();
    $('#roleSelect').value=r;
    $('#userRole').textContent=r;
    applyACL();
  });
  window.addEventListener('hashchange', applyACL);
})();
</script>
<!-- =========================================================
BLOQUE 36 — Incidencias (#/incidencias) con filtros (estado, fecha, texto)
Datos en localStorage: cdl-inc  [{id,fecha,estado,eq,codEq,titulo,detalle,adjuntos?[], coste?}]
========================================================= -->
<section id="incView" class="cdl-container" hidden>
  <h2>Incidencias</h2>

  <div class="eq-detail__right" style="margin-top:8px;">
    <div style="display:grid; grid-template-columns: repeat(6,1fr); gap:8px;">
      <select id="fIncEstado">
        <option value="">Todos los estados</option>
        <option>Abierta</option><option>En curso</option><option>Cerrada</option>
      </select>
      <input type="date" id="fIncD1">
      <input type="date" id="fIncD2">
      <input type="search" id="fIncQ" placeholder="Buscar…">
      <button id="btnIncFiltrar" class="btn-cdl">Filtrar</button>
      <button id="btnIncNueva" class="btn-cdl" style="background:#111;">Nueva incidencia</button>
    </div>
  </div>

  <div class="eq-table" style="margin-top:10px;">
    <div style="padding:8px; display:flex; justify-content:space-between; align-items:center;">
      <b>Listado</b>
      <div>
        <button id="btnIncCSV" class="btn-cdl">Exportar Excel</button>
      </div>
    </div>
    <div id="incTable"></div>
  </div>
</section>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const LS=(k,d=null)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v): (d??null) }catch{ return d??null } };
  const WR=(k,v)=>localStorage.setItem(k, JSON.stringify(v));

  function lsInc(){ return LS('cdl-inc', []); }
  function addInc(obj){
    const inc=lsInc(); inc.unshift(obj); WR('cdl-inc', inc);
  }
  function render(estado='', d1='', d2='', q=''){
    const wrap=$('#incTable'); if(!wrap) return;
    let rows=lsInc();
    if(estado) rows = rows.filter(r=> r.estado===estado);
    if(d1) rows = rows.filter(r=> new Date(r.fecha).toISOString().slice(0,10) >= d1);
    if(d2) rows = rows.filter(r=> new Date(r.fecha).toISOString().slice(0,10) <= d2);
    if(q){ const qq=q.toLowerCase(); rows = rows.filter(r=> (r.titulo||'').toLowerCase().includes(qq) || (r.detalle||'').toLowerCase().includes(qq) || String(r.codEq||'').includes(qq)); }

    const tbl=document.createElement('table');
    tbl.innerHTML=`<thead><tr>
      <th>Fecha</th><th>Estado</th><th>Equipo</th><th>Título</th><th>Coste €</th><th>Adj.</th><th></th>
    </tr></thead>
    <tbody>${
      rows.map(r=>`<tr>
        <td>${new Date(r.fecha).toLocaleString()}</td>
        <td>${r.estado}</td>
        <td>${r.eq||''} <small class="eq-meta">#${r.codEq||''}</small></td>
        <td>${(r.titulo||'').replace(/</g,'&lt;')}</td>
        <td>${r.coste? Number(r.coste).toFixed(2): ''}</td>
        <td>${(r.adjuntos?.length||0)||''}</td>
        <td><button class="btn-cdl" style="padding:.35rem .7rem;" data-open="${r.id}">Abrir</button></td>
      </tr>`).join('') || '<tr><td colspan="7" style="color:#6b7280">Sin incidencias.</td></tr>'
    }</tbody>`;
    wrap.innerHTML=''; wrap.appendChild(tbl);

    // Abrir desde listado
    wrap.querySelectorAll('[data-open]')?.forEach(b=>{
      b.addEventListener('click', ()=>{
        const one = lsInc().find(x=>x.id===b.getAttribute('data-open'));
        if(!one) return;
        openIncModal('edit', one);
      });
    });
  }

  // Modal reutiliza estilos del BLOQUE 31
  const modalHtml=`
  <dialog id="incModal" class="cdl-modal" aria-label="Incidencia">
    <div class="cdl-modal__bk" data-close></div>
    <div class="cdl-modal__card">
      <div class="cdl-modal__head">
        <h3 id="incTitle">Nueva incidencia</h3>
        <button class="btn-ghost" data-close>✕</button>
      </div>
      <form id="incForm" class="cdl-modal__grid">
        <label>Fecha <input type="datetime-local" name="fecha" required></label>
        <label>Estado
          <select name="estado"><option>Abierta</option><option>En curso</option><option>Cerrada</option></select>
        </label>
        <label>Equipo <input name="eq" placeholder="Nombre equipo"></label>
        <label>Código eq. <input name="codEq" placeholder="EQ-001"></label>
        <label style="grid-column:1/-1">Título <input name="titulo" required></label>
        <label style="grid-column:1/-1">Detalle <textarea name="detalle" rows="3"></textarea></label>
        <label>Coste (€) <input type="number" step="0.01" min="0" name="coste"></label>
        <label>Adjuntos <input id="incFiles" type="file" multiple></label>
        <input type="hidden" name="mode" value="new">
        <input type="hidden" name="id" value="">
      </form>
      <div class="cdl-modal__actions">
        <button class="btn-ghost" data-close>Cancelar</button>
        <button id="incDel" class="btn-ghost" style="display:none; color:#b91c1c; border-color:#fecaca;">Eliminar</button>
        <button id="incSave" class="btn-cdl">Guardar</button>
      </div>
    </div>
  </dialog>`;
  document.body.insertAdjacentHTML('beforeend', modalHtml);

  const incModal = document.getElementById('incModal');
  const incForm  = document.getElementById('incForm');
  const incDel   = document.getElementById('incDel');
  const incSave  = document.getElementById('incSave');
  const incFiles = document.getElementById('incFiles');

  function openIncModal(mode='new', data={}){
    incForm.reset();
    incForm.mode.value = mode;
    incForm.id.value   = data.id||'';
    incForm.fecha.value= data.fecha ? new Date(data.fecha).toISOString().slice(0,16) : new Date().toISOString().slice(0,16);
    incForm.estado.value= data.estado||'Abierta';
    incForm.eq.value    = data.eq||'';
    incForm.codEq.value = data.codEq||'';
    incForm.titulo.value= data.titulo||'';
    incForm.detalle.value= data.detalle||'';
    incForm.coste.value = data.coste||'';
    incDel.style.display = mode==='edit'? '': 'none';
    document.getElementById('incTitle').textContent = mode==='edit' ? 'Editar incidencia' : 'Nueva incidencia';
    incModal.setAttribute('open','');
  }
  function closeInc(){ incModal.removeAttribute('open'); }

  // Guardar (convierte adjuntos a base64)
  async function filesToBase64List(files){
    const out=[];
    for(const f of files){
      const b = await f.arrayBuffer();
      const base64 = btoa(String.fromCharCode(...new Uint8Array(b)));
      out.push({name:f.name, type:f.type, size:f.size, data:`data:${f.type};base64,${base64}`});
    }
    return out;
  }

  incSave.addEventListener('click', async ()=>{
    const fd=new FormData(incForm);
    const mode=fd.get('mode');
    const id  = fd.get('id') || ('INC-'+Date.now());
    const adj = await filesToBase64List(incFiles.files||[]);
    const obj = {
      id, fecha:new Date(fd.get('fecha')).toISOString(), estado:fd.get('estado'),
      eq:fd.get('eq'), codEq:fd.get('codEq'), titulo:fd.get('titulo'), detalle:fd.get('detalle'),
      coste:Number(fd.get('coste')||0), adjuntos:adj
    };
    let arr=lsInc();
    if(mode==='edit'){
      const i=arr.findIndex(x=>x.id===id); if(i>-1) arr[i]={...arr[i], ...obj, adjuntos:[...(arr[i].adjuntos||[]), ...adj]};
    }else{
      arr.unshift(obj);
    }
    WR('cdl-inc', arr);
    closeInc(); render($('#fIncEstado').value, $('#fIncD1').value, $('#fIncD2').value, $('#fIncQ').value);
  });

  incDel.addEventListener('click', ()=>{
    const id=incForm.id.value; if(!id) return;
    if(!confirm('¿Eliminar incidencia?')) return;
    WR('cdl-inc', lsInc().filter(x=>x.id!==id));
    closeInc(); render($('#fIncEstado').value, $('#fIncD1').value, $('#fIncD2').value, $('#fIncQ').value);
  });

  incModal.addEventListener('click', e=>{ if(e.target.matches('[data-close], .cdl-modal__bk')) closeInc(); });
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeInc(); });

  // Exportación a “Excel” (XLS: HTML table)
  function exportInc(){
    const rows=lsInc();
    const html = `
      <table>
        <tr><th>Fecha</th><th>Estado</th><th>Equipo</th><th>Código</th><th>Título</th><th>Detalle</th><th>Coste</th><th>Adjuntos</th></tr>
        ${rows.map(r=>`<tr>
          <td>${new Date(r.fecha).toLocaleString()}</td>
          <td>${r.estado}</td>
          <td>${r.eq||''}</td>
          <td>${r.codEq||''}</td>
          <td>${(r.titulo||'').replace(/</g,'&lt;')}</td>
          <td>${(r.detalle||'').replace(/</g,'&lt;')}</td>
          <td>${Number(r.coste||0).toFixed(2)}</td>
          <td>${(r.adjuntos||[]).map(a=>a.name).join(', ')}</td>
        </tr>`).join('')}
      </table>`;
    const blob = new Blob([`\ufeff<html><meta charset="utf-8">${html}</html>`], {type:'application/vnd.ms-excel'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='Incidencias_CDL.xls'; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),400);
  }

  // Routing + UI
  function route(){
    const on = (location.hash||'').startsWith('#/incidencias');
    $('#incView').hidden = !on;
    if(on) render($('#fIncEstado').value, $('#fIncD1').value, $('#fIncD2').value, $('#fIncQ').value);
  }
  window.addEventListener('hashchange', route);
  window.addEventListener('load', ()=>{
    route();
    $('#btnIncFiltrar')?.addEventListener('click', ()=> render($('#fIncEstado').value, $('#fIncD1').value, $('#fIncD2').value, $('#fIncQ').value));
    $('#btnIncNueva')?.addEventListener('click', ()=> openIncModal('new', {}));
    $('#btnIncCSV')?.addEventListener('click', exportInc);
  });

  // Enlace rápido desde ficha de equipo: crea incidencia con equipo pre-rellenado
  window.nuevaIncidenciaPara = function(codigo, nombre){
    openIncModal('new', {codEq:codigo, eq:nombre});
  };
})();
</script>

<!-- =========================================================
BLOQUE 37 — Adjuntos base64 en EVENTOS de la ficha (inyecta input + vista)
Guarda en cdl-evt-<EQ> los campos: {tipo, horas, coste, detalle, ts, files?[]}
========================================================= -->
<script>
(function(){
  const $=s=>document.querySelector(s);
  // Inyectar campo “Adjuntos” en el formulario de eventos si no existe
  window.addEventListener('load', ()=>{
    const form=$('#evtForm'); if(!form || form.querySelector('#evtFiles')) return;
    const wrap=document.createElement('label'); wrap.innerHTML='Adjuntos <input id="evtFiles" type="file" multiple>';
    form.insertBefore(wrap, form.querySelector('button[type="submit"]'));
  });

  // Monkey-patch de pushEvt para soportar files base64 y refresco de tabla con iconos de descarga
  const _loadEvt = (c)=>{ try{ return JSON.parse(localStorage.getItem('cdl-evt-'+c))||[] }catch{ return [] } };
  const _saveEvt = (c, arr)=>localStorage.setItem('cdl-evt-'+c, JSON.stringify(arr));

  async function filesToBase64(files){
    const out=[]; for(const f of files){
      const b=await f.arrayBuffer();
      const base64 = btoa(String.fromCharCode(...new Uint8Array(b)));
      out.push({name:f.name, type:f.type, size:f.size, data:`data:${f.type};base64,${base64}`});
    } return out;
  }

  // Reemplaza handler del form de eventos para capturar adjuntos
  window.addEventListener('load', ()=>{
    const form=$('#evtForm'); if(!form) return;
    const orig = form.onsubmit;
    form.onsubmit = async (ev)=>{
      ev.preventDefault();
      const fd=new FormData(form);
      const filesInput = document.getElementById('evtFiles');
      const files = filesInput?.files?.length ? await filesToBase64(filesInput.files) : [];
      // Detectar equipo actual por URL
      const code = (location.hash.split('/')[2]||'').split('?')[0];
      const arr = _loadEvt(code);
      arr.unshift({
        tipo:fd.get('tipo'), horas:Number(fd.get('horas')||0), coste:Number(fd.get('coste')||0),
        detalle:String(fd.get('detalle')||''), ts:Date.now(), files
      });
      _saveEvt(code, arr);
      form.reset();
      // Refrescar la vista de ficha reutilizando showEquipo si existe
      if(typeof window.showEquipo==='function') window.showEquipo(code);
      else window.dispatchEvent(new HashChangeEvent('hashchange'));
    };
  });

  // Extiende tabla de histórico para mostrar clip si hay archivos (hook tras render)
  const observer=new MutationObserver(()=>{
    const tbl=document.querySelector('#eqTable table tbody'); if(!tbl) return;
    Array.from(tbl.rows).forEach((tr,i)=>{
      // Busca evento correspondiente y si tiene files añadir icono con descarga
      const code = (location.hash.split('/')[2]||'').split('?')[0];
      const evts=_loadEvt(code);
      const e = evts[i]; if(!e||!e.files||!e.files.length) return;
      const td = tr.cells[4]; // detalle
      const a=document.createElement('a'); a.textContent=' 📎'; a.href=e.files[0].data; a.download=e.files[0].name; a.title=`${e.files.length} adjunto(s)`;
      td && td.appendChild(a);
    });
  });
  window.addEventListener('load', ()=> observer.observe(document.getElementById('eqTable'), {childList:true, subtree:true}));
})();
</script>

<!-- =========================================================
BLOQUE 38 — Multi-PLANTAS y ÁREAS (contexto global)
Selector en cabecera; filtra Equipos e Incidencias por contexto
========================================================= -->
<style>
  .ctx-wrap{ display:flex; gap:.5rem; align-items:center; }
  .ctx-chip{ border:1px solid #e5e7eb; border-radius:999px; background:#fff; padding:.35rem .6rem; font-weight:800; }
</style>
<script>
(function(){
  const $=s=>document.querySelector(s);
  const CKEY='cdl-ctx'; // {planta:'', area:''}
  const PLANTAS=['Planta Norte','Planta Sur','Centro'];
  const AREAS=['Corte','Prensas','Soldadura','Logística'];

  function getCtx(){ try{ return JSON.parse(localStorage.getItem(CKEY)) || {planta:'', area:''} }catch{ return {planta:'', area:''} } }
  function setCtx(v){ localStorage.setItem(CKEY, JSON.stringify(v)); applyCtxUI(); rerenderByRoute(); }

  // UI en cabecera (bajo el logo)
  function ensureUI(){
    const inner=document.querySelector('.cdl-header__inner'); if(!inner) return;
    if(document.getElementById('ctxPlanta')) return;
    const wrap=document.createElement('div'); wrap.className='ctx-wrap';
    wrap.style.marginLeft='8px';

    const sPl=document.createElement('select'); sPl.id='ctxPlanta';
    sPl.innerHTML='<option value="">Todas las plantas</option>'+PLANTAS.map(p=>`<option>${p}</option>`).join('');
    const sAr=document.createElement('select'); sAr.id='ctxArea';
    sAr.innerHTML='<option value="">Todas las áreas</option>'+AREAS.map(a=>`<option>${a}</option>`).join('');

    wrap.appendChild(sPl); wrap.appendChild(sAr);
    inner.insertBefore(wrap, inner.querySelector('.cdl-user'));

    sPl.addEventListener('change', ()=> setCtx({...getCtx(), planta:sPl.value}));
    sAr.addEventListener('change', ()=> setCtx({...getCtx(), area:sAr.value}));
  }
  function applyCtxUI(){
    const ctx=getCtx();
    const sPl=$('#ctxPlanta'), sAr=$('#ctxArea');
    if(sPl) sPl.value = ctx.planta||'';
    if(sAr) sAr.value = ctx.area||'';
    // Mostrar chips en la hero (opcional)
    const main=document.querySelector('.cdl-hero');
    if(main && !main.querySelector('.ctx-chip')){
      const c=document.createElement('div'); c.style.marginTop='6px';
      c.innerHTML=`<span class="ctx-chip" id="chipPl"></span> <span class="ctx-chip" id="chipAr"></span>`;
      main.appendChild(c);
    }
    const cp=document.getElementById('chipPl'), ca=document.getElementById('chipAr');
    if(cp) cp.textContent = ctx.planta || 'Todas las plantas';
    if(ca) ca.textContent = ctx.area   || 'Todas las áreas';
  }

  // Hook a renderer de equipos (filtro por ctx)
  const _renderEquipos = window.renderEquipos;
  window.renderEquipos = function(list, query){
    const ctx=getCtx();
    // Extiende modelo: e.planta, e.area (si faltan, no filtra)
    const filtered = list.filter(e=>{
      const okP = ctx.planta? (e.planta===ctx.planta):true;
      const okA = ctx.area? (e.area===ctx.area):true;
      return okP && okA;
    });
    _renderEquipos.call(null, filtered, query);
  };

  // Filtro en incidencias
  function filterIncByCtx(rows){
    const ctx=getCtx();
    return rows.filter(r=>{
      // Empareja por nombre de equipo o código (busca equipo en cdl-equipos)
      try{
        const eqs=JSON.parse(localStorage.getItem('cdl-equipos'))||[];
        const found=eqs.find(e=> e.codigo===r.codEq || e.nombre===r.eq);
        const okP = ctx.planta? (found?.planta===ctx.planta):true;
        const okA = ctx.area? (found?.area===ctx.area):true;
        return okP && okA;
      }catch{ return true; }
    });
  }

  // Parchea render() de incidencias (B36)
  const incTableDiv = ()=>document.getElementById('incTable');
  const mo=new MutationObserver(()=>{
    // no-op; placeholder para futuras extensiones
  });

  // Rerender según ruta
  function rerenderByRoute(){ window.dispatchEvent(new HashChangeEvent('hashchange')); }

  window.addEventListener('load', ()=>{ ensureUI(); applyCtxUI(); mo.observe(document.body,{childList:true,subtree:true}); });
})();
</script>

<!-- =========================================================
BLOQUE 39 — Exportación Excel-lite (equipos, eventos por equipo, incidencias)
Botones rápidos añadidos en vistas
========================================================= -->
<script>
(function(){
  function dlXls(filename, html){
    const blob=new Blob([`\ufeff<html><meta charset="utf-8">${html}</html>`],{type:'application/vnd.ms-excel'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),400);
  }

  // Exportar EQUIPOS (lista)
  window.exportEquiposXLS = function(){
    const eqs = JSON.parse(localStorage.getItem('cdl-equipos')||'[]');
    const html = `<table>
      <tr><th>Código</th><th>Nombre</th><th>Estado</th><th>Planta</th><th>Área</th><th>Reparaciones</th><th>Repuestos €</th></tr>
      ${eqs.map(e=>`<tr><td>${e.codigo}</td><td>${e.nombre}</td><td>${e.estado}</td><td>${e.planta||''}</td><td>${e.area||''}</td><td>${e.reparaciones||0}</td><td>${Number(e.repuestos||0).toFixed(2)}</td></tr>`).join('')}
    </table>`;
    dlXls('Equipos_CDL.xls', html);
  };

  // Exportar EVENTOS del equipo actual
  window.exportEventosEquipoXLS = function(){
    const code = (location.hash.split('/')[2]||'').split('?')[0];
    const ev = JSON.parse(localStorage.getItem('cdl-evt-'+code)||'[]');
    const html = `<table>
      <tr><th>Fecha</th><th>Tipo</th><th>Horas</th><th>Coste</th><th>Detalle</th><th>Adjuntos</th></tr>
      ${ev.map(x=>`<tr><td>${new Date(x.ts).toLocaleString()}</td><td>${x.tipo}</td><td>${x.horas||''}</td><td>${Number(x.coste||0).toFixed(2)}</td><td>${(x.detalle||'').replace(/</g,'&lt;')}</td><td>${(x.files||[]).map(f=>f.name).join(', ')}</td></tr>`).join('')}
    </table>`;
    dlXls(`Eventos_${code}.xls`, html);
  };

  // Inyecta botones en UI (lista y ficha)
  window.addEventListener('load', ()=>{
    // Lista Equipos: botón exportar (en título)
    const v=document.getElementById('equiposView');
    if(v && !document.getElementById('btnEqXLS')){
      const b=document.createElement('button'); b.id='btnEqXLS'; b.className='btn-cdl'; b.style.margin='6px 0';
      b.textContent='Exportar equipos (Excel)'; b.onclick=exportEquiposXLS;
      v.insertBefore(b, v.querySelector('#equiposGrid'));
    }
    // Ficha: botón exportar eventos
    const hdr=document.querySelector('#equipoView header');
    if(hdr && !document.getElementById('btnEvtXLS')){
      const b=document.createElement('button'); b.id='btnEvtXLS'; b.className='btn-cdl'; b.style.marginLeft='8px';
      b.textContent='Exportar eventos (Excel)'; b.onclick=exportEventosEquipoXLS;
      hdr.appendChild(b);
    }
  });
})();
</script>

<!-- =========================================================
BLOQUE 40 — Módulo de USUARIOS y TURNOS (selector en panel de usuario)
Afecta a permisos (ya gestionados) y muestra turno activo
========================================================= -->
<style>
  .turno-badge{ margin-left:6px; border:1px solid #e5e7eb; border-radius:999px; padding:.2rem .55rem; font-weight:800; color:#111; }
</style>
<script>
(function(){
  const $=s=>document.querySelector(s);
  const TKEY='cdl-shift'; // {turno:'Mañana', usuario:'', email:''}
  const TURNOS=['Mañana','Tarde','Noche'];

  function getT(){ try{ return JSON.parse(localStorage.getItem(TKEY)) || {turno:'Mañana', usuario:'', email:''} }catch{ return {turno:'Mañana', usuario:'', email:''} } }
  function setT(v){ localStorage.setItem(TKEY, JSON.stringify(v)); applyUI(); }

  // Extiende el panel de usuario del BLOQUE 34
  function enhancePanel(){
    const panel=$('#userPanel'); if(!panel || panel.querySelector('#shiftSelect')) return;
    const lb=document.createElement('label'); lb.textContent='Turno';
    const sel=document.createElement('select'); sel.id='shiftSelect';
    sel.innerHTML = TURNOS.map(t=>`<option>${t}</option>`).join('');
    const lb2=document.createElement('label'); lb2.textContent='Usuario';
    const inU=document.createElement('input'); inU.id='userName'; inU.placeholder='Nombre y apellidos';
    const lb3=document.createElement('label'); lb3.textContent='Email';
    const inE=document.createElement('input'); inE.id='userEmail'; inE.placeholder='usuario@cdl.es';
    [lb,sel,lb2,inU,lb3,inE].forEach(n=> panel.appendChild(n));

    sel.addEventListener('change', ()=> setT({...getT(), turno:sel.value}));
    inU.addEventListener('change', ()=> setT({...getT(), usuario:inU.value}));
    inE.addEventListener('change', ()=> setT({...getT(), email:inE.value}));
  }

  // Muestra turno actual junto al rol en la cabecera
  function applyUI(){
    const t=getT();
    // Rellenar panel
    const sel=$('#shiftSelect'), u=$('#userName'), e=$('#userEmail');
    if(sel) sel.value=t.turno;
    if(u) u.value=t.usuario||'';
    if(e) e.value=t.email||'';
    // Badge en cabecera
    let badge=document.getElementById('turnoBadge');
    if(!badge){
      badge=document.createElement('span'); badge.id='turnoBadge'; badge.className='turno-badge';
      document.getElementById('userRole')?.after(badge);
    }
    badge.textContent = t.turno;
  }

  // Inicializa
  window.addEventListener('load', ()=>{ enhancePanel(); applyUI(); });
})();
</script>
<!-- =========================================================
BLOQUE 41 — REPUESTOS: maestro + movimientos + stock
LocalStorage:
  cdl-rep = [{cod,nombre,ubicacion,min,stock=0}]
  cdl-rep-mov-<cod> = [{ts,tipo:'IN'|'OUT',cant,nota}]
========================================================= -->
<section id="repuestosView" class="cdl-container" hidden>
  <h2>Repuestos</h2>
  <div class="eq-detail__right" style="margin-top:8px;">
    <div style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr 1fr auto; gap:8px;">
      <input id="repQ" placeholder="Buscar por código o nombre">
      <input id="repCod" placeholder="Código">
      <input id="repNom" placeholder="Nombre">
      <input id="repUbi" placeholder="Ubicación">
      <input id="repMin" type="number" min="0" placeholder="Stock mínimo">
      <button id="repAdd" class="btn-cdl">Añadir</button>
    </div>
  </div>

  <div class="eq-table" style="margin-top:10px;">
    <div style="padding:8px; display:flex; gap:8px; align-items:center;">
      <b>Inventario</b>
      <button id="repXLS" class="btn-cdl">Exportar Excel</button>
      <button id="repPrint" class="btn-cdl" style="background:#111;">Imprimir</button>
    </div>
    <div id="repTable"></div>
  </div>
</section>

<style>
  .rep-badge-min{ background:#fee2e2; color:#b91c1c; border-radius:999px; padding:.1rem .45rem; font-weight:800; }
  .rep-mov{ display:flex; gap:6px; }
  .rep-mov input{ width:90px; }
</style>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const LS=(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch{return d}};
  const WR=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
  const KEY='cdl-rep';

  function list(){ return LS(KEY, []); }
  function save(arr){ WR(KEY, arr); }
  function stockOf(r){ return Number(r.stock||0); }
  function movKey(c){ return 'cdl-rep-mov-'+c; }
  function movs(c){ return LS(movKey(c),[]); }
  function pushMov(c, m){ const a=movs(c); a.unshift(m); WR(movKey(c), a); }

  function render(){
    const q=($('#repQ')?.value||'').toLowerCase();
    let rows=list().filter(r=> !q || r.cod.toLowerCase().includes(q) || (r.nombre||'').toLowerCase().includes(q));
    const tbl=document.createElement('table');
    tbl.innerHTML=`<thead><tr>
      <th>QR</th><th>Código</th><th>Nombre</th><th>Ubicación</th><th>Stock</th><th>Mín.</th><th>Mov.</th><th></th>
    </tr></thead><tbody>${
      rows.map(r=>{
        const low = stockOf(r) < Number(r.min||0);
        return `<tr>
          <td><div id="qr-rep-${r.cod}" class="eq-qr" style="width:44px;height:44px;"></div></td>
          <td><b>${r.cod}</b></td>
          <td>${(r.nombre||'').replace(/</g,'&lt;')}</td>
          <td>${(r.ubicacion||'').replace(/</g,'&lt;')}</td>
          <td>${stockOf(r)} ${low?'<span class="rep-badge-min">bajo</span>':''}</td>
          <td>${r.min||0}</td>
          <td>
            <div class="rep-mov">
              <input type="number" min="1" placeholder="cant" id="qty-${r.cod}">
              <button class="btn-cdl" data-in="${r.cod}" style="padding:.3rem .6rem;">+ IN</button>
              <button class="btn-cdl" data-out="${r.cod}" style="padding:.3rem .6rem;background:#111;">- OUT</button>
            </div>
          </td>
          <td><button class="btn-cdl" data-open="${r.cod}" style="padding:.3rem .6rem;">Hist.</button></td>
        </tr>`;
      }).join('') || '<tr><td colspan="8" style="color:#6b7280">Sin repuestos.</td></tr>'
    }</tbody>`;
    const wrap=$('#repTable'); wrap.innerHTML=''; wrap.appendChild(tbl);

    // QR por repuesto
    rows.forEach(r=> qrMake($('#qr-rep-'+r.cod), location.origin+location.pathname+'#/rep/'+encodeURIComponent(r.cod), 44));

    // Movimientos
    wrap.querySelectorAll('[data-in]').forEach(b=>{
      b.onclick=()=>mov(b.getAttribute('data-in'),'IN');
    });
    wrap.querySelectorAll('[data-out]').forEach(b=>{
      b.onclick=()=>mov(b.getAttribute('data-out'),'OUT');
    });
    // Historial
    wrap.querySelectorAll('[data-open]').forEach(b=>{
      b.onclick=()=>openHist(b.getAttribute('data-open'));
    });
  }

  function add(){
    const cod=$('#repCod').value.trim(); if(!cod) return alert('Código requerido');
    const arr=list(); if(arr.some(r=>r.cod===cod)) return alert('Código duplicado');
    arr.unshift({
      cod, nombre:$('#repNom').value.trim(), ubicacion:$('#repUbi').value.trim(),
      min:Number($('#repMin').value||0), stock:0
    });
    save(arr);
    $('#repCod').value=$('#repNom').value=$('#repUbi').value=$('#repMin').value='';
    render();
  }

  function mov(cod, tipo){
    const qty=Number(($('#qty-'+cod)?.value)||0);
    if(qty<=0) return alert('Cantidad > 0');
    const arr=list(); const r=arr.find(x=>x.cod===cod); if(!r) return;
    r.stock = Number(r.stock||0) + (tipo==='IN'? qty : -qty);
    if(r.stock<0) r.stock=0;
    save(arr);
    pushMov(cod, {ts:Date.now(), tipo, cant:qty, nota:''});
    render();
  }

  // Modal historial simple
  const modalHtml=`
  <dialog id="repModal" class="cdl-modal">
    <div class="cdl-modal__bk" data-close></div>
    <div class="cdl-modal__card">
      <div class="cdl-modal__head">
        <h3 id="repTitle">Historial</h3>
        <button class="btn-ghost" data-close>✕</button>
      </div>
      <div id="repMovWrap" class="eq-table"></div>
    </div>
  </dialog>`;
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  const repModal=$('#repModal');

  function openHist(cod){
    $('#repTitle').textContent='Historial · '+cod;
    const rows=movs(cod);
    const tbl=document.createElement('table');
    tbl.innerHTML=`<thead><tr><th>Fecha</th><th>Tipo</th><th>Cant.</th></tr></thead>
    <tbody>${rows.map(m=>`<tr><td>${new Date(m.ts).toLocaleString()}</td><td>${m.tipo}</td><td>${m.cant}</td></tr>`).join('')||'<tr><td colspan="3" style="color:#6b7280">Sin movimientos.</td></tr>'}</tbody>`;
    $('#repMovWrap').innerHTML=''; $('#repMovWrap').appendChild(tbl);
    repModal.setAttribute('open','');
  }
  function closeM(){ repModal.removeAttribute('open'); }
  repModal.addEventListener('click', e=>{ if(e.target.matches('[data-close], .cdl-modal__bk')) closeM(); });

  // Exportar e imprimir
  function exportXLS(){
    const rows=list();
    const html=`<table>
      <tr><th>Código</th><th>Nombre</th><th>Ubicación</th><th>Mín.</th><th>Stock</th></tr>
      ${rows.map(r=>`<tr><td>${r.cod}</td><td>${(r.nombre||'').replace(/</g,'&lt;')}</td><td>${(r.ubicacion||'').replace(/</g,'&lt;')}</td><td>${r.min||0}</td><td>${r.stock||0}</td></tr>`).join('')}
    </table>`;
    const blob=new Blob([`\ufeff<html><meta charset="utf-8">${html}</html>`],{type:'application/vnd.ms-excel'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='Repuestos_CDL.xls'; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),400);
  }
  function printInv(){
    const w=window.open('','_blank'); const css=`body{font-family:Inter,Arial} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ddd;padding:6px} th{background:#f8fafc}`;
    const rows=list();
    w.document.write(`<style>${css}</style><h2>Inventario de Repuestos</h2><table><tr><th>Código</th><th>Nombre</th><th>Ubicación</th><th>Mín.</th><th>Stock</th></tr>${rows.map(r=>`<tr><td>${r.cod}</td><td>${r.nombre||''}</td><td>${r.ubicacion||''}</td><td>${r.min||0}</td><td>${r.stock||0}</td></tr>`).join('')}</table>`);
    w.document.close(); w.print();
  }

  // Routing
  function route(){
    const h=location.hash||'';
    $('#repuestosView').hidden = !h.startsWith('#/repuestos');
    if(h.startsWith('#/repuestos')) render();
  }
  window.addEventListener('hashchange', route);
  window.addEventListener('load', ()=>{
    route();
    $('#repAdd')?.addEventListener('click', add);
    $('#repQ')?.addEventListener('input', render);
    $('#repXLS')?.addEventListener('click', exportXLS);
    $('#repPrint')?.addEventListener('click', printInv);
  });
})();
</script>

<!-- =========================================================
BLOQUE 42 — CATÁLOGO de repuestos con QR (grid)
Ruta: #/rep-catalog  · usa qrMake() existente
========================================================= -->
<section id="repCatView" class="cdl-container" hidden>
  <h2>Catálogo de Repuestos</h2>
  <div id="repCatGrid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap:12px;"></div>
</section>
<script>
(function(){
  const $=s=>document.querySelector(s);
  function render(){
    const grid=$('#repCatGrid'); if(!grid) return;
    const rows=JSON.parse(localStorage.getItem('cdl-rep')||'[]');
    grid.innerHTML = rows.map(r=>`
      <article class="eq-card">
        <div class="eq-card__body">
          <div class="eq-title"><span>${r.nombre||'-'}</span><small class="eq-meta">#${r.cod}</small></div>
          <div class="eq-qr" id="qrC-${r.cod}" style="width:100px;height:100px;margin:auto;"></div>
          <div class="eq-meta">Ubi: ${r.ubicacion||'-'} · Stock: ${r.stock||0}</div>
          <button class="btn-cdl" onclick="window.print()">Imprimir tarjeta</button>
        </div>
      </article>`).join('') || '<p style="color:#6b7280">Sin repuestos.</p>';
    rows.forEach(r=> qrMake(document.getElementById('qrC-'+r.cod), location.origin+location.pathname+'#/rep/'+encodeURIComponent(r.cod), 100));
  }
  function route(){
    const on=(location.hash||'').startsWith('#/rep-catalog');
    document.getElementById('repCatView').hidden=!on;
    if(on) render();
  }
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
})();
</script>
<!-- =========================================================
BLOQUE 44 — NOTAS rápidas por EQUIPO (post-its)
LocalStorage: cdl-notes-<EQ> = [{id, ts, txt}]
========================================================= -->
<style>
  .note{ border:1px solid #fde68a; background:#fef9c3; border-radius:10px; padding:8px; }
  .note + .note{ margin-top:8px; }
</style>
<script>
(function(){
  const $=s=>document.querySelector(s);
  function key(c){ return 'cdl-notes-'+c; }
  function ls(c){ try{ return JSON.parse(localStorage.getItem(key(c)))||[] }catch{return []} }
  function sv(c, a){ localStorage.setItem(key(c), JSON.stringify(a)); }

  // Inyecta módulo en la ficha
  window.addEventListener('load', ()=>{
    const aside=document.querySelector('#equipoView .eq-detail__right'); if(!aside||document.getElementById('notesBox')) return;
    const box=document.createElement('div'); box.id='notesBox';
    box.innerHTML=`<h3>Notas rápidas</h3>
      <div style="display:flex; gap:6px; margin-bottom:6px;">
        <input id="noteTxt" placeholder="Escribe una nota…" style="flex:1; border:1px solid #e5e7eb; border-radius:10px; padding:.5rem;">
        <button id="noteAdd" class="btn-cdl">Añadir</button>
      </div>
      <div id="noteList"></div>`;
    aside.appendChild(box);
  });

  // Hook a showEquipo() para renderizar notas
  const _showEquipo = window.showEquipo;
  window.showEquipo = function(code){
    _showEquipo && _showEquipo(code);
    setTimeout(()=>render(code), 0);
    const add=()=>{ const txt=document.getElementById('noteTxt').value.trim(); if(!txt) return;
      const a=ls(code); a.unshift({id:'N'+Date.now(), ts:Date.now(), txt}); sv(code,a);
      document.getElementById('noteTxt').value=''; render(code);
    };
    const btn=document.getElementById('noteAdd'); if(btn && !btn._bind){ btn._bind=true; btn.addEventListener('click', add); }
  };

  function render(code){
    const listEl=document.getElementById('noteList'); if(!listEl) return;
    const a=ls(code);
    listEl.innerHTML = a.map(n=>`<div class="note">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <b>${new Date(n.ts).toLocaleString()}</b>
        <button data-del="${n.id}" class="btn-cdl" style="padding:.2rem .5rem;background:#111;">Borrar</button>
      </div>
      <div>${n.txt.replace(/</g,'&lt;')}</div>
    </div>`).join('') || '<p class="eq-meta">Sin notas.</p>';
    listEl.querySelectorAll('[data-del]').forEach(b=>{
      b.onclick=()=>{ const id=b.getAttribute('data-del'); const arr=ls(code).filter(x=>x.id!==id); sv(code,arr); render(code); };
    });
  }
})();
</script>

<!-- =========================================================
BLOQUE 45 — IMPRESIÓN/“PDF” de incidencias y repuestos
Añade vistas amigables para imprimir (usa print del navegador)
========================================================= -->
<script>
(function(){
  function printIncidencias(){
    const rows=JSON.parse(localStorage.getItem('cdl-inc')||'[]');
    const w=window.open('','_blank');
    const css=`body{font-family:Inter,Arial} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ddd;padding:6px} th{background:#f8fafc}`;
    w.document.write(`<style>${css}</style><h2>Incidencias CDL</h2>
      <table><tr><th>Fecha</th><th>Estado</th><th>Equipo</th><th>Código</th><th>Título</th><th>Coste €</th></tr>
      ${rows.map(r=>`<tr><td>${new Date(r.fecha).toLocaleString()}</td><td>${r.estado}</td><td>${r.eq||''}</td><td>${r.codEq||''}</td><td>${(r.titulo||'').replace(/</g,'&lt;')}</td><td>${Number(r.coste||0).toFixed(2)}</td></tr>`).join('')}
      </table>`);
    w.document.close(); w.print();
  }
  // Botón rápido en Incidencias
  window.addEventListener('load', ()=>{
    const v=document.getElementById('incView');
    if(v && !document.getElementById('incPrint')){
      const b=document.createElement('button'); b.id='incPrint'; b.className='btn-cdl'; b.style.marginLeft='8px'; b.textContent='Imprimir';
      b.onclick=printIncidencias;
      v.querySelector('.eq-table > div')?.appendChild(b);
    }
  });
})();
</script>


<!--=========================================================
BLOQUE 54 — CABECERA: PULIDO VISUAL + LOGO EN TITULARES
(logo-cdl a la izquierda de h1/h2/h3 y detalles de header)
========================================================= -->
<style>
  /* Logo pequeño integrado en todos los h1/h2/h3 (esquina sup. izq) */
  :where(h1,h2,h3){ padding-left:44px; }
  :where(h1,h2,h3)::after{
    content:""; position:absolute; left:8px; top:0; width:28px; height:28px;
    background:url('./logo-cdl.png') center/contain no-repeat; opacity:.95;
    filter:contrast(1.05) saturate(1.05);
  }

  /* Detalles de cabecera: alturas, contención y safe-area */
  :root{
    --hdr-h: 80px;
  }
  .cdl-header{ height:calc(var(--hdr-h) + env(safe-area-inset-top,0px)); padding-top:env(safe-area-inset-top,0px); }
  .cdl-header__inner{ gap:10px; }
  .cdl-logo img{ height:30px; display:block; }

  /* Zonas clicables cómodas */
  .cdl-hamb,.cdl-user__btn{ touch-action:manipulation; -webkit-tap-highlight-color:transparent; }

  /* Sombra sutil como cdl.es */
  #cdlHeader{ box-shadow:0 2px 14px rgba(0,0,0,.04); }

  /* Modo oscuro opcional del SO (no cambia marca roja) */
  @media (prefers-color-scheme: dark){
    html,body{ background:#0b0c0f; color:#e5e7eb; }
    .cdl-header,.eq-card,.kpi,.eq-detail__right,.eq-table{ background:#0f1217; }
    .cdl-panel,.eq-card,.kpi,.eq-detail__right{ border-color:#202631; }
    .cdl-hamb,.cdl-user__btn{ background:#0f1217; border-color:#202631; color:#e5e7eb; }
    .cdl-panel__nav a:hover{ background:#131a22; }
    .cdl-sem .btn{ background:#0f1217; border-color:#202631; color:#e5e7eb; }
    .cdl-divider{ background:#202631; }
  }
</style>
<!-- =========================================================
BLOQUE 57 — DASHBOARD TV (mosaico a pantalla completa)
(ideal para pantallas grandes en planta; usa estados en vivo)
========================================================= -->
<section id="tvView" hidden>
  <div class="tv-wrap">
    <header class="tv-head cdl-container">
      <img src="./logo-cdl.png" alt="CDL" height="22">
      <b>Estado de equipos · TV</b>
      <time id="tvClock"></time>
    </header>
    <div id="tvGrid" class="tv-grid cdl-container"></div>
  </div>
</section>
<style>
  #tvView{ background:#fff; min-height:100dvh; display:grid; grid-template-rows:auto 1fr; }
  .tv-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 0; }
  .tv-grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); padding-bottom:24px; }
  .tv-card{ border:1px solid #e5e7eb; border-radius:16px; padding:12px; background:#fff; display:grid; gap:8px; }
  .tv-card h4{ margin:0; padding-left:0; font-size:1.05rem; font-weight:900; }
  .tv-card h4::after{ content:none; } /* sin logo en h4 para TV */
  .tv-kpi{ display:flex; gap:10px; flex-wrap:wrap; font-size:.95rem; color:#374151; }
  .tv-dot{ width:10px; height:10px; border-radius:50%; margin-right:6px; display:inline-block; vertical-align:middle; }
  .tv-ok{background:#16a34a}.tv-warn{background:#f59e0b}.tv-stop{background:#dc2626}
  @media (prefers-color-scheme: dark){
    #tvView,.tv-card{ background:#0f1217; }
    .tv-card{ border-color:#202631; }
    .tv-kpi{ color:#cbd5e1; }
  }
</style>
<script>
(function(){
  const view = document.getElementById('tvView');
  const grid = document.getElementById('tvGrid');
  const clock = document.getElementById('tvClock');

  function load(){ try{ return JSON.parse(localStorage.getItem('cdl-equipos'))||[] }catch{return []} }
  function color(estado){ return estado==='En marcha'?'ok':estado==='Parada'?'stop':'warn'; }

  function render(){
    grid.innerHTML='';
    const list = load();
    list.forEach(eq=>{
      const card = document.createElement('div');
      card.className='tv-card';
      const horas = eq.horas||{m:0,r:0,p:0};
      const total = (horas.m||0)+(horas.r||0)+(horas.p||0)||1;
      const dispo = ((horas.m||0)/total*100).toFixed(0);
      card.innerHTML=`
        <h4>${eq.nombre} <small style="color:#6b7280">#${eq.codigo}</small></h4>
        <div>
          <span class="tv-dot tv-${color(eq.estado)}"></span>
          <b>${eq.estado}</b>
        </div>
        <div class="tv-kpi">
          <span><b>${horas.m||0}h</b> Marcha</span>
          <span><b>${horas.r||0}h</b> Restr.</span>
          <span><b>${horas.p||0}h</b> Paro</span>
          <span><b>${dispo}%</b> Disp.</span>
        </div>
      `;
      grid.appendChild(card);
    });
  }

  function tick(){
    clock.textContent = new Date().toLocaleString();
  }

  function route(){
    const on=(location.hash||'').startsWith('#/tv');
    view.hidden=!on;
    if(on){ render(); tick(); }
  }

  // Refrescado automático para pantallas TV
  setInterval(()=>{ if(!view.hidden) { render(); tick(); } }, 5000);

  window.addEventListener('hashchange',route);
  window.addEventListener('load',route);
})();
</script>
<!-- =========================================================
BLOQUE 59 — EXPORTAR/IMPORTAR CSV (equipos + eventos)
(sin dependencias; formato simple y robusto)
========================================================= -->
<script>
(function(){
  const LSKEY='cdl-equipos', EVTKEY=c=>'cdl-evt-'+c;
  const $=s=>document.querySelector(s);

  function esc(v){ v=String(v??''); return `"${v.replace(/"/g,'""')}"`; }

  function exportCSV(){
    let rows=[];
    const equipos = JSON.parse(localStorage.getItem(LSKEY)||'[]');
    rows.push('##EQUIPOS');
    rows.push('codigo,nombre,estado,hm,hr,hp,reparaciones,repuestos');
    equipos.forEach(e=>{
      rows.push([e.codigo,e.nombre,e.estado,e.horas?.m||0,e.horas?.r||0,e.horas?.p||0,e.reparaciones||0,e.repuestos||0].map(esc).join(','));
    });
    rows.push('##EVENTOS');
    rows.push('codigo,ts,tipo,horas,coste,detalle');
    equipos.forEach(e=>{
      const ev = JSON.parse(localStorage.getItem(EVTKEY(e.codigo))||'[]');
      ev.forEach(x=>{
        rows.push([e.codigo,x.ts||'',x.tipo||'',x.horas||'',x.coste||'',(x.detalle||'')].map(esc).join(','));
      });
    });
    const blob = new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='cdl_mantenimiento.csv';
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),1000);
  }

  function importCSV(file){
    const reader = new FileReader();
    reader.onload = ()=>{
      const txt = String(reader.result||'');
      const lines = txt.split(/\r?\n/);
      let mode='';
      const equipos=[], eventos=[];
      lines.forEach(l=>{
        if(!l.trim()) return;
        if(l.startsWith('##')){ mode=l.trim(); return; }
        if(l.startsWith('codigo')||l.startsWith('"codigo"')) return; // headers
        // CSV muy simple (comillas dobles)
        const cells = [];
        let cur='', inQ=false;
        for(let i=0;i<l.length;i++){
          const ch=l[i];
          if(ch==='"'){ if(inQ && l[i+1]==='"'){ cur+='"'; i++; } else inQ=!inQ; continue; }
          if(ch===',' && !inQ){ cells.push(cur); cur=''; continue; }
          cur+=ch;
        }
        cells.push(cur);
        if(mode==='##EQUIPOS'){
          const [codigo,nombre,estado,hm,hr,hp,reparaciones,repuestos]=cells;
          equipos.push({
            codigo, nombre, estado,
            horas:{m:Number(hm||0),r:Number(hr||0),p:Number(hp||0)},
            reparaciones:Number(reparaciones||0),
            repuestos:Number(repuestos||0)
          });
        }else if(mode==='##EVENTOS'){
          const [codigo,ts,tipo,horas,coste,detalle]=cells;
          eventos.push({codigo, ts:Number(ts||Date.now()), tipo, horas:Number(horas||0), coste:Number(coste||0), detalle});
        }
      });
      // Persistir
      localStorage.setItem(LSKEY, JSON.stringify(equipos));
      // reset eventos por código
      const by = {};
      eventos.forEach(e=>{ (by[e.codigo]=by[e.codigo]||[]).push({ts:e.ts,tipo:e.tipo,horas:e.horas,coste:e.coste,detalle:e.detalle}); });
      equipos.forEach(eq=>{
        localStorage.setItem(EVTKEY(eq.codigo), JSON.stringify(by[eq.codigo]||[]));
      });
      alert('Datos importados.');
      location.reload();
    };
    reader.readAsText(file);
  }

  function clearAll(){
    if(!confirm('Borrar todos los datos locales (demo)?')) return;
    Object.keys(localStorage).forEach(k=>{
      if(k.startsWith('cdl-')) localStorage.removeItem(k);
    });
    location.reload();
  }

  // Bind UI (Ajustes)
  window.addEventListener('load', ()=>{
    $('#btnExport')?.addEventListener('click', exportCSV);
    $('#csvIn')?.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) importCSV(f); e.target.value=''; });
    $('#btnClear')?.addEventListener('click', clearAll);
  });
})();
</script>

<!-- =========================================================
BLOQUE 60 — ESCÁNER QR (BarcodeDetector / cámara) + fallback
(abrir ficha al detectar URL hash #/equipo/… o código literal)
========================================================= -->
<div id="qrModal" class="user-panel" hidden>
  <div class="user-panel__card" style="width:min(92vw,480px);">
    <header><img src="./logo-cdl.png" height="18" alt="CDL"><b>Escáner QR</b></header>
    <video id="qrVideo" playsinline autoplay muted style="width:100%; border-radius:10px; background:#000;"></video>
    <div style="display:flex; gap:.5rem; margin-top:6px;">
      <button class="btn-cdl" id="qrClose" style="background:#111;">Cerrar</button>
      <input id="qrText" placeholder="Pega URL o código (EQ-001)" style="flex:1; border:1px solid #e5e7eb; border-radius:10px; padding:.55rem .6rem;">
      <button class="btn-cdl" id="qrGo">Ir</button>
    </div>
  </div>
</div>
<script>
(function(){
  const $=s=>document.querySelector(s);
  const modal = $('#qrModal'), video=$('#qrVideo');

  async function open(){
    modal.hidden=false;
    if('BarcodeDetector' in window){
      try{
        const det = new BarcodeDetector({formats:['qr_code']});
        const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
        video.srcObject = stream;
        const loop = async ()=>{
          if(modal.hidden) return;
          const bitmap = await createImageBitmap(video);
          const codes = await det.detect(bitmap);
          if(codes.length){
            handle(codes[0].rawValue||'');
            return;
          }
          requestAnimationFrame(loop);
        };
        requestAnimationFrame(loop);
      }catch(e){ /* cae a fallback */ }
    }
  }
  function close(){
    modal.hidden=true;
    const s=video.srcObject; if(s && s.getTracks) s.getTracks().forEach(t=>t.stop());
    video.srcObject=null;
  }
  function handle(text){
    // admite URL con hash #/equipo/.. o un código tipo EQ-XXX
    try{
      const url = new URL(text);
      if(url.hash.startsWith('#/equipo/')){ location.hash=url.hash; close(); return; }
    }catch{}
    // si no es URL, asumimos código
    if(/^EQ-\w+/.test(text)){ location.hash='#/equipo/'+text.trim(); close(); return; }
    alert('QR no reconocido');
  }
  window.addEventListener('load', ()=>{
    $('#btnScan')?.addEventListener('click', open);
    $('#qrClose')?.addEventListener('click', close);
    $('#qrGo')?.addEventListener('click', ()=>handle($('#qrText').value||''));
  });
})();
</script>

<!-- =========================================================
BLOQUE 61 — RENDIMIENTO + ACCESIBILIDAD + DETALLES FINOS
(skeletons, foco accesible, reduced motion, seguridad)
========================================================= -->
<style>
  .skeleton{
    background:linear-gradient(90deg,#f3f4f6,#eceef1,#f3f4f6);
    background-size:200% 100%;
    animation:sh 1.2s linear infinite;
  }
  @keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .sk-card{ height:120px; border:1px solid #e5e7eb; border-radius:14px; }

  @media (prefers-reduced-motion: reduce){
    *{
      scroll-behavior:auto !important;
      animation-duration:0.01ms !important;
      animation-iteration-count:1 !important;
      transition:none !important;
    }
  }
</style>
<script>
(function(){
  // Foco al cambiar de vista (accesibilidad)
  function focusMain(){
    const m=document.getElementById('main');
    if(m) m.focus({preventScroll:true});
  }
  window.addEventListener('hashchange', focusMain);
  window.addEventListener('load', focusMain);

  // Skeleton mientras carga (muy breve / demo)
  const grids=['#equiposGrid','#incGrid','#repGrid','#kpiGrid','#tvGrid'];
  function putSkeleton(sel){
    const el=document.querySelector(sel); if(!el) return;
    el.innerHTML='';
    for(let i=0;i<6;i++){
      const d=document.createElement('div');
      d.className='sk-card skeleton';
      el.appendChild(d);
    }
    setTimeout(()=>{}, 350);
  }
  window.addEventListener('hashchange', ()=>{
    const h=location.hash||'';
    if(h.startsWith('#/equipos'))     putSkeleton('#equiposGrid');
    if(h.startsWith('#/incidencias')) putSkeleton('#incGrid');
    if(h.startsWith('#/repuestos'))   putSkeleton('#repGrid');
    if(h.startsWith('#/kpi'))         putSkeleton('#kpiGrid');
    if(h.startsWith('#/tv'))          putSkeleton('#tvGrid');
  });

  // Evita selección accidental al pulsar botones en planta
  document.addEventListener('mousedown', e=>{
    if(e.target.closest?.('button')) e.preventDefault();
  });

  // Sanitiza texto libre
  window.safeText = s => String(s||'').replace(/[<>&"]/g, m=>({ '<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;' }[m]));

  // Hoja de QRs (A4)
  function qrSheet(){
    const list = JSON.parse(localStorage.getItem('cdl-equipos')||'[]');
    const win  = window.open('','_blank');
    const css  = `@page{size:A4;margin:10mm} body{font-family:Inter,Arial}
                  .g{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
                  .c{border:1px solid #ddd;border-radius:8px;padding:8px;display:grid;justify-items:center}
                  .c b{font-size:12px}`;

    /* IMPORTANTE: hay que escapar el cierre de script dentro del HTML generado */
    win.document.write(
      `<html><head><title>QRs CDL</title><style>${css}</style></head>
       <body><h3>CDL · QRs de equipos</h3>
       <div class="g" id="g"></div>
       <script>${qrMake.toString()}<\/script>
       </body></html>`
    );

    const g = win.document.getElementById('g');
    list.forEach(eq=>{
      const d = win.document.createElement('div');
      d.className='c';
      d.innerHTML = \`<b>\${eq.nombre} · #\${eq.codigo}</b>
                      <div id="q\${eq.codigo}" style="width:140px;height:140px;border:1px solid #eee;border-radius:6px;"></div>\`;
      g.appendChild(d);
      const url = location.origin + location.pathname + '#/equipo/' + eq.codigo;
      win.qrMake(d.querySelector('#q'+eq.codigo), url, 140);
    });
    win.document.close();
  }
  window.addEventListener('load', ()=>{
    document.getElementById('btnSheet')?.addEventListener('click', qrSheet);
  });
})();
</script>
<!-- =========================================================
BLOQUE 64 — LOGO en titulares (h1/h2/h3) + refino cabecera
(logo visible en la esquina sup. izq de cada titular, sin tapar texto)
========================================================= -->
<style>
  :where(h1,h2,h3){
    padding-left:2.2rem; /* deja hueco para mini logo + marco rojo existentes */
  }
  :where(h1,h2,h3)::after{
    content:""; position:absolute; left:.35rem; top:.05rem;
    width:18px; height:18px; background:url('./logo-cdl.png') center/contain no-repeat;
    opacity:.95; filter:drop-shadow(0 1px 0 rgba(0,0,0,.04));
  }
  /* Refino header (alineación exacta) */
  .cdl-logo img{ display:block; height:28px; }
</style>
<!-- =========================================================
BLOQUE 66 — REFINO VISUAL TIPO cdl.es (breadcrumbs + enlaces)
========================================================= -->
<nav class="cdl-breadcrumbs cdl-container" aria-label="Ruta">
  <a href="#/equipos">Inicio</a>
  <span aria-hidden="true">›</span>
  <span id="crumbHere">Mantenimiento</span>
</nav>

<style>
  .cdl-breadcrumbs{
    display:flex; align-items:center; gap:.4rem; margin-top:10px; margin-bottom:2px; color:#6b7280; font-weight:600;
  }
  .cdl-breadcrumbs a{ color:#111; text-decoration:none; border-bottom:2px solid transparent; }
  .cdl-breadcrumbs a:hover{ border-color:var(--cdl-red); }
  /* Enlaces corporativos dentro del contenido */
  .cdl-container a:not(.btn-cdl){
    color:#111; font-weight:800; text-decoration:none; border-bottom:2px solid rgba(228,59,59,.25);
  }
  .cdl-container a:not(.btn-cdl):hover{ border-color:var(--cdl-red); }
</style>

<script>
(function(){
  // Actualiza rastro según hash
  function upd(){
    const c = document.getElementById('crumbHere'); if(!c) return;
    const h = location.hash||'#/equipos';
    if(h.startsWith('#/equipos')) c.textContent = 'Equipos';
    else if(h.startsWith('#/equipo/')) c.textContent = 'Ficha de equipo';
    else if(h.startsWith('#/repuestos')) c.textContent = 'Repuestos';
    else if(h.startsWith('#/incidencias')) c.textContent = 'Incidencias';
    else if(h.startsWith('#/tv')) c.textContent = 'Dashboard TV';
    else if(h.startsWith('#/qr')) c.textContent = 'QRs';
  }
  window.addEventListener('hashchange', upd);
  window.addEventListener('load', upd);
})();
</script>
<!-- =========================================================
BLOQUE 69 — HOJA DE QRs (imprimible A4) para todos los equipos
========================================================= -->
<section id="qrView" class="cdl-container" hidden>
  <div style="display:flex; align-items:center; justify-content:space-between;">
    <h2>QRs de equipos</h2>
    <div style="display:flex; gap:.5rem;">
      <button class="btn-cdl" id="qrGen">Generar</button>
      <button class="btn-cdl" style="background:#111" onclick="window.print()">Imprimir</button>
    </div>
  </div>
  <p class="eq-meta" style="margin:.2rem 0 1rem;">Genera tarjetas con QR (nombre + código). Se imprimen 8 por página.</p>
  <div id="qrSheet" class="qr-sheet"></div>
</section>

<style>
  .qr-sheet{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
  .qr-card{ border:1px solid #e5e7eb; border-radius:12px; padding:10px; background:#fff; display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:center; }
  .qr-img{ width:120px; height:120px; border:1px solid #e5e7eb; border-radius:10px; display:grid; place-items:center; background:#fff; }
  .qr-info b{ display:block; font-size:1.05rem; }
  @media print{
    #equiposView, #equipoView, #incidenciasView, #repuestosView, #tvView, #cdlHeader, .cdl-breadcrumbs, .pwa-bar, .net-chip { display:none !important; }
    #qrView{ display:block !important; }
    .qr-sheet{ grid-template-columns:repeat(2,1fr); gap:10px; }
  }
</style>

<script>
(function(){
  const $=s=>document.querySelector(s);
  function eqs(){ try{return JSON.parse(localStorage.getItem('cdl-equipos'))||[]}catch{return[]} }

  function gen(){
    const wrap=$('#qrSheet'); if(!wrap) return;
    const list=eqs();
    if(list.length===0){ wrap.innerHTML='<p class="eq-meta">No hay equipos.</p>'; return; }
    wrap.innerHTML='';
    list.forEach(eq=>{
      const card=document.createElement('article');
      card.className='qr-card';
      card.innerHTML=`
        <div class="qr-img" id="img-${eq.codigo}"></div>
        <div class="qr-info">
          <b>${eq.nombre}</b>
          <small class="eq-meta">#${eq.codigo}</small><br>
          <span class="eq-meta">${location.origin+location.pathname}#/equipo/${eq.codigo}</span>
        </div>`;
      wrap.appendChild(card);
      qrMake(card.querySelector('#img-'+eq.codigo), location.origin+location.pathname+'#/equipo/'+eq.codigo, 120);
    });
  }

  function route(){
    const v=$('#qrView'); if(!v) return;
    const h=location.hash||'';
    v.hidden=!h.startsWith('#/qr');
    if(!v.hidden) gen();
  }
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
  $('#qrGen')?.addEventListener('click', gen);
})();
</script>

<!-- =========================================================
BLOQUE 70 — Capa de datos (abstracción para cambiar storage)
========================================================= -->
<script>
/* Abstrae lectura/escritura para poder migrar a Google Sheets/API sin tocar vistas */
(function(){
  if(window.CDL_STORE) return;
  const LS_E = 'cdl-equipos';
  const EVTKEY = c => 'cdl-evt-'+c;
  const LS_R = 'cdl-repuestos';

  const safeGet = k => { try{ return JSON.parse(localStorage.getItem(k)||'null'); }catch{return null;} };
  const safeSet = (k,v) => { try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} };

  window.CDL_STORE = {
    equipos: {
      list(){ return safeGet(LS_E) || []; },
      save(arr){ safeSet(LS_E, arr); },
      upsert(item){
        const arr = this.list();
        const i = arr.findIndex(x=>x.codigo===item.codigo);
        if(i>=0) arr[i]=Object.assign({},arr[i],item); else arr.unshift(item);
        this.save(arr); return arr[i>=0?i:0];
      }
    },
    eventos: {
      list(codigo){ return safeGet(EVTKEY(codigo)) || []; },
      push(codigo, evt){
        const arr = this.list(codigo); arr.unshift({...evt, ts:evt.ts||Date.now()});
        safeSet(EVTKEY(codigo), arr); return arr[0];
      }
    },
    repuestos: {
      list(){ return safeGet(LS_R) || []; },
      save(arr){ safeSet(LS_R, arr); }
    }
  };
})();
</script>

<!-- =========================================================
BLOQUE 71 — Exportar CSV (equipos y eventos)
========================================================= -->
<section id="exportView" class="cdl-container" hidden>
  <h2>Exportar datos</h2>
  <p class="eq-meta" style="margin:.2rem 0 1rem;">Descarga CSV de equipos y eventos para análisis externo.</p>
  <div style="display:flex; gap:.6rem; flex-wrap:wrap;">
    <button class="btn-cdl" id="csvEquipos">CSV Equipos</button>
    <button class="btn-cdl" id="csvEventos">CSV Eventos</button>
  </div>
</section>
<script>
(function(){
  const $=s=>document.querySelector(s);
  function toCSV(rows){
    if(!rows.length) return '';
    const head = Object.keys(rows[0]);
    const esc = v => `"${String(v??'').replace(/"/g,'""')}"`;
    const body = rows.map(r=> head.map(k=>esc(r[k])).join(',')).join('\n');
    return head.join(',')+'\n'+body;
  }
  function download(name, text){
    const a=document.createElement('a'); a.download=name;
    a.href=URL.createObjectURL(new Blob([text],{type:'text/csv'})); a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),1000);
  }
  function route(){
    const v=$('#exportView'); if(!v) return;
    v.hidden = !(location.hash||'').startsWith('#/exportar');
  }
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);

  $('#csvEquipos')?.addEventListener('click', ()=>{
    const E=CDL_STORE.equipos.list();
    download('equipos.csv', toCSV(E));
  });
  $('#csvEventos')?.addEventListener('click', ()=>{
    const E=CDL_STORE.equipos.list();
    const rows=[];
    E.forEach(eq=>{
      CDL_STORE.eventos.list(eq.codigo).forEach(ev=>{
        rows.push({equipo:eq.codigo, nombre:eq.nombre, ...ev});
      });
    });
    download('eventos.csv', toCSV(rows));
  });
})();
</script>

<!-- =========================================================
BLOQUE 72 — Importar CSV (equipos y eventos)
========================================================= -->
<section id="importView" class="cdl-container" hidden>
  <h2>Importar datos</h2>
  <p class="eq-meta">Adjunta CSV con cabeceras. Archivos: <b>equipos.csv</b> o <b>eventos.csv</b>.</p>
  <input id="csvFile" type="file" accept=".csv" />
  <div style="margin-top:8px;">
    <button class="btn-cdl" id="doImport">Importar</button>
  </div>
  <p id="impMsg" class="eq-meta" style="margin-top:8px;"></p>
</section>
<script>
(function(){
  const $=s=>document.querySelector(s);
  function parseCSV(text){
    const lines = text.split(/\r?\n/).filter(x=>x.trim().length);
    if(!lines.length) return {head:[],rows:[]};
    const head = lines[0].split(',').map(s=>s.trim().replace(/^"|"$/g,''));
    const rows = lines.slice(1).map(l=>{
      const cols = []; let cur='', inQ=false;
      for(let i=0;i<l.length;i++){
        const ch=l[i];
        if(ch==='"' ){ if(inQ && l[i+1]==='"'){ cur+='"'; i++; } else inQ=!inQ; }
        else if(ch===',' && !inQ){ cols.push(cur); cur=''; }
        else cur+=ch;
      } cols.push(cur);
      const obj={}; head.forEach((k,i)=> obj[k]=cols[i]?.replace(/^"|"$/g,''));
      return obj;
    });
    return {head, rows};
  }
  function route(){
    const v=$('#importView'); if(!v) return;
    v.hidden = !(location.hash||'').startsWith('#/importar');
  }
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);

  $('#doImport')?.addEventListener('click', async ()=>{
    const f = $('#csvFile')?.files?.[0]; if(!f){ alert('Selecciona un CSV'); return; }
    const text = await f.text();
    const {head, rows} = parseCSV(text);
    const hx = head.map(h=>h.toLowerCase());
    const msg = $('#impMsg');
    if(hx.includes('codigo') && hx.includes('nombre')){ // equipos.csv
      const list = CDL_STORE.equipos.list();
      rows.forEach(r=>{
        const item = {
          codigo: r.codigo, nombre:r.nombre,
          estado: r.estado||'Restricciones',
          horas:{ m:Number(r.hm||r.horas_marcha||0), r:Number(r.hr||r.horas_restricciones||0), p:Number(r.hp||r.horas_paro||0) },
          reparaciones:Number(r.reparaciones||0),
          repuestos:Number(r.repuestos||0)
        };
        CDL_STORE.equipos.upsert(item);
      });
      msg.textContent = `Importados ${rows.length} equipos.`;
    }else if(hx.includes('equipo') && hx.includes('tipo')){ // eventos.csv
      let n=0;
      rows.forEach(r=>{
        CDL_STORE.eventos.push(r.equipo, {
          tipo:r.tipo, horas:Number(r.horas||0), coste:Number(r.coste||0), detalle:r.detalle||'', ts: Number(r.ts||Date.now())
        }); n++;
      });
      msg.textContent = `Importados ${n} eventos.`;
    }else{
      msg.textContent = 'Cabeceras no reconocidas.';
    }
  });
})();
</script>


<!-- =========================================================
BLOQUE 75 — Accesibilidad + atajos teclado (nav y acciones)
========================================================= -->
<script>
(function(){
  // Atajos: g e (equipos), g i (incidencias), g r (repuestos), g k (kpis), g t (tv), g q (qrs)
  const seq=[];
  const go=h=>location.hash=h;
  const map={ 'ge':'#/equipos','gi':'#/incidencias','gr':'#/repuestos','gk':'#/kpi','gt':'#/tv','gq':'#/qr','gx':'#/exportar','gm':'#/importar' };
  window.addEventListener('keydown', (e)=>{
    if(['INPUT','TEXTAREA','SELECT'].includes(document.activeElement?.tagName)) return;
    seq.push(e.key.toLowerCase()); if(seq.length>2) seq.shift();
    const k=seq.join(''); if(map[k]){ e.preventDefault(); go(map[k]); }
  });
  // Saltar contenido con Alt+Shift+S
  window.addEventListener('keydown', (e)=>{ if(e.altKey && e.shiftKey && e.key.toLowerCase()==='s'){ e.preventDefault(); document.getElementById('main')?.focus(); }});
})();
</script>

<!-- =========================================================
BLOQUE 76 — Toasts corporativos (mensajes superiores)
========================================================= -->
<div id="toast" class="cdl-toast" role="status" aria-live="polite"></div>
<style>
  .cdl-toast{ position:fixed; top:14px; left:50%; transform:translateX(-50%); z-index:1200;
    background:#111; color:#fff; padding:.6rem .9rem; border-radius:999px; box-shadow:0 10px 24px rgba(0,0,0,.18); display:none; font-weight:800; }
  .cdl-toast.show{ display:block; animation:fade 2s ease forwards; }
  @keyframes fade{ 0%{opacity:0; transform:translateX(-50%) translateY(-6px);} 10%,80%{opacity:1; transform:translateX(-50%) } 100%{opacity:0; transform:translateX(-50%) translateY(-6px);} }
</style>
<script>
  window.cdlToast = function(msg){ const t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.className='cdl-toast show'; setTimeout(()=>t.className='cdl-toast',2100); };
  // hooks rápidos
  ['hashchange','load'].forEach(ev=> window.addEventListener(ev, ()=>{ /* no-op, reservado */ }));
</script>

<!-- ========================================================= 
BLOQUE 78 — Panel de usuario (rol, cerrar sesión ficticia, tema)
========================================================= -->
<aside id="userPanel" class="cdl-panel" aria-hidden="true" aria-label="Usuario" style="right:0; left:auto; transform:translateX(102%); border-left:1px solid var(--cdl-line);">
  <div class="cdl-panel__head">
    <strong>Usuario</strong>
    <button id="btnCloseUser" class="cdl-x" aria-label="Cerrar">✕</button>
  </div>
  <div style="padding:12px; display:grid; gap:10px;">
    <label>Rol
      <select id="roleSel" style="width:100%; border:1px solid #e5e7eb; border-radius:10px; padding:.55rem .6rem;">
        <option>Mantenimiento</option>
        <option>Producción</option>
        <option>Calidad</option>
        <option>Dirección</option>
      </select>
    </label>
    <m
    <button class="btn-cdl" style="background:#111" id="btnLogout">Cerrarsesión</button>
  </div>
</aside>
<script>
(function(){
  const $=s=>document.querySelector(s);
  const pnl=$('#userPanel'), btn=$('#userBtn'), close=$('#btnCloseUser');
  function open(){ pnl.setAttribute('aria-hidden','false'); }
  function closeP(){ pnl.setAttribute('aria-hidden','true'); }
  btn?.addEventListener('click', open); close?.addEventListener('click', closeP);
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeP(); });

  const KEY='cdl-role';
  function loadRole(){ try{return localStorage.getItem(KEY)||'Mantenimiento'}catch{return'Mantenimiento'} }
  function saveRole(r){ try{localStorage.setItem(KEY,r)}catch{} }

  window.addEventListener('load', ()=>{
    const r=loadRole(); document.getElementById('roleSel').value=r;
    const tag=document.getElementById('userRole'); if(tag) tag.textContent=r;
  });
  document.getElementById('btnSaveRole')?.addEventListener('click', ()=>{
    const r=document.getElementById('roleSel').value; saveRole(r);
    const tag=document.getElementById('userRole'); if(tag) tag.textContent=r;
    cdlToast('Rol actualizado a '+r); 
  });
  document.getElementById('btnLogout')?.addEventListener('click', ()=>{
    cdlToast('Sesión cerrada (demo)');
    // aquí integrarías logout real (OAuth/cookie)
  });
})();
</script>

<!-- =========================================================
BLOQUE 79 — Navegación rápida en menú lateral (añade rutas nuevas)
========================================================= -->
<script>
(function(){
  const nav = document.querySelector('.cdl-panel__nav');
  if(!nav) return;
  // Evita duplicados si ya se inyectó
  if(nav.querySelector('[data-extra="1"]')) return;
  nav.insertAdjacentHTML('beforeend', `
    <a data-extra="1" href="#/qr">QRs</a>
    <a data-extra="1" href="#/kpi">KPIs</a>
    <a data-extra="1" href="#/repuestos">Repuestos</a>
    <a data-extra="1" href="#/incidencias">Incidencias</a>
    <a data-extra="1" href="#/exportar">Exportar</a>
    <a data-extra="1" href="#/importar">Importar</a>
  `);
})();
</script>

<!-- =========================================================
BLOQUE 80 — Filtros por ESTADO en “Equipos” (persistentes)
========================================================= -->
<style>
  .eq-filtros{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin:6px 0 12px; }
  .eq-filtros select{ border:1px solid #e5e7eb; border-radius:10px; padding:.5rem .6rem; }
</style>
<script>
(function(){
  const KEY='cdl-filter-estado';
  function ui(){
    const view=document.getElementById('equiposView'); if(!view) return;
    if(view.querySelector('.eq-filtros')) return;
    const bar=document.createElement('div'); bar.className='eq-filtros';
    bar.innerHTML=`
      <label>Estado
        <select id="fEstado">
          <option value="">Todos</option>
          <option>En marcha</option>
          <option>Restricciones</option>
          <option>Parada</option>
        </select>
      </label>
    `;
    view.insertBefore(bar, view.children[1]);
    const sel=bar.querySelector('#fEstado');
    sel.value = localStorage.getItem(KEY)||'';
    sel.addEventListener('change', ()=>{
      localStorage.setItem(KEY, sel.value);
      render();
    });
  }
  function render(){
    const estado = localStorage.getItem(KEY)||'';
    const q = (new URLSearchParams((location.hash.split('?')[1]||''))).get('q')||'';
    const base = CDL_STORE?.equipos?.list?.()||[];
    const list = estado ? base.filter(e=>e.estado===estado) : base;
    // reutilizamos renderEquipos(list,q) ya existente
    renderEquipos(list, q);
  }
  // Hookeamos renderEquipos si estamos en #/equipos
  const _go = window.renderEquipos;
  window.renderEquipos = function(list, q){
    const estado = localStorage.getItem(KEY)||'';
    if(estado){
      list = list.filter(e=>e.estado===estado);
    }
    _go(list, q);
  };
  window.addEventListener('load', ()=>{
    ui();
    if((location.hash||'').startsWith('#/equipos')) render();
  });
  window.addEventListener('hashchange', ()=>{
    if((location.hash||'').startsWith('#/equipos')){ ui(); /* render ocurre en router */ }
  });
})();
</script>

<!-- =========================================================
BLOQUE 81 — Selector de PLANTA y LÍNEA + etiquetas en tarjetas
========================================================= -->
<style>
  .tag{ display:inline-block; padding:.15rem .5rem; border:1px solid #e5e7eb; border-radius:999px; font-size:.8rem; color:#374151; background:#fff; }
  .eq-tags{ display:flex; gap:.35rem; flex-wrap:wrap; }
  .pl-filtros{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin:0 0 12px; }
  .pl-filtros select{ border:1px solid #e5e7eb; border-radius:10px; padding:.5rem .6rem; }
</style>
<script>
(function(){
  const KP='cdl-filter-planta', KL='cdl-filter-linea';
  function ensureUI(){
    const view=document.getElementById('equiposView'); if(!view) return;
    if(view.querySelector('.pl-filtros')) return;
    const bar=document.createElement('div'); bar.className='pl-filtros';
    bar.innerHTML=`
      <label>Planta
        <select id="fPlanta"><option value="">Todas</option></select>
      </label>
      <label>Línea
        <select id="fLinea"><option value="">Todas</option></select>
      </label>
    `;
    view.insertBefore(bar, view.querySelector('.eq-filtros')?.nextSibling||view.children[1]);
    const selP=bar.querySelector('#fPlanta'), selL=bar.querySelector('#fLinea');
    const E=CDL_STORE.equipos.list();
    const plantas=[...new Set(E.map(x=>x.planta).filter(Boolean))].sort();
    const lineas=[...new Set(E.map(x=>x.linea).filter(Boolean))].sort();
    plantas.forEach(p=> selP.insertAdjacentHTML('beforeend',`<option>${p}</option>`));
    lineas.forEach(l=> selL.insertAdjacentHTML('beforeend',`<option>${l}</option>`));
    selP.value=localStorage.getItem(KP)||''; selL.value=localStorage.getItem(KL)||'';
    selP.addEventListener('change',()=>{ localStorage.setItem(KP, selP.value); rerender(); });
    selL.addEventListener('change',()=>{ localStorage.setItem(KL, selL.value); rerender(); });
  }
  function applyFilters(list){
    const p=localStorage.getItem(KP)||'', l=localStorage.getItem(KL)||'';
    if(p) list = list.filter(e=>e.planta===p);
    if(l) list = list.filter(e=>e.linea===l);
    return list;
  }
  const _render = window.renderEquipos;
  window.renderEquipos = function(list, q){
    list = applyFilters(list);
    _render(list, q);
    // añadir etiquetas en tarjetas
    document.querySelectorAll('.eq-card .eq-card__body').forEach((body,i)=>{
      const eq = list[i]; if(!eq) return;
      const div=document.createElement('div'); div.className='eq-tags';
      if(eq.planta) div.innerHTML += `<span class="tag">Planta: ${eq.planta}</span>`;
      if(eq.linea)  div.innerHTML += `<span class="tag">Línea: ${eq.linea}</span>`;
      body.appendChild(div);
    });
  };
  function rerender(){
    const q = (new URLSearchParams((location.hash.split('?')[1]||''))).get('q')||'';
    window.renderEquipos(CDL_STORE.equipos.list(), q);
  }
  window.addEventListener('load', ()=>{ if((location.hash||'').startsWith('#/equipos')){ ensureUI(); rerender(); }});
  window.addEventListener('hashchange', ()=>{ if((location.hash||'').startsWith('#/equipos')){ ensureUI(); rerender(); }});
})();
</script>

<!-- =========================================================
BLOQUE 82 — Editor de EQUIPO (crear/editar) en panel derecho
========================================================= -->
<aside id="eqEditor" class="cdl-panel" aria-hidden="true" aria-label="Editor equipo" style="right:0; left:auto; transform:translateX(102%); border-left:1px solid var(--cdl-line); max-width:480px;">
  <div class="cdl-panel__head">
    <strong id="edTitle">Nuevo equipo</strong>
    <button id="edClose" class="cdl-x" aria-label="Cerrar">✕</button>
  </div>
  <form id="edForm" style="padding:12px; display:grid; gap:10px;">
    <label>Código <input required name="codigo" style="width:100%; border:1px solid #e5e7eb; border-radius:10px; padding:.55rem .6rem;"></label>
    <label>Nombre <input required name="nombre" style="width:100%; border:1px solid #e5e7eb; border-radius:10px; padding:.55rem .6rem;"></label>
    <label>Estado
      <select name="estado" style="width:100%; border:1px solid #e5e7eb; border-radius:10px; padding:.55rem .6rem;">
        <option>En marcha</option><option>Restricciones</option><option>Parada</option>
      </select>
    </label>
    <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px;">
      <label>Horas M <input type="number" step="0.1" name="hm" value="0"></label>
      <label>Horas R <input type="number" step="0.1" name="hr" value="0"></label>
      <label>Horas P <input type="number" step="0.1" name="hp" value="0"></label>
    </div>
    <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:8px;">
      <label>Planta <input name="planta"></label>
      <label>Línea <input name="linea"></label>
    </div>
    <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:8px;">
      <label>Reparaciones <input type="number" name="reparaciones" value="0"></label>
      <label>€ Repuestos <input type="number" step="0.01" name="repuestos" value="0"></label>
    </div>
    <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
      <button class="btn-cdl" type="submit">Guardar</button>
      <button class="btn-cdl" type="button" id="edClone" style="background:#111;">Duplicar</button>
      <button class="btn-cdl" type="button" id="edGenQR">Ver QR</button>
    </div>
  </form>
</aside>
<script>
(function(){
  const $=s=>document.querySelector(s);
  const pnl=$('#eqEditor'), close=$('#edClose'), form=$('#edForm'), title=$('#edTitle');
  let editing=null;
  function open(data){
    pnl.setAttribute('aria-hidden','false');
    title.textContent = data ? 'Editar equipo' : 'Nuevo equipo';
    editing = data?.codigo || null;
    form.codigo.value = data?.codigo || '';
    form.nombre.value = data?.nombre || '';
    form.estado.value = data?.estado || 'Restricciones';
    form.hm.value = data?.horas?.m ?? 0;
    form.hr.value = data?.horas?.r ?? 0;
    form.hp.value = data?.horas?.p ?? 0;
    form.planta.value = data?.planta || '';
    form.linea.value = data?.linea || '';
    form.reparaciones.value = data?.reparaciones ?? 0;
    form.repuestos.value = data?.repuestos ?? 0;
  }
  function closeP(){ pnl.setAttribute('aria-hidden','true'); }
  close?.addEventListener('click', closeP);
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeP(); });

  // Exponer API
  window.eqOpenEditor = function(codigo){
    const list=CDL_STORE.equipos.list();
    const data = list.find(e=>e.codigo===codigo);
    open(data);
  };
  window.eqNew = function(){ open(null); };

  // Auto botón “+ Equipo” en la vista Equipos
  (function injectButton(){
    const view=document.getElementById('equiposView');
    if(!view) return;
    const btn = document.createElement('button');
    btn.className='btn-cdl'; btn.textContent='+ Equipo';
    btn.style.margin='6px 0 8px'; btn.addEventListener('click', ()=>eqNew());
    view.insertBefore(btn, view.querySelector('.equipos-grid'));
  })();

  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const item = {
      codigo: form.codigo.value.trim(),
      nombre: form.nombre.value.trim(),
      estado: form.estado.value,
      horas:{ m:Number(form.hm.value||0), r:Number(form.hr.value||0), p:Number(form.hp.value||0) },
      planta: form.planta.value.trim()||undefined,
      linea: form.linea.value.trim()||undefined,
      reparaciones:Number(form.reparaciones.value||0),
      repuestos:Number(form.repuestos.value||0)
    };
    const saved = CDL_STORE.equipos.upsert(item);
    cdlToast('Equipo guardado');
    closeP();
    // refrescar lista o ficha según ruta
    if((location.hash||'').startsWith('#/equipo/')) location.hash = '#/equipo/'+encodeURIComponent(item.codigo);
    else if((location.hash||'').startsWith('#/equipos')) {
      const q = (new URLSearchParams((location.hash.split('?')[1]||''))).get('q')||'';
      renderEquipos(CDL_STORE.equipos.list(), q);
    }
  });

  // Duplicar
  document.getElementById('edClone')?.addEventListener('click', ()=>{
    const base = {
      codigo: (form.codigo.value||'') + '-COPY',
      nombre: (form.nombre.value||'') + ' (copia)',
      estado: form.estado.value,
      horas:{ m:Number(form.hm.value||0), r:Number(form.hr.value||0), p:Number(form.hp.value||0) },
      planta: form.planta.value||undefined,
      linea: form.linea.value||undefined,
      reparaciones:Number(form.reparaciones.value||0),
      repuestos:Number(form.repuestos.value||0)
    };
    open(base);
    cdlToast('Editando copia del equipo');
  });

  // Ver QR directo
  document.getElementById('edGenQR')?.addEventListener('click', ()=>{
    const code = form.codigo.value.trim(); if(!code){ alert('Indica un código'); return; }
    const url = location.origin+location.pathname+'#/equipo/'+encodeURIComponent(code);
    window.open(url, '_blank');
  });

  // Acción rápida en tarjeta: clic en título abre editor
  const _render = window.renderEquipos;
  window.renderEquipos = function(list,q){
    _render(list,q);
    // añadir botón editar discreto
    document.querySelectorAll('.eq-card .eq-title').forEach((el, i)=>{
      const eq = list[i]; if(!eq) return;
      const btn = document.createElement('button');
      btn.className='cdl-x'; btn.textContent='✎'; btn.setAttribute('title','Editar');
      btn.style.marginLeft='8px';
      btn.addEventListener('click', (ev)=>{ ev.stopPropagation(); eqOpenEditor(eq.codigo); });
      el.appendChild(btn);
    });
  };
})();
</script>

<!-- =========================================================
BLOQUE 83 — Acción “Editar/Clonar” desde la FICHA del equipo
========================================================= -->
<style>
  .eq-actions-top{ display:flex; gap:.5rem; flex-wrap:wrap; margin:8px 0; }
</style>
<script>
(function(){
  const $=s=>document.querySelector(s);
  function inject(){
    const view=$('#equipoView'); if(!view || view.dataset.edtools==='1') return;
    const wrap=document.createElement('div'); wrap.className='eq-actions-top'; view.insertBefore(wrap, view.querySelector('.cdl-divider'));
    const b1=document.createElement('button'); b1.className='btn-cdl'; b1.textContent='Editar equipo';
    const b2=document.createElement('button'); b2.className='btn-cdl'; b2.textContent='Clonar'; b2.style.background='#111';
    wrap.appendChild(b1); wrap.appendChild(b2);
    b1.addEventListener('click', ()=>{
      const code = $('#eqMeta')?.textContent?.match(/Código\s([^\s·]+)/)?.[1]; if(!code) return;
      window.eqOpenEditor(code);
    });
    b2.addEventListener('click', ()=>{
      const code = $('#eqMeta')?.textContent?.match(/Código\s([^\s·]+)/)?.[1]; if(!code) return;
      const list=CDL_STORE.equipos.list();
      const eq = list.find(e=>e.codigo===code); if(!eq) return;
      window.eqOpenEditor({...eq, codigo:eq.codigo+'-COPY'}.codigo);
      // truco para precargar copia
      setTimeout(()=>window.eqOpenEditor(eq.codigo),0);
      setTimeout(()=>document.querySelector('#edForm input[name="codigo"]').value=eq.codigo+'-COPY',20);
    });
    view.dataset.edtools='1';
  }
  window.addEventListener('hashchange', ()=>{ if((location.hash||'').startsWith('#/equipo/')) inject(); });
  window.addEventListener('load', ()=>{ if((location.hash||'').startsWith('#/equipo/')) inject(); });
})();
</script>

<!-- =========================================================
BLOQUE 84 — Etiquetas QR (una o múltiples) listas para imprimir
========================================================= -->
<section id="qrView" class="cdl-container" hidden>
  <h2>Etiquetas QR</h2>
  <div style="display:flex; gap:.5rem; flex-wrap:wrap; align-items:center;">
    <label>Tamaño <select id="qrSize">
      <option value="120">Pequeño (120px)</option>
      <option value="180" selected>Medio (180px)</option>
      <option value="240">Grande (240px)</option>
    </select></label>
    <button class="btn-cdl" id="qrAll">Generar todos</button>
    <button class="btn-cdl" style="background:#111" id="qrPrint">Imprimir</button>
  </div>
  <div id="qrGrid" class="qr-grid" style="margin-top:10px;"></div>
</section>
<style>
  .qr-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; }
  .qr-card{ border:1px solid #e5e7eb; border-radius:12px; padding:10px; background:#fff; display:grid; gap:6px; justify-items:center; }
  .qr-card h4{ margin:0; font-size:1rem; }
  @media print{
    #equiposView, #kpiView, #tvView, #importView, #exportView, #equipoView, #pagesPanel, #panelBackdrop { display:none !important; }
    #qrView{ display:block !important; }
    .qr-grid{ grid-template-columns: repeat(3, 1fr) !important; gap:10px !important; }
    .qr-card{ page-break-inside:avoid; }
  }
</style>
<script>
(function(){
  const $=s=>document.querySelector(s);
  function route(){
    const v=$('#qrView'); if(!v) return;
    v.hidden = !(location.hash||'').startsWith('#/qr');
  }
  function paintAll(){
    const size = Number($('#qrSize').value||180);
    const grid = $('#qrGrid'); grid.innerHTML='';
    CDL_STORE.equipos.list().forEach(eq=>{
      const card=document.createElement('div'); card.className='qr-card';
      card.innerHTML=`<h4>${eq.nombre}</h4><div class="eq-meta">#${eq.codigo}</div><div class="eq-qr-big" id="qrC-${eq.codigo}"></div>`;
      grid.appendChild(card);
      const url = location.origin+location.pathname+'#/equipo/'+encodeURIComponent(eq.codigo);
      qrMake(card.querySelector('.eq-qr-big'), url, size);
    });
  }
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
  document.getElementById('qrAll')?.addEventListener('click', paintAll);
  document.getElementById('qrPrint')?.addEventListener('click', ()=>window.print());
})();
</script>

<!-- =========================================================
BLOQUE 85 — Vista Incidencias (agregado por equipos)
========================================================= -->
<section id="incView" class="cdl-container" hidden>
  <h2>Incidencias</h2>
  <div id="incTable" class="eq-table"></div>
</section>
<script>
(function(){
  const $=s=>document.querySelector(s);
  function route(){
    const v=$('#incView'); if(!v) return;
    v.hidden = !(location.hash||'').startsWith('#/incidencias');
    if(!v.hidden) paint();
  }
  function paint(){
    const cont = $('#incTable'); cont.innerHTML='';
    const tbl=document.createElement('table');
    tbl.innerHTML=`<thead><tr>
      <th>Fecha</th><th>Equipo</th><th>Tipo</th><th>Horas</th><th>Coste €</th><th>Detalle</th>
    </tr></thead><tbody></tbody>`;
    const body=tbl.querySelector('tbody');
    const E=CDL_STORE.equipos.list();
    E.forEach(eq=>{
      CDL_STORE.eventos.list(eq.codigo).forEach(e=>{
        body.insertAdjacentHTML('beforeend',
          `<tr><td>${new Date(e.ts).toLocaleString()}</td><td>${eq.codigo}</td><td>${e.tipo}</td><td>${e.horas||''}</td><td>${e.coste||''}</td><td>${(e.detalle||'').replace(/</g,'&lt;')}</td></tr>`);
      });
    });
    cont.appendChild(tbl);
  }
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
})();
</script>

<!-- =========================================================
BLOQUE 86 — Vista Repuestos (costes por equipo)
========================================================= -->
<section id="repView" class="cdl-container" hidden>
  <h2>Repuestos</h2>
  <div id="repTable" class="eq-table"></div>
</section>
<script>
(function(){
  const $=s=>document.querySelector(s);
  function route(){
    const v=$('#repView'); if(!v) return;
    v.hidden = !(location.hash||'').startsWith('#/repuestos');
    if(!v.hidden) paint();
  }
  function paint(){
    const cont=$('#repTable'); cont.innerHTML='';
    const tbl=document.createElement('table');
    const E = CDL_STORE.equipos.list();
    const rows=E.map(eq=>{
      const ev=CDL_STORE.eventos.list(eq.codigo);
      const coste = ev.reduce((a,b)=>a+Number(b.coste||0), Number(eq.repuestos||0));
      const rep = ev.filter(b=>b.tipo==='Reparación').length + Number(eq.reparaciones||0);
      return {codigo:eq.codigo, nombre:eq.nombre, rep, coste};
    });
    const total = rows.reduce((a,b)=>a+b.coste,0);
    tbl.innerHTML=`<thead><tr><th>Equipo</th><th>Reparaciones</th><th>Coste repuestos (€)</th></tr></thead>
      <tbody>${rows.map(r=>`<tr><td>${r.codigo} — ${r.nombre}</td><td>${r.rep}</td><td>${r.coste.toFixed(2)}</td></tr>`).join('')}
      <tr><th>Total</th><th></th><th>${total.toFixed(2)}</th></tr>
      </tbody>`;
    cont.appendChild(tbl);
  }
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
})();
</script>

<!-- =========================================================
BLOQUE 87 — Permisos por ROL (edición vs solo lectura)
========================================================= -->
<script>
(function(){
  const EDIT_ROLES = new Set(['Mantenimiento','Dirección']);
  function apply(){
    const role = localStorage.getItem('cdl-role')||'Mantenimiento';
    const can = EDIT_ROLES.has(role);
    // Deshabilitar botones de edición si no puede
    document.querySelectorAll('#evtForm button[type="submit"]').forEach(b=> b.disabled=!can);
    document.querySelectorAll('.btn-cdl').forEach(b=>{
      if(b.textContent?.match(/(Editar|Clonar|\+ Equipo|Guardar)/i)) b.disabled=!can;
    });
    // Aviso sutil
    if(!can) cdlToast('Modo solo lectura por rol: '+role);
  }
  window.addEventListener('load', apply);
  window.addEventListener('hashchange', apply);
  // Re-aplicar cuando cambiamos rol en el Panel de Usuario
  document.getElementById('btnSaveRole')?.addEventListener('click', ()=>setTimeout(apply, 50));
})();
</script>

<!-- =========================================================
BLOQUE 88 — Deep-link QR robusto + fallback PWA
========================================================= -->
<script>
(function(){
  // Si abrimos con ?eq=EQ-XXX redirige a la ficha (útil para apps nativas/QR)
  const params = new URLSearchParams(location.search);
  const eq = params.get('eq');
  if(eq){ location.hash = '#/equipo/'+encodeURIComponent(eq); history.replaceState({},'', location.pathname); }
  // Prompt de instalación PWA (si aplica)
  let defEvt=null;
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); defEvt=e; cdlToast('Instalable: abre el menú del navegador para añadir a inicio'); });
  // podrías añadir un botón que llame defEvt.prompt() si quieres forzar UI
})();
</script>

<!-- =========================================================
BLOQUE 89 — Guardado seguro + copia rápida (backup JSON)
========================================================= -->
<section id="backupView" class="cdl-container" hidden>
  <h2>Copias de seguridad</h2>
  <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
    <button class="btn-cdl" id="bkExport">Exportar JSON</button>
    <input type="file" id="bkFile" accept="application/json">
    <button class="btn-cdl" id="bkImport" style="background:#111">Restaurar</button>
  </div>
</section>
<script>
(function(){
  const $=s=>document.querySelector(s);
  function route(){
    const v=$('#backupView'); if(!v) return;
    v.hidden = !(location.hash||'').startsWith('#/backup');
  }
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);

  function dump(){
    const E = CDL_STORE.equipos.list();
    const data = { equipos:E, eventos:{} };
    E.forEach(eq=> data.eventos[eq.codigo]=CDL_STORE.eventos.list(eq.codigo));
    return data;
  }
  function download(name, obj){
    const a=document.createElement('a'); a.download=name;
    a.href=URL.createObjectURL(new Blob([JSON.stringify(obj,null,2)],{type:'application/json'})); a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),1000);
  }
  $('#bkExport')?.addEventListener('click', ()=>{
    download('backup-cdl.json', dump());
    cdlToast('Backup exportado');
  });
  $('#bkImport')?.addEventListener('click', async ()=>{
    const f=$('#bkFile')?.files?.[0]; if(!f){ alert('Selecciona un JSON'); return; }
    const text = await f.text();
    try{
      const obj=JSON.parse(text);
      if(Array.isArray(obj.equipos)) CDL_STORE.equipos.save(obj.equipos);
      if(obj.eventos && typeof obj.eventos==='object'){
        Object.entries(obj.eventos).forEach(([k,v])=>{
          localStorage.setItem('cdl-evt-'+k, JSON.stringify(v||[]));
        });
      }
      cdlToast('Backup restaurado');
      if((location.hash||'').startsWith('#/equipos')){
        const q = (new URLSearchParams((location.hash.split('?')[1]||''))).get('q')||'';
        renderEquipos(CDL_STORE.equipos.list(), q);
      }
    }catch(e){ alert('JSON no válido'); }
  });
})();
</script>
<!-- =========================================================
BLOQUE 90 — Filtros AVANZADOS (estado + planta + línea + fechas + coste + texto)
========================================================= -->
<style>
  .adv-filtros{display:flex;flex-wrap:wrap;gap:.5rem;margin:6px 0 12px}
  .adv-filtros input,.adv-filtros select{border:1px solid #e5e7eb;border-radius:10px;padding:.5rem .6rem}
</style>
<script>
(function(){
  const IDS={wrap:'advFiltros',d1:'fDesde',d2:'fHasta',c1:'cMin',c2:'cMax',t:'fTexto'};
  function ensure(){
    const view=document.getElementById('equiposView'); if(!view) return;
    if(document.getElementById(IDS.wrap)) return;
    const bar=document.createElement('div'); bar.className='adv-filtros'; bar.id=IDS.wrap;
    bar.innerHTML=`
      <label>Desde <input type="date" id="${IDS.d1}"></label>
      <label>Hasta <input type="date" id="${IDS.d2}"></label>
      <label>€ mín <input type="number" step="0.01" id="${IDS.c1}" placeholder="0"></label>
      <label>€ máx <input type="number" step="0.01" id="${IDS.c2}" placeholder="∞"></label>
      <label>Texto <input type="search" id="${IDS.t}" placeholder="detalle/incidencia"></label>
      <button class="btn-cdl" id="advGo">Filtrar</button>
      <button class="btn-cdl" id="advClear" style="background:#111">Limpiar</button>
    `;
    view.insertBefore(bar, view.querySelector('.equipos-grid'));
    document.getElementById('advGo').onclick = rerender;
    document.getElementById('advClear').onclick = ()=>{
      [IDS.d1,IDS.d2,IDS.c1,IDS.c2,IDS.t].forEach(id=>document.getElementById(id).value='');
      rerender();
    };
  }
  function applyAdvanced(list){
    const d1 = document.getElementById(IDS.d1)?.value;
    const d2 = document.getElementById(IDS.d2)?.value;
    const c1 = Number(document.getElementById(IDS.c1)?.value||0);
    const c2raw = document.getElementById(IDS.c2)?.value; const c2 = c2raw===''?Infinity:Number(c2raw);
    const txt=(document.getElementById(IDS.t)?.value||'').toLowerCase();

    if(!(d1||d2||c1||c2raw||txt)) return list;
    // filtra si el equipo tiene algún evento que cumpla (o, si no hay eventos, deja pasar si no filtramos por eventos)
    return list.filter(eq=>{
      const ev = (CDL_STORE?.eventos?.list(eq.codigo)||[]);
      if(ev.length===0) return txt==='' && c1===0 && !d1 && !d2 && c2===Infinity;
      return ev.some(e=>{
        const fechaOK = (!d1 || e.ts>=new Date(d1).getTime()) && (!d2 || e.ts<=new Date(d2).getTime()+86400000-1);
        const costeOK = (Number(e.coste||0)>=c1) && (Number(e.coste||0)<=c2);
        const textOK = txt==='' || (String(e.detalle||'').toLowerCase().includes(txt) || String(e.tipo||'').toLowerCase().includes(txt));
        return fechaOK && costeOK && textOK;
      });
    });
  }
  // hook a renderEquipos tras los filtros previos
  const _render = window.renderEquipos;
  window.renderEquipos = function(list,q){
    ensure();
    list = applyAdvanced(list);
    _render(list,q);
  };
  function rerender(){
    if((location.hash||'').startsWith('#/equipos')){
      const q = (new URLSearchParams((location.hash.split('?')[1]||''))).get('q')||'';
      renderEquipos(CDL_STORE.equipos.list(), q);
    }
  }
  window.addEventListener('hashchange', ensure);
  window.addEventListener('load', ensure);
})();
</script>

<!-- =========================================================
BLOQUE 91 — Resumen de filtros + contadores (chips)
========================================================= -->
<style>
  .eq-summary{display:flex;gap:.4rem;flex-wrap:wrap;margin:0 0 10px}
  .chip-c{border:1px solid #e5e7eb;border-radius:999px;padding:.2rem .6rem;font-weight:800;color:#374151;background:#fff}
</style>
<script>
(function(){
  function inject(){
    const v=document.getElementById('equiposView'); if(!v) return;
    if(v.querySelector('.eq-summary')) return;
    const s=document.createElement('div'); s.className='eq-summary'; s.id='eqSummary';
    v.insertBefore(s, v.querySelector('.equipos-grid'));
  }
  function update(){
    const v=document.getElementById('equiposView'); if(!v) return;
    const s=document.getElementById('eqSummary'); if(!s) return;
    const L=CDL_STORE.equipos.list();
    const c={ok:0,w:0,st:0}; L.forEach(e=>{ if(e.estado==='En marcha')c.ok++; else if(e.estado==='Restricciones')c.w++; else c.st++; });
    s.innerHTML = `
      <span class="chip-c">Total: ${L.length}</span>
      <span class="chip-c">Marcha: ${c.ok}</span>
      <span class="chip-c">Restr.: ${c.w}</span>
      <span class="chip-c">Paro: ${c.st}</span>
    `;
  }
  const _r = window.renderEquipos;
  window.renderEquipos = function(list,q){ _r(list,q); inject(); update(); };
  window.addEventListener('load', ()=>{ if((location.hash||'').startsWith('#/equipos')){ inject(); update(); }});
  window.addEventListener('hashchange', ()=>{ if((location.hash||'').startsWith('#/equipos')){ inject(); update(); }});
})();
</script>

<!-- =========================================================
BLOQUE 92 — Etiquetas QR imprimibles con LOGO + campos extra
========================================================= -->
<section id="labelsView" class="cdl-container" hidden>
  <h2>Imprimir etiquetas</h2>
  <form id="lblForm" style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:10px">
    <label>Ubicación <input name="ubic" placeholder="Nave 1 / Zona A"></label>
    <label>Responsable <input name="resp" placeholder="Nombre y apellidos"></label>
    <label>Tamaño
      <select name="size">
        <option value="180">180px</option>
        <option value="240" selected>240px</option>
        <option value="300">300px</option>
      </select>
    </label>
    <label><input type="checkbox" name="logo" checked> Logo CDL</label>
    <label><input type="checkbox" name="wm" checked> Watermark Mantenimiento</label>
    <button class="btn-cdl" type="button" id="lblGen">Generar</button>
    <button class="btn-cdl" type="button" id="lblPrint" style="background:#111">Imprimir</button>
  </form>
  <div id="labelsGrid" class="qr-grid"></div>
</section>
<style>
  .label-card{border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;display:grid;gap:6px;justify-items:center;position:relative;overflow:hidden}
  .label-card .mark{position:absolute;inset:0;pointer-events:none;opacity:.08;background:url('./logo_mantenimiento.png') center/420px auto no-repeat}
  .label-head{display:flex;align-items:center;gap:.5rem}
  .label-head img{height:22px}
</style>
<script>
(function(){
  const $=s=>document.querySelector(s);
  function route(){
    const v=$('#labelsView'); if(!v) return;
    v.hidden = !(location.hash||'').startsWith('#/etiquetas');
  }
  function gen(){
    const grid=$('#labelsGrid'); grid.innerHTML='';
    const fd=new FormData($('#lblForm'));
    const ubic = String(fd.get('ubic')||'').trim();
    const resp = String(fd.get('resp')||'').trim();
    const size = Number(fd.get('size')||240);
    const showLogo = fd.get('logo')==='on';
    const showWM = fd.get('wm')==='on';

    CDL_STORE.equipos.list().forEach(eq=>{
      const card=document.createElement('div'); card.className='label-card';
      card.innerHTML = `
        ${showWM?'<div class="mark"></div>':''}
        <div class="label-head">
          ${showLogo?'<img src="./logo-cdl.png" alt="CDL">':''}
          <div><strong>${eq.nombre}</strong><div class="eq-meta">#${eq.codigo}</div></div>
        </div>
        <div class="eq-qr-big" id="lqr-${eq.codigo}"></div>
        ${ubic?`<div class="eq-meta">Ubicación: ${ubic}</div>`:''}
        ${resp?`<div class="eq-meta">Responsable: ${resp}</div>`:''}
      `;
      grid.appendChild(card);
      const url = location.origin+location.pathname+'#/equipo/'+encodeURIComponent(eq.codigo);
      qrMake(card.querySelector('.eq-qr-big'), url, size);
    });
  }
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
  document.getElementById('lblGen')?.addEventListener('click', gen);
  document.getElementById('lblPrint')?.addEventListener('click', ()=>window.print());
})();
</script>

<!-- =========================================================
BLOQUE 93 — Desde la FICHA: previsualizar e imprimir etiqueta individual
========================================================= -->
<style>
  .eq-label-actions{display:flex;gap:.5rem;flex-wrap:wrap;margin:8px 0}
  dialog.cdl{border:1px solid #e5e7eb;border-radius:12px;padding:12px}
</style>
<dialog id="dlgLabel" class="cdl">
  <div id="dlgContent"></div>
  <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:10px">
    <button class="btn-cdl" id="dlgPrint">Imprimir</button>
    <button class="btn-cdl" id="dlgClose" style="background:#111">Cerrar</button>
  </div>
</dialog>
<script>
(function(){
  const $=s=>document.querySelector(s);
  function inject(){
    const v=$('#equipoView'); if(!v) return;
    if(v.querySelector('.eq-label-actions')) return;
    const bar=document.createElement('div'); bar.className='eq-label-actions';
    const b=document.createElement('button'); b.className='btn-cdl'; b.textContent='Etiqueta QR';
    bar.appendChild(b); v.insertBefore(bar, v.querySelector('.cdl-divider'));
    b.onclick=()=>{
      const code = $('#eqMeta')?.textContent?.match(/Código\s([^\s·]+)/)?.[1];
      const name = $('#eqName')?.textContent||'Equipo';
      const dlg=$('#dlgLabel'); const box=$('#dlgContent'); box.innerHTML='';
      const wrap=document.createElement('div'); wrap.className='label-card'; wrap.style.width='280px';
      wrap.innerHTML=`<div class="label-head"><img src="./logo-cdl.png" alt="CDL"><div><strong>${name}</strong><div class="eq-meta">#${code}</div></div></div><div class="eq-qr-big" id="dlgQR"></div>`;
      box.appendChild(wrap);
      dlg.showModal();
      const url = location.origin+location.pathname+'#/equipo/'+encodeURIComponent(code);
      qrMake(wrap.querySelector('#dlgQR'), url, 240);
      document.getElementById('dlgPrint').onclick=()=>window.print();
      document.getElementById('dlgClose').onclick=()=>dlg.close();
    };
  }
  window.addEventListener('hashchange', ()=>{ if((location.hash||'').startsWith('#/equipo/')) inject(); });
  window.addEventListener('load', ()=>{ if((location.hash||'').startsWith('#/equipo/')) inject(); });
})();
</script>

<!-- =========================================================
BLOQUE 94 — Fotos en EVENTOS: adjuntar, previsualizar y ver
========================================================= -->
<style>
  .thumbs{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .thumbs img{width:62px;height:62px;object-fit:cover;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer}
  .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1200}
  .lightbox img{max-width:92vw;max-height:92vh;border-radius:8px;box-shadow:0 10px 40px rgba(0,0,0,.4)}
</style>
<div id="lb" class="lightbox" onclick="this.style.display='none'"><img alt=""></div>
<script>
(function(){
  const $=s=>document.querySelector(s);
  // extender formulario de eventos con input file (múltiple)
  window.addEventListener('load', ()=>{
    const f=$('#evtForm'); if(!f || f.querySelector('input[name="fotos"]')) return;
    const lbl=document.createElement('label');
    lbl.innerHTML=`Fotos <input type="file" name="fotos" accept="image/*" multiple>`;
    f.insertBefore(lbl, f.querySelector('button[type="submit"]'));
  });
  // Helper para convertir a base64
  async function toBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
  // Hookear pushEvt para guardar fotos
  const _push = window.pushEvt;
  window.pushEvt = async function(codigo, evt){
    try{
      if(evt.fotosFiles && evt.fotosFiles.length){
        const arr=[]; for(const f of evt.fotosFiles){ arr.push(await toBase64(f)); }
        evt.fotos = arr;
      }
    }catch(e){ console.warn('Fotos no añadidas', e); }
    _push(codigo, evt);
  };
  // Inyectar preview + lectura de ficheros al enviar
  const _showEquipo = window.showEquipo;
  window.showEquipo = function(code){
    _showEquipo(code);
    const f=document.getElementById('evtForm');
    if(f){
      f.onsubmit = async (evn)=>{
        evn.preventDefault();
        const fd = new FormData(f);
        const fotosFiles = fd.getAll('fotos').filter(x=>x && x.name); // File[]
        await window.pushEvt(code, {
          tipo: fd.get('tipo'), horas:Number(fd.get('horas')||0), coste:Number(fd.get('coste')||0),
          detalle:String(fd.get('detalle')||''), fotosFiles
        });
        f.reset(); window.showEquipo(code);
      };
    }
    // Pintar miniaturas en la tabla
    const tbl = document.querySelector('#eqTable table tbody'); if(!tbl) return;
    const evts = CDL_STORE.eventos.list(code);
    const rows = tbl.querySelectorAll('tr');
    rows.forEach((tr, i)=>{
      const e = evts[i]; if(!e) return;
      if(e.fotos && e.fotos.length){
        const td=document.createElement('td'); td.colSpan=5; const box=document.createElement('div'); box.className='thumbs';
        e.fotos.forEach(src=>{
          const img=new Image(); img.src=src; img.alt='foto';
          img.onclick=()=>{ const lb=document.getElementById('lb'); lb.querySelector('img').src=src; lb.style.display='flex'; };
          box.appendChild(img);
        });
        tr.after(document.createElement('tr')).nextSibling.appendChild(document.createElement('td')).parentNode.firstChild.colSpan=5;
        tr.nextSibling.firstChild.appendChild(box);
      }
    });
  };
})();
</script>

<!-- =========================================================
BLOQUE 95 — Mini-GRÁFICO de tendencias (horas M/R/P) por equipo
========================================================= -->
<style>
  .trend{border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;margin-top:10px}
</style>
<script>
(function(){
  function drawTrend(canvas, data){
    const ctx = canvas.getContext('2d');
    const w=canvas.width=canvas.clientWidth||420, h=canvas.height=160;
    ctx.clearRect(0,0,w,h);
    const keys=['m','r','p'];
    const max = Math.max(1, ...data.flatMap(d=>keys.map(k=>d[k]||0)));
    const xStep = w/(Math.max(1,data.length-1));
    function line(key){
      ctx.beginPath();
      data.forEach((d,i)=>{
        const x=i*xStep, y=h - ( (d[key]||0)/max )*(h-20) - 10;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.lineWidth=2; ctx.stroke();
    }
    // sin especificar colores (el navegador usa por defecto)
    line('m'); line('r'); line('p');
    // ejes sutiles
    ctx.globalAlpha=.25; ctx.beginPath(); ctx.moveTo(0,h-10); ctx.lineTo(w,h-10); ctx.stroke(); ctx.globalAlpha=1;
  }
  const _show = window.showEquipo;
  window.showEquipo = function(code){
    _show(code);
    const left = document.querySelector('.eq-detail__left');
    if(!left || left.querySelector('.trend')) return;
    const box=document.createElement('div'); box.className='trend';
    box.innerHTML='<h3>Tendencia (horas M/R/P)</h3><canvas id="cvTrend" style="width:100%"></canvas>';
    left.appendChild(box);
    // datos: ultimos 12 eventos agregados por tipo (acumulado simple)
    const raw = CDL_STORE.eventos.list(code).slice(0,60).reverse();
    const buckets=[]; // grupos de 5 eventos
    for(let i=0;i<raw.length;i+=5){
      const slice=raw.slice(i,i+5);
      buckets.push({
        m: slice.filter(e=>e.tipo==='Marcha').reduce((a,b)=>a+Number(b.horas||0),0),
        r: slice.filter(e=>e.tipo==='Restricción').reduce((a,b)=>a+Number(b.horas||0),0),
        p: slice.filter(e=>e.tipo==='Paro').reduce((a,b)=>a+Number(b.horas||0),0)
      });
      if(buckets.length>=12) break;
    }
    drawTrend(document.getElementById('cvTrend'), buckets.length?buckets:[{m:0,r:0,p:0}]);
  };
})();
</script>

<!-- =========================================================
BLOQUE 96 — Sparklines en TARJETAS (estado de las últimas incidencias)
========================================================= -->
<style>
  .spark{width:100%;height:36px;display:block}
</style>
<script>
(function(){
  function spark(el, arr){
    const c=document.createElement('canvas'); c.width=el.clientWidth||240; c.height=36; el.appendChild(c);
    const ctx=c.getContext('2d'); const w=c.width,h=c.height, m=2;
    const max=Math.max(1,...arr); const step=w/Math.max(1,arr.length-1);
    ctx.beginPath();
    arr.forEach((v,i)=>{ const x=i*step, y=h - (v/max)*(h-m) - m; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
    ctx.lineWidth=1.5; ctx.stroke();
  }
  const _render = window.renderEquipos;
  window.renderEquipos = function(list,q){
    _render(list,q);
    document.querySelectorAll('.eq-card .eq-card__body').forEach((body,i)=>{
      const eq=list[i]; if(!eq) return;
      const ev=CDL_STORE.eventos.list(eq.codigo).slice(0,20);
      const arr=ev.map(e=>Number(e.horas||0)||0);
      const host=document.createElement('div'); host.className='spark'; body.appendChild(host);
      spark(host, arr.length?arr:[0]);
    });
  };
})();
</script>

<!-- =========================================================
BLOQUE 97 — Cola OFFLINE de eventos + reintento (para backend futuro)
========================================================= -->
<script>
/* Si en el futuro hay API, esta cola guardará los eventos y los reintenta al recuperar conexión */
(function(){
  const KEY='cdl-queue';
  function q(){ try{return JSON.parse(localStorage.getItem(KEY))||[]}catch{return[]} }
  function save(a){ try{localStorage.setItem(KEY,JSON.stringify(a))}catch{} }
  // Encolar al crear evento
  const _push = window.pushEvt;
  window.pushEvt = async function(codigo, evt){
    _push(codigo, evt);
    const item={codigo,evt,ts:Date.now()};
    const arr=q(); arr.push(item); save(arr);
    // simulación de flush si hubiera fetch a API
    tryFlush();
  };
  async function tryFlush(){
    if(!navigator.onLine) return;
    const arr=q(); if(!arr.length) return;
    // Aquí llamarías a fetch('/api/evento', {method:'POST',body:JSON.stringify(item)})
    // Simulamos éxito inmediato:
    save([]);
    cdlToast('Eventos sincronizados');
  }
  window.addEventListener('online', tryFlush);
})();
</script>

<!-- =========================================================
BLOQUE 98 — Exportación CSV (Incidencias y Repuestos)
========================================================= -->
<section id="exportView" class="cdl-container" hidden>
  <h2>Exportar datos</h2>
  <div style="display:flex;gap:.5rem;flex-wrap:wrap">
    <button class="btn-cdl" id="exInc">Incidencias CSV</button>
    <button class="btn-cdl" id="exRep" style="background:#111">Repuestos CSV</button>
  </div>
</section>
<script>
(function(){
  const $=s=>document.querySelector(s);
  function route(){
    const v=$('#exportView'); if(!v) return;
    v.hidden = !(location.hash||'').startsWith('#/export');
  }
  function csv(rows){
    return rows.map(r=>r.map(v=>{
      const s=String(v??''); return (s.includes(';')||s.includes('"')||s.includes('\n'))?('"'+s.replace(/"/g,'""')+'"'):s;
    }).join(';')).join('\n');
  }
  function download(name,text){
    const a=document.createElement('a'); a.download=name; a.href=URL.createObjectURL(new Blob([text],{type:'text/csv'})); a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),500);
  }
  $('#exInc')?.addEventListener('click', ()=>{
    const out=[['fecha','equipo','tipo','horas','coste','detalle']];
    CDL_STORE.equipos.list().forEach(eq=>{
      CDL_STORE.eventos.list(eq.codigo).forEach(e=>{
        out.push([new Date(e.ts).toISOString(), eq.codigo, e.tipo, e.horas||'', e.coste||'', (e.detalle||'').replace(/\n/g,' ')]);
      });
    });
    download('incidencias.csv', csv(out));
  });
  $('#exRep')?.addEventListener('click', ()=>{
    const out=[['equipo','reparaciones','coste_total']];
    CDL_STORE.equipos.list().forEach(eq=>{
      const ev=CDL_STORE.eventos.list(eq.codigo);
      const rep = ev.filter(e=>e.tipo==='Reparación').length + Number(eq.reparaciones||0);
      const coste = ev.reduce((a,b)=>a+Number(b.coste||0), Number(eq.repuestos||0));
      out.push([eq.codigo, rep, coste.toFixed(2)]);
    });
    download('repuestos.csv', csv(out));
  });
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
})();
</script>

<!-- =========================================================
BLOQUE 99 — Accesibilidad + Atajos de teclado (búsqueda, menú, rutas)
========================================================= -->
<script>
(function(){
  // Atajos:
  //   /  -> focus buscar
  //   m  -> menú principal
  //   e  -> nueva incidencia (si hay ficha)
  //   q  -> vista etiquetas QR
  //   g  -> vista equipos
  window.addEventListener('keydown', (e)=>{
    if(e.target && ['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
    if(e.key==='/'){ e.preventDefault(); document.getElementById('searchBox')?.focus(); return; }
    if(e.key==='m'){ e.preventDefault(); document.getElementById('btnMenu')?.click(); return; }
    if(e.key==='g'){ e.preventDefault(); location.hash='#/equipos'; return; }
    if(e.key==='q'){ e.preventDefault(); location.hash='#/etiquetas'; return; }
    if(e.key==='e' && (location.hash||'').startsWith('#/equipo/')){
      e.preventDefault();
      document.getElementById('evtForm')?.scrollIntoView({behavior:'smooth',block:'center'});
    }
  });
  // ARIA menores
  document.getElementById('pagesPanel')?.setAttribute('role','dialog');
})();
</script>

<!-- =========================================================
BLOQUE 100 — HOTFIX: Mini store global (CDL_STORE) si no existe
========================================================= -->

<script>
(function(){
  if(window.CDL_STORE) return;
  // Puentes a las funciones ya existentes del proyecto
  function _equipos(){ try{return JSON.parse(localStorage.getItem('cdl-equipos'))||[]}catch{return[]} }
  function _setEquipos(arr){ try{localStorage.setItem('cdl-equipos', JSON.stringify(arr))}catch{} }
  function _evKey(c){ return 'cdl-evt-'+c }
  function _eventos(c){ try{return JSON.parse(localStorage.getItem(_evKey(c)))||[]}catch{return[]} }
  function _pushEvt(c, e){ const a=_eventos(c); a.unshift(e); localStorage.setItem(_evKey(c), JSON.stringify(a)); }

  window.CDL_STORE = {
    equipos: {
      list: ()=>_equipos(),
      upsert: (obj)=>{
        const L=_equipos(); const i=L.findIndex(x=>x.codigo===obj.codigo);
        if(i>=0) L[i]={...L[i], ...obj}; else L.push(obj);
        _setEquipos(L); return obj.codigo;
      }
    },
    eventos: {
      list: (code)=>_eventos(code),
      push: (code, evt)=>_pushEvt(code, {...evt, ts: evt.ts||Date.now()})
    }
  };
  // Toast mínimo utilizado más abajo
  window.cdlToast = window.cdlToast || (msg=>{
    const t=document.createElement('div');
    t.textContent=msg; t.style.cssText='position:fixed;right:14px;bottom:14px;background:#111;color:#fff;padding:10px 12px;border-radius:10px;z-index:2000';
    document.body.appendChild(t); setTimeout(()=>t.remove(),2500);
  });
})();
</script>

<!-- =========================================================
BLOQUE 101 — Alertas SLA (restricción/paro) + badge en cabecera
========================================================= -->
<style>
  .cdl-badge{position:absolute;top:8px;right:8px;background:#dc2626;color:#fff;font-weight:800;border-radius:999px;padding:.15rem .45rem;font-size:.75rem}
</style>
<script>
(function(){
  const SLA={warnR:8, warnP:2, windowH:72}; // horas en 72h
  function analyze(eq){
    const since = Date.now() - SLA.windowH*3600000;
    const ev = CDL_STORE.eventos.list(eq.codigo).filter(e=>e.ts>=since);
    const hrsR = ev.filter(e=>e.tipo==='Restricción').reduce((a,b)=>a+(+b.horas||0),0);
    const hrsP = ev.filter(e=>e.tipo==='Paro').reduce((a,b)=>a+(+b.horas||0),0);
    return {hrsR, hrsP, breach: hrsR>=SLA.warnR || hrsP>=SLA.warnP};
  }
  function headerBadge(count){
    const h=document.getElementById('cdlHeader'); if(!h) return;
    let b=h.querySelector('.cdl-badge');
    if(count>0){
      if(!b){ b=document.createElement('span'); b.className='cdl-badge'; h.appendChild(b); }
      b.textContent = count;
      b.title = 'Alertas SLA activas';
    }else{ b?.remove(); }
  }
  function scan(){
    const L = CDL_STORE.equipos.list();
    const breaches = L.map(analyze).filter(x=>x.breach).length;
    headerBadge(breaches);
    if(breaches>0) cdlToast(`⚠️ ${breaches} equipos superan SLA en 72h`);
  }
  window.addEventListener('load', scan);
  window.addEventListener('hashchange', ()=>{ if((location.hash||'').startsWith('#/equipos')) scan(); });
})();
</script>

<!-- =========================================================
BLOQUE 102 — Calendario de paradas (vista mensual)
========================================================= -->
<section id="calView" class="cdl-container" hidden>
  <h2>Calendario de paradas</h2>
  <div style="display:flex;gap:.5rem;align-items:center;margin-bottom:8px">
    <button class="btn-cdl" id="calPrev">←</button>
    <div id="calTitle" style="font-weight:900"></div>
    <button class="btn-cdl" id="calNext">→</button>
    <button class="btn-cdl" id="calNew" style="margin-left:auto;background:#111">Programar parada</button>
  </div>
  <div id="calGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px"></div>
</section>
<style>
  .day{border:1px solid #e5e7eb;border-radius:10px;padding:6px;min-height:90px;background:#fff}
  .day h4{margin:0 0 4px;font-size:.9rem;color:#374151}
  .tag{display:block;border-radius:8px;padding:.2rem .4rem;margin:.2rem 0;background:#fee2e2;color:#991b1b;font-weight:800;font-size:.75rem}
  .tag.r{background:#fef3c7;color:#92400e}
  .tag.m{background:#dcfce7;color:#14532d}
</style>
<script>
(function(){
  const $=s=>document.querySelector(s);
  let base = new Date(); base.setDate(1); base.setHours(0,0,0,0);

  function route(){
    const v=$('#calView'); if(!v) return;
    v.hidden = !(location.hash||'').startsWith('#/calendario');
    if(!v.hidden) render();
  }
  function evToTag(e){
    const map={Paro:'tag', 'Restricción':'tag r', Marcha:'tag m', Reparación:'tag', Avería:'tag'};
    return `<span class="${map[e.tipo]||'tag'}">${e.tipo} · ${e.horas||0}h · ${e.equipo||''}</span>`;
  }
  function collectByDay(y,m){
    const start = new Date(y,m,1).getTime();
    const end = new Date(y,m+1,1).getTime()-1;
    const bucket={};
    CDL_STORE.equipos.list().forEach(eq=>{
      CDL_STORE.eventos.list(eq.codigo).forEach(e=>{
        if(e.ts>=start && e.ts<=end){
          const d = new Date(e.ts).getDate();
          (bucket[d]||(bucket[d]=[])).push({...e, equipo:eq.codigo});
        }
      });
    });
    return bucket;
  }
  function render(){
    const title = base.toLocaleString(undefined, {month:'long', year:'numeric'});
    $('#calTitle').textContent = title.charAt(0).toUpperCase()+title.slice(1);
    const g=$('#calGrid'); g.innerHTML='';
    const y=base.getFullYear(), m=base.getMonth();
    const firstDay = new Date(y,m,1).getDay()||7; // lunes=1…dom=7
    const days = new Date(y,m+1,0).getDate();
    const data = collectByDay(y,m);
    // cabecera
    ['L','M','X','J','V','S','D'].forEach(d=>{
      const h=document.createElement('div'); h.style.fontWeight='900'; h.style.textAlign='center'; h.textContent=d; g.appendChild(h);
    });
    // huecos
    for(let i=1;i<firstDay;i++){ const sp=document.createElement('div'); g.appendChild(sp); }
    for(let d=1; d<=days; d++){
      const cell=document.createElement('div'); cell.className='day';
      cell.innerHTML=`<h4>${d}</h4>${(data[d]||[]).map(evToTag).join('')}`;
      g.appendChild(cell);
    }
  }
  $('#calPrev')?.addEventListener('click', ()=>{ base.setMonth(base.getMonth()-1); render(); });
  $('#calNext')?.addEventListener('click', ()=>{ base.setMonth(base.getMonth()+1); render(); });
  $('#calNew')?.addEventListener('click', ()=>location.hash='#/parada/nueva');
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
})();
</script>

<!-- =========================================================
BLOQUE 103 — Programar PARADA (form + guardado como evento futuro)
========================================================= -->
<section id="paradaView" class="cdl-container" hidden>
  <h2>Nueva parada programada</h2>
  <form id="paradaForm" class="evt-form" style="max-width:640px">
    <label>Equipo
      <select name="equipo" required id="paradaEq"></select>
    </label>
    <label>Fecha inicio <input type="datetime-local" name="inicio" required></label>
    <label>Duración (horas) <input type="number" step="0.1" min="0" name="dur" required></label>
    <label>Detalle <textarea name="detalle" rows="3"></textarea></label>
    <button class="btn-cdl" type="submit">Guardar</button>
  </form>
</section>
<script>
(function(){
  const $=s=>document.querySelector(s);
  function route(){
    const v=$('#paradaView'); if(!v) return;
    v.hidden = !(location.hash||'').startsWith('#/parada/nueva');
    if(!v.hidden) fill();
  }
  function fill(){
    const sel=$('#paradaEq'); sel.innerHTML='';
    CDL_STORE.equipos.list().forEach(eq=>{
      const o=document.createElement('option'); o.value=eq.codigo; o.textContent=`${eq.codigo} · ${eq.nombre}`; sel.appendChild(o);
    });
  }
  $('#paradaForm')?.addEventListener('submit', (e)=>{
    e.preventDefault();
    const fd=new FormData(e.target);
    const code=fd.get('equipo'); const inicio=new Date(fd.get('inicio')).getTime();
    const horas=Number(fd.get('dur')); const detalle=String(fd.get('detalle')||'Parada programada');
    CDL_STORE.eventos.push(code, {tipo:'Paro', horas, detalle, ts: inicio});
    cdlToast('Parada programada creada'); location.hash='#/calendario';
  });
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
})();
</script>

<!-- =========================================================
BLOQUE 104 — Recordatorios de paradas próximas (notificación local)
========================================================= -->
<script>
(function(){
  const HORIZON=6; // horas
  function check(){
    const now=Date.now(), soon=now+HORIZON*3600000;
    let hits=0;
    CDL_STORE.equipos.list().forEach(eq=>{
      CDL_STORE.eventos.list(eq.codigo).forEach(e=>{
        if(e.tipo==='Paro' && e.ts>now && e.ts<=soon) hits++;
      });
    });
    if(hits) cdlToast(`🗓️ ${hits} parada(s) en las próximas ${HORIZON}h`);
  }
  window.addEventListener('load', ()=>{ check(); setInterval(check, 10*60*1000); });
})();
</script>

<!-- =========================================================
BLOQUE 105 — Importación CSV / Google Sheets (URL CSV público)
========================================================= -->
<section id="importView" class="cdl-container" hidden>
  <h2>Importar datos</h2>
  <div class="evt-form" style="max-width:760px">
    <label>CSV (pegar texto)
      <textarea id="csvText" rows="6" placeholder="codigo;nombre;estado;horas_m;horas_r;horas_p;reparaciones;repuestos"></textarea>
    </label>
    <label>o URL CSV (Google Sheets &rarr; Archivo &rarr; Publicar en la Web)
      <input id="csvUrl" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv">
    </label>
    <div style="display:flex;gap:.5rem;flex-wrap:wrap">
      <button class="btn-cdl" id="impPreview">Previsualizar</button>
      <button class="btn-cdl" id="impApply" style="background:#111">Importar</button>
    </div>
    <div id="impTable" class="eq-table" style="margin-top:10px"></div>
  </div>
</section>
<script>
(function(){
  const $=s=>document.querySelector(s);
  function route(){
    const v=$('#importView'); if(!v) return;
    v.hidden = !(location.hash||'').startsWith('#/importar');
  }
  function parseCSV(txt){
    return txt.trim().split(/\r?\n/).map(line=>{
      const cols=[]; let cur='',q=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch==='"' ){ if(q && line[i+1]==='"'){ cur+='"'; i++; } else { q=!q; } }
        else if(ch===';' && !q){ cols.push(cur); cur=''; }
        else cur+=ch;
      }
      cols.push(cur);
      return cols;
    });
  }
  async function readInput(){
    const text=$('#csvText').value.trim();
    if(text) return parseCSV(text);
    const url=$('#csvUrl').value.trim();
    if(!url){ cdlToast('Pega CSV o indica una URL'); return []; }
    // Sin fetch cross-origin en entornos restringidos: intentamos usar <img> hack no viable; pedimos pegar.
    cdlToast('Para URL externa, descarga el CSV y pégalo arriba.');
    return [];
  }
  function preview(rows){
    if(!rows.length) return;
    const head = rows[0].map(h=>h.toLowerCase());
    const body = rows.slice(1);
    const tbl=document.createElement('table');
    tbl.innerHTML = `<thead><tr>${rows[0].map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>${
      body.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')
    }</tbody>`;
    const wrap=$('#impTable'); wrap.innerHTML=''; wrap.appendChild(tbl);
    wrap.dataset.head = JSON.stringify(head);
    wrap.dataset.body = JSON.stringify(body);
  }
  function apply(){
    const head=JSON.parse($('#impTable').dataset.head||'[]');
    const body=JSON.parse($('#impTable').dataset.body||'[]');
    if(!head.length){ cdlToast('Primero previsualiza'); return; }
    const idx=(name)=> head.indexOf(name);
    body.forEach(r=>{
      const item={
        codigo: r[idx('codigo')]||r[0],
        nombre: r[idx('nombre')]||'Equipo',
        estado: r[idx('estado')]||'Restricciones',
        horas: { m:+(r[idx('horas_m')]||0), r:+(r[idx('horas_r')]||0), p:+(r[idx('horas_p')]||0) },
        reparaciones: +(r[idx('reparaciones')]||0),
        repuestos: +(r[idx('repuestos')]||0)
      };
      CDL_STORE.equipos.upsert(item);
    });
    cdlToast('Importación aplicada'); location.hash='#/equipos';
  }
  $('#impPreview')?.addEventListener('click', async()=> preview(await readInput()));
  $('#impApply')?.addEventListener('click', apply);
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
})();
</script>

<!-- =========================================================
BLOQUE 106 — Consolidación: combinar duplicados por código
========================================================= -->
<script>
(function(){
  window.cdlMergeDuplicados = function(){
    const list = CDL_STORE.equipos.list();
    const map=new Map();
    list.forEach(e=>{ 
      const k=e.codigo; 
      const cur=map.get(k);
      if(!cur) map.set(k, {...e});
      else{
        // merge básico: suma horas/repuestos y conserva "peor" estado
        const rank={'En marcha':0,'Restricciones':1,'Parada':2};
        const horas={m:(cur.horas?.m||0)+(e.horas?.m||0), r:(cur.horas?.r||0)+(e.horas?.r||0), p:(cur.horas?.p||0)+(e.horas?.p||0)};
        const estado = (rank[cur.estado||'Restricciones']>=rank[e.estado||'Restricciones'])?cur.estado:e.estado;
        map.set(k, {...cur, ...e, horas, estado, repuestos:(+cur.repuestos||0)+(+e.repuestos||0), reparaciones:(+cur.reparaciones||0)+(+e.reparaciones||0) });
      }
    });
    localStorage.setItem('cdl-equipos', JSON.stringify(Array.from(map.values())));
    cdlToast('Consolidación completada');
  };
})();
</script>

<!-- =========================================================
BLOQUE 107 — Reporte imprimible (PDF) por equipo
========================================================= -->
<style>
  #reportView{padding-top:8px}
  .rep-grid{display:grid;grid-template-columns:1fr;gap:10px}
  .rep-box{border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff}
  @media(min-width:960px){ .rep-grid{grid-template-columns:1.2fr .8fr} }
  @media print{
    #cdlHeader,#pagesPanel,#panelBackdrop,.btn-cdl{display:none!important}
    #reportView{display:block!important}
  }
</style>
<section id="reportView" class="cdl-container" hidden>
  <h2>Reporte del equipo</h2>
  <div class="rep-grid">
    <div class="rep-box">
      <h3 id="repName">Equipo</h3>
      <div id="repKPIs" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px"></div>
      <div style="margin-top:10px" class="eq-table"><div id="repTable"></div></div>
    </div>
    <div class="rep-box">
      <h3>QR</h3>
      <div id="repQR" class="eq-qr-big"></div>
      <button class="btn-cdl" onclick="window.print()">Imprimir / PDF</button>
    </div>
  </div>
</section>
<script>
(function(){
  const $=s=>document.querySelector(s);
  function route(){
    const h=location.hash||'';
    const v=$('#reportView'); if(!v) return;
    if(h.startsWith('#/reporte/')){
      v.hidden=false;
      const code=decodeURIComponent(h.split('/')[2]||'');
      build(code);
    }else v.hidden=true;
  }
  function build(code){
    const eq = CDL_STORE.equipos.list().find(e=>e.codigo===code);
    if(!eq){ cdlToast('Equipo no encontrado'); location.hash='#/equipos'; return; }
    $('#repName').textContent = `${eq.nombre} · #${eq.codigo}`;
    const ev = CDL_STORE.eventos.list(eq.codigo);
    const hm = (eq.horas?.m||0) + ev.filter(e=>e.tipo==='Marcha').reduce((a,b)=>a+(+b.horas||0),0);
    const hr = (eq.horas?.r||0) + ev.filter(e=>e.tipo==='Restricción').reduce((a,b)=>a+(+b.horas||0),0);
    const hp = (eq.horas?.p||0) + ev.filter(e=>e.tipo==='Paro').reduce((a,b)=>a+(+b.horas||0),0);
    const tot = Math.max(1, hm+hr+hp), dispo = (hm/tot*100).toFixed(1)+'%';
    const rp = (eq.reparaciones||0) + ev.filter(e=>e.tipo==='Reparación').length;
    const mtbf = (hm/Math.max(1,rp)).toFixed(1)+'h';
    const KPIS=[['Horas marcha',hm+'h'],['Restricciones',hr+'h'],['Paro',hp+'h'],['Reparaciones',rp],['Disponibilidad',dispo],['MTBF',mtbf]];
    const box=$('#repKPIs'); box.innerHTML='';
    KPIS.forEach(k=>{
      const d=document.createElement('div'); d.className='kpi'; d.innerHTML=`<b>${k[1]}</b><span>${k[0]}</span>`; box.appendChild(d);
    });
    const tbl=document.createElement('table');
    tbl.innerHTML=`<thead><tr><th>Fecha</th><th>Tipo</th><th>Horas</th><th>Coste €</th><th>Detalle</th></tr></thead><tbody>${
      ev.map(e=>`<tr><td>${new Date(e.ts).toLocaleString()}</td><td>${e.tipo}</td><td>${e.horas||''}</td><td>${e.coste||''}</td><td>${(e.detalle||'').replace(/</g,'&lt;')}</td></tr>`).join('')
    }</tbody>`;
    const wrap=$('#repTable'); wrap.innerHTML=''; wrap.appendChild(tbl);
    const url = location.origin+location.pathname+'#/equipo/'+encodeURIComponent(eq.codigo);
    qrMake($('#repQR'), url, 180);
  }
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
})();
</script>

<!-- =========================================================
BLOQUE 108 — Panel KPI global (resumen planta/CDL)
========================================================= -->
<section id="kpiGlobalView" class="cdl-container" hidden>
  <h2>KPIs globales</h2>
  <div id="kpiGlobalCards" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px"></div>
</section>
<script>
(function(){
  const $=s=>document.querySelector(s);
  function route(){
    const v=$('#kpiGlobalView'); if(!v) return;
    v.hidden = !(location.hash||'').startsWith('#/kpi');
    if(!v.hidden) render();
  }
  function render(){
    const L=CDL_STORE.equipos.list();
    const S={m:0,r:0,p:0, rep:0, coste:0};
    L.forEach(eq=>{
      const ev=CDL_STORE.eventos.list(eq.codigo);
      S.m += (eq.horas?.m||0) + ev.filter(e=>e.tipo==='Marcha').reduce((a,b)=>a+(+b.horas||0),0);
      S.r += (eq.horas?.r||0) + ev.filter(e=>e.tipo==='Restricción').reduce((a,b)=>a+(+b.horas||0),0);
      S.p += (eq.horas?.p||0) + ev.filter(e=>e.tipo==='Paro').reduce((a,b)=>a+(+b.horas||0),0);
      S.rep += (eq.reparaciones||0) + ev.filter(e=>e.tipo==='Reparación').length;
      S.coste += ev.reduce((a,b)=>a+(+b.coste||0), (+eq.repuestos||0));
    });
    const tot=Math.max(1,S.m+S.r+S.p), dispo=(S.m/tot*100).toFixed(1)+'%';
    const cards=[
      ['Disponibilidad',dispo],['Horas marcha',S.m.toFixed(1)],['Horas restr.',S.r.toFixed(1)],
      ['Horas paro',S.p.toFixed(1)],['Reparaciones',S.rep],['Coste repuestos €',S.coste.toFixed(2)]
    ];
    const grid=$('#kpiGlobalCards'); grid.innerHTML='';
    cards.forEach(c=>{
      const d=document.createElement('div'); d.className='kpi'; d.innerHTML=`<b>${c[1]}</b><span>${c[0]}</span>`; grid.appendChild(d);
    });
  }
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
})();
</script>

<!-- =========================================================
BLOQUE 109 — Backup/Restore JSON + Reset demo
========================================================= -->
<section id="backupView" class="cdl-container" hidden>
  <h2>Copia de seguridad</h2>
  <div style="display:flex;gap:.5rem;flex-wrap:wrap">
    <button class="btn-cdl" id="bkExport">Exportar JSON</button>
    <label class="btn-cdl" style="background:#111;display:inline-grid;place-items:center;cursor:pointer">
      Importar JSON
      <input id="bkImport" type="file" accept="application/json" style="display:none">
    </label>
    <button class="btn-cdl" id="bkReset" style="background:#111">Reset demo</button>
  </div>
</section>
<script>
(function(){
  const $=s=>document.querySelector(s);
  function route(){
    const v=$('#backupView'); if(!v) return;
    v.hidden = !(location.hash||'').startsWith('#/backup');
  }
  $('#bkExport')?.addEventListener('click', ()=>{
    const data={
      equipos: CDL_STORE.equipos.list(),
      eventos: CDL_STORE.equipos.list().reduce((acc,eq)=>{ acc[eq.codigo]=CDL_STORE.eventos.list(eq.codigo); return acc; }, {})
    };
    const a=document.createElement('a');
    a.download='cdl-backup.json';
    a.href=URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'}));
    a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500);
  });
  $('#bkImport')?.addEventListener('change', async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    const txt=await f.text(); const data=JSON.parse(txt);
    if(Array.isArray(data.equipos)) localStorage.setItem('cdl-equipos', JSON.stringify(data.equipos));
    if(data.eventos && typeof data.eventos==='object'){
      Object.entries(data.eventos).forEach(([k,v])=>localStorage.setItem('cdl-evt-'+k, JSON.stringify(v||[])));
    }
    cdlToast('Backup restaurado'); location.hash='#/equipos';
  });
  $('#bkReset')?.addEventListener('click', ()=>{
    if(!confirm('¿Seguro que quieres resetear los datos de demo?')) return;
    ['EQ-001','EQ-002','EQ-003'].forEach(k=>localStorage.removeItem('cdl-evt-'+k));
    localStorage.removeItem('cdl-equipos');
    cdlToast('Demo reseteada'); location.reload();
  });
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
})();
</script>
<!-- =========================================================
BLOQUE 110 — Perfiles de usuario + permisos (lectura/escritura)
========================================================= -->
<script>
(function(){
  // Roles sugeridos: 'Operario' (solo lectura parcial), 'Mantenimiento' (edita eventos/estado), 'Supervisor' (todo)
  const DEF = { name:'Invitado', role:'Operario' };
  const KEY='cdl-user';
  const current = (()=>{ try{return JSON.parse(localStorage.getItem(KEY))||DEF}catch{return DEF} })();
  window.CDL_USER = {
    get: ()=>current,
    set: (obj)=>{ Object.assign(current,obj); localStorage.setItem(KEY, JSON.stringify(current)); renderBadge(); },
    can: (action)=>{
      const role=current.role||'Operario';
      const matrix={
        ver: ['Operario','Mantenimiento','Supervisor'],
        editar_estado: ['Mantenimiento','Supervisor'],
        crear_eventos: ['Mantenimiento','Supervisor'],
        administrar: ['Supervisor']
      };
      return (matrix[action]||[]).includes(role);
    }
  };
  function renderBadge(){
    const el=document.getElementById('userRole');
    if(el) el.textContent = `${current.role||'Operario'}`;
  }
  window.addEventListener('load', renderBadge);
})();
</script>

<!-- =========================================================
BLOQUE 111 — UI de usuario (selector simple de rol + nombre)
========================================================= -->
<section id="userView" class="cdl-container" hidden>
  <h2>Perfil de usuario</h2>
  <form id="userForm" class="evt-form" style="max-width:520px">
    <label>Nombre <input name="name" placeholder="Tu nombre"></label>
    <label>Rol
      <select name="role">
        <option>Operario</option>
        <option>Mantenimiento</option>
        <option>Supervisor</option>
      </select>
    </label>
    <button class="btn-cdl" type="submit">Guardar</button>
  </form>
  <p style="color:#6b7280;margin-top:8px">El rol controla permisos de edición (estado de equipos, alta de eventos, administración).</p>
</section>
<script>
(function(){
  const $=s=>document.querySelector(s);
  function route(){
    const v=$('#userView'); if(!v) return;
    v.hidden = !(location.hash||'').startsWith('#/usuario');
    if(!v.hidden){
      const u=CDL_USER.get();
      const f=$('#userForm');
      f.name.value=u.name||'';
      f.role.value=u.role||'Operario';
    }
  }
  $('#userForm')?.addEventListener('submit',(e)=>{
    e.preventDefault();
    const fd=new FormData(e.target);
    CDL_USER.set({name:String(fd.get('name')||'Invitado'), role:String(fd.get('role')||'Operario')});
    cdlToast('Perfil actualizado');
    location.hash='#/equipos';
  });
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
})();
</script>

<!-- =========================================================
BLOQUE 112 — Guardas de permisos en UI (botones y semáforo)
========================================================= -->
<script>
(function(){
  function lockUI(){
    const canState = CDL_USER.can('editar_estado');
    const canEvt = CDL_USER.can('crear_eventos');
    // Deshabilitar botones de semáforo y formularios de evento si no hay permiso
    document.querySelectorAll('.cdl-sem .btn').forEach(b=> b.disabled = !canState );
    const evtForm=document.getElementById('evtForm'); if(evtForm) evtForm.querySelectorAll('input,select,textarea,button').forEach(el=> el.disabled=!canEvt);
  }
  window.addEventListener('load', lockUI);
  window.addEventListener('hashchange', ()=> setTimeout(lockUI, 60));
  // Hook a mountSemaforo para que respete permisos cuando se creen nuevos
  const __mount=window.mountSemaforo;
  window.mountSemaforo = function(host, opts){
    __mount(host, opts);
    if(!CDL_USER.can('editar_estado')){
      host.querySelectorAll('.btn').forEach(b=> b.disabled = true);
    }
  };
})();
</script>

<!-- =========================================================
BLOQUE 113 — Auditoría (log central de acciones)
========================================================= -->
<section id="auditView" class="cdl-container" hidden>
  <h2>Auditoría</h2>
  <div class="eq-table" id="auditTable" style="margin-top:8px"></div>
  <div style="margin-top:8px;display:flex;gap:.5rem">
    <button id="auditExport" class="btn-cdl">Exportar CSV</button>
    <button id="auditClear" class="btn-cdl" style="background:#111">Vaciar</button>
  </div>
</section>
<script>
(function(){
  const KEY='cdl-audit';
  function read(){ try{return JSON.parse(localStorage.getItem(KEY))||[]}catch{return[]} }
  function write(a){ try{localStorage.setItem(KEY, JSON.stringify(a))}catch{} }
  window.CDL_AUDIT = {
    push: (evt)=>{
      const list=read();
      list.unshift({...evt, ts: evt.ts||Date.now()});
      write(list);
    },
    list: ()=>read(),
    clear: ()=>write([])
  };
  // Hooks: setEquipoEstado y pushEvt para registrar log
  const _set=window.setEquipoEstado;
  window.setEquipoEstado = async function(codigo, estado){
    if(!CDL_USER.can('editar_estado')){ cdlToast('Sin permiso para cambiar estado'); return; }
    await _set(codigo, estado);
    CDL_AUDIT.push({tipo:'Estado', equipo:codigo, detalle:`Nuevo estado: ${estado}`, user: (CDL_USER.get().name||'') });
  };
  const _pushEvt = (code, evt)=> CDL_STORE.eventos.push(code, evt);
  window.addEventListener('load', ()=>{
    // interceptar form evento existente
    const form=document.getElementById('evtForm');
    if(form){
      const orig=form.onsubmit;
      form.addEventListener('submit', ()=> {
        const u=CDL_USER.get();
        CDL_AUDIT.push({tipo:'Evento', equipo:document.getElementById('eqMeta')?.textContent||'', detalle:'Alta de evento', user:u.name||''});
      }, {once:false});
      if(typeof orig==='function') form.onsubmit=orig;
    }
  });

  function route(){
    const v=document.getElementById('auditView'); if(!v) return;
    v.hidden = !(location.hash||'').startsWith('#/auditoria');
    if(!v.hidden) render();
  }
  function render(){
    const data=CDL_AUDIT.list();
    const tbl=document.createElement('table');
    tbl.innerHTML=`<thead><tr><th>Fecha</th><th>Usuario</th><th>Equipo</th><th>Tipo</th><th>Detalle</th></tr></thead><tbody>${
      data.map(e=>`<tr><td>${new Date(e.ts).toLocaleString()}</td><td>${(e.user||'')}</td><td>${e.equipo||''}</td><td>${e.tipo}</td><td>${(e.detalle||'').replace(/</g,'&lt;')}</td></tr>`).join('')
    }</tbody>`;
    const wrap=document.getElementById('auditTable'); wrap.innerHTML=''; wrap.appendChild(tbl);
  }
  document.getElementById('auditExport')?.addEventListener('click', ()=>{
    const rows=[['fecha','usuario','equipo','tipo','detalle']].concat(
      CDL_AUDIT.list().map(e=>[new Date(e.ts).toISOString(), e.user||'', e.equipo||'', e.tipo||'', (e.detalle||'').replace(/\n/g,' ')])
    );
    const csv=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(';')).join('\n');
    const a=document.createElement('a'); a.download='cdl-auditoria.csv'; a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.click();
  });
  document.getElementById('auditClear')?.addEventListener('click', ()=>{ if(CDL_USER.can('administrar')){ CDL_AUDIT.clear(); cdlToast('Auditoría vaciada'); route(); } else cdlToast('Solo Supervisor puede vaciar'); });
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
})();
</script>

<!-- =========================================================
BLOQUE 114 — Checklist de Mantenimiento Preventivo (plantillas)
========================================================= -->
<section id="pmView" class="cdl-container" hidden>
  <h2>Preventivo</h2>
  <div class="evt-form" style="max-width:860px">
    <label>Equipo
      <select id="pmEq"></select>
    </label>
    <label>Plantilla
      <select id="pmTpl">
        <option value="basico">Básico mensual</option>
        <option value="prensa">Prensa · Seguridad</option>
        <option value="corte">Corte · Lubricación</option>
      </select>
    </label>
    <button class="btn-cdl" id="pmCreate">Crear checklist</button>
  </div>
  <div id="pmList" style="margin-top:10px"></div>
</section>
<style>
  .pm-card{border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:10px;margin:8px 0}
  .pm-item{display:flex;align-items:center;gap:.5rem;margin:.25rem 0}
  .pm-item input[type=checkbox]{width:18px;height:18px}
  .pm-badge{border:1px solid #e5e7eb;border-radius:999px;padding:.15rem .45rem;font-size:.75rem}
</style>
<script>
(function(){
  const KEY = (eq)=>'cdl-pm-'+eq;
  const TPLS = {
    basico:['Limpieza general','Apriete de tornillería','Comprobación de sensores','Verificación de protecciones'],
    prensa:['Prueba de seta emergencia','Verificar barreras fotoeléctricas','Inspección fugas hidráulicas','Chequeo vibraciones'],
    corte:['Nivel y cambio aceite','Engrase guías','Estado de correas','Alineación cabezal']
  };
  const $=s=>document.querySelector(s);
  function route(){
    const v=$('#pmView'); if(!v) return;
    v.hidden = !(location.hash||'').startsWith('#/preventivo');
    if(!v.hidden) init();
  }
  function init(){
    const sel=$('#pmEq'); sel.innerHTML='';
    CDL_STORE.equipos.list().forEach(e=>{ const o=document.createElement('option'); o.value=e.codigo; o.textContent=`${e.codigo} · ${e.nombre}`; sel.appendChild(o); });
    renderList(sel.value);
  }
  function read(eq){ try{return JSON.parse(localStorage.getItem(KEY(eq)))||[]}catch{return[]} }
  function write(eq, data){ localStorage.setItem(KEY(eq), JSON.stringify(data)); }
  function renderList(eq){
    const mount=$('#pmList'); mount.innerHTML='';
    const data=read(eq);
    if(!data.length){ mount.innerHTML='<p style="color:#6b7280">Sin checklists. Crea uno con la plantilla.</p>'; return; }
    data.forEach((c,i)=>{
      const card=document.createElement('div'); card.className='pm-card';
      const doneCount=c.items.filter(x=>x.ok).length;
      card.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center">
        <b>${c.titulo}</b>
        <span class="pm-badge">${doneCount}/${c.items.length} hechos</span>
      </div>
      <div>${c.items.map((it,j)=>`
        <label class="pm-item">
          <input type="checkbox" ${it.ok?'checked':''} data-i="${i}" data-j="${j}">
          <span>${it.txt}</span>
        </label>`).join('')}
      </div>
      <div style="display:flex;gap:.5rem;margin-top:6px">
        <button class="btn-cdl" data-print="${i}">Imprimir</button>
        <button class="btn-cdl" style="background:#111" data-close="${i}">Cerrar checklist</button>
      </div>`;
      mount.appendChild(card);
    });
    // Interacciones
    mount.querySelectorAll('input[type=checkbox]').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        const i=+cb.dataset.i, j=+cb.dataset.j;
        const d=read(eq); d[i].items[j].ok=cb.checked; d[i].items[j].ts=Date.now(); write(eq,d);
      });
    });
    mount.querySelectorAll('button[data-print]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const i=+btn.dataset.print; const d=read(eq)[i];
        const a=document.createElement('a'); const rows=d.items.map(x=>`${x.ok?'[x]':'[ ]'} ${x.txt}`).join('\n');
        const blob=new Blob([`Checklist: ${d.titulo}\nEquipo: ${eq}\n\n${rows}`],{type:'text/plain'});
        a.href=URL.createObjectURL(blob); a.download=`checklist-${eq}.txt`; a.click();
      });
    });
    mount.querySelectorAll('button[data-close]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const i=+btn.dataset.close; const d=read(eq);
        // Al cerrar, registramos un evento de "Reparación" / "Marcha" simbólico con coste 0
        CDL_STORE.eventos.push(eq, {tipo:'Reparación', horas:0, coste:0, detalle:`Cierre PM: ${d[i].titulo}`});
        d.splice(i,1); write(eq,d); renderList(eq); cdlToast('Checklist cerrado');
      });
    });
  }
  document.getElementById('pmCreate')?.addEventListener('click', ()=>{
    const eq=$('#pmEq').value; const tpl=$('#pmTpl').value||'basico';
    const d=read(eq); d.unshift({ titulo:`${tpl.toUpperCase()} · ${new Date().toLocaleDateString()}`, items: TPLS[tpl].map(t=>({txt:t, ok:false})) });
    write(eq,d); renderList(eq);
  });
  document.getElementById('pmEq')?.addEventListener('change', (e)=>renderList(e.target.value));
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
})();
</script>
<!-- =========================================================
BLOQUE 116 — Accesos de navegación rápida (añadir a menú lateral)
========================================================= -->
<script>
(function(){
  window.addEventListener('load', ()=>{
    const nav=document.querySelector('.cdl-panel__nav');
    if(!nav) return;
    const links=[
      ['Calendario','#/calendario'],
      ['Nueva parada','#/parada/nueva'],
      ['Preventivo','#/preventivo'],
      ['Auditoría','#/auditoria'],
      ['Importar','#/importar'],
      ['KPIs globales','#/kpi'],
      ['Backup','#/backup'],
      ['Perfil','#/usuario']
    ];
    links.forEach(([t,href])=>{
      if(!nav.querySelector(`a[href="${href}"]`)){
        const a=document.createElement('a'); a.href=href; a.textContent=t; nav.appendChild(a);
      }
    });
  });
})();
</script>

<!-- =========================================================
BLOQUE 117 — Filtro por rol en vistas (ocultar acciones)
========================================================= -->
<script>
(function(){
  const hideMap = [
    ['#/parada/nueva','crear_eventos'],
    ['#/importar','administrar'],
    ['#/backup','administrar'],
    ['#/auditoria','ver'] // visible a todos, pero limpiar solo supervisor (ya controlado)
  ];
  function guard(){
    const h=location.hash||'';
    const entry = hideMap.find(([p])=> h.startsWith(p));
    if(!entry) return;
    const action=entry[1];
    if(!CDL_USER.can(action)){
      cdlToast('Acceso restringido por rol');
      location.hash='#/equipos';
    }
  }
  window.addEventListener('hashchange', guard);
  window.addEventListener('load', guard);
})();
</script>

<!-- =========================================================
BLOQUE 118 — Accesibilidad: atajos teclado + foco en main
========================================================= -->
<script>
(function(){
  window.addEventListener('load', ()=>{
    // Foco a main al navegar
    const main=document.getElementById('main');
    window.addEventListener('hashchange', ()=> main?.focus({preventScroll:true}));
    // Atajos: g e (equipos), g k (kpi), g t (tv), g u (usuario)
    let lastG=0;
    window.addEventListener('keydown', (e)=>{
      if(e.key.toLowerCase()==='g'){ lastG=Date.now(); return; }
      if(Date.now()-lastG<800){
        const k=e.key.toLowerCase();
        if(k==='e') location.hash='#/equipos';
        if(k==='k') location.hash='#/kpi';
        if(k==='t') location.hash='#/tv';
        if(k==='u') location.hash='#/usuario';
        lastG=0;
      }
    });
  });
})();
</script>

<!-- =========================================================
BLOQUE 119 — Pulido visual menor + placeholder 404 de rutas
========================================================= -->
<section id="notFound" class="cdl-container" hidden>
  <h2>Sección no encontrada</h2>
  <p style="color:#6b7280">La ruta solicitada no existe. Usa el menú para navegar.</p>
</section>
<script>
(function(){
  // Extiende router existente para mostrar 404 si la hash no coincide con vistas soportadas
  const views=['#/equipos','#/equipo/','#/tv','#/calendario','#/parada/nueva','#/preventivo','#/auditoria','#/importar','#/kpi','#/backup','#/usuario'];
  function check404(){
    const h=location.hash||'#/equipos';
    const ok = views.some(v=> h.startsWith(v));
    const nf=document.getElementById('notFound');
    if(nf) nf.hidden = ok;
  }
  window.addEventListener('hashchange', check404);
  window.addEventListener('load', check404);
})();
</script>

<!-- =========================================================
BLOQUE 120 — Puente de datos global (CDL_STORE) + utilidades
========================================================= -->
<script>
(function(){
  if(window.CDL_STORE) return;
  // Reutiliza las funciones existentes del router/ficha (loadEquipos, saveEquipos, loadEvt, pushEvt)
  const _has = (k)=> typeof window[k] === 'function';
  const _getEquipos = ()=> _has('loadEquipos') ? loadEquipos() : JSON.parse(localStorage.getItem('cdl-equipos')||'[]');
  const _setEquipos = (arr)=> _has('saveEquipos') ? saveEquipos(arr) : localStorage.setItem('cdl-equipos', JSON.stringify(arr));
  const _loadEvt = (c)=> (_has('loadEvt') ? loadEvt(c) : JSON.parse(localStorage.getItem('cdl-evt-'+c)||'[]'));
  const _pushEvt = (c, e)=>{
    const k='cdl-evt-'+c; const arr=_loadEvt(c); arr.unshift({...e, ts:e.ts||Date.now()});
    localStorage.setItem(k, JSON.stringify(arr));
  };
  window.CDL_STORE = {
    equipos: {
      list: ()=> _getEquipos(),
      get: (code)=> _getEquipos().find(e=>e.codigo===code),
      upsert: (obj)=>{
        const L=_getEquipos(); const i=L.findIndex(e=>e.codigo===obj.codigo);
        if(i>=0) L[i]={...L[i],...obj}; else L.unshift(obj);
        _setEquipos(L);
      }
    },
    eventos: {
      list: (code)=> _loadEvt(code),
      push: (code, evt)=> _pushEvt(code, evt)
    },
    repuestos: {
      list: ()=> JSON.parse(localStorage.getItem('cdl-repuestos')||'[]'),
      set: (arr)=> localStorage.setItem('cdl-repuestos', JSON.stringify(arr))
    }
  };
  // Toast mínimo reutilizable
  window.cdlToast = function(msg){
    let el=document.getElementById('cdlToast'); 
    if(!el){ el=document.createElement('div'); el.id='cdlToast'; document.body.appendChild(el);
      el.style.cssText='position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:#fff;padding:.55rem .8rem;border-radius:999px;z-index:9999;font-weight:800';
    }
    el.textContent=msg; el.style.opacity='1'; clearTimeout(el._t); el._t=setTimeout(()=>el.style.opacity='0', 1800);
  };
})();
</script>

<!-- =========================================================
BLOQUE 121 — Exportación a PDF de la ficha (encabezado con logos)
========================================================= -->
<style>
  @media print{
    @page{ margin:18mm 14mm; }
    body:before{
      content:''; position:fixed; top:12mm; left:14mm; right:14mm; height:48px;
      background: url('./logo-cdl.png') left center / auto 36px no-repeat,
                  url('./logo_mantenimiento.png') right center / auto 36px no-repeat;
    }
  }
</style>
<script>
(function(){
  window.exportFichaPDF = function(){
    if(!location.hash.startsWith('#/equipo/')){ cdlToast('Abre una ficha de equipo'); return; }
    window.print(); // El @media print ya maqueta logos y oculta resto
  };
})();
</script>
<!-- Botón adicional (opcional) — colócalo donde quieras -->
<!-- <button class="btn-cdl" onclick="exportFichaPDF()">Exportar PDF</button> -->

<!-- =========================================================
BLOQUE 122 — OEE (beta) en ficha de equipo
========================================================= -->
<style>
  .kpi.oee b{ font-size:1.25rem }
</style>
<script>
(function(){
  // Extiende calcKPIs existente con A,P,Q y OEE. Supuestos: P=100%, Q=100% salvo params.
  const _calc = window.calcKPIs;
  window.calcKPIs = function(eq){
    const base=_calc? _calc(eq) : {horas:{m:0,r:0,p:0}, dispo:0, mtbf:0, reparaciones:0};
    const total = (base.horas.m+base.horas.r+base.horas.p)||1;
    const A = base.horas.m/total; // disponibilidad
    const P = Math.max(0, Math.min(1, (eq.params?.performance||1))); // 1 = 100%
    const Q = Math.max(0, Math.min(1, (eq.params?.quality||1)));     // 1 = 100%
    const OEE = A*P*Q;
    return {...base, A,P,Q,OEE};
  };
  // Hook de render en ficha para pintar KPIs OEE
  const _showEquipo = window.showEquipo;
  window.showEquipo = function(code){
    _showEquipo(code);
    const eq = CDL_STORE.equipos.get(code); if(!eq) return;
    const k = calcKPIs(eq);
    const left = document.querySelector('.eq-detail__left > div[style*="grid"]');
    if(left && !document.getElementById('kpi-oee')){
      const tpl = document.createElement('div');
      tpl.innerHTML = `
        <div class="kpi oee"><b id="kpi-oee">${(k.OEE*100).toFixed(1)}%</b><span>OEE</span></div>
        <div class="kpi"><b id="kpi-a">${(k.A*100).toFixed(1)}%</b><span>Disponibilidad (A)</span></div>
        <div class="kpi"><b id="kpi-p">${(k.P*100).toFixed(1)}%</b><span>Rendimiento (P)</span></div>
        <div class="kpi"><b id="kpi-q">${(k.Q*100).toFixed(1)}%</b><span>Calidad (Q)</span></div>`;
      left.appendChild(tpl.firstElementChild); left.appendChild(tpl.children[0]); left.appendChild(tpl.children[0]); left.appendChild(tpl.children[0]);
    } else {
      document.getElementById('kpi-oee').textContent = (k.OEE*100).toFixed(1)+'%';
      document.getElementById('kpi-a').textContent = (k.A*100).toFixed(1)+'%';
      document.getElementById('kpi-p').textContent = (k.P*100).toFixed(1)+'%';
      document.getElementById('kpi-q').textContent = (k.Q*100).toFixed(1)+'%';
    }
  };
})();
</script>

<!-- =========================================================
BLOQUE 123 — Buscador avanzado (estado + rango código + horas)
========================================================= -->
<style>
  .cdl-adv{display:grid;grid-template-columns:1fr;gap:.4rem;padding:10px 16px;border-top:1px solid var(--cdl-line)}
  .cdl-adv input,.cdl-adv select{height:36px;border:1px solid #e5e7eb;border-radius:10px;padding:0 .6rem}
  @media(min-width:480px){ .cdl-adv{grid-template-columns:repeat(4,1fr)} }
</style>
<div id="advSearch" class="cdl-adv" hidden>
  <input id="fCod" placeholder="Código contiene…">
  <select id="fEstado">
    <option value="">Estado (todos)</option>
    <option>En marcha</option><option>Restricciones</option><option>Parada</option>
  </select>
  <input id="fHmin" type="number" min="0" step="1" placeholder="Horas mín. marcha">
  <button class="btn-cdl" id="fApply">Filtrar</button>
</div>
<script>
(function(){
  // Mostrar controles en el panel lateral (debajo de búsqueda simple)
  window.addEventListener('load', ()=>{
    const panel = document.querySelector('.cdl-panel'); const adv=document.getElementById('advSearch');
    if(panel && adv && !panel.querySelector('#advSearch')) panel.appendChild(adv), adv.hidden=false;
  });
  // Hook al render de equipos
  const _render = window.renderEquipos;
  window.renderEquipos = function(list, q){
    const cod = (document.getElementById('fCod')?.value||'').toLowerCase();
    const est = document.getElementById('fEstado')?.value||'';
    const hmin = +((document.getElementById('fHmin')?.value)||0);
    const filtered = list.filter(eq=>{
      const byQ = !q || eq.nombre.toLowerCase().includes((q||'').toLowerCase()) || String(eq.codigo).includes(q);
      const byCod = !cod || String(eq.codigo).toLowerCase().includes(cod);
      const byEst = !est || eq.estado===est;
      const hm = (eq.horas?.m||0) + CDL_STORE.eventos.list(eq.codigo).filter(e=>e.tipo==='Marcha').reduce((a,b)=>a+(+b.horas||0),0);
      const byH = !hmin || hm>=hmin;
      return byQ && byCod && byEst && byH;
    });
    _render(filtered, q);
  };
  document.getElementById('fApply')?.addEventListener('click', ()=>{
    const h=location.hash; if(!h.startsWith('#/equipos')) location.hash='#/equipos'; else window.dispatchEvent(new HashChangeEvent('hashchange'));
  });
})();
</script>

<!-- =========================================================
BLOQUE 124 — Adjuntos de fotos en eventos (+visor)
========================================================= -->
<style>
  .eq-photos{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .eq-photos img{width:70px;height:70px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb;cursor:zoom-in}
  .ph-modal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:grid;place-items:center;z-index:1200}
  .ph-modal img{max-width:92vw;max-height:92vh;border-radius:8px}
</style>
<script>
(function(){
  // Añade campo de adjunto al form existente
  window.addEventListener('load', ()=>{
    const f=document.getElementById('evtForm'); if(!f || f.querySelector('input[type=file]')) return;
    const lbl=document.createElement('label'); lbl.textContent='Fotos (opcional) ';
    const inp=document.createElement('input'); inp.type='file'; inp.accept='image/*'; inp.multiple=true; inp.name='fotos';
    lbl.appendChild(inp); f.insertBefore(lbl, f.querySelector('button[type=submit]'));
  });
  // Extiende pushEvt para guardar fotos como dataURL (localStorage)
  const toDataUrls = (files)=> Promise.all(Array.from(files||[]).slice(0,6).map(f=> new Promise(res=>{
    const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f);
  })));
  const _showEquipo = window.showEquipo;
  window.showEquipo = async function(code){
    _showEquipo(code);
    // Render miniaturas encima de tabla historial
    const cont=document.getElementById('eqTable')?.previousElementSibling;
    if(cont && !cont.nextSibling?.classList?.contains('eq-photos')){
      const ph=document.createElement('div'); ph.className='eq-photos'; ph.id='eqPhotos'; cont.parentNode.insertBefore(ph, cont.nextSibling);
    }
    const photos = CDL_STORE.eventos.list(code).flatMap(e=> e._photos||[]);
    const ph=document.getElementById('eqPhotos'); if(ph){ ph.innerHTML=photos.map(src=>`<img src="${src}" alt="foto">`).join(''); bindModal(ph); }
    // intercepta form para adjuntar
    const f=document.getElementById('evtForm');
    if(!f._hasHook){
      f.addEventListener('submit', async ()=>{
        const fd=new FormData(f);
        const files = f.querySelector('input[type=file]')?.files;
        const imgs = await toDataUrls(files);
        if(imgs.length){
          const arr=CDL_STORE.eventos.list(code); if(arr.length){ arr[0]._photos=(arr[0]._photos||[]).concat(imgs); localStorage.setItem('cdl-evt-'+code, JSON.stringify(arr)); }
        }
      });
      f._hasHook=true;
    }
  };
  function bindModal(root){
    root.querySelectorAll('img').forEach(img=>{
      img.addEventListener('click', ()=>{
        const m=document.createElement('div'); m.className='ph-modal'; m.innerHTML=`<img src="${img.src}" alt=""><button aria-label="Cerrar" style="position:fixed;top:14px;right:14px;width:42px;height:42px;border-radius:10px;border:0;background:#fff">✕</button>`;
        m.addEventListener('click', ()=>document.body.removeChild(m));
        document.body.appendChild(m);
      });
    });
  }
})();
</script>

<!-- =========================================================
BLOQUE 125 — Repuestos (inventario, movimientos y enlace a equipos)
========================================================= -->
<section id="sparesView" class="cdl-container" hidden>
  <h2>Repuestos</h2>
  <div class="evt-form" style="max-width:980px">
    <label>Ref. <input id="spRef"></label>
    <label>Descripción <input id="spDesc"></label>
    <label>Stock <input id="spStock" type="number" step="1" min="0"></label>
    <label>€ Unidad <input id="spCost" type="number" step="0.01" min="0"></label>
    <button class="btn-cdl" id="spAdd">Añadir / Actualizar</button>
  </div>
  <div class="eq-table" style="margin-top:10px"><table id="spTable"></table></div>
</section>
<script>
(function(){
  function route(){
    const v=document.getElementById('sparesView'); if(!v) return;
    v.hidden = !(location.hash||'').startsWith('#/repuestos');
    if(!v.hidden) render();
  }
  function render(){
    const rows=CDL_STORE.repuestos.list();
    const tbl=document.getElementById('spTable');
    tbl.innerHTML=`<thead><tr><th>Ref</th><th>Descripción</th><th>Stock</th><th>€ Unidad</th><th>Usar en equipo</th></tr></thead><tbody>${
      rows.map(r=>`<tr><td>${r.ref}</td><td>${r.desc||''}</td><td>${r.stock||0}</td><td>${(r.cost||0).toFixed(2)}</td>
      <td><button class="btn-cdl" data-use="${r.ref}">Asignar…</button></td></tr>`).join('')
    }</tbody>`;
    tbl.querySelectorAll('button[data-use]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const ref=b.dataset.use; const eq=prompt('Código de equipo destino:'); if(!eq) return;
        const L=CDL_STORE.repuestos.list(); const it=L.find(x=>x.ref===ref); if(!it) return;
        if((it.stock||0)<=0){ cdlToast('Sin stock'); return; }
        it.stock=(it.stock||0)-1; CDL_STORE.repuestos.set(L);
        CDL_STORE.eventos.push(eq, {tipo:'Reparación', horas:0, coste:it.cost||0, detalle:`Repuesto ${ref} - ${it.desc||''}`});
        cdlToast('Movimiento registrado'); render();
      });
    });
  }
  document.getElementById('spAdd')?.addEventListener('click', ()=>{
    const ref = document.getElementById('spRef').value.trim(); if(!ref) return;
    const L=CDL_STORE.repuestos.list();
    const i=L.findIndex(x=>x.ref===ref);
    const obj={ref, desc:document.getElementById('spDesc').value, stock:+(document.getElementById('spStock').value||0), cost:+(document.getElementById('spCost').value||0)};
    if(i>=0) L[i]={...L[i],...obj}; else L.unshift(obj);
    CDL_STORE.repuestos.set(L); cdlToast('Repuesto guardado'); location.hash='#/repuestos';
  });
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
})();
</script>

<!-- =========================================================
BLOQUE 126 — Deep-link App desde QR (scheme + fallback)
========================================================= -->
<script>
(function(){
  // Si tu app móvil usa scheme "cdlapp://", abrimos directo y dejamos hash como fallback
  window.openDeepLink = function(equipoCode){
    const appUrl = 'cdlapp://equipo/'+encodeURIComponent(equipoCode);
    const webUrl = location.origin+location.pathname+'#/equipo/'+encodeURIComponent(equipoCode);
    // Intento abrir app
    const a=document.createElement('a'); a.href=appUrl; document.body.appendChild(a); a.click();
    // Fallback: tras 600ms nos aseguramos de estar en web
    setTimeout(()=>{ location.href=webUrl; }, 600);
  };
  // Integra en QR generado (opcional): cambia qrMake para usar openDeepLink
  const _qr = window.qrMake;
  window.qrMake = function(el, url, size){
    // Codificamos la deep-link precedida por web URL para compatibilidad
    const code = 'cdlapp://'+(url.split('#/equipo/')[1] ? 'equipo/'+url.split('#/equipo/')[1] : 'open')+'|'+url;
    _qr(el, code, size);
  };
})();
</script>

<!-- =========================================================
BLOQUE 127 — Backup: Export/Import (JSON) de toda la app
========================================================= -->
<section id="backupView" class="cdl-container" hidden>
  <h2>Backup</h2>
  <div style="display:flex;gap:.5rem;flex-wrap:wrap">
    <button class="btn-cdl" id="bkExport">Exportar JSON</button>
    <label class="btn-cdl" style="display:inline-grid;place-items:center;cursor:pointer">
      Importar JSON <input id="bkImport" type="file" accept="application/json" style="display:none">
    </label>
  </div>
  <p style="color:#6b7280;margin-top:8px">Incluye equipos, eventos, repuestos, preventivos, auditoría y perfil.</p>
</section>
<script>
(function(){
  function route(){
    const v=document.getElementById('backupView'); if(!v) return;
    v.hidden = !(location.hash||'').startsWith('#/backup');
  }
  document.getElementById('bkExport')?.addEventListener('click', ()=>{
    const equipos=CDL_STORE.equipos.list();
    const eventos=Object.fromEntries(equipos.map(e=>[e.codigo, CDL_STORE.eventos.list(e.codigo)]));
    const rep=CDL_STORE.repuestos.list();
    const pmKeys=equipos.map(e=>'cdl-pm-'+e.codigo);
    const pm=Object.fromEntries(pmKeys.map(k=>[k, JSON.parse(localStorage.getItem(k)||'[]')]));
    const audit=JSON.parse(localStorage.getItem('cdl-audit')||'[]');
    const user=JSON.parse(localStorage.getItem('cdl-user')||'{}');
    const blob=new Blob([JSON.stringify({equipos,eventos,repuestos:rep,pm,audit,user}, null, 2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='cdl-backup.json'; a.click();
  });
  document.getElementById('bkImport')?.addEventListener('change', (ev)=>{
    const f=ev.target.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>{
      try{
        const j=JSON.parse(r.result);
        if(Array.isArray(j.equipos)) localStorage.setItem('cdl-equipos', JSON.stringify(j.equipos));
        if(j.eventos) Object.keys(j.eventos).forEach(k=> localStorage.setItem('cdl-evt-'+k, JSON.stringify(j.eventos[k])));
        if(Array.isArray(j.repuestos)) localStorage.setItem('cdl-repuestos', JSON.stringify(j.repuestos));
        if(j.pm) Object.keys(j.pm).forEach(k=> localStorage.setItem(k, JSON.stringify(j.pm[k])));
        if(Array.isArray(j.audit)) localStorage.setItem('cdl-audit', JSON.stringify(j.audit));
        if(j.user) localStorage.setItem('cdl-user', JSON.stringify(j.user));
        cdlToast('Backup importado');
      }catch(e){ alert('JSON inválido'); }
    }; r.readAsText(f);
  });
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
})();
</script>
<!-- =========================================================
BLOQUE 129 — Acciones masivas en lista de equipos (cambio estado)
========================================================= -->
<style>
  .bulkbar{position:sticky;top:calc(var(--hdr-h) + 0px);z-index:900;background:#fff;border-bottom:1px solid #e5e7eb;padding:8px 0;display:none}
  .bulkbar.active{display:block}
  .eq-select{width:18px;height:18px}
</style>
<div id="bulkBar" class="bulkbar cdl-container">
  <b id="bulkCount">0 seleccionados</b>
  <div style="display:inline-flex;gap:.4rem;margin-left:.8rem">
    <button class="btn-cdl" data-set="En marcha">Poner en marcha</button>
    <button class="btn-cdl" data-set="Restricciones" style="background:#111">Restringir</button>
    <button class="btn-cdl" data-set="Parada" style="background:#dc2626">Parar</button>
    <button class="btn-cdl" id="bulkClear">Limpiar</button>
  </div>
</div>
<script>
(function(){
  // Inyecta checkbox en tarjetas y gestiona barra
  const _render = window.renderEquipos;
  let SELECTED=new Set();
  function updateBar(){
    const bar=document.getElementById('bulkBar');
    document.getElementById('bulkCount').textContent = SELECTED.size+' seleccionados';
    bar.classList.toggle('active', SELECTED.size>0);
  }
  window.renderEquipos = function(list, q){
    _render(list, q);
    const grid=document.getElementById('equiposGrid');
    grid.querySelectorAll('.eq-card').forEach((card,i)=>{
      if(!card.querySelector('.eq-select')){
        const eq=list[i]; const cb=document.createElement('input'); cb.type='checkbox'; cb.className='eq-select';
        cb.style.margin='8px'; cb.title='Seleccionar para acción masiva';
        card.insertBefore(cb, card.firstChild);
        cb.addEventListener('change', ()=>{ cb.checked?SELECTED.add(eq.codigo):SELECTED.delete(eq.codigo); updateBar(); });
      }
    });
    updateBar();
  };
  // Acciones masivas
  document.querySelectorAll('#bulkBar [data-set]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if(!CDL_USER.can('editar_estado')) return cdlToast('Sin permiso');
      SELECTED.forEach(c=> window.setEquipoEstado(c, btn.dataset.set));
      cdlToast('Estados actualizados'); SELECTED.clear(); updateBar(); window.dispatchEvent(new HashChangeEvent('hashchange'));
    });
  });
  document.getElementById('bulkClear')?.addEventListener('click', ()=>{ SELECTED.clear(); updateBar(); document.querySelectorAll('.eq-select').forEach(cb=>cb.checked=false); });
})();
</script>

<!-- =========================================================
BLOQUE 130 — Calendario de paradas (mensual)
========================================================= -->
<section id="calView" class="cdl-container" hidden>
  <h2>Calendario</h2>
  <div id="calHead" style="display:flex;gap:.5rem;align-items:center;margin:.5rem 0">
    <button class="btn-cdl" id="calPrev">‹</button>
    <div id="calLabel" style="font-weight:900"></div>
    <button class="btn-cdl" id="calNext">›</button>
    <button class="btn-cdl" id="calToday" style="margin-left:auto;background:#111">Hoy</button>
  </div>
  <div id="calGrid" class="cal-grid"></div>
</section>
<style>
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
  .cal-grid header,.cal-grid .cell{border-right:1px solid #f1f5f9;border-bottom:1px solid #f1f5f9;padding:8px;min-height:84px}
  .cal-grid header{background:#f8fafc;font-weight:900}
  .cal-grid .cell .d{font-weight:800;color:#111}
  .badge-s{display:inline-block;border-radius:999px;padding:.12rem .45rem;font-size:.75rem;font-weight:900;margin:.18rem 0}
  .b-paro{background:#fee2e2;color:#991b1b} .b-rest{background:#fef3c7;color:#92400e}
  .b-prev{background:#dbeafe;color:#1e3a8a}
</style>
<script>
(function(){
  const view = document.getElementById('calView');
  function route(){
    if(!view) return;
    view.hidden = !(location.hash||'').startsWith('#/cal');
    if(!view.hidden) render();
  }
  let cursor = new Date();
  function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
  function addMonths(d, m){ const n=new Date(d); n.setMonth(n.getMonth()+m); return n; }
  function ymd(d){ return d.toISOString().slice(0,10); }
  function monthMatrix(d){
    const s=startOfMonth(d); const start=new Date(s); start.setDate(1 - ((s.getDay()+6)%7));
    return Array.from({length:6},(_,w)=> Array.from({length:7},(_,i)=> {
      const x=new Date(start); x.setDate(start.getDate()+w*7+i); return x;
    }));
  }
  function render(){
    document.getElementById('calLabel').textContent = cursor.toLocaleString(undefined,{month:'long',year:'numeric'});
    const grid=document.getElementById('calGrid');
    const weeks=monthMatrix(cursor);
    const equipos=CDL_STORE.equipos.list();
    const eventos = Object.fromEntries(equipos.map(e=>[e.codigo, CDL_STORE.eventos.list(e.codigo)]));
    grid.innerHTML='';
    // encabezados
    const head = ['Lun','Mar','Mié','Jue','Vie','Sáb','Dom'].map(t=>`<header>${t}</header>`).join('');
    grid.insertAdjacentHTML('beforeend', head);
    // celdas
    weeks.flat().forEach(d=>{
      const iso=ymd(d), inMonth = d.getMonth()===cursor.getMonth();
      const items=[];
      Object.keys(eventos).forEach(k=>{
        eventos[k].forEach(e=>{
          const day = ymd(new Date(e.ts||Date.now()));
          const tipo = String(e.tipo||'');
          if(day===iso && (tipo.includes('Paro')||tipo.includes('Restric')||tipo.includes('Prev'))) {
            const cls = tipo.includes('Paro')?'b-paro':(tipo.includes('Restr')?'b-rest':'b-prev');
            items.push(`<div class="badge-s ${cls}" title="${k} ${tipo}">${k}</div>`);
          }
        });
      });
      const cell = document.createElement('div');
      cell.className='cell'; cell.style.background = inMonth?'#fff':'#fafafa';
      cell.innerHTML = `<div class="d">${d.getDate()}</div>${items.join('')}`;
      grid.appendChild(cell);
    });
  }
  document.getElementById('calPrev')?.addEventListener('click', ()=>{cursor=addMonths(cursor,-1); render();});
  document.getElementById('calNext')?.addEventListener('click', ()=>{cursor=addMonths(cursor,1); render();});
  document.getElementById('calToday')?.addEventListener('click', ()=>{cursor=new Date(); render();});
  window.addEventListener('hashchange', route); window.addEventListener('load', route);
})();
</script>

<!-- =========================================================
BLOQUE 131 — Planificador rápido de paradas (programadas)
========================================================= -->
<section id="planView" class="cdl-container" hidden>
  <h2>Planificador</h2>
  <form id="planForm" class="evt-form" style="max-width:780px">
    <label>Equipo <input name="eq" required placeholder="EQ-001"></label>
    <label>Fecha <input name="fecha" type="date" required></label>
    <label>Horas estimadas <input name="horas" type="number" step="0.1" min="0" value="1"></label>
    <label>Motivo <input name="motivo" placeholder="Mantenimiento preventivo"></label>
    <button class="btn-cdl" type="submit">Programar Parada</button>
  </form>
  <div class="cdl-divider"></div>
  <a class="btn-cdl" href="#/cal" style="background:#111">Ver en calendario</a>
</section>
<script>
(function(){
  function route(){
    const v=document.getElementById('planView'); if(!v) return;
    v.hidden = !(location.hash||'').startsWith('#/plan');
  }
  document.getElementById('planForm')?.addEventListener('submit', (ev)=>{
    ev.preventDefault();
    const fd=new FormData(ev.target);
    const code = String(fd.get('eq')||'').trim();
    if(!CDL_STORE.equipos.get(code)) return alert('Equipo no existe');
    const ts = new Date(fd.get('fecha')+'T08:00:00').getTime();
    CDL_STORE.eventos.push(code,{tipo:'Paro Programado', horas:+(fd.get('horas')||0), coste:0, detalle:String(fd.get('motivo')||''), ts});
    cdlToast('Parada programada'); ev.target.reset();
  });
  window.addEventListener('hashchange', route); window.addEventListener('load', route);
})();
</script>

<!-- =========================================================
BLOQUE 132 — Importación CSV (equipos / eventos)
========================================================= -->
<section id="csvView" class="cdl-container" hidden>
  <h2>Importar CSV</h2>
  <p style="color:#6b7280">Formato equipos: <code>codigo,nombre,estado,hm,hr,hp</code> · Formato eventos: <code>equipo,tipo,horas,coste,detalle,fecha</code></p>
  <div style="display:flex;gap:.6rem;flex-wrap:wrap">
    <label class="btn-cdl">CSV Equipos <input id="csvEq" type="file" accept=".csv" style="display:none"></label>
    <label class="btn-cdl" style="background:#111">CSV Eventos <input id="csvEv" type="file" accept=".csv" style="display:none"></label>
  </div>
</section>
<script>
(function(){
  function route(){
    const v=document.getElementById('csvView'); if(!v) return;
    v.hidden = !(location.hash||'').startsWith('#/csv');
  }
  function parseCSV(text){
    const lines=text.split(/\r?\n/).filter(Boolean);
    return lines.map(l=>l.split(';').length>1? l.split(';'): l.split(',')).map(a=>a.map(s=>s.trim()));
  }
  document.getElementById('csvEq')?.addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>{
      parseCSV(r.result).forEach(a=>{
        const [codigo,nombre,estado,hm,hr,hp]=a;
        CDL_STORE.equipos.upsert({codigo,nombre,estado,horas:{m:+hm||0,r:+hr||0,p:+hp||0}});
      });
      cdlToast('Equipos importados');
    }; r.readAsText(f);
  });
  document.getElementById('csvEv')?.addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>{
      parseCSV(r.result).forEach(a=>{
        const [eq,tipo,horas,coste,detalle,fecha]=a;
        const ts = fecha ? new Date(fecha).getTime() : Date.now();
        CDL_STORE.eventos.push(eq,{tipo,horas:+horas||0,coste:+coste||0,detalle,ts});
      });
      cdlToast('Eventos importados');
    }; r.readAsText(f);
  });
  window.addEventListener('hashchange', route); window.addEventListener('load', route);
})();
</script>

<!-- =========================================================
BLOQUE 133 — Panel de incidencias con SLA (abiertas)
========================================================= -->
<section id="incidenciasView" class="cdl-container" hidden>
  <h2>Incidencias</h2>
  <div id="incTable" class="eq-table" style="margin-top:8px"></div>
</section>
<style>
  .sla-ok{background:#ecfdf5;color:#065f46;border-radius:999px;padding:.12rem .5rem;font-weight:900}
  .sla-warn{background:#fffbeb;color:#92400e;border-radius:999px;padding:.12rem .5rem;font-weight:900}
  .sla-bad{background:#fef2f2;color:#991b1b;border-radius:999px;padding:.12rem .5rem;font-weight:900}
</style>
<script>
(function(){
  const SLA_H = 8; // horas objetivo
  function route(){
    const v=document.getElementById('incidenciasView'); if(!v) return;
    v.hidden = !(location.hash||'').startsWith('#/incidencias');
    if(!v.hidden) render();
  }
  function render(){
    const L=CDL_STORE.equipos.list();
    const rows=[];
    L.forEach(eq=>{
      CDL_STORE.eventos.list(eq.codigo).forEach(e=>{
        if(['Avería','Restricción','Paro'].includes(e.tipo)){
          const hrs=(Date.now()-(e.ts||Date.now()))/36e5;
          rows.push({eq:eq.codigo,nombre:eq.nombre,tipo:e.tipo,desde:new Date(e.ts||Date.now()),hrs});
        }
      });
    });
    rows.sort((a,b)=>b.hrs-a.hrs);
    const tbl=document.createElement('table');
    tbl.innerHTML=`<thead><tr><th>Equipo</th><th>Tipo</th><th>Desde</th><th>Horas</th><th>SLA</th><th>Acción</th></tr></thead><tbody>${
      rows.map(r=>{
        const cls = r.hrs<SLA_H*0.5?'sla-ok': r.hrs<SLA_H?'sla-warn':'sla-bad';
        const badge = `<span class="${cls}">${r.hrs.toFixed(1)}h / ${SLA_H}h</span>`;
        return `<tr><td>${r.eq} · ${r.nombre}</td><td>${r.tipo}</td><td>${r.desde.toLocaleString()}</td><td>${r.hrs.toFixed(1)}</td><td>${badge}</td>
        <td><button class="btn-cdl" onclick="gotoEquipo('${r.eq}')">Abrir</button></td></tr>`;
      }).join('')
    }</tbody>`;
    const wrap=document.getElementById('incTable'); wrap.innerHTML=''; wrap.appendChild(tbl);
  }
  window.addEventListener('hashchange', route); window.addEventListener('load', route);
})();
</script>

<!-- =========================================================
BLOQUE 134 — Ajuste SLA configurable + etiqueta en ficha
========================================================= -->
<script>
(function(){
  // Config SLA guardado
  const KEY='cdl-sla-h'; window.getSLA=()=> +(localStorage.getItem(KEY)||8);
  window.setSLA=(h)=> localStorage.setItem(KEY, String(h));
  // Badge en ficha
  const _showEquipo = window.showEquipo;
  window.showEquipo = function(code){
    _showEquipo(code);
    const k = document.getElementById('kpi-rp')?.parentElement;
    if(k && !document.getElementById('kpi-sla')){
      const s=document.createElement('div'); s.className='kpi'; s.innerHTML=`<b id="kpi-sla">${getSLA()}h</b><span>SLA objetivo</span>`;
      k.parentElement.appendChild(s);
    }else if(document.getElementById('kpi-sla')){
      document.getElementById('kpi-sla').textContent=getSLA()+'h';
    }
  };
})();
</script>

<!-- =========================================================
BLOQUE 135 — Afinado visual “cdl.es”: tipografía, espaciado, badges
========================================================= -->
<style>
  /* Titulares más compactos, tracking leve y color corporativo estable */
  :where(h1,h2,h3){ letter-spacing:.01em }
  .cdl-badge{display:inline-block;border:1px solid #e5e7eb;border-radius:999px;padding:.18rem .6rem;font-weight:900}
  .cdl-badge--red{border-color:#fecaca;background:#fff5f5;color:#b91c1c}
  .cdl-badge--dark{border-color:#e5e7eb;background:#111;color:#fff}
  /* Márgenes consistentes con página oficial */
  .cdl-container > * + *{ margin-top:14px }
</style>

<!-- =========================================================
BLOQUE 136 — PWA: registro del Service Worker (si no está)
========================================================= -->
<script>
(function(){
  if('serviceWorker' in navigator){
    navigator.serviceWorker.getRegistration().then(reg=>{
      if(!reg) navigator.serviceWorker.register('./sw.js').catch(()=>{});
    });
  }
})();
</script>

<!-- =========================================================
BLOQUE 137 — PWA: “Instalar app” (A2HS)
========================================================= -->
<div id="a2hsBar" class="cdl-container" hidden>
  <div style="display:flex;gap:.6rem;align-items:center;border:1px solid #e5e7eb;border-radius:12px;padding:10px">
    <b>Instala la app de Mantenimiento</b>
    <button class="btn-cdl" id="btnA2HS">Instalar</button>
    <button class="cdl-x" id="btnA2HSClose" aria-label="Ocultar">✕</button>
  </div>
</div>
<script>
(function(){
  let deferred;
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault(); deferred=e; const bar=document.getElementById('a2hsBar'); bar.hidden=false;
  });
  document.getElementById('btnA2HS')?.addEventListener('click', async ()=>{
    if(!deferred) return; deferred.prompt(); const choice=await deferred.userChoice; deferred=null;
    document.getElementById('a2hsBar').hidden=true; if(choice.outcome==='accepted') cdlToast('Instalada');
  });
  document.getElementById('btnA2HSClose')?.addEventListener('click', ()=> document.getElementById('a2hsBar').hidden=true);
})();
</script>

<!-- =========================================================
BLOQUE 138 — Performance: lazy & diferido (QR/fotos fuera de viewport)
========================================================= -->
<script>
(function(){
  const io = 'IntersectionObserver' in window ? new IntersectionObserver((entries)=>{
    entries.forEach(e=>{
      if(e.isIntersecting){
        const el=e.target;
        // QR pequeños en tarjetas
        if(el.dataset.qr && !el._done){ qrMake(el, el.dataset.qr, 120); el._done=true; }
        // Imágenes diferidas (si las hubiera en media)
        if(el.dataset.src && !el._loaded){ el.style.backgroundImage=`url('${el.dataset.src}')`; el._loaded=true; }
        io.unobserve(el);
      }
    });
  },{rootMargin:'120px'}) : null;

  // hook en renderEquipos para diferir QR
  const _render = window.renderEquipos;
  window.renderEquipos = function(list,q){
    _render(list,q);
    document.querySelectorAll('.eq-
    <!-- =========================================================
BLOQUE 180 — API util (wrapper localStorage) para usar en otros módulos
========================================================= -->
<script>
(function(){
  if(window.api) return;
  const LSKEY='cdl-equipos';
  const EVTKEY = c => 'cdl-evt-'+c;

  function listEquipos(){
    try{ return JSON.parse(localStorage.getItem(LSKEY))||[]; }catch{ return []; }
  }
  function saveEquipos(arr){
    try{ localStorage.setItem(LSKEY, JSON.stringify(arr)); }catch{}
  }
  function getEquipo(code){
    return listEquipos().find(e=>e.codigo===code) || null;
  }
  function listEventos(code){
    try{ return JSON.parse(localStorage.getItem(EVTKEY(code)))||[]; }catch{ return []; }
  }
  function addEvento(code, evt){
    const arr=listEventos(code); arr.unshift({...evt, ts:evt.ts||Date.now()});
    localStorage.setItem(EVTKEY(code), JSON.stringify(arr));
  }
  function upsertEquipo(eq){
    const all=listEquipos(); const i=all.findIndex(e=>e.codigo===eq.codigo);
    if(i>=0) all[i]={...all[i], ...eq}; else all.push(eq);
    saveEquipos(all);
  }
  window.api={listEquipos,saveEquipos,getEquipo,listEventos,addEvento,upsertEquipo};
})();
</script>

<!-- =========================================================
BLOQUE 181 — Reporte KPI por rango de fechas (#/kpi)
========================================================= -->
<section id="kpiView" class="cdl-container" hidden>
  <h2>KPIs</h2>
  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:end;margin:.4rem 0 10px">
    <label>Desde<br><input id="kpiFrom" type="date" style="border:1px solid #e5e7eb;border-radius:10px;padding:.4rem .55rem"></label>
    <label>Hasta<br><input id="kpiTo" type="date" style="border:1px solid #e5e7eb;border-radius:10px;padding:.4rem .55rem"></label>
    <button class="btn-cdl" id="kpiRun">Calcular</button>
    <button class="btn-cdl" id="kpiCsv" style="background:#111">Exportar CSV</button>
  </div>
  <div id="kpiTable" class="eq-table" aria-live="polite"></div>
</section>
<script>
(function(){
  function inRange(ts,from,to){
    if(from && ts<from) return false;
    if(to && ts>to+86400000-1) return false;
    return true;
  }
  function calc(eq, from, to){
    const k={m:0,r:0,p:0, rep:0, repuestos:0};
    api.listEventos(eq.codigo).forEach(e=>{
      if(!inRange(e.ts, from, to)) return;
      if(e.tipo==='Marcha') k.m+=Number(e.horas||0);
      if(e.tipo==='Restricción') k.r+=Number(e.horas||0);
      if(e.tipo==='Paro') k.p+=Number(e.horas||0);
      if(e.tipo==='Reparación'){ k.rep++; k.repuestos+=Number(e.coste||0); }
      if(e.coste) k.repuestos+=Number(e.coste||0);
    });
    const total=(k.m+k.r+k.p)||1;
    return {dispo:(k.m/total)*100, mtbf: (k.m/Math.max(1,k.rep)), ...k};
  }
  function render(){
    const v=document.getElementById('kpiView');
    const t=document.getElementById('kpiTable'); if(!v||!t) return;
    const from=document.getElementById('kpiFrom').value?new Date(document.getElementById('kpiFrom').value).getTime():null;
    const to=document.getElementById('kpiTo').value?new Date(document.getElementById('kpiTo').value).getTime():null;
    const rows=api.listEquipos().map(eq=>{
      const k=calc(eq,from,to);
      return `<tr>
        <td>${eq.codigo}</td><td>${eq.nombre}</td>
        <td>${k.m.toFixed(1)}h</td><td>${k.r.toFixed(1)}h</td><td>${k.p.toFixed(1)}h</td>
        <td>${k.rep}</td><td>${k.mtbf.toFixed(1)}h</td><td>${k.dispo.toFixed(1)}%</td><td>${k.repuestos.toFixed(2)}€</td>
      </tr>`;
    }).join('');
    t.innerHTML=`<table><thead>
      <tr><th>Código</th><th>Equipo</th><th>Marcha</th><th>Restr.</th><th>Paro</th><th>Rep.</th><th>MTBF</th><th>Disp.</th><th>Repuestos</th></tr>
    </thead><tbody>${rows}</tbody></table>`;
  }
  function exportCSV(){
    const from=document.getElementById('kpiFrom').value?new Date(document.getElementById('kpiFrom').value).getTime():null;
    const to=document.getElementById('kpiTo').value?new Date(document.getElementById('kpiTo').value).getTime():null;
    const head='Codigo,Equipo,Marcha,Restricciones,Paro,Reparaciones,MTBF,Disponibilidad,Repuestos';
    const lines=api.listEquipos().map(eq=>{
      const k=(function(){ const r=api.listEventos(eq.codigo).filter(e=>(!from||e.ts>=from)&&(!to||e.ts<=to+86400000-1));
        let m=0,r=0,p=0,rep=0, repuestos=0; r.forEach; r.forEach; return {}})();
      const K=(function(){ const k={m:0,r:0,p:0, rep:0, repuestos:0};
        api.listEventos(eq.codigo).forEach(e=>{
          if(from&&e.ts<from) return; if(to&&e.ts>to+86400000-1) return;
          if(e.tipo==='Marcha') k.m+=Number(e.horas||0);
          if(e.tipo==='Restricción') k.r+=Number(e.horas||0);
          if(e.tipo==='Paro') k.p+=Number(e.horas||0);
          if(e.tipo==='Reparación') {k.rep++; k.repuestos+=Number(e.coste||0);}
          if(e.coste) k.repuestos+=Number(e.coste||0);
        });
        const total=(k.m+k.r+k.p)||1;
        return {dispo:(k.m/total)*100, mtbf:(k.m/Math.max(1,k.rep)), ...k};
      })();
      return [eq.codigo, `"${eq.nombre}"`, K.m.toFixed(1), K.r.toFixed(1), K.p.toFixed(1), K.rep, K.mtbf.toFixed(1), K.dispo.toFixed(1), K.repuestos.toFixed(2)].join(',');
    }).join('\n');
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([[head,lines].join('\n')],{type:'text/csv'}));
    a.download='kpi.csv'; a.click(); URL.revokeObjectURL(a.href);
  }
  function route(){ const v=document.getElementById('kpiView'); if(!v) return;
    v.hidden = (location.hash!=='#/kpi');
    if(!v.hidden) render();
  }
  window.addEventListener('hashchange', route);
  document.getElementById('kpiRun').onclick=render;
  document.getElementById('kpiCsv').onclick=exportCSV;
  route();
})();
</script>

<!-- =========================================================
BLOQUE 182 — Filtros avanzados en Equipos (estado y disponibilidad)
========================================================= -->
<div id="equiposFilters" class="cdl-container" hidden style="display:flex;gap:8px;flex-wrap:wrap;align-items:end;margin-bottom:8px">
  <label>Estado<br>
    <select id="fEstado" style="border:1px solid #e5e7eb;border-radius:10px;padding:.4rem .55rem">
      <option value="">Todos</option>
      <option>En marcha</option><option>Restricciones</option><option>Parada</option>
    </select>
  </label>
  <label>Disp. mínima (%)<br>
    <input id="fDisp" type="number" min="0" max="100" step="1" placeholder="0" style="border:1px solid #e5e7eb;border-radius:10px;padding:.4rem .55rem;width:110px">
  </label>
  <button id="fAplicar" class="btn-cdl">Filtrar</button>
</div>
<script>
(function(){
  const F={estado:'', disp:0};
  const bar=document.getElementById('equiposFilters');
  function ensureBar(){
    const view=document.getElementById('equiposView');
    if(!view) return;
    bar.hidden=false; view.parentNode.insertBefore(bar, view);
  }
  function apply(){
    // Filtra tarjetas existentes sin rehacer la grilla
    document.querySelectorAll('.eq-card').forEach(card=>{
      const code=card.querySelector('.eq-meta')?.textContent?.replace('#','')||'';
      const eq=api.getEquipo(code); if(!eq){ card.hidden=false; return; }
      let ok=true;
      if(F.estado && (eq.estado!==F.estado)) ok=false;
      if(Number(F.disp)>0){
        // estimación sencilla usando eventos (últimos 90 días)
        const to=Date.now(), from=to-90*86400000;
        let m=0,r=0,p=0; api.listEventos(eq.codigo).forEach(e=>{
          if(e.ts<from||e.ts>to) return;
          if(e.tipo==='Marcha') m+=Number(e.horas||0);
          if(e.tipo==='Restricción') r+=Number(e.horas||0);
          if(e.tipo==='Paro') p+=Number(e.horas||0);
        });
        const total=(m+r+p)||1, dispo=(m/total)*100;
        if(dispo < Number(F.disp)) ok=false;
      }
      card.style.display = ok?'':'none';
    });
  }
  document.getElementById('fAplicar').onclick=()=>{
    F.estado=document.getElementById('fEstado').value;
    F.disp=document.getElementById('fDisp').value||0;
    apply();
  };
  function route(){
    const on = location.hash.startsWith('#/equipos') || location.hash==='';
    bar.hidden = !on; if(on) ensureBar();
    if(on) setTimeout(apply, 0);
  }
  window.addEventListener('hashchange', route); route();
})();
</script>

<!-- =========================================================
BLOQUE 183 — Importación CSV (equipos y eventos)  #/import
========================================================= -->
<section id="importView" class="cdl-container" hidden>
  <h2>Importar CSV</h2>
  <p class="eq-meta">Formatos: 
    <br><b>Equipos:</b> codigo,nombre,estado,horas_m,horas_r,horas_p
    <br><b>Eventos:</b> codigo,tipo,horas,coste,detalle,ts(ISO/opcional)
  </p>
  <label class="btn-cdl" style="background:#111;cursor:pointer;display:inline-block;margin-top:8px">
    Seleccionar CSV<input id="impFile" type="file" accept=".csv,text/csv" style="display:none">
  </label>
</section>
<script>
(function(){
  // añade entrada al menú si no existe
  const nav=document.querySelector('.cdl-panel__nav');
  if(nav && !nav.querySelector('a[href="#/import"]')){
    const a=document.createElement('a'); a.href='#/import'; a.textContent='Importar CSV'; nav.appendChild(a);
  }
  function parseCSV(text){
    const lines=text.split(/\r?\n/).filter(Boolean);
    return lines.map(l=>{
      const m=[]; let s='',q=false;
      for(let i=0;i<l.length;i++){
        const c=l[i];
        if(c==='"' ){ if(q && l[i+1]==='"'){ s+='"'; i++; } else q=!q; }
        else if(c===',' && !q){ m.push(s); s=''; }
        else s+=c;
      }
      m.push(s); return m;
    });
  }
  function handle(rows){
    const head=rows[0].map(h=>h.toLowerCase());
    const isEquipos = head.includes('nombre');
    const isEventos = head.includes('tipo');
    if(isEquipos){
      rows.slice(1).forEach(r=>{
        const obj={
          codigo:r[head.indexOf('codigo')]?.trim(),
          nombre:r[head.indexOf('nombre')]||'Equipo',
          estado:r[head.indexOf('estado')]||'Restricciones',
          horas:{
            m:Number(r[head.indexOf('horas_m')]||0),
            r:Number(r[head.indexOf('horas_r')]||0),
            p:Number(r[head.indexOf('horas_p')]||0)
          }
        };
        if(obj.codigo) api.upsertEquipo(obj);
      });
    }
    if(isEventos){
      rows.slice(1).forEach(r=>{
        const code=r[head.indexOf('codigo')]?.trim();
        if(!code) return;
        api.upsertEquipo({codigo:code, nombre: api.getEquipo(code)?.nombre||code}); // por si no existe
        const evt={
          tipo:r[head.indexOf('tipo')],
          horas:Number(r[head.indexOf('horas')]||0),
          coste:Number(r[head.indexOf('coste')]||0),
          detalle:r[head.indexOf('detalle')]||'',
          ts: (function(v){ const t=Date.parse(v||''); return isNaN(t)?Date.now():t; })(r[head.indexOf('ts')])
        };
        api.addEvento(code, evt);
      });
    }
    alert('Importación completada'); location.hash='#/equipos';
  }
  document.getElementById('impFile')?.addEventListener('change', async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    const text=await f.text(); const rows=parseCSV(text);
    try{ handle(rows); }catch(err){ alert('CSV no reconocido'); console.error(err); }
  });
  function route(){ const v=document.getElementById('importView'); v.hidden = (location.hash!=='#/import'); }
  window.addEventListener('hashchange', route); route();
})();
</script>

<!-- =========================================================
BLOQUE 184 — Elevación de rol protegida por PIN
========================================================= -->
<script>
(function(){
  if(!window.CDLRole) return;
  const _set=window.CDLRole.set;
  async function confirmPIN(){
    return new Promise(res=>{
      const pin=prompt('PIN de seguridad:');
      if(pin===null) return res(false);
      const ok = (pin === (localStorage.getItem('cdl-pin') || '1234'));
      if(!ok) alert('PIN incorrecto');
      res(ok);
    });
  }
  window.CDLRole.set = async function(role){
    const current=window.CDLRole.get();
    const elevating = (current==='Operario' && (role==='Mantenimiento'||role==='Admin')) || (current!=='Admin' && role==='Admin');
    if(elevating){
      const ok=await confirmPIN(); if(!ok) return;
    }
    _set(role);
  };
})();
</script>

<!-- =========================================================
BLOQUE 185 — Mantenimiento Preventivo (PM) por equipo
========================================================= -->
<style>
  .pm-list{border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
  .pm-list table{width:100%;border-collapse:collapse}
  .pm-list th,.pm-list td{padding:8px 10px;border-bottom:1px solid #f1f5f9;text-align:left}
</style>
<script>
(function(){
  const PMKEY = c => 'cdl-pm-'+c; // guarda {items:[{id,desc,cadaDias,ultima,dateDue}]}
  function listPM(code){ try{ return JSON.parse(localStorage.getItem(PMKEY(code)))?.items||[]; }catch{return [];} }
  function savePM(code, items){ localStorage.setItem(PMKEY(code), JSON.stringify({items})); }
  function addPM(code, item){ const arr=listPM(code); arr.push({...item, id:crypto.randomUUID?.():String(Date.now())}); savePM(code, arr); }
  function markDone(code, id){ const arr=listPM(code).map(i=>i.id===id?({...i, ultima:Date.now()}):i); savePM(code, arr); }

  function renderPM(code){
    const wrap=document.getElementById('eqTable');
    const cont=document.createElement('div'); cont.style.marginTop='10px';
    cont.innerHTML=`<h3>Preventivo</h3>
      <form id="pmForm" class="evt-form" style="margin-bottom:8px">
       <label>Descripción <input name="desc" required></label>
       <label>Cada (días) <input name="cada" type="number" min="1" required></label>
       <button class="btn-cdl" type="submit">Añadir PM</button>
      </form>
      <div class="pm-list"><table><thead><tr><th>Tarea</th><th>Frecuencia</th><th>Próximo</th><th></th></tr></thead><tbody id="pmBody"></tbody></table></div>`;
    wrap.appendChild(cont);
    const body=cont.querySelector('#pmBody');
    const items=listPM(code);
    body.innerHTML=items.map(i=>{
      const due = (i.ultima||0) + (Number(i.cadaDias||i.cada||0)*86400000);
      return `<tr><td>${(i.desc||'—').replace(/</g,'&lt;')}</td><td>${i.cadaDias||i.cada}d</td><td>${ new Date(due||Date.now()).toLocaleDateString()}</td>
      <td><button class="btn-cdl" data-done="${i.id}" style="padding:.4rem .7rem">Hecho</button></td></tr>`;
    }).join('') || `<tr><td colspan="4" class="eq-meta">Sin tareas</td></tr>`;
    cont.querySelectorAll('[data-done]').forEach(b=>{
      b.onclick=()=>{ markDone(code, b.getAttribute('data-done')); location.hash=location.hash; };
    });
    cont.querySelector('#pmForm').onsubmit=(e)=>{
      e.preventDefault();
      const fd=new FormData(e.target);
      addPM(code, {desc:fd.get('desc'), cadaDias:Number(fd.get('cada')||0), ultima:Date.now()});
      location.hash=location.hash;
    };
  }

  // Hook a la vista de equipo: cuando se muestra, pintamos PM
  const obs=new MutationObserver(()=>{
    if(!location.hash.startsWith('#/equipo/')) return;
    const code=decodeURIComponent(location.hash.split('/')[2].split('?')[0]);
    if(document.getElementById('eqTable') && !document.getElementById('eqTable').dataset.pm){
      document.getElementById('eqTable').dataset.pm='1';
      renderPM(code);
    }
  });
  obs.observe(document.body,{childList:true,subtree:true});
})();
</script>

<!-- =========================================================
BLOQUE 186 — Badges de alerta en tarjetas (Parada / PM vencido)
========================================================= -->
<style>
  .eq-badge{position:absolute;top:8px;left:8px;background:#dc2626;color:#fff;border-radius:999px;padding:.2rem .5rem;font-weight:800;font-size:.8rem}
  .eq-card{position:relative}
</style>
<script>
(function(){
  function pmOverdue(code){
    try{
      const data=JSON.parse(localStorage.getItem('cdl-pm-'+code)); const items=(data&&data.items)||[];
      return items.some(i=> (i.ultima||0) + (Number(i.cadaDias||0)*86400000) < Date.now());
    }catch{return false;}
  }
  function badge(){
    document.querySelectorAll('.eq-card').forEach(card=>{
      const code=card.querySelector('.eq-meta')?.textContent?.replace('#','');
      if(!code) return;
      const eq=api.getEquipo(code)||{};
      let text='';
      if(eq.estado==='Parada') text='PARO';
      else if(pmOverdue(code)) text='PM';
      let tag=card.querySelector('.eq-badge');
      if(text){
        if(!tag){ tag=document.createElement('span'); tag.className='eq-badge'; card.appendChild(tag); }
        tag.textContent=text;
        tag.style.background = text==='PARO' ? '#dc2626' : '#f59e0b';
      }else if(tag){ tag.remove(); }
    });
  }
  const mo=new MutationObserver(badge);
  mo.observe(document.getElementById('equiposGrid')||document.body,{childList:true,subtree:true});
  window.addEventListener('hashchange', ()=> setTimeout(badge,0));
})();
</script>

<!-- =========================================================
BLOQUE 187 — Soporte offline: aviso + cola de eventos (sync diferido)
========================================================= -->
<style>
  .offline-toast{position:fixed;left:50%;transform:translateX(-50%);bottom:10px;background:#111;color:#fff;border-radius:12px;padding:.45rem .7rem;display:none;z-index:1500}
</style>
<div id="offlineToast" class="offline-toast">Sin conexión. Guardando en cola…</div>
<script>
(function(){
  const QKEY='cdl-queue';
  function getQ(){ try{ return JSON.parse(localStorage.getItem(QKEY))||[]; }catch{return [];} }
  function setQ(q){ localStorage.setItem(QKEY, JSON.stringify(q)); }
  function toast(show){ const t=document.getElementById('offlineToast'); if(!t) return; t.style.display=show?'block':'none'; }

  // Simulamos envío en línea: aquí podrías integrar fetch/Sheets/Firestore
  async function flush(){
    if(!navigator.onLine) return;
    const q=getQ(); if(q.length===0) return;
    // simular envío ok:
    setQ([]); toast(false);
    console.log('Cola sincronizada', q);
  }
  window.addEventListener('online', flush);

  // Hook sobre pushEvt para encolar si offline
  if(!window.__pushEvtBase) window.__pushEvtBase = window.pushEvt;
  window.pushEvt = function(code, evt){
    if(!navigator.onLine){
      toast(true);
      const q=getQ(); q.push({code, evt}); setQ(q);
      // guarda también localmente para no perder histórico
      api.addEvento(code, evt);
    }else{
      window.__pushEvtBase(code, evt);
      flush();
    }
  };

  // Flush inicial
  flush();
})();
</script>

<!-- =========================================================
BLOQUE 188 — Compartir ficha (Web Share API)
========================================================= -->
<script>
(function(){
  function addShare(){
    const aside=document.querySelector('#equipoView .eq-detail__right'); if(!aside) return;
    if(aside.querySelector('#shareBtn')) return;
    const b=document.createElement('button'); b.className='btn-cdl'; b.id='shareBtn'; b.textContent='Compartir';
    b.style.marginTop='8px'; aside.appendChild(b);
    b.onclick=()=>{
      const name=document.getElementById('eqName')?.textContent||'Equipo';
      const url=location.href;
      if(navigator.share){
        navigator.share({title:name, text:`Ficha ${name}`, url});
      }else{
        navigator.clipboard?.writeText(url);
        alert('Enlace copiado');
      }
    };
  }
  const obs=new MutationObserver(addShare);
  obs.observe(document.body,{childList:true,subtree:true});
})();
</script>

<!-- =========================================================
BLOQUE 189 — Pulido visual extra para clavar estilo CDL
========================================================= -->
<style>
  /* Tipografía y pesos afinados */
  h1,h2,h3{ letter-spacing: .01em }
  h1{ font-weight:800 } h2{ font-weight:800 } h3{ font-weight:800 }
  /* Cabecera: ancho y alineación tipo corporate */
  .cdl-header__inner{ max-width: var(--container); margin-inline:auto; padding-inline:16px }
  .cdl-logo img{ height:28px }
  /* Navegación lateral: mayúsculas suaves y tracking */
  .cdl-panel__nav a{ text-transform:uppercase; letter-spacing:.03em; font-size:.88rem }
  /* Botones: bordes y radios coherentes */
  .btn-cdl{ border-radius:999px }
  /* Hero espaciado */
  .cdl-hero{ padding:6px 0 10px }
  /* Colores de foco coherentes con rojo corporativo */
  :focus-visible{ outline:3px solid rgba(228,59,59,.45); outline-offset:2px }
</style>

<!-- =========================================================
BLOQUE 190 — Vista de REPUESTOS (#/repuestos): stock, consumo y alertas
========================================================= -->
<section id="repuestosView" class="cdl-container" hidden>
  <h2>Repuestos</h2>
  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:end;margin:.4rem 0 10px">
    <label>Buscar<br><input id="repQ" type="search" placeholder="código o nombre" style="border:1px solid #e5e7eb;border-radius:10px;padding:.4rem .55rem"></label>
    <button id="repNewBtn" class="btn-cdl">Nuevo repuesto</button>
    <button id="repCsvBtn" class="btn-cdl" style="background:#111">Exportar CSV</button>
  </div>
  <div id="repTable" class="eq-table" aria-live="polite"></div>
</section>

<style>
  .rep-badge{display:inline-block;border-radius:999px;padding:.15rem .5rem;font-weight:800;font-size:.78rem}
  .rep-badge.low{background:#dc2626;color:#fff}
  .rep-badge.mid{background:#f59e0b;color:#111}
</style>

<script>
(function(){
  const KEY='cdl-repuestos';
  function list(){ try{return JSON.parse(localStorage.getItem(KEY))||[]}catch{return[]} }
  function save(arr){ localStorage.setItem(KEY, JSON.stringify(arr)) }
  function upsert(rep){
    const all=list(); const i=all.findIndex(r=>r.codigo===rep.codigo);
    if(i>=0) all[i]={...all[i], ...rep}; else all.push(rep);
    save(all);
  }
  function adjust(codigo, delta){ const all=list(); const i=all.findIndex(r=>r.codigo===codigo); if(i<0) return;
    all[i].stock = Number(all[i].stock||0)+Number(delta||0);
    all[i].consumo = Number(all[i].consumo||0) + (delta<0? Math.abs(delta):0);
    save(all);
  }
  function render(q){
    const t=document.getElementById('repTable'); if(!t) return;
    const L=list().filter(r=>{
      const s=(q||'').toLowerCase();
      return !s || r.codigo?.toLowerCase().includes(s) || r.nombre?.toLowerCase().includes(s);
    });
    const rows=L.map(r=>{
      const stock=Number(r.stock||0), min=Number(r.min||0);
      const badge = stock<=min ? `<span class="rep-badge low">MÍN</span>` : (stock<=min*1.3?`<span class="rep-badge mid">BAJO</span>`:'');
      return `<tr>
        <td>${r.codigo}</td><td>${(r.nombre||'').replace(/</g,'&lt;')}</td>
        <td>${stock} ${badge}</td><td>${Number(r.min||0)}</td><td>${Number(r.consumo||0)}</td>
        <td style="white-space:nowrap">
          <button class="btn-cdl" data-in="${r.codigo}" style="padding:.35rem .6rem">+ Entr.</button>
          <button class="btn-cdl" data-out="${r.codigo}" style="padding:.35rem .6rem;background:#111">− Cons.</button>
        </td>
      </tr>`;
    }).join('');
    t.innerHTML=`<table><thead>
      <tr><th>Código</th><th>Nombre</th><th>Stock</th><th>Mínimo</th><th>Consumo</th><th>Acciones</th></tr>
    </thead><tbody>${rows || `<tr><td colspan="6" class="eq-meta">Sin repuestos</td></tr>`}</tbody></table>`;
    t.querySelectorAll('[data-in]').forEach(b=>b.onclick=()=>{ const u=prompt('Unidades a ENTRAR:','1'); if(u!==null) adjust(b.dataset.in, Math.abs(Number(u||0))); render(document.getElementById('repQ').value) });
    t.querySelectorAll('[data-out]').forEach(b=>b.onclick=()=>{ const u=prompt('Unidades a CONSUMIR:','1'); if(u!==null) adjust(b.dataset.out, -Math.abs(Number(u||0))); render(document.getElementById('repQ').value) });
  }
  function exportCSV(){
    const head='codigo,nombre,stock,min,consumo';
    const lines=list().map(r=>[r.codigo, `"${(r.nombre||'').replace(/"/g,'""')}"`, r.stock||0, r.min||0, r.consumo||0].join(',')).join('\n');
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([[head,lines].join('\n')],{type:'text/csv'})); a.download='repuestos.csv'; a.click();
  }
  function newRep(){
    const codigo=prompt('Código del repuesto:'); if(!codigo) return;
    const nombre=prompt('Nombre/Descripción:')||'';
    const stock=Number(prompt('Stock inicial:','0')||0);
    const min=Number(prompt('Stock mínimo:','0')||0);
    upsert({codigo, nombre, stock, min, consumo:0});
    render(document.getElementById('repQ').value);
  }
  function route(){
    const v=document.getElementById('repuestosView'); if(!v) return;
    v.hidden = (location.hash!=='#/repuestos');
    if(!v.hidden) render((document.getElementById('repQ')||{}).value||'');
  }
  document.getElementById('repQ')?.addEventListener('input', e=>render(e.target.value));
  document.getElementById('repNewBtn')?.addEventListener('click', newRep);
  document.getElementById('repCsvBtn')?.addEventListener('click', exportCSV);
  window.addEventListener('hashchange', route); route();
  // Exponer API mínima por si quieres tocar desde consola:
  window.CDLParts={list, upsert, adjust};
})();
</script>

<!-- =========================================================
BLOQUE 191 — Auto-enlace de repuestos con eventos de Reparación
========================================================= -->
<script>
(function(){
  // Cuando se guarda un evento con coste, sugiere descontar repuesto
  const _push = window.pushEvt;
  window.pushEvt = function(code, evt){
    _push(code, evt);
    if(Number(evt.coste||0)>0){
      setTimeout(()=>{ if(confirm('¿Descontar 1 unidad de un repuesto?')) {
        const cod = prompt('Código de repuesto a descontar:'); if(cod) window.CDLParts?.adjust(cod, -1);
      }}, 50);
    }
  };
})();
</script>

<!-- =========================================================
BLOQUE 192 — Paros planificados (#/paros) con pequeño calendario
========================================================= -->
<section id="parosView" class="cdl-container" hidden>
  <h2>Paros planificados</h2>
  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:end;margin:.4rem 0 10px">
    <label>Equipo<br>
      <select id="paroEq" style="border:1px solid #e5e7eb;border-radius:10px;padding:.4rem .55rem"></select>
    </label>
    <label>Fecha<br><input id="paroDate" type="date" style="border:1px solid #e5e7eb;border-radius:10px;padding:.4rem .55rem"></label>
    <label>Horas<br><input id="paroHoras" type="number" step="0.5" min="0" value="2" style="border:1px solid #e5e7eb;border-radius:10px;padding:.4rem .55rem;width:90px"></label>
    <button id="paroAdd" class="btn-cdl">Planificar</button>
  </div>
  <div class="eq-table" id="parosTable"></div>
</section>
<script>
(function(){
  const KEY='cdl-paros';
  function list(){ try{return JSON.parse(localStorage.getItem(KEY))||[]}catch{return[]} }
  function save(arr){ localStorage.setItem(KEY, JSON.stringify(arr)) }
  function add(item){ const L=list(); L.unshift(item); save(L); }
  function fillEquipos(){
    const sel=document.getElementById('paroEq'); if(!sel) return;
    sel.innerHTML = api.listEquipos().map(e=>`<option value="${e.codigo}">${e.codigo} · ${e.nombre}</option>`).join('');
  }
  function render(){
    const t=document.getElementById('parosTable'); if(!t) return;
    const rows=list().map(p=>`<tr><td>${p.fecha}</td><td>${p.equipo}</td><td>${p.horas}h</td><td>${(p.detalle||'').replace(/</g,'&lt;')}</td></tr>`).join('');
    t.innerHTML=`<table><thead><tr><th>Fecha</th><th>Equipo</th><th>Horas</th><th>Detalle</th></tr></thead><tbody>${rows||'<tr><td colspan="4" class="eq-meta">Sin paros planificados</td></tr>'}</tbody></table>`;
  }
  document.getElementById('paroAdd')?.addEventListener('click', ()=>{
    const equipo=document.getElementById('paroEq').value;
    const fecha=document.getElementById('paroDate').value;
    if(!equipo||!fecha) return alert('Falta equipo o fecha');
    const horas=Number(document.getElementById('paroHoras').value||0);
    const detalle=prompt('Detalle (opcional):')||'';
    add({equipo, fecha, horas, detalle});
    render();
  });
  function route(){
    const v=document.getElementById('parosView'); v.hidden = (location.hash!=='#/paros');
    if(!v.hidden){ fillEquipos(); render(); }
  }
  window.addEventListener('hashchange', route); route();
})();
</script>

<!-- =========================================================
BLOQUE 193 — Comparativa entre equipos (#/comparar)
========================================================= -->
<section id="cmpView" class="cdl-container" hidden>
  <h2>Comparativa</h2>
  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:end;margin:.4rem 0 10px">
    <label>Equipos (códigos separados por coma)<br>
      <input id="cmpCodes" type="text" placeholder="EQ-001,EQ-002" style="border:1px solid #e5e7eb;border-radius:10px;padding:.4rem .55rem;min-width:280px">
    </label>
    <button id="cmpRun" class="btn-cdl">Comparar</button>
  </div>
  <div id="cmpWrap"></div>
</section>
<style>
  .bar{height:18px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .bar>i{display:block;height:100%;background:var(--cdl-red);width:0%}
</style>
<script>
(function(){
  function calc(eq){
    // Usa misma lógica que KPIs (últimos 90 días)
    const to=Date.now(), from=to-90*86400000;
    let m=0,r=0,p=0, rep=0;
    api.listEventos(eq.codigo).forEach(e=>{
      if(e.ts<from||e.ts>to) return;
      if(e.tipo==='Marcha') m+=Number(e.horas||0);
      if(e.tipo==='Restricción') r+=Number(e.horas||0);
      if(e.tipo==='Paro') p+=Number(e.horas||0);
      if(e.tipo==='Reparación') rep++;
    });
    const total=(m+r+p)||1, dispo=(m/total)*100, mtbf=m/Math.max(1,rep);
    return {m,r,p,dispo,mtbf};
  }
  function render(codes){
    const wrap=document.getElementById('cmpWrap'); if(!wrap) return;
    const eqs = (codes||[]).map(c=>api.getEquipo(c)).filter(Boolean);
    if(eqs.length===0){ wrap.innerHTML='<p class="eq-meta">Indica al menos un código válido.</p>'; return; }
    const data = eqs.map(e=>({e, k:calc(e)}));
    const maxM=Math.max(...data.map(d=>d.k.m),1), maxMTBF=Math.max(...data.map(d=>d.k.mtbf),1);
    wrap.innerHTML = data.map(d=>{
      return `<article class="eq-card" style="padding:10px">
        <div class="eq-title"><span>${d.e.nombre}</span><small class="eq-meta">#${d.e.codigo}</small></div>
        <div style="display:grid;gap:8px">
          <div><small>Disponibilidad ${d.k.dispo.toFixed(1)}%</small><div class="bar"><i style="width:${d.k.dispo}%"></i></div></div>
          <div><small>Horas marcha ${d.k.m.toFixed(1)}h</small><div class="bar"><i style="width:${(d.k.m/maxM)*100}%"></i></div></div>
          <div><small>MTBF ${d.k.mtbf.toFixed(1)}h</small><div class="bar"><i style="width:${(d.k.mtbf/maxMTBF)*100}%"></i></div></div>
        </div>
      </article>`;
    }).join('');
  }
  document.getElementById('cmpRun')?.addEventListener('click', ()=>{
    const codes=(document.getElementById('cmpCodes').value||'').split(',').map(s=>s.trim()).filter(Boolean);
    render(codes);
  });
  function route(){
    const v=document.getElementById('cmpView'); v.hidden = (location.hash!=='#/comparar');
    if(!v.hidden){ const first=api.listEquipos().slice(0,2).map(e=>e.codigo); document.getElementById('cmpCodes').value = first.join(','); render(first); }
  }
  window.addEventListener('hashchange', route); route();
})();
</script>

<!-- =========================================================
BLOQUE 194 — Exportar a Excel (XLS) simple desde cualquier tabla visible
========================================================= -->
<script>
(function(){
  function exportTableAsExcel(tableEl, name){
    const html = tableEl.outerHTML.replace(/ /g, '%20');
    const uri = 'data:application/vnd.ms-excel;charset=utf-8,' + html;
    const a=document.createElement('a'); a.href=uri; a.download=(name||'export')+'.xls'; a.click();
  }
  // Botón adicional en KPIs si existe
  const kpiTbl=document.getElementById('kpiTable');
  if(kpiTbl){
    const btn=document.createElement('button'); btn.className='btn-cdl'; btn.textContent='Exportar Excel'; btn.style.marginLeft='6px';
    document.getElementById('kpiCsv')?.after(btn);
    btn.onclick=()=>{ const t=kpiTbl.querySelector('table'); if(!t) return alert('Calcula primero'); exportTableAsExcel(t,'kpi'); };
  }
  // Exponer util por si lo quieres reusar:
  window.exportTableAsExcel = exportTableAsExcel;
})();
</script>

<!-- =========================================================
BLOQUE 196 — Mini-API Google Sheets (stub) para futura sincronización
========================================================= -->
<script>
/*
  Uso futuro (cuando conectemos credenciales/endpoint):
  CDLSheets.push([{type:'evento', code:'EQ-001', data:{...}}, ...])
  Implementa colas y reintentos; ahora sólo loguea.
*/
(function(){
  const QUE='cdl-sheets-q';
  function q(){ try{return JSON.parse(localStorage.getItem(QUE))||[]}catch{return[]} }
  function set(v){ localStorage.setItem(QUE, JSON.stringify(v)); }
  async function flush(){
    if(!navigator.onLine) return;
    const items=q(); if(items.length===0) return;
    // Aquí integrarías fetch hacia tu Apps Script/endpoint:
    console.log('[Sheets] Envío simulado', items);
    set([]); // limpiar si éxito
  }
  function push(arr){
    const cur=q(); set(cur.concat(arr||[]));
    flush();
  }
  window.CDLSheets={push, flush};
  window.addEventListener('online', flush);
})();
</script>

<!-- =========================================================
BLOQUE 197 — Accesibilidad: atajos, roles ARIA y foco
========================================================= -->
<script>
(function(){
  // Atajo / para buscar
  window.addEventListener('keydown', (e)=>{ if(e.key==='/' && !/input|textarea|select/i.test(document.activeElement.tagName)){ e.preventDefault(); document.getElementById('searchBox')?.focus(); } });
  // Marcar dinámicos con aria-live
  document.getElementById('equiposGrid')?.setAttribute('aria-live','polite');
  document.getElementById('kpiTable')?.setAttribute('aria-live','polite');
})();
</script>

<!-- =========================================================
BLOQUE 198 — Enlaces en el menú a nuevas vistas (si no existen)
========================================================= -->
<script>
(function(){
  const nav=document.querySelector('.cdl-panel__nav'); if(!nav) return;
  function add(href, label){
    if(nav.querySelector(`a[href="${href}"]`)) return;
    const a=document.createElement('a'); a.href=href; a.textContent=label; nav.appendChild(a);
  }
  add('#/paros','Paros');
  add('#/comparar','Comparar');
  add('#/repuestos','Repuestos');
})();
</script>

<!-- =========================================================
BLOQUE 199 — Pulido visual final (alineación, espaciados, microdetalles)
========================================================= -->
<style>
  /* Consistencia en paddings de tarjetas */
  .eq-card__body{ padding:14px }
  /* Tabla compacta en TV */
  #tvView .eq-card__body{ padding:12px }
  /* Inputs uniformes */
  input[type="date"],input[type="number"],input[type="search"],select{ font: inherit }
  /* Hover sutil en tarjetas */
  .eq-card{ transition: box-shadow .15s ease }
  .eq-card:hover{ box-shadow: 0 8px 24px rgba(17,24,39,.06) }
</style>

<!-- =========================================================
BLOQUE 200 — HERRAMIENTAS (#/herramientas): inventario básico + asignación
========================================================= -->
<section id="herrView" class="cdl-container" hidden>
  <h2>Herramientas</h2>
  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:end;margin:.4rem 0 10px">
    <label>Buscar<br><input id="herrQ" type="search" placeholder="código o nombre" style="border:1px solid #e5e7eb;border-radius:10px;padding:.4rem .55rem"></label>
    <button id="herrNewBtn" class="btn-cdl">Nueva herramienta</button>
    <button id="herrCsvBtn" class="btn-cdl" style="background:#111">Exportar CSV</button>
  </div>
  <div id="herrTable" class="eq-table" aria-live="polite"></div>
</section>
<script>
(function(){
  const KEY='cdl-herr';
  function list(){ try{return JSON.parse(localStorage.getItem(KEY))||[]}catch{return[]} }
  function save(v){ localStorage.setItem(KEY, JSON.stringify(v)) }
  function upsert(h){ const L=list(); const i=L.findIndex(x=>x.codigo===h.codigo); if(i>=0) L[i]={...L[i],...h}; else L.push(h); save(L); }
  function setAsignacion(codigo, equipo){ const L=list(); const i=L.findIndex(x=>x.codigo===codigo); if(i<0) return; L[i].equipo=equipo||''; save(L); }
  function exportCSV(){
    const head='codigo,nombre,estado,equipo';
    const lines=list().map(h=>[h.codigo, `"${(h.nombre||'').replace(/"/g,'""')}"`, h.estado||'', h.equipo||''].join(',')).join('\n');
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([[head,lines].join('\n')],{type:'text/csv'})); a.download='herramientas.csv'; a.click();
  }
  function render(q){
    const t=document.getElementById('herrTable'); if(!t) return;
    const s=(q||'').toLowerCase();
    const L=list().filter(h=>!s || h.codigo?.toLowerCase().includes(s) || (h.nombre||'').toLowerCase().includes(s));
    const eqOpts = api.listEquipos().map(e=>`<option value="${e.codigo}">${e.codigo}</option>`).join('');
    t.innerHTML = `<table><thead><tr>
      <th>Código</th><th>Nombre</th><th>Estado</th><th>Asignada a</th><th>Acciones</th>
    </tr></thead><tbody>${
      L.map(h=>`<tr>
        <td>${h.codigo}</td>
        <td>${(h.nombre||'').replace(/</g,'&lt;')}</td>
        <td>${h.estado||'Disponible'}</td>
        <td>${h.equipo||'—'}</td>
        <td style="white-space:nowrap">
          <button class="btn-cdl" data-asg="${h.codigo}" style="padding:.35rem .6rem">Asignar</button>
          <button class="btn-cdl" data-free="${h.codigo}" style="padding:.35rem .6rem;background:#111">Liberar</button>
        </td>
      </tr>`).join('') || `<tr><td colspan="5" class="eq-meta">Sin herramientas</td></tr>`
    }</tbody></table>`;
    t.querySelectorAll('[data-asg]').forEach(b=>b.onclick=()=>{
      const wrap=document.createElement('div'); wrap.innerHTML=`<select id="asgSel" style="border:1px solid #e5e7eb;border-radius:10px;padding:.35rem .5rem">${eqOpts}</select>`;
      const tmp=prompt('Código de equipo para asignar (p.ej. EQ-001). Si cancelas, se abrirá desplegable.'); 
      if(tmp){ setAsignacion(b.dataset.asg, tmp); render(document.getElementById('herrQ').value); }
      else { setTimeout(()=>{ const v=prompt('Selecciona código de equipo (sugerencia: '+(api.listEquipos()[0]?.codigo||'EQ-001')+')'); if(v){ setAsignacion(b.dataset.asg, v); render(document.getElementById('herrQ').value); }},0); }
    });
    t.querySelectorAll('[data-free]').forEach(b=>b.onclick=()=>{ setAsignacion(b.dataset.free,''); render(document.getElementById('herrQ').value); });
  }
  document.getElementById('herrQ')?.addEventListener('input', e=>render(e.target.value));
  document.getElementById('herrNewBtn')?.addEventListener('click', ()=>{
    const codigo=prompt('Código:'); if(!codigo) return;
    const nombre=prompt('Nombre/Descripción:')||'';
    const estado=prompt('Estado (Disponible, En uso, Avería):','Disponible')||'Disponible';
    upsert({codigo, nombre, estado, equipo:''}); render(document.getElementById('herrQ').value);
  });
  document.getElementById('herrCsvBtn')?.addEventListener('click', exportCSV);
  function route(){
    const v=document.getElementById('herrView'); v.hidden = (location.hash!=='#/herramientas');
    if(!v.hidden) render((document.getElementById('herrQ')||{}).value||'');
  }
  window.addEventListener('hashchange', route); route();
  // Exponer por consola
  window.CDLTools={list, upsert, setAsignacion};
})();
</script>

<!-- =========================================================
BLOQUE 201 — Enlazar HERRAMIENTAS en el menú si no existe
========================================================= -->
<script>
(function(){
  const nav=document.querySelector('.cdl-panel__nav'); if(!nav) return;
  if(!nav.querySelector('a[href="#/herramientas"]')){ const a=document.createElement('a'); a.href='#/herramientas'; a.textContent='Herramientas'; nav.appendChild(a); }
})();
</script>

<!-- =========================================================
BLOQUE 202 — ROLES Y PERMISOS: definición + guardado en localStorage
========================================================= -->
<script>
/*
  Roles soportados:
  - lector: solo lectura
  - operador: añade eventos, cambia semáforos
  - supervisor: además gestiona repuestos/herramientas
  - admin: todo + ajustes
*/
(function(){
  const KEY='cdl-role';
  function get(){ return localStorage.getItem(KEY)||'operador' }
  function set(r){ localStorage.setItem(KEY, r) }
  // UI rápida en cabecera (junto a área de usuario)
  const box=document.createElement('div');
  box.style.marginLeft='6px';
  box.innerHTML=`<select id="cdlRoleSel" aria-label="Rol de usuario" style="border:1px solid #e5e7eb;border-radius:8px;padding:.35rem .4rem">
    <option value="lector">Lector</option>
    <option value="operador">Operador</option>
    <option value="supervisor">Supervisor</option>
    <option value="admin">Admin</option>
  </select>`;
  document.querySelector('.cdl-user')?.appendChild(box);
  const sel=box.querySelector('#cdlRoleSel'); sel.value=get();
  sel.addEventListener('change', ()=>{ set(sel.value); apply(); alert('Rol aplicado: '+sel.value); });
  // Aplicar permisos usando data-role
  function allow(role, need){
    const order=['lector','operador','supervisor','admin'];
    return order.indexOf(role)>=order.indexOf(need);
  }
  function apply(){
    const role=get();
    document.querySelectorAll('[data-role]').forEach(el=>{
      const need=el.getAttribute('data-role');
      el.toggleAttribute('disabled', !allow(role, need));
      el.style.pointerEvents = allow(role, need)? 'auto' : 'none';
      el.style.opacity = allow(role, need)? '1' : '.5';
      if(el.tagName==='A' && !allow(role, need)) el.setAttribute('tabindex','-1');
    });
    // Ocultar vistas enteras si no hay permiso
    const guard = [
      ['#/repuestos','supervisor'],
      ['#/herramientas','supervisor'],
      ['#/ajustes','admin']
    ];
    const h=location.hash;
    guard.forEach(([path, need])=>{
      if(h===path && !allow(role, need)){ alert('Permiso requerido: '+need); location.hash='#/equipos'; }
    });
  }
  window.addEventListener('hashchange', apply);
  window.addEventListener('load', apply);
  window.CDLRole={get,set};
})();
</script>

<!-- =========================================================
BLOQUE 203 — Marcar acciones sensibles con data-role
========================================================= -->
<script>
(function(){
  // Botones que ya existen: añadir evento, cambiar estado, crear repuesto/herramienta, etc.
  // Marcas progresivas (si aún no están)
  function mark(){
    document.querySelectorAll('.cdl-sem .btn').forEach(b=>b.setAttribute('data-role','operador'));
    document.querySelectorAll('button[onclick^="registrarEvento"]').forEach(b=>b.setAttribute('data-role','operador'));
    document.querySelector('#repNewBtn')?.setAttribute('data-role','supervisor');
    document.querySelector('#herrNewBtn')?.setAttribute('data-role','supervisor');
  }
  mark(); // inicial
  // Reaplicar cuando cambie de vista
  window.addEventListener('hashchange', ()=>setTimeout(mark, 0));
})();
</script>

<!-- =========================================================
BLOQUE 204 — Adjuntos en eventos: input file + vista previa + descarga
========================================================= -->
<script>
(function(){
  // 1) Insertar input file y preview en el form de eventos existente
  function enhanceForm(){
    const form=document.getElementById('evtForm'); if(!form || form.querySelector('#evtFiles')) return;
    const lbl=document.createElement('label');
    lbl.innerHTML=`Adjuntos (fotos/pdf)<input id="evtFiles" type="file" multiple accept=".jpg,.jpeg,.png,.pdf" />`;
    const prev=document.createElement('div'); prev.id='evtPrev'; prev.style.display='grid'; prev.style.gap='6px'; prev.style.marginTop='6px';
    form.appendChild(lbl); form.appendChild(prev);
    const filesInput=lbl.querySelector('#evtFiles');
    filesInput.addEventListener('change', ()=>{
      prev.innerHTML='';
      [...filesInput.files].forEach(f=>{ const p=document.createElement('small'); p.textContent='• '+f.name; prev.appendChild(p); });
    });
  }
  // 2) Envolver pushEvt para guardar base64 de adjuntos
  const originalPush = window.pushEvt;
  window.pushEvt = async function(codigo, evt){
    try{
      const filesInput=document.getElementById('evtFiles');
      if(filesInput && filesInput.files && filesInput.files.length){
        evt.files=[];
        for(const f of filesInput.files){
          const data = await new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f); });
          evt.files.push({name:f.name, type:f.type, data});
        }
      }
    }catch(e){ console.warn('Adjuntos no guardados', e); }
    originalPush(codigo, evt);
  };
  // 3) Reemplazar la tabla de histórico para mostrar clip adjunto + enlaces
  function renderWithFiles(){
    const h=location.hash;
    if(!h.startsWith('#/equipo/')) return;
    const code=decodeURIComponent(h.split('/')[2]||'');
    const key='cdl-evt-'+code;
    let L=[]; try{ L=JSON.parse(localStorage.getItem(key))||[] }catch{}
    const wrap=document.getElementById('eqTable'); if(!wrap) return;
    const tbl=document.createElement('table');
    tbl.innerHTML=`<thead><tr><th>Fecha</th><th>Tipo</th><th>Horas</th><th>Coste €</th><th>Detalle</th><th>Adj.</th></tr></thead>
      <tbody>${
        L.map(e=>{
          const links=(e.files||[]).map((f,i)=>`<a href="${f.data}" download="${f.name}" title="${f.name}">📎${i+1}</a>`).join(' ');
          return `<tr>
            <td>${new Date(e.ts).toLocaleString()}</td>
            <td>${e.tipo}</td>
            <td>${e.horas||''}</td>
            <td>${e.coste||''}</td>
            <td>${(e.detalle||'').replace(/</g,'&lt;')}</td>
            <td style="white-space:nowrap">${links||''}</td>
          </tr>`;
        }).join('') || '<tr><td colspan="6" class="eq-meta">Sin eventos</td></tr>'
      }</tbody>`;
    wrap.innerHTML=''; wrap.appendChild(tbl);
  }
  window.addEventListener('hashchange', ()=>setTimeout(()=>{ enhanceForm(); renderWithFiles(); }, 0));
  window.addEventListener('load', ()=>{ enhanceForm(); setTimeout(renderWithFiles, 0); });
})();
</script>

<!-- =========================================================
BLOQUE 205 — Omnibox (Ctrl+K / ⌘K): búsqueda global equipos, repuestos, herramientas
========================================================= -->
<div id="omnibox" hidden>
  <div id="omniboxBox" role="dialog" aria-modal="true" aria-label="Búsqueda global">
    <input id="omniboxInput" type="search" placeholder="Buscar en equipos, repuestos y herramientas… (Esc para cerrar)">
    <div id="omniboxRes"></div>
  </div>
</div>
<style>
  #omnibox{ position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:1300; display:grid; place-items:start center; padding-top:10vh; }
  #omniboxBox{ width:min(720px,92vw); background:#fff; border:1px solid #e5e7eb; border-radius:14px; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,.18) }
  #omniboxInput{ width:100%; padding:12px 14px; border:0; border-bottom:1px solid #f1f5f9; font-size:1rem }
  #omniboxRes{ max-height:60vh; overflow:auto }
  .omni-item{ padding:10px 14px; border-bottom:1px solid #f8fafc; cursor:pointer }
  .omni-k{ color:#6b7280; font-size:.88rem }
</style>
<script>
(function(){
  const overlay=document.getElementById('omnibox');
  const input=document.getElementById('omniboxInput');
  const res=document.getElementById('omniboxRes');
  function open(){ overlay.hidden=false; input.value=''; render(''); input.focus(); }
  function close(){ overlay.hidden=true; }
  function render(q){
    const s=(q||'').toLowerCase();
    const eq=api.listEquipos().filter(e=>!s || e.nombre.toLowerCase().includes(s) || e.codigo.toLowerCase().includes(s))
      .map(e=>({t:'Equipo', k:`${e.codigo} · ${e.nombre}`, href:`#/equipo/${e.codigo}`}));
    const rp=(window.CDLParts?.list()||[]).filter(r=>!s || r.codigo.toLowerCase().includes(s) || (r.nombre||'').toLowerCase().includes(s))
      .map(r=>({t:'Repuesto', k:`${r.codigo} · ${r.nombre||''}`, href:'#/repuestos'}));
    const hr=(window.CDLTools?.list()||[]).filter(h=>!s || h.codigo.toLowerCase().includes(s) || (h.nombre||'').toLowerCase().includes(s))
      .map(h=>({t:'Herramienta', k:`${h.codigo} · ${h.nombre||''}`, href:'#/herramientas'}));
    const all=[...eq,...rp,...hr].slice(0,40);
    res.innerHTML = all.map(i=>`<div class="omni-item" data-href="${i.href}"><b>${i.t}</b> · <span class="omni-k">${i.k}</span></div>`).join('') || `<div class="omni-item"><span class="eq-meta">Sin resultados</span></div>`;
    res.querySelectorAll('.omni-item[data-href]').forEach(n=>n.onclick=()=>{ location.hash=n.dataset.href; close(); });
  }
  window.addEventListener('keydown', (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); open(); }
    if(e.key==='Escape' && !overlay.hidden){ e.preventDefault(); close(); }
  });
  overlay.addEventListener('click', (e)=>{ if(e.target===overlay) close(); });
  input.addEventListener('input', ()=>render(input.value));
})();
</script>

<!-- =========================================================
BLOQUE 206 — QR por lote (#/qr-lote): generar e imprimir múltiples
========================================================= -->
<section id="qrLoteView" class="cdl-container" hidden>
  <h2>QR por lote</h2>
  <div style="display:grid;gap:8px;max-width:720px">
    <label>Códigos de equipo (separados por comas o saltos de línea)
      <textarea id="qrLoteInput" rows="3" placeholder="EQ-001, EQ-002, EQ-003" style="border:1px solid #e5e7eb;border-radius:10px;padding:.6rem"></textarea>
    </label>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="qrLoteGen" class="btn-cdl">Generar</button>
      <button id="qrLotePrint" class="btn-cdl" style="background:#111">Imprimir</button>
    </div>
  </div>
  <div id="qrLoteGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:12px"></div>
</section>
<script>
(function(){
  function parseCodes(raw){
    return (raw||'').split(/[\s,;]+/).map(s=>s.trim()).filter(Boolean);
  }
  function render(codes){
    const grid=document.getElementById('qrLoteGrid'); grid.innerHTML='';
    codes.forEach(c=>{
      const card=document.createElement('article'); card.className='eq-card';
      card.innerHTML=`<div class="eq-card__body">
        <div class="eq-title"><span>QR ${c}</span><small class="eq-meta">${location.hostname}</small></div>
        <div class="eq-qr-big" id="qrL-${c}"></div>
      </div>`;
      grid.appendChild(card);
      qrMake(card.querySelector('#qrL-'+c), location.origin+location.pathname+'#/equipo/'+encodeURIComponent(c), 180);
    });
  }
  document.getElementById('qrLoteGen')?.addEventListener('click', ()=>{
    const codes=parseCodes(document.getElementById('qrLoteInput').value);
    if(codes.length===0) return alert('Indica códigos de equipo');
    render(codes);
  });
  document.getElementById('qrLotePrint')?.addEventListener('click', ()=>window.print());
  function route(){
    const v=document.getElementById('qrLoteView'); v.hidden = (location.hash!=='#/qr-lote');
    if(!v.hidden && !document.getElementById('qrLoteInput').value){
      document.getElementById('qrLoteInput').value = api.listEquipos().map(e=>e.codigo).join(', ');
    }
  }
  window.addEventListener('hashchange', route); route();
})();
</script>

<!-- =========================================================
BLOQUE 207 — Añadir acceso a QR por lote al menú
========================================================= -->
<script>
(function(){
  const nav=document.querySelector('.cdl-panel__nav'); if(!nav) return;
  if(!nav.querySelector('a[href="#/qr-lote"]')){ const a=document.createElement('a'); a.href='#/qr-lote'; a.textContent='QR por lote'; nav.appendChild(a); }
})();
</script>

<!-- =========================================================
BLOQUE 208 — Rendimiento: generación diferida de QR en lista (idle)
========================================================= -->
<script>
(function(){
  // En la lista de equipos, difiere la generación del QR para no bloquear UI
  const _qrMake = window.qrMake;
  window.qrMake = function(el, url, size){
    if('requestIdleCallback' in window){
      requestIdleCallback(()=>_qrMake(el,url,size||120), {timeout:500});
    }else{
      setTimeout(()=>_qrMake(el,url,size||120), 0);
    }
  };
})();
</script>

<!-- =========================================================
BLOQUE 209 — Micro-pulidos de estilo y foco
========================================================= -->
<style>
  /* Unificar esquinas */
  input, select, textarea { border-radius:10px }
  /* Estados de foco visibles (AA) */
  :is(button, a, input, select, textarea):focus { outline:3px solid rgba(228,59,59,.35); outline-offset:2px }
  /* Cabecera en impresión (oculta) ya definida; añadimos QR-lote: mostrar solo grid */
  @media print{
    #qrLoteInput, #qrLoteGen { display:none !important }
  }
</style>

<!-- =========================================================
BLOQUE 210 — Dashboard de incidencias por semana (#/incidencias-dash)
========================================================= -->
<section id="incDashView" class="cdl-container" hidden>
  <h2>Incidencias (últimas 8 semanas)</h2>
  <p class="eq-meta">Averías, Restricciones, Paros y Reparaciones registradas en las fichas de equipo.</p>
  <div style="display:grid;gap:10px;max-width:980px">
    <canvas id="incDashCanvas" width="980" height="360" role="img" aria-label="Gráfico de incidencias por semana"></canvas>
    <div id="incDashLegend" class="eq-meta"></div>
  </div>
</section>
<script>
(function(){
  // Shim mínimo de API si faltara (usa localStorage de equipos ya existente)
  window.api = window.api || {};
  api.listEquipos = api.listEquipos || function(){
    try{ return JSON.parse(localStorage.getItem('cdl-equipos')) || [] }catch{return []}
  };
  function getAllEvents(){
    const list = api.listEquipos();
    let out = [];
    list.forEach(eq=>{
      try{
        const ev = JSON.parse(localStorage.getItem('cdl-evt-'+eq.codigo))||[];
        ev.forEach(e=>out.push({...e, __eq:eq.codigo}));
      }catch{}
    });
    return out;
  }
  function weekKey(ts){
    const d=new Date(ts); // ISO week approx (Mon-based)
    const day=(d.getDay()+6)%7; // 0..6 (Mon..Sun)
    d.setDate(d.getDate()-day);
    d.setHours(0,0,0,0);
    const y=d.getFullYear();
    const w=Math.floor((d - new Date(y,0,1))/ (7*24*3600*1000)) + 1;
    return y+'-W'+String(w).padStart(2,'0');
  }
  function computeSeries(){
    const events=getAllEvents();
    const map=new Map();
    events.forEach(e=>{
      const k=weekKey(e.ts||Date.now());
      const o=map.get(k)||{Avería:0,Restricción:0,Paro:0,Reparación:0};
      if(o[e.tipo]!=null) o[e.tipo]++; map.set(k,o);
    });
    // últimas 8 semanas (orden ascendente)
    const keys=[...map.keys()].sort().slice(-8);
    const series={
      keys,
      data:{
        Avería:keys.map(k=>map.get(k)?.Avería||0),
        Restricción:keys.map(k=>map.get(k)?.Restricción||0),
        Paro:keys.map(k=>map.get(k)?.Paro||0),
        Reparación:keys.map(k=>map.get(k)?.Reparación||0)
      }
    };
    return series;
  }
  function drawBarChart(canvas, series){
    const ctx=canvas.getContext('2d');
    const W=canvas.width, H=canvas.height, PAD=42;
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H);
    // ejes
    const keys=series.keys;
    const groups=keys.length;
    const cats=['Avería','Restricción','Paro','Reparación'];
    const colors=['#EF4444','#F59E0B','#111827','#10B981'];
    const gw=(W-PAD*2)/Math.max(1,groups);
    const barw= Math.min(28, (gw-16)/cats.length);
    const maxY=Math.max(1, ...cats.map(c=>Math.max(...series.data[c])));
    // grid
    ctx.strokeStyle='#E5E7EB'; ctx.lineWidth=1;
    const steps=Math.min(5, maxY);
    for(let i=0;i<=steps;i++){
      const y = H-PAD - (H-PAD*2)*(i/steps);
      ctx.beginPath(); ctx.moveTo(PAD,y); ctx.lineTo(W-PAD,y); ctx.stroke();
      ctx.fillStyle='#6B7280'; ctx.font='12px Inter, Arial'; ctx.fillText(String(Math.round(maxY*i/steps)), 8, y+4);
    }
    // barras
    keys.forEach((k,gi)=>{
      cats.forEach((c,ci)=>{
        const v=series.data[c][gi];
        const x=PAD + gw*gi + 8 + ci*barw;
        const h=((H-PAD*2) * (v/maxY))||0;
        const y=H-PAD-h;
        ctx.fillStyle=colors[ci];
        ctx.fillRect(x,y,barw-2,h);
      });
      // etiqueta X
      ctx.fillStyle='#6B7280'; ctx.font='12px Inter, Arial';
      const label=k.slice(-3); // Wxx
      ctx.fillText(label, PAD + gw*gi + 8, H-PAD+16);
    });
  }
  function renderDash(){
    const view=document.getElementById('incDashView');
    if(!view || view.hidden) return;
    const s=computeSeries();
    const canvas=document.getElementById('incDashCanvas');
    drawBarChart(canvas, s);
    const legend=document.getElementById('incDashLegend');
    legend.innerHTML=`<span style="color:#EF4444">■</span> Avería &nbsp; <span style="color:#F59E0B">■</span> Restricción &nbsp; <span style="color:#111827">■</span> Paro &nbsp; <span style="color:#10B981">■</span> Reparación`;
  }
  function route(){
    const v=document.getElementById('incDashView'); if(!v) return;
    v.hidden = (location.hash!=='#/incidencias-dash');
    if(!v.hidden) { setTimeout(renderDash, 0); }
  }
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);
})();
</script>

<!-- =========================================================
BLOQUE 211 — Enlace de menú a Incidencias (dash)
========================================================= -->
<script>
(function(){
  const nav=document.querySelector('.cdl-panel__nav'); if(!nav) return;
  if(!nav.querySelector('a[href="#/incidencias-dash"]')){
    const a=document.createElement('a'); a.href='#/incidencias-dash'; a.textContent='Incidencias (dash)';
    nav.insertBefore(a, nav.querySelector('a[href="#/repuestos"]')||null);
  }
})();
</script>

<!-- =========================================================
BLOQUE 212 — Filtros avanzados en Equipos (estado + disponibilidad mínima)
========================================================= -->
<section id="eqFilters" class="cdl-container" hidden>
  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:end;margin:.2rem 0 8px">
    <label>Estado<br>
      <select id="fEstado" style="border:1px solid #e5e7eb;border-radius:10px;padding:.45rem .55rem">
        <option value="">Todos</option>
        <option>En marcha</option>
        <option>Restricciones</option>
        <option>Parada</option>
      </select>
    </label>
    <label>Disponibilidad ≥ %<br>
      <input id="fDispo" type="number" min="0" max="100" placeholder="0" style="border:1px solid #e5e7eb;border-radius:10px;padding:.45rem .55rem;width:120px">
    </label>
    <button id="fApply" class="btn-cdl">Aplicar</button>
    <button id="fClear" class="btn-cdl" style="background:#111">Limpiar</button>
  </div>
</section>
<script>
(function(){
  // guardamos filtros en memoria global
  window.__EQF__ = window.__EQF__ || {estado:'', dispo:0};
  // Hook: mostrar barra de filtros únicamente en #/equipos
  function showFilters(){
    const isEq = (location.hash.split('?')[0]==='#/equipos' || location.hash==='' );
    const el=document.getElementById('eqFilters'); if(!el) return;
    el.hidden = !isEq;
  }
  // Monkey-patch de renderEquipos para aplicar filtro de disponibilidad (calculada)
  const _renderEq = window.renderEquipos;
  window.renderEquipos = function(list, query){
    const F=window.__EQF__;
    const filtered = list.filter(eq=>{
      if(F.estado && eq.estado!==F.estado) return false;
      if(F.dispo>0){
        // calcular disponibilidad con los eventos como en calcKPIs
        let horas = { ...(eq.horas || { m:0, r:0, p:0 }) };
        try{ (JSON.parse(localStorage.getItem('cdl-evt-'+eq.codigo))||[]).forEach(e=>{
          if(e.tipo==='Marcha') horas.m+=Number(e.horas||0);
          if(e.tipo==='Restricción') horas.r+=Number(e.horas||0);
          if(e.tipo==='Paro') horas.p+=Number(e.horas||0);
        }) }catch{}
        const total=horas.m+horas.r+horas.p||1;
        const dispo= (horas.m/total)*100;
        if(dispo < F.dispo) return false;
      }
      return true;
    });
    _renderEq(filtered, query);
  };
  // eventos UI
  document.getElementById('fApply')?.addEventListener('click', ()=>{
    window.__EQF__.estado = document.getElementById('fEstado').value;
    window.__EQF__.dispo = Number(document.getElementById('fDispo').value||0);
    // re-render si estamos en lista
    if((location.hash||'').startsWith('#/equipos')) window.dispatchEvent(new HashChangeEvent('hashchange'));
  });
  document.getElementById('fClear')?.addEventListener('click', ()=>{
    window.__EQF__ = {estado:'', dispo:0};
    document.getElementById('fEstado').value='';
    document.getElementById('fDispo').value='';
    if((location.hash||'').startsWith('#/equipos')) window.dispatchEvent(new HashChangeEvent('hashchange'));
  });
  window.addEventListener('hashchange', showFilters);
  window.addEventListener('load', showFilters);
})();
</script>

<!-- =========================================================
BLOQUE 213 — Afinado visual cabecera: sombra al hacer scroll y alineaciones
========================================================= -->
<style>
  .cdl-header.scrolled{ box-shadow:0 6px 20px rgba(17,24,39,.06); }
  .cdl-logo img{ display:block; height:28px; width:auto }
</style>
<script>
(function(){
  const hdr=document.getElementById('cdlHeader');
  function onScroll(){ hdr?.classList.toggle('scrolled', window.scrollY>2); }
  window.addEventListener('scroll', onScroll, {passive:true}); onScroll();
})();
</script>

<!-- =========================================================
BLOQUE 214 — Titulares: mini-logo en esquina (cumple “siempre aparece el logo”)
========================================================= -->
<style>
  :where(h1,h2,h3)::after{
    content:""; position:absolute; left:-28px; top:-4px; width:22px; height:22px;
    background:url('./logo-cdl.png') center/contain no-repeat; opacity:.95;
  }
  @media(max-width:640px){ :where(h1,h2,h3)::after{ left:-24px; width:18px; height:18px } }
</style>

<!-- =========================================================
BLOQUE 215 — Ficha de herramienta (#/herramienta/<codigo>) con QR y asignación
========================================================= -->
<section id="herrFichaView" class="cdl-container" hidden>
  <a href="#/herramientas" class="btn-cdl" style="background:#111;margin-top:8px">← Volver</a>
  <header style="margin-top:10px">
    <h2 id="hfName">Herramienta</h2>
    <p id="hfMeta" class="eq-meta"></p>
  </header>
  <div class="cdl-divider"></div>
  <div style="display:grid;grid-template-columns:1fr .8fr;gap:14px;max-width:980px">
    <div>
      <div class="kpi"><b id="hfEstado">—</b><span>Estado</span></div>
      <div class="kpi"><b id="hfAsign">—</b><span>Asignada a</span></div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="hfAsignBtn" class="btn-cdl" data-role="supervisor">Asignar a equipo</button>
        <button id="hfLiberarBtn" class="btn-cdl" style="background:#111" data-role="supervisor">Liberar</button>
      </div>
    </div>
    <aside class="eq-detail__right">
      <h3>QR de la herramienta</h3>
      <div id="hfQR" class="eq-qr-big"></div>
      <button class="btn-cdl" onclick="window.print()">Imprimir</button>
    </aside>
  </div>
</section>
<script>
(function(){
  function listHerr(){ try{return JSON.parse(localStorage.getItem('cdl-herr'))||[]}catch{return[]} }
  function saveHerr(L){ localStorage.setItem('cdl-herr', JSON.stringify(L)) }
  function showHerr(codigo){
    const L=listHerr(); const h=L.find(x=>x.codigo===codigo); if(!h){ location.hash='#/herramientas'; return; }
    const v=document.getElementById('herrFichaView'); v.hidden=false;
    document.getElementById('hfName').textContent = h.nombre||('Herramienta '+h.codigo);
    document.getElementById('hfMeta').textContent = `Código ${h.codigo}`;
    document.getElementById('hfEstado').textContent = h.estado||'Disponible';
    document.getElementById('hfAsign').textContent = h.equipo||'—';
    qrMake(document.getElementById('hfQR'), location.origin+location.pathname+'#/herramienta/'+encodeURIComponent(h.codigo), 180);
    // acciones
    document.getElementById('hfAsignBtn').onclick=()=>{
      const v=prompt('Código de equipo destino (p.ej. EQ-001):'); if(!v) return;
      h.equipo=v; saveHerr(L); showHerr(h.codigo);
    };
    document.getElementById('hfLiberarBtn').onclick=()=>{ h.equipo=''; saveHerr(L); showHerr(h.codigo); };
  }
  function route(){
    const h=location.hash.split('?')[0];
    document.getElementById('herrFichaView').hidden = !h.startsWith('#/herramienta/');
    if(h.startsWith('#/herramienta/')) showHerr(decodeURIComponent(h.split('/')[2]||''));
  }
  window.addEventListener('hashchange', route);
  window.addEventListener('load', ()=>{
    // navegación desde la tabla de herramientas (clic en código)
    const table = document.getElementById('herrTable');
    table?.addEventListener('click', (e)=>{
      const td=e.target.closest('td'); if(!td) return;
      const codeCell=td.parentElement?.children?.[0]; const code=codeCell?.textContent?.trim();
      if(code && td===codeCell){ location.hash = '#/herramienta/'+encodeURIComponent(code); }
    });
    route();
  });
})();
</script>

<!-- =========================================================
BLOQUE 216 — Exportar ficha de equipo a JSON (botón en ficha)
========================================================= -->
<script>
(function(){
  function addBtn(){
    if(document.getElementById('eqJSONBtn')) return;
    const wrap=document.querySelector('#equipoView header'); if(!wrap) return;
    const btn=document.createElement('button');
    btn.id='eqJSONBtn'; btn.className='btn-cdl'; btn.style.marginLeft='8px';
    btn.textContent='Exportar JSON';
    btn.setAttribute('data-role','operador');
    btn.onclick=()=>{
      const code=(document.getElementById('eqMeta').textContent.match(/Código\s([^\s·]+)/)||[])[1];
      if(!code) return;
      const eq=(api.listEquipos().find(e=>e.codigo===code))||{};
      let ev=[]; try{ ev=JSON.parse(localStorage.getItem('cdl-evt-'+code))||[] }catch{}
      const blob=new Blob([JSON.stringify({equipo:eq, eventos:ev}, null, 2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`ficha-${code}.json`; a.click();
    };
    wrap.appendChild(btn);
  }
  window.addEventListener('hashchange', ()=>setTimeout(addBtn,0));
  window.addEventListener('load', ()=>setTimeout(addBtn,0));
})();
</script>

<!-- =========================================================
BLOQUE 217 — Importar datos (equipos) desde JSON o CSV sencillo
========================================================= -->
<section id="importView" class="cdl-container" hidden>
  <h2>Importar datos</h2>
  <p class="eq-meta">Carga equipos desde un JSON (formato {codigo,nombre,estado,horas}) o CSV: codigo,nombre,estado.</p>
  <input id="impFile" type="file" accept=".json,.csv" />
  <div style="display:flex;gap:8px;margin-top:8px">
    <button id="impRun" class="btn-cdl" data-role="admin">Importar</button>
    <a class="btn-cdl" style="background:#111" href="data:application/json,[]" download="plantilla.json">Plantilla JSON</a>
  </div>
</section>
<script>
(function(){
  function parseCSV(txt){
    const lines=txt.split(/\r?\n/).filter(Boolean); const out=[];
    lines.forEach(L=>{
      const [codigo,nombre,estado]=L.split(','); if(!codigo) return;
      out.push({codigo:codigo.trim(), nombre:(nombre||'').replace(/^"|"$/g,'').trim(), estado:(estado||'').trim()||'Restricciones'});
    });
    return out;
  }
  function mergeEquipos(arr){
    let L=[]; try{ L=JSON.parse(localStorage.getItem('cdl-equipos'))||[] }catch{}
    arr.forEach(n=>{
      const i=L.findIndex(e=>e.codigo===n.codigo);
      if(i>=0) L[i]={...L[i], ...n}; else L.push(n);
    });
    localStorage.setItem('cdl-equipos', JSON.stringify(L));
  }
  document.getElementById('impRun')?.addEventListener('click', async ()=>{
    const f=document.getElementById('impFile')?.files?.[0]; if(!f) return alert('Selecciona un archivo');
    const text=await f.text();
    let payload=[];
    if(f.name.endsWith('.json')){
      try{ const j=JSON.parse(text); payload = Array.isArray(j)? j : (j.equipos||[]); }catch(e){ return alert('JSON inválido'); }
    }else{
      payload = parseCSV(text);
    }
    if(payload.length===0) return alert('No se encontró contenido');
    mergeEquipos(payload);
    alert('Importados: '+payload.length); location.hash='#/equipos';
  });
  function route(){
    const v=document.getElementById('importView'); if(!v) return;
    v.hidden = (location.hash!=='#/importar');
  }
  window.addEventListener('hashchange', route); window.addEventListener('load', route);
  // menú
  const nav=document.querySelector('.cdl-panel__nav');
  if(nav && !nav.querySelector('a[href="#/importar"]')){ const a=document.createElement('a'); a.href='#/importar'; a.textContent='Importar'; a.setAttribute('data-role','admin'); nav.appendChild(a); }
})();
</script>

<!-- =========================================================
BLOQUE 218 — “Look & feel” cdl.es: tipografías, espaciados y botones secundarios
========================================================= -->
<style>
  /* Botón secundario (negro) coherente */
  .btn-cdl--sec{ background:#111; color:#fff; box-shadow:0 8px 18px rgba(17,24,39,.18) }
  /* Enlaces del menú: peso alto, hover sutil */
  .cdl-panel__nav a{ font-weight:800; color:#111; }
  .cdl-panel__nav a:focus{ outline:3px solid rgba(228,59,59,.35) }
  /* Textos secundarios */
  .eq-meta{ color:#6b7280 }
  /* Tablas más “corporativas” */
  .eq-table th{ background:#F7F7F8; font-weight:800 }
  .eq-table tr:hover td{ background:#fafafa }
  /* Cartas y kpis */
  .kpi{ box-shadow:0 6px 14px rgba(17,24,39,.05) }
</style>

<!-- =========================================================
BLOQUE 219 — Accesibilidad + rendimiento: skeleton y roles ARIA
========================================================= -->
<style>
  .skeleton{ background:linear-gradient(90deg,#f3f4f6 25%,#e5e7eb 37%,#f3f4f6 63%); background-size:400% 100%; animation:sk 1.2s ease-in-out infinite }
  @keyframes sk{0%{background-position:100% 0}100%{background-position:-100% 0}}
</style>
<script>
(function(){
  // Añadir rol/list a la rejilla de equipos y skeleton al cargar
  const grid = document.getElementById('equiposGrid');
  if(grid){ grid.setAttribute('role','list'); }
  const _renderEq = window.renderEquipos;
  window.renderEquipos = function(list, query){
    if(grid){
      grid.innerHTML = '';
      for(let i=0;i<6;i++){
        const sk=document.createElement('div'); sk.className='eq-card skeleton'; sk.style.height='180px'; grid.appendChild(sk);
      }
    }
    setTimeout(()=>_renderEq(list, query), 120);
  };
  // Asegurar labels accesibles
  document.getElementById('searchBox')?.setAttribute('aria-label','Buscar equipo');
  document.getElementById('qrLoteInput')?.setAttribute('aria-label','Códigos de equipo');
})();
</script>

<!-- =========================================================
BLOQUE 220 — Vista TV (#/tv) con auto-rotación de equipos
========================================================= -->
<section id="tvView" hidden aria-label="Dashboard TV" style="inset:0;position:fixed;background:#fff;z-index:900">
  <div class="cdl-container" style="padding-top:10px">
    <header style="display:flex;align-items:center;justify-content:space-between;gap:10px">
      <h2 style="margin:0">Estado de equipos · TV</h2>
      <div style="display:flex;gap:8px;align-items:center">
        <label>Intervalo (s)
          <input id="tvInterval" type="number" min="3" value="6" style="width:72px;border:1px solid #e5e7eb;border-radius:10px;padding:.35rem .5rem">
        </label>
        <label>Filtrar
          <select id="tvFilter" style="border:1px solid #e5e7eb;border-radius:10px;padding:.35rem .5rem">
            <option value="">Todos</option>
 
 <!-- =========================================================
BLOQUE 230 — Tipografía/CDL: microajustes de legibilidad y ritmo vertical
========================================================= -->
<style>
  :root{
    --cdl-font: Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    --cdl-lh: 1.45;
    --cdl-leading-tight: 1.2;
    --cdl-radius: 12px;
    --cdl-shadow: 0 10px 22px rgba(17,24,39,.06);
  }
  html,body{ font-family:var(--cdl-font); line-height:var(--cdl-lh); -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility }
  .cdl-container{ width:min(100%, 1120px); } /* un pelín más ancho para parecerse a cdl.es */
  :where(h1,h2,h3){ letter-spacing:.005em }
  h1{ line-height:var(--cdl-leading-tight) }
  .eq-meta{ letter-spacing:.01em }
</style>

<!-- =========================================================
BLOQUE 231 — Botones secundarios/terciarios + estados “quiet” como cdl.es
========================================================= -->
<style>
  .btn-cdl--sec{
    background:#fff; color:#111; border:1px solid #e5e7eb; box-shadow:none;
  }
  .btn-cdl--quiet{
    background:transparent; color:#111; border:1px dashed #e5e7eb; box-shadow:none;
  }
  .btn-cdl--sec:hover,.btn-cdl--quiet:hover{ background:#f9fafb }
  .cdl-hamb,.cdl-user__btn{ transition:border-color .15s ease, background .15s ease }
  .cdl-hamb:hover,.cdl-user__btn:hover{ background:#f9fafb; border-color:#e5e7eb }
</style>

<!-- =========================================================
BLOQUE 232 — Cabecera: proporciones/espaciado “calcadas” (márgenes, alturas, logo)
========================================================= -->
<style>
  .cdl-header{ height:72px } /* un pelín menos para parecer más corporativa */
  .cdl-header__inner{ padding-block:8px }
  .cdl-logo img{ height:26px; image-rendering:-webkit-optimize-contrast }
  .cdl-user__role{ font-weight:800; opacity:.95 }
  /* mejor contraste del watermark sin tapar contenido */
  #cdlHeader::after{ opacity:.75; filter: saturate(.9) }
</style>

<!-- =========================================================
BLOQUE 233 — Migas (breadcrumb) ultra ligeras (solo visual) bajo cabecera
========================================================= -->
<nav id="cdlBread" aria-label="Ruta" class="cdl-container" style="display:none;margin-top:8px">
  <small class="eq-meta" id="cdlBreadTxt">CDL › Mantenimiento</small>
</nav>
<script>
(function(){
  function setBread(){
    const b=document.getElementById('cdlBread'); const t=document.getElementById('cdlBreadTxt');
    const h=location.hash||'';
    let trail='CDL › Mantenimiento';
    if(h.startsWith('#/equipos')) trail+=' › Equipos';
    if(h.startsWith('#/equipo/'))  trail+=' › Ficha';
    if(h==='#/tv')                trail+=' › TV';
    if(h==='#/qr-lote')          trail+=' › QRs (lote)';
    t.textContent=trail; b.style.display='block';
  }
  window.addEventListener('load', setBread);
  window.addEventListener('hashchange', setBread);
})();
</script>

<!-- =========================================================
BLOQUE 234 — Tarjetas/Listas: sombras, radios y “hover” suaves tipo cdl.es
========================================================= -->
<style>
  .eq-card, .eq-detail__right, .kpi, .eq-table, .tv-card, .qr-sheet{
    border-radius:var(--cdl-radius);
    box-shadow:var(--cdl-shadow);
  }
  .eq-card{ transition:transform .06s ease, box-shadow .15s ease }
  .eq-card:hover{ transform:translateY(-1px); box-shadow:0 14px 28px rgba(17,24,39,.09) }
  .kpi b{ font-variant-numeric:tabular-nums }
</style>

<!-- =========================================================
BLOQUE 235 — Tablas: zebra + sticky header para lecturas largas
========================================================= -->
<style>
  .eq-table table{ border-collapse:separate; border-spacing:0 }
  .eq-table thead th{ position:sticky; top:0; z-index:1; box-shadow:0 1px 0 #e5e7eb }
  .eq-table tbody tr:nth-child(odd){ background:#fcfcfd }
  .eq-table td{ vertical-align:top }
</style>

<!-- =========================================================
BLOQUE 236 — Skeletons (carga percibida rápida) para grid de equipos
========================================================= -->
<style>
  .skeleton{ background:linear-gradient(90deg,#f3f4f6 25%,#eceff3 37%,#f3f4f6 63%); background-size:400% 100%; animation:sheen 1.2s ease infinite }
  @keyframes sheen{ 0%{background-position:100% 0} 100%{background-position:0 0} }
  .eq-card.skel .eq-card__media{ background:#f3f4f6 }
  .eq-card.skel .eq-title span,.eq-card.skel .eq-meta,.eq-card.skel .eq-actions{ height:14px; border-radius:8px }
  .eq-card.skel .eq-title span{ width:50% }
  .eq-card.skel .eq-meta{ width:80px }
  .eq-card.skel .eq-actions{ width:100%; }
</style>
<script>
(function(){
  const grid=document.getElementById('equiposGrid');
  if(!grid) return;
  if(!grid._skeletonized){
    grid._skeletonized=true;
    const ph=Array.from({length:6}).map(()=> {
      const a=document.createElement('article'); a.className='eq-card skel';
      a.innerHTML=`<div class="eq-card__media skeleton"></div>
        <div class="eq-card__body">
          <div class="eq-title"><span class="skeleton"></span><small class="eq-meta skeleton"></small></div>
          <div class="eq-actions skeleton"></div>
          <div class="skeleton" style="height:34px;border-radius:999px;width:38%"></div>
        </div>`;
      return a;
    });
    grid.append(...ph);
  }
})();
</script>

<!-- =========================================================
BLOQUE 237 — Micro-perf: debounced resize + will-change + decoding async
========================================================= -->
<style>
  .eq-card, .tv-card{ will-change:transform }
  img[decoding="async"]{ content-visibility:auto } /* hint */
</style>
<script>
(function(){
  let raf=null;
  function onResize(){
    if(raf) cancelAnimationFrame(raf);
    raf=requestAnimationFrame(()=>{/* layout ligero futuro si hiciera falta */});
  }
  window.addEventListener('resize', onResize, {passive:true});
  // Logo con decoding async
  document.querySelector('.cdl-logo img')?.setAttribute('decoding','async');
})();
</script>

<!-- =========================================================
BLOQUE 238 — Pulido @media print (marcas de corte suaves y márgenes)
========================================================= -->
<style>
  @media print{
    @page{ margin:10mm }
    .qr-sheet{ page-break-inside:avoid }
    .eq-table table{ font-size:11pt }
    .cdl-container{ width:100% }
  }
</style>

<!-- =========================================================
BLOQUE 239 — Preload/Prefetch sutil (logo + watermark) y lazy hints
========================================================= -->
<link rel="preload" as="image" href="./logo-cdl.png">
<link rel="preload" as="image" href="./logo_mantenimiento.png">
<script>
  // aplica loading=lazy/decoding=async a futuras imágenes inyectadas (defensivo)
  const _create=document.createElement;
  document.createElement=function(tag){
    const el=_create.call(document, tag);
    if(tag==='img'){ el.loading='lazy'; el.decoding='async'; }
    return el;
  };
</script>

<!-- =========================================================
BLOQUE 240 — Paleta fina y estados (solo visual, tipo cdl.es)
========================================================= -->
<style>
  :root{
    --cdl-red-600:#E43B3B;
    --cdl-red-700:#d33232;
    --cdl-ink:#111827;
    --cdl-gray-50:#F9FAFB;
    --cdl-gray-100:#F3F4F6;
    --cdl-gray-200:#E5E7EB;
    --cdl-gray-300:#D1D5DB;
  }
  .btn-cdl{ transition:transform .06s ease, box-shadow .15s ease, background .15s ease }
  .btn-cdl:hover{ box-shadow:0 14px 28px rgba(228,59,59,.25) }
  .btn-cdl:focus-visible{ outline:3px solid rgba(228,59,59,.35); outline-offset:2px }
  .btn-cdl:active{ transform:translateY(1px); box-shadow:0 6px 16px rgba(228,59,59,.18) }
</style>

<!-- =========================================================
BLOQUE 241 — Cabecera: sombra al desplazar + motion-reduce
========================================================= -->
<style>
  .cdl-header.is-scrolled{ box-shadow:0 8px 18px rgba(17,24,39,.06) }
  @media (prefers-reduced-motion:reduce){
    *{ animation-duration:.001ms !important; animation-iteration-count:1 !important; transition-duration:.001ms !important }
  }
</style>
<script>
(function(){
  const hdr=document.getElementById('cdlHeader');
  if(!hdr) return;
  let y=0, ticking=false;
  function onScroll(){
    y = window.scrollY||0;
    if(!ticking){
      window.requestAnimationFrame(()=>{
        hdr.classList.toggle('is-scrolled', y>2);
        ticking=false;
      });
      ticking=true;
    }
  }
  window.addEventListener('scroll', onScroll, {passive:true});
  onScroll();
})();
</script>
<!-- =========================================================
BLOQUE 243 — Navegación activa por hash (solo estilo)
========================================================= -->
<script>
(function(){
  const navSel='.cdl-panel__nav a';
  function paintActive(){
    document.querySelectorAll(navSel).forEach(a=>{
      const on = location.hash && a.getAttribute('href') && location.hash.startsWith(a.getAttribute('href'));
      a.style.background = on? 'var(--cdl-gray-100)' : '';
      a.style.fontWeight = on? '900' : '800';
      a.style.color = on? 'var(--cdl-ink)' : '#111';
    });
  }
  window.addEventListener('hashchange', paintActive);
  window.addEventListener('load', paintActive);
})();
</script>

<!-- =========================================================
BLOQUE 244 — Requisito títulos: mini-watermark del logo en esquina superior izq.
========================================================= -->
<style>
  :where(h1,h2,h3){
    --wm-size: 16px;
    padding-left: calc(.65rem + var(--wm-size) + 8px);
  }
  :where(h1,h2,h3)::after{
    content:""; position:absolute; left:.65rem; top:0;
    width:var(--wm-size); height:var(--wm-size); opacity:.08;
    background: url('./logo-cdl.png') center/contain no-repeat;
    transform: translateY(2px);
    pointer-events:none;
  }
  /* el marco rojo existente (::before) se mantiene para identidad CDL */
</style>

<!-- =========================================================
BLOQUE 245 — Perf: content-visibility y tamaños intrínsecos para vistas ocultas
========================================================= -->
<style>
  #equiposView[hidden], #equipoView[hidden]{ display:block !important; visibility:hidden; content-visibility:auto; contain-intrinsic-size: 800px 1200px; height:0; overflow:hidden }
</style>

<!-- =========================================================
BLOQUE 246 — Contenedor y respiración visual (gutters grandes en desktop)
========================================================= -->
<style>
  @media(min-width:1280px){
    .cdl-container{ padding-inline:24px }
  }
  main.cdl-container .cdl-hero{ padding-block:8px 6px }
  .cdl-divider{ margin:18px 0 }
</style>

<!-- =========================================================
BLOQUE 247 — Accesibilidad y foco consistente (inputs/links)
========================================================= -->
<style>
  :where(input,select,textarea,.cdl-x,.cdl-hamb,.cdl-user__btn){
    transition:border-color .12s ease, background .12s ease, box-shadow .12s ease;
  }
  :where(input,select,textarea):focus-visible{
    outline:2px solid rgba(228,59,59,.35); outline-offset:2px;
    border-color:var(--cdl-red-600);
    box-shadow:0 0 0 3px rgba(228,59,59,.12);
  }
  a:focus-visible{ outline:2px dashed rgba(228,59,59,.5); outline-offset:3px }
</style>

<!-- =========================================================
BLOQUE 248 — Scrollbar discreta + evitar “rebotes” en panel
========================================================= -->
<style>
  .cdl-panel{ overscroll-behavior:contain }
  /* WebKit scrollbar */
  *::-webkit-scrollbar{ height:10px; width:10px }
  *::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:999px; border:3px solid transparent; background-clip:content-box }
  *::-webkit-scrollbar-thumb:hover{ background:#94a3b8; background-clip:content-box }
</style>

<!-- =========================================================
BLOQUE 249 — Modo TV / Transiciones sutiles de vistas (solo CSS)
========================================================= -->
<style>
  [id$="View"]{ transition: opacity .18s ease }
  [id$="View"][hidden]{ opacity:0 }
  .tv-card{ border:1px solid var(--cdl-gray-200); background:#fff; padding:12px; border-radius:12px }
</style>

<!-- =========================================================
BLOQUE 250 — Tipografía y suavizado tipo cdl.es (micro-ajustes)
========================================================= -->
<style>
  html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
  h1,h2,h3 { letter-spacing: .005em; }
  .eq-meta, .kpi span, small { letter-spacing: 0; }
  /* cohesión de bordes y sombras */
  .soft-card, .eq-card, .eq-detail__right, .eq-table, .kpi { border-radius: 12px; }
  .soft-shadow { box-shadow: 0 10px 24px rgba(17,24,39,.06); }
</style>

<!-- =========================================================
BLOQUE 251 — Hamburguesa → “X” (solo CSS, aprovechando aria-expanded)
========================================================= -->
<style>
  .cdl-hamb{ position:relative; overflow:hidden }
  .cdl-hamb span{
    width:18px; height:2px; background:#111; display:block; border-radius:2px;
    transition:transform .18s ease, opacity .12s ease;
  }
  .cdl-hamb span:nth-child(1){ transform-origin:left center }
  .cdl-hamb span:nth-child(2){ }
  .cdl-hamb span:nth-child(3){ transform-origin:left center }
  /* Estado abierto: animación a “X” */
  #btnMenu[aria-expanded="true"] span:nth-child(1){ transform:translateY(6px) rotate(45deg) }
  #btnMenu[aria-expanded="true"] span:nth-child(2){ opacity:0 }
  #btnMenu[aria-expanded="true"] span:nth-child(3){ transform:translateY(-6px) rotate(-45deg) }
</style>

<!-- =========================================================
BLOQUE 252 — Cabecera: alineaciones, alturas exactas y logo
========================================================= -->
<style>
  .cdl-logo img{ height:28px; display:block }
  @media (min-width:1024px){
    :root{ --hdr-h: 80px; }
    .cdl-user__role{ font-size: .96rem }
  }
  /* micro-espaciado de la cabecera */
  .cdl-header__inner{ gap:12px }
</style>

<!-- =========================================================
BLOQUE 253 — Hero corporativo: jerarquía y ritmo vertical
========================================================= -->
<style>
  .cdl-hero h1{ margin-top:.4rem; margin-bottom:.35rem }
  .cdl-hero p{ color:#4b5563; line-height:1.6 }
  .cdl-hero .btn-cdl + .btn-cdl{ margin-left:.2rem }
</style>

<!-- =========================================================
BLOQUE 254 — Tarjetas de equipos: densidad, hover y consistencia
========================================================= -->
<style>
  .eq-card{ transition: box-shadow .15s ease, transform .06s ease }
  .eq-card:hover{ box-shadow:0 16px 36px rgba(17,24,39,.08) }
  .eq-card__body{ padding:12px 12px 14px }
  .eq-title span{ font-weight:900 }
  .eq-actions{ margin-top:-2px }
  .eq-qr{ background:#fff; }
</style>

<!-- =========================================================
BLOQUE 255 — Semáforo compacto: estados con halo sutil (solo visual)
========================================================= -->
<style>
  .cdl-sem .btn{ transition: background .12s ease, outline-color .12s ease }
  .dot-ok{ box-shadow: 0 0 0 2px #fff inset, 0 0 0 1px rgba(0,0,0,.08), 0 0 0 6px rgba(22,163,74,.10) }
  .dot-warn{ box-shadow: 0 0 0 2px #fff inset, 0 0 0 1px rgba(0,0,0,.08), 0 0 0 6px rgba(245,158,11,.10) }
  .dot-stop{ box-shadow: 0 0 0 2px #fff inset, 0 0 0 1px rgba(0,0,0,.08), 0 0 0 6px rgba(220,38,38,.10) }
</style>

<!-- =========================================================
BLOQUE 256 — KPIs: equilibrio visual y valores tabulares
========================================================= -->
<style>
  .kpi{ display:grid; align-items:center; grid-template-rows:auto auto; min-height:64px }
  .kpi b{ font-variant-numeric: tabular-nums; letter-spacing:.01em }
  .kpi span{ color:#6b7280; font-size:.9rem }
</style>

<!-- =========================================================
BLOQUE 257 — Tablas: zebra suave y cabecera corporativa
========================================================= -->
<style>
  .eq-table table{ border-collapse:separate; border-spacing:0 }
  .eq-table th{ background: linear-gradient(0deg,#F8FAFC,#F8FAFC); border-bottom:1px solid #e5e7eb }
  .eq-table tbody tr:nth-child(odd) td{ background:#fafafa }
  .eq-table td, .eq-table th{ vertical-align:top }
</style>

<!-- =========================================================
BLOQUE 258 — Estados de foco y accesibilidad en botones neutros
========================================================= -->
<style>
  .cdl-x:focus-visible, .cdl-user__btn:focus-visible, .cdl-hamb:focus-visible{
    outline:3px solid rgba(228,59,59,.35); outline-offset:2px
  }
</style>

<!-- =========================================================
BLOQUE 259 — Ritmo general y micro-perf (repaint mínimo)
========================================================= -->
<style>
  /* Evitar repaints en hover de grandes zonas */
  .eq-card, .cdl-panel, .cdl-header{ will-change: box-shadow, transform }
  /* Margen respirado entre secciones principales */
  #equiposView, #equipoView{ margin-top: 6px }
</style>

<!-- =========================================================
BLOQUE 260 — Watermark cabecera (afinado responsivo + contraste)
========================================================= -->
<style>
  /* Ajuste fino del watermark para que nunca tape menús ni rol */
  #cdlHeader::after{
    /* ya existe; aquí solo refinamos posiciones y opacidad por breakpoint */
    background:
      radial-gradient(60% 60% at 0% 0%, rgba(228,59,59,.06), transparent 70%) no-repeat,
      url('./logo_mantenimiento.png') left clamp(16px, 4vw, 28px) top clamp(6px, 2.5vw, 14px) / clamp(180px, 28vw, 320px) auto no-repeat;
    opacity:.85;
  }
  @media (min-width:1024px){
    #cdlHeader::after{ opacity:.92 }
  }
  @media (prefers-reduced-transparency: reduce){
    #cdlHeader::after{ opacity:.15 }
  }
</style>

<!-- =========================================================
BLOQUE 261 — Cabecera: paddings exactos y grid invisible
========================================================= -->
<style>
  .cdl-header__inner{
    padding-left: max(16px, env(safe-area-inset-left, 16px));
    padding-right: max(16px, env(safe-area-inset-right, 16px));
  }
  /* Mantén separación clara entre logo y hamburguesa en móviles */
  .cdl-logo{ margin-left: 4px }
  @media (min-width:1024px){
    .cdl-logo{ margin-left: 6px }
  }
</style>
<script>
  /* Marcar item activo según hash (solo visual) */
  (function(){
    function mark(){
      const links = document.querySelectorAll('.cdl-panel__nav a');
      const h = (location.hash||'').split('/')[1]||'equipos';
      links.forEach(a=>{
        const sec = a.getAttribute('href').replace('#/','');
        a.removeAttribute('aria-current');
        if(sec.startsWith(h)) a.setAttribute('aria-current','page');
      });
    }
    window.addEventListener('hashchange', mark);
    window.addEventListener('load', mark);
  })();
</script>

<!-- =========================================================
BLOQUE 263 — Panel: animación más fluida + reduce-motion
========================================================= -->
<style>
  .cdl-panel{ transition: transform .22s cubic-bezier(.2,.7,.2,1) }
  @media (prefers-reduced-motion: reduce){
    .cdl-panel, #panelBackdrop{ transition:none !important }
  }
</style>

<!-- =========================================================
BLOQUE 264 — Hero: toques corporativos y límites de ancho
========================================================= -->
<style>
  .cdl-hero{ padding-top: 6px }
  .cdl-hero p{ max-width: 62ch }
  @media (min-width: 1200px){
    .cdl-hero p{ max-width: 68ch }
  }
</style>

<!-- =========================================================
BLOQUE 265 — Impresión: cabeceras de tabla pegadas y zebra suave
========================================================= -->
<style>
  @media print{
    .eq-table thead th{ position: sticky; top: 0; background: #f0f3f7 !important; -webkit-print-color-adjust:exact; }
    .eq-table tbody tr:nth-child(odd) td{ background:#fafafa !important; }
    .eq-table td, .eq-table th{ border-bottom:1px solid #e5e7eb !important; }
  }
</style>

<!-- =========================================================
BLOQUE 266 — Utilidades corporativas (solo clases de apoyo)
========================================================= -->
<style>
  .u-hide-mobile{ display:none }
  @media (min-width:768px){ .u-hide-mobile{ display:initial } }
  .u-muted{ color: var(--cdl-muted) }
  .u-tight{ letter-spacing:.002em }
</style>

<!-- =========================================================
BLOQUE 267 — Botones: hover/active consistente con cdl.es
========================================================= -->
<style>
  .btn-cdl{ transition: transform .06s ease, box-shadow .12s ease, background .12s ease }
  .btn-cdl:hover{ box-shadow:0 12px 26px rgba(228,59,59,.30) }
  .btn-cdl:active{ transform: translateY(1px) scale(.995) }
  /* Variante oscura usada en “Dashboard TV” y “Volver” */
  .btn-cdl[style*="background:#111"]{ box-shadow:0 10px 22px rgba(17,17,17,.18) }
  .btn-cdl[style*="background:#111"]:hover{ box-shadow:0 14px 28px rgba(17,17,17,.26) }
</style>

<!-- =========================================================
BLOQUE 268 — Skeleton visual para tarjetas (sin JS, opcional)
========================================================= -->
<style>
  .skeleton{ position:relative; overflow:hidden; background:#eef1f5 }
  .skeleton::after{
    content:""; position:absolute; inset:0;
    transform: translateX(-100%);
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.55), transparent);
    animation: sk-shine 1.2s infinite;
  }
  @keyframes sk-shine{
    100%{ transform: translateX(100%) }
  }
</style>
<!-- Uso opcional (visual): <div class="eq-card__media skeleton"></div> -->

<!-- =========================================================
BLOQUE 269 — Manifiesto y tema (solo si no lo tenías ya)
========================================================= -->
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#E43B3B">

<!-- =========================================================
BLOQUE 270 — Grid de tarjetas: respiración y alineado fino
========================================================= -->
<style>
  .equipos-grid{
    gap: 14px; /* un pelín más de aire */
  }
  .eq-card{
    transition: box-shadow .14s ease, transform .10s ease;
    will-change: transform;
  }
  .eq-card:hover{
    box-shadow: 0 10px 24px rgba(17,24,39,.08);
    transform: translateY(-1px);
  }
  .eq-card__body{ padding: 12px 12px 14px }
  .eq-title{ gap: 10px }
  .eq-meta{ font-variant-numeric: tabular-nums }
</style>

<!-- =========================================================
BLOQUE 271 — Estados de foco accesibles (teclado)
========================================================= -->
<style>
  :root{
    --focus: 0 0 0 3px rgba(228,59,59,.22);
    --focus-inset: inset 0 0 0 2px rgba(228,59,59,.28);
  }
  .cdl-hamb:focus-visible,
  .cdl-x:focus-visible,
  .cdl-panel__nav a:focus-visible,
  .btn-cdl:focus-visible,
  .evt-form input:focus-visible,
  .evt-form select:focus-visible,
  .evt-form textarea:focus-visible{
    outline: none;
    box-shadow: var(--focus);
    border-color: #f3c2c2;
  }
  .cdl-panel__nav a:focus-visible{ box-shadow: var(--focus-inset), var(--focus) }
</style>

<!-- =========================================================
BLOQUE 272 — Inputs del formulario: ritmo vertical + ayudas
========================================================= -->
<style>
  .evt-form label{ font-weight:600; color:#111; display:grid; gap:6px }
  .evt-form input::placeholder,
  .evt-form textarea::placeholder{ color:#9aa3af }
  .evt-form select{ appearance:none; background-image: linear-gradient(45deg, transparent 50%, #999 50%), linear-gradient(135deg, #999 50%, transparent 50%); background-position: calc(100% - 16px) 55%, calc(100% - 11px) 55%; background-size:5px 5px,5px 5px; background-repeat:no-repeat; }
  .evt-form button[type="submit"]{ margin-top: 4px }
</style>

<!-- =========================================================
BLOQUE 273 — Tabla histórico: legibilidad y corte de texto
========================================================= -->
<style>
  .eq-table td:nth-child(5){
    max-width: 420px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }
  @media (max-width: 680px){
    .eq-table td:nth-child(5){ max-width: 200px }
  }
</style>

<!-- =========================================================
BLOQUE 274 — Titulares: micro-ajuste óptico del “marco rojo”
========================================================= -->
<style>
  :where(h1,h2,h3){ padding-left: .70rem }
  :where(h1,h2,h3)::before{
    top: .12rem; width: 19px; height: 19px;
  }
</style>

<!-- =========================================================
BLOQUE 275 — Scroll: suave pero respeta reduce-motion
========================================================= -->
<style>
  html{ scroll-behavior: smooth }
  @media (prefers-reduced-motion: reduce){
    html{ scroll-behavior: auto }
  }
</style>

<!-- =========================================================
BLOQUE 276 — Router: evitar saltos al cambiar de vista
========================================================= -->
<script>
  /* Suaviza el cambio de hash manteniendo la posición si ya estás en top */
  (function(){
    let lastHash = "";
    window.addEventListener('hashchange', ()=>{
      const nearTop = (window.scrollY||document.documentElement.scrollTop) < 8;
      if(nearTop){ try{ document.getElementById('main')?.scrollIntoView({block:'start'}) }catch{} }
      lastHash = location.hash;
    }, {passive:true});
    window.addEventListener('load', ()=>{ lastHash = location.hash; }, {passive:true});
  })();
</script>

<!-- =========================================================
BLOQUE 277 — Cabecera: clic en logo vuelve a “Equipos”
========================================================= -->
<script>
  (function(){
    const logo = document.querySelector('.cdl-logo img');
    if(logo && !logo.dataset.bound){
      logo.style.cursor='pointer';
      logo.addEventListener('click', ()=>{ location.hash='#/equipos' });
      logo.dataset.bound = '1';
    }
  })();
</script>

<!-- =========================================================
BLOQUE 278 — Afinado del watermark según densidad de pantalla
========================================================= -->
<style>
  @media (-webkit-min-device-pixel-ratio:2), (min-resolution:192dpi){
    #cdlHeader::after{
      background:
        radial-gradient(60% 60% at 0% 0%, rgba(228,59,59,.05), transparent 70%) no-repeat,
        url('./logo_mantenimiento.png') left clamp(16px, 4vw, 26px) top clamp(6px, 2.5vw, 12px) / clamp(180px, 26vw, 300px) auto no-repeat;
    }
  }
</style>

<!-- =========================================================
BLOQUE 279 — Favicon y apple-touch-icon (coherencia visual)
========================================================= -->
<link rel="icon" href="./logo-cdl.png" type="image/png" sizes="64x64">
<link rel="apple-touch-icon" href="./logo-cdl.png">

<!-- =========================================================
BLOQUE 280 — Panel lateral: sombreado + transiciones suaves
========================================================= -->
<style>
  .cdl-panel{
    box-shadow: 4px 0 24px rgba(0,0,0,.08);
    transition: transform .28s ease, box-shadow .28s ease;
  }
  .cdl-panel[aria-hidden="false"]{ box-shadow: 6px 0 28px rgba(0,0,0,.10) }
</style>

<!-- =========================================================
BLOQUE 281 — Panel: interacción táctil (swipe close básico)
========================================================= -->
<script>
(function(){
  const panel = document.getElementById('pagesPanel');
  if(!panel || panel.dataset.swipe) return;
  let startX=null;
  panel.addEventListener('touchstart',e=>{ startX=e.touches[0].clientX; },{passive:true});
  panel.addEventListener('touchmove',e=>{
    if(startX!==null){
      const dx=e.touches[0].clientX-startX;
      if(dx<-80){ panel.setAttribute('aria-hidden','true'); document.getElementById('panelBackdrop').hidden=true; startX=null; }
    }
  },{passive:true});
  panel.dataset.swipe='1';
})();
</script>

<!-- =========================================================
BLOQUE 282 — Hover tarjetas: gradiente muy sutil
========================================================= -->
<style>
  .eq-card:hover{ 
    background: linear-gradient(180deg,#fff,#fdfdfd);
  }
</style>

<!-- =========================================================
BLOQUE 283 — Zebra en tablas histórico/equipos
========================================================= -->
<style>
  .eq-table tbody tr:nth-child(even){ background:#fafafa }
</style>

<!-- =========================================================
BLOQUE 284 — KPIs: tipografía y jerarquía
========================================================= -->
<style>
  .kpi b{ font-size:1.25rem; font-weight:900; color:#111 }
  .kpi span{ font-size:.85rem; color:#6b7280 }
</style>

<!-- =========================================================
BLOQUE 285 — Botones: feedback rápido
========================================================= -->
<style>
  .btn-cdl{ transition: background .14s ease, transform .12s ease }
  .btn-cdl:hover{ filter:brightness(1.05) }
  .btn-cdl:active{ transform: translateY(1px) scale(.98) }
</style>

<!-- =========================================================
BLOQUE 286 — Semáforo: tamaños compactos en tarjetas
========================================================= -->
<style>
  .eq-actions .cdl-sem.compact .btn{ font-size:.8rem; padding:0 .45rem; }
  .eq-actions .chip{ font-size:.8rem }
</style>

<!-- =========================================================
BLOQUE 287 — Panel búsqueda: input animado
========================================================= -->
<style>
  .cdl-panel__search input:focus{ border-color:#e43b3b; box-shadow:0 0 0 2px rgba(228,59,59,.2) }
</style>

<!-- =========================================================
BLOQUE 288 — Tipografía global: afinado
========================================================= -->
<style>
  body{ -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility }
  h1,h2,h3{ -webkit-font-smoothing:auto }
</style>

<!-- =========================================================
BLOQUE 289 — Footer copy: menor tamaño + color gris
========================================================= -->
<style>
  .cdl-panel__foot small{ font-size:.75rem; color:#9ca3af }
</style>

<!-- =========================================================
BLOQUE 290 — Cabecera: compacta en pantallas pequeñas
========================================================= -->
<style>
  @media(max-width:480px){
    .cdl-header__inner{ padding-inline:8px }
    .cdl-logo img{ height:22px }
    .cdl-user__role{ display:none }
  }
</style>

<!-- =========================================================
BLOQUE 291 — Cabecera: transición sombra al hacer scroll
========================================================= -->
<style>
  #cdlHeader.scrolled{ box-shadow:0 4px 14px rgba(0,0,0,.08) }
</style>
<script>
(function(){
  const hdr=document.getElementById('cdlHeader');
  if(!hdr) return;
  window.addEventListener('scroll',()=>{
    hdr.classList.toggle('scrolled',window.scrollY>5);
  },{passive:true});
})();
</script>

<!-- =========================================================
BLOQUE 292 — Accesibilidad: aria-current en menú
========================================================= -->
<script>
(function(){
  const navLinks=document.querySelectorAll('.cdl-panel__nav a');
  function updateNav(){
    const h=location.hash.split('?')[0];
    navLinks.forEach(a=>{
      a.removeAttribute('aria-current');
      if(h && a.getAttribute('href')===h){ a.setAttribute('aria-current','page'); }
    });
  }
  window.addEventListener('hashchange',updateNav);
  window.addEventListener('load',updateNav);
})();
</script>

<!-- =========================================================
BLOQUE 293 — Botones accesibles: focus visible
========================================================= -->
<style>
  .btn-cdl:focus-visible,.cdl-x:focus-visible,.cdl-hamb:focus-visible,.cdl-user__btn:focus-visible{
    outline:2px solid var(--cdl-red); outline-offset:2px;
  }
</style>

<!-- =========================================================
BLOQUE 294 — Menú lateral: scroll interno
========================================================= -->
<style>
  .cdl-panel__nav{ overflow-y:auto; max-height:calc(100vh - 180px) }
</style>

<!-- =========================================================
BLOQUE 295 — Performance: lazy load imágenes tarjetas
========================================================= -->
<script>
(function(){
  const obs=new IntersectionObserver(entries=>{
    entries.forEach(e=>{
      if(e.isIntersecting){
        const ph=e.target.querySelector('.eq-card__media');
        if(ph && !ph.dataset.loaded){
          ph.style.backgroundImage="url('./linea-kaltenbach.jpeg')";
          ph.dataset.loaded="1";
        }
      }
    });
  },{rootMargin:"100px"});
  document.querySelectorAll('.eq-card').forEach(c=>obs.observe(c));
})();
</script>

<!-- =========================================================
BLOQUE 296 — Tablas: scroll horizontal responsivo
========================================================= -->
<style>
  .eq-table{ overflow-x:auto }
  .eq-table table{ min-width:600px }
</style>

<!-- =========================================================
BLOQUE 297 — Animación suave apertura panel
========================================================= -->
<style>
  .cdl-panel{ transition: transform .25s cubic-bezier(.4,0,.2,1) }
</style>

<!-- =========================================================
BLOQUE 298 — Cabecera watermark: ajuste responsive
========================================================= -->
<style>
  #cdlHeader::after{
    background-size:200px auto;
    opacity:.75;
  }
  @media(min-width:1024px){
    #cdlHeader::after{ background-size:300px auto; opacity:.9; }
  }
</style>

<!-- =========================================================
BLOQUE 299 — Optimización carga fuentes
========================================================= -->
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap">

<!-- =========================================================
BLOQUE 300 — Tabla: cabecera fija + zebra + compacta
========================================================= -->
<style>
  .eq-table{ overflow:auto; border-radius:12px }
  .eq-table thead th{
    position:sticky; top:0; z-index:1;
    background:#f8fafc; /* igual que antes, pero sticky */
  }
  .eq-table tbody tr:nth-child(odd){ background:#fcfcfd }
  .eq-table th,.eq-table td{ white-space:nowrap }
  .eq-table td:last-child{ max-width:460px; white-space:normal } /* detalle puede ser largo */
</style>

<!-- =========================================================
BLOQUE 301 — KPIs: fichas con microrelieve y mejor jerarquía
========================================================= -->
<style>
  .kpi{
    background:linear-gradient(#fff, #fff) padding-box,
               linear-gradient(180deg, #f5f7fb, #eef2f7) border-box;
    border:1px solid #e5e7eb; box-shadow:0 1px 0 rgba(17,24,39,.03);
  }
  .kpi b{ font-variant-numeric:tabular-nums; letter-spacing:.2px }
  .kpi span{ color:var(--cdl-muted); font-size:.9rem }
</style>

<!-- =========================================================
BLOQUE 302 — Botón “volver arriba” discreto (UX)
========================================================= -->
<style>
  #toTop{
    position:fixed; right:16px; bottom:16px; height:42px; width:42px;
    display:grid; place-items:center; border-radius:999px;
    border:1px solid #e5e7eb; background:#fff; color:#111;
    box-shadow:0 6px 18px rgba(0,0,0,.06); opacity:0; pointer-events:none;
    transition:opacity .2s ease, transform .2s ease; transform:translateY(8px); z-index:1200;
  }
  #toTop.show{ opacity:1; pointer-events:auto; transform:translateY(0) }
</style>
<button id="toTop" aria-label="Volver arriba" title="Volver arriba">↑</button>
<script>
(function(){
  const b=document.getElementById('toTop'); if(!b) return;
  b.addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'}));
  const onScroll=()=> b.classList.toggle('show', window.scrollY>600);
  window.addEventListener('scroll', onScroll, {passive:true}); onScroll();
})();
</script>

<!-- =========================================================
BLOQUE 303 — Tokens extra: sombras, radios y transiciones CDL
========================================================= -->
<style>
  :root{
    --cdl-radius:12px;
    --cdl-shadow-sm:0 1px 2px rgba(0,0,0,.04);
    --cdl-shadow-md:0 6px 18px rgba(0,0,0,.06);
    --cdl-transition:.2s cubic-bezier(.4,0,.2,1);
  }
  .eq-card,.eq-detail__right{ border-radius:var(--cdl-radius); box-shadow:var(--cdl-shadow-sm) }
  .btn-cdl{ transition:transform var(--cdl-transition), box-shadow var(--cdl-transition) }
  .btn-cdl:hover{ box-shadow:0 10px 24px rgba(228,59,59,.25); transform:translateY(-1px) }
</style>

<!-- =========================================================
BLOQUE 304 — Accesibilidad: “prefers-reduced-motion” respetado
========================================================= -->
<style>
@media (prefers-reduced-motion: reduce){
  *{ animation-duration:0.001ms !important; animation-iteration-count:1 !important; transition-duration:0.001ms !important; scroll-behavior:auto !important }
}
</style>

<!-- =========================================================
BLOQUE 305 — Inputs y selects: look unificado (iOS/Android/Web)
========================================================= -->
<style>
  input, select, textarea{
    -webkit-appearance:none; appearance:none; outline:none;
  }
  select{
    background:
      linear-gradient(180deg,#fff,#fff) padding-box,
      linear-gradient(90deg,#e5e7eb,#e5e7eb) border-box;
    background-image:
      linear-gradient(180deg,#fff,#fff),
      linear-gradient(90deg,#e5e7eb,#e5e7eb),
      url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 20 20' fill='none' stroke='black' stroke-width='2'%3E%3Cpath d='M5 8l5 5 5-5'/%3E%3C/svg%3E");
    background-repeat:no-repeat,no-repeat,no-repeat;
    background-position:0 0, 0 0, right .75rem center;
    background-size:auto, auto, 14px;
    padding-right:2.2rem !important;
  }
  input:focus, select:focus, textarea:focus{
    border-color:#d1d5db; box-shadow:0 0 0 3px rgba(228,59,59,.15);
  }
</style>

<!-- =========================================================
BLOQUE 306 — Estados de botones del semáforo: microfeedback
========================================================= -->
<style>
  .cdl-sem .btn{ transition: background var(--cdl-transition), transform var(--cdl-transition) }
  .cdl-sem .btn[aria-pressed="true"]{ transform:translateY(-1px) }
</style>

<!-- =========================================================
BLOQUE 307 — Skeleton para tarjetas de equipos (percepción de velocidad)
========================================================= -->
<style>
  .skeleton{ position:relative; overflow:hidden; background:#f3f4f6 }
  .skeleton::after{
    content:""; position:absolute; inset:0;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
    transform:translateX(-100%); animation:shimmer 1.2s infinite;
  }
  @keyframes shimmer{ 100%{ transform:translateX(100%) } }
</style>
<script>
(function(){
  // Añade skeleton mientras aún no se puebla el grid (micro-mejora UX; se quita al renderizar)
  const grid=document.getElementById('equiposGrid');
  if(!grid) return;
  if(!grid.children.length){
    for(let i=0;i<3;i++){
      const ph=document.createElement('article');
      ph.className='eq-card';
      ph.innerHTML=`<div class="eq-card__media skeleton"></div>
                    <div class="eq-card__body">
                      <div class="eq-title skeleton" style="height:18px;border-radius:6px"></div>
                      <div class="eq-actions" style="gap:8px">
                        <div class="eq-sem skeleton" style="height:30px;flex:1;border-radius:999px"></div>
                        <div class="eq-qr skeleton" style="height:60px;width:60px;border-radius:8px"></div>
                      </div>
                    </div>`;
      grid.appendChild(ph);
    }
  }
  // Al primer render real, limpiar skeleton (hookeamos a renderEquipos)
  const _render = window.renderEquipos;
  if(typeof _render === 'function'){
    window.renderEquipos = function(list,q){
      grid.innerHTML=''; // limpia skeleton
      return _render(list,q);
    }
  }
})();
</script>

<!-- =========================================================
BLOQUE 308 — Menú lateral: hover/active con subrayado deslizante
========================================================= -->
<style>
  .cdl-panel__nav a{
    position:relative; transition:background var(--cdl-transition)
  }
  .cdl-panel__nav a::after{
    content:""; position:absolute; left:12px; right:auto; bottom:6px;
    width:0; height:2px; background:var(--cdl-red); transition:width var(--cdl-transition)
  }
  .cdl-panel__nav a:hover::after, .cdl-panel__nav a[aria-current="page"]::after{ width:24px }
</style>

<!-- =========================================================
BLOQUE 309 — Fijar fondo blanco y contraste en modo oscuro del SO
========================================================= -->
<style>
  @media (prefers-color-scheme: dark){
    html, body{ background:#fff; color:#111 } /* forzamos look cdl.es */
    .eq-card,.eq-detail__right,.cdl-panel,.cdl-header{ background:#fff }
    .cdl-panel__backdrop{ background:rgba(0,0,0,0.35) }
  }
</style>
<!-- =========================================================
BLOQUE 230 — Tipografía/CDL: microajustes de legibilidad y ritmo vertical
========================================================= -->
<style>
  :root{
    --cdl-font: Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    --cdl-lh: 1.45;
    --cdl-leading-tight: 1.2;
    --cdl-radius: 12px;
    --cdl-shadow: 0 10px 22px rgba(17,24,39,.06);
  }
  html,body{ font-family:var(--cdl-font); line-height:var(--cdl-lh); -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility }
  .cdl-container{ width:min(100%, 1120px); } /* un pelín más ancho para parecerse a cdl.es */
  :where(h1,h2,h3){ letter-spacing:.005em }
  h1{ line-height:var(--cdl-leading-tight) }
  .eq-meta{ letter-spacing:.01em }
</style>

<!-- =========================================================
BLOQUE 231 — Botones secundarios/terciarios + estados “quiet” como cdl.es
========================================================= -->
<style>
  .btn-cdl--sec{
    background:#fff; color:#111; border:1px solid #e5e7eb; box-shadow:none;
  }
  .btn-cdl--quiet{
    background:transparent; color:#111; border:1px dashed #e5e7eb; box-shadow:none;
  }
  .btn-cdl--sec:hover,.btn-cdl--quiet:hover{ background:#f9fafb }
  .cdl-hamb,.cdl-user__btn{ transition:border-color .15s ease, background .15s ease }
  .cdl-hamb:hover,.cdl-user__btn:hover{ background:#f9fafb; border-color:#e5e7eb }
</style>

<!-- =========================================================
BLOQUE 232 — Cabecera: proporciones/espaciado “calcadas” (márgenes, alturas, logo)
========================================================= -->
<style>
  .cdl-header{ height:72px } /* un pelín menos para parecer más corporativa */
  .cdl-header__inner{ padding-block:8px }
  .cdl-logo img{ height:26px; image-rendering:-webkit-optimize-contrast }
  .cdl-user__role{ font-weight:800; opacity:.95 }
  /* mejor contraste del watermark sin tapar contenido */
  #cdlHeader::after{ opacity:.75; filter: saturate(.9) }
</style>

<!-- =========================================================
BLOQUE 233 — Migas (breadcrumb) ultra ligeras (solo visual) bajo cabecera
========================================================= -->
<nav id="cdlBread" aria-label="Ruta" class="cdl-container" style="display:none;margin-top:8px">
  <small class="eq-meta" id="cdlBreadTxt">CDL › Mantenimiento</small>
</nav>
<script>
(function(){
  function setBread(){
    const b=document.getElementById('cdlBread'); const t=document.getElementById('cdlBreadTxt');
    const h=location.hash||'';
    let trail='CDL › Mantenimiento';
    if(h.startsWith('#/equipos')) trail+=' › Equipos';
    if(h.startsWith('#/equipo/'))  trail+=' › Ficha';
    if(h==='#/tv')                trail+=' › TV';
    if(h==='#/qr-lote')          trail+=' › QRs (lote)';
    t.textContent=trail; b.style.display='block';
  }
  window.addEventListener('load', setBread);
  window.addEventListener('hashchange', setBread);
})();
</script>

<!-- =========================================================
BLOQUE 234 — Tarjetas/Listas: sombras, radios y “hover” suaves tipo cdl.es
========================================================= -->
<style>
  .eq-card, .eq-detail__right, .kpi, .eq-table, .tv-card, .qr-sheet{
    border-radius:var(--cdl-radius);
    box-shadow:var(--cdl-shadow);
  }
  .eq-card{ transition:transform .06s ease, box-shadow .15s ease }
  .eq-card:hover{ transform:translateY(-1px); box-shadow:0 14px 28px rgba(17,24,39,.09) }
  .kpi b{ font-variant-numeric:tabular-nums }
</style>

<!-- =========================================================
BLOQUE 235 — Tablas: zebra + sticky header para lecturas largas
========================================================= -->
<style>
  .eq-table table{ border-collapse:separate; border-spacing:0 }
  .eq-table thead th{ position:sticky; top:0; z-index:1; box-shadow:0 1px 0 #e5e7eb }
  .eq-table tbody tr:nth-child(odd){ background:#fcfcfd }
  .eq-table td{ vertical-align:top }
</style>

<!-- =========================================================
BLOQUE 236 — Skeletons (carga percibida rápida) para grid de equipos
========================================================= -->
<style>
  .skeleton{ background:linear-gradient(90deg,#f3f4f6 25%,#eceff3 37%,#f3f4f6 63%); background-size:400% 100%; animation:sheen 1.2s ease infinite }
  @keyframes sheen{ 0%{background-position:100% 0} 100%{background-position:0 0} }
  .eq-card.skel .eq-card__media{ background:#f3f4f6 }
  .eq-card.skel .eq-title span,.eq-card.skel .eq-meta,.eq-card.skel .eq-actions{ height:14px; border-radius:8px }
  .eq-card.skel .eq-title span{ width:50% }
  .eq-card.skel .eq-meta{ width:80px }
  .eq-card.skel .eq-actions{ width:100%; }
</style>
<script>
(function(){
  const grid=document.getElementById('equiposGrid');
  if(!grid) return;
  if(!grid._skeletonized){
    grid._skeletonized=true;
    const ph=Array.from({length:6}).map(()=> {
      const a=document.createElement('article'); a.className='eq-card skel';
      a.innerHTML=`<div class="eq-card__media skeleton"></div>
        <div class="eq-card__body">
          <div class="eq-title"><span class="skeleton"></span><small class="eq-meta skeleton"></small></div>
          <div class="eq-actions skeleton"></div>
          <div class="skeleton" style="height:34px;border-radius:999px;width:38%"></div>
        </div>`;
      return a;
    });
    grid.append(...ph);
  }
})();
</script>

<!-- =========================================================
BLOQUE 237 — Micro-perf: debounced resize + will-change + decoding async
========================================================= -->
<style>
  .eq-card, .tv-card{ will-change:transform }
  img[decoding="async"]{ content-visibility:auto } /* hint */
</style>
<script>
(function(){
  let raf=null;
  function onResize(){
    if(raf) cancelAnimationFrame(raf);
    raf=requestAnimationFrame(()=>{/* layout ligero futuro si hiciera falta */});
  }
  window.addEventListener('resize', onResize, {passive:true});
  // Logo con decoding async
  document.querySelector('.cdl-logo img')?.setAttribute('decoding','async');
})();
</script>

<!-- =========================================================
BLOQUE 238 — Pulido @media print (marcas de corte suaves y márgenes)
========================================================= -->
<style>
  @media print{
    @page{ margin:10mm }
    .qr-sheet{ page-break-inside:avoid }
    .eq-table table{ font-size:11pt }
    .cdl-container{ width:100% }
  }
</style>

<!-- =========================================================
BLOQUE 239 — Preload/Prefetch sutil (logo + watermark) y lazy hints
========================================================= -->
<link rel="preload" as="image" href="./logo-cdl.png">
<link rel="preload" as="image" href="./logo_mantenimiento.png">
<script>
  // aplica loading=lazy/decoding=async a futuras imágenes inyectadas (defensivo)
  const _create=document.createElement;
  document.createElement=function(tag){
    const el=_create.call(document, tag);
    if(tag==='img'){ el.loading='lazy'; el.decoding='async'; }
    return el;
  };
</script>

<!-- =========================================================
BLOQUE 240 — Paleta fina y estados (solo visual, tipo cdl.es)
========================================================= -->
<style>
  :root{
    --cdl-red-600:#E43B3B;
    --cdl-red-700:#d33232;
    --cdl-ink:#111827;
    --cdl-gray-50:#F9FAFB;
    --cdl-gray-100:#F3F4F6;
    --cdl-gray-200:#E5E7EB;
    --cdl-gray-300:#D1D5DB;
  }
  .btn-cdl{ transition:transform .06s ease, box-shadow .15s ease, background .15s ease }
  .btn-cdl:hover{ box-shadow:0 14px 28px rgba(228,59,59,.25) }
  .btn-cdl:focus-visible{ outline:3px solid rgba(228,59,59,.35); outline-offset:2px }
  .btn-cdl:active{ transform:translateY(1px); box-shadow:0 6px 16px rgba(228,59,59,.18) }
</style>

<!-- =========================================================
BLOQUE 241 — Cabecera: sombra al desplazar + motion-reduce
========================================================= -->
<style>
  .cdl-header.is-scrolled{ box-shadow:0 8px 18px rgba(17,24,39,.06) }
  @media (prefers-reduced-motion:reduce){
    *{ animation-duration:.001ms !important; animation-iteration-count:1 !important; transition-duration:.001ms !important }
  }
</style>
<script>
(function(){
  const hdr=document.getElementById('cdlHeader');
  if(!hdr) return;
  let y=0, ticking=false;
  function onScroll(){
    y = window.scrollY||0;
    if(!ticking){
      window.requestAnimationFrame(()=>{
        hdr.classList.toggle('is-scrolled', y>2);
        ticking=false;
      });
      ticking=true;
    }
  }
  window.addEventListener('scroll', onScroll, {passive:true});
  onScroll();
})();
</script>
<!-- BLOQUE 242 — Menú lateral: animación y subrayado (sin backdrop) -->
<style>
  .cdl-panel{ transition:transform .28s cubic-bezier(.2,.8,.2,1) }
  .cdl-panel__nav a{ position:relative; transition:background .12s ease }
  .cdl-panel__nav a::after{
    content:""; position:absolute; left:12px; bottom:8px; height:2px; width:0;
    background:var(--cdl-red-600); border-radius:2px; transition:width .16s ease;
  }
  .cdl-panel__nav a:hover::after{ width:24px }

</style>

<!-- =========================================================
BLOQUE 243 — Navegación activa por hash (solo estilo)
========================================================= -->
<script>
(function(){
  const navSel='.cdl-panel__nav a';
  function paintActive(){
    document.querySelectorAll(navSel).forEach(a=>{
      const on = location.hash && a.getAttribute('href') && location.hash.startsWith(a.getAttribute('href'));
      a.style.background = on? 'var(--cdl-gray-100)' : '';
      a.style.fontWeight = on? '900' : '800';
      a.style.color = on? 'var(--cdl-ink)' : '#111';
    });
  }
  window.addEventListener('hashchange', paintActive);
  window.addEventListener('load', paintActive);
})();
</script>

<!-- =========================================================
BLOQUE 244 — Requisito títulos: mini-watermark del logo en esquina superior izq.
========================================================= -->
<style>
  :where(h1,h2,h3){
    --wm-size: 16px;
    padding-left: calc(.65rem + var(--wm-size) + 8px);
  }
  :where(h1,h2,h3)::after{
    content:""; position:absolute; left:.65rem; top:0;
    width:var(--wm-size); height:var(--wm-size); opacity:.08;
    background: url('./logo-cdl.png') center/contain no-repeat;
    transform: translateY(2px);
    pointer-events:none;
  }
  /* el marco rojo existente (::before) se mantiene para identidad CDL */
</style>

<!-- =========================================================
BLOQUE 245 — Perf: content-visibility y tamaños intrínsecos para vistas ocultas
========================================================= -->
<style>
  #equiposView[hidden], #equipoView[hidden]{ display:block !important; visibility:hidden; content-visibility:auto; contain-intrinsic-size: 800px 1200px; height:0; overflow:hidden }
</style>

<!-- =========================================================
BLOQUE 246 — Contenedor y respiración visual (gutters grandes en desktop)
========================================================= -->
<style>
  @media(min-width:1280px){
    .cdl-container{ padding-inline:24px }
  }
  main.cdl-container .cdl-hero{ padding-block:8px 6px }
  .cdl-divider{ margin:18px 0 }
</style>

<!-- =========================================================
BLOQUE 247 — Accesibilidad y foco consistente (inputs/links)
========================================================= -->
<style>
  :where(input,select,textarea,.cdl-x,.cdl-hamb,.cdl-user__btn){
    transition:border-color .12s ease, background .12s ease, box-shadow .12s ease;
  }
  :where(input,select,textarea):focus-visible{
    outline:2px solid rgba(228,59,59,.35); outline-offset:2px;
    border-color:var(--cdl-red-600);
    box-shadow:0 0 0 3px rgba(228,59,59,.12);
  }
  a:focus-visible{ outline:2px dashed rgba(228,59,59,.5); outline-offset:3px }
</style>

<!-- =========================================================
BLOQUE 248 — Scrollbar discreta + evitar “rebotes” en panel
========================================================= -->
<style>
  .cdl-panel{ overscroll-behavior:contain }
  /* WebKit scrollbar */
  *::-webkit-scrollbar{ height:10px; width:10px }
  *::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:999px; border:3px solid transparent; background-clip:content-box }
  *::-webkit-scrollbar-thumb:hover{ background:#94a3b8; background-clip:content-box }
</style>

<!-- =========================================================
BLOQUE 249 — Modo TV / Transiciones sutiles de vistas (solo CSS)
========================================================= -->
<style>
  [id$="View"]{ transition: opacity .18s ease }
  [id$="View"][hidden]{ opacity:0 }
  .tv-card{ border:1px solid var(--cdl-gray-200); background:#fff; padding:12px; border-radius:12px }
</style>

<!-- =========================================================
BLOQUE 250 — Tipografía y suavizado tipo cdl.es (micro-ajustes)
========================================================= -->
<style>
  html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
  h1,h2,h3 { letter-spacing: .005em; }
  .eq-meta, .kpi span, small { letter-spacing: 0; }
  /* cohesión de bordes y sombras */
  .soft-card, .eq-card, .eq-detail__right, .eq-table, .kpi { border-radius: 12px; }
  .soft-shadow { box-shadow: 0 10px 24px rgba(17,24,39,.06); }
</style>

<!-- =========================================================
BLOQUE 251 — Hamburguesa → “X” (solo CSS, aprovechando aria-expanded)
========================================================= -->
<style>
  .cdl-hamb{ position:relative; overflow:hidden }
  .cdl-hamb span{
    width:18px; height:2px; background:#111; display:block; border-radius:2px;
    transition:transform .18s ease, opacity .12s ease;
  }
  .cdl-hamb span:nth-child(1){ transform-origin:left center }
  .cdl-hamb span:nth-child(2){ }
  .cdl-hamb span:nth-child(3){ transform-origin:left center }
  /* Estado abierto: animación a “X” */
  #btnMenu[aria-expanded="true"] span:nth-child(1){ transform:translateY(6px) rotate(45deg) }
  #btnMenu[aria-expanded="true"] span:nth-child(2){ opacity:0 }
  #btnMenu[aria-expanded="true"] span:nth-child(3){ transform:translateY(-6px) rotate(-45deg) }
</style>

<!-- =========================================================
BLOQUE 252 — Cabecera: alineaciones, alturas exactas y logo
========================================================= -->
<style>
  .cdl-logo img{ height:28px; display:block }
  @media (min-width:1024px){
    :root{ --hdr-h: 80px; }
    .cdl-user__role{ font-size: .96rem }
  }
  /* micro-espaciado de la cabecera */
  .cdl-header__inner{ gap:12px }
</style>

<!-- =========================================================
BLOQUE 253 — Hero corporativo: jerarquía y ritmo vertical
========================================================= -->
<style>
  .cdl-hero h1{ margin-top:.4rem; margin-bottom:.35rem }
  .cdl-hero p{ color:#4b5563; line-height:1.6 }
  .cdl-hero .btn-cdl + .btn-cdl{ margin-left:.2rem }
</style>

<!-- =========================================================
BLOQUE 254 — Tarjetas de equipos: densidad, hover y consistencia
========================================================= -->
<style>
  .eq-card{ transition: box-shadow .15s ease, transform .06s ease }
  .eq-card:hover{ box-shadow:0 16px 36px rgba(17,24,39,.08) }
  .eq-card__body{ padding:12px 12px 14px }
  .eq-title span{ font-weight:900 }
  .eq-actions{ margin-top:-2px }
  .eq-qr{ background:#fff; }
</style>

<!-- =========================================================
BLOQUE 255 — Semáforo compacto: estados con halo sutil (solo visual)
========================================================= -->
<style>
  .cdl-sem .btn{ transition: background .12s ease, outline-color .12s ease }
  .dot-ok{ box-shadow: 0 0 0 2px #fff inset, 0 0 0 1px rgba(0,0,0,.08), 0 0 0 6px rgba(22,163,74,.10) }
  .dot-warn{ box-shadow: 0 0 0 2px #fff inset, 0 0 0 1px rgba(0,0,0,.08), 0 0 0 6px rgba(245,158,11,.10) }
  .dot-stop{ box-shadow: 0 0 0 2px #fff inset, 0 0 0 1px rgba(0,0,0,.08), 0 0 0 6px rgba(220,38,38,.10) }
</style>

<!-- =========================================================
BLOQUE 256 — KPIs: equilibrio visual y valores tabulares
========================================================= -->
<style>
  .kpi{ display:grid; align-items:center; grid-template-rows:auto auto; min-height:64px }
  .kpi b{ font-variant-numeric: tabular-nums; letter-spacing:.01em }
  .kpi span{ color:#6b7280; font-size:.9rem }
</style>

<!-- =========================================================
BLOQUE 257 — Tablas: zebra suave y cabecera corporativa
========================================================= -->
<style>
  .eq-table table{ border-collapse:separate; border-spacing:0 }
  .eq-table th{ background: linear-gradient(0deg,#F8FAFC,#F8FAFC); border-bottom:1px solid #e5e7eb }
  .eq-table tbody tr:nth-child(odd) td{ background:#fafafa }
  .eq-table td, .eq-table th{ vertical-align:top }
</style>

<!-- =========================================================
BLOQUE 258 — Estados de foco y accesibilidad en botones neutros
========================================================= -->
<style>
  .cdl-x:focus-visible, .cdl-user__btn:focus-visible, .cdl-hamb:focus-visible{
    outline:3px solid rgba(228,59,59,.35); outline-offset:2px
  }
</style>

<!-- =========================================================
BLOQUE 259 — Ritmo general y micro-perf (repaint mínimo)
========================================================= -->
<style>
  /* Evitar repaints en hover de grandes zonas */
  .eq-card, .cdl-panel, .cdl-header{ will-change: box-shadow, transform }
  /* Margen respirado entre secciones principales */
  #equiposView, #equipoView{ margin-top: 6px }
</style>

<!-- =========================================================
BLOQUE 260 — Watermark cabecera (afinado responsivo + contraste)
========================================================= -->
<style>
  /* Ajuste fino del watermark para que nunca tape menús ni rol */
  #cdlHeader::after{
    /* ya existe; aquí solo refinamos posiciones y opacidad por breakpoint */
    background:
      radial-gradient(60% 60% at 0% 0%, rgba(228,59,59,.06), transparent 70%) no-repeat,
      url('./logo_mantenimiento.png') left clamp(16px, 4vw, 28px) top clamp(6px, 2.5vw, 14px) / clamp(180px, 28vw, 320px) auto no-repeat;
    opacity:.85;
  }
  @media (min-width:1024px){
    #cdlHeader::after{ opacity:.92 }
  }
  @media (prefers-reduced-transparency: reduce){
    #cdlHeader::after{ opacity:.15 }
  }
</style>

<!-- =========================================================
BLOQUE 261 — Cabecera: paddings exactos y grid invisible
========================================================= -->
<style>
  .cdl-header__inner{
    padding-left: max(16px, env(safe-area-inset-left, 16px));
    padding-right: max(16px, env(safe-area-inset-right, 16px));
  }
  /* Mantén separación clara entre logo y hamburguesa en móviles */
  .cdl-logo{ margin-left: 4px }
  @media (min-width:1024px){
    .cdl-logo{ margin-left: 6px }
  }
</style>

<!-- =========================================================
BLOQUE 262 — Menú lateral: ritmo vertical y estados activos
========================================================= -->
<style>
  .cdl-panel__nav{ gap:.1rem }
  .cdl-panel__nav a{
    line-height:1.25; border:1px solid transparent;
    transition: background .12s ease, border-color .12s ease;
  }
  .cdl-panel__nav a:hover{ background:#f3f4f6; border-color:#eef0f4 }
  .cdl-panel__nav a[aria-current="page"]{
    background:#fff5f5; border-color:#ffd5d5;
  }
</style>
<script>
  /* Marcar item activo según hash (solo visual) */
  (function(){
    function mark(){
      const links = document.querySelectorAll('.cdl-panel__nav a');
      const h = (location.hash||'').split('/')[1]||'equipos';
      links.forEach(a=>{
        const sec = a.getAttribute('href').replace('#/','');
        a.removeAttribute('aria-current');
        if(sec.startsWith(h)) a.setAttribute('aria-current','page');
      });
    }
    window.addEventListener('hashchange', mark);
    window.addEventListener('load', mark);
  })();
</script>

<!-- =========================================================
BLOQUE 263 — Panel: animación más fluida + reduce-motion
========================================================= -->
<style>
  .cdl-panel{ transition: transform .22s cubic-bezier(.2,.7,.2,1) }
  @media (prefers-reduced-motion: reduce){
    .cdl-panel, #panelBackdrop{ transition:none !important }
  }
</style>

<!-- =========================================================
BLOQUE 264 — Hero: toques corporativos y límites de ancho
========================================================= -->
<style>
  .cdl-hero{ padding-top: 6px }
  .cdl-hero p{ max-width: 62ch }
  @media (min-width: 1200px){
    .cdl-hero p{ max-width: 68ch }
  }
</style>

<!-- =========================================================
BLOQUE 265 — Impresión: cabeceras de tabla pegadas y zebra suave
========================================================= -->
<style>
  @media print{
    .eq-table thead th{ position: sticky; top: 0; background: #f0f3f7 !important; -webkit-print-color-adjust:exact; }
    .eq-table tbody tr:nth-child(odd) td{ background:#fafafa !important; }
    .eq-table td, .eq-table th{ border-bottom:1px solid #e5e7eb !important; }
  }
</style>

<!-- =========================================================
BLOQUE 266 — Utilidades corporativas (solo clases de apoyo)
========================================================= -->
<style>
  .u-hide-mobile{ display:none }
  @media (min-width:768px){ .u-hide-mobile{ display:initial } }
  .u-muted{ color: var(--cdl-muted) }
  .u-tight{ letter-spacing:.002em }
</style>

<!-- =========================================================
BLOQUE 267 — Botones: hover/active consistente con cdl.es
========================================================= -->
<style>
  .btn-cdl{ transition: transform .06s ease, box-shadow .12s ease, background .12s ease }
  .btn-cdl:hover{ box-shadow:0 12px 26px rgba(228,59,59,.30) }
  .btn-cdl:active{ transform: translateY(1px) scale(.995) }
  /* Variante oscura usada en “Dashboard TV” y “Volver” */
  .btn-cdl[style*="background:#111"]{ box-shadow:0 10px 22px rgba(17,17,17,.18) }
  .btn-cdl[style*="background:#111"]:hover{ box-shadow:0 14px 28px rgba(17,17,17,.26) }
</style>

<!-- =========================================================
BLOQUE 268 — Skeleton visual para tarjetas (sin JS, opcional)
========================================================= -->
<style>
  .skeleton{ position:relative; overflow:hidden; background:#eef1f5 }
  .skeleton::after{
    content:""; position:absolute; inset:0;
    transform: translateX(-100%);
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.55), transparent);
    animation: sk-shine 1.2s infinite;
  }
  @keyframes sk-shine{
    100%{ transform: translateX(100%) }
  }
</style>
<!-- Uso opcional (visual): <div class="eq-card__media skeleton"></div> -->

<!-- =========================================================
BLOQUE 269 — Manifiesto y tema (solo si no lo tenías ya)
========================================================= -->
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#E43B3B">

<!-- =========================================================
BLOQUE 270 — Grid de tarjetas: respiración y alineado fino
========================================================= -->
<style>
  .equipos-grid{
    gap: 14px; /* un pelín más de aire */
  }
  .eq-card{
    transition: box-shadow .14s ease, transform .10s ease;
    will-change: transform;
  }
  .eq-card:hover{
    box-shadow: 0 10px 24px rgba(17,24,39,.08);
    transform: translateY(-1px);
  }
  .eq-card__body{ padding: 12px 12px 14px }
  .eq-title{ gap: 10px }
  .eq-meta{ font-variant-numeric: tabular-nums }
</style>

<!-- =========================================================
BLOQUE 271 — Estados de foco accesibles (teclado)
========================================================= -->
<style>
  :root{
    --focus: 0 0 0 3px rgba(228,59,59,.22);
    --focus-inset: inset 0 0 0 2px rgba(228,59,59,.28);
  }
  .cdl-hamb:focus-visible,
  .cdl-x:focus-visible,
  .cdl-panel__nav a:focus-visible,
  .btn-cdl:focus-visible,
  .evt-form input:focus-visible,
  .evt-form select:focus-visible,
  .evt-form textarea:focus-visible{
    outline: none;
    box-shadow: var(--focus);
    border-color: #f3c2c2;
  }
  .cdl-panel__nav a:focus-visible{ box-shadow: var(--focus-inset), var(--focus) }
</style>

<!-- =========================================================
BLOQUE 272 — Inputs del formulario: ritmo vertical + ayudas
========================================================= -->
<style>
  .evt-form label{ font-weight:600; color:#111; display:grid; gap:6px }
  .evt-form input::placeholder,
  .evt-form textarea::placeholder{ color:#9aa3af }
  .evt-form select{ appearance:none; background-image: linear-gradient(45deg, transparent 50%, #999 50%), linear-gradient(135deg, #999 50%, transparent 50%); background-position: calc(100% - 16px) 55%, calc(100% - 11px) 55%; background-size:5px 5px,5px 5px; background-repeat:no-repeat; }
  .evt-form button[type="submit"]{ margin-top: 4px }
</style>

<!-- =========================================================
BLOQUE 273 — Tabla histórico: legibilidad y corte de texto
========================================================= -->
<style>
  .eq-table td:nth-child(5){
    max-width: 420px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }
  @media (max-width: 680px){
    .eq-table td:nth-child(5){ max-width: 200px }
  }
</style>

<!-- =========================================================
BLOQUE 274 — Titulares: micro-ajuste óptico del “marco rojo”
========================================================= -->
<style>
  :where(h1,h2,h3){ padding-left: .70rem }
  :where(h1,h2,h3)::before{
    top: .12rem; width: 19px; height: 19px;
  }
</style>

<!-- =========================================================
BLOQUE 275 — Scroll: suave pero respeta reduce-motion
========================================================= -->
<style>
  html{ scroll-behavior: smooth }
  @media (prefers-reduced-motion: reduce){
    html{ scroll-behavior: auto }
  }
</style>

<!-- =========================================================
BLOQUE 276 — Router: evitar saltos al cambiar de vista
========================================================= -->
<script>
  /* Suaviza el cambio de hash manteniendo la posición si ya estás en top */
  (function(){
    let lastHash = "";
    window.addEventListener('hashchange', ()=>{
      const nearTop = (window.scrollY||document.documentElement.scrollTop) < 8;
      if(nearTop){ try{ document.getElementById('main')?.scrollIntoView({block:'start'}) }catch{} }
      lastHash = location.hash;
    }, {passive:true});
    window.addEventListener('load', ()=>{ lastHash = location.hash; }, {passive:true});
  })();
</script>

<!-- =========================================================
BLOQUE 277 — Cabecera: clic en logo vuelve a “Equipos”
========================================================= -->
<script>
  (function(){
    const logo = document.querySelector('.cdl-logo img');
    if(logo && !logo.dataset.bound){
      logo.style.cursor='pointer';
      logo.addEventListener('click', ()=>{ location.hash='#/equipos' });
      logo.dataset.bound = '1';
    }
  })();
</script>

<!-- =========================================================
BLOQUE 278 — Afinado del watermark según densidad de pantalla
========================================================= -->
<style>
  @media (-webkit-min-device-pixel-ratio:2), (min-resolution:192dpi){
    #cdlHeader::after{
      background:
        radial-gradient(60% 60% at 0% 0%, rgba(228,59,59,.05), transparent 70%) no-repeat,
        url('./logo_mantenimiento.png') left clamp(16px, 4vw, 26px) top clamp(6px, 2.5vw, 12px) / clamp(180px, 26vw, 300px) auto no-repeat;
    }
  }
</style>

<!-- =========================================================
BLOQUE 279 — Favicon y apple-touch-icon (coherencia visual)
========================================================= -->
<link rel="icon" href="./logo-cdl.png" type="image/png" sizes="64x64">
<link rel="apple-touch-icon" href="./logo-cdl.png">

<!-- =========================================================
BLOQUE 280 — Panel lateral: sombreado + transiciones suaves
========================================================= -->
<style>
  .cdl-panel{
    box-shadow: 4px 0 24px rgba(0,0,0,.08);
    transition: transform .28s ease, box-shadow .28s ease;
  }
  .cdl-panel[aria-hidden="false"]{ box-shadow: 6px 0 28px rgba(0,0,0,.10) }
</style>

<!-- =========================================================
BLOQUE 281 — Panel: interacción táctil (swipe close básico)
========================================================= -->
<script>
(function(){
  const panel = document.getElementById('pagesPanel');
  if(!panel || panel.dataset.swipe) return;
  let startX=null;
  panel.addEventListener('touchstart',e=>{ startX=e.touches[0].clientX; },{passive:true});
  panel.addEventListener('touchmove',e=>{
    if(startX!==null){
      const dx=e.touches[0].clientX-startX;
      if(dx<-80){ panel.setAttribute('aria-hidden','true'); document.getElementById('panelBackdrop').hidden=true; startX=null; }
    }
  },{passive:true});
  panel.dataset.swipe='1';
})();
</script>

<!-- =========================================================
BLOQUE 282 — Hover tarjetas: gradiente muy sutil
========================================================= -->
<style>
  .eq-card:hover{ 
    background: linear-gradient(180deg,#fff,#fdfdfd);
  }
</style>

<!-- =========================================================
BLOQUE 283 — Zebra en tablas histórico/equipos
========================================================= -->
<style>
  .eq-table tbody tr:nth-child(even){ background:#fafafa }
</style>

<!-- =========================================================
BLOQUE 284 — KPIs: tipografía y jerarquía
========================================================= -->
<style>
  .kpi b{ font-size:1.25rem; font-weight:900; color:#111 }
  .kpi span{ font-size:.85rem; color:#6b7280 }
</style>

<!-- =========================================================
BLOQUE 285 — Botones: feedback rápido
========================================================= -->
<style>
  .btn-cdl{ transition: background .14s ease, transform .12s ease }
  .btn-cdl:hover{ filter:brightness(1.05) }
  .btn-cdl:active{ transform: translateY(1px) scale(.98) }
</style>

<!-- =========================================================
BLOQUE 286 — Semáforo: tamaños compactos en tarjetas
========================================================= -->
<style>
  .eq-actions .cdl-sem.compact .btn{ font-size:.8rem; padding:0 .45rem; }
  .eq-actions .chip{ font-size:.8rem }
</style>

<!-- =========================================================
BLOQUE 287 — Panel búsqueda: input animado
========================================================= -->
<style>
  .cdl-panel__search input:focus{ border-color:#e43b3b; box-shadow:0 0 0 2px rgba(228,59,59,.2) }
</style>

<!-- =========================================================
BLOQUE 288 — Tipografía global: afinado
========================================================= -->
<style>
  body{ -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility }
  h1,h2,h3{ -webkit-font-smoothing:auto }
</style>

<!-- =========================================================
BLOQUE 289 — Footer copy: menor tamaño + color gris
========================================================= -->
<style>
  .cdl-panel__foot small{ font-size:.75rem; color:#9ca3af }
</style>

<!-- =========================================================
BLOQUE 290 — Cabecera: compacta en pantallas pequeñas
========================================================= -->
<style>
  @media(max-width:480px){
    .cdl-header__inner{ padding-inline:8px }
    .cdl-logo img{ height:22px }
    .cdl-user__role{ display:none }
  }
</style>

<!-- =========================================================
BLOQUE 291 — Cabecera: transición sombra al hacer scroll
========================================================= -->
<style>
  #cdlHeader.scrolled{ box-shadow:0 4px 14px rgba(0,0,0,.08) }
</style>
<script>
(function(){
  const hdr=document.getElementById('cdlHeader');
  if(!hdr) return;
  window.addEventListener('scroll',()=>{
    hdr.classList.toggle('scrolled',window.scrollY>5);
  },{passive:true});
})();
</script>

<!-- =========================================================
BLOQUE 292 — Accesibilidad: aria-current en menú
========================================================= -->
<script>
(function(){
  const navLinks=document.querySelectorAll('.cdl-panel__nav a');
  function updateNav(){
    const h=location.hash.split('?')[0];
    navLinks.forEach(a=>{
      a.removeAttribute('aria-current');
      if(h && a.getAttribute('href')===h){ a.setAttribute('aria-current','page'); }
    });
  }
  window.addEventListener('hashchange',updateNav);
  window.addEventListener('load',updateNav);
})();
</script>

<!-- =========================================================
BLOQUE 293 — Botones accesibles: focus visible
========================================================= -->
<style>
  .btn-cdl:focus-visible,.cdl-x:focus-visible,.cdl-hamb:focus-visible,.cdl-user__btn:focus-visible{
    outline:2px solid var(--cdl-red); outline-offset:2px;
  }
</style>

<!-- =========================================================
BLOQUE 294 — Menú lateral: scroll interno
========================================================= -->
<style>
  .cdl-panel__nav{ overflow-y:auto; max-height:calc(100vh - 180px) }
</style>

<!-- =========================================================
BLOQUE 295 — Performance: lazy load imágenes tarjetas
========================================================= -->
<script>
(function(){
  const obs=new IntersectionObserver(entries=>{
    entries.forEach(e=>{
      if(e.isIntersecting){
        const ph=e.target.querySelector('.eq-card__media');
        if(ph && !ph.dataset.loaded){
          ph.style.backgroundImage="url('./linea-kaltenbach.jpeg')";
          ph.dataset.loaded="1";
        }
      }
    });
  },{rootMargin:"100px"});
  document.querySelectorAll('.eq-card').forEach(c=>obs.observe(c));
})();
</script>

<!-- =========================================================
BLOQUE 296 — Tablas: scroll horizontal responsivo
========================================================= -->
<style>
  .eq-table{ overflow-x:auto }
  .eq-table table{ min-width:600px }
</style>

<!-- =========================================================
BLOQUE 297 — Animación suave apertura panel
========================================================= -->
<style>
  .cdl-panel{ transition: transform .25s cubic-bezier(.4,0,.2,1) }
</style>

<!-- =========================================================
BLOQUE 298 — Cabecera watermark: ajuste responsive
========================================================= -->
<style>
  #cdlHeader::after{
    background-size:200px auto;
    opacity:.75;
  }
  @media(min-width:1024px){
    #cdlHeader::after{ background-size:300px auto; opacity:.9; }
  }
</style>

<!-- =========================================================
BLOQUE 299 — Optimización carga fuentes
========================================================= -->
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap">

<!-- =========================================================
BLOQUE 300 — Tabla: cabecera fija + zebra + compacta
========================================================= -->
<style>
  .eq-table{ overflow:auto; border-radius:12px }
  .eq-table thead th{
    position:sticky; top:0; z-index:1;
    background:#f8fafc; /* igual que antes, pero sticky */
  }
  .eq-table tbody tr:nth-child(odd){ background:#fcfcfd }
  .eq-table th,.eq-table td{ white-space:nowrap }
  .eq-table td:last-child{ max-width:460px; white-space:normal } /* detalle puede ser largo */
</style>

<!-- =========================================================
BLOQUE 301 — KPIs: fichas con microrelieve y mejor jerarquía
========================================================= -->
<style>
  .kpi{
    background:linear-gradient(#fff, #fff) padding-box,
               linear-gradient(180deg, #f5f7fb, #eef2f7) border-box;
    border:1px solid #e5e7eb; box-shadow:0 1px 0 rgba(17,24,39,.03);
  }
  .kpi b{ font-variant-numeric:tabular-nums; letter-spacing:.2px }
  .kpi span{ color:var(--cdl-muted); font-size:.9rem }
</style>

<!-- =========================================================
BLOQUE 302 — Botón “volver arriba” discreto (UX)
========================================================= -->
<style>
  #toTop{
    position:fixed; right:16px; bottom:16px; height:42px; width:42px;
    display:grid; place-items:center; border-radius:999px;
    border:1px solid #e5e7eb; background:#fff; color:#111;
    box-shadow:0 6px 18px rgba(0,0,0,.06); opacity:0; pointer-events:none;
    transition:opacity .2s ease, transform .2s ease; transform:translateY(8px); z-index:1200;
  }
  #toTop.show{ opacity:1; pointer-events:auto; transform:translateY(0) }
</style>
<button id="toTop" aria-label="Volver arriba" title="Volver arriba">↑</button>
<script>
(function(){
  const b=document.getElementById('toTop'); if(!b) return;
  b.addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'}));
  const onScroll=()=> b.classList.toggle('show', window.scrollY>600);
  window.addEventListener('scroll', onScroll, {passive:true}); onScroll();
})();
</script>

<!-- =========================================================
BLOQUE 303 — Tokens extra: sombras, radios y transiciones CDL
========================================================= -->
<style>
  :root{
    --cdl-radius:12px;
    --cdl-shadow-sm:0 1px 2px rgba(0,0,0,.04);
    --cdl-shadow-md:0 6px 18px rgba(0,0,0,.06);
    --cdl-transition:.2s cubic-bezier(.4,0,.2,1);
  }
  .eq-card,.eq-detail__right{ border-radius:var(--cdl-radius); box-shadow:var(--cdl-shadow-sm) }
  .btn-cdl{ transition:transform var(--cdl-transition), box-shadow var(--cdl-transition) }
  .btn-cdl:hover{ box-shadow:0 10px 24px rgba(228,59,59,.25); transform:translateY(-1px) }
</style>

<!-- =========================================================
BLOQUE 304 — Accesibilidad: “prefers-reduced-motion” respetado
========================================================= -->
<style>
@media (prefers-reduced-motion: reduce){
  *{ animation-duration:0.001ms !important; animation-iteration-count:1 !important; transition-duration:0.001ms !important; scroll-behavior:auto !important }
}
</style>

<!-- =========================================================
BLOQUE 305 — Inputs y selects: look unificado (iOS/Android/Web)
========================================================= -->
<style>
  input, select, textarea{
    -webkit-appearance:none; appearance:none; outline:none;
  }
  select{
    background:
      linear-gradient(180deg,#fff,#fff) padding-box,
      linear-gradient(90deg,#e5e7eb,#e5e7eb) border-box;
    background-image:
      linear-gradient(180deg,#fff,#fff),
      linear-gradient(90deg,#e5e7eb,#e5e7eb),
      url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 20 20' fill='none' stroke='black' stroke-width='2'%3E%3Cpath d='M5 8l5 5 5-5'/%3E%3C/svg%3E");
    background-repeat:no-repeat,no-repeat,no-repeat;
    background-position:0 0, 0 0, right .75rem center;
    background-size:auto, auto, 14px;
    padding-right:2.2rem !important;
  }
  input:focus, select:focus, textarea:focus{
    border-color:#d1d5db; box-shadow:0 0 0 3px rgba(228,59,59,.15);
  }
</style>

<!-- =========================================================
BLOQUE 306 — Estados de botones del semáforo: microfeedback
========================================================= -->
<style>
  .cdl-sem .btn{ transition: background var(--cdl-transition), transform var(--cdl-transition) }
  .cdl-sem .btn[aria-pressed="true"]{ transform:translateY(-1px) }
</style>

<!-- =========================================================
BLOQUE 307 — Skeleton para tarjetas de equipos (percepción de velocidad)
========================================================= -->
<style>
  .skeleton{ position:relative; overflow:hidden; background:#f3f4f6 }
  .skeleton::after{
    content:""; position:absolute; inset:0;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
    transform:translateX(-100%); animation:shimmer 1.2s infinite;
  }
  @keyframes shimmer{ 100%{ transform:translateX(100%) } }
</style>
<script>
(function(){
  // Añade skeleton mientras aún no se puebla el grid (micro-mejora UX; se quita al renderizar)
  const grid=document.getElementById('equiposGrid');
  if(!grid) return;
  if(!grid.children.length){
    for(let i=0;i<3;i++){
      const ph=document.createElement('article');
      ph.className='eq-card';
      ph.innerHTML=`<div class="eq-card__media skeleton"></div>
                    <div class="eq-card__body">
                      <div class="eq-title skeleton" style="height:18px;border-radius:6px"></div>
                      <div class="eq-actions" style="gap:8px">
                        <div class="eq-sem skeleton" style="height:30px;flex:1;border-radius:999px"></div>
                        <div class="eq-qr skeleton" style="height:60px;width:60px;border-radius:8px"></div>
                      </div>
                    </div>`;
      grid.appendChild(ph);
    }
  }
  // Al primer render real, limpiar skeleton (hookeamos a renderEquipos)
  const _render = window.renderEquipos;
  if(typeof _render === 'function'){
    window.renderEquipos = function(list,q){
      grid.innerHTML=''; // limpia skeleton
      return _render(list,q);
    }
  }
})();
</script>

<!-- =========================================================
BLOQUE 308 — Menú lateral: hover/active con subrayado deslizante
========================================================= -->
<style>
  .cdl-panel__nav a{
    position:relative; transition:background var(--cdl-transition)
  }
  .cdl-panel__nav a::after{
    content:""; position:absolute; left:12px; right:auto; bottom:6px;
    width:0; height:2px; background:var(--cdl-red); transition:width var(--cdl-transition)
  }
  .cdl-panel__nav a:hover::after, .cdl-panel__nav a[aria-current="page"]::after{ width:24px }
</style>

<!-- =========================================================
BLOQUE 309 — Fijar fondo blanco y contraste en modo oscuro del SO
========================================================= -->
<style>
  @media (prefers-color-scheme: dark){
    html, body{ background:#fff; color:#111 } /* forzamos look cdl.es */
    .eq-card,.eq-detail__right,.cdl-panel,.cdl-header{ background:#fff }
    .cdl-panel__backdrop{ background:rgba(0,0,0,.35) }
  }
</style>
<!-- =========================================================
BLOQUE 310 — Cabecera: alturas, márgenes y alineación finas
========================================================= -->
<style>
  :root{
    --hdr-h: 76px;               /* base móvil */
    --hdr-pad-x: 10px;
  }
  @media (min-width: 768px){
    :root{ --hdr-h: 84px; --hdr-pad-x: 14px; }
  }
  #cdlHeader.cdl-header{ height:var(--hdr-h) }
  #cdlHeader .cdl-header__inner{ padding-inline:var(--hdr-pad-x) }
  /* Logo sutilmente más nítido */
  .cdl-logo img{ height:28px; image-rendering:-webkit-optimize-contrast; }
  @media (min-width: 1024px){ .cdl-logo img{ height:30px } }
  /* Botones de cabecera: alineación perfecta al píxel */
  .cdl-hamb, .cdl-user__btn{ width:42px; height:42px; display:grid; place-items:center }
  .cdl-user{ gap:.6rem }
  .cdl-user__role{ line-height:1; padding-top:1px } /* óptico */
</style>
<!-- =========================================================
BLOQUE 320 — Cabecera: ritmo espacial y “snap” de alineaciones
========================================================= -->
<style>
  :root{ --hdr-gap: clamp(8px, 2vw, 16px); }
  .cdl-header__inner{ gap:var(--hdr-gap) }
  .cdl-logo{ display:flex; align-items:center; min-width:96px }
  /* Alineación óptica de los tres bloques: hamb | logo | usuario */
  @media (min-width: 1024px){
    .cdl-header__inner{ grid-template-columns: auto 1fr auto; display:grid }
    .cdl-logo{ justify-self:start }
    .cdl-user{ justify-self:end }
  }
</style>
<!-- =========================================================
BLOQUE 310 — Cabecera: alturas, márgenes y alineación finas
========================================================= -->
<style>
  :root{
    --hdr-h: 76px;               /* base móvil */
    --hdr-pad-x: 10px;
  }
  @media (min-width: 768px){
    :root{ --hdr-h: 84px; --hdr-pad-x: 14px; }
  }
  #cdlHeader.cdl-header{ height:var(--hdr-h) }
  #cdlHeader .cdl-header__inner{ padding-inline:var(--hdr-pad-x) }
  /* Logo sutilmente más nítido */
  .cdl-logo img{ height:28px; image-rendering:-webkit-optimize-contrast; }
  @media (min-width: 1024px){ .cdl-logo img{ height:30px } }
  /* Botones de cabecera: alineación perfecta al píxel */
  .cdl-hamb, .cdl-user__btn{ width:42px; height:42px; display:grid; place-items:center }
  .cdl-user{ gap:.6rem }
  .cdl-user__role{ line-height:1; padding-top:1px } /* óptico */
</style>

<!-- =========================================================
BLOQUE 311 — Watermark cabecera: posicionamiento y respiración
========================================================= -->
<style>
  /* Asegura respiración para menú y usuario */
  #cdlHeader::after{
    inset:-42% -6% 44% -6%;
    background:
      radial-gradient(55% 60% at 0% 0%, rgba(228,59,59,.07), transparent 70%) no-repeat,
      url('./logo_mantenimiento.png') left max(24px, var(--hdr-pad-x)) top 8px / clamp(200px, 28vw, 320px) auto no-repeat;
    opacity:.9;
  }
  /* Evita solaparse en pantallas muy pequeñas */
  @media (max-width: 360px){
    #cdlHeader::after{
      background:
        radial-gradient(55% 60% at 0% 0%, rgba(228,59,59,.07), transparent 70%) no-repeat,
        url('./logo_mantenimiento.png') left 12px top 12px / 200px auto no-repeat;
    }
  }
</style>

<!-- =========================================================
BLOQUE 312 — UX: hit-area generosa + estados de foco accesibles
========================================================= -->
<style>
  .cdl-hamb, .cdl-user__btn, .cdl-x{
    touch-action:manipulation; -webkit-tap-highlight-color:transparent;
  }
  .cdl-hamb:focus-visible, .cdl-user__btn:focus-visible, .cdl-x:focus-visible,
  .btn-cdl:focus-visible, .cdl-panel__nav a:focus-visible{
    outline:3px solid rgba(228,59,59,.3); outline-offset:2px; border-radius:10px;
  }
  /* Fácil pulsación en enlaces del panel */
  .cdl-panel__nav a{ padding:.8rem .9rem; }
</style>

<!-- =========================================================
BLOQUE 313 — Tipografía y legibilidad pro (como cdl.es)
========================================================= -->
<style>
  html{ -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale }
  body{ letter-spacing:.005em }
  h1,h2,h3{ letter-spacing:.01em }
  .eq-meta, .cdl-panel__foot, .kpi span{ letter-spacing:.01em }
  small,.eq-meta{ font-variant-numeric:tabular-nums }
</style>

<!-- =========================================================
BLOQUE 314 — Marca en títulos: micrologo CDL en esquina superior
========================================================= -->
<style>
  /* Añadimos un micrologo en todos los h1,h2,h3 sin tapar texto */
  :where(h1,h2,h3){
    padding-left: calc(.65rem + 20px); /* espacio para micrologo */
  }
  :where(h1,h2,h3)::after{
    content:""; position:absolute; left:.65rem; top:.05rem; width:16px; height:16px;
    background:url('./logo-cdl.png') center/contain no-repeat;
    opacity:.92; pointer-events:none; filter:contrast(1.05) saturate(1.02);
  }
  /* Mantén el “marco rojo” existente (pseudo ::before) sin cambios */
</style>

<!-- =========================================================
BLOQUE 315 — Tarjetas: elevación suave y hover sobrio
========================================================= -->
<style>
  .eq-card{
    transition: box-shadow .18s ease, transform .18s ease, border-color .18s ease;
    will-change: box-shadow, transform;
  }
  .eq-card:hover{ transform:translateY(-1px); box-shadow:0 8px 24px rgba(0,0,0,.06); border-color:#e6eaf0 }
  .eq-card__media{ border-bottom:1px solid #eef1f5 }
</style>

<!-- =========================================================
BLOQUE 316 — Tablas: densidad, hover y alineaciones
========================================================= -->
<style>
  .eq-table th, .eq-table td{ padding:9px 12px }
  .eq-table tbody tr:hover{ background:#f9fafb }
  .eq-table td:nth-child(3), .eq-table td:nth-child(4){ text-align:right } /* Horas / Coste */
  .eq-table th:nth-child(3), .eq-table th:nth-child(4){ text-align:right }
</style>

<!-- =========================================================
BLOQUE 317 — Botón “← Volver” con look de migas discretas
========================================================= -->
<style>
  #equipoView > a.btn-cdl{
    background:#111 !important; border-radius:999px;
    padding:.55rem .9rem !important; box-shadow:var(--cdl-shadow-sm);
  }
  #equipoView > a.btn-cdl:hover{ box-shadow:0 8px 24px rgba(0,0,0,.08) }
</style>

<!-- =========================================================
BLOQUE 318 — Rendimiento: content-visibility/contain en grid
========================================================= -->
<style>
  .eq-card{ content-visibility:auto; contain-intrinsic-size: 240px 320px; }
  .eq-card__media{ contain:content }
</style>
<script>
  // Optimiza decodificación de imágenes (si se añaden fotos reales)
  (function(){
    document.addEventListener('load', e=>{
      if(e.target.tagName==='IMG'){ e.target.decoding='async'; e.target.loading='lazy'; }
    }, true);
  })();
</script>

<!-- =========================================================
BLOQUE 319 — Movimiento suave y seguro + scroll UX
========================================================= -->
<style>
  html{ scroll-behavior:smooth }
  @media (prefers-reduced-motion: reduce){ html{ scroll-behavior:auto } }
</style>
<!-- =========================================================
BLOQUE 320 — Cabecera: ritmo espacial y “snap” de alineaciones
========================================================= -->
<style>
  :root{ --hdr-gap: clamp(8px, 2vw, 16px); }
  .cdl-header__inner{ gap:var(--hdr-gap) }
  .cdl-logo{ display:flex; align-items:center; min-width:96px }
  /* Alineación óptica de los tres bloques: hamb | logo | usuario */
  @media (min-width: 1024px){
    .cdl-header__inner{ grid-template-columns: auto 1fr auto; display:grid }
    .cdl-logo{ justify-self:start }
    .cdl-user{ justify-self:end }
  }
</style>
<!-- =========================================================
BLOQUE 321 — Panel lateral: estados activos + secciones
========================================================= -->
<style>
  .cdl-panel__nav a.is-active{
    background:#f3f4f6; border:1px solid #e5e7eb; font-weight:900;
  }
  .cdl-panel__nav hr{ height:1px; border:0; background:var(--cdl-line); margin:.35rem .4rem }
</style>
<script>
  // Marca activo según hash (solo clase visual)
  (function(){
    function markActive(){
      const h = location.hash.split('?')[0];
      document.querySelectorAll('.cdl-panel__nav a').forEach(a=>{
        a.classList.toggle('is-active', a.getAttribute('href')===h);
      });
    }
    window.addEventListener('hashchange', markActive);
    window.addEventListener('load', markActive);
  })();
</script>

<!-- =========================================================
BLOQUE 322 — Hero: proporciones y espaciados tipo cdl.es
========================================================= -->
<style>
  .cdl-hero{ padding: clamp(8px, 1.8vw, 18px) 0 6px }
  .cdl-hero p{ font-size:clamp(.98rem, 1.2vw, 1.05rem) }
  .cdl-hero .btn-cdl{ min-height:42px }
</style>

<!-- =========================================================
BLOQUE 323 — Semáforo: micro-interacciones sobrias
========================================================= -->
<style>
  .cdl-sem .btn{ transition:background .16s ease, outline-color .16s ease }
  .cdl-sem .btn:hover{ background:#f5f6f7 }
  .cdl-sem .chip{ box-shadow:0 1px 0 rgba(0,0,0,.02) inset }
</style>

<!-- =========================================================
BLOQUE 324 — KPIs: cuadrícula estable y jerarquía visual
========================================================= -->
<style>
  .kpi{ display:grid; grid-template-rows:auto 1fr; align-items:start }
  .kpi b{ line-height:1.1 }
  .kpi span{ color:#6b7280; font-size:.9rem }
  @media (min-width:720px){
    .eq-detail__left > div[style*="grid-template-columns"]{ grid-template-columns:repeat(3,1fr) }
  }
</style>

<!-- =========================================================
BLOQUE 325 — QR: nitidez y affordance de “descargar”
========================================================= -->
<style>
  .eq-qr, .eq-qr-big{ position:relative }
  .eq-qr::after, .eq-qr-big::after{
    content:""; position:absolute; inset:0; border-radius:inherit; transition:box-shadow .15s ease;
  }
  .eq-qr:hover::after, .eq-qr-big:hover::after{ box-shadow:inset 0 0 0 2px #e5e7eb }
</style>

<!-- =========================================================
BLOQUE 326 — Accesibilidad: contraste y foco coherente
========================================================= -->
<style>
  /* AA mínimo para textos secundarios sobre blanco */
  .eq-meta, .cdl-panel__foot{ color:#525a66 }
  /* Foco consistente ya definido en 312; afinamos separación */
  .btn-cdl:focus-visible{ outline-offset:3px }
</style>

<!-- =========================================================
BLOQUE 327 — Skeleton de tarjetas (UX de carga; solo visual)
========================================================= -->
<style>
  .skeleton{ position:relative; overflow:hidden; background:#f3f4f6 }
  .skeleton::before{
    content:""; position:absolute; inset:0;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,.5), transparent);
    transform:translateX(-100%); animation:sweep 1.2s infinite;
  }
  @keyframes sweep{ to{ transform:translateX(100%) } }
  .eq-card.sk .eq-card__media{ background:#eef1f5 }
  .eq-card.sk .eq-card__body > *{ height:14px; border-radius:6px }
</style>
<script>
  // Antes de renderizar, muestra 6 skeletons; luego reemplaza (no cambia la lógica)
  (function(){
    const grid = document.getElementById('equiposGrid');
    if(!grid) return;
    function paintSkeleton(n=6){
      grid.innerHTML = '';
      for(let i=0;i<n;i++){
        const el=document.createElement('article');
        el.className='eq-card sk skeleton';
        el.innerHTML=`<div class="eq-card__media"></div>
          <div class="eq-card__body">
            <div></div><div></div><div style="height:32px"></div>
          </div>`;
        grid.appendChild(el);
      }
    }
    window.addEventListener('load', ()=>{ paintSkeleton(); setTimeout(()=>{},0) }, {once:true});
    // Exponer para usarlo antes de búsquedas si se quiere (solo visual)
    window.__paintEquiposSkeleton = paintSkeleton;
  })();
</script>

<!-- =========================================================
BLOQUE 328 — Rendimiento: listeners pasivos y hints
========================================================= -->
<script>
  // Evita bloqueos de scroll con rueda/táctil en panel
  (function(){
    const opts = { passive:true };
    window.addEventListener('touchstart', ()=>{}, opts);
    window.addEventListener('wheel', ()=>{}, opts);
  })();
</script>
<style>
  .btn-cdl{ will-change: transform }
  .cdl-panel{ will-change: transform }
</style>

<!-- =========================================================
BLOQUE 329 — Tokens de sombras y z-layers centralizados
========================================================= -->
<style>
  :root{
    --z-header:1000; --z-panel:1100; --z-backdrop:1090;
    --cdl-shadow-sm: 0 1px 2px rgba(0,0,0,.05);
    --cdl-shadow-md: 0 6px 18px rgba(0,0,0,.07);
    --cdl-shadow-lg: 0 16px 42px rgba(0,0,0,.10);
  }
  #cdlHeader{ z-index:var(--z-header) }
  .cdl-panel{ z-index:var(--z-panel) }
  .cdl-panel__backdrop{ z-index:var(--z-backdrop) }
</style>
<!-- =========================================================
BLOQUE 330 — Cabecera desktop: alturas, márgenes y tipografía
========================================================= -->
<style>
  @media (min-width: 1200px){
    :root{ --hdr-h: 84px }
    .cdl-header{ border-bottom:1px solid #ECEFF3 }
    .cdl-header__inner{ padding-block: 6px }
    .cdl-user__role{ font-size: .95rem; letter-spacing:.01em }
    .cdl-hamb, .cdl-user__btn{ width:44px; height:44px }
    .cdl-logo img{ height:30px }
  }
</style>

<!-- =========================================================
BLOQUE 331 — Tipografía: escalas coherentes y tracking
========================================================= -->
<style>
  :root{
    --font-body: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    --lh: 1.45;
  }
  html, body{ line-height: var(--lh) }
  p, li{ letter-spacing: .005em }
  strong{ font-weight: 800 }
  .eq-title{ letter-spacing:.01em }
  /* Ajuste fino de h1–h3 ya definidos */
  h1{ font-variation-settings:"wght" 830 }
  h2{ font-variation-settings:"wght" 760 }
  h3{ font-variation-settings:"wght" 700 }
</style>

<!-- =========================================================
BLOQUE 332 — Iconografía ligera (SVG embebidos reutilizables)
========================================================= -->
<svg aria-hidden="true" style="position:absolute; width:0; height:0; overflow:hidden">
  <defs>
    <symbol id="ic-search" viewBox="0 0 24 24">
      <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" fill="none"/>
      <path d="M20 20L17 17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
    <symbol id="ic-back" viewBox="0 0 24 24">
      <path d="M15 6L9 12l6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    <symbol id="ic-print" viewBox="0 0 24 24">
      <path d="M6 9V3h12v6M6 17h12v4H6z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <rect x="4" y="9" width="16" height="8" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2"/>
    </symbol>
  </defs>
</svg>
<style>
  .ico{ width:18px; height:18px; display:inline-block; vertical-align:-2px }
  .btn-icon{ display:inline-grid; grid-auto-flow:column; gap:.45rem; place-items:center }
</style>

<!-- =========================================================
BLOQUE 333 — Sustituir texto “Volver” por botón con icono
========================================================= -->
<script>
  (function(){
    const back = document.querySelector('#equipoView a.btn-cdl');
    if(back && !back.dataset.iconized){
      back.dataset.iconized = '1';
      back.innerHTML = `<svg class="ico" aria-hidden="true"><use href="#ic-back"/></svg> Volver`;
    }
    const printBtn = document.querySelector('#equipoView button.btn-cdl[onclick*="print"]');
    if(printBtn && !printBtn.dataset.iconized){
      printBtn.dataset.iconized = '1';
      printBtn.classList.add('btn-icon');
      printBtn.innerHTML = `<svg class="ico" aria-hidden="true"><use href="#ic-print"/></svg> Imprimir ficha`;
    }
  })();
</script>

<!-- =========================================================
BLOQUE 334 — Tarjetas: elevación y hover sobrio
========================================================= -->
<style>
  .eq-card{ box-shadow: var(--cdl-shadow-sm); transition:transform .12s ease, box-shadow .18s ease }
  .eq-card:hover{ transform: translateY(-1px); box-shadow: var(--cdl-shadow-md) }
</style>

<!-- =========================================================
BLOQUE 335 — Tabla histórico: zebra, sticky header y wrapping
========================================================= -->
<style>
  .eq-table{ max-height: 54vh; overflow:auto }
  .eq-table thead th{
    position: sticky; top:0; z-index:1;
    box-shadow: 0 1px 0 #e5e7eb; background:#f8fafc;
  }
  .eq-table tbody tr:nth-child(odd){ background:#fcfdff }
  .eq-table td{ word-break: break-word }
</style>

<!-- =========================================================
BLOQUE 336 — Cabecera: watermark afinado y seguridad de lectura
========================================================= -->
<style>
  /* reduce opacidad y eleva contraste de controles */
  #cdlHeader::after{ opacity:.75; background-size: 240px auto }
  .cdl-hamb, .cdl-user__btn{ background:#fff; backdrop-filter:saturate(110%) }
</style>

<!-- =========================================================
BLOQUE 337 — Ajustes de impresión (márgenes y tipografía)
========================================================= -->
<style>
  @page{ margin: 14mm }
  @media print{
    body{ font-size: 12pt }
    h2{ margin: 0 0 6px }
    .kpi b{ font-size: 1.1rem }
    .eq-qr-big{ margin-top:6px; border-color:#ddd }
    .eq-table{ max-height:none; overflow:visible }
  }
</style>

<!-- =========================================================
BLOQUE 338 — Performance hints: preconnect/preload defensivo
========================================================= -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link rel="dns-prefetch" href="https://fonts.gstatic.com" />
<link rel="dns-prefetch" href="https://fonts.googleapis.com" />
<link rel="preload" as="image" href="./logo-cdl.png" imagesizes="(max-width: 600px) 28px, 30px" />
<link rel="preload" as="image" href="./logo_mantenimiento.png" imagesizes="260px" />

<!-- =========================================================
BLOQUE 339 — Micro-UX: búsqueda con “Enter” y autofocus suave
========================================================= -->
<script>
  (function(){
    const box = document.getElementById('searchBox');
    const btn = document.getElementById('searchBtn');
    if(box && btn){
      box.addEventListener('keydown', (e)=>{
        if(e.key==='Enter'){ e.preventDefault(); btn.click(); }
      }, {passive:false});
      // Autofocus suave al abrir panel
      const openBtn = document.getElementById('btnMenu');
      const panel = document.getElementById('pagesPanel');
      if(openBtn && panel){
        openBtn.addEventListener('click', ()=>{
          setTimeout(()=> box?.focus({preventScroll:true}), 180);
        });
      }
    }
  })();
</script>
<!-- =========================================================
BLOQUE 340 — Cabecera: sombra sutil al hacer scroll
========================================================= -->
<style>
  .cdl-header.scrolled{ box-shadow:0 6px 18px rgba(17,24,39,.06) }
</style>
<script>
  (function(){
    const H = document.getElementById('cdlHeader');
    if(!H) return;
    const on = ()=> H.classList.toggle('scrolled', window.scrollY>4);
    on(); window.addEventListener('scroll', on, {passive:true});
  })();
</script>

<!-- =========================================================
BLOQUE 341 — Container: anchos de lectura y gutters
========================================================= -->
<style>
  :root{ --container: 1120px; --gutter: 16px }
  .cdl-container{ padding-inline: var(--gutter) }
  @media(min-width:1280px){ :root{ --container: 1180px; --gutter: 20px } }
</style>

<!-- =========================================================
BLOQUE 342 — Botones CDL: foco accesible y estados disabled
========================================================= -->
<style>
  .btn-cdl:focus-visible{ outline: 3px solid rgba(228,59,59,.35); outline-offset:2px }
  .btn-cdl[disabled]{ opacity:.5; cursor:not-allowed; box-shadow:none }
</style>

<!-- =========================================================
BLOQUE 343 — Tipografía de párrafo y listas
========================================================= -->
<style>
  p{ color:#374151; font-size:1rem }
  ul,ol{ color:#374151; padding-left:1.2rem }
  li+li{ margin-top:.25rem }
</style>

<!-- =========================================================
BLOQUE 344 — Hero: proporciones y ritmos
========================================================= -->
<style>
  .cdl-hero{ padding:8px 0 10px }
  .cdl-hero p{ margin:.3rem 0 .9rem }
  .cdl-hero .btn-cdl{ min-height:40px }
</style>

<!-- =========================================================
BLOQUE 345 — Chips de estado: contraste AA
========================================================= -->
<style>
  .cdl-sem .chip{ border-color:#e6e9ee }
  .dot-ok{ box-shadow:0 0 0 1px #0e6e2c inset, 0 0 0 1px rgba(0,0,0,.06) }
  .dot-warn{ box-shadow:0 0 0 1px #a26207 inset, 0 0 0 1px rgba(0,0,0,.06) }
  .dot-stop{ box-shadow:0 0 0 1px #7a1a1a inset, 0 0 0 1px rgba(0,0,0,.06) }
</style>

<!-- =========================================================
BLOQUE 346 — Panel lateral: transiciones más suaves
========================================================= -->
<style>
  .cdl-panel{ transition: transform .24s cubic-bezier(.22,.61,.36,1) }
  .cdl-panel__backdrop{ transition: opacity .2s ease }
  .cdl-panel[aria-hidden="true"] + .cdl-panel__backdrop{ opacity:0 }
  .cdl-panel[aria-hidden="false"] + .cdl-panel__backdrop{ opacity:1 }
</style>

<!-- =========================================================
BLOQUE 347 — Panel: foco inicial accesible
========================================================= -->
<script>
  (function(){
    const openBtn = document.getElementById('btnMenu');
    const panel = document.getElementById('pagesPanel');
    const closeBtn = document.getElementById('btnClosePanel');
    const input = document.getElementById('searchBox');
    if(openBtn && panel && closeBtn){
      openBtn.addEventListener('click', ()=> {
        setTimeout(()=> (input||closeBtn).focus({preventScroll:true}), 160);
      });
    }
  })();
</script>

<!-- =========================================================
BLOQUE 348 — Links de nav: estado activo por hash
========================================================= -->
<style>
  .cdl-panel__nav a.active{ background:#f3f4f6; color:#111; box-shadow: inset 0 0 0 1px #e5e7eb }
</style>
<script>
  (function(){
    const nav = document.querySelectorAll('.cdl-panel__nav a');
    const sync = ()=>{
      const h = location.hash||'#/equipos';
      nav.forEach(a=> a.classList.toggle('active', h.startsWith(a.getAttribute('href')) ));
    };
    window.addEventListener('hashchange', sync);
    window.addEventListener('load', sync);
  })();
</script>

<!-- =========================================================
BLOQUE 349 — Logo cabecera: click a raíz de app
========================================================= -->
<script>
  (function(){
    const L = document.querySelector('.cdl-logo img');
    L?.addEventListener('click', ()=>{ location.hash = '#/equipos'; });
    L?.setAttribute('style','cursor:pointer');
  })();
</script>

<!-- =========================================================
BLOQUE 350 — EQ grid: densidad y gaps para desktop
========================================================= -->
<style>
  @media(min-width:1280px){
    .equipos-grid{ grid-template-columns: repeat(4, 1fr); gap:14px }
  }
</style>

<!-- =========================================================
BLOQUE 351 — EQ card: cabecera compacta
========================================================= -->
<style>
  .eq-title{ font-size:1rem }
  .eq-meta{ font-size:.85rem }
</style>

<!-- =========================================================
BLOQUE 352 — Hover seguro en táctiles
========================================================= -->
<style>
  @media(hover:hover){
    .cdl-panel__nav a:hover{ background:#eef2f7 }
    .eq-card:hover .eq-card__body{ background:linear-gradient(180deg,#fff, #fff 70%, #fafbff) }
  }
</style>

<!-- =========================================================
BLOQUE 353 — Botones secundarios (blanco/negro)
========================================================= -->
<style>
  .btn-secondary{ border:1px solid #e5e7eb; background:#fff; color:#111; border-radius:999px; font-weight:800; padding:.6rem 1rem }
  .btn-secondary:focus-visible{ outline:3px solid rgba(17,24,39,.25); outline-offset:2px }
</style>

<!-- =========================================================
BLOQUE 354 — Tarjetas: espacios internos coherentes
========================================================= -->
<style>
  .eq-card__body{ padding:12px 12px 14px }
</style>

<!-- =========================================================
BLOQUE 355 — KPI: alineación tipográfica
========================================================= -->
<style>
  .kpi{ align-items:start }
  .kpi b{ line-height:1 }
  .kpi span{ color:#6b7280; font-size:.9rem }
</style>

<!-- =========================================================
BLOQUE 356 — Tabla: ancho de columnas
========================================================= -->
<style>
  .eq-table table{ table-layout: fixed }
  .eq-table th:nth-child(1), .eq-table td:nth-child(1){ width: 28% }
  .eq-table th:nth-child(2), .eq-table td:nth-child(2){ width: 18% }
  .eq-table th:nth-child(3), .eq-table td:nth-child(3){ width: 12% }
  .eq-table th:nth-child(4), .eq-table td:nth-child(4){ width: 14% }
  .eq-table th:nth-child(5), .eq-table td:nth-child(5){ width: 28% }
</style>

<!-- =========================================================
BLOQUE 357 — Selects e inputs: altura y radios
========================================================= -->
<style>
  .evt-form select, .evt-form input, .evt-form textarea{ min-height:40px; border-radius:12px }
  .evt-form label{ font-weight:800; color:#111; display:grid; gap:.35rem }
</style>

<!-- =========================================================
BLOQUE 358 — Color tokens de sombras (para consistencia)
========================================================= -->
<style>
  :root{
    --cdl-shadow-sm: 0 1px 2px rgba(17,24,39,.04), 0 1px 1px rgba(17,24,39,.03);
    --cdl-shadow-md: 0 10px 18px rgba(17,24,39,.07), 0 2px 6px rgba(17,24,39,.05);
  }
</style>

<!-- =========================================================
BLOQUE 359 — Cabecera: alineación vertical precisa
========================================================= -->
<style>
  .cdl-logo{ display:flex; align-items:center; gap:.6rem }
  .cdl-user__role{ transform: translateY(1px) }
</style>

<!-- =========================================================
BLOQUE 360 — Panel: bordes y radio consistentes
========================================================= -->
<style>
  .cdl-panel, .cdl-panel__search input, .cdl-x{ border-radius: 0 }
  .cdl-panel__search input{ border-color:#dde2ea }
</style>

<!-- =========================================================
BLOQUE 361 — Botones del semáforo: tamaño táctil
========================================================= -->
<style>
  .cdl-sem .btn{ min-width:74px }
  .cdl-sem.compact .btn{ min-width:62px }
</style>

<!-- =========================================================
BLOQUE 362 — Semáforo: cursor y títulos accesibles
========================================================= -->
<script>
  (function(){
    document.querySelectorAll('.cdl-sem .btn').forEach(b=>{
      b.style.cursor='pointer'; b.setAttribute('title', 'Cambiar estado a "'+(b.dataset.state||'')+'"');
    });
  })();
</script>

<!-- =========================================================
BLOQUE 363 — EQ QR: borde y sombra suaves
========================================================= -->
<style>
  .eq-qr, .eq-qr-big{ box-shadow:0 1px 0 rgba(17,24,39,.04) }
</style>

<!-- =========================================================
BLOQUE 364 — Ficha: columnas en XL
========================================================= -->
<style>
  @media(min-width:1360px){
    .eq-detail{ grid-template-columns: 1.25fr .75fr }
  }
</style>

<!-- =========================================================
BLOQUE 365 — Botón imprimir: sticky en sidebar al scrollear
========================================================= -->
<style>
  .eq-detail__right{ position: sticky; top: calc(var(--hdr-h) + 12px) }
</style>

<!-- =========================================================
BLOQUE 366 — Focus global visible en enlaces
========================================================= -->
<style>
  a:focus-visible{ outline:3px solid rgba(17,24,39,.28); outline-offset:2px; border-radius:6px }
</style>

<!-- =========================================================
BLOQUE 367 — Placeholder de búsqueda más claro
========================================================= -->
<style>
  .cdl-panel__search input::placeholder{ color:#9aa3b2 }
</style>

<!-- =========================================================
BLOQUE 368 — Hero: enlaces fuertes dentro del texto
========================================================= -->
<style>
  .cdl-hero a{ color:#111; font-weight:800; text-decoration-thickness:2px }
  .cdl-hero a:hover{ text-decoration:underline }
</style>

<!-- =========================================================
BLOQUE 369 — Micro-animación en watermark cabecera
========================================================= -->
<style>
  #cdlHeader.watermark-soft::after{ opacity:.7; transition:opacity .3s ease }
  #cdlHeader.watermark-soft:hover::after{ opacity:.82 }
</style>
<script> document.getElementById('cdlHeader')?.classList.add('watermark-soft'); </script>

<!-- =========================================================
BLOQUE 370 — Corrección de aliasing en logos (image-rendering)
========================================================= -->
<style>
  .cdl-logo img{ image-rendering:-webkit-optimize-contrast; image-rendering:crisp-edges }
</style>

<!-- =========================================================
BLOQUE 371 — Preferencia de color del sistema (por si acaso)
========================================================= -->
<meta name="color-scheme" content="light only" />

<!-- =========================================================
BLOQUE 372 — Reducción de motion si el usuario lo pide
========================================================= -->
<style>
  @media (prefers-reduced-motion: reduce){
    *{ animation-duration:.001ms !important; animation-iteration-count:1 !important; transition-duration:.001ms !important; scroll-behavior:auto !important }
  }
</style>

<!-- =========================================================
BLOQUE 373 — Scrollbar limpia (WebKit)
========================================================= -->
<style>
  :root{
    scrollbar-color: #cfd6df #f4f6fa;
  }
  *::-webkit-scrollbar{ height:10px; width:10px }
  *::-webkit-scrollbar-thumb{ background:#cfd6df; border-radius:10px; border:2px solid #f4f6fa }
  *::-webkit-scrollbar-track{ background:#f4f6fa }
</style>

<!-- =========================================================
BLOQUE 374 — Botones: estados :active más sutiles
========================================================= -->
<style>
  .btn-cdl:active{ transform: translateY(1px); filter:saturate(.96) }
  .btn-secondary:active{ transform: translateY(1px) }
</style>

<!-- =========================================================
BLOQUE 375 — Inputs: selección de texto visible
========================================================= -->
<style>
  ::selection{ background: rgba(228,59,59,.2) }
</style>

<!-- =========================================================
BLOQUE 376 — EQ grid: mensaje vacío centrado
========================================================= -->
<style>
  .equipos-grid .empty{ color:#6b7280; padding:24px; text-align:center; border:1px dashed #e5e7eb; border-radius:14px; background:#fff }
</style>
<script>
  (function(){
    const grid = document.getElementById('equiposGrid');
    const old = grid?.innerHTML;
    if(grid && !grid.children.length){
      grid.innerHTML = '<div class="empty">No hay equipos aún.</div>';
    }
  })();
</script>

<!-- =========================================================
BLOQUE 377 — Tabla: encabezados en mayúsculas suaves
========================================================= -->
<style>
  .eq-table th{ text-transform:uppercase; letter-spacing:.04em; font-size:.78rem }
</style>

<!-- =========================================================
BLOQUE 378 — KPI: badges de tendencia (placeholder)
========================================================= -->
<style>
  .kpi .trend{ font-size:.75rem; font-weight:800; padding:.1rem .4rem; border-radius:999px; border:1px solid #e5e7eb; color:#374151 }
</style>

<!-- =========================================================
BLOQUE 379 — Alineación de QR + semáforo en tarjeta
========================================================= -->
<style>
  .eq-actions{ align-items:center }
  .eq-qr{ flex-shrink:0 }
</style>

<!-- =========================================================
BLOQUE 380 — Botonera semáforo: tooltips nativos title mejorados
========================================================= -->
<script>
  (function(){
    const map={ "En marcha":"Sistema funcionando", "Restricciones":"Funcionamiento limitado", "Parada":"Detenido" };
    document.querySelectorAll('.cdl-sem .btn').forEach(b=>{
      if(!b.title && b.dataset.state) b.title = map[b.dataset.state]||b.dataset.state;
    });
  })();
</script>

<!-- =========================================================
BLOQUE 381 — Header: capas z-index calculadas
========================================================= -->
<style>
  :root{ --z-header:1000; --z-panel:1100; --z-backdrop:1090 }
  .cdl-header{ z-index: var(--z-header) }
  .cdl-panel{ z-index: var(--z-panel) }
  .cdl-panel__backdrop{ z-index: var(--z-backdrop) }
</style>

<!-- =========================================================
BLOQUE 382 — Botones pequeños para acciones secundarias
========================================================= -->
<style>
  .btn-xs{ padding:.35rem .6rem; border-radius:10px; font-weight:800; font-size:.85rem; border:1px solid #e5e7eb; background:#fff }
</style>

<!-- =========================================================
BLOQUE 383 — Mejoras de contraste en modo impresión
========================================================= -->
<style>
  @media print{
    .eq-table th{ background:#f0f2f5 !important; -webkit-print-color-adjust:exact }
    .cdl-sem .chip{ border-color:#bbb }
  }
</style>

<!-- =========================================================
BLOQUE 384 — Redondeo consistente
========================================================= -->
<style>
  :root{ --radius-lg:14px; --radius-md:12px; --radius-sm:10px }
  .eq-card, .eq-detail__right, .eq-qr-big, .eq-qr{ border-radius: var(--radius-lg) }
  .evt-form input, .evt-form select, .evt-form textarea, .cdl-panel__search input{ border-radius: var(--radius-md) }
  .cdl-x, .cdl-hamb, .cdl-user__btn{ border-radius: var(--radius-sm) }
</style>

<!-- =========================================================
BLOQUE 385 — Micro-ligaduras tipográficas
========================================================= -->
<style>
  h1,h2,h3,.eq-title, .cdl-user__role{ font-variant-ligatures: contextual common-ligatures }
</style>

<!-- =========================================================
BLOQUE 386 — Tiempos de transición unificados
========================================================= -->
<style>
  :root{ --t-fast:.12s; --t-base:.2s }
  .eq-card, .cdl-panel{ transition-duration: var(--t-base) }
  .cdl-hamb, .cdl-user__btn{ transition: background var(--t-fast) ease, border-color var(--t-fast) ease }
</style>

<!-- =========================================================
BLOQUE 387 — Hints de rendering texto
========================================================= -->
<style>
  html{ text-rendering: optimizeLegibility; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale }
</style>

<!-- =========================================================
BLOQUE 388 — Alineación de h1–h3 con regla roja
========================================================= -->
<style>
  :where(h1,h2,h3){ padding-left:.72rem }
  :where(h1)::before, :where(h2)::before, :where(h3)::before{ top:.14rem }
</style>

<!-- =========================================================
BLOQUE 389 — Footer mínimo corporativo (visual, sin enlazar)
========================================================= -->
<footer class="cdl-container" aria-label="Pie de página" style="margin:18px auto 26px">
  <div class="cdl-divider"></div>
  <p style="color:#6b7280; font-size:.9rem; margin:8px 0 0">© CDL · Área de Mantenimiento · Identidad visual alineada con cdl.es</p>
</footer>
<!-- =========================================================
BLOQUE 390 — Preconnect/Hint de rendimiento adicional
========================================================= -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="dns-prefetch" href="//fonts.gstatic.com">

<!-- =========================================================
BLOQUE 391 — Font: swap visible y fallback seguro
========================================================= -->
<style>
  @font-face{
    font-family:Inter; font-style:normal; font-weight:400; font-display:swap;
    src: local("Inter"), local("Inter Regular");
  }
  body{ font-feature-settings:"liga","kern" }
</style>

<!-- =========================================================
BLOQUE 392 — Layout: evita CLS en cabecera
========================================================= -->
<style>
  #cdlHeader{ min-height: var(--hdr-h) }
  .cdl-logo img{ width:auto; height:28px; display:block }
</style>

<!-- =========================================================
BLOQUE 393 — Hero: contención CSS para pintar menos
========================================================= -->
<style>
  .cdl-hero{ contain: content; content-visibility:auto }
</style>

<!-- =========================================================
BLOQUE 394 — Botón negro: leve degradado sutil
========================================================= -->
<style>
  .btn-cdl[style*="background:#111"]{ background:linear-gradient(#111,#0f0f0f) }
</style>

<!-- =========================================================
BLOQUE 395 — Cabecera: hover de iconos
========================================================= -->
<style>
  .cdl-hamb:hover,.cdl-user__btn:hover{ background:#f8fafc; border-color:#dfe4ea }
</style>

<!-- =========================================================
BLOQUE 396 — Inputs: enfoque interno claro
========================================================= -->
<style>
  .evt-form input:focus,.evt-form select:focus,.evt-form textarea:focus{
    outline:2px solid rgba(228,59,59,.28); outline-offset:2px
  }
</style>

<!-- =========================================================
BLOQUE 397 — Texto secundario tokenizado
========================================================= -->
<style>
  .muted{ color: var(--cdl-muted) }
</style>

<!-- =========================================================
BLOQUE 398 — EQ media: reserva de altura para evitar saltos
========================================================= -->
<style>
  .eq-card__media{ min-height: 140px }
</style>

<!-- =========================================================
BLOQUE 399 — Hover tarjetas: sombra corporativa
========================================================= -->
<style>
  @media(hover:hover){
    .eq-card:hover{ box-shadow: var(--cdl-shadow-md) }
  }
</style>

<!-- =========================================================
BLOQUE 400 — Panel: mejor hit-area de cierre
========================================================= -->
<style>
  #btnClosePanel{ width:40px; height:40px }
</style>

<!-- =========================================================
BLOQUE 401 — Panel: inert cuando está oculto (accesibilidad)
========================================================= -->
<script>
  (function(){
    const p = document.getElementById('pagesPanel'), b = document.getElementById('panelBackdrop');
    if(!p||!b) return;
    const sync=()=>{ const open=p.getAttribute('aria-hidden')==='false'; p.inert=!open; b.hidden=!open; };
    new MutationObserver(sync).observe(p,{attributes:true,attributeFilter:['aria-hidden']}); sync();
  })();
</script>

<!-- =========================================================
BLOQUE 402 — Scroll suave solo si usuario no reduce motion
========================================================= -->
<style>
  html:where(:not(.no-smooth)){ scroll-behavior:smooth }
  @media (prefers-reduced-motion: reduce){ html{ scroll-behavior:auto } }
</style>

<!-- =========================================================
BLOQUE 403 — Títulos: microtracking y altura
========================================================= -->
<style>
  h1,h2,h3{ letter-spacing:.01em; line-height:1.12 }
</style>

<!-- =========================================================
BLOQUE 404 — Breadcrumb mínimo (visual, no funcional)
========================================================= -->
<nav aria-label="Miga de pan" class="cdl-container" style="margin:6px 0 0">
  <small class="muted">CDL › Mantenimiento</small>
</nav>

<!-- =========================================================
BLOQUE 405 — Semáforo: feedback aria-live discreto
========================================================= -->
<div id="stateAnnouncer" aria-live="polite" class="visually-hidden"></div>
<style>
  .visually-hidden{ position:absolute!important; height:1px;width:1px;clip:rect(1px,1px,1px,1px); overflow:hidden; white-space:nowrap }
</style>
<script>
  (function(){
    const an = document.getElementById('stateAnnouncer');
    const orig = window.setEquipoEstado;
    window.setEquipoEstado = async function(cod, est){ 
      const r = orig ? await orig(cod, est) : null; 
      an.textContent = `Equipo ${cod} ahora en ${est}`; 
      return r;
    };
  })();
</script>

<!-- =========================================================
BLOQUE 406 — KPI: rejilla estable en móviles
========================================================= -->
<style>
  @media(max-width:420px){
    .eq-detail__left > div[style*="grid-template-columns:repeat(2"]{ grid-template-columns:1fr 1fr !important }
  }
</style>

<!-- =========================================================
BLOQUE 407 — Tabla: corte de texto largo
========================================================= -->
<style>
  .eq-table td:nth-child(5){ overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
</style>

<!-- =========================================================
BLOQUE 408 — Botones: tamaño mínimo táctil
========================================================= -->
<style>
  button, .btn-cdl, .btn-secondary{ min-height:40px }
</style>

<!-- =========================================================
BLOQUE 409 — Panel: separadores sutiles entre enlaces
========================================================= -->
<style>
  .cdl-panel__nav a{ border:1px solid transparent }
  .cdl-panel__nav a + a{ border-top:1px solid #f3f4f6 }
</style>

<!-- =========================================================
BLOQUE 410 — Hero: sombras coherentes en botones
========================================================= -->
<style>
  .btn-cdl{ box-shadow:0 10px 18px rgba(228,59,59,.18) }
</style>

<!-- =========================================================
BLOQUE 411 — Imágenes/Canvas: DPR aware para nitidez
========================================================= -->
<script>
  (function(){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
    document.querySelectorAll('canvas').forEach(cv=>{
      if(cv.dataset.dprScaled) return;
      const w=cv.width, h=cv.height; cv.width=w*dpr; cv.height=h*dpr; cv.style.width=w+'px'; cv.style.height=h+'px';
      const ctx=cv.getContext('2d'); ctx&&ctx.scale(dpr,dpr); cv.dataset.dprScaled=1;
    });
  })();
</script>

<!-- =========================================================
BLOQUE 412 — QR: cursor e instrucción
========================================================= -->
<style>
  .eq-qr, .eq-qr-big{ cursor:pointer }
  .eq-qr::after, .eq-qr-big::after{ content:""; }
</style>

<!-- =========================================================
BLOQUE 413 — Cabecera: límite de ancho del watermark
========================================================= -->
<style>
  #cdlHeader::after{ background-size: min(280px, 30vw) auto, auto }
</style>

<!-- =========================================================
BLOQUE 414 — Contenedores: margen vertical armonizado
========================================================= -->
<style>
  section.cdl-container + section.cdl-container{ margin-top: 10px }
</style>

<!-- =========================================================
BLOQUE 415 — Grids: gaps uniformes
========================================================= -->
<style>
  .equipos-grid{ gap: 14px }
</style>

<!-- =========================================================
BLOQUE 416 — Links: color activo subrayado
========================================================= -->
<style>
  a:active{ text-decoration:underline }
</style>

<!-- =========================================================
BLOQUE 417 — Botones: sombra al enfocar vía teclado
========================================================= -->
<style>
  .btn-cdl:focus-visible{ box-shadow:0 0 0 4px rgba(228,59,59,.18) }
</style>

<!-- =========================================================
BLOQUE 418 — Tabla: zebra muy suave
========================================================= -->
<style>
  .eq-table tbody tr:nth-child(odd){ background:#fcfdff }
</style>

<!-- =========================================================
BLOQUE 419 — KPI: números tabulares para alineado
========================================================= -->
<style>
  .kpi b, .eq-table td{ font-variant-numeric: tabular-nums }
</style>

<!-- =========================================================
BLOQUE 420 — Botones: espaciado interno consistente
========================================================= -->
<style>
  .btn-cdl, .btn-secondary{ padding:.68rem 1.05rem }
</style>

<!-- =========================================================
BLOQUE 421 — Inputs: compatibilidad iOS (borde)
========================================================= -->
<style>
  input,select,textarea{ -webkit-appearance:none; appearance:none }
</style>

<!-- =========================================================
BLOQUE 422 — Panel: sombra cuando abierto
========================================================= -->
<style>
  .cdl-panel[aria-hidden="false"]{ box-shadow: 8px 0 20px rgba(17,24,39,.08) }
</style>

<!-- =========================================================
BLOQUE 423 — Ficha: separación entre bloques
========================================================= -->
<style>
  #equipoView .cdl-sem{ margin-top:6px }
  #equipoView .kpi{ margin-top:0 }
</style>

<!-- =========================================================
BLOQUE 424 — Títulos: subrayado corporativo opcional
========================================================= -->
<style>
  .cdl-underline{ box-shadow: inset 0 -12px rgba(228,59,59,.16) }
</style>

<!-- =========================================================
BLOQUE 425 — Placeholder de tarjeta “Foto equipo” más fino
========================================================= -->
<style>
  .eq-card__media{ background-color:#f7f8fc }
</style>

<!-- =========================================================
BLOQUE 426 — Cabecera: bloquea selección accidental
========================================================= -->
<style>
  .cdl-header, .cdl-header *{ user-select:none }
</style>

<!-- =========================================================
BLOQUE 427 — Panel: teclado Tab cíclico (trap simple)
========================================================= -->
<script>
  (function(){
    const p=document.getElementById('pagesPanel'); if(!p) return;
    p.addEventListener('keydown',e=>{
      if(p.getAttribute('aria-hidden')==='false' && e.key==='Tab'){
        const f=[...p.querySelectorAll('button,a,input')].filter(x=>!x.disabled);
        if(!f.length) return;
        const first=f[0], last=f[f.length-1];
        if(e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault(); }
        else if(!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault(); }
      }
    });
  })();
</script>

<!-- =========================================================
BLOQUE 428 — Panel: botón cerrar con Escape ya gestionado (pulido)
========================================================= -->
<style>
  #btnClosePanel{ font-size:16px; line-height:1 }
</style>

<!-- =========================================================
BLOQUE 429 — Color de fondo global muy blanco (consistencia)
========================================================= -->
<style>
  html,body{ background:#ffffff }
</style>

<!-- =========================================================
BLOQUE 430 — Botones: transición de sombra
========================================================= -->
<style>
  .btn-cdl{ transition: box-shadow var(--t-base), transform var(--t-fast) }
</style>

<!-- =========================================================
BLOQUE 431 — Eq meta: gris corporativo
========================================================= -->
<style>
  .eq-meta{ color:#6b7280 }
</style>

<!-- =========================================================
BLOQUE 432 — Tarjeta: bordes nítidos en pantallas retina
========================================================= -->
<style>
  .eq-card{ border-color:#e6eaf0 }
</style>

<!-- =========================================================
BLOQUE 433 — Hero: ancho máximo del párrafo para lectura
========================================================= -->
<style>
  .cdl-hero p{ max-width: 62ch }
</style>

<!-- =========================================================
BLOQUE 434 — Tabla: bordes inferiores más claros
========================================================= -->
<style>
  .eq-table th,.eq-table td{ border-bottom:1px solid #eef2f7 }
</style>

<!-- =========================================================
BLOQUE 435 — Formularios: espacio entre campos
========================================================= -->
<style>
  .evt-form{ gap:10px }
</style>

<!-- =========================================================
BLOQUE 436 — Botón “Añadir evento”: estilo secundario negro
========================================================= -->
<style>
  .eq-actions .btn-cdl[style*="background:#111"]{ box-shadow:0 8px 18px rgba(17,24,39,.12) }
</style>

<!-- =========================================================
BLOQUE 437 — Panel: placeholder de búsqueda con zoom
========================================================= -->
<style>
  .cdl-panel__search input{ font-size:16px } /* evita zoom iOS */
</style>

<!-- =========================================================
BLOQUE 438 — Hints de idioma para formateo local
========================================================= -->
<script>
  (function(){ try{ document.documentElement.lang = document.documentElement.lang || 'es'; }catch{} })();
</script>

<!-- =========================================================
BLOQUE 439 — Pie: separación final consistente
========================================================= -->
<style>
  footer.cdl-container{ margin-bottom: 34px }
</style>

<!-- =========================================================
BLOQUE 49 — PWA (ÚNICO): barra “Instalar” + chip red + registro SW
- Reemplaza el antiguo BLOQUE 49
- Elimina cualquier BLOQUE 35 duplicado
========================================================= -->
<div id="pwaBar" class="pwa-bar" hidden>
  <span id="pwaMsg">Esta app funciona sin conexión. ¿Instalar?</span>
  <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
    <button class="btn-cdl" id="pwaInstall">Instalar</button>
    <button class="btn-cdl" id="pwaClose" style="background:#111;">Cerrar</button>
  </div>
</div>

<div id="netChip" class="net-chip" role="status" aria-live="polite" title="Estado de red">● Online</div>

<style>
  .pwa-bar{
    position:fixed;
    left:12px; right:12px;
    bottom: calc(12px + env(safe-area-inset-bottom, 0px));
    display:flex; justify-content:space-between; align-items:center;
    background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:10px 12px;
    z-index:1300; box-shadow:0 10px 30px rgba(0,0,0,.12);
  }
  .net-chip{
    position:fixed;
    right:12px;
    top: calc(12px + env(safe-area-inset-top, 0px));
    background:#fff; border:1px solid #e5e7eb; border-radius:999px;
    padding:.25rem .6rem; font-weight:800; z-index:1300;
  }
  .net-chip.off{ color:#dc2626; border-color:#fecaca; }
  .net-chip.on{  color:#16a34a; border-color:#bbf7d0; }

  /* Asegura que paneles/modales queden por encima si hace falta */
  .user-panel{ z-index:1400; }
</style>

<script>
(function(){
  // --- Toast minimal (se crea dinámicamente para avisos breves)
  function ensureToast(){
    let t = document.getElementById('netToast');
    if(!t){
      t = document.createElement('div');
      t.id='netToast';
      t.style.cssText='position:fixed;left:50%;transform:translateX(-50%);bottom:calc(12px + env(safe-area-inset-bottom,0px));background:#111;color:#fff;padding:.55rem .8rem;border-radius:999px;font-weight:800;z-index:3000;display:none';
      document.body.appendChild(t);
    }
    return t;
  }
  function showToast(msg, ms){
    const t = ensureToast();
    t.textContent = msg;
    t.style.display = 'block';
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>{ t.style.display='none'; }, ms||2400);
  }

  // --- Estado de red (chip + toast)
  const chip = document.getElementById('netChip');
  function updNet(){
    const on = navigator.onLine;
    chip.textContent = `● ${on ? 'Online' : 'Offline'}`;
    chip.classList.toggle('on', on);
    chip.classList.toggle('off', !on);
  }
  window.addEventListener('online',  ()=>{ updNet(); showToast('Conexión restaurada'); });
  window.addEventListener('offline', ()=>{ updNet(); showToast('Estás sin conexión · modo offline'); });
  updNet();

  // --- Registro del Service Worker (único)
  if('serviceWorker' in navigator){
    window.addEventListener('load', async ()=>{
      try{
        const reg = await navigator.serviceWorker.register('./sw.js');

        // Auto-update UX:
        // 1) cuando hay un SW nuevo en "waiting", pedimos activarlo
        function promptUpdate(sw){
          if(!sw) return;
          // solicitamos activación inmediata
          sw.postMessage('skipWaiting');
        }
        if(reg.waiting){ promptUpdate(reg.waiting); }
        reg.addEventListener('updatefound', ()=>{
          const newSW = reg.installing;
          if(!newSW) return;
          newSW.addEventListener('statechange', ()=>{
            if(newSW.state === 'installed' && navigator.serviceWorker.controller){
              // hay una nueva versión lista
              showToast('Actualizando aplicación…', 1800);
              promptUpdate(reg.waiting);
            }
          });
        });

        // 2) cuando el controlador cambia, recargamos 1 vez
        let refreshed = false;
        navigator.serviceWorker.addEventListener('controllerchange', ()=>{
          if(refreshed) return;
          refreshed = true;
          location.reload();
        });

      }catch(e){
        console.warn('SW no registrado:', e);
      }
    });
  }

  // --- Banner A2HS (Add to Home Screen) controlado
  let deferredPrompt = null;
  const bar = document.getElementById('pwaBar');
  const btnInstall = document.getElementById('pwaInstall');
  const btnClose = document.getElementById('pwaClose');

  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault();             // no muestres el banner nativo
    deferredPrompt = e;
    bar.hidden = false;             // mostramos nuestra barra
  });

  btnInstall?.addEventListener('click', async ()=>{
    if(!deferredPrompt) return;
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
    bar.hidden = true;
  });

  btnClose?.addEventListener('click', ()=>{ bar.hidden = true; });

  // --- Evitar solaparse con modales (oculta barra si hay un .user-panel visible)
  const OBS = new MutationObserver(()=>{
    const userPanelVisible = !!document.querySelector('.user-panel:not([hidden])');
    const dialogOpen       = !!document.querySelector('dialog[open], .cdl-modal[open]');
    if(userPanelVisible || dialogOpen) bar.hidden = true;
  });
  OBS.observe(document.body, {subtree:true, attributes:true, attributeFilter:['open','hidden','style']});
})();
</script>
<!-- =========================================================
BLOQUE 438 — FIX: forzar [hidden] a display:none
========================================================= -->
<style>
  [hidden]{ display:none !important; }
</style>

<!-- =========================================================
BLOQUE 439 — Pie: separación final consistente
========================================================= -->
<style>
  footer.cdl-container{ margin-bottom: 34px; }
</style>

<!-- =========================================================
BLOQUE 440 — Backdrop del panel lateral (CSS + JS)
========================================================= -->
<style>
  /* Backdrop base (oculto por defecto) */
  .cdl-panel__backdrop{
    position:fixed; inset:0;
    background:rgba(0,0,0,.28);
    z-index:1090;
    opacity:0;
    pointer-events:none;
    transition:opacity .2s ease;
  }
  .cdl-panel__backdrop:not([hidden]){
    opacity:1;
    pointer-events:auto;
  }
  .cdl-panel[aria-hidden="false"] + .cdl-panel__backdrop{
    opacity:1;
    pointer-events:auto;
  }
</style>

<script>
(function(){
  const panel    = document.getElementById('pagesPanel');
  const openBtn  = document.getElementById('btnMenu');
  const closeBtn = document.getElementById('btnClosePanel');
  const backdrop = document.getElementById('panelBackdrop');

  function open(){
    panel?.setAttribute('aria-hidden','false');
    if(backdrop) backdrop.hidden = false;
    openBtn?.setAttribute('aria-expanded','true');
  }
  function close(){
    panel?.setAttribute('aria-hidden','true');
    if(backdrop) backdrop.hidden = true;
    openBtn?.setAttribute('aria-expanded','false');
  }

  openBtn?.addEventListener('click', open);
  closeBtn?.addEventListener('click', close);
  backdrop?.addEventListener('click', close);
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });

  // Asegura que al cargar, el backdrop quede oculto
  window.addEventListener('load', ()=>{ if(backdrop) backdrop.hidden = true; });
})();
</script>
<!-- =========================================================
BLOQUE 10 — ESTILOS DE IMPRESIÓN + CABECERA + MENÚ FULL + TÍTULOS
+ MIGAS + “PLANTAS” OFF + SHEETS API (compat)
(Reemplaza tu bloque 10 actual y elimina cualquier bloque 70/B duplicado)
========================================================= -->
<style>
  /* ---------- Pulido responsive ---------- */
  main.cdl-container section + section{ margin-top:16px; }

  /* ---------- Cabecera fija (siempre blanca) ---------- */
  #cdlHeader.cdl-header{
    position:sticky; top:0; z-index:1000;
    height:var(--hdr-h,76px);
    background:#fff !important;
    border-bottom:1px solid var(--cdl-line,#e5e7eb);
  }
  #cdlHeader .cdl-header__inner{
    height:inherit; display:flex; align-items:center; justify-content:space-between;
    gap:.75rem; overflow:hidden; /* evita desbordes en móvil */
  }
  /* User area */
  .cdl-user{ display:flex; align-items:center; gap:.5rem; }
  .cdl-user__role{ font-weight:800; color:#111; }
  .cdl-user__btn{ width:42px; height:42px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; color:#111; }

  /* Logo sin recortes */
  .cdl-logo img{
    display:block; height:28px; width:auto;
    object-fit:contain; object-position:left center;
  }

  /* Hamburguesa sin píldora; líneas más juntas */
  .cdl-hamb{ all:unset; display:grid; place-items:center; width:42px; height:42px; cursor:pointer; }
  .cdl-hamb span{ width:18px; height:2px; background:#111; display:block; }
  .cdl-hamb span+span{ margin-top:3px; }

  /* ---------- Menú lateral a pantalla completa ---------- */
  .cdl-panel{
    position:fixed; inset:0; max-width:none; width:100vw; height:100vh;
    background:#0b0f14; color:#fff; border:none; box-shadow:none;
    transform:translateX(-100%); transition:transform .28s cubic-bezier(.2,.8,.2,1);
    z-index:1100;
  }
  .cdl-panel[aria-hidden="false"]{ transform:translateX(0); }

  /* Franja superior blanca con logo + botón cerrar */
  .cdl-panel__top{
    background:#fff; color:#111; height:60px; display:flex; align-items:center;
    justify-content:space-between; padding:0 16px; border-bottom:1px solid #e5e7eb;
  }
  .cdl-panel__top img{ height:26px; width:auto; display:block; }
  .cdl-panel__close{ all:unset; width:40px; height:40px; display:grid; place-items:center;
    font-size:20px; line-height:1; color:#111; cursor:pointer; }

  /* Zona de búsqueda oscura bajo la franja blanca */
  .cdl-panel__search{ padding:12px 16px; border-bottom:1px solid rgba(255,255,255,.06); }
  .cdl-panel__search input{
    width:100%; border-radius:12px; border:1px solid rgba(255,255,255,.18);
    background:transparent; color:#fff; padding:.7rem .9rem; outline:none;
  }
  .cdl-panel__search input::placeholder{ color:rgba(255,255,255,.6); }

  /* Navegación del panel: mayúsculas, blanco, sin subrayado */
  .cdl-panel__nav{ display:grid; gap:.25rem; padding:12px 10px 24px; }
  .cdl-panel__nav a{
    text-decoration:none; text-transform:uppercase; color:#fff;
    font-weight:700; letter-spacing:.02em; padding:.5rem .75rem; border-radius:8px; display:block;
  }
  .cdl-panel__nav a:hover{ background:rgba(255,255,255,.06); }

  /* Backdrop */
  .cdl-panel__backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.28); z-index:1090;
    opacity:0; pointer-events:none; transition:opacity .2s ease;
  }
  .cdl-panel__backdrop:not([hidden]){ opacity:1; pointer-events:auto; }

  /* ---------- Títulos H1/H2/H3 en mayúsculas + angular rojo ---------- */
  h1, h2, h3{ text-transform:uppercase; position:relative; }
  /* Angular arrancando en el 2º tercio */
  h1::before, h2::before, h3::before,
  h1::after,  h2::after,  h3::after{ content:""; position:absolute; left:-14px; background:#E43B3B; }
  h1::before, h2::before, h3::before{ top:33%; width:3px; height:16px; border-radius:2px; }
  h1::after,  h2::after,  h3::after{ top:33%; width:14px; height:3px; border-radius:2px; transform:translateX(-14px); }

  /* ---------- Migas alineadas ---------- */
  .cdl-breadcrumbs, nav[aria-label="breadcrumb"]{ display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
  .cdl-breadcrumbs *{ vertical-align:middle; }

  /* ---------- Print: ficha equipo ---------- */
  @media print{
    header, #cdlHeader, #pagesPanel, #panelBackdrop, .btn-cdl, .cdl-divider, #equiposView { display:none !important; }
    #equipoView{ display:block !important; }
    .eq-detail{ grid-template-columns: 1.2fr .8fr !important; gap:10px; }
    body{ -webkit-print-color-adjust:exact; print-color-adjust:exact; }
  }

  /* Utilidad genérica */
  [hidden]{ display:none !important; }
</style>

<script>
(function(){
  /* =========================================================
  1) SHEETS API (compat con apiSheet.get/post desde HTML)
  Pon tu URL en window.GSCRIPT_URL en cualquier bloque, o aquí:
  ========================================================= */
  window.GSCRIPT_URL = window.GSCRIPT_URL || ''; // <-- si quieres, define aquí tu Web App URL

  async function sheetFetch(path='', {method='GET', data=null}={}){
    if(!window.GSCRIPT_URL){ console.warn('GSCRIPT_URL vacío'); return null; }
    const url = window.GSCRIPT_URL + (path||'');
    const opt = { method, headers:{ 'Content-Type':'application/json' } };
    if(data) opt.body = JSON.stringify(data);
    const res = await fetch(url, opt);
    if(!res.ok) throw new Error('Sheets API error: '+res.status);
    return res.json();
  }
  window.apiSheet = {
    async get(key){ return sheetFetch('?key='+encodeURIComponent(key), {method:'GET'}); },
    async post(key, payload){ return sheetFetch('?key='+encodeURIComponent(key), {method:'POST', data:payload}); }
  };

  /* =========================================================
  2) Ocultar “Todas las plantas” de la cabecera
  ========================================================= */
  window.addEventListener('load', ()=>{
    const pills = Array.from(document.querySelectorAll('button, a, [role="button"], .pill, .chip'))
      .filter(el => /todas\s+las\s+plantas/i.test(el.textContent||''));
    pills.forEach(el => el.remove());
  });

  /* =========================================================
  3) Menú fullscreen: franja blanca + buscador + backdrop + autocierre
  ========================================================= */
  const panel    = document.getElementById('pagesPanel');
  const openBtn  = document.getElementById('btnMenu');
  const closeBtn = document.getElementById('btnClosePanel'); // si ya existe
  let   backdrop = document.getElementById('panelBackdrop');

  function ensurePanelChrome(){
    if(!panel) return;
    // Franja superior blanca con logo + X
    if(!panel.querySelector('.cdl-panel__top')){
      const top = document.createElement('div');
      top.className = 'cdl-panel__top';
      top.innerHTML = `
        <img src="./logo-cdl.png" alt="CDL">
        <button class="cdl-panel__close" aria-label="Cerrar">×</button>`;
      panel.prepend(top);
      top.querySelector('.cdl-panel__close').addEventListener('click', close);
    }
    // Buscador
    if(!panel.querySelector('.cdl-panel__search')){
      const box = document.createElement('div');
      box.className='cdl-panel__search';
      box.innerHTML = `<input type="search" placeholder="Buscar equipo..." id="sideSearch">`;
      const afterTop = panel.querySelector('.cdl-panel__top');
      (afterTop?.nextSibling) ? panel.insertBefore(box, afterTop.nextSibling) : panel.appendChild(box);
    }
    // Backdrop
    if(!backdrop){
      backdrop = document.createElement('div');
      backdrop.id='panelBackdrop'; backdrop.className='cdl-panel__backdrop'; backdrop.hidden=true;
      document.body.appendChild(backdrop);
    }
  }

  function open(){
    ensurePanelChrome();
    panel?.setAttribute('aria-hidden','false');
    if(backdrop) backdrop.hidden = false;
    openBtn?.setAttribute('aria-expanded','true');
  }
  function close(){
    panel?.setAttribute('aria-hidden','true');
    if(backdrop) backdrop.hidden = true;
    openBtn?.setAttribute('aria-expanded','false');
  }

  openBtn?.addEventListener('click', open);
  closeBtn?.addEventListener('click', close);
  backdrop?.addEventListener('click', close);
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
  document.addEventListener('click', (e)=>{
    if(e.target.closest && e.target.closest('.cdl-panel__nav a')) close(); // autocierra al elegir
  });
  window.addEventListener('load', ()=>{ if(backdrop) backdrop.hidden = true; });

  /* =========================================================
  4) Anti-desbordes cabecera en iOS (repaint suave al rotar/zoom)
  ========================================================= */
  let lastW = innerWidth;
  window.addEventListener('resize', ()=>{
    if(Math.abs(innerWidth - lastW) > 1){
      const h = document.getElementById('cdlHeader');
      if(h){
        h.style.setProperty('will-change','transform');
        requestAnimationFrame(()=>h.style.removeProperty('will-change'));
      }
      lastW = innerWidth;
    }
  });
})();
</script>
<!-- =========================================================
BLOQUE 500 — Ajustes cabecera + menú full-screen + títulos + dark
(AÑADIR al final, sin borrar nada)
========================================================= -->
<style>
  /* 1) Cabecera: robustez + no desborde */
  .cdl-header{ position:sticky; top:0; z-index:1000; width:100%; box-sizing:border-box; }
  .cdl-header__inner{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; min-height:var(--hdr-h,72px); }
  /* Logo: que NO se corte */
  .cdl-logo img{ display:block; height:32px; max-width:180px; object-fit:contain; }

  /* 2) Hamburguesa: sin píldora, líneas más juntas */
  .cdl-hamb{ width:42px; height:42px; display:grid; place-items:center; background:transparent !important; border:none !important; border-radius:0 !important; }
  .cdl-hamb span{ display:block; width:18px; height:2px; background:#111; }
  .cdl-hamb span+span{ margin-top:3px; }
  /* Dark */
  .theme-dark .cdl-hamb span{ background:#fff; }

  /* 3) Menú lateral como overlay full-screen */
  aside.cdl-panel{
    position:fixed; inset:0; width:100vw; max-width:none !important;
    background:#000; color:#fff; transform:translateX(-102%);
    transition:transform .28s cubic-bezier(.2,.8,.2,1);
    display:flex; flex-direction:column; z-index:1100; border-right:0 !important;
  }
  .cdl-panel[aria-hidden="false"]{ transform:translateX(0); }
  /* Franja superior blanca con logo + X */
  .cdl-panel .cdl-panel__head{
    background:#fff; color:#111; display:flex; align-items:center; justify-content:space-between;
    padding:12px 16px; border-bottom:1px solid #e5e7eb;
  }
  .cdl-panel .cdl-panel__head img{ height:26px; object-fit:contain; }
  .cdl-x{ width:36px; height:36px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; font-weight:900; }
  /* Cuerpo oscuro: buscador + enlaces */
  .cdl-panel__search{ display:flex; gap:.5rem; padding:12px 16px; border-bottom:1px solid rgba(255,255,255,.06); background:#000; }
  .cdl-panel__search input{
    flex:1; height:40px; border:1px solid rgba(255,255,255,.18); border-radius:10px; padding:0 .7rem;
    background:#0b0b0b; color:#fff; caret-color:#fff;
  }
  .cdl-panel__nav{ display:grid; gap:.2rem; padding:10px 8px; background:#000; }
  .cdl-panel__nav a{
    display:block; padding:.7rem .8rem; border-radius:12px; font-weight:800;
    color:#fff !important; background:transparent; text-decoration:none !important; text-transform:uppercase;
  }
  .cdl-panel__nav a:hover{ background:#111; }
  .cdl-panel__foot{ margin-top:auto; padding:10px 16px; border-top:1px solid rgba(255,255,255,.06); color:#9ca3af; background:#000; }

  /* Backdrop: click-cierre y transición */
  .cdl-panel__backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:1090;
    opacity:0; pointer-events:none; transition:opacity .2s ease;
  }
  .cdl-panel[aria-hidden="false"] + .cdl-panel__backdrop{ opacity:1; pointer-events:auto; }

  /* 4) Títulos en mayúsculas + angular rojo posicionado al 2/3 */
  .cdl-container h1, .cdl-container h2, .cdl-container h3{ text-transform:uppercase; position:relative; }
  /* Decorador tipo “angular rojo CDL” */
  .ttl-cdl{
    --cdl-red:#E43B3B;
    padding-bottom:8px;
    background:
      linear-gradient(135deg, transparent 66%, var(--cdl-red) 66% 100%) 0 100% / 100% 8px no-repeat;
  }

  /* 5) Breadcrumb: alineación y consistencia si existe */
  .breadcrumb, .cdl-breadcrumb{
    display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; line-height:1.2;
  }
  .breadcrumb a, .cdl-breadcrumb a{ color:inherit; text-decoration:none; }
  .breadcrumb .sep, .cdl-breadcrumb .sep{ opacity:.4; }

  /* 6) Ocultar selector de plantas si existe (varias variantes) */
  #plantas, #plantasSel, .plantas-select, [data-role="plantas"]{ display:none !important; }

  /* 7) Modo oscuro: header/roles/btns ya forzados */
  .theme-dark .cdl-header{ background:#0b0f14; border-bottom-color:#111827; }
  .theme-dark .cdl-user__role{ color:#fff; }
  .theme-dark .cdl-user__btn{ background:#0b0f14; border-color:#1f2937; color:#fff; }

  /* 8) Util: cualquier [hidden] de verdad oculto */
  [hidden]{ display:none !important; }
</style>

<script>
(function(){
  // ---------- 0) Helper seguro ----------
  const $  = (s,sc)=> (sc||document).querySelector(s);
  const $$ = (s,sc)=> Array.from((sc||document).querySelectorAll(s));

  // ---------- 1) Logo no recortado ----------
  const logo = document.querySelector('.cdl-logo img');
  if(logo){ logo.removeAttribute('width'); logo.setAttribute('height','32'); logo.style.objectFit='contain'; }

  // ---------- 2) Aplicar decorador angular a H1/H2/H3 existentes ----------
  $$('.cdl-container h1, .cdl-container h2, .cdl-container h3').forEach(h=>{
    if(!h.classList.contains('ttl-cdl')) h.classList.add('ttl-cdl');
  });

  // ---------- 3) Menú: abrir/cerrar, cerrar al navegar / clicar fuera ----------
  const panel    = $('#pagesPanel');
  const openBtn  = $('#btnMenu');
  const closeBtn = $('#btnClosePanel');
  const backdrop = $('#panelBackdrop');

  function open(){ panel?.setAttribute('aria-hidden','false'); if(backdrop) backdrop.hidden=false; openBtn?.setAttribute('aria-expanded','true'); }
  function close(){ panel?.setAttribute('aria-hidden','true'); if(backdrop) backdrop.hidden=true; openBtn?.setAttribute('aria-expanded','false'); }
  openBtn?.addEventListener('click', open);
  closeBtn?.addEventListener('click', close);
  backdrop?.addEventListener('click', close);
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });

  // Cerrar al hacer click en un enlace del menú
  $$('.cdl-panel__nav a', panel).forEach(a=>{
    a.addEventListener('click', ()=>{ close(); });
  });

  // ---------- 4) Dark-mode: asegurar contraste en nav (por si hay clases propias) ----------
  // (Ya reforzado en CSS; esto es por si hay toggle dinámico)
  function ensureMenuContrast(){
    $$('.cdl-panel__nav a', panel).forEach(a=>{
      a.style.color = '#fff';
      a.style.textDecoration = 'none';
      a.style.textTransform = 'uppercase';
    });
  }
  ensureMenuContrast();
  const obs = new MutationObserver(ensureMenuContrast);
  if(panel) obs.observe(panel, {subtree:true, attributes:true, childList:true});

  // ---------- 5) Quitar selector de plantas si existe ----------
  ['#plantas', '#plantasSel', '.plantas-select', '[data-role="plantas"]'].forEach(sel=>{
    $$(sel).forEach(el=> el.remove());
  });

  // ---------- 6) Breadcrumb: alineación básica si existe ----------
  const bc = $('.breadcrumb, .cdl-breadcrumb');
  if(bc){
    bc.style.display='flex';
    bc.style.alignItems='center';
    bc.style.gap='.5rem';
  }
})();
</script>
<!-- =========================================================
BLOQUE 500 — Overrides UI (cabecera blanca, logo sin corte,
hamburguesa full-screen, H1–H3 angular/upper, breadcrumbs alineados,
ocultar Plantas/Áreas, y fixes de overflow)
========================================================= -->
<style>
  /* 1) Cabecera SIEMPRE blanca y sin watermark */
  #cdlHeader{ background:#fff !important; }
  #cdlHeader::after{ content:none !important; } /* adiós logo_mantenimiento + degradado */

  /* 2) Logo cabecera: que no se recorte y mantenga proporción */
  .cdl-logo img{
    display:block;
    max-height: calc(var(--hdr-h, 76px) - 22px);
    height:auto !important; width:auto; /* por si el PNG es más alto */
    object-fit:contain;
    margin:0; padding:4px 0;
  }

  /* 3) Contención de cabecera (evitar “desbordes” visuales) */
  .cdl-header{
    position:sticky; top:0; z-index:1000;
    overflow:clip;              /* recorta cualquier pseudo-elemento/imagen suelta */
    contain:layout paint;       /* aisla la pintura del header */
    -webkit-backdrop-filter:none;
    backdrop-filter:none;
  }

  /* 4) Menú hamburguesa: pantalla completa con tope blanco arriba */
  .cdl-panel{
    inset:0 auto 0 0; width:100vw !important; max-width:none !important;
    transform:translateX(-102%); transition:transform .28s ease;
    background:#000; color:#fff; /* cuerpo del panel en negro */
  }
  .cdl-panel[aria-hidden="false"]{ transform:translateX(0); }
  .cdl-panel__head{
    background:#fff; color:#111;
    border-bottom:1px solid var(--cdl-line);
  }
  .cdl-panel__head img{ filter:none; }
  .cdl-x{ background:#fff; color:#111; border-color:#e5e7eb; }

  /* Franja buscador y navegación en negro con textos blancos */
  .cdl-panel__search{
    background:#000; border-bottom:1px solid #222;
  }
  .cdl-panel__search input{
    background:#111; color:#fff; border:1px solid #333;
  }
  .cdl-panel__nav a{
    color:#fff; border-radius:12px;
  }
  .cdl-panel__nav a:hover{ background:#111; }

  /* Backdrop más opaco para tapar completamente el fondo */
  #panelBackdrop{
    background:rgba(0,0,0,.85) !important;
  }

  /* 5) Titulares: mayúscula + acento “angular” rojo
        - marca diagonal arrancando ~segundo tercio
        - mantiene padding lateral para que no tape el texto */
  :where(h1,h2,h3){
    position:relative; text-transform:uppercase;
    padding-left:2.4rem; margin:1.1rem 0 .8rem;
    line-height:1.125; font-weight:900; letter-spacing:.02em;
  }
  :where(h1,h2,h3)::before{
    content:"";
    position:absolute; left:.35rem; top:66%; /* ~2º tercio */
    width:14px; height:14px; background:var(--cdl-red);
    transform:translateY(-50%) rotate(-45deg);
    border-radius:2px;
    box-shadow:0 0 0 2px #fff inset; /* halo para que “muerda” el papel blanco */
  }

  /* 6) Breadcrumbs siempre alineados */
  .cdl-breadcrumbs{ display:flex; align-items:center; gap:.4rem; }
  .cdl-breadcrumbs > *{ display:inline-flex; align-items:center; }
  .cdl-breadcrumbs span[aria-hidden="true"]{ line-height:1; }

  /* 7) Ocultar UI de multi-PLANTAS/ÁREAS sin tocar datos */
  .ctx-wrap{ display:none !important; }

  /* 8) Tema oscuro: respetar contraste en header y buscador del panel */
  :root[data-theme="dark"] .cdl-header{ background:#0B0F14 !important; }
  :root[data-theme="dark"] .cdl-panel{
    background:#000; color:#fff;
  }
  :root[data-theme="dark"] .cdl-panel__search input{
    background:#0F141B; border-color:#253040; color:#E5E7EB;
  }
</style>

<script>
/* Asegura que el backdrop se muestre/oculte en sync y cubra todo */
(function(){
  const panel = document.getElementById('pagesPanel');
  const openBtn = document.getElementById('btnMenu');
  const closeBtn = document.getElementById('btnClosePanel');
  const backdrop = document.getElementById('panelBackdrop');

  function open(){ panel?.setAttribute('aria-hidden','false'); if(backdrop) backdrop.hidden=false; openBtn?.setAttribute('aria-expanded','true'); }
  function close(){ panel?.setAttribute('aria-hidden','true');  if(backdrop) backdrop.hidden=true;  openBtn?.setAttribute('aria-expanded','false'); }

  openBtn?.addEventListener('click', open);
  closeBtn?.addEventListener('click', close);
  backdrop?.addEventListener('click', close);
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });

  /* Al cargar, deja backdrop oculto para evitar parpadeos */
  window.addEventListener('load', ()=>{ if(backdrop) backdrop.hidden=true; });
})();
</script>
<!-- =========================================================
BLOQUE 500 — FIX CABECERA + MENÚ FULLSCREEN + TITULARES + BREADCRUMBS
(override seguro: no borres nada; este bloque gana por cascada)
========================================================= -->
<style>
  /* 1) CABECERA: quita el watermark que está rompiendo el layout */
  #cdlHeader{ overflow:hidden; }
  #cdlHeader::after{ content:none !important; background:none !important; }

  /* 2) HAMBURGUER: sin píldora, barras más juntas */
  .cdl-hamb{
    width:40px;height:40px;border:none !important;background:transparent !important;border-radius:0 !important;
    display:grid;place-items:center;
  }
  .cdl-hamb span{ width:20px;height:2px;background:#111;display:block; }
  .cdl-hamb span+span{ margin-top:3px; }

  /* 3) MENÚ FULLSCREEN: cubre toda la pantalla, con franja blanca arriba y cuerpo negro */
  .cdl-panel{
    inset:0 !important; left:0; right:auto;
    width:100vw !important; max-width:100vw !important;
    height:100dvh !important; transform:translateX(-102%); transition:transform .28s ease;
    background:#000 !important; color:#fff;
    border-right: none !important;
  }
  .cdl-panel[aria-hidden="false"]{ transform:translateX(0); }

  /* Head (franja blanca con logo CDL a la izq. y X negra a la dcha.) */
  .cdl-panel__head{
    position:sticky; top:env(safe-area-inset-top,0); z-index:1;
    padding:12px 16px; background:#fff !important; border-bottom:1px solid #e5e7eb;
    display:flex; align-items:center; justify-content:space-between;
  }
  .cdl-panel__head img{ height:22px; }
  .cdl-x{ background:#fff !important; color:#111 !important; border:1px solid #e5e7eb; }

  /* Cuerpo negro: buscador y navegación en blanco */
  .cdl-panel__search{ background:#000 !important; border-bottom:1px solid rgba(255,255,255,.08); }
  .cdl-panel__search input{
    flex:1; height:42px; border-radius:10px; border:1px solid rgba(255,255,255,.18);
    background:#111; color:#fff; padding:0 .7rem;
  }
  .cdl-panel__nav{ background:#000; }
  .cdl-panel__nav a{
    color:#fff !important; border-radius:12px; font-weight:800; padding:.8rem .9rem;
  }
  .cdl-panel__nav a:hover{ background:rgba(255,255,255,.06); }

  /* 4) Backdrop único y bloqueo de scroll al abrir */
  .cdl-panel__backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.38); z-index:1090;
    opacity:0; pointer-events:none; transition:opacity .2s ease;
  }
  .cdl-panel[aria-hidden="false"] + .cdl-panel__backdrop{ opacity:1; pointer-events:auto; }
  body.cdl-lock{ overflow:hidden; touch-action:none; }

  /* 5) Quitar la “x” nativa de los inputs de tipo search en iOS */
  input[type="search"]::-webkit-search-cancel-button{ -webkit-appearance: none; appearance:none; }

  /* 6) TITULARES: mayúsculas + “ángulo rojo” arrancando en el segundo tercio */
  :where(h1,h2,h3){
    text-transform:uppercase;
    letter-spacing:.02em; font-weight:900; position:relative; padding-left:0.9rem;
  }
  :where(h1,h2,h3)::before{
    content:""; position:absolute; left:0; top:.12rem; width:18px; height:18px; border-radius:2px;
    /* ángulo rojo (L) que empieza visualmente avanzado */
    background:
      linear-gradient(90deg, var(--cdl-red) 0 100%) 0 0/100% 6px no-repeat,
      linear-gradient(180deg, var(--cdl-red) 0 100%) 0 0/6px 100% no-repeat;
    transform-origin:left top; transform:skew(-10deg) translateX(6px);
  }

  /* 7) Breadcrumbs: alineación y espaciado uniforme */
  .cdl-breadcrumbs{ align-items:center !important; gap:.45rem !important; line-height:1 !important; }
  .cdl-breadcrumbs a{ display:inline-flex; align-items:center; }

  /* 8) Header todavía más seguro en móviles (no se desborda) */
  .cdl-header{ height:var(--hdr-h); background:#fff; border-bottom:1px solid var(--cdl-line); }
  .cdl-header__inner{ max-width:var(--container); margin-inline:auto; padding-inline:16px; }
</style>

<script>
  // Unificar open/close del panel y bloqueo del scroll (evita duplicados previos)
  (function(){
    const panel   = document.getElementById('pagesPanel');
    const openBtn = document.getElementById('btnMenu');
    const closeBtn= document.getElementById('btnClosePanel');
    const backdrop= document.getElementById('panelBackdrop');

    function open(){
      panel?.setAttribute('aria-hidden','false');
      backdrop && (backdrop.hidden = false);
      document.body.classList.add('cdl-lock');
      openBtn?.setAttribute('aria-expanded','true');
    }
    function close(){
      panel?.setAttribute('aria-hidden','true');
      backdrop && (backdrop.hidden = true);
      document.body.classList.remove('cdl-lock');
      openBtn?.setAttribute('aria-expanded','false');
    }
    openBtn?.addEventListener('click', open);
    closeBtn?.addEventListener('click', close);
    backdrop?.addEventListener('click', close);
    window.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });

    // Asegurar estado inicial
    window.addEventListener('load', ()=>{ backdrop && (backdrop.hidden = true); panel?.setAttribute('aria-hidden','true'); });
  })();
</script>
</body>
</html>