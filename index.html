<!-- ====== BLOQUE 1.1 (HEAD + APERTURA BODY + CABECERA) ====== -->
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="format-detection" content="telephone=no">
<title>CDL · CMMS</title>

<!-- PWA -->
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#0c0f14">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CDL · CMMS">
<link rel="icon" sizes="192x192" href="/icon-192.png">
<link rel="icon" sizes="512x512" href="/icon-512.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

<!-- Fuente -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
/* ===== Base visual corporativa (oscuro) ===== */
:root{
  --brand1:#A60000; --brand2:#E43B3B;
  --ok:#16a34a; --warn:#f59e0b; --stop:#dc2626;
  --ink:#e8eef7; --muted:#9aa7b4; --line:#232b36;
  --bg:#0c0f14; --panel:#0b0f15;
  --safe-top: env(safe-area-inset-top,0px);
  --safe-bottom: env(safe-area-inset-bottom,0px);
  --hdr-h: 64px;
}
*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  color:var(--ink); background:var(--bg); -webkit-text-size-adjust:100%;
  padding-top:var(--safe-top); padding-bottom:var(--safe-bottom);
}
.hidden{ display:none !important; }
img,canvas,svg,video{ max-width:100%; height:auto; }

/* Cabecera oscura */
header{ background:var(--panel); border-bottom:1px solid #1f2937; position:sticky; top:0; z-index:2000; }
header .nav{ min-height:64px; display:flex; align-items:center; justify-content:center; position:relative; padding:.35rem .6rem; }
.hero-title .hero-panel{ color:#f3f4f6; font-weight:900; letter-spacing:.04em; }
.hero-logo-cdl{ height:22px; width:auto; display:inline-block; }
.rolechip{ position:absolute; right:12px; top:8px; font-size:.92rem; font-weight:800; color:#f3f4f6; }
.menu button#pagesBtn,
.menu button#userBtn{
  position:absolute; top:10px; width:36px; height:36px; border-radius:8px;
  border:1px solid #2a3342; color:#e5e7eb; background:#111826; cursor:pointer; display:grid; place-items:center;
}
.menu button#pagesBtn{ left:10px; }
.menu button#userBtn{ right:10px; }

/* Panel de menú (cuadro oscuro flotante) */
.panel{
  position:absolute; top:56px; left:10px; background:#0b0f15; color:#e5e7eb;
  border:1px solid #1f2937; border-radius:14px; box-shadow:0 24px 60px rgba(0,0,0,.45);
  padding:.6rem; z-index:2100; max-height:calc(100vh - 80px); overflow:auto;
}
.menu-user .panel{ right:10px; left:auto; width:280px; }
.menu-pages .panel{ width:280px; }
.panel .row{ display:flex; flex-direction:column; gap:.5rem; }
.panel .actions{ display:flex; flex-direction:column; gap:.35rem; }

/* Contenido */
main{ max-width:1200px; margin:0 auto; padding:.8rem .8rem 1.2rem; }
.card{ background:#141a22; border:1px solid var(--line); border-radius:12px; padding:.75rem .9rem; margin:.5rem 0; }
.in-txt, input[type="date"], select{ height:36px; padding:.35rem .55rem; border-radius:10px; border:1px solid #2b3443; background:#0f141b; color:var(--ink); }
.btn{ display:inline-flex; align-items:center; justify-content:center; gap:.4rem; padding:.42rem .72rem; border-radius:999px; border:1px solid #2b3443; background:#0f141b; color:var(--ink); font-weight:800; }
table{ width:100%; border-collapse:collapse; background:#0f141b; border:1px solid var(--line); border-radius:12px; overflow:hidden; }
thead th{ background:#121925; color:#e5e7eb; font-weight:800; text-align:left; border-bottom:1px solid var(--line); padding:.55rem .6rem; }
tbody td{ border-top:1px solid var(--line); padding:.5rem .6rem; }
</style>
</head>
<body>

<header>
  <div class="nav" id="navBar">
    <!-- Menú (hamburguesa) -->
    <div class="menu menu-pages">
      <button id="pagesBtn" aria-label="Menú" aria-expanded="false" aria-controls="pagesPanel">☰</button>
      <div id="pagesPanel" class="panel hidden" aria-label="Menú principal" style="min-width:260px">
        <div class="row">
          <div class="actions">
            <button class="btn" onclick="nav('equipos')">Equipos</button>
            <button class="btn" onclick="nav('gruas')">Puentes Grúa</button>
            <button class="btn" onclick="nav('otros')">Otros</button>
            <button class="btn" onclick="nav('incidencias')">Incidencias</button>
            <button class="btn" onclick="nav('indicadores')">Indicadores</button>
            <button class="btn" onclick="nav('ot')">OT</button>
            <button class="btn" onclick="nav('inventario')">Inventario</button>
            <button class="btn" onclick="nav('repuestos')">Repuestos solicitados</button>
            <button class="btn" onclick="nav('consumibles')">Consumibles</button>
            <button class="btn" onclick="nav('tv')">Dashboard TV</button>
          </div>
        </div>
      </div>
    </div>
<!-- ====== FIN BLOQUE 1.1 ====== -->

<!-- ====== BLOQUE 1.2 (CABECERA: LOGO, ROL, MENÚ USUARIO) ====== -->

    <!-- Título centrado -->
    <div class="hero-title">
      <div class="hero-row">
        <img src="/logo-cdl.png" alt="CDL" class="hero-logo-cdl">
        <span class="hero-panel">PANEL DE CONTROL</span>
      </div>
    </div>

    <!-- Chip de rol y menú usuario -->
    <span id="roleChip" class="rolechip" aria-label="Rol actual">Invitado</span>
    <div class="menu menu-user">
      <button id="userBtn" aria-label="Usuario" aria-expanded="false" aria-controls="userPanel">⋮</button>
      <div id="userPanel" class="panel hidden" aria-label="Panel de usuario">
        <div class="row">
          <label class="small">Usuario</label>
          <select id="userSelect">
            <option value="invitado">Invitado</option>
            <option value="admin">Administrador</option>
            <option value="gerente">Gerente</option>
            <option value="encargado">Encargado</option>
            <option value="produccion">Producción</option>
            <option value="rt11">RT1.1</option>
            <option value="rt12">RT1.2</option>
            <option value="rt21">RT2.1</option>
            <option value="rt22">RT2.2</option>
            <option value="rt31">RT3.1</option>
            <option value="rt32">RT3.2</option>
            <option value="tcoint">Tco.INT</option>
            <option value="subc">Subcontrata</option>
          </select>

          <label class="small" style="margin-top:.4rem">Contraseña</label>
          <div class="pw" style="display:flex;gap:.4rem;align-items:center">
            <input id="userPass" type="password" placeholder="••••••••" style="flex:1">
            <button type="button" class="pw-toggle" data-target="userPass" aria-label="Mostrar contraseña" aria-pressed="false"></button>
          </div>

          <div class="actions" style="margin-top:.6rem;display:flex;gap:.4rem;flex-wrap:wrap">
            <button class="btn gloss" onclick="login()">Entrar</button>
            <button class="btn gloss" onclick="logout()">Salir</button>
          </div>
        </div>

        <div class="row" style="margin-top:.8rem">
          <label class="small">Cambiar contraseña</label>
          <div class="pw" style="display:flex;gap:.4rem;align-items:center">
            <input id="oldPass" type="password" placeholder="Actual" style="flex:1">
            <button type="button" class="pw-toggle" data-target="oldPass" aria-label="Mostrar contraseña" aria-pressed="false"></button>
          </div>
          <div class="pw" style="margin-top:.4rem;display:flex;gap:.4rem;align-items:center">
            <input id="newPass" type="password" placeholder="Nueva" style="flex:1">
            <button type="button" class="pw-toggle" data-target="newPass" aria-label="Mostrar contraseña" aria-pressed="false"></button>
          </div>
          <div class="actions" style="margin-top:.6rem">
            <button class="btn gloss" onclick="changePwd()">Cambiar</button>
          </div>
          <div id="pwdMsg" class="small" style="margin-top:.4rem;color:#374151"></div>
        </div>
      </div>
    </div>
  </div>
</header>
<!-- ====== FIN BLOQUE 1.2 ====== --> <!-- ====== BLOQUE 1.3 (STATUS STRIP + SECCIONES PRINCIPALES) ====== -->

<main>

  <!-- Resumen alto impacto (totales y última actualización) -->
  <section id="status-strip" style="background:#0b0f15;color:#e5e7eb;border-bottom:1px solid #1f2937">
    <div style="max-width:1200px;margin:0 auto;padding:.55rem .8rem;display:flex;gap:.8rem;align-items:center;flex-wrap:wrap">
      <div style="font-weight:900;letter-spacing:.02em">RESUMEN</div>
      <div style="display:flex;gap:.6rem;flex-wrap:wrap;align-items:center">
        <span id="sumStop" style="display:inline-flex;align-items:center;gap:.4rem;padding:.22rem .5rem;border-radius:999px;border:1px solid #7f1d1d;background:#1b0b0b;font-weight:800">
          <span style="width:10px;height:10px;border-radius:50%;background:#dc2626;display:inline-block"></span>
          <span>Paradas:</span><b id="kStop">0</b>
        </span>
        <span id="sumWarn" style="display:inline-flex;align-items:center;gap:.4rem;padding:.22rem .5rem;border-radius:999px;border:1px solid #854d0e;background:#1b1404;font-weight:800">
          <span style="width:10px;height:10px;border-radius:50%;background:#f59e0b;display:inline-block"></span>
          <span>Restricciones:</span><b id="kWarn">0</b>
        </span>
        <span id="sumOk" style="display:inline-flex;align-items:center;gap:.4rem;padding:.22rem .5rem;border-radius:999px;border:1px solid #14532d;background:#0a1b12;font-weight:800">
          <span style="width:10px;height:10px;border-radius:50%;background:#16a34a;display:inline-block"></span>
          <span>En marcha:</span><b id="kOk">0</b>
        </span>
        <span id="sumAll" style="display:inline-flex;align-items:center;gap:.4rem;padding:.22rem .5rem;border-radius:999px;border:1px solid #334155;background:#0b1220;font-weight:800">
          <span>Total:</span><b id="kAll">0</b>
        </span>
      </div>
      <div style="margin-left:auto;font-weight:700;color:#94a3b8">Última actualización: <span id="kUpdated">—</span></div>
    </div>
  </section>

  <!-- ====== SECCIONES ====== -->

  <section id="page-equipos">
    <h2 class="cdl-tag">Equipos</h2>
    <div class="brand-wrap">
      <img src="/linea-kaltenbach.png" alt="LÍNEA KALTENBACH"
           loading="lazy" decoding="async" fetchpriority="low"
           onerror="this.closest('.brand-wrap').classList.add('fallback'); this.remove();">
    </div>

    <!-- Leyenda local para esta vista -->
    <div id="legend-equipos" style="display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;margin:.5rem 0">
      <span style="display:inline-flex;align-items:center;gap:.4rem"><span style="width:10px;height:10px;border-radius:50%;background:#dc2626;display:inline-block"></span>Parada</span>
      <span style="display:inline-flex;align-items:center;gap:.4rem"><span style="width:10px;height:10px;border-radius:50%;background:#f59e0b;display:inline-block"></span>Restricciones</span>
      <span style="display:inline-flex;align-items:center;gap:.4rem"><span style="width:10px;height:10px;border-radius:50%;background:#16a34a;display:inline-block"></span>En marcha</span>
      <span style="margin-left:auto;display:flex;gap:.4rem;flex-wrap:wrap">
        <button id="btnShowCritical" class="btn gloss">Ver solo críticas</button>
        <button id="btnResetFilters" class="btn gloss">Ver todo</button>
      </span>
    </div>

    <div id="equiposWrap"></div>

    <div class="right" style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
      <button id="btnExportIncidCSVTop" class="btn gloss">Incidencias CSV</button>
      <button id="btnExportIncidPDFTop" class="btn gloss">Incidencias PDF</button>
    </div>
  </section>

  <section id="page-gruas" class="hidden">
    <h2 class="cdl-tag">Puentes Grúa</h2>
    <div id="gruasWrap"></div>
  </section>

  <section id="page-otros" class="hidden">
    <h2 class="cdl-tag">Otros (auxiliares)</h2>
    <div id="otrosWrap"></div>
  </section>

  <!-- 🔹 NUEVAS SECCIONES DE DETALLE (usadas por el router #/equipo/:slug y #/repuesto/:ref) -->
  <section id="page-equipo" class="hidden">
    <div id="equipoDetail"></div>
  </section>

  <section id="page-repuesto" class="hidden">
    <div id="repuestoDetail"></div>
  </section>

  <!-- Inventario -->
  <section id="page-inv" class="hidden">
    <h2 class="cdl-tag">Inventario</h2>

    <div style="margin:.5rem 0;display:flex;flex-wrap:wrap;gap:.5rem">
      <input id="invRef" placeholder="Referencia" class="in-txt">
      <input id="invNombre" placeholder="Nombre" class="in-txt">
      <input id="invStock" type="number" placeholder="Stock" class="in-txt" style="width:90px">
      <input id="invMin" type="number" placeholder="Mínimo" class="in-txt" style="width:90px">
      <button id="btnAddInv" class="btn gloss">Añadir</button>
    </div>

    <div id="invWrap"></div>

    <!-- 🔸 Botón de exportación que ya usan los scripts -->
    <div class="right" style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
      <button id="btnExportInvCSV" class="btn gloss">Exportar CSV</button>
    </div>
  </section>

  <!-- Repuestos solicitados -->
  <section id="page-rep" class="hidden">
    <h2 class="cdl-tag">Repuestos solicitados</h2>

    <div style="margin:.5rem 0;display:flex;flex-wrap:wrap;gap:.5rem">
      <input id="repRef" placeholder="Referencia" class="in-txt">
      <input id="repNombre" placeholder="Nombre repuesto" class="in-txt">
      <button id="btnAddRep" class="btn gloss">Solicitar</button>
    </div>

    <div id="repWrap"></div>

    <div class="right" style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
      <button id="btnExportRepCSV" class="btn gloss">Exportar CSV</button>
      <button id="btnExportRepPDF" class="btn gloss">Exportar PDF</button>
    </div>
  </section>

  <!-- Consumibles -->
  <section id="page-cons" class="hidden">
    <h2 class="cdl-tag">Consumibles recurrentes</h2>

    <div style="margin:.5rem 0;display:flex;flex-wrap:wrap;gap:.5rem">
      <input id="consRef" placeholder="Referencia" class="in-txt">
      <input id="consNombre" placeholder="Nombre consumible" class="in-txt">
      <input id="consStock" type="number" placeholder="Stock" class="in-txt" style="width:90px">
      <input id="consMin" type="number" placeholder="Mínimo" class="in-txt" style="width:90px">
      <button id="btnAddCons" class="btn gloss">Añadir</button>
    </div>

    <div id="consWrap"></div>

    <!-- 🔸 Botón de exportación que ya usan los scripts -->
    <div class="right" style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
      <button id="btnExportConsCSV" class="btn gloss">Exportar CSV</button>
    </div>
  </section>

  <!-- Órdenes de trabajo -->
  <section id="page-ot" class="hidden">
    <h2 class="cdl-tag">Órdenes de trabajo</h2>

    <div style="margin:.5rem 0;display:flex;flex-wrap:wrap;gap:.5rem">
      <input id="otEquipo" placeholder="Equipo" class="in-txt">
      <input id="otTitulo" placeholder="Título" class="in-txt">
      <input id="otVencimiento" type="date" class="in-txt">
      <select id="otPrioridad" class="in-txt">
        <option value="A">Alta</option>
        <option value="M">Media</option>
        <option value="B">Baja</option>
      </select>
      <button id="btnAddOT" class="btn gloss">Crear OT</button>
    </div>

    <div id="otWrap"></div>
    <!-- Nota: el botón Exportar PDF de OT lo inserta dinámicamente renderOTTable() -->
  </section>

  <!-- Personal -->
  <section id="page-personal" class="hidden">
    <h2 class="cdl-tag">Personal</h2>
    <div id="personalWrap"></div>
  </section>

  <!-- Logs -->
  <section id="page-logs" class="hidden">
    <h2 class="cdl-tag">Histórico de logs</h2>
    <div id="logsWrap"></div>
  </section>

  <!-- Incidencias -->
  <section id="page-incidencias" class="hidden">
    <h2 class="cdl-tag">Incidencias</h2>

    <div style="margin:.5rem 0;display:flex;flex-wrap:wrap;gap:.5rem">
      <input id="incidEquipo" placeholder="Equipo" class="in-txt">
      <input id="incidTipo" placeholder="Tipo" class="in-txt">
      <input id="incidDesc" placeholder="Descripción" class="in-txt" style="flex:1">
      <button id="btnAddIncid" class="btn gloss">Añadir</button>
    </div>

    <div id="incidTableWrap"></div>

    <div class="right" style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
      <button id="btnExportIncidCSV" class="btn gloss">Exportar CSV</button>
      <button id="btnExportIncidPDF" class="btn gloss">Exportar PDF</button>
    </div>
  </section>

  <!-- Indicadores -->
  <section id="page-indicadores" class="hidden">
    <h2 class="cdl-tag">Indicadores</h2>

    <div class="kpi-grid">
      <div class="kpi-card">
        <h3>MTTR</h3>
        <canvas id="chartMttr" aria-label="MTTR (Tiempo medio de reparación)" width="320" height="180"></canvas>
        <div><b id="kpiMttrG">0.00</b> h</div>
      </div>
      <div class="kpi-card">
        <h3>MTBF</h3>
        <canvas id="chartMtbf" aria-label="MTBF (Tiempo medio entre fallos)" width="320" height="180"></canvas>
        <div><b id="kpiMbfG">0.00</b> h</div>
      </div>
      <div class="kpi-card">
        <h3>Disponibilidad</h3>
        <canvas id="chartDisp" aria-label="Disponibilidad de equipos" width="320" height="180"></canvas>
        <div><b id="kpiDispG">0.00</b> %</div>
      </div>
      <div class="kpi-card">
        <h3>OEE</h3>
        <canvas id="chartOee" aria-label="Eficiencia global de equipos (OEE)" width="320" height="180"></canvas>
        <div><b id="kpiOeeG">0.00</b> %</div>
      </div>
    </div>
  </section>

  <!-- Dashboard TV -->
  <section id="page-tv" class="hidden">
    <h2 class="cdl-tag">Dashboard TV</h2>

    <div style="display:flex;flex-direction:column;gap:1rem;max-width:800px;margin:0 auto">
      <div>
        <h3>Equipos Parados</h3>
        <div id="tvParados" class="tv-list"></div>
      </div>
      <div>
        <h3>Equipos con Restricciones</h3>
        <div id="tvRestr" class="tv-list"></div>
      </div>
      <div>
        <h3>Stock Crítico</h3>
        <div id="tvStock" class="tv-list"></div>
      </div>
    </div>
  </section>

</main>
<!-- ====== FIN BLOQUE 1.3 ====== -->
<!-- ========== BLOQUE 1.4 (INICIO) ========== -->
<style>
/* Chip de rol visible y limpio */
.rolechip{
  position:absolute; right:12px; top:8px;
  font-size:.92rem; font-weight:800; color:#f3f4f6; background:transparent; border:0; padding:0;
}

/* Título centrado y alineado a logo CDL */
.hero-title{ display:flex; align-items:center; justify-content:center; }
.hero-title .hero-row{ display:flex; align-items:center; gap:10px; white-space:nowrap; }
.hero-title .hero-panel{ font-weight:800; letter-spacing:.02em; color:#f3f4f6; }
.hero-logo-cdl{ height:22px; width:auto; display:inline-block; }

/* Panel menús en pantalla completa */
html.menu-open,body.menu-open{ overflow:hidden; }
.panel.menu-full{
  position:fixed !important; z-index:2400 !important;
  inset: calc(var(--safe-top) + var(--hdr-h)) 0 var(--safe-bottom) 0 !important;
  background:#0b0f15 !important;
  background-image:linear-gradient(180deg,#0b0f15,#121820 60%,#0b0f15) !important;
}
.panel.menu-full::before{
  content:""; position:absolute; inset:0;
  background: radial-gradient(1200px 600px at 50% -10%, rgba(255,255,255,.06), transparent 60%);
  pointer-events:none;
}
#pagesPanel.menu-full .actions{
  width:min(560px,92vw); margin:0 auto !important;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:0; height:100%;
}
#pagesPanel.menu-full .btn{
  background:none!important; border:0!important; box-shadow:none!important;
  color:#fff!important; font-weight:900; text-transform:uppercase; letter-spacing:.06em;
  font-size:clamp(18px,3vh,28px); padding:1.05rem 0; text-align:center; position:relative; cursor:pointer;
}
#pagesPanel.menu-full .btn + .btn::before{
  content:""; position:absolute; top:0; left:0; right:0; height:1px; opacity:.85;
  background:radial-gradient(circle at 50% 50%, rgba(255,255,255,.9) 0%, rgba(255,255,255,.4) 35%, rgba(255,255,255,0) 100%);
}
</style>
<!-- ========== BLOQUE 1.4 (FIN) ========== -->


<!-- ========== BLOQUE 1.5 (INICIO) ========== -->
<style>
/* Botones genéricos */
.btn.gloss{
  display:inline-flex; align-items:center; gap:.5rem;
  padding:.34rem .62rem; border-radius:999px; border:1px solid #cbd5e1;
  background:linear-gradient(180deg,#fdfdfd,#dfe3eb); color:#111; font-weight:800;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.9),0 4px 12px rgba(0,0,0,.12); cursor:pointer;
}
.btn.gloss.btn-mail{
  color:#fff!important; background:linear-gradient(180deg,#ff5a5a,#c10f0f)!important; border-color:#9f0c0c!important;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.9),0 8px 18px rgba(178,15,15,.35)!important;
}
.btn.gloss.btn-ficha{
  background:linear-gradient(180deg,#111,#222)!important; color:#fff!important; border-color:#000!important;
}

/* Sombra cabecera al hacer scroll */
header.scrolled{ box-shadow:0 4px 10px rgba(0,0,0,.18); }

/* Ojo (mostrar/ocultar contraseña) bien visible */
.pw-toggle{
  width:32px; height:32px; border-radius:8px; border:1px solid #cbd5e1; background:#fff; cursor:pointer;
  background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%236b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>');
  background-repeat:no-repeat; background-position:center;
}
.pw-toggle.on{
  background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%23ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8a19.77 19.77 0 0 1 5.06-5.94M9.9 4.24A10.94 10.94 0 0 1 12 4c7 0 11 8 11 8a19.8 19.8 0 0 1-4.22 5.02M1 1l22 22"/><path d="M14.12 14.12A3 3 0 0 1 9.88 9.88"/></svg>');
}

/* Ajuste responsive del logo cabecera */
@media (max-width: 420px){
  .hero-logo-cdl{ height:18px; }
}
</style>
<!-- ========== BLOQUE 1.5 (FIN) ========== -->
<script>
/* ========== BLOQUE 4.1 (INICIO) ========== */
/* ====== BOOT ====== */
const API_BASE = "https://script.google.com/macros/s/AKfycbzPxPJztSCo7dX-xmzYW_pBwkQne3aACe1EzzlNDsjr0nuRXZaOSOrRGzVrYZsN5cgF/exec";

function byId(id){ return document.getElementById(id); }
function show(id){ byId(id)?.classList.remove("hidden"); }
function hide(id){ byId(id)?.classList.add("hidden"); }
function toggle(id){ byId(id)?.classList.toggle("hidden"); }

function qs(sel){ return document.querySelector(sel); }
function qsa(sel){ return [...document.querySelectorAll(sel)]; }
function esc(str){ return String(str).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

function getCID(){ return localStorage.getItem("CDL_CID") || ""; }
function setCID(v){ localStorage.setItem("CDL_CID",v); }

let USER = { user:"invitado", rol:"Invitado", group:"guest" };
function setUser(u){ USER=u; localStorage.setItem("CDL_USER",JSON.stringify(u)); applyRoleUI(); }
function getUser(){ try{return JSON.parse(localStorage.getItem("CDL_USER")||"{}");}catch(_){return USER;} }
USER=getUser()||USER;
/* ========== BLOQUE 4.1 (FIN) ========== */
/* ========== BLOQUE 4.2 (INICIO) ========== */
async function apiGet(q){
  const u=new URL(API_BASE);
  Object.entries(q).forEach(([k,v])=>u.searchParams.set(k,v));
  const r=await fetch(u);
  return await r.json();
}

async function apiPost(q){
  const r=await fetch(API_BASE,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(q)
  });
  return await r.json();
}

function fmtDate(d){
  if(!d)return"";
  const dt=new Date(d);
  if(isNaN(dt))return d;
  return dt.toLocaleString("es-ES",{hour12:false});
}

function copyText(txt){
  navigator.clipboard.writeText(txt)
    .then(()=>toast("Copiado"))
    .catch(()=>alert("No se pudo copiar"));
}

function applyRoleUI(){
  qsa("[data-role]").forEach(el=>{
    const roles=(el.getAttribute("data-role")||"").split(",");
    if(roles.includes(USER.rol)||USER.rol==="Administrador"){
      el.style.display="";
    }else{
      el.style.display="none";
    }
  });
  byId("roleChip").textContent = USER.rol;  // 🔹 corregido
}
/* ========== BLOQUE 4.2 (FIN) ========== */
/* ========== BLOQUE 4.3 (INICIO) ========== */
function renderState(items){
  const wrap=byId("stateWrap");
  if(!wrap)return;
  wrap.innerHTML="";
  if(!items||!items.length){ wrap.textContent="Sin datos"; return; }

  const groups={};
  items.forEach(it=>{
    if(!groups[it.grupo])groups[it.grupo]=[];
    groups[it.grupo].push(it);
  });

  Object.keys(groups).forEach(g=>{
    const sec=document.createElement("section");
    const h=document.createElement("h3");
    h.textContent=g;
    sec.appendChild(h);

    groups[g].forEach(it=>{
      const d=document.createElement("div");
      d.className="card";
      d.innerHTML=`<div><b>${esc(it.nombre)}</b><br>
      Estado: <span class="${it.estado.toLowerCase()}">${esc(it.estado)}</span><br>
      Actualizado: ${fmtDate(it.updated)}</div>`;
      sec.appendChild(d);
    });
    wrap.appendChild(sec);
  });
}
/* ========== BLOQUE 4.3 (FIN) ========== */
/* ========== BLOQUE 5.1 (INICIO) ========== */
/* KPIs y minigráficas (placeholder sin libs externas) */
(function(){
  const notify = (window.toast || window.showToast || (m=>console.log(m)));

  if (typeof calcKPIs === "undefined"){
    window.calcKPIs = function(){
      try{
        const data = (window.INCID || []);
        const totalRep = data.reduce((a,x)=>a + (+x.hRep||0), 0);
        const nRep = data.length || 1;
        const mttr = totalRep / nRep;

        const setTxt = (id,v)=>{ const n=document.getElementById(id); if(n) n.textContent=String(v); };
        const fmt = (n)=> (Math.round((+n||0)*100)/100).toFixed(2);

        setTxt("kpiMttrG", fmt(mttr));
        setTxt("kpiMbfG", "0.00");
        setTxt("kpiDispG","0.00");
        setTxt("kpiOeeG", "0.00");
      }catch(e){ console.error(e); }
    };
  }

  if (typeof drawAllCharts === "undefined"){
    window.drawAllCharts = function(){
      ["chartMttr","chartMtbf","chartDisp","chartOee"].forEach(id=>{
        const c = document.getElementById(id); if(!c) return;
        const ctx = c.getContext("2d");
        ctx.clearRect(0,0,c.width,c.height);
        ctx.fillStyle = "#0f141c";
        ctx.fillRect(0,0,c.width,c.height);
        ctx.fillStyle = "#e5e7eb";
        ctx.font = "16px Inter, Arial, sans-serif";
        ctx.fillText(c.getAttribute("aria-label")||"", 12, 22);
      });
      notify("KPIs dibujados");
    };
  }
})();
/* ========== BLOQUE 5.1 (FIN) ========== */

/* ========== BLOQUE 5.2 (INICIO) ========== */
/* Router por hash + utilidades de navegación */
(function(){
  if (typeof window.handleHash === "undefined"){
    window.handleHash = function(){
      const h = location.hash || "";
      if (!h){ window.nav && nav("equipos"); return; }

      const mEq = h.match(/^#\/equipo\/(.+)$/);
      const mRp = h.match(/^#\/repuesto\/(.+)$/);

      if (mEq && window.renderEquipoBySlug){ renderEquipoBySlug(mEq[1]); return; }
      if (mRp && window.renderRepuestoByRef){ const ref = decodeURIComponent(mRp[1]||""); renderRepuestoByRef(ref); return; }

      const p = h.replace(/^#\/?/,"");
      const pages = ["equipos","gruas","otros","incidencias","indicadores","ot","inventario","repuestos","consumibles","tv"];
      if (pages.includes(p) && window.nav){ nav(p); return; }

      window.nav && nav("equipos");
    };
    window.addEventListener("hashchange", window.handleHash);
  }

  // Actualización del sello de tiempo del resumen
  if (typeof window.updateSummaryTimestamp === "undefined"){
    window.updateSummaryTimestamp = function(){
      const d = new Date();
      const el = document.getElementById("kUpdated");
      if (el) el.textContent = d.toLocaleString("es-ES",{hour12:false});
    };
    setInterval(window.updateSummaryTimestamp, 30*1000);
    window.updateSummaryTimestamp();
  }
})();
/* ========== BLOQUE 5.2 (FIN) ========== */

/* ========== BLOQUE 5.3 (INICIO) ========== */
/* Utilidades de exportación y ventana de impresión (con guardas) */
(function(){
  if (typeof window.csvEscape === "undefined"){
    window.csvEscape = function(v){
      v = (v==null?'':String(v));
      if (/[",\n;]/.test(v)) return `"${v.replace(/"/g,'""')}"`;
      return v;
    };
  }

  if (typeof window.toCSV === "undefined"){
    window.toCSV = function(rows){ return rows.map(r => r.map(window.csvEscape).join(";")).join("\n"); };
  }

  if (typeof window.download === "undefined"){
    window.download = function(name, content, type="text/plain"){
      const blob = new Blob([content], {type});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = name;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    };
  }

  if (typeof window.exportCSVFromTable === "undefined"){
    window.exportCSVFromTable = function(tableSel, fileName){
      const table = document.querySelector(tableSel); if(!table) return;
      const rows = [...table.querySelectorAll("tr")]
        .map(tr => [...tr.children].map(td => td.innerText.trim()));
      window.download(fileName, window.toCSV(rows), "text/csv;charset=utf-8");
    };
  }

  if (typeof window.exportSimpleCSV === "undefined"){
    window.exportSimpleCSV = function(name, headers, items, pick){
      const rows = [headers].concat(items.map(pick));
      window.download(name, window.toCSV(rows), "text/csv;charset=utf-8");
    };
  }

  if (typeof window.printHTML === "undefined"){
    window.printHTML = function(title, html){
      const w = window.open("", "_blank");
      w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>${title}</title><style>
        body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:16px}
        table{width:100%;border-collapse:collapse}
        th,td{border:1px solid #ddd;padding:6px 8px}
        th{background:#f3f4f6}
      </style></head><body>${html}</body></html>`);
      w.document.close(); w.focus(); w.print();
    };
  }
})();

/* ========== BLOQUE 5.3 (FIN) ========== */
/* ========== BLOQUE 5.4 (INICIO) ========== */
/* TV Dashboard (renderizado periódico) */
(function(){
  if (typeof window.renderTV === "undefined"){
    window.renderTV = function(){
      try{
        const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
        const STATE = (window.STATE||[]);
        const INV   = (window.INV||[]);
        const par = STATE.filter(x=>x.estado==="Parada").map(x=>x.nombre);
        const wrn = STATE.filter(x=>x.estado==="Restricciones").map(x=>x.nombre);
        const low = INV.filter(x=>(x.stock||0)<=(x.minimo||0)).map(x=>`${x.ref} (${x.stock}/${x.minimo})`);
        const fill = (id,arr)=>{
          const el = document.getElementById(id); if(!el) return;
          el.innerHTML = arr.length ? arr.map(n=>`<div class="tv-item">${esc(n)}</div>`).join("") : `<div class="tv-item" style="opacity:.6">—</div>`;
        };
        fill("tvParados", par);
        fill("tvRestr",  wrn);
        fill("tvStock",  low);
      }catch(e){ console.error(e); }
    };
  }
  if (typeof window.initTV === "undefined"){
    let TV_TIMER = null;
    window.initTV = function(){
      if (TV_TIMER) clearInterval(TV_TIMER);
      window.renderTV && renderTV();
      TV_TIMER = setInterval(()=>{ window.renderTV && renderTV(); }, 10000);
    };
  }
})();
/* ========== BLOQUE 5.4 (FIN) ========== */

/* ========== BLOQUE 5.5 (INICIO) ========== */
/* Bind de UI principal + arranque (DOMContentLoaded) */
(function(){
  if (typeof window.bindUI === "undefined"){
    window.bindUI = function(){
      // Sello de tiempo (con guarda para no duplicar timers)
      if (typeof window.updateSummaryTimestamp === "function"){
        if (!window.__TS_TIMER__){
          window.__TS_TIMER__ = setInterval(window.updateSummaryTimestamp, 30*1000);
        }
        window.updateSummaryTimestamp();
      }

      const byId=(id)=>document.getElementById(id);

      // (INCIDENCIAS) 👉 Eliminado aquí, lo gestiona el BLOQUE 5.5.x compartido

      // Export Inventario
      byId("btnExportInvCSV")?.addEventListener("click",()=>{
        if(!exportSimpleCSV)return;
        const INV=(window.INV||[]);
        exportSimpleCSV("inventario.csv",
          ["Ref","Nombre","Stock","Mínimo"],
          INV,
          x=>[x.ref,x.nombre,x.stock,x.minimo]);
      });

      // Export Consumibles
      byId("btnExportConsCSV")?.addEventListener("click",()=>{
        if(!exportSimpleCSV)return;
        const CONS=(window.CONS||[]);
        const fmtDate=(d)=> new Date(d).toLocaleString("es-ES",{hour12:false});
        exportSimpleCSV("consumibles.csv",
          ["Ref","Nombre","Stock","Mínimo","Actualizado"],
          CONS,
          x=>[x.ref,x.nombre,x.stock,x.minimo,x.updated?fmtDate(x.updated):""]);
      });

      // Export Repuestos solicitados
      byId("btnExportRepCSV")?.addEventListener("click",()=>{
        if(!exportSimpleCSV)return;
        const REP=(window.REP||[]);
        exportSimpleCSV("repuestos.csv",
          ["ID","Ref","Nombre","Solicitante","Estado"],
          REP,
          x=>[x.id,x.ref,x.nombre,x.solicitante||"",x.estado||""]);
      });
      byId("btnExportRepPDF")?.addEventListener("click",()=>{
        const REP=(window.REP||[]);
        if(!window.printHTML)return;
        const rows=REP.map(r=>
          `<tr><td>${r.id}</td><td>${r.ref}</td><td>${r.nombre}</td><td>${r.solicitante||""}</td><td>${r.estado||""}</td></tr>`).join("");
        printHTML("Repuestos solicitados",
          `<h2>Repuestos solicitados</h2><table>
            <thead><tr><th>ID</th><th>Ref</th><th>Nombre</th><th>Solicitante</th><th>Estado</th></tr></thead>
            <tbody>${rows}</tbody></table>`);
      });

      // Export OT
      byId("btnExportOTPDF")?.addEventListener("click",()=>{
        const OTS=(window.OTS||[]);
        if(!window.printHTML)return;
        const fmtDate=(d)=> new Date(d).toLocaleString("es-ES",{hour12:false});
        const rows=OTS.map(o=>
          `<tr><td>${fmtDate(o.created||"")}</td><td>${o.id}</td><td>${o.prioridad||""}</td><td>${o.asignado||""}</td><td>${o.vencimiento||""}</td><td>${o.estado||""}</td></tr>`).join("");
        printHTML("Órdenes de trabajo",
          `<h2>Órdenes de trabajo</h2><table>
            <thead><tr><th>Fecha</th><th>OT</th><th>Prioridad</th><th>Asignado</th><th>Vence</th><th>Estado</th></tr></thead>
            <tbody>${rows}</tbody></table>`);
      });
    };
  }

  // Boot (idempotente)
  if (!window.__CDL_BOOT_ATTACHED__){
    window.__CDL_BOOT_ATTACHED__=true;
    document.addEventListener("DOMContentLoaded", async ()=>{
      try{
        bindUI && bindUI();
        loadState && await loadState();
        if(loadIncid && loadInv && loadRepSol && loadConsumibles && loadOT){
          await Promise.all([loadIncid(),loadInv(),loadRepSol(),loadConsumibles(),loadOT()]);
        }
        calcKPIs && calcKPIs();
        drawAllCharts && drawAllCharts();
        handleHash && handleHash();
      }catch(e){ console.error(e); }
    });
  }
})();
/* ========== BLOQUE 5.5 (FIN) ========== */
/* ========== BLOQUE 5.5.x (INICIO) — Listeners export Incidencias (IDs únicos) ========== */
(function(){
  if (window.__INCID_EXPORT_BOUND__) return;
  window.__INCID_EXPORT_BOUND__ = true;

  const tableSel = "#incidTableWrap table";

  const handleCSV = ()=>{
    const t = document.querySelector(tableSel);
    if (!t) { alert("No hay tabla de incidencias"); return; }
    if (typeof exportCSVFromTable === "function"){
      exportCSVFromTable(tableSel, "incidencias.csv");
    }
  };

  const handlePDF = ()=>{
    const t = document.querySelector(tableSel);
    if (!t) { alert("No hay tabla de incidencias"); return; }
    if (typeof printHTML === "function"){
      printHTML("Incidencias", `<h2>Incidencias</h2><table>${t.innerHTML}</table>`);
    }
  };

  ["btnExportIncidCSV","btnExportIncidCSVTop"].forEach(id=>{
    document.getElementById(id)?.addEventListener("click", handleCSV);
  });
  ["btnExportIncidPDF","btnExportIncidPDFTop"].forEach(id=>{
    document.getElementById(id)?.addEventListener("click", handlePDF);
  });
})();
/* ========== BLOQUE 5.5.x (FIN) ========== */
/* ========== BLOQUE 5.6 (INICIO) ========== */
/* SW auto-actualiza + loader QR + utilidades Toast */
(function(){
  // Toast unificado (mantiene compatibilidad con showToast y toast)
  if (typeof window.toast === "undefined"){
    window.toast = function(msg){
      let t = document.getElementById("toast");
      if(!t){
        t = document.createElement("div");
        t.id = "toast";
        t.style.position="fixed";
        t.style.left="50%";
        t.style.bottom="16px";
        t.style.transform="translateX(-50%)";
        t.style.background="#0b0f15";
        t.style.color="#e5e7eb";
        t.style.border="1px solid #1f2937";
        t.style.padding=".5rem .8rem";
        t.style.borderRadius="12px";
        t.style.boxShadow="0 10px 26px rgba(0,0,0,.35)";
        t.style.opacity="0";
        t.style.transition="opacity .25s ease";
        t.style.zIndex="3000";
        document.body.appendChild(t);
      }
      t.textContent = msg;
      t.style.opacity = "1";
      clearTimeout(window.__TOAST_T);
      window.__TOAST_T = setTimeout(()=> t.style.opacity = "0", 1800);
    };
  }
  if (typeof window.showToast === "undefined"){
    window.showToast = (m)=> window.toast(m);
  }

  // Service Worker auto-actualiza
  if ('serviceWorker' in navigator && !window.__CDL_SW_BOUND__){
    window.__CDL_SW_BOUND__ = true;
    window.addEventListener('load', async () => {
      try {
        const reg = await navigator.serviceWorker.register('/sw.js', { updateViaCache: 'none' });
        if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        reg.addEventListener('updatefound', () => {
          const nw = reg.installing;
          nw && nw.addEventListener('statechange', () => {
            if (nw.state === 'installed' && navigator.serviceWorker.controller) {
              reg.waiting && reg.waiting.postMessage({ type: 'SKIP_WAITING' });
            }
          });
        });
        navigator.serviceWorker.addEventListener('controllerchange', () => location.reload());
      } catch (e) { console.error('SW register error', e); }
    });
  }

  // QRCode lazy loader (si no está cargado)
  (function loadQRLib(){
    if (window.QRCode || document.querySelector('script[data-qrcode-lib]')) return;
    const s = document.createElement("script");
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js";
    s.setAttribute("data-qrcode-lib","1");
    s.onload = ()=> console.log("QRCode.js cargado");
    document.head.appendChild(s);
  })();
})();
/* ========== BLOQUE 5.6 (FIN) ========== */
/* ========== BLOQUE 5.7 (INICIO) — Helpers y navegación (producción) ========== */
(function(){
  if (window.__CDL_HELPERS_READY__) return;
  window.__CDL_HELPERS_READY__ = true;

  // Espejo del usuario actual (compatibilidad con código previo)
  window.currentUser = window.currentUser || USER;

  // Roles con permiso de edición (ajusta si Producción no debe editar)
  const EDIT_ROLES = new Set(["Administrador","Gerente","Encargado","Producción"]);
  if (typeof window.canEdit !== "function"){
    window.canEdit = ()=> EDIT_ROLES.has((USER?.rol)||"Invitado");
  }

  // Helpers básicos
  if (typeof window.val !== "function"){
    window.val = (id)=> (document.getElementById(id)?.value||"").trim();
  }
  if (typeof window.baseURL !== "function"){
    window.baseURL = ()=> (location.origin + location.pathname);
  }
  if (typeof window.slugify !== "function"){
    window.slugify = (s)=> String(s||"")
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
  }
  if (typeof window.ensureSectionsHidden !== "function"){
    window.ensureSectionsHidden = ()=>{
      document.querySelectorAll('[id^="page-"]').forEach(el=> el.classList.add("hidden"));
    };
  }

  // Mapa nav -> id de sección real en tu HTML
  const PAGE_ID = {
    equipos:      "page-equipos",
    gruas:        "page-gruas",
    otros:        "page-otros",
    incidencias:  "page-incidencias",
    indicadores:  "page-indicadores",
    ot:           "page-ot",
    inventario:   "page-inv",
    repuestos:    "page-rep",
    consumibles:  "page-cons",
    tv:           "page-tv",
    personal:     "page-personal",
    logs:         "page-logs",

    // Detalles (por si existieran en tu layout)
    equipo:       "page-equipo",
    repuesto:     "page-repuesto",
  };

  // Navegación principal (idempotente)
  if (typeof window.nav !== "function"){
    window.nav = (page)=>{
      const id = PAGE_ID[page] || PAGE_ID["equipos"];
      window.ensureSectionsHidden && ensureSectionsHidden();

      const tgt = document.getElementById(id);
      if (tgt) tgt.classList.remove("hidden");

      // hash navegable (no romper el back)
      try{
        const desired = "#/"+page;
        if (location.hash !== desired) location.hash = desired;
      }catch(_){}
    };
  }

  // Cerrar menús (páginas / usuario) y desbloquear scroll
  if (typeof window.closeAllMenus !== "function"){
    window.closeAllMenus = ()=>{
      const p = document.getElementById("pagesPanel");
      const u = document.getElementById("userPanel");
      if (p){ p.classList.add("hidden"); document.getElementById("pagesBtn")?.setAttribute("aria-expanded","false"); }
      if (u){ u.classList.add("hidden"); document.getElementById("userBtn")?.setAttribute("aria-expanded","false"); }
      document.documentElement.classList.remove("menu-open");
      document.body.classList.remove("menu-open");
    };
  }

  // Bindings a botones de alta/acciones (idempotentes, sólo si existen)
  const on = (id,fn)=>{
    const n = document.getElementById(id);
    if (!n || n.__bound__) return;
    n.__bound__ = true; n.addEventListener("click", fn);
  };
  on("btnAddInv",   ()=> window.invAdd && invAdd());
  on("btnAddRep",   ()=> window.addRep && addRep());
  on("btnAddCons",  ()=> window.consAdd && consAdd());
  on("btnAddOT",    ()=> window.addOT && addOT());
  on("btnAddIncid", ()=> window.addIncid && addIncid());

  // Acción “Parada prolongada”: primero API; si falla, mailto
  if (typeof window.accionParadaProlongada !== "function"){
    window.accionParadaProlongada = async (equipo)=>{
      try{
        const r = await apiPost({res:"mail", fn:"parada_prolongada", equipo, actor:(window.currentUser?.user||USER?.user||"anon")});
        if (r?.ok){ (window.toast||window.showToast||console.log)("Aviso enviado"); return; }
        throw new Error("mail api not ok");
      }catch(_){
        const subj = encodeURIComponent(`[CDL] Parada prolongada — ${equipo}`);
        const body = encodeURIComponent(`Equipo: ${equipo}\nFecha: ${new Date().toLocaleString("es-ES",{hour12:false})}\n\nDetalle: ...`);
        location.href = `mailto:?subject=${subj}&body=${body}`;
      }
    };
  }
})();
/* ========== BLOQUE 5.7 (FIN) ========== */
/* ========== BLOQUE 6.1 (INICIO) — Estados globales + helpers export ========== */
window.INCID = window.INCID || [];
window.INV   = window.INV   || [];
window.REP   = window.REP   || [];
window.CONS  = window.CONS  || [];
window.OTS   = window.OTS   || [];

if (typeof window.csvEscape === "undefined"){
  window.csvEscape = function(v){
    v = (v==null?'':String(v));
    if (/[",\n;]/.test(v)) return `"${v.replace(/"/g,'""')}"`;
    return v;
  };
}
if (typeof window.toCSV === "undefined"){
  window.toCSV = function(rows){ return rows.map(r => r.map(window.csvEscape).join(";")).join("\n"); };
}
if (typeof window.download === "undefined"){
  window.download = function(name, content, type="text/plain"){
    const blob = new Blob([content], {type});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = name;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  };
}
/* ========== BLOQUE 6.1 (FIN) ========== */

/* ========== BLOQUE 6.2 (INICIO) — Incidencias: carga, filtros, render tabla ========== */
async function loadIncid(){
  try{
    const r = await apiGet({res:"incid", fn:"list"});
    if (r?.ok && Array.isArray(r.items)){
      window.INCID = r.items;
      renderIncidenciasTable(r.items);
    }
  }catch(e){ console.error(e); }
}

function renderIncidenciasTable(items){
  const wrap = document.getElementById("incidTableWrap") || document.createElement("div");
  wrap.id = "incidTableWrap";
  wrap.innerHTML = "";
  if (!items || !items.length){
    wrap.textContent = "Sin incidencias";
    return;
  }
  const table = document.createElement("table");
  table.innerHTML = `
    <thead><tr>
      <th>Equipo</th><th>Tipo</th><th>Descripción</th>
      <th>Inicio</th><th>Fin</th><th>Reportante</th>
    </tr></thead>
    <tbody>
      ${items.map(it=>`
        <tr>
          <td>${esc(it.equipo)}</td>
          <td>${esc(it.tipo||"")}</td>
          <td>${esc(it.desc||"")}</td>
          <td>${fmtDate(it.inicio)}</td>
          <td>${fmtDate(it.fin)}</td>
          <td>${esc(it.reportante||"")}</td>
        </tr>
      `).join("")}
    </tbody>`;
  wrap.appendChild(table);
  const sec = document.getElementById("page-incidencias");
  if (sec && !sec.querySelector("#incidTableWrap")) sec.appendChild(wrap);
}
/* ========== BLOQUE 6.2 (FIN) ========== */


/* ========== BLOQUE 6.3 (INICIO) — Inventario con ±1/±10/±100 ========== */
async function loadInv(){
  try{
    const r = await apiGet({res:"inv", fn:"list"});
    if (r?.ok && Array.isArray(r.items)){
      window.INV = r.items;
      renderInv(r.items);
    }
  }catch(e){ console.error(e); }
}

function renderInv(items){
  const wrap = document.getElementById("invWrap");
  if (!wrap) return;
  wrap.innerHTML = "";
  if (!items || !items.length){
    wrap.textContent = "Inventario vacío";
    return;
  }
  items.forEach(it=>{
    const d = document.createElement("div");
    d.className = "card";
    d.innerHTML = `
      <div><b>${esc(it.nombre)}</b> [${esc(it.ref)}]</div>
      <div>Stock: ${it.stock} · Mínimo: ${it.minimo}</div>
      <div>
        <button onclick="invDelta('${it.ref}',1)">+1</button>
        <button onclick="invDelta('${it.ref}',-1)">-1</button>
        <button onclick="invDelta('${it.ref}',10)">+10</button>
        <button onclick="invDelta('${it.ref}',-10)">-10</button>
        <button onclick="invDelta('${it.ref}',100)">+100</button>
        <button onclick="invDelta('${it.ref}',-100)">-100</button>
      </div>
    `;
    wrap.appendChild(d);
  });
}

async function invDelta(ref, delta){
  try{
    const r = await apiPost({res:"inv", fn:"delta", ref, delta, actor:USER.user});
    if (r?.ok){
      (window.toast||window.showToast||console.log)("Stock actualizado: "+ref);
      loadInv();
    }
  }catch(e){ console.error(e); }
}

async function invAdd(){
  const ref = document.getElementById("invRef")?.value || "";
  const nombre = document.getElementById("invNombre")?.value || "";
  const stock = +(document.getElementById("invStock")?.value || 0);
  const minimo = +(document.getElementById("invMin")?.value || 0);
  try{
    const r = await apiPost({res:"inv", fn:"add", ref, nombre, stock, minimo, actor:USER.user});
    if (r?.ok){
      (window.toast||window.showToast||console.log)("Añadido al inventario");
      loadInv();
    }
  }catch(e){ console.error(e); }
}
/* ========== BLOQUE 6.3 (FIN) ========== */
/* ========== BLOQUE 6.4 (INICIO) — Repuestos solicitados (HTML-safe con #repWrap) ========== */
async function loadRepSol(){
  try{
    const d = await apiGet({res:"rep", fn:"list"});
    window.REP = d?.ok && Array.isArray(d.items) ? d.items : [];
    renderRepTable();
  }catch(e){ console.error(e); }
}

function renderRepTable(){
  const host = document.getElementById("repWrap");
  if (!host) return;

  if (!window.REP || !window.REP.length){
    host.innerHTML = `<div class="card">Sin solicitudes</div>`;
    return;
  }

  const rows = window.REP.map(r=>`
    <tr data-id="${esc(r.id)}">
      <td class="nowrap">${esc(fmtDate(r.created||""))}</td>
      <td>${esc(r.id)}</td>
      <td>${esc(r.ref)}</td>
      <td>
        <button class="btn gloss btn-ficha" title="Abrir ficha de inventario" onclick="openRepuestoByRef('${esc(r.ref)}')">${esc(r.nombre)}</button>
      </td>
      <td>${esc(r.solicitante||"-")}</td>
      <td>
        <select class="repestado" data-id="${esc(r.id)}">
          ${["Pendiente","Aprobado","Denegado","Recibido"].map(s=>`<option ${s===(r.estado||"Pendiente")?'selected':''}>${s}</option>`).join("")}
        </select>
      </td>
      <td><input class="repcoment in-txt" data-id="${esc(r.id)}" value="${esc(r.comentario||"")}" placeholder="Comentario"></td>
      <td class="nowrap">
        <div class="qty" data-ref="${esc(r.ref)}" style="margin-bottom:.35rem;display:flex;gap:.25rem;flex-wrap:wrap">
          <button class="page-btn rep-delta" data-delta="+1"   data-ref="${esc(r.ref)}">+1</button>
          <button class="page-btn rep-delta" data-delta="-1"   data-ref="${esc(r.ref)}">-1</button>
          <button class="page-btn rep-delta" data-delta="+10"  data-ref="${esc(r.ref)}">+10</button>
          <button class="page-btn rep-delta" data-delta="-10"  data-ref="${esc(r.ref)}">-10</button>
          <button class="page-btn rep-delta" data-delta="+100" data-ref="${esc(r.ref)}">+100</button>
          <button class="page-btn rep-delta" data-delta="-100" data-ref="${esc(r.ref)}">-100</button>
        </div>
        <button class="btn gloss rep-guardar" data-id="${esc(r.id)}">Guardar</button>
      </td>
    </tr>
  `).join("");

  host.innerHTML = `
    <div id="repTableWrap">
      <table>
        <thead>
          <tr>
            <th>Fecha</th><th>ID</th><th>Ref</th><th>Nombre</th><th>Solicitante</th>
            <th>Estado</th><th>Comentario</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;

  const tb = host.querySelector("tbody");
  if (!tb) return;

  // Guardar fila (estado/comentario)
  tb.querySelectorAll(".rep-guardar").forEach(b=>{
    b.addEventListener("click", async (e)=>{
      if (!canEdit()) return alert("Sin permiso.");
      const id = e.currentTarget.getAttribute("data-id");
      const estado = tb.querySelector(`.repestado[data-id="${CSS.escape(id)}"]`)?.value || "Pendiente";
      const comentario = tb.querySelector(`.repcoment[data-id="${CSS.escape(id)}"]`)?.value || "";
      try{
        const r = await apiPost({res:"rep", fn:"set", id, estado, comentario, actor:(window.currentUser?.user||USER?.user||"anon")});
        if (r?.ok){ (window.toast||window.showToast||console.log)("Guardado"); loadRepSol(); }
        else alert(r?.error||"No se pudo guardar");
      }catch(err){ console.error(err); alert("Error de red"); }
    });
  });

  // Ajustes rápidos al inventario desde la solicitud
  tb.querySelectorAll(".rep-delta").forEach(b=>{
    b.addEventListener("click", async (e)=>{
      if (!canEdit()) return alert("Sin permiso.");
      const ref   = e.currentTarget.getAttribute("data-ref");
      const delta = Number(e.currentTarget.getAttribute("data-delta"));
      try{
        const r = await apiPost({res:"inv", fn:"delta", ref, delta, actor:(window.currentUser?.user||USER?.user||"anon")});
        if (r?.ok){ (window.toast||window.showToast||console.log)(`Inventario ${ref}: ${r.stock}`); loadInv(); }
      }catch(err){ console.error(err); }
    });
  });
}

async function addRep(){
  if (!canEdit()) return alert("Sin permiso.");
  const item = { ref: val("repRef"), nombre: val("repNombre") };
  if (!item.ref || !item.nombre){ alert("Rellena referencia y nombre"); return; }
  try{
    const r = await apiPost({res:"rep", fn:"add", item, actor:(window.currentUser?.user||USER?.user||"anon")});
    if (r?.ok){
      (window.toast||window.showToast||console.log)("Solicitud enviada");
      ["repRef","repNombre","repComent"].forEach(id=>{ const n=byId(id); if(n) n.value=""; });
      loadRepSol();
    }else alert(r?.error||"No se pudo crear");
  }catch(err){ console.error(err); alert("Error de red"); }
}

function exportRepCSV(){
  if (!window.exportSimpleCSV) return;
  exportSimpleCSV("repuestos_solicitados.csv",
    ["Fecha","ID","Ref","Nombre","Solicitante","Estado","Comentario"],
    (window.REP||[]),
    r=>[fmtDate(r.created||""), r.id, r.ref, r.nombre, r.solicitante||"", r.estado||"", r.comentario||""]
  );
}

function exportRepPDF(){
  if (!window.printHTML) return;
  const rows = (window.REP||[]).map(r=>`
    <tr><td>${esc(fmtDate(r.created||""))}</td><td>${esc(r.id)}</td><td>${esc(r.ref)}</td><td>${esc(r.nombre)}</td><td>${esc(r.solicitante||"")}</td><td>${esc(r.estado||"")}</td><td>${esc(r.comentario||"")}</td></tr>
  `).join("");
  printHTML("Repuestos solicitados", `<h2>Repuestos solicitados</h2>
  <table><thead><tr><th>Fecha</th><th>ID</th><th>Ref</th><th>Nombre</th><th>Solicitante</th><th>Estado</th><th>Comentario</th></tr></thead><tbody>${rows}</tbody></table>`);
}
/* ========== BLOQUE 6.4 (FIN) ========== */

/* ========== BLOQUE 6.5 (INICIO) — Consumibles (render en #consWrap) ========== */
async function loadConsumibles(){
  try{
    const d = await apiGet({res:"cons", fn:"list"});
    CONS = d.ok ? d.items : [];
    renderConsTable();
    renderConsAlerts();
  }catch(e){ console.error(e); }
}

function renderConsTable(){
  const host = document.getElementById("consWrap"); if (!host) return;
  if (!Array.isArray(CONS) || !CONS.length){
    host.innerHTML = `<div class="card">Sin consumibles</div>`;
    return;
  }
  const rows = CONS.map(c=>`
    <tr>
      <td>${esc(c.ref)}</td>
      <td>${esc(c.nombre)}</td>
      <td class="num">${c.stock}</td>
      <td class="num">${c.minimo}</td>
      <td>${c.updated ? esc(fmtDate(c.updated)) : ""}</td>
      <td class="nowrap">
        <div class="qty" data-ref="${esc(c.ref)}">
          <button class="page-btn cons-delta" data-delta="+1"   data-ref="${esc(c.ref)}">+1</button>
          <button class="page-btn cons-delta" data-delta="-1"   data-ref="${esc(c.ref)}">-1</button>
          <button class="page-btn cons-delta" data-delta="+10"  data-ref="${esc(c.ref)}">+10</button>
          <button class="page-btn cons-delta" data-delta="-10"  data-ref="${esc(c.ref)}">-10</button>
          <button class="page-btn cons-delta" data-delta="+100" data-ref="${esc(c.ref)}">+100</button>
          <button class="page-btn cons-delta" data-delta="-100" data-ref="${esc(c.ref)}">-100</button>
        </div>
      </td>
    </tr>
  `).join("");
  host.innerHTML = `
    <div id="consTableWrap">
      <table>
        <thead>
          <tr><th>Ref</th><th>Nombre</th><th>Stock</th><th>Mínimo</th><th>Actualizado</th><th>Acciones</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
  host.querySelectorAll("button.cons-delta").forEach(b=>{
    b.addEventListener("click", async (e)=>{
      if (!canEdit()) return alert("Sin permiso.");
      const ref   = e.currentTarget.getAttribute("data-ref");
      const delta = Number(e.currentTarget.getAttribute("data-delta"));
      try{
        const r = await apiPost({res:"cons", fn:"delta", ref, delta, actor: currentUser?.user||"anon"});
        if (r?.ok){ toast(`Stock ${ref}: ${r.stock}`); loadConsumibles(); }
      }catch(err){ console.error(err); }
    });
  });
}

function renderConsAlerts(){
  const low = (CONS||[]).filter(x => (x.stock||0) <= (x.minimo||0));
  const box = byId("consAlerts"); if (!box) return; // opcional
  if (!low.length){ box.classList.add("hidden"); box.innerHTML=""; return; }
  box.classList.remove("hidden");
  box.innerHTML = `<b>Consumibles bajos:</b> ` + low.map(x=>`<span class="badge-low">${esc(x.ref)} (${x.stock}/${x.minimo})</span>`).join(" ");
}

async function consAdd(){
  if (!canEdit()) return alert("Sin permiso.");
  const item = { ref: val("consRef"), nombre: val("consNombre"), stock: Number(val("consStock")||0), minimo: Number(val("consMin")||0) };
  try{
    const r = await apiPost({res:"cons", fn:"add", item, actor: currentUser?.user||"anon"});
    if (r?.ok){
      toast("Consumible añadido");
      ["consRef","consNombre","consStock","consMin"].forEach(id=>{ const n=byId(id); if(n) n.value=""; });
      loadConsumibles();
    }else alert(r?.error||"No se pudo añadir");
  }catch(err){ console.error(err); alert("Error de red"); }
}
/* ========== BLOQUE 6.5 (FIN) ========== */

/* ========== BLOQUE 6.6 (INICIO) — Órdenes de trabajo (render en #otWrap) ========== */
async function loadOT(){
  try{
    const d = await apiGet({res:"ot", fn:"list"});
    OTS = d.ok ? d.items : [];
    renderOTTable();
  }catch(e){ console.error(e); }
}

function renderOTTable(){
  const host = document.getElementById("otWrap"); if (!host) return;
  if (!Array.isArray(OTS) || !OTS.length){
    host.innerHTML = `<div class="card">Sin OT</div>`;
    return;
  }
  const rows = OTS.map(o=>`
    <tr>
      <td>${esc(fmtDate(o.created||""))}</td>
      <td>${esc(o.id)}</td>
      <td>${esc(o.prioridad||"")}</td>
      <td>${esc(o.asignado||"")}</td>
      <td>${esc(o.vencimiento||"")}</td>
      <td>${esc(o.estado||"")}</td>
    </tr>
  `).join("");
  host.innerHTML = `
    <div id="otTableWrap">
      <table>
        <thead>
          <tr><th>Fecha</th><th>OT</th><th>Prioridad</th><th>Asignado</th><th>Vence</th><th>Estado</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="right" style="margin-top:.5rem;display:flex;gap:.5rem;flex-wrap:wrap">
        <button id="btnExportOTPDF" class="btn gloss">Exportar PDF</button>
      </div>
    </div>`;
}

async function addOT(){
  if (!canEdit()) return alert("Sin permiso.");
  const item = {
    equipo: val("otEquipo"),
    prioridad: val("otPrioridad"),
    titulo: val("otTitulo"),
    vencimiento: val("otVencimiento"),
    asignado: "", adj: "", desc: ""
  };
  try{
    const r = await apiPost({res:"ot", fn:"add", item, actor: currentUser?.user||"anon"});
    if (r?.ok){
      toast("OT creada");
      ["otEquipo","otTitulo","otVencimiento","otPrioridad"].forEach(id=>{ const n=byId(id); if(n) n.value=""; });
      loadOT();
    }else alert(r?.error||"No se pudo crear");
  }catch(err){ console.error(err); alert("Error de red"); }
}

function exportOTPDF(){
  if (!window.printHTML) return;
  const fmt = (d)=> new Date(d).toLocaleString("es-ES",{hour12:false});
  const rows = (OTS||[]).map(o=>`
    <tr><td>${esc(fmt(o.created||""))}</td><td>${esc(o.id)}</td><td>${esc(o.prioridad||"")}</td><td>${esc(o.asignado||"")}</td><td>${esc(o.vencimiento||"")}</td><td>${esc(o.estado||"")}</td></tr>
  `).join("");
  printHTML("Órdenes de trabajo", `<h2>Órdenes de trabajo</h2>
  <table><thead><tr><th>Fecha</th><th>OT</th><th>Prioridad</th><th>Asignado</th><th>Vence</th><th>Estado</th></tr></thead><tbody>${rows}</tbody></table>`);
}
/* ========== BLOQUE 6.6 (FIN) ========== */
/* ========== BLOQUE 6.7 (INICIO) — Fichas (equipo / repuesto) ========== */
function renderEquipoBySlug(slug){
  // Oculta secciones y muestra ficha de equipo
  if (typeof ensureSectionsHidden === "function") ensureSectionsHidden();
  const hostId = "equipoDetail";
  const pageId = "page-equipo";
  const show = (id)=>document.getElementById(id)?.classList.remove("hidden");
  show(pageId);
  const host = document.getElementById(hostId);

  const eq = (window.STATE||[]).find(x => (typeof slugify==="function" ? slugify(x.nombre) : String(x.nombre).toLowerCase().replace(/\s+/g,'-')) === slug);
  if (!host || !eq){
    if (host) host.innerHTML = "<div class='card'>No encontrado</div>";
    return;
  }

  const baseURL = (typeof window.baseURL==="function") ? window.baseURL() : (location.origin + location.pathname);
  host.innerHTML = `
    <div class="card">
      <h3 style="margin:.1rem 0">${esc(eq.nombre)}</h3>
      <div class="sub">${esc(eq.grupo)}</div>
      <div style="margin:.5rem 0">Estado actual: <b>${esc(eq.estado)}</b></div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn gloss btn-mail" onclick="accionParadaProlongada(${JSON.stringify(eq.nombre)})">Parada prolongada (email)</button>
        <button class="btn gloss btn-ficha" onclick="window.print()">Imprimir ficha</button>
        <button class="btn gloss" onclick="history.back()">Volver</button>
      </div>
      <div style="margin-top:.6rem"><div id="qrficha"></div></div>
    </div>
  `;
  const qr = document.getElementById("qrficha");
  if (qr && window.QRCode){
    new QRCode(qr, { text: `${baseURL}#/equipo/${slug}`, width:96, height:96 });
  }
}

function openRepuestoByRef(ref){
  const slug = encodeURIComponent(ref);
  location.hash = `#/repuesto/${slug}`;
  renderRepuestoByRef(ref);
}

function renderRepuestoByRef(ref){
  if (typeof ensureSectionsHidden === "function") ensureSectionsHidden();
  const pageId = "page-repuesto";
  const hostId = "repuestoDetail";
  const show = (id)=>document.getElementById(id)?.classList.remove("hidden");
  show(pageId);
  const host = document.getElementById(hostId);

  const it = (window.INV||[]).find(x => String(x.ref).toUpperCase() === String(ref).toUpperCase());
  if (!host || !it){
    if (host) host.innerHTML = "<div class='card'>No encontrado</div>";
    return;
  }

  const baseURL = (typeof window.baseURL==="function") ? window.baseURL() : (location.origin + location.pathname);
  host.innerHTML = `
    <div class="card">
      <h3 style="margin:.1rem 0">${esc(it.nombre)}</h3>
      <div class="sub">Ref: <b>${esc(it.ref)}</b></div>
      <div style="margin:.5rem 0">Stock: <b>${it.stock}</b> · Mínimo: <b>${it.minimo}</b></div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn gloss" onclick="window.print()">Imprimir etiqueta</button>
        <button class="btn gloss" onclick="history.back()">Volver</button>
      </div>
      <div style="margin-top:.6rem"><div id="qrrep"></div></div>
    </div>
  `;
  const qr = document.getElementById("qrrep");
  if (qr && window.QRCode){
    new QRCode(qr, { text: `${baseURL}#/repuesto/${encodeURIComponent(it.ref)}`, width:96, height:96 });
  }
}
/* ========== BLOQUE 6.7 (FIN) ========== */


/* ========== BLOQUE 6.8 (INICIO) — Router (guard) + sello de tiempo ========== */
// Si otro bloque ya definió handleHash, respetarlo.
if (typeof window.handleHash !== "function"){
  window.handleHash = function(){
    const h = location.hash || "";
    if (!h){ window.nav && nav("equipos"); return; }

    const mEq = h.match(/^#\/equipo\/(.+)$/);
    const mRp = h.match(/^#\/repuesto\/(.+)$/);

    if (mEq && typeof renderEquipoBySlug==="function"){ renderEquipoBySlug(mEq[1]); return; }
    if (mRp && typeof renderRepuestoByRef==="function"){ const ref = decodeURIComponent(mRp[1]||""); renderRepuestoByRef(ref); return; }

    const p = h.replace(/^#\/?/,"");
    const pages = ["equipos","gruas","otros","incidencias","indicadores","ot","inventario","repuestos","consumibles","tv"];
    if (pages.includes(p) && typeof nav==="function"){ nav(p); return; }

    typeof nav==="function" && nav("equipos");
  };
  window.addEventListener("hashchange", window.handleHash);
}

// Sello de tiempo del resumen (guard)
if (typeof window.updateSummaryTimestamp !== "function"){
  window.updateSummaryTimestamp = function(){
    const d = new Date();
    const el = document.getElementById("kUpdated");
    if (el) el.textContent = d.toLocaleString("es-ES",{hour12:false});
  };
  setInterval(window.updateSummaryTimestamp, 30*1000);
  window.updateSummaryTimestamp();
}
/* ========== BLOQUE 6.8 (FIN) ========== */


/* ========== BLOQUE 7.1 (INICIO) — PW toggle + arranque mínimo (guard) ========== */
// Toggle de mostrar/ocultar contraseñas (click delegado)
if (!window.__PW_TOGGLE_BOUND__){
  window.__PW_TOGGLE_BOUND__ = true;
  document.addEventListener("click",(e)=>{
    const btn = e.target.closest(".pw-toggle");
    if (!btn) return;
    const targetId = btn.getAttribute("data-target");
    const inp = document.getElementById(targetId);
    if (!inp) return;
    const to = inp.type === "password" ? "text" : "password";
    inp.type = to;
    btn.classList.toggle("on", to === "text");
    btn.setAttribute("aria-pressed", to === "text" ? "true" : "false");
  });
}

// Arranque mínimo si no está ya
if (!window.__CDL_MIN_BOOT__){
  window.__CDL_MIN_BOOT__ = true;
  document.addEventListener("DOMContentLoaded", ()=>{
    // Si existen, lánzalas (idempotente)
    typeof updateSummaryTimestamp === "function" && updateSummaryTimestamp();
    typeof handleHash === "function" && handleHash();
  });
}
/* ========== BLOQUE 7.1 (FIN) ========== */
/* ========== BLOQUE 7.2 (INICIO) — Atajos de UI y accesibilidad (guards) ========== */
(function(){
  if (window.__CDL_UI_SHORTCUTS__) return;
  window.__CDL_UI_SHORTCUTS__ = true;

  const hasInputFocus = ()=> {
    const a = document.activeElement;
    if (!a) return false;
    const tag = (a.tagName||"").toLowerCase();
    return ["input","textarea","select"].includes(tag) || a.isContentEditable;
  };

  // Atajos:
  //  - "/" enfoca el primer buscador visible (invSearch si existe)
  //  - "g e" → equipos, "g i" → inventario, "g r" → repuestos, "g c" → consumibles, "g t" → TV
  //  - "Esc" cierra menús si están abiertos
  document.addEventListener("keydown",(e)=>{
    // ESC → cerrar paneles si la app define closeAllMenus
    if (e.key === "Escape" && typeof window.closeAllMenus === "function"){
      window.closeAllMenus();
      return;
    }

    // Evitar atajos cuando se escribe en inputs
    if (hasInputFocus()) return;

    // "/" → buscador
    if (e.key === "/"){
      const cand = document.getElementById("invSearch")
               || document.querySelector('input[type="search"]')
               || document.querySelector('input[placeholder*="Buscar" i]');
      if (cand){ e.preventDefault(); cand.focus(); cand.select?.(); }
      return;
    }

    // Prefijo "g" (go) + letra
    if (e.key.toLowerCase() === "g"){
      // Esperar a la siguiente tecla
      const onNext = (ev)=>{
        document.removeEventListener("keydown", onNext, true);
        const k = (ev.key||"").toLowerCase();
        if (typeof window.nav !== "function") return;
        if (k === "e") nav("equipos");
        if (k === "i") nav("inventario");
        if (k === "r") nav("repuestos");
        if (k === "c") nav("consumibles");
        if (k === "t") nav("tv");
      };
      document.addEventListener("keydown", onNext, true);
    }
  }, { passive:true });

  // Asegurar activación con teclado en botones con role/button
  const boostBtn = (btn)=>{
    if (!btn || btn.__kbd__) return;
    btn.__kbd__ = true;
    btn.setAttribute("tabindex","0");
    btn.addEventListener("keydown",(e)=>{
      if (e.key === "Enter" || e.key === " "){
        e.preventDefault();
        btn.click();
      }
    });
  };
  const tryBoost = ()=>{
    ["pagesBtn","userBtn"].forEach(id => boostBtn(document.getElementById(id)));
    document.querySelectorAll('[role="button"]').forEach(boostBtn);
  };
  tryBoost();
  const mo = new MutationObserver(tryBoost);
  mo.observe(document.documentElement, { subtree:true, childList:true });
})();
/* ========== BLOQUE 7.2 (FIN) ========== */


/* ========== BLOQUE 7.3 (INICIO) — Mejoras de cabecera y viewport (guards) ========== */
(function(){
  if (window.__CDL_HDR_BOUND__) return;
  window.__CDL_HDR_BOUND__ = true;

  // Sombra al hacer scroll (si no lo hizo otro bloque)
  const hdr = document.querySelector("header");
  if (hdr){
    const onScroll = ()=>{ if (window.scrollY > 2) hdr.classList.add("scrolled"); else hdr.classList.remove("scrolled"); };
    onScroll();
    window.addEventListener("scroll", onScroll, { passive:true });
  }

  // Sincroniza variable --hdr-h para layouts con panel fullscreen
  const syncHeaderHeightVar = ()=>{
    const h = Math.max(72, document.querySelector('header')?.offsetHeight || 0);
    document.documentElement.style.setProperty('--hdr-h', h + 'px');
  };
  window.addEventListener('load', syncHeaderHeightVar);
  window.addEventListener('resize', syncHeaderHeightVar);
  window.addEventListener('orientationchange', syncHeaderHeightVar);
  if (document.fonts && document.fonts.ready) document.fonts.ready.then(syncHeaderHeightVar);
  syncHeaderHeightVar();
})();
/* ========== BLOQUE 7.3 (FIN) ========== */


/* ========== BLOQUE 7.4 (INICIO) — Login / Logout / Cambio de contraseña (guards) ========== */
(function(){
  const apiPost = window.apiPost || (async()=>({ ok:false }));

  if (typeof window.login !== "function"){
    window.login = async function(){
      const uSel = document.getElementById("userSelect");
      const pInp = document.getElementById("userPass");
      const u = uSel?.value || "invitado";
      const p = pInp?.value || "";
      try{
        const cid = (typeof getCID==="function" ? getCID() : (localStorage.getItem("CDL_CID")||""));
        const r = await apiPost({res:"auth", fn:"login", user:u, pass:p, cid});
        if (r?.ok){
          (typeof setUser==="function" ? setUser({ user:u, rol:r.rol||u, group:r.group||"guest" }) : (window.currentUser={ user:u, rol:r.rol||u, group:r.group||"guest"}));
          (window.toast||window.showToast||console.log)(`Bienvenido ${u}`);
          if (typeof window.closeAllMenus==="function") closeAllMenus();
        }else{
          alert("Usuario o contraseña incorrectos");
        }
      }catch(err){
        console.error(err);
        alert("Error en la conexión al servidor");
      }
    };
  }

  if (typeof window.logout !== "function"){
    window.logout = function(){
      try{
        localStorage.removeItem("CDL_USER");
        (typeof setUser==="function" ? setUser({ user:"invitado", rol:"Invitado", group:"guest" }) : (window.currentUser={ user:"invitado", rol:"Invitado", group:"guest"}));
        (window.toast||window.showToast||console.log)("Sesión cerrada");
        if (typeof window.closeAllMenus==="function") closeAllMenus();
      }catch(e){ console.error(e); }
    };
  }

  if (typeof window.changePwd !== "function"){
    window.changePwd = async function(){
      const oldP = document.getElementById("oldPass")?.value || "";
      const newP = document.getElementById("newPass")?.value || "";
      const msg  = document.getElementById("pwdMsg");
      if (!oldP || !newP){ alert("Introduce la contraseña actual y la nueva"); return; }
      try{
        const cid = (typeof getCID==="function" ? getCID() : (localStorage.getItem("CDL_CID")||""));
        const r = await apiPost({res:"auth", fn:"chpwd", old:oldP, nuevo:newP, cid});
        if (r?.ok){
          if (msg){ msg.textContent = "Contraseña cambiada correctamente"; msg.style.color = "green"; }
          const o = document.getElementById("oldPass"); const n = document.getElementById("newPass");
          if (o) o.value=""; if (n) n.value="";
        }else{
          if (msg){ msg.textContent = "Error al cambiar la contraseña"; msg.style.color = "red"; }
        }
      }catch(err){
        console.error(err);
        if (msg){ msg.textContent = "Error de red"; msg.style.color = "red"; }
      }
    };
  }
})();
 /* ========== BLOQUE 7.4 (FIN) ========== */
 <!-- ========== BLOQUE 7.6 (INICIO) — Menús funcionales ========== -->
<script>
(function(){
  if (window.__CDL_MENUS__) return; window.__CDL_MENUS__=true;

  const $ = (id)=>document.getElementById(id);
  const pagesBtn=$("pagesBtn"), pagesPanel=$("pagesPanel");
  const userBtn =$("userBtn"),  userPanel =$("userPanel");

  function open(btn,panel,fullscreen){
    closeAll();
    panel.classList.remove("hidden");
    if (fullscreen && matchMedia("(max-width: 720px)").matches){
      panel.classList.add("menu-full");
      document.documentElement.classList.add("menu-open");
      document.body.classList.add("menu-open");
    }
    btn.setAttribute("aria-expanded","true");
  }
  function close(btn,panel){
    if(!panel) return;
    panel.classList.add("hidden"); panel.classList.remove("menu-full");
    btn?.setAttribute("aria-expanded","false");
    document.documentElement.classList.remove("menu-open");
    document.body.classList.remove("menu-open");
  }
  function closeAll(){ close(pagesBtn,pagesPanel); close(userBtn,userPanel); }

  pagesBtn?.addEventListener("click",()=> pagesPanel.classList.contains("hidden") ? open(pagesBtn,pagesPanel,true) : close(pagesBtn,pagesPanel));
  userBtn ?.addEventListener("click",()=> userPanel .classList.contains("hidden") ? open(userBtn ,userPanel ,false) : close(userBtn ,userPanel ));

  document.addEventListener("click",(e)=>{
    if (e.target.closest("#pagesPanel, #pagesBtn, #userPanel, #userBtn")) return;
    closeAll();
  }, {passive:true});

  document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeAll(); }, {passive:true});
})();
</script>
<!-- ========== BLOQUE 7.6 (FIN) ========== -->

</body>
</html>