<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>CDL · Producción</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ffffff">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">

<!-- Fuente -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

<style>
/* =========================================================
   VARIABLES + RESET (consolidado) · versión compacta
========================================================= */
:root{
  --brand:#E43B3B;
  --ink:#0f172a;
  --muted:#475569;
  --line:#e5e7eb;
  --bg:#ffffff;

  --hdr-h:84px;
  --radius:16px;
  --shadow:0 3px 10px rgba(0,0,0,.05);

  --angular-size:26px;
  --angular-up:.72em;
  --angular-gap:20px;

  /* Carrusel algo más compacto para evitar cortes */
  --carousel-h:clamp(76px,13vw,128px);
}

*{box-sizing:border-box; min-width:0}
html{font-size:15px}
@media (max-width:540px){ html{font-size:14.5px} }
@media (min-width:1400px){ html{font-size:15.5px} }

html,body{height:100%; background:#fff; overflow-x:hidden; color:var(--ink)}
body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
a{color:inherit; text-decoration:none}
img,svg,canvas,video{display:block; max-width:100%; height:auto}
button{font:inherit; cursor:pointer; background:transparent; border:0}
:focus-visible{outline:2px solid #0ea5e9; outline-offset:2px}
@media (prefers-reduced-motion:reduce){ *{transition:none!important; animation:none!important} }

/* =========================================================
   BOTONES BASE
========================================================= */
.btn{
  display:inline-flex; align-items:center; justify-content:center;
  gap:.45rem; padding:.5rem .8rem; border-radius:10px; border:1px solid var(--line);
  background:#fff; color:var(--ink); font-weight:700; line-height:1.1; font-size:.95rem;
}
.btn:hover{ background:#f8fafc }
.btn:active{ transform:translateY(1px) }
.btn--primary{ background:var(--brand); color:#fff; border-color:transparent }
.btn--primary:hover{ filter:brightness(0.95) }
.btn--ghost{ background:#fff; color:#334155; border:1px solid #e2e8f0 }
.link{ background:transparent; border:0; color:var(--brand); font-weight:800; padding:0 }

/* Botón negro para "Programar parada" */
.btn--dark{ background:#000; color:#fff; border:1px solid #000 }
.btn--dark:hover{ filter:brightness(1.05) }

/* Badge */
.badge{display:inline-block; padding:2px 9px; border-radius:999px; font-weight:900; font-size:11px; background:#eef2f7; color:#334155; border:1px solid #e2e8f0}

/* Separador fino */
.sep{height:1px; margin:22px 0; background:linear-gradient(90deg,rgba(15,23,42,0),rgba(15,23,42,.22) 50%,rgba(15,23,42,0))}

/* Inputs */
.form-inline{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
.form-inline__label{ font-weight:900; font-size:.93rem }
.form-inline input[type="search"], .form-inline input[type="text"], .form-inline input[type="date"], .form-inline input[type="password"], .form-inline input[type="number"], .form-inline select, .form-inline textarea{
  padding:7px 10px; border:1px solid #e5e7eb; border-radius:10px; min-width:190px; font:inherit; font-size:.95rem;
}
.visually-hidden{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0}

/* =========================================================
   CABECERA
========================================================= */
.header{
  position:sticky; top:0; z-index:1000; background:#fff;
  border-bottom:1px solid #eee; transition:box-shadow .25s ease;
}
.header.scrolled{ box-shadow:0 6px 14px rgba(0,0,0,.06) }
.h__in{
  height:var(--hdr-h);
  display:grid; grid-template-columns:auto 1fr auto;
  align-items:flex-start; gap:10px; padding:6px 12px 8px; position:relative;
}
/* Marca de agua mantenimiento (subida y algo más ancha) */
.header::before{
  content:""; position:absolute; inset:0;
  background:
    linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.05) 60%, rgba(255,255,255,.09) 100%),
    url("logo_mantenimiento.png") center 0px / clamp(260px, 46vw, 420px) auto no-repeat;
  opacity:.10; pointer-events:none;
}
.brand{display:flex; align-items:flex-end; gap:10px; justify-self:center; margin-top:2px}
.brand img{height:40px; margin-top:2px}

#roleChip{
  position:absolute; right:16px; top:8px; font-weight:900; font-size:11px; color:var(--ink)
}
/* Iconos header */
.hbtn{width:42px; height:42px; display:grid; place-items:center}
#hamb .i{width:20px; height:14px; position:relative; display:inline-block}
#hamb .i:before,#hamb .i:after,#hamb .i span{
  content:""; position:absolute; left:0; right:0; height:2px; background:var(--ink); border-radius:2px;
}
#hamb .i:before{top:0} #hamb .i span{top:6px} #hamb .i:after{bottom:0}
#moreBtn .i{display:inline-block; width:16px; text-align:center; letter-spacing:2px; font-weight:900}
#moreBtn .i::before{content:"···"}

/* ===== SIDENAV ===== */
#sidenav{
  position:fixed;
  /* arranca justo debajo de la cabecera sticky */
  inset:var(--hdr-h) 0 0 0;
  background:#fff; color:var(--ink);
  transform:translateX(-100%);
  transition:transform .28s ease;
  z-index:1100;                 /* > header (1000) y > overlay (1050) */
  box-shadow:4px 0 24px rgba(0,0,0,.08);
  will-change:transform;
  overflow:auto;
}
#sidenav.open{ transform:none }

/* Cabecera del menú + buscador */
.sidenav__head{ display:flex; align-items:center; gap:12px; padding:12px 14px }
.sidenav__search{
  padding:10px 14px; display:grid; grid-template-columns:1fr auto auto; gap:8px; align-items:center
}
#closeNav{
  margin-left:0; width:38px; height:38px; font-size:18px; line-height:1;
  border-radius:8px; background:#000; color:#fff; border:1px solid #000;
}
.sidenav__search input{
  flex:1 1 auto; padding:10px 12px; border:1px solid var(--line); border-radius:12px; font-weight:600
}

/* Lista de navegación (acepta #navList o .navlist) */
#navList,.navlist{ padding:4px 0 }
#navList a,.navlist a{
  display:block; padding:12px 14px; border-radius:12px; font-weight:600;
  text-transform:uppercase; outline:none; position:relative; font-size:.94rem;
}
#navList a:not(:last-child)::after,.navlist a:not(:last-child)::after{
  content:""; position:absolute; left:10%; right:10%; height:1.5px;
  background:linear-gradient(90deg,rgba(0,0,0,0),rgba(15,23,42,.25) 50%,rgba(0,0,0,0));
  bottom:-1px;
}
#navList a[aria-current="page"],.navlist a[aria-current="page"]{
  background:#f6f8fb; box-shadow:inset 4px 0 0 var(--brand);
}

/* Overlay al abrir menú (por encima de todo menos del propio sidenav) */
body.menu-open{
  overflow:hidden;               /* bloquea scroll de fondo */
  touch-action:none;
}
body.menu-open::after{
  content:""; position:fixed; inset:var(--hdr-h) 0 0 0;
  backdrop-filter:blur(4px); background:rgba(0,0,0,.18);
  z-index:1050;                  /* < sidenav(1100), > contenido(...) */
}

/* Accesibilidad / rendimiento */
@media (prefers-reduced-motion:reduce){
  #sidenav{ transition:none }
}

/* =========================================================
   PANEL USUARIO
========================================================= */
#userPanel{
  position:fixed; left:0; right:0; top:var(--hdr-h);
  width:100vw; max-width:none;
  background:#0f141c; color:#e6eef7; border:1px solid #223046; border-radius:0; box-shadow:0 20px 36px rgba(0,0,0,.45);
  padding:12px; display:none; z-index:950; font-size:.95rem;
}
#userPanel.show{ display:block }
.up__head{ display:flex; align-items:center; justify-content:space-between; gap:10px }
.up__row{ display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:10px; margin-top:8px }
.up__field label{ display:block; font-weight:900; margin-bottom:4px }
.up__pwdwrap{ position:relative; display:flex; align-items:center }
.up__pwdwrap input{ flex:1 1 auto }
/* Botón de ojo SVG (versión actualizada) */
.eyeBtn{
  width:36px;
  height:36px;
  display:flex;
  align-items:center;
  justify-content:center;
  border:1px solid #223046;
  border-left:0;
  background:#0b101a;
  margin-left:4px;
  border-radius:0 10px 10px 0;
  color:#e6eef7;                /* color del icono */
  cursor:pointer;
  transition:filter .2s ease;
}
.eyeBtn:hover{ filter:brightness(1.2); }
.eyeBtn svg{
  width:20px;
  height:20px;
  pointer-events:none;
  fill:currentColor;
  stroke:currentColor;
  stroke-width:2;
}

/* Botones inferiores del panel */
.up__actions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:8px;
}

/* =========================================================
   TITULARES (con angular)
========================================================= */
h1,h2,h3{
  position:relative; margin:20px 0 12px; padding-left:var(--angular-gap); line-height:1.15; white-space:normal;
}
h1{font-size:clamp(1.25rem,3.4vw,1.6rem)}
h2{font-size:clamp(1.02rem,2.6vw,1.22rem)}
h3{font-size:clamp(.95rem,2.2vw,1.08rem)}
h1::before,h2::before,h3::before{
  content:""; position:absolute; left:0; bottom:var(--angular-up);
  width:var(--angular-size); height:var(--angular-size);
  background:url("angular.png") left bottom/contain no-repeat;
  z-index:1; pointer-events:none;
}
/* Quitar angular en subtítulos del DASHBOARD solicitados */
#dashboard .card h2::before{ display:none }

/* =========================================================
   CONTENEDOR Y TARJETAS
========================================================= */
.main{padding:14px; max-width:1160px; margin:0 auto}
.card{background:#fff; border:1px solid var(--line); border-radius:14px; padding:10px; box-shadow:var(--shadow)}
.grid{display:grid; gap:10px}
.grid.cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
.grid.cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
@media (max-width: 980px){ .grid.cols-2, .grid.cols-3 { grid-template-columns: 1fr } }

/* Hero del dashboard */
.hero{background:transparent; border:0; padding:4px 10px 0;}
.hero h1{margin:2px 0 0; padding-left:0}
.hero h1::before{display:none}
.hero .sub{margin:2px 0 0; font-weight:700; color:#64748b; font-size:.95rem}

/* ==================== TARJETA CON SEMÁFORO (horizontal) ==================== */
.tl{
  border-radius: 16px;
  border: 1px solid var(--line, #1e293b);
  padding: 10px 12px;
  margin: 6px 0;
  background: radial-gradient(circle at top left,#0f172a,#020617);
  color:#e5e7eb;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.tl__head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  flex-wrap:wrap;
}

.tl__id{
  display:flex;
  flex-direction:column;
  gap:4px;
}

.tl__name{
  font-weight:700;
  letter-spacing:.03em;
}

.tl__badge{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:2px 8px;
  border-radius:999px;
  font-size:11px;
  background:#0f172a;
  border:1px solid #1f2937;
  color:#e5e7eb;
}

/* Mínimo color de fondo según estado (se realza con JS al cambiar) */
.tl[data-card*=":"] .tl__badge{
  text-transform:uppercase;
}

/* Poste + lámparas */
.tl__pole-wrap{
  position:relative;
  display:flex;
  align-items:center;
  justify-content:flex-end;
}

.tl__pole{
  display:flex;
  gap:4px;
  padding:4px 8px;
  border-radius:999px;
  background:rgba(15,23,42,.9);
  border:1px solid #1f2937;
  box-shadow:0 0 0 1px rgba(15,23,42,.8),0 6px 12px rgba(0,0,0,.7) inset;
}

.tl__lamp{
  width:14px;
  height:14px;
  border-radius:999px;
  background:#020617;
  box-shadow:0 0 0 1px rgba(15,23,42,.9) inset;
  opacity:.3;
  transition:opacity .18s ease, box-shadow .18s ease, transform .18s ease;
}

/* Colores base (con color: para que el glow use currentColor) */
.tl__lamp--g{ background:#22c55e; color:#22c55e; }
.tl__lamp--y{ background:#eab308; color:#eab308; }
.tl__lamp--r{ background:#ef4444; color:#ef4444; }
.tl__lamp--b{ background:#3b82f6; color:#3b82f6; }

/* Encendidas */
.tl__lamp.active{
  opacity:1;
  box-shadow:
    0 0 6px currentColor,
    0 0 0 1px rgba(15,23,42,.9) inset;
  transform:translateY(-1px);
}

/* Zonas clicables (verde / amarillo / rojo / azul) */
.tl__hit{
  position:absolute;
  top:-6px;
  bottom:-6px;
  cursor:pointer;
}

/* Repartimos el “poste” en 4 zonas horizontales aproximadas */
.tl__hit--g{ left:0; width:25%; }
.tl__hit--y{ left:25%; width:25%; }
.tl__hit--r{ left:50%; width:25%; }
.tl__hit--b{ left:75%; width:25%; }

/* Pequeño feedback al pasar el ratón por encima (solo escritorio) */
@media (hover:hover){
  .tl__hit:hover ~ .tl__pole .tl__lamp{
    opacity:.4;
  }
}

/* Acciones inferiores */
.tl__actions{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
  margin-top:4px;
}

.tl__actions .btn{
  padding-inline:10px;
}

/* Menú contextual “más” de la tarjeta */
.tl__more{
  position:relative;
}

.tl__arrow{
  font-size:11px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid #1f2937;
  background:#020617;
  cursor:pointer;
  user-select:none;
}

.tl__more.open .tl__arrow{
  background:#111827;
}

.tl__menu{
  position:absolute;
  right:0;
  top:120%;
  min-width:190px;
  background:#020617;
  border-radius:12px;
  border:1px solid #1f2937;
  box-shadow:0 16px 40px rgba(0,0,0,.65);
  padding:6px;
  display:none;
  z-index:40;
}

.tl__more.open .tl__menu{
  display:block;
}

.tl__menu .btn{
  width:100%;
  justify-content:flex-start;
  font-size:12px;
  padding:4px 8px;
}

/* ==================== FIN TARJETA CON SEMÁFORO ==================== */

/* =========================================================
   UTILIDADES
========================================================= */
.black{ color:#0f172a; font-weight:900 }

.dbtv-tag{
  position:sticky;
  top:calc(var(--hdr-h) + 6px);
  display:inline-block;
  margin:6px 0;
  padding:5px 9px;
  border:1px solid var(--line);
  border-radius:999px;
  background:#fff;
  font-weight:900;
  font-size:.9rem;
}

/* =================== Dashboard TV: tipografías compactas =================== */
#dashboardtv{ font-size:.92rem }
#dashboardtv .card strong{ font-size:.98rem }
#dashboardtv .badge{ font-size:11px }
#dashboardtv details summary{ font-size:.98rem }

/* =========================================================
   GRID LOGOS INCIDENCIAS
========================================================= */
.inc-logos{
  display:grid; gap:10px;
  grid-template-columns:repeat(3,minmax(0,1fr));
}
@media (max-width:720px){ .inc-logos{ grid-template-columns:repeat(2,minmax(0,1fr)) } }
.inc-logo{
  display:grid; place-items:center; border:1px solid var(--line); border-radius:12px; padding:8px;
  background:#fff; cursor:pointer; transition:transform .08s ease, box-shadow .12s ease;
}
.inc-logo:active{ transform:translateY(1px) }
.inc-logo img{ max-height:54px; width:100%; object-fit:contain }
.inc-listado{ margin-top:8px }
.inc-listado button{
  display:block; width:100%; text-align:left; padding:8px 10px; border-radius:10px; border:1px solid var(--line); background:#fff;
}
.inc-listado button+button{ margin-top:6px }

/* =========================================================
   PLANIFICACIÓN · Hoja “calcada” de la plantilla en papel
   - 11 columnas fijas en el mismo orden
   - Tabla muy cuadriculada, aspecto de hoja impresa
   - Marcado visual de ALIMENTADO y TERMINADO
========================================================= */
.plan-wrap{
  display:flex;
  align-items:stretch;
  gap:0;
  margin-top:1rem;
  border:1px solid #cbd5e1;
  background:#ffffff;
}

/* Banda vertical gris con texto PLANIFICACIÓN (como la hoja) */
.plan-title-strip{
  writing-mode:vertical-rl;
  text-orientation:mixed;
  background:#4b5563;
  color:#f9fafb;
  font-weight:800;
  letter-spacing:.08em;
  text-transform:uppercase;
  padding:12px 6px;
  font-size:11px;
  display:flex;
  align-items:center;
  justify-content:center;
  min-width:26px;
}

/* Contenedor de la tabla */
.plan-table-wrap{
  flex:1 1 auto;
  overflow:auto;
}

/* Tabla principal */
.plan-table{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
  font-size:12px;
  color:#0f172a;
}

/* Cabecera */
.plan-table thead{
  background:#e5e7eb;
}
.plan-table th{
  border:1px solid #cbd5e1;
  padding:4px 6px;
  text-align:center;
  font-weight:800;
  font-size:11px;
  text-transform:uppercase;
  white-space:nowrap;
}

/* Cuerpo */
.plan-table td{
  border:1px solid #cbd5e1;
  padding:3px 5px;
  text-align:center;
  vertical-align:middle;
  background:#ffffff;
}

/* Anchuras calcadas del papel */
.plan-table .col-maq{   width:7%;  }
.plan-table .col-input{ width:6%;  }
.plan-table .col-cliente{width:14%;}
.plan-table .col-deleg{ width:9%;  }
.plan-table .col-uds{   width:7%;  }
.plan-table .col-kgs{   width:8%;  }
.plan-table .col-output{width:10%; }
.plan-table .col-picking{width:12%;}
.plan-table .col-parte{ width:6%;  }
.plan-table .col-carga{ width:9%;  }
.plan-table .col-com{   width:12%; }

/* Alineaciones idénticas al papel */
.plan-table td:nth-child(1),
.plan-table td:nth-child(3),
.plan-table td:nth-child(4),
.plan-table td:nth-child(7),
.plan-table td:nth-child(8),
.plan-table td:nth-child(11){
  text-align:left;
}
.plan-table td:nth-child(5),
.plan-table td:nth-child(6),
.plan-table td:nth-child(9),
.plan-table td:nth-child(10){
  text-align:right;
}

/* Fila TERMINADO */
.plan-table tr.done-row td{
  background:#e5e7eb;
  color:#4b5563;
}

/* Columna MAQUINA cuando está ALIMENTADO */
.plan-table td.cel-maq{
  font-weight:700;
}
.plan-table td.cel-alim{
  background:#f97316;
  color:#111827;
  font-weight:900;
}

/* Leyenda inferior */
.plan-legend{
  font-size:11px;
  color:#4b5563;
  padding:6px 8px 8px;
  display:flex;
  align-items:center;
  gap:10px;
}
.plan-pill{
  display:inline-block;
  width:14px;
  height:8px;
  border-radius:999px;
  border:1px solid #9ca3af;
  margin-right:3px;
}
.plan-pill--alim{
  background:#f97316;
  border-color:#c2410c;
}
.plan-pill--done{
  background:#e5e7eb;
  border-color:#9ca3af;
}

/* ==================== MASTER CONTROL TIME ==================== */
.mt-table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
  margin-top:10px;
}
.mt-table th,.mt-table td{
  border:1px solid #dde1e7;
  padding:6px 8px;
  text-align:center;
}
.mt-table thead{
  background:#f3f4f6;
}

.mt-card{
  border:1px solid var(--line);
  border-radius:12px;
  padding:12px;
  background:#fff;
}

.mt-card h3{
  margin-top:0;
  margin-bottom:6px;
}

.mt-box{
  display:flex;
  justify-content:space-between;
  padding:6px 0;
  font-weight:600;
  border-bottom:1px solid #e5e7eb;
}
.mt-box:last-child{
  border-bottom:none;
}
.mt-marcha{ color:#22c55e; }
.mt-restr{ color:#fbbf24; }
.mt-stop{ color:#ef4444; }
.mt-rep{ color:#3b82f6; }
</style>
</head>
<body>
<!-- =======================================================
     CABECERA
======================================================= -->
<header class="header" id="hdr" role="banner">
  <span id="roleChip">Invitado</span>
  <div class="h__in">
    <button class="hbtn" id="hamb" type="button" aria-label="Abrir menú" aria-controls="sidenav" aria-expanded="false">
      <span class="i"><span></span></span>
    </button>

    <a class="brand" aria-label="Inicio" href="#equipos">
      <img src="logo-cdl.png" alt="CDL" style="height:40px; margin-top:2px">
    </a>

    <button class="hbtn" id="moreBtn" type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="userPanel">
      <span class="i"></span>
    </button>
  </div>
</header>

<aside id="sidenav" aria-hidden="true" aria-label="Navegación principal">
  <div class="sidenav__search" style="align-items:center">
    <input id="globalSearch" placeholder="Buscar en la app…" aria-label="Buscar">
    <button id="goSearch" type="button" class="btn btn--ghost">Ir</button>
    <button id="closeNav" type="button" aria-label="Cerrar menú">✕</button>
  </div>

  <nav class="navlist" id="navList">
    <!-- Se llena en runtime -->
  </nav>
</aside>

<!-- =========================================================
     PANEL USUARIO
========================================================= -->
<section id="userPanel" role="dialog" aria-modal="true" aria-labelledby="upTitle">
  <div class="up__head">
    <h3 id="upTitle" style="margin:0">Acceso de usuario</h3>
    <button id="closeUser" type="button" class="btn btn--ghost" aria-label="Cerrar">✕</button>
  </div>

  <div class="up__row">
    <div class="up__field">
      <label for="roleSelect">Usuario / Rol</label>
      <select id="roleSelect"></select>
    </div>

    <div class="up__field">
      <label for="userPass">Contraseña</label>
      <div class="up__pwdwrap" style="display:flex;gap:8px;align-items:center">
        <input id="userPass" type="password" placeholder="Contraseña" autocomplete="current-password">
        <button class="eyeBtn" id="eyeMain" type="button" aria-label="Mostrar/Ocultar contraseña" title="Mostrar/Ocultar">
          <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
            <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z" fill="none" stroke="currentColor" stroke-width="2"/>
            <circle cx="12" cy="12" r="3.5" fill="currentColor"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <div class="up__actions">
    <button class="btn btn--primary" id="loginBtn" type="button">Acceder</button>
    <button class="btn btn--ghost" id="logoutBtn" type="button">Salir</button>
    <button class="link" id="togglePwdLink" type="button" aria-expanded="false" aria-controls="chgWrap">Cambiar contraseña</button>
  </div>

  <div id="chgWrap" hidden>
    <div class="up__row">
      <div class="up__field">
        <label for="chgOld">Actual</label>
        <div class="up__pwdwrap" style="display:flex;gap:8px;align-items:center">
          <input id="chgOld" type="password" placeholder="Contraseña actual" autocomplete="current-password">
          <button class="eyeBtn" id="eyeOld" type="button" aria-label="Mostrar/Ocultar contraseña actual" title="Mostrar/Ocultar">
            <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
              <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z" fill="none" stroke="currentColor" stroke-width="2"/>
              <circle cx="12" cy="12" r="3.5" fill="currentColor"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="up__field">
        <label for="chgNew">Nueva</label>
        <div class="up__pwdwrap" style="display:flex;gap:8px;align-items:center">
          <input id="chgNew" type="password" placeholder="Contraseña nueva" autocomplete="new-password">
          <button class="eyeBtn" id="eyeNew" type="button" aria-label="Mostrar/Ocultar contraseña nueva" title="Mostrar/Ocultar">
            <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
              <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z" fill="none" stroke="currentColor" stroke-width="2"/>
              <circle cx="12" cy="12" r="3.5" fill="currentColor"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <div class="up__actions">
      <button class="btn btn--ghost" id="chgBtn" type="button">Guardar</button>
    </div>
  </div>
</section>

<!-- =======================================================
     CONTENEDOR PRINCIPAL (páginas por hash)
======================================================= -->
<main class="main" id="appRoot" hidden data-role-min="prod">

  <!-- ==================== DASHBOARD (TV) ==================== -->
  <section id="dashboard" class="page" hidden aria-labelledby="dashTitle">
    <article class="hero">
      <h1 id="dashTitle"><span style="font-weight:900">DASHBOARD</span> <span class="badge">TV</span></h1>
      <div class="sub">Panel de control</div>
    </article>

    <div class="grid cols-3" style="margin-top:10px">
      <article class="card">
        <h2><span class="black">EQUIPOS EN</span> <span style="color:var(--brand)">PARADA</span> <span class="badge" id="countParadas">0</span></h2>
        <div id="dash-paradas"></div>
      </article>

      <article class="card">
        <h2><span class="black">EQUIPOS EN</span> <span style="color:var(--brand)">MARCHA CON RESTRICCIONES</span> <span class="badge" id="countRestr">0</span></h2>
        <div id="dash-restr"></div>
      </article>

      <article class="card">
        <h2><span class="black">ALERTAS</span> <span style="color:var(--brand)">STOCK</span> <span class="black">MÍNIMO</span> <span class="badge" id="countStock">0</span></h2>
        <div id="dash-stock"></div>
      </article>

      <article class="card">
        <h2><span class="black">CONSUMIBLES</span> <span style="color:var(--brand)">BAJO STOCK</span> <span class="badge" id="countConsLow">0</span></h2>
        <div id="dash-cons"></div>
      </article>

      <article class="card">
        <h2><span class="black">AVISOS</span> <span style="color:var(--brand)">SUBCONTRATAS</span> <span class="badge" id="countExt">0</span></h2>
        <div id="dash-externas"></div>
      </article>

      <article class="card">
        <h2><span class="black">SOLICITUDES</span> <span style="color:var(--brand)">PRIORITARIAS</span> <span class="badge" id="countReq">0</span></h2>
        <div id="dash-req"></div>
      </article>

      <article class="card" data-role="approveStop">
        <h2><span class="black">PARADAS</span> <span style="color:var(--brand)">PROGRAMADAS</span> <span class="black">PENDIENTES</span> <span class="badge" id="countPendStops">0</span></h2>
        <div id="dash-pendientes"></div>
      </article>
    </div>
  </section>

  <!-- ==================== PÁG. 0.5 PLANIFICACIÓN PRODUCCIÓN ==================== -->
  <section id="planificacion" class="page" hidden>
    <header class="page__header">
      <h1>Planificación</h1>
      <p class="page__subtitle">
        Hoja de planificación de producción (formato original papel, una fila por pedido).
      </p>
    </header>

    <div class="plan-wrap">
      <div class="plan-title-strip">
        <span>PLANIFICACIÓN</span>
      </div>

      <div class="plan-table-wrap">
        <table class="plan-table">
          <thead>
            <tr>
              <th class="col-maq">MAQUINA</th>
              <th class="col-input">INPUT</th>
              <th class="col-cliente">CLIENTE</th>
              <th class="col-deleg">DELEG</th>
              <th class="col-uds">UDS</th>
              <th class="col-kgs">KGS</th>
              <th class="col-output">OUTPUT</th>
              <th class="col-picking">PICKING</th>
              <th class="col-parte">PARTE</th>
              <th class="col-carga">CARGA</th>
              <th class="col-com">COMENTARIOS</th>
            </tr>
          </thead>
          <tbody id="planBody">
            <!-- Rellenado por loadPlanificacion() -->
          </tbody>
        </table>
        <p class="plan-legend">
          <span class="plan-pill plan-pill--alim"></span> Pedido alimentado
          <span class="plan-pill plan-pill--proc"></span> En proceso
          <span class="plan-pill plan-pill--done"></span> Pedido terminado
        </p>
      </div>
    </div>
  </section>

  <!-- ==================== PÁG. 1.0 PRODUCCIÓN (EQUIPOS) ==================== -->
  <section id="equipos" class="page" hidden aria-labelledby="equipTitle">
    <h1 id="equipTitle">
      Producción
      <button class="search-toggle" type="button" data-search="eq" aria-expanded="false">Buscar ▲▼</button>
    </h1>

    <p class="page-intro">
      Cada tarjeta representa un equipo productivo.
      El semáforo indica el estado:
      <strong>Verde</strong> = marcha ·
      <strong>Amarillo</strong> = marcha con restricciones ·
      <strong>Rojo</strong> = parada ·
      <strong>Azul</strong> = en reparación.
    </p>

    <article class="card" id="eqSearchCard" hidden>
      <form id="eqForm" class="form-inline" autocomplete="off">
        <label for="eqQuery" class="form-inline__label">Ficha técnica / QR</label>
        <input id="eqQuery" type="search" placeholder="Escribe ID o nombre… (ej: KDP-1)">
        <select id="eqSelect" aria-label="Seleccionar equipo">
          <option value="">— Selecciona de la lista —</option>
        </select>
        <button type="submit" class="btn btn--primary">Ver ficha</button>
      </form>
    </article>

    <h3 style="margin-top:10px">Línea Kaltenbach (sierras + taladros + alimentación)</h3>
    <div class="grid grid-eq" id="equiposKaltenbach"></div>

    <h3>Láser Trumpf</h3>
    <div class="grid grid-eq" id="equiposTrumpf"></div>

    <h3>Otras máquinas independientes</h3>
    <div class="grid grid-eq" id="equiposIndep"></div>
  </section>

  <!-- ==================== PÁG. 2.0 PUENTES GRÚA ==================== -->
  <section id="gruas" class="page" hidden aria-labelledby="grTitle">
    <h1 id="grTitle">
      Puentes grúa
      <button class="search-toggle" type="button" data-search="gr" aria-expanded="false">Buscar ▲▼</button>
    </h1>

    <p class="page-intro">
      Cada tarjeta representa un puente grúa.
      El semáforo indica el estado en tiempo real comunicado por producción y mantenimiento.
    </p>

    <article class="card" id="grSearchCard" hidden>
      <form id="grForm" class="form-inline" autocomplete="off">
        <label for="grQuery" class="form-inline__label">Ficha de grúa</label>
        <input id="grQuery" type="search" placeholder="Escribe ID de grúa… (ej: G-1)">
        <select id="grSelect" aria-label="Seleccionar puente grúa">
          <option value="">— Selecciona —</option>
        </select>
        <button type="submit" class="btn btn--primary">Ver ficha</button>
      </form>
    </article>

    <h3 style="margin-top:10px">Nave 1</h3>
    <div class="grid grid-eq" id="grN1"></div>

    <h3>Nave 2</h3>
    <div class="grid grid-eq" id="grN2"></div>

    <h3>Nave 3</h3>
    <div class="grid grid-eq" id="grN3"></div>

    <h3>Nave 4</h3>
    <div class="grid grid-eq" id="grN4"></div>
  </section>

  <!-- ==================== PÁG. 3.0 AUXILIARES ==================== -->
  <section id="auxiliares" class="page" hidden aria-labelledby="auxTitle">
    <h1 id="auxTitle">
      Auxiliares (Otros)
      <button class="search-toggle" type="button" data-search="ax" aria-expanded="false">Buscar ▼</button>
    </h1>

    <article class="card" id="axSearchCard" hidden>
      <form id="axForm" class="form-inline" autocomplete="off">
        <label for="axQuery" class="form-inline__label">Ficha auxiliar</label>
        <input id="axQuery" type="search" placeholder="Escribe ID o nombre…">
        <select id="axSelect" aria-label="Seleccionar auxiliar">
          <option value="">— Selecciona —</option>
        </select>
        <button type="submit" class="btn btn--primary">Ver ficha</button>
      </form>
    </article>

    <div class="grid grid-eq" id="auxList"></div>
  </section>

  <!-- ==================== PÁG. 4.0 INCIDENCIAS ==================== -->
  <section id="incidencias" class="page" hidden aria-labelledby="incTitle">
    <h1 id="incTitle">Incidencias</h1>

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
      <button class="btn btn--primary" id="btnNewInc" type="button">Nueva incidencia</button>
      <button class="btn btn--dark" id="btnProgParada" type="button">Programar parada</button>
      <button class="btn btn--ghost" id="incToggleSearch" type="button" aria-expanded="false" aria-controls="incSearchCard">Buscar ▼</button>
    </div>

    <article class="card" id="incSearchCard" hidden>
      <form id="incFilterForm" class="form-inline" autocomplete="off">
        <label for="incEquipo" class="form-inline__label">Equipo</label>
        <input id="incEquipo" list="incEquipList" placeholder="Escribe número o nombre… (ej: 1 Sierra KBS)">
        <datalist id="incEquipList"></datalist>

        <label for="incFecha" class="form-inline__label">Fecha creación</label>
        <input id="incFecha" type="date">

        <label for="incTexto" class="form-inline__label">Texto</label>
        <input id="incTexto" type="search" placeholder="palabras clave" style="text-transform:none">

        <button type="submit" class="btn btn--ghost">Aplicar</button>
        <button type="button" class="btn btn--ghost" id="incClear">Limpiar</button>
      </form>
    </article>

    <article class="card">
      <div id="incLogosWrap" class="inc-logos">
        <button type="button" class="inc-logo" data-marca="kaltenbach" title="Kaltenbach">
          <img src="./img/Carousel/kaltenbach.webp" alt="Kaltenbach">
        </button>
        <button type="button" class="inc-logo" data-marca="trumpf" title="Trumpf">
          <img src="./img/Carousel/trumpf.webp" alt="Trumpf">
        </button>
        <button type="button" class="inc-logo" data-marca="gruas" title="Puentes grúa">
          <img src="logo_mantenimiento.png" alt="Puentes grúa">
        </button>
        <button type="button" class="inc-logo" data-marca="hgg" title="HGG">
          <img src="./img/Carousel/hgg.webp" alt="HGG">
        </button>
        <button type="button" class="inc-logo" data-marca="tecoi" title="Tecoi">
          <img src="./img/Carousel/tecoi.webp" alt="Tecoi">
        </button>
        <button type="button" class="inc-logo" data-marca="mazak" title="Mazak">
          <img src="./img/Carousel/mazak.webp" alt="Mazak">
        </button>
        <button type="button" class="inc-logo" id="incShowAux" title="Auxiliares">AUXILIARES</button>
      </div>
      <div id="incCatList" class="inc-listado" hidden></div>
    </article>

    <article class="card" id="incAddRestr" hidden>
      <h2>Añadir restricciones</h2>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr))">
        <div><label>Equipo</label><input id="resEq" placeholder="ID equipo"></div>
        <div><label>Detalle</label><input id="resDet" placeholder="Describe la restricción"></div>
      </div>
      <div style="margin-top:10px">
        <button class="btn btn--primary" id="resGuardar" type="button">Guardar restricción</button>
      </div>
    </article>

    <div id="incList" class="grid" style="grid-template-columns:1fr"></div>
  </section>

  <!-- ==================== PÁG. 5.0 OT ==================== -->
  <section id="ot" class="page" hidden aria-labelledby="otTitle">
    <h1 id="otTitle">Órdenes de trabajo</h1>

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
      <button class="btn btn--primary" id="otCrear" type="button">Crear OT</button>
      <button class="btn btn--ghost" id="otReload" type="button">Actualizar</button>
      <button class="btn btn--ghost" id="otHist" type="button">Historial</button>
    </div>

    <article class="card">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
        <div><label>Equipo</label><input id="otEq" list="eqList" placeholder="ID equipo"></div>
        <div><label>Tipo</label>
          <select id="otTipo"><option>Preventivo</option><option>Correctivo</option><option>Mejora</option></select>
        </div>
        <div><label>Fecha</label><input id="otFecha" type="date"></div>
        <div style="grid-column:1/-1"><label>Tarea</label><input id="otTarea" placeholder="Descripción de la OT"></div>
      </div>
    </article>

    <article class="card">
      <div class="form-inline">
        <label for="otFilter" class="form-inline__label">Filtrar</label>
        <input id="otFilter" type="search" placeholder="Buscar por equipo o tarea…">
      </div>
    </article>

    <div id="otList" class="grid" style="grid-template-columns:1fr"></div>
    <datalist id="eqList"></datalist>
  </section>

  <!-- ==================== PÁG. 6.0 REPUESTOS ==================== -->
  <section id="repuestos" class="page" hidden aria-labelledby="repTitle">
    <h1 id="repTitle">Repuestos</h1>

    <article class="card">
      <h2>Solicitar repuesto</h2>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
        <div><label>Nombre</label><input id="repNombre" placeholder="Ej: Rodamiento 6204"></div>
        <div><label>Referencia</label><input id="repRef" placeholder="REF/ID"></div>
        <div><label>Unidades</label><input id="repQty" type="number" value="1" min="1"></div>
        <div><label>Equipo</label><input id="repEq" placeholder="ID equipo (opcional)"></div>
        <div><label>Urgencia</label>
          <select id="repUrg"><option value="">—</option><option value="urgente">Urgente</option><option value="proxima">Necesidad próxima</option></select>
        </div>
        <div style="grid-column:1/-1"><label>Observaciones</label><input id="repObs" placeholder="Notas"></div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn--primary" id="repSend" type="button">Solicitar</button>
        <button class="btn btn--ghost" id="repClear" type="button">Limpiar</button>
      </div>
    </article>

    <article class="card">
      <h2>Listado (estado)</h2>
      <div id="reqList" class="grid" style="grid-template-columns:1fr"></div>
    </article>
  </section>

  <!-- ==================== PÁG. 7.0 INVENTARIO ==================== -->
  <section id="inventario" class="page" hidden aria-labelledby="invTitle">
    <h1 id="invTitle">Inventario</h1>

    <article class="card">
      <form id="invSearchForm" class="form-inline" autocomplete="off">
        <label for="invQuery" class="form-inline__label">Buscar</label>
        <input id="invQuery" type="search" placeholder="ref / desc / código">
        <button class="btn btn--ghost" type="submit">Filtrar</button>
        <button class="btn btn--ghost" type="button" id="invClear">Limpiar</button>
        <span style="margin-left:auto" data-role="admin">
          <label class="form-inline__label" for="csvUp">CSV/QRs</label>
          <input id="csvUp" type="file" accept=".csv,.txt" style="max-width:240px">
        </span>
      </form>
    </article>

    <article class="card">
      <h2>Alertas stock mínimo</h2>
      <div id="invAlerts"></div>
    </article>

    <div id="invCats" class="grid" style="grid-template-columns:1fr"></div>
  </section>

  <!-- ==================== PÁG. 8.0 SUBCONTRATAS ==================== -->
  <section id="subcontratas" class="page" hidden aria-labelledby="subTitle">
    <h1 id="subTitle">Subcontratas</h1>

    <article class="card">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn--primary" id="subNew" type="button">Solicitar subcontrata</button>
        <button class="btn btn--ghost" id="subDel" type="button">Eliminar solicitud</button>
      </div>
      <p style="color:#64748b;margin:.5rem 0">* En este prototipo, el flujo se refleja en el Dashboard y en el Registro como avisos.</p>
    </article>

    <article class="card">
      <h2>Pendientes</h2>
      <div id="subPend" class="grid" style="grid-template-columns:1fr"></div>
    </article>

    <article class="card">
      <h2>Histórico</h2>
      <div id="subHist" class="grid" style="grid-template-columns:1fr"></div>
    </article>
  </section>

  <!-- ==================== PÁG. 9.0 INDICADORES (KPIs) ==================== -->
  <section id="indicadores" class="page" hidden aria-labelledby="kpiTitle">
    <h1 id="kpiTitle">KPIs</h1>
    <article class="card">
      <canvas id="chMtbf" width="720" height="320"></canvas>
      <div style="font-size:12px;color:#64748b;margin-top:6px">MTBF: tiempo medio entre fallos. Escala 0–100.</div>
    </article>
    <article class="card">
      <canvas id="chMttr" width="720" height="320"></canvas>
      <div style="font-size:12px;color:#64748b;margin-top:6px">MTTR: tiempo medio de reparación. Escala 0–100 (menor es mejor).</div>
    </article>
    <article class="card">
      <canvas id="chDisp" width="720" height="320"></canvas>
      <div style="font-size:12px;color:#64748b;margin-top:6px">Disponibilidad: % operativo. Escala 0–100.</div>
    </article>
  </section>

  <!-- ==================== PÁG. 9.5 MASTER CONTROL TIME ==================== -->
  <section id="mastertime" class="page" hidden aria-labelledby="mtTitle">
    <h1 id="mtTitle">Master Control Time</h1>

    <article class="card">
      <p class="page-intro">
        Resumen de horas por equipo y detalle de tramos de estado
        (marcha, restricciones, parada, reparación). Solo lectura, pensado
        para responsable de mantenimiento y KPIs.
      </p>
    </article>

    <article class="card">
      <h2>Resumen por equipo</h2>
      <p style="font-size:12px;color:#64748b;margin-bottom:6px">
        Horas acumuladas por estado. La disponibilidad estimada se calcula como
        <strong>(marcha + restricciones) / total</strong>.
      </p>
      <div style="overflow:auto">
        <table class="tablaprod">
          <thead>
            <tr>
              <th>Equipo</th>
              <th>Marcha (h)</th>
              <th>Restricción (h)</th>
              <th>Parada (h)</th>
              <th>Reparación (h)</th>
              <th>Total (h)</th>
              <th>% Disp.</th>
            </tr>
          </thead>
          <tbody id="mtSummaryBody">
            <!-- Rellenado por loadMasterTime() -->
          </tbody>
        </table>
      </div>
    </article>

    <article class="card">
      <h2>Detalle de tramos</h2>

      <form id="mtFilterForm" class="form-inline" autocomplete="off" style="margin-bottom:8px">
        <label for="mtEqFilter" class="form-inline__label">Equipo</label>
        <input id="mtEqFilter" type="search" placeholder="ID o nombre…">

        <label for="mtDateFilter" class="form-inline__label">Fecha</label>
        <input id="mtDateFilter" type="date">

        <label for="mtEstadoFilter" class="form-inline__label">Estado</label>
        <input id="mtEstadoFilter" type="search" placeholder="marcha / restricción / parada / reparación">

        <button type="submit" class="btn btn--ghost">Aplicar</button>
        <button type="button" class="btn btn--ghost" id="mtClearFilters">Limpiar</button>
      </form>

      <div style="overflow:auto">
        <table class="tablaprod">
          <thead>
            <tr>
              <th>Fecha / tramo</th>
              <th>Equipo</th>
              <th>Estado</th>
              <th>Horas</th>
              <th>Motivo / detalle</th>
            </tr>
          </thead>
          <tbody id="mtDetailBody">
            <!-- Rellenado por loadMasterTime() + filtros -->
          </tbody>
        </table>
      </div>

      <p style="font-size:12px;color:#64748b;margin-top:6px">
        Los tramos se alimentarán automáticamente desde los cambios de estado
        del semáforo y las incidencias.
      </p>
    </article>
  </section>

  <!-- ==================== PÁG. 10.0 DASHBOARD TV ==================== -->
  <section id="dashboardtv" class="page" hidden aria-labelledby="dbTitle">
    <div id="carousel" class="card" style="overflow:hidden">
      <div id="carouselTrack" style="display:flex;gap:0;transition:transform .6s ease">
        <img src="./img/Carousel/corte.webp"      alt="Corte"      style="width:100%;flex:0 0 100%;object-fit:cover;max-height:340px">
        <img src="./img/Carousel/kaltenbach.webp"  alt="Kaltenbach" style="width:100%;flex:0 0 100%;object-fit:cover;object-position:center center;max-height:320px">
        <img src="./img/Carousel/trumpf.webp"      alt="Trumpf"     style="width:100%;flex:0 0 100%;object-fit:cover;max-height:340px">
        <img src="./img/Carousel/hgg.webp"         alt="HGG"        style="width:100%;flex:0 0 100%;object-fit:cover;max-height:340px">
        <img src="./img/Carousel/tecoi.webp"       alt="Tecoi"      style="width:100%;flex:0 0 100%;object-fit:cover;max-height:340px">
        <img src="./img/Carousel/mazak.webp"       alt="Mazak"      style="width:100%;flex:0 0 100%;object-fit:cover;max-height:340px">
      </div>
    </div>

    <div class="dbtv-tag">Dashboard TV</div>

    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));margin-top:10px">
      <article class="card"><strong>Equipos en parada</strong><div id="dbParada" class="badge">0</div></article>
      <article class="card"><strong>Equipos en marcha con restricciones</strong><div id="dbRestr" class="badge">0</div></article>
      <article class="card"><strong>Repuestos pendientes de llegada</strong><div id="dbPendLleg" class="badge">0</div></article>
      <article class="card"><strong>Solicitudes de repuesto pendientes</strong><div id="dbRepPend" class="badge">0</div></article>
      <article class="card"><strong>Consumibles con stock crítico</strong><div id="dbConsCrit" class="badge">0</div></article>
      <article class="card"><strong>Llegadas de subcontratas</strong><div id="dbSubc" class="badge">0</div></article>
      <article class="card"><strong>Alertas stock mínimo</strong><div id="dbInvMin" class="badge">0</div></article>
    </div>

    <details class="card" open>
      <summary><strong>1) Equipos en parada</strong> <small id="sumParada" style="color:#64748b"></small></summary>
      <div id="listParada"></div>
    </details>

    <details class="card">
      <summary><strong>2) Equipos en marcha con restricciones</strong> <small id="sumRestr" style="color:#64748b"></small></summary>
      <div id="listRestr"></div>
    </details>

    <details class="card">
      <summary><strong>3) Repuestos pendientes de llegada</strong> <small id="sumPendLleg" style="color:#64748b"></small></summary>
      <div id="listPendLleg"></div>
    </details>

    <details class="card">
      <summary><strong>4) Solicitudes de repuesto pendientes</strong> <small id="sumRepPend" style="color:#64748b"></small></summary>
      <div id="listRepPend"></div>
    </details>

    <details class="card">
      <summary><strong>5) Consumibles con stock crítico</strong> <small id="sumConsCrit" style="color:#64748b"></small></summary>
      <div id="listConsCrit"></div>
    </details>

    <details class="card">
      <summary><strong>6) Llegadas de subcontratas</strong> <small id="sumSubc" style="color:#64748b"></small></summary>
      <div id="listSubc"></div>
    </details>

    <details class="card">
      <summary><strong>7) Alertas stock mínimo</strong> <small id="sumInvMin" style="color:#64748b"></small></summary>
      <div id="listInvMin"></div>
    </details>

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
      <button class="btn btn--ghost" id="dbRefresh" type="button">Actualizar</button>
    </div>
  </section>

  <!-- ==================== REGISTRO (LOGS) ==================== -->
  <section id="registro" class="page" hidden aria-labelledby="regTitle">
    <h1 id="regTitle">Registro</h1>

    <article class="card">
      <form id="regForm" class="form-inline" autocomplete="off">
        <label class="form-inline__label" for="regQ">Buscar</label>
        <input id="regQ" type="search" placeholder="por acción, objeto, usuario…">
        <label class="form-inline__label" for="regF">Fecha</label>
        <input id="regF" type="date">
        <button class="btn btn--ghost" type="submit">Filtrar</button>
        <button class="btn btn--ghost" type="button" id="regClr">Limpiar</button>
      </form>
    </article>

    <div id="regList" class="grid" style="grid-template-columns:1fr"></div>
  </section>

  <!-- ==================== MODALES COMPARTIDOS ==================== -->
  <div id="modalBg" style="position:fixed;inset:0;background:rgba(0,0,0,0.45);backdrop-filter:blur(2px);display:none;z-index:900"></div>
  <div id="modalCard" style="position:fixed;left:50%;top:10dvh;transform:translateX(-50%);width:min(980px,92vw);background:#0f141c;color:#e6eef7;border:1px solid #223046;border-radius:16px;box-shadow:0 20px 36px rgba(0,0,0,.45);padding:14px;display:none;z-index:950">
    <header style="display:flex;justify-content:space-between;align-items:center;gap:10px">
      <h3 id="modalT" style="margin:0">Detalle</h3>
      <button id="modalX" type="button" class="btn btn--ghost">Cerrar</button>
    </header>
    <div id="modalC" style="max-height:min(68dvh,620px);overflow:auto;margin-top:8px"></div>
  </div>

  <datalist id="eqAll"></datalist>
</main>
<section class="hero-carousel" aria-label="Fotos de producción" id="dashCarousel">
  <div class="carousel-track" id="hcTrack">
    <div class="carousel-slide"><img src="./img/Carousel/corte.webp" alt="Corte"></div>
    <div class="carousel-slide"><img src="./img/Carousel/kaltenbach.webp" alt="Kaltenbach"></div>
    <div class="carousel-slide"><img src="./img/Carousel/trumpf.webp" alt="Trumpf"></div>
    <div class="carousel-slide"><img src="./img/Carousel/hgg.webp" alt="HGG"></div>
    <div class="carousel-slide"><img src="./img/Carousel/tecoi.webp" alt="Tecoi"></div>
    <div class="carousel-slide"><img src="./img/Carousel/mazak.webp" alt="Mazak"></div>
  </div>
  <button class="carousel-ctrl carousel-prev" id="hcPrev" type="button" aria-label="Anterior" aria-controls="hcTrack">
    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"><path d="M15 18l-6-6 6-6"/></svg>
  </button>
  <button class="carousel-ctrl carousel-next" id="hcNext" type="button" aria-label="Siguiente" aria-controls="hcTrack">
    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"><path d="M9 6l6 6-6 6"/></svg>
  </button>
  <div class="carousel-dots" id="hcDots" aria-label="Indicadores"></div>
</section>

<footer style="text-align:center;color:#64748b;font-size:12px;margin:2rem 0 1rem">
  © CDL — Sistema de Mantenimiento · PWA
</footer>

 <script>
/* ========= API base ========= */
window.API_BASE = "https://script.google.com/macros/s/AKfycbylcSwPb9mVmIAvwJUJMPPp1Dy-Z8YeQoiaFluwrkEIN2HnegOoet0hJq4X_SAH0FZM/exec";
const API_BASE      = window.API_BASE;
const CDL_TOKEN_KEY = "cdl_token";
const CDL_ROLE_KEY  = "cdl_role";

 /* =========================================================
   ROLES SIMPLIFICADOS
   - invitado      → solo lectura
   - produccion    → datos útiles de producción + inventario/repuestos
   - compras       → gestión pedidos
   - mantenimiento → acceso total (OT, KPIs, etc.)
========================================================= */
const ROLES = [
  { slug:"invitado",      label:"Invitado",                perms:[] },
  { slug:"produccion",    label:"Producción",              perms:["viewEquipos","viewPlanificacion","viewInventario","viewRepuestos"] },
  { slug:"compras",       label:"Responsable de compras",  perms:["viewEquipos","viewPlanificacion","viewInventario","viewRepuestos","approvePedido","updatePedido"] },
  { slug:"mantenimiento", label:"Mantenimiento",           perms:["viewEquipos","viewPlanificacion","viewInventario","viewRepuestos","approveStop","verKPIs","viewIncidencias","viewOT","viewSubcontratas","viewMasterTime","full"] }
];
function roleLabel(slug){
  const r = ROLES.find(x=>x.slug === slug);
  return r ? r.label : "Invitado";
}

function currentRoleSlug(){
  const saved = localStorage.getItem(CDL_ROLE_KEY) || "invitado";
  return ROLES.some(r=>r.slug === saved) ? saved : "invitado";
}

/**
 * roleCan('approveStop') → solo mantenimiento
 * roleCan('verKPIs')     → solo mantenimiento
 */
function roleCan(perm){
  const slug = currentRoleSlug();
  const r = ROLES.find(x=>x.slug === slug);
  if (!r || !Array.isArray(r.perms)) return false;
  // Permiso total (solo mantenimiento)
  if (r.perms.includes("full")) return true;
  return r.perms.includes(perm);
}

const GET  = async (p)=>{
  const r = await fetch(`${API_BASE}?path=${encodeURIComponent(p)}`, { cache:"no-store" });
  try{ return await r.json(); }catch{ return []; }
};
const POST = async (body)=>{
  const r = await fetch(API_BASE, {
    method:"POST",
    headers:{"Content-Type":"text/plain;charset=utf-8"},
    body:JSON.stringify(body),
    cache:"no-store"
  });
  try{ return await r.json(); }catch{ return {ok:false}; }
};

/* ========= Panel usuario: login / logout / cambiar pass ========= */
(function(){
  const roleChip  = document.getElementById("roleChip");
  const userPanel = document.getElementById("userPanel");
  const moreBtn   = document.getElementById("moreBtn");
  const closeUser = document.getElementById("closeUser");
  const roleSel   = document.getElementById("roleSelect");
  const userPass  = document.getElementById("userPass");
  const loginBtn  = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const eyeMain   = document.getElementById("eyeMain");

  const togglePwdLink = document.getElementById("togglePwdLink");
  const chgWrap  = document.getElementById("chgWrap");
  const chgBtn   = document.getElementById("chgBtn");
  const chgOld   = document.getElementById("chgOld");
  const chgNew   = document.getElementById("chgNew");
  const eyeOld   = document.getElementById("eyeOld");
  const eyeNew   = document.getElementById("eyeNew");

  // ✅ Guard: si falta el panel (por ejemplo en vistas “TV” o páginas recortadas), no rompas todo el JS
  const required = [roleChip,userPanel,moreBtn,closeUser,roleSel,userPass,loginBtn,logoutBtn,eyeMain];
  if (required.some(x=>!x)) return;

  roleSel.innerHTML = ROLES.map(r => `<option value="${r.slug}">${r.label}</option>`).join("");

  function ucFirst(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1).replace(/_/g," ") : s; }

  (function initRoleChip(){
    const tok = localStorage.getItem(CDL_TOKEN_KEY);
    const savedRole = localStorage.getItem(CDL_ROLE_KEY);
    roleChip.textContent = (tok && savedRole) ? ucFirst(savedRole) : "Invitado";
  })();

  const togglePanel = (show)=>{
    userPanel.classList.toggle("show", show);
    moreBtn.setAttribute("aria-expanded", show ? "true" : "false");
  };

  moreBtn.addEventListener("click", (e)=>{ e.stopPropagation(); togglePanel(!userPanel.classList.contains("show")); });
  closeUser.addEventListener("click", ()=> togglePanel(false));
  document.addEventListener("click", (e)=>{
    if (userPanel.classList.contains("show") && !userPanel.contains(e.target) && !moreBtn.contains(e.target)) togglePanel(false);
  });

  const toggleType = (inp)=> inp.type = (inp.type==="password") ? "text" : "password";
  eyeMain.addEventListener("click", (e)=>{ e.preventDefault(); toggleType(userPass); });
  eyeOld?.addEventListener("click", (e)=>{ e.preventDefault(); toggleType(chgOld); });
  eyeNew?.addEventListener("click", (e)=>{ e.preventDefault(); toggleType(chgNew); });

  loginBtn.addEventListener("click", async ()=>{
    const user = roleSel.value;
    const pass = (userPass.value||"").trim();
    if(!pass){ alert("Introduce la clave."); return; }
    try{
      const r = await POST({res:"auth", fn:"login", user, pass});
      if(r.ok && r.token){
        localStorage.setItem(CDL_TOKEN_KEY, r.token);
        localStorage.setItem(CDL_ROLE_KEY, user);
        roleChip.textContent = roleLabel(user);
        userPass.value = "";
        togglePanel(false);
        applyRoleVisibility();
      }else alert(r.error || "Contraseña incorrecta.");
    }catch{ alert("Error de red."); }
  });

  logoutBtn.addEventListener("click", ()=>{
    localStorage.removeItem(CDL_TOKEN_KEY);
    localStorage.removeItem(CDL_ROLE_KEY);
    roleChip.textContent = roleLabel("invitado");
    applyRoleVisibility();
  });

  togglePwdLink?.addEventListener("click", ()=>{
    if(!chgWrap) return;
    const open = chgWrap.hasAttribute("hidden");
    if(open){ chgWrap.removeAttribute("hidden"); } else { chgWrap.setAttribute("hidden",""); }
    togglePwdLink.setAttribute("aria-expanded", String(open));
  });

  chgBtn?.addEventListener("click", async ()=>{
    const tok  = localStorage.getItem(CDL_TOKEN_KEY)||"";
    const oldP = (chgOld?.value||"").trim();
    const newP = (chgNew?.value||"").trim();
    if(!oldP || !newP){ alert("Rellena Actual y Nueva."); return; }
    try{
      const r = await POST({res:"auth", fn:"change", token:tok, old:oldP, neu:newP});
      if(r.ok){
        alert("Contraseña cambiada.");
        if(chgOld) chgOld.value="";
        if(chgNew) chgNew.value="";
        chgWrap?.setAttribute("hidden",""); togglePwdLink?.setAttribute("aria-expanded","false");
      }else alert(r.error || "No se pudo cambiar.");
    }catch{ alert("Error de red."); }
  });

  // Aplica visibilidad inicial por rol al cargar
  document.addEventListener("DOMContentLoaded", applyRoleVisibility);
})();

/* ========= Service Worker (PWA) ========= */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js");
  navigator.serviceWorker.ready.then(reg => {
    if (reg && reg.waiting) reg.waiting.postMessage({ type: "SKIP_WAITING" });
    reg.addEventListener("updatefound", () => {
      const nw = reg.installing;
      if (!nw) return;
      nw.addEventListener("statechange", () => {
        if (nw.state === "installed" && reg.waiting) {
          reg.waiting.postMessage({ type: "SKIP_WAITING" });
        }
      });
    });
  });
  let refreshed = false;
  navigator.serviceWorker.addEventListener("controllerchange", () => {
    if (refreshed) return;
    refreshed = true;
    location.reload();
  });
}

/* ========= Importación automática de repuestos.csv (cola + reintentos) — UNIFICADO ========= */
(function(){
  const CSV_PATH          = "./repuestos.csv";
  const CSV_IMPORTED_KEY  = "inv_csv_imported";
  const CSV_QUEUE_KEY     = "inv_csv_queue";

  const hasToken     = ()=> !!(localStorage.getItem(CDL_TOKEN_KEY)||"");
  const onInventario = ()=> (location.hash||"#dashboard") === "#inventario";

  const stripBOM = (s)=> (s||"").replace(/^\uFEFF/, "");
  const detectDelim = (s)=>{
    const comma = (s.match(/,/g)||[]).length;
    const semi  = (s.match(/;/g)||[]).length;
    return semi > comma ? ";" : ",";
  };

  function parseCSV(txt){
    const lines = (txt||"").split(/\r?\n/).filter(l=>l.trim().length);
    if(!lines.length) return { headers:[], items:[] };

    const headLine = stripBOM(lines.shift());
    const delim = detectDelim(headLine);
    const headers = headLine.split(delim).map(h=>stripBOM(h).trim().toLowerCase());

    const normNum = v => Number(String(v??"0").replace(",", ".")) || 0;

    const items = lines.map(line=>{
      const cols = line.split(delim).map(c=>c.trim());
      const o = {}; headers.forEach((h,i)=> o[h] = cols[i] ?? "");
      const ref   = o.ref || o.referencia || o.codigo || "";
      const desc  = o.desc || o.descripcion || o.nombre || "";
      if(!ref && !desc) return null;
      return {
        ref,
        codigo: o.codigo || ref,
        desc,
        stock: normNum(o.stock),
        min:   normNum(o.min || o["stock_min"]),
        categoria: o.categoria || "General",
        subcategoria: o.subcategoria || "Sin subcategoría",
        ubicacion: o.ubicacion || "",
        unidad: o.unidad || ""
      };
    }).filter(Boolean);

    return { headers, items };
  }

  async function importNow(items){
    const token = localStorage.getItem(CDL_TOKEN_KEY) || "";
    try{
      const r = await fetch(API_BASE, {
        method:"POST",
        headers:{"Content-Type":"text/plain;charset=utf-8"},
        cache:"no-store",
        body: JSON.stringify({ res:"inv", fn:"import", token, items })
      }).then(x=>x.json()).catch(()=>({ok:false}));
      return (r && r.ok) ? (r.importados ?? items.length) : 0;
    }catch{
      return 0;
    }
  }

  async function flushCSVQueue(){
    if(localStorage.getItem(CSV_IMPORTED_KEY) === "1") return;
    const q = JSON.parse(localStorage.getItem(CSV_QUEUE_KEY) || "[]");
    if(!q.length) return;
    if(!hasToken()) return;

    const n = await importNow(q);
    if(n > 0){
      localStorage.setItem(CSV_IMPORTED_KEY, "1");
      localStorage.removeItem(CSV_QUEUE_KEY);
      if(onInventario() && typeof invLoad === "function") invLoad();
    }
  }

  async function autoImportCSVInicial(){
    try{
      if (localStorage.getItem(CSV_IMPORTED_KEY) === "1") return;

      const res = await fetch(CSV_PATH, { cache:"no-store" });
      if (!res.ok) return;
      const txt = await res.text();
      const { items } = parseCSV(txt);
      if (!items.length) return;

      if (hasToken()){
        const n = await importNow(items);
        if(n > 0){
          localStorage.setItem(CSV_IMPORTED_KEY,"1");
          if (onInventario() && typeof invLoad === "function") invLoad();
          return;
        }
      }else{
        localStorage.setItem(CSV_QUEUE_KEY, JSON.stringify(items));
      }
    }catch(_err){}
  }

  autoImportCSVInicial();
  document.addEventListener("DOMContentLoaded", flushCSVQueue);
  window.addEventListener("hashchange", flushCSVQueue, { passive:true });

  let tries = 0;
  const iv = setInterval(async ()=>{
    if(localStorage.getItem(CSV_IMPORTED_KEY) === "1" || (++tries > 30)){
      clearInterval(iv);
      return;
    }
    await flushCSVQueue();
  }, 1500);

  window.addEventListener("storage", (e)=>{
    if(e.key === CDL_TOKEN_KEY) flushCSVQueue();
  });
})();

/* ========= Carga mínima del Dashboard ========= */
async function loadDashboardMain(){
  try{
    const cons = await GET("consumibles");
    const lows = (cons||[]).filter(i=>Number(i.stock)<=Number(i.min));
    document.getElementById("countConsLow").textContent = lows.length;
    document.getElementById("dash-cons").innerHTML = lows.slice(0,5).map(i=>`<div class="badge">${i.ref||i.nombre} · Stock ${i.stock}</div>`).join("");

    const reqs = await GET("repuestos");
    document.getElementById("countReq").textContent = (reqs||[]).filter(r=>String(r.estado||"").toLowerCase()==="pendiente").length;

    const pend = await GET("paradas_programadas_pendientes");
    const cont = document.getElementById("dash-pendientes");
    const cnt  = document.getElementById("countPendStops");
    if(Array.isArray(pend) && pend.length){
      cont.innerHTML = pend.map(p=>`
        <div style="display:grid;grid-template-columns:1fr auto;align-items:center;gap:8px;margin:6px 0;padding:10px;border:1px dashed var(--line);border-radius:12px">
          <div><strong>${p.equipo||"-"}</strong><div style="color:#64748b;font-size:12px">${p.fecha||""} · ${p.motivo||""}</div></div>
          <div style="display:flex;gap:6px">
            <button class="btn btn--ghost" type="button" data-pp-aceptar="${p.id}">Aprobar</button>
            <button class="btn btn--ghost" type="button" data-pp-rechazar="${p.id}">Rechazar</button>
          </div>
        </div>`).join("");
      cnt.textContent = pend.length;
    }else{
      cont.innerHTML = '<div style="color:#64748b">No hay solicitudes pendientes.</div>';
      cnt.textContent = 0;
    }
  }catch(_e){}
}
document.addEventListener("DOMContentLoaded", loadDashboardMain);

document.addEventListener("click", async (e)=>{
  const tok = localStorage.getItem(CDL_TOKEN_KEY)||"";
  const ap = e.target.closest("[data-pp-aceptar]");
  const rc = e.target.closest("[data-pp-rechazar]");
  if(ap && roleCan("approveStop")){
    const id = ap.getAttribute("data-pp-aceptar");
    await POST({res:"stop", fn:"set", token:tok, id, estado:"Aprobada", comentario:""});
    loadDashboardMain();
  }
  if(rc && roleCan("approveStop")){
    const id = rc.getAttribute("data-pp-rechazar");
    await POST({res:"stop", fn:"set", token:tok, id, estado:"Rechazada", comentario:""});
    loadDashboardMain();
  }
});

/* ========= Carrusel portada (autoplay control) ========= */
let __hc = { start:()=>{}, stop:()=>{} };
function initHomeCarousel(){
  const track = document.getElementById("hcTrack"); if(!track) return;
  if (track.__inited) return;
  track.__inited = true;

  const prev  = document.getElementById("hcPrev");
  const next  = document.getElementById("hcNext");
  const dotsWrap = document.getElementById("hcDots");

  const slides = [...track.children];
  let idx = 0, timer=null, startX=0, dx=0, dragging=false;
  const AUTO_MS = 1800;

  if (dotsWrap){
    dotsWrap.innerHTML = slides.map((_,i)=>`<button type="button" aria-label="Ir a ${i+1}" ${i===0?'aria-current="true"':''}></button>`).join("");
  }
  const dots = dotsWrap ? [...dotsWrap.children] : [];

  function cueFade(){
    track.classList.add("is-fading");
    window.clearTimeout(track._fadeT);
    track._fadeT = window.setTimeout(()=> track.classList.remove("is-fading"), 320);
  }
  function goTo(i){
    idx=(i+slides.length)%slides.length;
    track.style.transition="transform .25s ease";
    track.style.transform=`translateX(${-100*idx}%)`;
    dots.forEach((d,k)=> d.setAttribute("aria-current", k===idx ? "true":"false"));
    cueFade();
  }
  function start(){ stop(); timer=setInterval(()=>{ goTo(idx+1); }, AUTO_MS); }
  function stop(){ if(timer){clearInterval(timer); timer=null;} }

  track.addEventListener("pointerdown", e=>{
    if(e.button!==0) return;
    dragging=true; startX=e.clientX; dx=0; track.style.transition="none"; stop();
  });
  track.addEventListener("pointermove", e=>{
    if(!dragging) return;
    dx=e.clientX-startX;
    track.style.transform=`translateX(calc(${-100*idx}% + ${dx}px))`;
  });
  window.addEventListener("pointerup", ()=>{
    if(!dragging) return;
    dragging=false;
    const w=track.clientWidth;
    Math.abs(dx)>w*0.15 ? goTo(idx+(dx<0?1:-1)) : goTo(idx);
  });

  prev?.addEventListener("click", ()=>{ goTo(idx-1); start(); });
  next?.addEventListener("click", ()=>{ goTo(idx+1); start(); });

  document.addEventListener("visibilitychange", ()=>{
    document.hidden ? stop() : (isOnDashboard() ? start() : stop());
  });

  goTo(0);
  __hc.start = start;
  __hc.stop  = stop;
}

/* ========= Routing simple + menú producción + visibilidad de carrusel ========= */
(function(){
  const car     = document.getElementById("dashCarousel");
  const navList = document.getElementById("navList");
  const appRoot = document.getElementById("appRoot");

  const NAV_ITEMS = [
    { hash:"#dashboard",     label:"Dashboard",            perm:"viewEquipos" },
    { hash:"#planificacion", label:"Planificación",        perm:"viewPlanificacion" },

    { hash:"#equipos",       label:"Producción",           perm:"viewEquipos" },
    { hash:"#gruas",         label:"Puentes grúa",         perm:"viewEquipos" },
    { hash:"#auxiliares",    label:"Equipos auxiliares",   perm:"viewEquipos" },

    { hash:"#inventario",    label:"Inventario",           perm:"viewInventario" },
    { hash:"#repuestos",     label:"Repuestos",            perm:"viewRepuestos" },

    { hash:"#incidencias",   label:"Incidencias",          perm:"viewIncidencias" },
    { hash:"#ot",            label:"OTs",                  perm:"viewOT" },
    { hash:"#subcontratas",  label:"Subcontratas",         perm:"viewSubcontratas" },

    { hash:"#mastertime",    label:"Master Control Time",  perm:"viewMasterTime" },
    { hash:"#indicadores",   label:"Indicadores",          perm:"verKPIs" },
    { hash:"#registro",      label:"Registro",             perm:"viewEquipos" }
  ];

  function buildNav(){
    if (!navList) return;
    const html = NAV_ITEMS
      .filter(it => roleCan(it.perm))
      .map(it=>`
        <a class="navlist__item" href="${it.hash}">
          <span>${it.label}</span>
        </a>
      `).join("");
    navList.innerHTML = html;
  }

  // ✅ IMPORTANTE: exponer buildNav para que applyRoleVisibility() pueda reconstruir el menú
  window.buildNav = buildNav;

  window.isOnDashboard = function(){
    const hash = location.hash || "#equipos";
    return hash === "#dashboard";
  };

  function show(el){ if(el) el.style.display=""; }
  function hide(el){ if(el) el.style.display="none"; }

  function markCurrent(){
    const hash = location.hash || "#equipos";

    // ✅ selector robusto: no dependas de una clase “.navlist”
    document.querySelectorAll("#navList a").forEach(a=>{
      a.setAttribute("aria-current", a.getAttribute("href") === hash ? "page" : "false");
    });

    document.querySelectorAll(".page").forEach(sec=>{
      sec.hidden = ("#" + sec.id) !== hash;
    });

    if (car){
      if (isOnDashboard()){
        show(car);
        __hc.start();
      } else {
        __hc.stop();
        hide(car);
      }
    }

    if (appRoot) appRoot.hidden = false;
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    buildNav();
    initHomeCarousel();
    markCurrent();
  });

  window.addEventListener("hashchange", markCurrent, { passive:true });
})();

/* ========= Sombra en header al hacer scroll ========= */
window.addEventListener("scroll", ()=>{
  const hdr = document.getElementById("hdr");
  if (hdr) hdr.classList.toggle("scrolled", window.scrollY > 6);
}, { passive:true });

/* ========= Visibilidad por rol ========= */
function applyRoleVisibility(){
  const showApproveStops = roleCan("approveStop");
  const canSeeKPIs       = roleCan("verKPIs");

  // Botones de aprobar paradas
  document.querySelectorAll('[data-role="approveStop"]').forEach(el=>{
    el.style.display = showApproveStops ? "" : "none";
  });

  // Indicadores (si existe en nav)
  document.querySelectorAll('#navList a[href="#indicadores"]').forEach(a=>{
    a.style.display = canSeeKPIs ? "" : "none";
  });

  // Elementos admin (solo mantenimiento)
  document.querySelectorAll('[data-role="admin"]').forEach(el=>{
    el.style.display = roleCan("full") ? "" : "none";
  });

  // ✅ Reconstruye menú según permisos (buildNav ahora es global)
  if (typeof window.buildNav === "function") window.buildNav();
}

/* =========================================================
   ÍNDICE DE EQUIPOS (UNIFICADO)
   - Referencia única compartida: EQ_INDEX y __EQ_INDEX
   - Añade "marca" por heurística para que funcione el grid de logos
========================================================= */
(function(){
  if (!("EQ_INDEX" in window)) window.EQ_INDEX = [];
  Object.defineProperty(window, "__EQ_INDEX", {
    get(){ return window.EQ_INDEX; },
    set(v){ window.EQ_INDEX = Array.isArray(v) ? v : []; }
  });

  const norm = (s)=>String(s??"").trim();

  function detectMarca(obj, tipo){
    const hay = (obj.grupo||"") + " " + (obj.fabricante||"") + " " + (obj.nombre||"") + " " + (obj.modelo||"");
    if (tipo === "grua") return "gruas";
    if (tipo === "aux")  return "auxiliares";
    if (/kaltenbach/i.test(hay)) return "kaltenbach";
    if (/trumpf/i.test(hay))     return "trumpf";
    if (/\bhgg\b/i.test(hay))    return "hgg";
    if (/tecoi/i.test(hay))      return "tecoi";
    if (/mazak/i.test(hay))      return "mazak";
    return "otros";
  }

  window.buildEqIndex = function({equipos=[], gruas=[], auxiliares=[]}={}){
    const pack = (list,tipo)=> (list||[]).map(e=>{
      const id     = norm(e.id||e.codigo||e.ref||"");
      const nombre = norm(e.nombre||e.tag||e.id||"");
      const fabricante = norm(e.fabricante||"");
      const modelo = norm(e.modelo||"");
      const grupo  = norm(e.grupo||"");
      return {
        id,
        nombre,
        tipo,
        grupo,
        nave: norm(e.nave||""),
        ubicacion: norm(e.ubicacion||""),
        fabricante,
        modelo,
        marca: detectMarca({nombre, fabricante, modelo, grupo}, tipo)
      };
    }).filter(x=>x.id || x.nombre);

    const idx = [
      ...pack(equipos,"equipo"),
      ...pack(gruas,"grua"),
      ...pack(auxiliares,"aux")
    ];

    idx.sort((a,b)=>{
      const n = a.nombre.localeCompare(b.nombre,"es",{sensitivity:"base"});
      return n!==0 ? n : a.id.localeCompare(b.id,"es",{sensitivity:"base"});
    });

    window.EQ_INDEX = idx;
    return window.EQ_INDEX;
  };

  window.searchEqIndex = function(term){
    const t = String(term||"").toLowerCase();
    if(!t) return window.EQ_INDEX.slice(0,100);
    return window.EQ_INDEX.filter(e=>
      e.id.toLowerCase().includes(t) ||
      e.nombre.toLowerCase().includes(t) ||
      e.tipo.toLowerCase().includes(t) ||
      e.ubicacion.toLowerCase().includes(t) ||
      e.marca.toLowerCase().includes(t)
    ).slice(0,200);
  };

  // Compatibilidad si en otras zonas usas buildEquipIndex / INC_EQ_INDEX
  if (!("INC_EQ_INDEX" in window)) window.INC_EQ_INDEX = [];
  if (!("__INC_ALL" in window)) window.__INC_ALL = [];
  if (typeof window.buildEquipIndex !== "function"){
    window.buildEquipIndex = async function(){
      if (window.INC_EQ_INDEX.length) return window.INC_EQ_INDEX;
      const eq  = await GET("equipos")    || [];
      const gr  = await GET("gruas")      || [];
      const aux = await GET("auxiliares") || [];
      const idx = window.buildEqIndex({equipos:eq, gruas:gr, auxiliares:aux}) || [];
      window.INC_EQ_INDEX = idx.map(x=>{
        const label = (x.id && x.nombre && x.nombre.toLowerCase() !== x.id.toLowerCase()) ? `${x.id} ${x.nombre}` : (x.id || x.nombre);
        return { id:x.id, label, grupo:x.grupo };
      });
      return window.INC_EQ_INDEX;
    };
  }
})();

/* ====== INCIDENCIAS: grid de logos → listado por categoría o abrir modal directa ====== */
(function(){
  const wrap = document.getElementById("incLogosWrap");
  const list = document.getElementById("incCatList");
  const auxBtn = document.getElementById("incShowAux");

  async function ensureIndex(){
    if(!window.EQ_INDEX.length && typeof buildEqIndex==="function"){
      try{
        const [equipos,gruas,auxiliares] = await Promise.all([
          GET("equipos").catch(()=>[]),
          GET("gruas").catch(()=>[]),
          GET("auxiliares").catch(()=>[])
        ]);
        buildEqIndex({equipos,gruas,auxiliares});
      }catch(_e){}
    }
  }

  function renderCat(marca){
    const multi = ["kaltenbach","trumpf","gruas","auxiliares","hgg","tecoi","mazak","otros"];
    if(!multi.includes(marca)){
      const one = window.EQ_INDEX.find(x=> x.marca===marca);
      if(one){ openNuevaIncidencia(one.id); }
      return;
    }
    const items = window.EQ_INDEX.filter(x=> x.marca===marca);
    if(!items.length){ if(list){ list.hidden = true; list.innerHTML=""; } return; }
    if(!list) return;
    list.hidden = false;
    list.innerHTML = items
      .sort((a,b)=> a.nombre.localeCompare(b.nombre,"es"))
      .map(x=> `<button type="button" data-eq="${x.id}">${x.nombre || x.id}</button>`)
      .join("");
  }

  wrap?.addEventListener("click", async (e)=>{
    const card = e.target.closest(".inc-logo");
    if(card){
      await ensureIndex();
      const marca = card.getAttribute("data-marca");
      if(marca) renderCat(marca);
      return;
    }
    const pick = e.target.closest("[data-eq]");
    if(pick){
      const id = pick.getAttribute("data-eq");
      openNuevaIncidencia(id);
      return;
    }
  });

  auxBtn?.addEventListener("click", async ()=>{
    await ensureIndex();
    const items = window.EQ_INDEX.filter(x=> x.tipo==="aux" || x.marca==="auxiliares" || /aux/i.test(x.grupo||""));
    if(!items.length){ if(list){ list.hidden = true; list.innerHTML=""; } return; }
    if(!list) return;
    list.hidden = false;
    list.innerHTML = items
      .sort((a,b)=> a.nombre.localeCompare(b.nombre,"es"))
      .map(x=> `<button type="button" data-eq="${x.id}">${x.nombre || x.id}</button>`)
      .join("");
  });
})();
/* ==================== INCIDENCIAS · CACHE + ÍNDICE ==================== */

// Cache global de incidencias
let __INC_ALL = [];

/* ==================== INCIDENCIAS · CARGA ==================== */
async function loadIncidencias(){
  if(!INC_EQ_INDEX.length) await buildEquipIndex();

  try{
    const data = await GET("incidencias");
    __INC_ALL = Array.isArray(data) ? data : [];
  }catch{
    __INC_ALL = [];
  }

  const equipoInp = document.getElementById("incEquipo");
  if(equipoInp){
    equipoInp.addEventListener("focus", ()=>{
      equipoInp.setSelectionRange(0, equipoInp.value.length);
    }, { once:true });
  }

  renderIncFiltered();
}

/* ==================== INCIDENCIAS · FILTRADO ==================== */
function renderIncFiltered(){
  const t = (document.getElementById('incTexto')?.value || '').trim().toLowerCase();
  const f = (document.getElementById('incFecha')?.value || '').trim(); // YYYY-MM-DD
  const e = (document.getElementById('incEquipo')?.value || '').trim();

  const eqSel = matchEquipo(e);
  let list = Array.isArray(__INC_ALL) ? __INC_ALL.slice() : [];

  // Filtro por equipo (ID o etiqueta)
  if (eqSel){
    const id  = String(eqSel.id || '').toLowerCase();
    const lbl = String(eqSel.label || '').toLowerCase();

    list = list.filter(x =>
      String(x.equipo||'').toLowerCase().includes(id) ||
      String(x.equipo||'').toLowerCase().includes(lbl)
    );
  }

  // Filtro por fecha
  if (f){
    list = list.filter(x => x.created && String(x.created).slice(0,10) === f);
  }

  // Filtro por texto libre
  if (t){
    list = list.filter(x =>
      (`${x.equipo||''} ${x.resumen||''} ${x.desc||''}`)
        .toLowerCase()
        .includes(t)
    );
  }

  renderIncList(list);
}

/* Toggle de buscador (plegable) */
(function(){
  const btn = document.getElementById("incToggleSearch");
  const card = document.getElementById("incSearchCard");
  if(!btn || !card) return;
  btn.addEventListener("click", ()=>{
    const open = card.hasAttribute("hidden");
    if(open) card.removeAttribute("hidden"); else card.setAttribute("hidden","");
    btn.setAttribute("aria-expanded", String(open));
    btn.textContent = open ? "Buscar ▲" : "Buscar ▼";
    if(open) document.getElementById("incEquipo")?.focus();
  });
})();

/* Envío filtros + limpiar */
document.getElementById("incFilterForm")?.addEventListener("submit", (e)=>{
  e.preventDefault();
  renderIncFiltered();
});
document.getElementById("incClear")?.addEventListener("click", ()=>{
  (document.getElementById("incEquipo")||{}).value = "";
  (document.getElementById("incFecha") ||{}).value = "";
  (document.getElementById("incTexto") ||{}).value = "";
  renderIncFiltered();
});

function renderIncList(arr){
  const list = document.getElementById("incList");
  const data = (arr||[]).slice().sort((a,b)=> new Date(b.created||0) - new Date(a.created||0));
  if(!list) return;
  list.innerHTML = data.map(it=>`
    <article class="card" data-incid-id="${it.id||""}">
      <header style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;align-items:center">
        <strong>${it.equipo||"-"}</strong>
        <div style="display:flex;gap:6px;align-items:center">
          <span style="font-size:12px;color:#64748b">${it.created ? new Date(it.created).toLocaleString() : ""}</span>
          <button class="btn" type="button" data-inc-fin style="background:#16a34a;color:#fff;border-color:#16a34a">Finalizar incidencia</button>
        </div>
      </header>
      <p style="margin:.5rem 0">${it.resumen||it.desc||"-"}</p>
      <div style="font-size:12px;color:#64748b">Estado: ${it.estado||"-"}</div>
    </article>`).join("") || '<div style="color:#64748b">Sin incidencias</div>';
}

// Acciones en tarjetas de incidencias: finalizar (unificado)
document.addEventListener("click", async (e)=>{
  const fin = e.target.closest("[data-inc-fin]");
  if(!fin) return;
  const card = fin.closest("[data-incid-id]");
  const id   = card?.getAttribute("data-incid-id");
  const tok  = localStorage.getItem(CDL_TOKEN_KEY)||"";
  if(!id){ alert("Incidencia sin ID"); return; }
  try{
    const r = await POST({res:"incid", fn:"finalizar", token:tok, id});
    if(!r.ok) return alert(r.error||"No se pudo finalizar");
    loadIncidencias();
  }catch{ alert("Error de red"); }
});

/* ==================== HELPERS UI / MODAL ==================== */
const _bg = document.getElementById("modalBg");
const _mc = document.getElementById("modalCard");
const _mt = document.getElementById("modalT");
const _md = document.getElementById("modalC");
function openModal(t, html){
  if(!_bg || !_mc || !_mt || !_md) return;
  _mt.textContent=t||"Detalle"; _md.innerHTML=html||"";
  _bg.style.display=_mc.style.display="block";
}
function closeModal(){
  if(!_bg || !_mc) return;
  _bg.style.display=_mc.style.display="none";
}

/* =========================================================
   REPUESTOS · BUSCADOR INTELIGENTE (FRONTEND)
   - Usa _invRaw (inventario) si está cargado, si no, intenta invLoad()
   - Coincidencias parciales, sin tildes, orden por relevancia
========================================================= */
function _normStr(s){
  return String(s||"")
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g,"")
    .trim();
}

function _scoreRepuesto(q, item){
  const qq = _normStr(q);
  if(!qq) return 0;

  const fields = [
    item.ref, item.referencia, item.codigo, item.id,
    item.nombre, item.descripcion, item.desc,
    item.ubicacion, item.categoria, item.cat,
    item.maquina, item.equipo
  ].map(_normStr).filter(Boolean);

  const hay = fields.join(" · ");
  if (!hay) return 0;

  // Exacto en referencia/código
  const ref = _normStr(item.ref || item.referencia || item.codigo || item.id);
  if (ref && ref === qq) return 1000;

  // Empieza por
  if (ref && ref.startsWith(qq)) return 850;

  // Coincidencia completa en texto
  if (hay.includes(qq)) return 650;

  // Token match
  const toks = qq.split(/\s+/).filter(Boolean);
  let hit = 0;
  toks.forEach(t=>{
    if (t.length >= 2 && hay.includes(t)) hit++;
  });
  if (hit){
    return 300 + hit*40;
  }
  return 0;
}

async function openRepuestoFinder(opts){
  const { title="Buscar repuesto", query="", onPick, onNone } = (opts||{});

  // Asegura inventario
  try{
    if (!Array.isArray(_invRaw) || !_invRaw.length){
      if (typeof invLoad === "function") await invLoad();
    }
  }catch(_e){}

  const list = Array.isArray(_invRaw) ? _invRaw : [];

  openModal(title, `
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px">
      <input id="rfQ" type="search" placeholder="Escribe referencia, nombre, ubicación…" value="${String(query||"").replace(/"/g,'&quot;')}" style="flex:1;min-width:240px">
      <button id="rfNone" class="btn btn--ghost" type="button">No está → Solicitar</button>
    </div>
    <div class="muted" style="font-size:12px;margin-bottom:8px">
      Consejos: busca por <strong>referencia</strong>, <strong>nombre</strong> o <strong>ubicación</strong>. Ignora tildes y mayúsculas.
    </div>
    <div style="max-height:55vh;overflow:auto;border:1px solid #15223a;border-radius:12px">
      <table class="table" style="border:0">
        <thead>
          <tr>
            <th>Ref</th><th>Nombre</th><th>Ubicación</th><th>Stock</th><th></th>
          </tr>
        </thead>
        <tbody id="rfBody">
          <tr><td colspan="5" class="muted">Escribe para buscar…</td></tr>
        </tbody>
      </table>
    </div>
  `);

  const qEl = document.getElementById("rfQ");
  const bEl = document.getElementById("rfBody");
  const noneBtn = document.getElementById("rfNone");
  if(!qEl || !bEl || !noneBtn) return;

  function render(){
    const q = qEl.value || "";
    const qq = _normStr(q);
    if(!qq){
      bEl.innerHTML = '<tr><td colspan="5" class="muted">Escribe para buscar…</td></tr>';
      return;
    }

    const ranked = list
      .map(it=>({it, sc:_scoreRepuesto(qq, it)}))
      .filter(x=>x.sc>0)
      .sort((a,b)=>b.sc-a.sc)
      .slice(0, 40);

    if(!ranked.length){
      bEl.innerHTML = '<tr><td colspan="5" class="muted">Sin coincidencias. Puedes solicitarlo con el botón de arriba.</td></tr>';
      return;
    }

    bEl.innerHTML = ranked.map(x=>{
      const it = x.it;
      const ref = it.ref || it.referencia || it.codigo || it.id || "";
      const nom = it.nombre || it.descripcion || it.desc || "";
      const ub  = it.ubicacion || it.ubi || "";
      const st  = (it.stock ?? it.cantidad ?? it.qty ?? "");
      return `
        <tr>
          <td><strong>${ref}</strong></td>
          <td>${nom}</td>
          <td>${ub}</td>
          <td>${st}</td>
          <td><button class="btn btn--primary" type="button" data-pick="${String(ref).replace(/"/g,'&quot;')}">Elegir</button></td>
        </tr>
      `;
    }).join("");

    bEl.querySelectorAll('button[data-pick]').forEach(btn=>{
      btn.onclick = ()=>{
        const ref = btn.getAttribute("data-pick") || "";
        const it = ranked.find(x=>String(x.it.ref||x.it.referencia||x.it.codigo||x.it.id||"") === ref)?.it || null;
        closeModal();
        if (typeof onPick === "function") onPick(it);
      };
    });
  }

  noneBtn.onclick = ()=>{
    closeModal();
    if (typeof onNone === "function") onNone();
  };

  qEl.addEventListener("input", render);
  render();
}

/* =========================================================
   SUBCONTRATAS · FLUJO MÍNIMO (FRONTEND)
   - Persistencia local (localStorage) como hook para backend futuro
========================================================= */
const SUB_KEY = "cdl_subcontratas_v1";
function sub_getAll(){
  try{ return JSON.parse(localStorage.getItem(SUB_KEY) || "[]") || []; }catch{ return []; }
}
function sub_setAll(arr){
  try{ localStorage.setItem(SUB_KEY, JSON.stringify(arr||[])); }catch(_e){}
}
function sub_add(req){
  const all = sub_getAll();
  const id = "SUB-" + Date.now();
  all.unshift({
    id,
    creado: new Date().toISOString(),
    cerrado: null,
    estado: "pendiente",
    ...req
  });
  sub_setAll(all);
  return id;
}
function sub_close(id){
  const all = sub_getAll();
  const it = all.find(x=>x.id===id);
  if(it){
    it.estado = "cerrada";
    it.cerrado = new Date().toISOString();
  }
  sub_setAll(all);
}
function sub_render(){
  const wrapPend = document.getElementById("subPendBody");
  const wrapHist = document.getElementById("subHistBody");
  if(!wrapPend || !wrapHist) return;

  const all = sub_getAll();
  const pend = all.filter(x=>x.estado!=="cerrada");
  const hist = all.filter(x=>x.estado==="cerrada").slice(0, 40);

  wrapPend.innerHTML = pend.length ? pend.map(x=>`
    <tr>
      <td><strong>${x.id}</strong></td>
      <td>${(x.equipo||x.ref||"")}</td>
      <td>${(x.motivo||"")}</td>
      <td>${(x.quien||"")}</td>
      <td>${new Date(x.creado).toLocaleString()}</td>
      <td><button class="btn btn--primary" type="button" data-close="${x.id}">Cerrar</button></td>
    </tr>
  `).join("") : `<tr><td colspan="6" class="muted">No hay solicitudes pendientes.</td></tr>`;

  wrapHist.innerHTML = hist.length ? hist.map(x=>`
    <tr>
      <td><strong>${x.id}</strong></td>
      <td>${(x.equipo||x.ref||"")}</td>
      <td>${(x.motivo||"")}</td>
      <td>${(x.quien||"")}</td>
      <td>${x.cerrado ? new Date(x.cerrado).toLocaleString() : ""}</td>
    </tr>
  `).join("") : `<tr><td colspan="5" class="muted">Sin histórico todavía.</td></tr>`;

  wrapPend.querySelectorAll('button[data-close]').forEach(b=>{
    b.onclick = ()=>{
      const id = b.getAttribute("data-close");
      sub_close(id);
      sub_render();
    };
  });
}

/* =========================================================
   MASTER TIME · HOOKS (PREPARACIÓN)
   - Registra tramos por equipo al cambiar el semáforo
   - Persistencia local, sin cálculo “serio” todavía
========================================================= */
const MT_KEY = "cdl_mastertime_segments_v1";
const MT_OPEN_KEY = "cdl_mastertime_open_v1";
function mt_getSegments(){
  try{ return JSON.parse(localStorage.getItem(MT_KEY)||"[]") || []; }catch{ return []; }
}
function mt_setSegments(arr){
  try{ localStorage.setItem(MT_KEY, JSON.stringify(arr||[])); }catch(_e){}
}
function mt_getOpen(){
  try{ return JSON.parse(localStorage.getItem(MT_OPEN_KEY)||"{}") || {}; }catch{ return {}; }
}
function mt_setOpen(obj){
  try{ localStorage.setItem(MT_OPEN_KEY, JSON.stringify(obj||{})); }catch(_e){}
}
function mt_stateToLabel(s){
  if(s==="g") return "marcha";
  if(s==="y") return "restriccion";
  if(s==="r") return "parada";
  if(s==="b") return "reparacion";
  return String(s||"");
}
function mt_onChange(tipo, id, newState){
  const key = `${tipo}:${id}`;
  const now = new Date().toISOString();
  const open = mt_getOpen();
  const segs = mt_getSegments();

  // cierra tramo anterior si existe
  if(open[key] && open[key].inicio && open[key].estado){
    segs.unshift({
      inicio: open[key].inicio,
      fin: now,
      tipo,
      equipo: id,
      estado: open[key].estado
    });
  }
  // abre nuevo tramo
  open[key] = { inicio: now, estado: mt_stateToLabel(newState) };
  mt_setOpen(open);
  mt_setSegments(segs);
}

// ✅ Guard: evita TypeError si no existen modalX o modalBg en esa vista
(function(){
  const mx = document.getElementById("modalX");
  if(mx) mx.onclick = closeModal;
  if(_bg) _bg.onclick = closeModal;
  document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeModal(); });
})();

/* ==================== TARJETA CON SEMÁFORO (horizontal) ==================== */
/**
 * Estados finales integrados:
 *  - 🟢 g → MARCHA
 *  - 🟡 y → MARCHA CON RESTRICCIONES
 *  - 🔴 r → PARADA
 *  - 🔵 b → EN REPARACIÓN (sin formulario, solo estado azul)
 *
 * Amarillo y rojo usan el MISMO formulario unificado.
 * Verde abre un mini-form para confirmar y, si quieres, saltar a inventario.
 * Azul solo pide confirmación rápida (no formulario largo).
 */

function uc(s){ return (s||'').toString().toUpperCase(); }

function semClass(estado){
  const s = String(estado||'ok').toLowerCase();
  if(/rep|repar|azul|blue/.test(s))        return 'b';
  if(/stop|parada|rojo|crit/.test(s))      return 'r';
  if(/warn|restr|amar/.test(s))            return 'y';
  return 'g';
}

function trafficLightCard({id,nombre,estado,tipo='equipo'}){
  const state = semClass(estado);
  const name  = uc(nombre||id);
  const stateLabel =
    state==='g' ? 'MARCHA' :
    state==='y' ? 'RESTRICCIÓN' :
    state==='r' ? 'PARADA' :
                  'EN REPARACIÓN';

  return `
  <article class="tl" data-card="${tipo}:${id}">
    <div class="tl__head">
      <div class="tl__id">
        <span class="tl__name">${name}</span>
        <span class="tl__badge" data-badge="${id}">${stateLabel}</span>
      </div>

      <div class="tl__pole-wrap" aria-label="Estado ${stateLabel}">
        <div class="tl__pole">
          <div class="tl__lamp tl__lamp--g ${state==='g'?'active':''}"></div>
          <div class="tl__lamp tl__lamp--y ${state==='y'?'active':''}"></div>
          <div class="tl__lamp tl__lamp--r ${state==='r'?'active':''}"></div>
          <div class="tl__lamp tl__lamp--b ${state==='b'?'active':''}"></div>
        </div>
        <!-- Zonas clicables: verde / amarillo / rojo / azul -->
        <div class="tl__hit tl__hit--g" data-tl="${id}" data-type="${tipo}" data-newstate="g" title="Marcha (verde)"></div>
        <div class="tl__hit tl__hit--y" data-tl="${id}" data-type="${tipo}" data-newstate="y" title="Marcha con restricciones (amarillo)"></div>
        <div class="tl__hit tl__hit--r" data-tl="${id}" data-type="${tipo}" data-newstate="r" title="Parada (rojo)"></div>
        <div class="tl__hit tl__hit--b" data-tl="${id}" data-type="${tipo}" data-newstate="b" title="En reparación (azul)"></div>
      </div>
    </div>

    <div class="tl__actions">
      <button class="btn btn--ghost" type="button" data-ficha="${id}" data-type="${tipo}">Ver ficha</button>
      <div class="tl__more">
        <button class="tl__arrow" type="button" data-more-open aria-haspopup="menu" aria-expanded="false">▼</button>
        <div class="tl__menu" role="menu">
          <button class="btn btn--ghost" type="button" data-incidencia="${id}" data-type="${tipo}">Nueva incidencia</button>
          <button class="btn btn--ghost" type="button" data-programar="${id}" data-type="${tipo}">Programar parada</button>
          <button class="btn btn--ghost" type="button" data-parada-programada="${id}" data-type="${tipo}">Parada programada</button>
          <button class="btn btn--danger" type="button" data-parada-prolongada="${id}" data-type="${tipo}">Parada prolongada</button>
        </div>
      </div>
    </div>
  </article>`;
}

/* ====== FORMULARIOS DE ESTADO (UNIFICADOS) ====== */

function openSemaforoIncidencia(tipo, id, newState, token){
  const titulo = newState === 'y'
    ? 'Marcha con restricciones'
    : 'Parada total';

  const now    = new Date();
  const fechaTxt = now.toLocaleString();

  openModal(titulo, `
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px">
      <div>
        <label>Equipo</label>
        <input id="sfEq" value="${id}" readonly>
      </div>
      <div>
        <label>Fecha / hora</label>
        <input value="${fechaTxt}" readonly>
      </div>
    </div>

    <label style="margin-top:8px;display:block">Motivo / causa</label>
    <textarea id="sfMotivo" rows="3" style="width:100%;border-radius:12px;border:1px solid #243046;background:#0b101a;color:#e6eef7"></textarea>

    <label style="margin-top:8px;display:block">Quién lo informa</label>
    <input id="sfQuien" placeholder="Nombre / iniciales">

    <div style="margin-top:10px;display:flex;flex-direction:column;gap:6px">
      <label style="display:flex;align-items:center;gap:6px">
        <input type="checkbox" id="sfRep">
        <span>Solicitar ORDEN DE REPUESTO</span>
      </label>
      <label style="display:flex;align-items:center;gap:6px">
        <input type="checkbox" id="sfExt">
        <span>Solicitar intervención externa</span>
      </label>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn--primary" type="button" id="sfSave">Guardar</button>
      <button class="btn btn--ghost" type="button" id="sfCancel">Cancelar</button>
    </div>
  `);

  const root   = _md;
  if(!root) return;

  const motivo = root.querySelector('#sfMotivo');
  const quien  = root.querySelector('#sfQuien');
  const repChk = root.querySelector('#sfRep');
  const extChk = root.querySelector('#sfExt');

  root.querySelector('#sfCancel').onclick = closeModal;

  root.querySelector('#sfSave').onclick = async ()=>{
    const m = (motivo.value||'').trim();
    const q = (quien.value||'').trim();

    if(!m || !q){
      alert('Motivo y quién lo informa son obligatorios.');
      return;
    }

    const pideRep = !!repChk.checked;
    const pideExt = !!extChk.checked;

    const desc = [
      m,
      '',
      `Informado por: ${q}`,
      `Solicita repuesto: ${pideRep ? 'Sí' : 'No'}`,
      `Solicita intervención externa: ${pideExt ? 'Sí' : 'No'}`
    ].join('\n');

    try{
      await POST({
        res:'incid',
        fn:'crear',
        token,
        equipo: id,
        tipo: (newState === 'y' ? 'restriccion' : 'parada'),
        desc
      });
    }catch(_e){}

    try{ mt_onChange(tipo, id, newState); }catch(_e){}

    await setSemaforoEstado(tipo, id, newState, token);

    closeModal();

    if(typeof loadIncidencias === 'function') loadIncidencias();

    if(pideRep){
      try{
        await openRepuestoFinder({
          title: "Selecciona repuesto para el pedido",
          query: motivo,
          onPick: (it)=>{
            try{
              localStorage.setItem("cdl_pedido_repuesto_draft_v1", JSON.stringify({
                ts: Date.now(),
                tipo, equipo:id,
                motivo, quien,
                repuesto: it
              }));
            }catch(_e){}
            location.hash = '#repuestos';
          },
          onNone: ()=>{
            try{
              localStorage.setItem("cdl_pedido_repuesto_draft_v1", JSON.stringify({
                ts: Date.now(),
                tipo, equipo:id,
                motivo, quien,
                repuesto: null
              }));
            }catch(_e){}
            location.hash = '#repuestos';
          }
        });
      }catch(_e){
        location.hash = '#repuestos';
      }
    }
  };
}

function openSemaforoMarcha(tipo, id, token){
  openModal('Volver a MARCHA', `
    <p>Vas a marcar el equipo <strong>${id}</strong> en estado <strong>MARCHA (verde)</strong>.</p>
    <label style="display:flex;align-items:center;gap:6px;margin-top:8px">
      <input type="checkbox" id="sfCons">
      <span>Descontar repuestos / consumibles utilizados</span>
    </label>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn--primary" type="button" id="sfOkG">Confirmar</button>
      <button class="btn btn--ghost" type="button" id="sfCancelG">Cancelar</button>
    </div>
  `);

  const root = _md;
  if(!root) return;
  const chk  = root.querySelector('#sfCons');

  root.querySelector('#sfCancelG').onclick = closeModal;

  root.querySelector('#sfOkG').onclick = async ()=>{
    try{ mt_onChange(tipo, id, 'g'); }catch(_e){}

    await setSemaforoEstado(tipo, id, 'g', token);
    closeModal();

    if(chk?.checked){
      location.hash = '#inventario';
    }
  };
}

function openSemaforoAzul(tipo, id, token){
  const ok = confirm(`¿Marcar el equipo ${id} como EN REPARACIÓN (azul)?`);
  if(!ok) return;
  setSemaforoEstado(tipo, id, 'b', token);
}

/* ==================== SEMÁFORO → actualizar DOM + backend ==================== */
async function setSemaforoEstado(tipo, id, newState, token){
  const card = document.querySelector(`[data-card="${tipo}:${CSS.escape(id)}"]`);
  if(card){
    const lamps = card.querySelectorAll('.tl__lamp');
    lamps.forEach(l => l.classList.remove('active'));

    const badge = card.querySelector(`[data-badge="${CSS.escape(id)}"]`);

    if(newState === 'g' && lamps[0]) lamps[0].classList.add('active');
    if(newState === 'y' && lamps[1]) lamps[1].classList.add('active');
    if(newState === 'r' && lamps[2]) lamps[2].classList.add('active');
    if(newState === 'b' && lamps[3]) lamps[3].classList.add('active');

    if(badge){
      if(newState === 'g') badge.textContent = 'MARCHA';
      else if(newState === 'y') badge.textContent = 'RESTRICCIÓN';
      else if(newState === 'r') badge.textContent = 'PARADA';
      else if(newState === 'b') badge.textContent = 'EN REPARACIÓN';
    }
  }

  try{
    await POST({
      res:'state',
      fn:'set_estado',
      token,
      tipo,
      id,
      estado:
        newState === 'g' ? 'ok' :
        newState === 'y' ? 'restriccion' :
        newState === 'r' ? 'parada' :
                           'reparacion'
    });
  }catch(_e){}
}

/* ==================== CLIC EN SEMÁFORO (4 ESTADOS) ==================== */
document.addEventListener('click', (e)=>{
  const hit = e.target.closest('[data-tl]');
  if(!hit) return;

  const id       = hit.getAttribute('data-tl');
  const tipo     = hit.getAttribute('data-type');
  const newState = hit.getAttribute('data-newstate');
  const tok      = localStorage.getItem(CDL_TOKEN_KEY)||'';

  if(newState === 'g'){
    openSemaforoMarcha(tipo, id, tok);
    return;
  }
  if(newState === 'b'){
    openSemaforoAzul(tipo, id, tok);
    return;
  }
  if(newState === 'y' || newState === 'r'){
    openSemaforoIncidencia(tipo, id, newState, tok);
    return;
  }
});

/* ==================== EQUIPOS / GRÚAS / AUXILIARES ==================== */
async function loadEquipos(){
  const data = await GET('equipos');
  document.getElementById('eqSelect').innerHTML =
    '<option value="">— Selecciona de la lista —</option>' +
    (data||[]).map(e=>`<option value="${e.id}">${e.nombre||e.id}</option>`).join('');

  const kal = (data||[]).filter(e=> /kaltenbach/i.test(e.linea||''));
  const tru = (data||[]).filter(e=> /trumpf|láser|laser/i.test((e.linea||e.nombre||'')));
  const ind = (data||[]).filter(e=> !/kaltenbach/i.test(e.linea||'') && !/trumpf|láser|laser/i.test((e.linea||e.nombre||'')));

  document.getElementById('equiposKaltenbach').innerHTML = kal.map(e=>trafficLightCard({...e,tipo:'equipo'})).join('') || '<div style="color:#64748b">Sin datos</div>';
  document.getElementById('equiposTrumpf').innerHTML     = tru.map(e=>trafficLightCard({...e,tipo:'equipo'})).join('') || '<div style="color:#64748b">Sin datos</div>';
  document.getElementById('equiposIndep').innerHTML      = ind.map(e=>trafficLightCard({...e,tipo:'equipo'})).join('') || '<div style="color:#64748b">Sin datos</div>';
}

async function loadGruas(){
  const data = await GET('gruas');
  const gruas = Array.isArray(data) ? data : [];

  // Select
  const sel = document.getElementById('grSelect');
  if (sel){
    sel.innerHTML =
      '<option value="">— Selecciona —</option>' +
      gruas.map(g => `<option value="${g.id}">${g.id}</option>`).join('');
  }

  // Detecta si realmente viene "nave" con valores 1..4
  const hasNave = gruas.some(g => ['1','2','3','4'].includes(String(g.nave ?? '').trim()));

  for (const n of [1,2,3,4]){
    const cont = document.getElementById('grN' + n);
    if (!cont) continue;

    let arr = gruas.filter(g => String(g.nave ?? '').trim() === String(n));

    // Fallback: si no existe/usa "nave", metemos todas en Nave 1 para que al menos se vean
    if (!hasNave){
      arr = (n === 1) ? gruas : [];
    }

    cont.innerHTML = arr.length
      ? arr.map(g => trafficLightCard({ ...g, tipo:'gruas' })).join('')
      : '<div style="color:#64748b">Sin puentes en esta nave.</div>';
  }
}
async function loadAux(){
  const data = await GET('auxiliares');
  document.getElementById('axSelect').innerHTML =
    '<option value="">— Selecciona —</option>' + (data||[]).map(a=>`<option value="${a.id}">${a.nombre||a.id}</option>`).join('');
  document.getElementById('auxList').innerHTML = (data||[]).map(a=>trafficLightCard({...a,tipo:'aux'})).join('') || '<div style="color:#64748b">Sin datos</div>';
}

/* ==================== FICHA DE EQUIPO/GRÚA/AUX (con QR) ==================== */
async function fichaRender(id){
  let e = (await GET('equipos')).find(x=>String(x.id).toLowerCase()===String(id).toLowerCase());
  if(!e) e = (await GET('gruas')).find(x=>String(x.id).toLowerCase()===String(id).toLowerCase());
  if(!e) e = (await GET('auxiliares')).find(x=>String(x.id).toLowerCase()===String(id).toLowerCase());
  if(!e) return openModal('Ficha', '<div class="badge">No encontrado</div>');

  const kv = (k,v)=>`<span class="badge" style="margin:2px 6px 2px 0"><strong>${k}:</strong> ${v ?? '—'}</span>`;
  const meta = [
    kv('Ubicación',e.ubicacion), kv('Nave',e.nave), kv('Grupo',e.grupo),
    kv('Fabricante',e.fabricante), kv('Modelo',e.modelo), kv('Año',e.anno),
    kv('Nº serie',e.numero_serie)
  ].join('');

  const sanitize = (t)=> String(t||'')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^\w\s-]/g,'').trim().replace(/\s+/g,'_');

  const pdfName = sanitize(e.nombre||e.id)+'.pdf';

  const qrData = encodeURIComponent(`${location.origin}${location.pathname}#equipos?eq=${encodeURIComponent(e.id)}`);
  const qrImg  = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${qrData}`;

  const html = `
    <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:flex-start">
      <div style="flex:1 1 380px">
        <div style="display:flex;gap:6px;flex-wrap:wrap">${meta}</div>
        <h4 style="margin:10px 0 6px">Observaciones</h4>
        <div class="card" style="background:#0b101a;color:#cfe1f7;border:1px solid #243046">${e.observaciones||'—'}</div>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn--primary" type="button" onclick="window.__cdlOpenManual && window.__cdlOpenManual('${pdfName}')">Manual</button>
          <button class="btn btn--ghost" type="button" onclick="window.print()">Imprimir</button>
        </div>
      </div>
      <div style="flex:0 0 auto; text-align:center">
        <div class="badge" style="display:inline-block;margin-bottom:6px">QR equipo</div>
        <img src="${qrImg}" alt="QR ${e.id}" width="160" height="160" style="border-radius:12px;border:1px solid #e2e8f0">
        <div style="font-size:12px;color:#64748b;margin-top:4px">${e.id}</div>
      </div>
    </div>`;
  openModal(`${e.nombre||e.id} — Ficha técnica`, html);
}

if(!window.__cdlOpenManual){
  window.__cdlOpenManual = async function(pdfName){
    const base = './manuales/';
    const url  = base + pdfName;
    try{
      const res = await fetch(url, { method:'HEAD', cache:'no-store' });
      if (res && res.ok) { window.open(url, '_blank'); return; }
    }catch(_e){}
    window.open(base + 'manual_no_disponible.pdf', '_blank');
  };
}

/* ==================== INVENTARIO / CONSUMIBLES (ÚNICO) ==================== */
let _invRaw = [];

/* ... (EL RESTO DE TU SCRIPT CONTINÚA EXACTAMENTE IGUAL DESDE AQUÍ) ... */

/* =========================================================
   NOTA:
   He corregido 3 cosas que rompen el menú y/o dejan el JS KO:
   1) Guard en panel usuario si faltan IDs.
   2) buildNav expuesto como window.buildNav + selector robusto #navList a.
   3) Guard para modalX / modalBg (evita TypeError que corta el script).
========================================================= */
/* =========================================================
   AÑADIDOS CDL · FIXES Y FUNCIONES FALTANTES
   (pegar al FINAL del script)
========================================================= */

/* ==================== 1) matchEquipo ==================== */
/* Relaciona texto libre con EQ_INDEX (usado en incidencias) */
function matchEquipo(val){
  if(!val) return null;
  const t = String(val).toLowerCase().trim();
  if(!t) return null;

  if(!Array.isArray(window.EQ_INDEX)) return null;

  return window.EQ_INDEX.find(e=>{
    return (
      String(e.id||"").toLowerCase() === t ||
      String(e.nombre||"").toLowerCase().includes(t)
    );
  }) || null;
}

/* ==================== 2) openNuevaIncidencia ==================== */
/* Apertura directa de incidencia desde logos / listados */
function openNuevaIncidencia(equipoId){
  const tok = localStorage.getItem(CDL_TOKEN_KEY)||"";
  if(!equipoId){
    alert("Equipo no válido");
    return;
  }

  openModal("Nueva incidencia", `
    <label>Equipo</label>
    <input value="${equipoId}" readonly>

    <label style="margin-top:8px">Descripción</label>
    <textarea id="niDesc" rows="4" placeholder="Describe la incidencia..."></textarea>

    <label style="margin-top:8px">Tipo</label>
    <select id="niTipo">
      <option value="parada">Parada</option>
      <option value="restriccion">Restricción</option>
      <option value="averia">Avería</option>
    </select>

    <div style="margin-top:12px;display:flex;gap:8px">
      <button class="btn btn--primary" id="niSave">Guardar</button>
      <button class="btn btn--ghost" id="niCancel">Cancelar</button>
    </div>
  `);

  document.getElementById("niCancel").onclick = closeModal;

  document.getElementById("niSave").onclick = async ()=>{
    const desc = document.getElementById("niDesc").value.trim();
    const tipo = document.getElementById("niTipo").value;
    if(!desc){
      alert("La descripción es obligatoria");
      return;
    }
    const r = await POST({
      res:"incid",
      fn:"crear",
      token:tok,
      equipo:equipoId,
      tipo,
      desc
    });
    if(!r.ok){
      alert(r.error || "No se pudo crear la incidencia");
      return;
    }
    closeModal();
    if(typeof loadIncidencias === "function") loadIncidencias();
  };
}

/* ==================== 3) invLoad ==================== */
/* Carga inventario plano para buscador de repuestos */
async function invLoad(){
  try{
    const data = await GET("inventario");
    _invRaw = Array.isArray(data) ? data : [];
    return _invRaw;
  }catch{
    _invRaw = [];
    return [];
  }
}

/* ==================== 4) Acciones menú ⋮ de semáforo ==================== */
document.addEventListener("click", async (e)=>{
  const tok = localStorage.getItem(CDL_TOKEN_KEY)||"";

  const inc = e.target.closest("[data-incidencia]");
  const prog = e.target.closest("[data-programar]");
  const pp = e.target.closest("[data-parada-programada]");
  const pl = e.target.closest("[data-parada-prolongada]");

  if(inc){
    openNuevaIncidencia(inc.getAttribute("data-incidencia"));
    return;
  }

  if(prog){
    const id = prog.getAttribute("data-programar");
    const fecha = prompt("Fecha parada programada (YYYY-MM-DD):");
    const motivo = prompt("Motivo:");
    if(fecha && motivo){
      await POST({res:"stop",fn:"programar",token:tok,equipo:id,fecha,motivo});
    }
    return;
  }

  if(pp){
    alert("Consulta de paradas programadas pendiente de vista específica.");
    return;
  }

  if(pl){
    const id = pl.getAttribute("data-parada-prolongada");
    if(confirm(`¿Notificar parada prolongada en ${id}?`)){
      await POST({res:"alert",fn:"parada",token:tok,equipo:id});
    }
    return;
  }
});

/* ==================== 5) Planificación de producción (loader base) ==================== */
async function loadPlanificacion(){
  const wrap = document.getElementById("planTable");
  if(!wrap) return;

  const data = await GET("planificacion");
  if(!Array.isArray(data) || !data.length){
    wrap.innerHTML = '<div class="muted">Sin datos de planificación</div>';
    return;
  }

  wrap.innerHTML = `
    <table class="table">
      <thead>
        <tr>
          <th>Máquina</th>
          <th>Pedido</th>
          <th>Perfil</th>
          <th>Cantidad</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody>
        ${data.map(r=>`
          <tr>
            <td>${r.maquina||r.maq||"-"}</td>
            <td>${r.pedido||"-"}</td>
            <td>${r.perfil||"-"}</td>
            <td>${r.cantidad||"-"}</td>
            <td>${r.fecha||"-"}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
}
/* =========================================================
   MENÚ HAMBURGUESA · SIDENAV
========================================================= */
(function(){
  const hamb     = document.getElementById("hamb");
  const sidenav  = document.getElementById("sidenav");
  const closeBtn = document.getElementById("closeNav");

  if(!hamb || !sidenav) return;

  const openNav = ()=>{
    sidenav.classList.add("open");
    document.body.classList.add("menu-open");
    hamb.setAttribute("aria-expanded","true");
    sidenav.setAttribute("aria-hidden","false");
  };

  const closeNav = ()=>{
    sidenav.classList.remove("open");
    document.body.classList.remove("menu-open");
    hamb.setAttribute("aria-expanded","false");
    sidenav.setAttribute("aria-hidden","true");
  };

  hamb.addEventListener("click", (e)=>{
    e.stopPropagation();
    sidenav.classList.contains("open") ? closeNav() : openNav();
  });

  closeBtn?.addEventListener("click", closeNav);

  // Cerrar al hacer click fuera
  document.addEventListener("click", (e)=>{
    if(
      sidenav.classList.contains("open") &&
      !sidenav.contains(e.target) &&
      !hamb.contains(e.target)
    ){
      closeNav();
    }
  });

  // Cerrar al navegar por hash
  window.addEventListener("hashchange", closeNav);
})();
/* ==================== ROUTER/INIT (recupera llamadas de carga) ==================== */
(function(){
  function getHash(){
    return (location.hash || "#dashboard").replace("#", "");
  }

  function enforceDefaultByRole(){
    const slug = (typeof currentRoleSlug === "function") ? currentRoleSlug() : "invitado";
    const h = location.hash || "";

    // Invitado: no debe ver nada “operativo”
    if (slug === "invitado"){
      if (h && h !== "#dashboard") location.hash = "#dashboard";
      return;
    }

    // Producción: al entrar, que vaya a planificación (tu “home real”)
    if (slug === "produccion"){
      if (!h || h === "#dashboard") location.hash = "#planificacion";
      return;
    }

    // Otros roles: si no hay hash, dashboard
    if (!h) location.hash = "#dashboard";
  }

  async function initSection(h){
    // IMPORTANTE: llamamos solo a lo que exista, así no rompe si faltan módulos
    try{
      switch(h){
        case "planificacion":
          if (typeof loadPlanificacion === "function") await loadPlanificacion();
          break;

        case "equipos":
          if (typeof loadEquipos === "function") await loadEquipos();
          break;

        case "gruas":
          if (typeof loadGruas === "function") await loadGruas();
          break;

        case "auxiliares":
          if (typeof loadAux === "function") await loadAux();
          break;

        case "inventario":
          if (typeof invLoad === "function") await invLoad();
          break;

        case "repuestos":
          if (typeof reqLoad === "function") await reqLoad();
          if (typeof loadRepuestos === "function") await loadRepuestos();
          break;

        case "incidencias":
          if (typeof loadIncidencias === "function") await loadIncidencias();
          break;

        case "dashboard":
        default:
          if (typeof loadDashboardMain === "function") await loadDashboardMain();
          break;
      }
    }catch(_e){
      // Si algo falla, que no reviente toda la app
      console.error("initSection error:", _e);
    }
  }

  async function boot(){
    // 1) Aplica visibilidad/menú
    try{ if (typeof applyRoleVisibility === "function") applyRoleVisibility(); }catch(_e){}

    // 2) Ajusta hash por rol (producción -> planificación / invitado -> dashboard)
    enforceDefaultByRole();

    // 3) Carga la sección actual
    await initSection(getHash());
  }

  window.addEventListener("hashchange", ()=> initSection(getHash()), { passive:true });
  document.addEventListener("DOMContentLoaded", boot);
})();
</script>
</body>
</html>