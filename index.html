<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>CDL · Panel de mantenimiento</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ffffff">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">

<!-- Fuente -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

<style>
/* =========================================================
   VARIABLES + RESET (consolidado) · versión compacta
========================================================= */
:root{
  --brand:#E43B3B;
  --ink:#0f172a;
  --muted:#475569;
  --line:#e5e7eb;
  --bg:#ffffff;

  --hdr-h:84px;
  --radius:16px;
  --shadow:0 3px 10px rgba(0,0,0,.05);

  --angular-size:26px;
  --angular-up:.72em;
  --angular-gap:20px;

  /* Carrusel algo más compacto para evitar cortes */
  --carousel-h:clamp(76px,13vw,128px);
}

*{box-sizing:border-box; min-width:0}
html{font-size:15px}
@media (max-width:540px){ html{font-size:14.5px} }
@media (min-width:1400px){ html{font-size:15.5px} }

html,body{height:100%; background:#fff; overflow-x:hidden; color:var(--ink)}
body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
a{color:inherit; text-decoration:none}
img,svg,canvas,video{display:block; max-width:100%; height:auto}
button{font:inherit; cursor:pointer; background:transparent; border:0}
:focus-visible{outline:2px solid #0ea5e9; outline-offset:2px}
@media (prefers-reduced-motion:reduce){ *{transition:none!important; animation:none!important} }

/* =========================================================
   BOTONES BASE
========================================================= */
.btn{
  display:inline-flex; align-items:center; justify-content:center;
  gap:.45rem; padding:.5rem .8rem; border-radius:10px; border:1px solid var(--line);
  background:#fff; color:var(--ink); font-weight:700; line-height:1.1; font-size:.95rem;
}
.btn:hover{ background:#f8fafc }
.btn:active{ transform:translateY(1px) }
.btn--primary{ background:var(--brand); color:#fff; border-color:transparent }
.btn--primary:hover{ filter:brightness(0.95) }
.btn--ghost{ background:#fff; color:#334155; border:1px solid #e2e8f0 }
.link{ background:transparent; border:0; color:var(--brand); font-weight:800; padding:0 }

/* Botón negro para "Programar parada" */
.btn--dark{ background:#000; color:#fff; border:1px solid #000 }
.btn--dark:hover{ filter:brightness(1.05) }

/* Badge */
.badge{display:inline-block; padding:2px 9px; border-radius:999px; font-weight:900; font-size:11px; background:#eef2f7; color:#334155; border:1px solid #e2e8f0}

/* Separador fino */
.sep{height:1px; margin:22px 0; background:linear-gradient(90deg,rgba(15,23,42,0),rgba(15,23,42,.22) 50%,rgba(15,23,42,0))}

/* Inputs */
.form-inline{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
.form-inline__label{ font-weight:900; font-size:.93rem }
.form-inline input[type="search"], .form-inline input[type="text"], .form-inline input[type="date"], .form-inline input[type="password"], .form-inline input[type="number"], .form-inline select, .form-inline textarea{
  padding:7px 10px; border:1px solid #e5e7eb; border-radius:10px; min-width:190px; font:inherit; font-size:.95rem;
}
.visually-hidden{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0}

/* =========================================================
   CABECERA
========================================================= */
.header{
  position:sticky; top:0; z-index:1000; background:#fff;
  border-bottom:1px solid #eee; transition:box-shadow .25s ease;
}
.header.scrolled{ box-shadow:0 6px 14px rgba(0,0,0,.06) } /* (fix .06) */
.h__in{
  height:var(--hdr-h);
  display:grid; grid-template-columns:auto 1fr auto;
  align-items:flex-start; gap:10px; padding:6px 12px 8px; position:relative;
}
/* Marca de agua mantenimiento (fix alphas .05/.09) */
.header::before{
  content:""; position:absolute; inset:0;
  background:
    linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.05) 60%, rgba(255,255,255,.09) 100%),
    url("logo_mantenimiento.png") center 0px / clamp(260px, 46vw, 420px) auto no-repeat;
  opacity:.10; pointer-events:none;
}
.brand{display:flex; align-items:flex-end; gap:10px; justify-self:center; margin-top:2px}
.brand img{height:40px; margin-top:2px}

#roleChip{
  position:absolute; right:16px; top:8px; font-weight:900; font-size:11px; color:var(--ink)
}
/* Iconos header */
.hbtn{width:42px; height:42px; display:grid; place-items:center}
#hamb .i{width:20px; height:14px; position:relative; display:inline-block}
#hamb .i:before,#hamb .i:after,#hamb .i span{
  content:""; position:absolute; left:0; right:0; height:2px; background:var(--ink); border-radius:2px;
}
#hamb .i:before{top:0} #hamb .i span{top:6px} #hamb .i:after{bottom:0}
#moreBtn .i{display:inline-block; width:16px; text-align:center; letter-spacing:2px; font-weight:900}
#moreBtn .i::before{content:"···"}

/* Overlay menú */
body.menu-open::after{
  content:""; position:fixed; inset:var(--hdr-h) 0 0 0; backdrop-filter:blur(4px); background:rgba(0,0,0,.18); z-index:800;
}

/* =========================================================
   CARRUSEL portada (estilos base)
========================================================= */
.hero-carousel{
  position:relative; overflow:hidden; height:var(--carousel-h); margin:6px 12px 0; border-radius:12px; border:1px solid var(--line);
}
.carousel-track{
  display:flex; width:100%; height:100%;
  will-change:transform; transform:translateX(0); transition:transform .35s ease;
}
.carousel-track.is-fading{ filter:saturate(1.02) contrast(1.02); }
.carousel-slide{ flex:0 0 100%; height:100% }
.carousel-slide img{ width:100%; height:100%; object-fit:cover }
.carousel-ctrl{
  position:absolute; top:50%; transform:translateY(-50%);
  width:36px; height:36px; display:grid; place-items:center; border-radius:999px;
  background:rgba(255,255,255,.75); /* (fix .75) */
  border:1px solid #e2e8f0;
}
.carousel-prev{ left:8px } .carousel-next{ right:8px }
.carousel-ctrl:hover{ background:#fff }
.carousel-dots{ display:none }

/* =========================================================
   SIDENAV
========================================================= */
#sidenav{
  position:fixed; inset:var(--hdr-h) 0 0 0; background:#fff; color:var(--ink);
  transform:translateX(-100%); transition:transform .25s ease; z-index:900; box-shadow:4px 0 24px rgba(0,0,0,.08);
}
#sidenav.open{transform:none}
.sidenav__head{display:flex; align-items:center; gap:12px; padding:12px 14px}

/* Reordenado: buscador + Ir + X negra en misma fila */
.sidenav__search{
  padding:10px 14px; display:grid; grid-template-columns:1fr auto auto; gap:8px; align-items:center
}
#closeNav{
  margin-left:0; width:38px; height:38px; font-size:18px; line-height:1;
  border-radius:8px; background:#000; color:#fff; border:1px solid #000;
}
.sidenav__search input{flex:1 1 auto; padding:10px 12px; border:1px solid var(--line); border-radius:12px; font-weight:600}

/* navegación */
.navlist{padding:4px 0}
.navlist a{
  display:block; padding:14px; font-weight:900; text-transform:uppercase; outline:none; position:relative; font-size:.94rem;
}
.navlist a:not(:last-child)::after{
  content:""; position:absolute; left:10%; right:10%; height:1.5px; background:linear-gradient(90deg,rgba(0,0,0,0),rgba(15,23,42,.25) 50%,rgba(0,0,0,0));
  bottom:-1px;
}
.navlist a[aria-current="page"]{background:#f6f8fb; box-shadow:inset 4px 0 0 var(--brand)}

/* =========================================================
   PANEL USUARIO
========================================================= */
#userPanel{
  position:fixed; left:0; right:0; top:var(--hdr-h);
  width:100vw; max-width:none;
  background:#0f141c; color:#e6eef7; border:1px solid #223046; border-radius:0; box-shadow:0 20px 36px rgba(0,0,0,.45);
  padding:12px; display:none; z-index:950; font-size:.95rem;
}
#userPanel.show{ display:block }
.up__head{ display:flex; align-items:center; justify-content:space-between; gap:10px }
.up__row{ display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:10px; margin-top:8px }
.up__field label{ display:block; font-weight:900; margin-bottom:4px }
.up__pwdwrap{ position:relative; display:flex; align-items:center }
.up__pwdwrap input{ flex:1 1 auto }
/* Botón de ojo SVG (versión actualizada) */
.eyeBtn{
  width:36px;
  height:36px;
  display:flex;
  align-items:center;
  justify-content:center;
  border:1px solid #223046;
  border-left:0;
  background:#0b101a;
  margin-left:4px;
  border-radius:0 10px 10px 0;
  color:#e6eef7;
  cursor:pointer;
  transition:filter .2s ease;
}
.eyeBtn:hover{ filter:brightness(1.2); }
.eyeBtn svg{
  width:20px;
  height:20px;
  pointer-events:none;
  fill:currentColor;
  stroke:currentColor;
  stroke-width:2;
}

/* Botones inferiores del panel */
.up__actions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:8px;
}

/* =========================================================
   TITULARES (con angular)
========================================================= */
h1,h2,h3{
  position:relative; margin:20px 0 12px; padding-left:var(--angular-gap); line-height:1.15; white-space:normal;
}
h1{font-size:clamp(1.25rem,3.4vw,1.6rem)}
h2{font-size:clamp(1.02rem,2.6vw,1.22rem)}
h3{font-size:clamp(.95rem,2.2vw,1.08rem)}
h1::before,h2::before,h3::before{
  content:""; position:absolute; left:0; bottom:var(--angular-up);
  width:var(--angular-size); height:var(--angular-size);
  background:url("angular.png") left bottom/contain no-repeat;
  z-index:1; pointer-events:none;
}
/* Quitar angular en subtítulos del DASHBOARD solicitados */
#dashboard .card h2::before{ display:none }

/* =========================================================
   CONTENEDOR Y TARJETAS
========================================================= */
.main{padding:14px; max-width:1160px; margin:0 auto}
.card{background:#fff; border:1px solid var(--line); border-radius:14px; padding:10px; box-shadow:var(--shadow)}
.grid{display:grid; gap:10px}
.grid.cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
.grid.cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
@media (max-width: 980px){ .grid.cols-2, .grid.cols-3 { grid-template-columns: 1fr } }

/* === (NUEVO) Grid de tarjetas de equipos, grúas y auxiliares === */
.grid-eq{ grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); }

/* Hero del dashboard */
.hero{background:transparent; border:0; padding:4px 10px 0;}
.hero h1{margin:2px 0 0; padding-left:0}
.hero h1::before{display:none}
.hero .sub{margin:2px 0 0; font-weight:700; color:#64748b; font-size:.95rem}

/* =========================================================
   TARJETA “Semáforo” horizontal y compacta
========================================================= */
.tl{
  display:grid; grid-template-columns:1fr; gap:8px;
  border:1px solid var(--line); border-radius:12px; padding:8px; box-shadow:var(--shadow);
}
.tl__head{ display:flex; align-items:center; gap:8px; justify-content:space-between; flex-wrap:wrap; }
.tl__id{ display:flex; align-items:center; gap:8px; min-width:180px; }
.tl__name{ font-weight:900; font-size:.92rem; line-height:1.1 }
.tl__badge{ display:inline-block; padding:2px 7px; border-radius:999px; background:#eef2f7; border:1px solid #e2e8f0; font-weight:900; font-size:10px }

/* Semáforo horizontal */
.tl__pole-wrap{ position:relative; }
.tl__pole{ background:#0b101a; border-radius:10px; padding:6px 8px; display:flex; align-items:center; gap:10px; }
.tl__lamp{
  width:14px; height:14px; border-radius:50%;
  border:2px solid #0b101a; outline:2px solid #ffffff; opacity:.45;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.5), rgba(255,255,255,0) 55%);
}
.tl__lamp--g{ background-color:#22c55e }
.tl__lamp--y{ background-color:#fbbf24 }
.tl__lamp--r{ background-color:#ef4444 }
.tl__lamp.active{ opacity:1; box-shadow:0 0 0 2px rgba(255,255,255,.5) inset, 0 0 12px rgba(0,0,0,.22) }

/* Áreas clicables (izq=verde, centro=amarillo, dcha=rojo) */
.tl__hit{ position:absolute; top:0; bottom:0; cursor:pointer }
.tl__hit--g{ left:4px; right:66%; }
.tl__hit--y{ left:33%; right:33%; }
.tl__hit--r{ left:66%; right:4px; }

/* Acciones */
.tl__actions{ display:flex; gap:6px; flex-wrap:wrap }
.tl__actions .btn--danger{ background:var(--brand); color:#fff }

/* Menú “Más opciones” */
.tl__more{ position:relative; display:inline-block }
.tl__arrow{
  cursor:pointer; font-size:14px; line-height:1; padding:3px 6px; border-radius:8px;
  border:1px solid var(--line); background:#fff; font-weight:900; user-select:none;
}
.tl__arrow:active{ transform:translateY(1px) }
.tl__menu{
  display:none; position:absolute; top:calc(100% + 6px); right:0;
  background:#fff; border:1px solid var(--line); border-radius:12px; padding:8px; z-index:12; min-width:190px; box-shadow:var(--shadow);
}
.tl__more.open .tl__menu{ display:grid; gap:6px }
.tl__menu .btn{ width:100%; justify-content:flex-start }

/* =========================================================
   UTILIDADES
========================================================= */
.black{ color:#0f172a; font-weight:900 }

.dbtv-tag{
  position:sticky;
  top:calc(var(--hdr-h) + 6px);
  display:inline-block;
  margin:6px 0;
  padding:5px 9px;
  border:1px solid var(--line);
  border-radius:999px;
  background:#fff;
  font-weight:900;
  font-size:.9rem;
}

/* =================== Dashboard TV: tipografías compactas =================== */
#dashboardtv{ font-size:.92rem }
#dashboardtv .card strong{ font-size:.98rem }
#dashboardtv .badge{ font-size:11px }
#dashboardtv details summary{ font-size:.98rem }

/* =========================================================
   GRID LOGOS INCIDENCIAS
========================================================= */
.inc-logos{
  display:grid; gap:10px;
  grid-template-columns:repeat(3,minmax(0,1fr));
}
@media (max-width:720px){ .inc-logos{ grid-template-columns:repeat(2,minmax(0,1fr)) } }
.inc-logo{
  display:grid; place-items:center; border:1px solid var(--line); border-radius:12px; padding:8px;
  background:#fff; cursor:pointer; transition:transform .08s ease, box-shadow .12s ease;
}
.inc-logo:active{ transform:translateY(1px) }
.inc-logo img{ max-height:54px; width:100%; object-fit:contain }
.inc-listado{ margin-top:8px }
.inc-listado button{
  display:block; width:100%; text-align:left; padding:8px 10px; border-radius:10px; border:1px solid var(--line); background:#fff;
}
.inc-listado button+button{ margin-top:6px }
</style>
</head>
<body>

<!-- =======================================================
     CABECERA
======================================================= -->
<header class="header" id="hdr" role="banner">
  <span id="roleChip">Invitado</span>
  <div class="h__in">
    <button class="hbtn" id="hamb" aria-label="Abrir menú" aria-controls="sidenav" aria-expanded="false"><span class="i"><span></span></span></button>
    <a class="brand" aria-label="Inicio" href="#dashboard">
      <img src="logo-cdl.png" alt="CDL" style="height:40px; margin-top:2px">
    </a>
    <button class="hbtn" id="moreBtn" aria-haspopup="dialog" aria-expanded="false" aria-controls="userPanel"><span class="i"></span></button>
  </div>
</header>

<aside id="sidenav" aria-hidden="true" aria-label="Navegación principal">
  <div class="sidenav__search" style="align-items:center">
    <input id="globalSearch" placeholder="Buscar en la app…" aria-label="Buscar">
    <button id="goSearch" class="btn btn--ghost">Ir</button>
    <button id="closeNav" aria-label="Cerrar menú" style="margin-left:auto;color:#000">✕</button>
  </div>

  <nav class="navlist" id="navList">
    <!-- Se llena en runtime -->
  </nav>
</aside>

<!-- =======================================================
     PANEL DE USUARIO
======================================================= -->
<section id="userPanel" role="dialog" aria-modal="true" aria-labelledby="upTitle">
  <div class="up__head">
    <strong id="upTitle">Ajustes de usuario</strong>
    <button class="btn btn--ghost" id="closeUserPanel" aria-label="Cerrar">Cerrar</button>
  </div>

  <div class="up__row" style="margin-top:10px">
    <div class="up__field">
      <label for="upName">Nombre</label>
      <input id="upName" type="text" placeholder="Tu nombre">
    </div>
    <div class="up__field">
      <label for="upEmail">Correo</label>
      <input id="upEmail" type="email" placeholder="correo@empresa.com">
    </div>
    <div class="up__field up__pwdwrap">
      <label for="upPwd">Contraseña</label>
      <div style="display:flex; width:100%">
        <input id="upPwd" type="password" autocomplete="new-password" placeholder="••••••••" style="border-top-right-radius:0;border-bottom-right-radius:0">
        <button class="eyeBtn" id="togglePwd" aria-label="Mostrar/ocultar contraseña" title="Mostrar/ocultar">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/><circle cx="12" cy="12" r="3.5"/></svg>
        </button>
      </div>
    </div>
  </div>

  <div class="up__actions">
    <button id="saveProfile" class="btn btn--primary">Guardar</button>
    <button id="logoutBtn" class="btn btn--ghost">Cerrar sesión</button>
  </div>
</section>

<main class="main" id="appMain">
  <!-- =====================================================
       DASHBOARD
  ====================================================== -->
  <section id="dashboard" class="card hero" aria-labelledby="dashTitle">
    <h1 id="dashTitle">Panel de mantenimiento</h1>
    <p class="sub">Estado general, accesos rápidos y últimos movimientos</p>
  </section>

  <section class="grid cols-3" aria-label="Accesos rápidos">
    <article class="card">
      <h2>Equipos</h2>
      <div class="tl">
        <div class="tl__head">
          <div class="tl__id">
            <span class="tl__badge">EQUIPOS</span>
            <span class="tl__name">Estado general</span>
          </div>
          <div class="tl__actions">
            <button class="btn" id="eqOpen">Abrir</button>
            <button class="btn btn--dark" id="eqParada">Programar parada</button>
          </div>
        </div>
        <div class="tl__pole-wrap" aria-label="Semáforo equipos">
          <div class="tl__pole">
            <span class="tl__lamp tl__lamp--g" id="eqLampG" aria-hidden="true"></span>
            <span class="tl__lamp tl__lamp--y" id="eqLampY" aria-hidden="true"></span>
            <span class="tl__lamp tl__lamp--r" id="eqLampR" aria-hidden="true"></span>
          </div>
          <span class="tl__hit tl__hit--g" data-target="equipos" data-state="ok" aria-label="Marcar OK"></span>
          <span class="tl__hit tl__hit--y" data-target="equipos" data-state="warn" aria-label="Marcar Aviso"></span>
          <span class="tl__hit tl__hit--r" data-target="equipos" data-state="down" aria-label="Marcar Parada"></span>
        </div>
      </div>
    </article>

    <article class="card">
      <h2>Puentes grúa</h2>
      <div class="tl">
        <div class="tl__head">
          <div class="tl__id">
            <span class="tl__badge">GRÚAS</span>
            <span class="tl__name">Estado general</span>
          </div>
          <div class="tl__actions">
            <button class="btn" id="grOpen">Abrir</button>
            <button class="btn btn--dark" id="grParada">Programar parada</button>
          </div>
        </div>
        <div class="tl__pole-wrap" aria-label="Semáforo grúas">
          <div class="tl__pole">
            <span class="tl__lamp tl__lamp--g" id="grLampG" aria-hidden="true"></span>
            <span class="tl__lamp tl__lamp--y" id="grLampY" aria-hidden="true"></span>
            <span class="tl__lamp tl__lamp--r" id="grLampR" aria-hidden="true"></span>
          </div>
          <span class="tl__hit tl__hit--g" data-target="gruas" data-state="ok" aria-label="Marcar OK"></span>
          <span class="tl__hit tl__hit--y" data-target="gruas" data-state="warn" aria-label="Marcar Aviso"></span>
          <span class="tl__hit tl__hit--r" data-target="gruas" data-state="down" aria-label="Marcar Parada"></span>
        </div>
      </div>
    </article>

    <article class="card">
      <h2>Auxiliares</h2>
      <div class="tl">
        <div class="tl__head">
          <div class="tl__id">
            <span class="tl__badge">AUX</span>
            <span class="tl__name">Estado general</span>
          </div>
          <div class="tl__actions">
            <button class="btn" id="axOpen">Abrir</button>
            <button class="btn btn--dark" id="axParada">Programar parada</button>
          </div>
        </div>
        <div class="tl__pole-wrap" aria-label="Semáforo auxiliares">
          <div class="tl__pole">
            <span class="tl__lamp tl__lamp--g" id="axLampG" aria-hidden="true"></span>
            <span class="tl__lamp tl__lamp--y" id="axLampY" aria-hidden="true"></span>
            <span class="tl__lamp tl__lamp--r" id="axLampR" aria-hidden="true"></span>
          </div>
          <span class="tl__hit tl__hit--g" data-target="aux" data-state="ok" aria-label="Marcar OK"></span>
          <span class="tl__hit tl__hit--y" data-target="aux" data-state="warn" aria-label="Marcar Aviso"></span>
          <span class="tl__hit tl__hit--r" data-target="aux" data-state="down" aria-label="Marcar Parada"></span>
        </div>
      </div>
    </article>
  </section>

  <!-- =====================================================
       INVENTARIO (tarjeta compacta + import CSV controlado)
  ====================================================== -->
  <section id="inventario" class="card" aria-labelledby="invTitle">
    <h2 id="invTitle">Inventario / Consumibles</h2>
    <div class="form-inline">
      <label class="form-inline__label" for="invSearch">Buscar</label>
      <input id="invSearch" type="search" placeholder="Ej: boquilla 1.0, sop. fresa, M8…">
      <button id="invAddBtn" class="btn btn--primary">Añadir repuesto</button>
      <button id="invImportCsvBtn" class="btn">Importar CSV</button>
      <span id="invImportStatus" class="badge" aria-live="polite" style="display:none"></span>
    </div>

    <div id="invAlerts" class="sep" aria-live="polite"></div>

    <div class="grid grid-eq" id="invCats" style="margin-top:10px">
      <!-- Se rellena con categorías + tarjetas -->
    </div>
  </section>

  <!-- =====================================================
       INCIDENCIAS (un único bloque de logos + un único listado)
       (FIX 1 y 2: sin duplicidades de IDs ni grillas)
  ====================================================== -->
  <section id="incidencias" class="card" aria-labelledby="incTitle">
    <h2 id="incTitle">Incidencias</h2>

    <div class="inc-logos" id="incLogosWrap">
      <button class="inc-logo" data-maker="kaltenbach" title="Kaltenbach">
        <img src="./img/Carousel/kaltenbach.webp" alt="Kaltenbach">
      </button>
      <button class="inc-logo" data-maker="trumpf" title="TRUMPF">
        <img src="./img/Carousel/trumpf.webp" alt="TRUMPF">
      </button>
      <button class="inc-logo" data-maker="mazak" title="Mazak">
        <img src="./img/Carousel/mazak.webp" alt="Mazak">
      </button>
      <button class="inc-logo" data-maker="hgg" title="HGG">
        <img src="./img/Carousel/hgg.webp" alt="HGG">
      </button>
      <button class="inc-logo" data-maker="kbs" title="KALTENBACH KBS">
        <img src="./img/Carousel/kbs.webp" alt="KALTENBACH KBS">
      </button>
      <button class="inc-logo" data-maker="gruas" title="Puentes grúa">
        <img src="./img/Carousel/gruas.webp" alt="Puentes grúa">
      </button>
      <button class="inc-logo" data-maker="aux" title="Auxiliares">
        <img src="./img/Carousel/auxiliares.webp" alt="Auxiliares">
      </button>
    </div>

    <!-- ÚNICO contenedor de categorías/listado -->
    <div id="incCatList" class="inc-listado" hidden aria-live="polite"></div>
  </section>

  <!-- =====================================================
       EQUIPOS (listados con grid-eq y buscador plegable)
  ====================================================== -->
  <section id="equipos" class="card" aria-labelledby="eqTitle">
    <h2 id="eqTitle">Equipos</h2>
    <div class="form-inline" style="margin-bottom:6px">
      <button class="btn search-toggle" data-target="eqSearchBox">Buscar ▼</button>
      <div id="eqSearchBox" class="form-inline" hidden>
        <input id="eqSearchText" type="search" placeholder="Filtrar por nombre…">
        <input id="eqSearchDate" type="date">
        <button id="eqSearchGo" class="btn">Aplicar</button>
      </div>
    </div>
    <div class="grid grid-eq" id="eqList">
      <!-- Relleno dinámico -->
    </div>
  </section>

  <!-- =====================================================
       GRÚAS
  ====================================================== -->
  <section id="gruas" class="card" aria-labelledby="grTitle">
    <h2 id="grTitle">Puentes grúa</h2>
    <div class="form-inline" style="margin-bottom:6px">
      <button class="btn search-toggle" data-target="grSearchBox">Buscar ▼</button>
      <div id="grSearchBox" class="form-inline" hidden>
        <input id="grSearchText" type="search" placeholder="Filtrar por nombre…">
        <input id="grSearchDate" type="date">
        <button id="grSearchGo" class="btn">Aplicar</button>
      </div>
    </div>
    <div class="grid grid-eq" id="grList">
      <!-- Relleno dinámico -->
    </div>
  </section>

  <!-- =====================================================
       AUXILIARES
  ====================================================== -->
  <section id="aux" class="card" aria-labelledby="axTitle">
    <h2 id="axTitle">Auxiliares</h2>
    <div class="form-inline" style="margin-bottom:6px">
      <button class="btn search-toggle" data-target="axSearchBox">Buscar ▼</button>
      <div id="axSearchBox" class="form-inline" hidden>
        <input id="axSearchText" type="search" placeholder="Filtrar por nombre…">
        <input id="axSearchDate" type="date">
        <button id="axSearchGo" class="btn">Aplicar</button>
      </div>
    </div>
    <div class="grid grid-eq" id="axList">
      <!-- Relleno dinámico -->
    </div>
  </section>
</main>

<!-- =======================================================
     DASHBOARD TV (sección independiente)
======================================================= -->
<section id="dashboardtv" class="card" aria-labelledby="dbtvTitle">
  <span class="dbtv-tag">DASHBOARD · TV</span>
  <h2 id="dbtvTitle">Resumen en tiempo real</h2>
  <div id="dbtvContent" class="grid cols-3" style="margin-top:8px">
    <!-- Se rellenará dinámicamente (KPIs, últimas incidencias, próximos mantenimientos) -->
  </div>
</section>

<!-- =======================================================
     CONTENEDORES GLOBALES DE UI
======================================================= -->
<!-- Toast / avisos -->
<div id="toast" aria-live="polite" style="position:fixed;left:50%;transform:translateX(-50%);bottom:16px;z-index:2000;"></div>

<!-- Modal genérico -->
<div id="modal" hidden>
  <div id="modalBackdrop" style="position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);z-index:1900;"></div>
  <div id="modalCard" role="dialog" aria-modal="true" aria-labelledby="modalTitle" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px;min-width:300px;max-width:92vw;z-index:2001;">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px">
      <strong id="modalTitle">Detalles</strong>
      <button id="modalClose" class="btn">Cerrar</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<!-- Modal QR (para fichas de equipos/grúas/aux) -->
<div id="qrModal" hidden>
  <div id="qrBackdrop" style="position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);z-index:1900;"></div>
  <div id="qrCard" role="dialog" aria-modal="true" aria-labelledby="qrTitle" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px;min-width:280px;max-width:90vw;z-index:2001;">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px">
      <strong id="qrTitle">QR del equipo</strong>
      <button id="qrClose" class="btn">Cerrar</button>
    </div>
    <div id="qrBody" style="display:grid;place-items:center;min-height:200px">
      <!-- canvas/img QR -->
    </div>
  </div>
</div>

<!-- =======================================================
     CARRUSEL PORTADA (UBICADO AL FINAL, COMO ACORDADO)
======================================================= -->
<div class="hero-carousel" id="homeCarousel" aria-label="Promos y accesos">
  <button class="carousel-ctrl carousel-prev" aria-label="Anterior">‹</button>
  <div class="carousel-track" id="carouselTrack">
    <div class="carousel-slide"><img src="./img/Carousel/kaltenbach.webp" alt="Kaltenbach"></div>
    <div class="carousel-slide"><img src="./img/Carousel/trumpf.webp" alt="TRUMPF"></div>
    <div class="carousel-slide"><img src="./img/Carousel/mazak.webp" alt="Mazak"></div>
    <div class="carousel-slide"><img src="./img/Carousel/hgg.webp" alt="HGG"></div>
    <div class="carousel-slide"><img src="./img/Carousel/kbs.webp" alt="KALTENBACH KBS"></div>
    <div class="carousel-slide"><img src="./img/Carousel/gruas.webp" alt="Puentes grúa"></div>
    <div class="carousel-slide"><img src="./img/Carousel/auxiliares.webp" alt="Auxiliares"></div>
  </div>
  <button class="carousel-ctrl carousel-next" aria-label="Siguiente">›</button>
  <div class="carousel-dots" id="carouselDots" aria-hidden="true"></div>
</div>

<!-- =======================================================
     NOSCRIPT / FALLBACK
======================================================= -->
<noscript>
  <div style="margin:12px; padding:10px; border:1px solid #fca5a5; border-radius:10px; background:#fef2f2; color:#7f1d1d">
    Activa JavaScript para usar el panel de mantenimiento.
  </div>
</noscript>

<script>
/* ========= API base ========= */
window.API_BASE = "https://script.google.com/macros/s/AKfycbylcSwPb9mVmIAvwJUJMPPp1Dy-Z8YeQoiaFluwrkEIN2HnegOoet0hJq4X_SAH0FZM/exec";
const API_BASE      = window.API_BASE;
const CDL_TOKEN_KEY = "cdl_token";
const CDL_ROLE_KEY  = "cdl_role";

const GET  = async (p)=>{
  const r = await fetch(`${API_BASE}?path=${encodeURIComponent(p)}`, { cache:"no-store" });
  try{ return await r.json(); }catch{ return []; }
};
const POST = async (body)=>{
  const r = await fetch(API_BASE, {
    method:"POST", headers:{"Content-Type":"text/plain;charset=utf-8"},
    body:JSON.stringify(body), cache:"no-store"
  });
  try{ return await r.json(); }catch{ return {ok:false}; }
};

/* ========= ROLES + VISIBILIDAD ========= */
const ROLES = [
  { slug:"gerente",   name:"Gerente" },
  { slug:"admin",     name:"Admin"   },
  { slug:"mantenimiento", name:"Mantenimiento" },
  { slug:"invitado",  name:"Invitado" }
];
function applyRoleVisibility(){
  const role = localStorage.getItem(CDL_ROLE_KEY) || "invitado";
  const chip = document.getElementById("roleChip");
  if(chip){ chip.textContent = (ROLES.find(r=>r.slug===role)?.name || "Invitado"); }
  // Ejemplo: solo gerente/admin ven Dashboard TV
  const dbtv = document.getElementById("dashboardtv");
  if(dbtv){
    const canSee = ["gerente","admin"].includes(role);
    dbtv.style.display = canSee ? "" : "none";
  }
}

/* ========= MENÚ / NAVEGACIÓN ========= */
const NAV_ITEMS = [
  {hash:"#dashboard", label:"Dashboard"},
  {hash:"#inventario", label:"Inventario"},
  {hash:"#incidencias", label:"Incidencias"},
  {hash:"#equipos", label:"Equipos"},
  {hash:"#gruas", label:"Grúas"},
  {hash:"#aux", label:"Auxiliares"},
  {hash:"#dashboardtv", label:"Dashboard TV"}
];
function buildNav(){
  const nav = document.getElementById("navList");
  if(!nav) return;
  nav.innerHTML = NAV_ITEMS.map(i=>`<a href="${i.hash}">${i.label}</a>`).join("");
  markCurrent();
}
function markCurrent(){
  const links = document.querySelectorAll("#navList a");
  links.forEach(a=>a.removeAttribute("aria-current"));
  const h = location.hash || "#dashboard";
  const m = Array.from(links).find(a=>a.getAttribute("href")===h);
  if(m){ m.setAttribute("aria-current","page"); }
}
window.addEventListener("hashchange", markCurrent);

/* ========= BUSCADOR GLOBAL con alias ========= */
const SEARCH_ALIASES = {
  "dashboard":"#dashboard", "inicio":"#dashboard", "home":"#dashboard",
  "inventario":"#inventario", "repuestos":"#inventario", "consumibles":"#inventario",
  "incidencias":"#incidencias", "averias":"#incidencias", "averías":"#incidencias",
  "equipos":"#equipos", "maquinas":"#equipos", "máquinas":"#equipos",
  "gruas":"#gruas", "grúas":"#gruas", "puentes":"#gruas",
  "aux":"#aux", "auxiliares":"#aux",
  "tv":"#dashboardtv", "dashboard tv":"#dashboardtv",
  "ot":"#ot", "ordenes":"#ot", "órdenes":"#ot", "ordenes de trabajo":"#ot", "órdenes de trabajo":"#ot"
};
function resolveSearchToHash(q){
  if(!q) return null;
  const k = q.toLowerCase().trim();
  if(SEARCH_ALIASES[k]) return SEARCH_ALIASES[k];
  // Búsqueda por beginsWith sobre labels
  const hit = NAV_ITEMS.find(i=>i.label.toLowerCase().startsWith(k));
  return hit ? hit.hash : null;
}
function initGlobalSearch(){
  const inp = document.getElementById("globalSearch");
  const go  = document.getElementById("goSearch");
  if(!inp || !go) return;
  go.addEventListener("click", ()=>{
    const h = resolveSearchToHash(inp.value);
    if(h){ location.hash = h; }
  });
  inp.addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){ go.click(); }
  });
}

/* ========= SIDENAV & HEADER ========= */
(function initHeader(){
  const hamb = document.getElementById("hamb");
  const sidenav = document.getElementById("sidenav");
  const closeNav = document.getElementById("closeNav");
  const hdr = document.getElementById("hdr");
  if(hdr){
    const onScroll=()=> hdr.classList.toggle("scrolled", window.scrollY>10);
    onScroll(); window.addEventListener("scroll", onScroll, {passive:true});
  }
  function openNav(){ sidenav?.classList.add("open"); document.body.classList.add("menu-open"); }
  function hideNav(){ sidenav?.classList.remove("open"); document.body.classList.remove("menu-open"); }
  hamb?.addEventListener("click", openNav);
  closeNav?.addEventListener("click", hideNav);
  document.addEventListener("click",(ev)=>{
    if(!sidenav?.classList.contains("open")) return;
    if(!sidenav.contains(ev.target) && ev.target!==hamb){ hideNav(); }
  });
  buildNav();
  initGlobalSearch();
})();

/* ========= PANEL USUARIO ========= */
(function initUserPanel(){
  const moreBtn = document.getElementById("moreBtn");
  const panel   = document.getElementById("userPanel");
  const close   = document.getElementById("closeUserPanel");
  const togglePwd = document.getElementById("togglePwd");
  const pwd = document.getElementById("upPwd");
  const save = document.getElementById("saveProfile");
  const logout = document.getElementById("logoutBtn");

  function open(){ panel?.classList.add("show"); moreBtn?.setAttribute("aria-expanded","true"); }
  function hide(){ panel?.classList.remove("show"); moreBtn?.setAttribute("aria-expanded","false"); }
  moreBtn?.addEventListener("click", ()=> panel?.classList.toggle("show"));
  close?.addEventListener("click", hide);
  document.addEventListener("click",(e)=>{
    if(!panel?.classList.contains("show")) return;
    const inPanel = panel.contains(e.target) || moreBtn===e.target || moreBtn?.contains(e.target);
    if(!inPanel) hide();
  });
  togglePwd?.addEventListener("click", ()=>{
    if(!pwd) return;
    pwd.type = (pwd.type==="password") ? "text" : "password";
  });

  save?.addEventListener("click", async ()=>{
    // Guardado local de ejemplo (ajusta al backend si procede)
    localStorage.setItem("cdl_username", document.getElementById("upName")?.value||"");
    localStorage.setItem("cdl_email",    document.getElementById("upEmail")?.value||"");
    toast("Perfil guardado");
  });
  logout?.addEventListener("click", ()=>{
    localStorage.removeItem(CDL_TOKEN_KEY);
    localStorage.setItem(CDL_ROLE_KEY, "invitado");
    applyRoleVisibility();
    toast("Sesión cerrada");
  });
})();

/* ========= TOAST ========= */
function toast(msg){
  const t = document.getElementById("toast"); if(!t) return;
  const el = document.createElement("div");
  el.textContent = msg;
  el.style.cssText = "background:#0f172a;color:#fff;padding:8px 12px;border-radius:10px;margin-top:8px;box-shadow:0 6px 18px rgba(0,0,0,.3)";
  t.appendChild(el);
  setTimeout(()=>{ el.remove(); }, 2400);
}

/* ========= SEMÁFOROS (horizontal) ========= */
function setTraffic(target, state){
  const map = {equipos:["eqLampG","eqLampY","eqLampR"], gruas:["grLampG","grLampY","grLampR"], aux:["axLampG","axLampY","axLampR"]};
  const ids = map[target]; if(!ids) return;
  ids.forEach((id, i)=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.toggle("active",
      (state==="ok"   && i===0) ||
      (state==="warn" && i===1) ||
      (state==="down" && i===2)
    );
  });
}
(function bindTrafficHits(){
  document.querySelectorAll(".tl__hit").forEach(hit=>{
    hit.addEventListener("click", ()=>{
      setTraffic(hit.dataset.target, hit.dataset.state);
    });
  });
})();

/* ========= BUSCADORES PLEGABLES (Equipos/Grúas/Aux) ========= */
(function bindSearchToggles(){
  document.querySelectorAll(".search-toggle").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const box = document.getElementById(btn.dataset.target);
      if(box) box.hidden = !box.hidden;
    });
  });
})();

/* ========= INVENTARIO ========= */
let _invRaw = [];
function invRenderAlerts(){
  const alertsEl = document.getElementById("invAlerts");
  if(!alertsEl) return;
  const lows = (_invRaw||[]).flatMap(c=>(c.items||[]).filter(i=> Number(i.stock) <= Number(i.min)));
  if(!lows.length){
    alertsEl.style.display="none";
    alertsEl.innerHTML="";
    return;
  }
  alertsEl.style.display="";
  alertsEl.innerHTML = `<div class="card" style="border-color:#f59e0b;background:#fffbeb">
    <strong>Stock bajo:</strong> ${lows.length} referencias al mínimo
  </div>`;
}
function renderInv(){
  const wrap = document.getElementById("invCats"); if(!wrap) return;
  wrap.innerHTML = (_invRaw||[]).map(cat=>{
    const items = (cat.items||[]).map(i=>`
      <div class="card">
        <strong>${i.name}</strong>
        <div style="display:flex;gap:6px;margin-top:6px;align-items:center">
          <span class="badge">Stock: ${i.stock}</span>
          <button class="btn" data-inc="1"  data-id="${i.id}">+1</button>
          <button class="btn" data-inc="-1" data-id="${i.id}">-1</button>
          <button class="btn" data-inc="10" data-id="${i.id}">+10</button>
          <button class="btn" data-inc="-10" data-id="${i.id}">-10</button>
          <button class="btn" data-inc="100" data-id="${i.id}">+100</button>
          <button class="btn" data-inc="-100" data-id="${i.id}">-100</button>
        </div>
      </div>
    `).join("");
    return `<section class="card"><h3>${cat.name}</h3><div class="grid grid-eq">${items}</div></section>`;
  }).join("");

  // Delegación de clicks +/- stock
  wrap.querySelectorAll("button[data-inc]").forEach(b=>{
    b.addEventListener("click", async ()=>{
      const inc = Number(b.dataset.inc||0);
      const id  = b.dataset.id;
      for(const c of _invRaw){
        const it = c.items?.find(x=>x.id===id);
        if(it){ it.stock = String(Math.max(0, Number(it.stock||0)+inc)); break; }
      }
      renderInv(); invRenderAlerts();
      // Envío a API (cola/local si falla)
      queueChange({res:"inv", fn:"ajuste", id, inc});
    });
  });
}
async function invLoad(){
  // 1) Intento API
  let data = await GET("/inv/list");
  if(!Array.isArray(data) || !data.length){
    // 2) Fallback local mínimo (placeholder seguro)
    data = [
      { name:"Consumibles corte", items:[
        {id:"boquilla_10", name:"Boquilla 1.0", stock:"4", min:"3"},
        {id:"boquilla_12", name:"Boquilla 1.2", stock:"0", min:"2"}
      ]},
      { name:"Tornillería", items:[
        {id:"m8x20", name:"Tornillo M8x20", stock:"52", min:"20"}
      ]}
    ];
  }
  _invRaw = data;
  renderInv(); invRenderAlerts();
}
const _queue = [];
function queueChange(op){
  try{
    const k="cdl_queue";
    const q = JSON.parse(localStorage.getItem(k)||"[]");
    q.push({...op, ts:Date.now()});
    localStorage.setItem(k, JSON.stringify(q));
  }catch{}
}
async function flushQueue(){
  const k="cdl_queue";
  let q=[]; try{ q = JSON.parse(localStorage.getItem(k)||"[]"); }catch{}
  if(!q.length) return;
  const sending = [...q]; // snapshot
  const res = await POST({res:"batch", ops:sending});
  if(res?.ok){
    localStorage.setItem(k,"[]");
  }
}
setInterval(flushQueue, 5000);

/* ========= IMPORT CSV CONTROLADO (marca por navegador) ========= */
(function bindInvImport(){
  const btn = document.getElementById("invImportCsvBtn");
  const status = document.getElementById("invImportStatus");
  if(!btn || !status) return;
  const MARK = "inv_csv_imported_v1";
  function show(msg){ status.style.display="inline-block"; status.textContent=msg; }
  btn.addEventListener("click", async ()=>{
    if(localStorage.getItem(MARK)){ show("CSV ya importado"); return; }
    show("Importando…");
    const r = await POST({res:"inv", fn:"import"}); // backend debe procesar CSV de repositorio
    if(r?.ok){ localStorage.setItem(MARK,"1"); show("Importado correctamente"); invLoad(); }
    else{ show("Error al importar"); }
  });
})();

/* ========= INCIDENCIAS (un único bloque de logos + listado único) ========= */
const INC_DB = {
  kaltenbach:["KDP1","KDP3","KBS 1036","KDM"],
  trumpf:["TruLaser 3030","TruBend"],
  mazak:["FG-400 NEO","Mazak FX"],
  hgg:["HGG PipeCut"],
  kbs:["KBS 1036"],
  gruas:["GH-20T Nave A","DEMAG-10T Nave B","GH-5T Exterior"],
  aux:["Compresor Atlas Copco","Secador Kaeser","Caldera aire"]
};
function bindIncidencias(){
  const wrap = document.getElementById("incLogosWrap");
  const list = document.getElementById("incCatList");
  if(!wrap || !list) return;
  wrap.addEventListener("click", (e)=>{
    const btn = e.target.closest(".inc-logo"); if(!btn) return;
    const mk = btn.dataset.maker;
    const items = INC_DB[mk]||[];
    if(!items.length){ list.hidden=true; list.innerHTML=""; return; }
    list.hidden=false;
    list.innerHTML = items.map(n=>`<button data-eq="${n}">${n}</button>`).join("");
  });
}
bindIncidencias();

/* ========= ACCESOS RÁPIDOS desde cabeceras de tarjetas ========= */
document.getElementById("eqOpen")?.addEventListener("click", ()=> location.hash="#equipos");
document.getElementById("grOpen")?.addEventListener("click", ()=> location.hash="#gruas");
document.getElementById("axOpen")?.addEventListener("click", ()=> location.hash="#aux");

/* ========= CARRUSEL SIMPLE ========= */
(function carousel(){
  const track = document.getElementById("carouselTrack");
  const prev  = document.querySelector(".carousel-prev");
  const next  = document.querySelector(".carousel-next");
  if(!track || !prev || !next) return;
  const slides = Array.from(track.children);
  let idx = 0;
  function go(n){
    idx = (n+slides.length)%slides.length;
    track.style.transform = `translateX(-${idx*100}%)`;
    track.classList.add("is-fading");
    setTimeout(()=> track.classList.remove("is-fading"), 220);
  }
  prev.addEventListener("click", ()=> go(idx-1));
  next.addEventListener("click", ()=> go(idx+1));
  let auto = setInterval(()=> go(idx+1), 5000);
  track.addEventListener("pointerdown", ()=>{ clearInterval(auto); auto=null; }, {once:true});
})();

/* ========= QR MODAL (stub) ========= */
function openQR(title, dataURL){
  const m = document.getElementById("qrModal");
  const body = document.getElementById("qrBody");
  document.getElementById("qrTitle").textContent = title||"QR";
  body.innerHTML = dataURL ? `<img src="${dataURL}" alt="QR">` : `<div>Generando QR…</div>`;
  m.hidden = false;
}
document.getElementById("qrClose")?.addEventListener("click", ()=>{ document.getElementById("qrModal").hidden=true; });

/* ========= SW (registro + actualización inmediata) ========= */
if("serviceWorker" in navigator){
  window.addEventListener("load", async ()=>{
    try{
      const reg = await navigator.serviceWorker.register("./sw.js");
      if(reg.waiting){
        reg.waiting.postMessage({type:"SKIP_WAITING"});
      }
      navigator.serviceWorker.addEventListener("controllerchange", ()=>{ location.reload(); });
    }catch(e){ /* noop */ }
  });
}

/* ========= ARRANQUE ========= */
document.addEventListener("DOMContentLoaded", ()=>{
  applyRoleVisibility();
  invLoad();
  flushQueue();
});
</script>

</body>
</html>