<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="format-detection" content="telephone=no">
<title>CDL · CMMS</title>

<!-- Fuente -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest?v=2">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CDL · CMMS">

<!-- Icons -->
<link rel="icon" href="favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="icon-32.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">

<style>
:root{
  --brand1:#A60000; --brand2:#E43B3B;
  --ink:#111827; --muted:#475569; --line:#e5e7eb;
  --bg:#ffffff; --panel:#ffffff;
  --ok:#16a34a; --warn:#f59e0b; --stop:#dc2626;
  --safe-top: env(safe-area-inset-top,0px);
  --safe-bottom: env(safe-area-inset-bottom,0px);
  --hdr-h: 64px;
}
*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  color:var(--ink); background:var(--bg); -webkit-text-size-adjust:100%;
  padding-top:var(--safe-top); padding-bottom:var(--safe-bottom);
}
.hidden{ display:none !important; }
img,canvas,svg,video{ max-width:100%; height:auto; }

/* Header */
header{
  background: var(--panel);
  border-bottom:1px solid var(--line);
  position:sticky; top:0; z-index:2000;
  background-image:url('logo_mantenimiento.png');
  background-repeat:no-repeat;
  background-position:center top;
  background-size:min(560px,92vw) auto;
  padding-top:4px;
}
header .nav{
  min-height:64px; display:flex; align-items:center; justify-content:center;
  position:relative; padding:.35rem .6rem;
}
.hero-title{ display:flex; justify-content:center; }
.hero-title .hero-row{ display:flex; align-items:center; gap:10px; white-space:nowrap; }
.hero-title .hero-panel{ color:#111827; font-weight:900; letter-spacing:.04em; }
.hero-logo-cdl{ height:22px; width:auto; display:inline-block; }
.rolechip{ position:absolute; right:56px; top:6px; font-size:.92rem; font-weight:800; color:#111827; }

/* Menús */
.menu button#pagesBtn,
.menu button#userBtn{
  position:absolute; top:10px; width:36px; height:36px; border-radius:8px;
  border:1px solid #cbd5e1; color:#111827; background:#ffffff; cursor:pointer; display:grid; place-items:center;
}
.menu button#pagesBtn{ left:10px; }
.menu button#userBtn{ right:10px; }
.panel{
  position:absolute; top:56px; left:10px; background:#ffffff; color:#111827;
  border:1px solid var(--line); border-radius:14px; box-shadow:0 24px 60px rgba(0,0,0,.10);
  padding:.6rem; z-index:2100; max-height:calc(100vh - 80px); overflow:auto;
}
.menu-user .panel{ right:10px; left:auto; width:280px; }
.menu-pages .panel{ width:280px; }
.panel .row{ display:flex; flex-direction:column; gap:.5rem; }
.panel .actions{ display:flex; flex-direction:column; gap:.35rem; }

/* Fullscreen panel on mobile */
html.menu-open,body.menu-open{ overflow:hidden; }
.panel.menu-full{
  position:fixed !important; z-index:2400 !important;
  inset: calc(var(--safe-top) + var(--hdr-h)) 0 var(--safe-bottom) 0 !important;
  background:#ffffff !important;
  background-image:linear-gradient(180deg,#ffffff,#f8fafc 60%,#ffffff) !important;
}
.panel.menu-full::before{ content:""; position:absolute; inset:0; background: radial-gradient(1200px 600px at 50% -10%, rgba(0,0,0,.06), transparent 60%); pointer-events:none; }

/* Content */
main{ max-width:1200px; margin:0 auto; padding:.8rem .8rem 1.2rem; }
.card{ background:#ffffff; border:1px solid var(--line); border-radius:12px; padding:.75rem .9rem; margin:.5rem 0; }
.in-txt, input[type="date"], select{
  height:36px; padding:.35rem .55rem; border-radius:10px; border:1px solid #cbd5e1; background:#ffffff; color:#111827;
}
.btn{ display:inline-flex; align-items:center; justify-content:center; gap:.4rem; padding:.42rem .72rem; border-radius:999px; border:1px solid #cbd5e1; background:#ffffff; color:#111827; font-weight:800; }
table{ width:100%; border-collapse:collapse; background:#ffffff; border:1px solid var(--line); border-radius:12px; overflow:hidden; }
thead th{ background:#f8fafc; color:#0f172a; font-weight:800; text-align:left; border-bottom:1px solid var(--line); padding:.55rem .6rem; }
tbody td{ border-top:1px solid var(--line); padding:.5rem .6rem; }

/* TV Dashboard */
.tv-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px; }
.tv-card{ background:#fff; border:1px solid var(--line); border-radius:14px; padding:.8rem; }
.tv-card h3{ margin:.1rem 0 .5rem; font-size:1rem; font-weight:900; letter-spacing:.04em; color:var(--ink); text-transform:uppercase; }
.tv-list{ display:flex; flex-direction:column; gap:.4rem; }
.tv-item{ padding:.45rem .6rem; border-radius:10px; border:1px solid #e5e7eb; background:#fff; font-weight:700; }
.tv-empty{ opacity:.55; font-style:italic; }

.badge{ display:inline-flex; align-items:center; gap:.35rem; padding:.15rem .5rem; border-radius:999px; border:1px solid #cbd5e1; font-weight:800; }
.dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }
.dot-ok{ background:#16a34a; } .dot-warn{ background:#f59e0b; } .dot-stop{ background:#dc2626; }

/* Header shadow on scroll */
header.scrolled{ box-shadow:0 4px 10px rgba(0,0,0,.08); }

/* Password eye */
.pw-toggle{
  width:32px; height:32px; border-radius:8px; border:1px solid #cbd5e1; background:#fff; cursor:pointer;
  background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%236b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>');
  background-repeat:no-repeat; background-position:center;
}
.pw-toggle.on{
  background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%23ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8a19.77 19.77 0 0 1 5.06-5.94M9.9 4.24A10.94 10.94 0 0 1 12 4c7 0 11 8 11 8a19.8 19.8 0 0 1-4.22 5.02M1 1l22 22"/><path d="M14.12 14.12A3 3 0 0 1 9.88 9.88"/></svg>');
}
.small{ font-size:.85rem; color:#64748b; }
.nowrap{ white-space:nowrap; }
.right{ text-align:right; }
</style>
</head>
<body>

<header>
  <div class="nav" id="navBar">
    <div class="menu menu-pages">
      <button id="pagesBtn" aria-label="Menú" aria-expanded="false" aria-controls="pagesPanel">☰</button>
      <div id="pagesPanel" class="panel hidden" aria-label="Menú principal">
        <div class="row">
          <div class="actions">
            <button class="btn" onclick="nav('equipos')">Equipos</button>
            <button class="btn" onclick="nav('gruas')">Puentes Grúa</button>
            <button class="btn" onclick="nav('otros')">Otros</button>
            <button class="btn" onclick="nav('incidencias')">Incidencias</button>
            <button class="btn" onclick="nav('indicadores')">Indicadores</button>
            <button class="btn" onclick="nav('ot')">OT</button>
            <button class="btn" onclick="nav('inventario')">Inventario</button>
            <button class="btn" onclick="nav('repuestos')">Repuestos solicitados</button>
            <button class="btn" onclick="nav('consumibles')">Consumibles</button>
            <button class="btn" onclick="nav('tv')">Dashboard TV</button>
          </div>
        </div>
      </div>
    </div>

    <div class="hero-title">
      <div class="hero-row">
        <img src="logo-cdl.png" alt="CDL" class="hero-logo-cdl">
        <span class="hero-panel">PANEL DE CONTROL</span>
      </div>
    </div>

    <span id="roleChip" class="rolechip" aria-label="Rol actual">Invitado</span>
    <div class="menu menu-user">
      <button id="userBtn" aria-label="Usuario" aria-expanded="false" aria-controls="userPanel">⋮</button>
      <div id="userPanel" class="panel hidden" aria-label="Panel de usuario">
        <div class="row">
          <label class="small">Usuario</label>
          <select id="userSelect">
            <option value="invitado">Invitado</option>
            <option value="admin">Administrador</option>
            <option value="gerente">Gerente</option>
            <option value="encargado">Encargado</option>
            <option value="produccion">Producción</option>
            <option value="rt11">RT1.1</option>
            <option value="rt12">RT1.2</option>
            <option value="rt21">RT2.1</option>
            <option value="rt22">RT2.2</option>
            <option value="rt31">RT3.1</option>
            <option value="rt32">RT3.2</option>
            <option value="tcoint">Tco.INT</option>
            <option value="subc">Subcontrata</option>
          </select>

          <label class="small" style="margin-top:.4rem">Contraseña</label>
          <div class="pw" style="display:flex;gap:.4rem;align-items:center">
            <input id="userPass" type="password" placeholder="••••••••" style="flex:1">
            <button type="button" class="pw-toggle" data-target="userPass" aria-label="Mostrar contraseña" aria-pressed="false"></button>
          </div>

          <div class="actions" style="margin-top:.6rem;display:flex;gap:.4rem;flex-wrap:wrap">
            <button class="btn" onclick="login()">Entrar</button>
            <button class="btn" onclick="logout()">Salir</button>
          </div>
        </div>

        <div class="row" style="margin-top:.8rem">
          <label class="small">Cambiar contraseña</label>
          <div class="pw" style="display:flex;gap:.4rem;align-items:center">
            <input id="oldPass" type="password" placeholder="Actual" style="flex:1">
            <button type="button" class="pw-toggle" data-target="oldPass" aria-label="Mostrar contraseña" aria-pressed="false"></button>
          </div>
          <div class="pw" style="margin-top:.4rem;display:flex;gap:.4rem;align-items:center">
            <input id="newPass" type="password" placeholder="Nueva" style="flex:1">
            <button type="button" class="pw-toggle" data-target="newPass" aria-label="Mostrar contraseña" aria-pressed="false"></button>
          </div>
          <div class="actions" style="margin-top:.6rem">
            <button class="btn" onclick="changePwd()">Cambiar</button>
          </div>
          <div id="pwdMsg" class="small" style="margin-top:.4rem;color:#374151"></div>
        </div>
      </div>
    </div>
  </div>
</header>

<main>
  <!-- Resumen -->
  <section id="status-strip">
    <div style="max-width:1200px;margin:0 auto;padding:.55rem .8rem;display:flex;gap:.8rem;align-items:center;flex-wrap:wrap">
      <div style="font-weight:900;letter-spacing:.02em">RESUMEN</div>
      <div style="display:flex;gap:.6rem;flex-wrap:wrap;align-items:center">
        <span id="sumStop" class="badge"><span class="dot dot-stop"></span><span>Paradas:</span><b id="kStop">0</b></span>
        <span id="sumWarn" class="badge"><span class="dot dot-warn"></span><span>Restricciones:</span><b id="kWarn">0</b></span>
        <span id="sumOk"   class="badge"><span class="dot dot-ok"></span><span>En marcha:</span><b id="kOk">0</b></span>
        <span id="sumAll"  class="badge"><span>Total:</span><b id="kAll">0</b></span>
      </div>
      <div style="margin-left:auto;font-weight:700;color:#64748b">Última actualización: <span id="kUpdated">—</span></div>
    </div>
  </section>

  <!-- Equipos -->
  <section id="page-equipos" class="">
    <h2 class="cdl-tag">Equipos</h2>
    <div class="brand-wrap">
      <img src="linea-kaltenbach.png" alt="LÍNEA KALTENBACH"
           loading="lazy" decoding="async" fetchpriority="low"
           onerror="this.closest('.brand-wrap').classList.add('fallback'); this.remove();">
    </div>
    <div id="legend-equipos" style="display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;margin:.5rem 0">
      <span style="display:inline-flex;align-items:center;gap:.4rem"><span class="dot dot-stop"></span>Parada</span>
      <span style="display:inline-flex;align-items:center;gap:.4rem"><span class="dot dot-warn"></span>Restricciones</span>
      <span style="display:inline-flex;align-items:center;gap:.4rem"><span class="dot dot-ok"></span>En marcha</span>
    </div>
    <div id="equiposWrap"></div>
  </section>

  <!-- Otras páginas -->
  <section id="page-gruas" class="hidden"><h2 class="cdl-tag">Puentes Grúa</h2><div id="gruasWrap"></div></section>
  <section id="page-otros" class="hidden"><h2 class="cdl-tag">Otros (auxiliares)</h2><div id="otrosWrap"></div></section>
  <section id="page-equipo" class="hidden"><div id="equipoDetail"></div></section>
  <section id="page-repuesto" class="hidden"><div id="repuestoDetail"></div></section>
  <section id="page-inv" class="hidden"><h2 class="cdl-tag">Inventario</h2><div id="invWrap"></div></section>
  <section id="page-rep" class="hidden"><h2 class="cdl-tag">Repuestos solicitados</h2><div id="repWrap"></div></section>
  <section id="page-cons" class="hidden"><h2 class="cdl-tag">Consumibles recurrentes</h2><div id="consWrap"></div></section>
  <section id="page-ot" class="hidden"><h2 class="cdl-tag">Órdenes de trabajo</h2><div id="otWrap"></div></section>
  <section id="page-personal" class="hidden"><h2 class="cdl-tag">Personal</h2><div id="personalWrap"></div></section>
  <section id="page-logs" class="hidden"><h2 class="cdl-tag">Histórico de logs</h2><div id="logsWrap"></div></section>
  <section id="page-incidencias" class="hidden"><h2 class="cdl-tag">Incidencias</h2><div id="incidTableWrap"></div></section>

  <!-- TV Dashboard -->
  <section id="page-tv" class="">
    <h2 class="cdl-tag">Dashboard TV</h2>
    <div class="tv-grid" id="tvGrid">
      <article class="tv-card"><h3><span class="badge"><span class="dot dot-stop"></span> PARADAS</span></h3><div id="tvParadas" class="tv-list"></div></article>
      <article class="tv-card"><h3><span class="badge"><span class="dot dot-warn"></span> RESTRICCIONES</span></h3><div id="tvRestr" class="tv-list"></div></article>
      <article class="tv-card"><h3><span class="badge">REPUESTOS · URGENCIA</span></h3><div id="tvRep" class="tv-list"></div></article>
      <article class="tv-card"><h3><span class="badge">PARADAS PREVISTAS (OT)</span></h3><div id="tvPrev" class="tv-list"></div></article>
    </div>
  </section>
</main>

<!-- Toast -->
<div id="toast" class="hidden" aria-live="polite"></div>

<script>
/* ===== Helpers básicos ===== */
const $id = (id)=>document.getElementById(id);
const $$ = (s)=>Array.from(document.querySelectorAll(s));
const esc = (str)=>String(str??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
const API_BASE = "https://script.google.com/macros/s/AKfycbzPxPJztSCo7dX-xmzYW_pBwkQne3aACe1EzzlNDsjr0nuRXZaOSOrRGzVrYZsN5cgF/exec";

async function apiGet(q){ const u=new URL(API_BASE); Object.entries(q).forEach(([k,v])=>u.searchParams.set(k,v)); const r=await fetch(u); return r.json(); }
async function apiPost(q){ const r=await fetch(API_BASE,{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(q)}); return r.json(); }
function fmtDate(d){ if(!d) return ""; const dt=new Date(d); return isNaN(dt)? String(d) : dt.toLocaleString("es-ES",{hour12:false}); }
function toast(msg){ const t=$id("toast"); if(!t) return alert(msg); t.classList.remove("hidden"); t.textContent=msg; t.style.position="fixed"; t.style.left="50%"; t.style.bottom="16px"; t.style.transform="translateX(-50%)"; t.style.background="#0b0f15"; t.style.color="#e5e7eb"; t.style.border="1px solid #1f2937"; t.style.padding=".5rem .8rem"; t.style.borderRadius="12px"; t.style.boxShadow="0 10px 26px rgba(0,0,0,.35)"; clearTimeout(window.__TOAST_T); window.__TOAST_T=setTimeout(()=>t.classList.add("hidden"),1800); }

/* ===== Estado usuario ===== */
let USER = JSON.parse(localStorage.getItem("CDL_USER")||"{}");
if(!USER.user){ USER = { user:"invitado", rol:"Invitado", group:"guest" }; }
function setUser(u){ USER=u; localStorage.setItem("CDL_USER",JSON.stringify(u)); applyRoleUI(); }
function applyRoleUI(){ $id("roleChip").textContent = USER.rol; }

/* ===== Router / Nav ===== */
const PAGES = {equipos:"page-equipos",gruas:"page-gruas",otros:"page-otros",incidencias:"page-incidencias",indicadores:"page-indicadores",ot:"page-ot",inventario:"page-inv",repuestos:"page-rep",consumibles:"page-cons",tv:"page-tv",personal:"page-personal",logs:"page-logs",equipo:"page-equipo",repuesto:"page-repuesto"};
function ensureHidden(){ $$('[id^="page-"]').forEach(el=>el.classList.add("hidden")); }
function nav(page){ const id=PAGES[page]||PAGES.equipos; ensureHidden(); $id(id)?.classList.remove("hidden"); location.hash="#/"+page; }

/* Menús + fullscreen móvil */
(function(){
  const pagesBtn=$id("pagesBtn"), pagesPanel=$id("pagesPanel");
  const userBtn=$id("userBtn"), userPanel=$id("userPanel");
  const open=(btn,panel,fs)=>{ closeAll(); panel.classList.remove("hidden"); if(fs && matchMedia("(max-width: 720px)").matches){ panel.classList.add("menu-full"); document.documentElement.classList.add("menu-open"); document.body.classList.add("menu-open"); } btn.setAttribute("aria-expanded","true"); };
  const close=(btn,panel)=>{ if(!panel) return; panel.classList.add("hidden"); panel.classList.remove("menu-full"); btn?.setAttribute("aria-expanded","false"); document.documentElement.classList.remove("menu-open"); document.body.classList.remove("menu-open"); };
  const closeAll=()=>{ close(pagesBtn,pagesPanel); close(userBtn,userPanel); };
  pagesBtn?.addEventListener("click",()=> pagesPanel.classList.contains("hidden") ? open(pagesBtn,pagesPanel,true) : close(pagesBtn,pagesPanel));
  userBtn ?.addEventListener("click",()=> userPanel .classList.contains("hidden") ? open(userBtn ,userPanel ,false) : close(userBtn ,userPanel ));
  document.addEventListener("click",(e)=>{ if(e.target.closest("#pagesPanel,#pagesBtn,#userPanel,#userBtn")) return; closeAll(); }, {passive:true});
  document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeAll(); }, {passive:true});
})();

/* Header shadow + timestamp */
(function(){
  const hdr=document.querySelector("header");
  const onScroll=()=>{ if(window.scrollY>2) hdr.classList.add("scrolled"); else hdr.classList.remove("scrolled"); };
  onScroll(); window.addEventListener("scroll",onScroll,{passive:true});
  function updateTS(){ const d=new Date(); const el=$id("kUpdated"); if(el) el.textContent=d.toLocaleString("es-ES",{hour12:false}); }
  setInterval(updateTS,30e3); updateTS();
})();

/* Password eye (delegado) */
document.addEventListener("click",(e)=>{
  const btn=e.target.closest(".pw-toggle"); if(!btn) return;
  const id=btn.getAttribute("data-target"); const inp=$id(id); if(!inp) return;
  const to = inp.type==="password" ? "text" : "password"; inp.type=to;
  btn.classList.toggle("on", to==="text"); btn.setAttribute("aria-pressed", to==="text"?"true":"false");
});

/* ===== Datos globales ===== */
window.STATE=[]; window.INCID=[]; window.INV=[]; window.REP=[]; window.CONS=[]; window.OTS=[];

/* ===== Cargas ===== */
async function loadState(){
  try{
    const r = await apiGet({res:"state", fn:"list"});
    STATE = Array.isArray(r?.items) ? r.items : [];
    const nStop = STATE.filter(x=>x.estado==="Parada").length;
    const nWarn = STATE.filter(x=>x.estado==="Restricciones").length;
    const nOk   = STATE.filter(x=>x.estado==="En marcha").length;
    $id("kStop").textContent=nStop; $id("kWarn").textContent=nWarn; $id("kOk").textContent=nOk; $id("kAll").textContent=STATE.length;
    renderEquiposList();
    renderTV();
  }catch(e){ console.error(e); }
}
function badge(color, txt){ return `<span class="badge"><i style="width:10px;height:10px;border-radius:50%;background:${color};display:inline-block"></i><b>${txt}</b></span>`; }
function slugify(s){ return String(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""); }
function renderEquiposList(){
  const wrap=$id("equiposWrap"); if(!wrap) return;
  const items=STATE||[];
  if(!items.length){ wrap.innerHTML=`<div class="card">Sin datos</div>`; return; }
  const colores = { "Parada":"#dc2626", "Restricciones":"#f59e0b", "En marcha":"#16a34a" };
  const grupos = {}; items.forEach(it=>{ (grupos[it.grupo]=grupos[it.grupo]||[]).push(it); });
  wrap.innerHTML = Object.entries(grupos).map(([g,arr])=>{
    const filas = arr.map(it=>{
      const c = colores[it.estado]||"#64748b";
      return `<div class="card" style="display:flex;align-items:center;gap:.6rem;justify-content:space-between">
        <div><b>${esc(it.nombre)}</b><div class="small" style="color:#64748b">${esc(g)}</div></div>
        <div>${badge(c, esc(it.estado))}</div>
        <div style="display:flex;gap:.4rem;flex-wrap:wrap">
          <button class="btn" onclick="location.hash='#/equipo/${encodeURIComponent(slugify(it.nombre))}'">Ficha</button>
          <button class="btn" onclick="accionParadaProlongada(${JSON.stringify(it.nombre)})">Parada prolongada</button>
        </div>
      </div>`;
    }).join("");
    return `<div><h3 style="margin:.6rem 0 .2rem">${esc(g)}</h3>${filas}</div>`;
  }).join("");
}

/* ===== TV ===== */
function renderTV(){
  const STATE_ = STATE||[]; const REP_ = REP||[]; const OTS_ = OTS||[];
  const par = STATE_.filter(x=>x.estado==="Parada").map(x=>x.nombre).sort();
  const res = STATE_.filter(x=>x.estado==="Restricciones").map(x=>x.nombre).sort();
  const rank = { "Alta":3, "Media":2, "Baja":1 };
  const repRows = REP_.map(r=>({ txt:`${r.ref} — ${r.nombre||""} · <span class="urg urg-${(r.urgencia||'baja').toLowerCase()}">${r.urgencia||'Baja'}</span> · Entrega: ${r.entrega?fmtDate(r.entrega):"—"}`, urg:rank[(r.urgencia||"Baja")]||1, eta:new Date(r.entrega||r.fecha||r.fechaPrevista||"2100-01-01").getTime() })).sort((a,b)=> (b.urg-a.urg)||(a.eta-b.eta)).map(x=>`<div class="tv-item">${x.txt}</div>`).join("");
  const prev = OTS_.filter(o=> /prevent/i.test(o.titulo||o.tipo||"") || /prevent/i.test(o.prioridad||"")).map(o=>({ t:`${o.id||""} — ${o.titulo||""} · Vence: ${fmtDate(o.vencimiento)}`, v:new Date(o.vencimiento||"2100-01-01").getTime() })).sort((a,b)=>a.v-b.v).map(x=>`<div class="tv-item">${x.t}</div>`).join("");
  const fill = (id,arr)=>{ const el=$id(id); if(!el) return; el.innerHTML = (Array.isArray(arr) ? arr : []).length ? arr.map(t=>`<div class="tv-item">${t}</div>`).join("") : `<div class="tv-item tv-empty">—</div>`; };
  fill("tvParadas", par);
  fill("tvRestr", res);
  $id("tvRep").innerHTML = repRows || `<div class="tv-item tv-empty">—</div>`;
  $id("tvPrev").innerHTML = prev || `<div class="tv-item tv-empty">—</div>`;
}
let TV_T=null; function initTV(){ renderTV(); if(TV_T) clearInterval(TV_T); TV_T=setInterval(renderTV, 10000); }

/* ===== Otras cargas ===== */
async function loadIncid(){ try{ const r=await apiGet({res:"incid", fn:"list"}); if(r?.ok) { INCID=r.items||[]; } }catch(e){ console.error(e); } }
async function loadInv(){ try{ const r=await apiGet({res:"inv", fn:"list"}); if(r?.ok) { INV=r.items||[]; } }catch(e){ console.error(e); } }
async function loadRepSol(){ try{ const r=await apiGet({res:"rep", fn:"list"}); if(r?.ok) { REP=r.items||[]; renderTV(); } }catch(e){ console.error(e); } }
async function loadConsumibles(){ try{ const r=await apiGet({res:"cons", fn:"list"}); if(r?.ok) { CONS=r.items||[]; } }catch(e){ console.error(e); } }
async function loadOT(){ try{ const r=await apiGet({res:"ot", fn:"list"}); if(r?.ok) { OTS=r.items||[]; renderTV(); } }catch(e){ console.error(e); } }

/* ===== Acciones ===== */
async function invDelta(ref, delta){ try{ const r = await apiPost({res:"inv", fn:"delta", ref, delta, actor:USER.user}); if (r?.ok){ toast("Stock actualizado: "+ref); loadInv(); } }catch(e){ console.error(e); } }
async function accionParadaProlongada(equipo){
  try{
    const r = await apiPost({res:"mail", fn:"parada_prolongada", equipo, actor:(USER?.user||"anon")});
    if (r?.ok){ toast("Aviso enviado"); return; }
    throw new Error("mail api not ok");
  }catch(_){
    const subj = encodeURIComponent(`[CDL] Parada prolongada — ${equipo}`);
    const body = encodeURIComponent(`Equipo: ${equipo}\nFecha: ${new Date().toLocaleString("es-ES",{hour12:false})}\n\nDetalle: ...`);
    location.href = `mailto:?subject=${subj}&body=${body}`;
  }
}

/* ===== Login / logout / cambio pass ===== */
async function login(){
  const uSel=$id("userSelect"); const pInp=$id("userPass");
  const u=uSel?.value||"invitado"; const p=pInp?.value||"";
  try{
    const r = await apiPost({res:"auth", fn:"login", user:u, pass:p, cid:(localStorage.getItem("CDL_CID")||"")});
    if (r?.ok){ setUser({user:u, rol:r.rol||u, group:r.group||"guest"}); toast("Bienvenido "+u); closeMenus(); }
    else alert("Usuario o contraseña incorrectos");
  }catch(e){ console.error(e); alert("Error en la conexión al servidor"); }
}
function logout(){ localStorage.removeItem("CDL_USER"); setUser({ user:"invitado", rol:"Invitado", group:"guest" }); toast("Sesión cerrada"); closeMenus(); }
async function changePwd(){
  const oldP=$id("oldPass")?.value||""; const newP=$id("newPass")?.value||""; const msg=$id("pwdMsg");
  if(!oldP||!newP){ alert("Introduce la contraseña actual y la nueva"); return; }
  try{
    const r = await apiPost({res:"auth", fn:"chpwd", old:oldP, nuevo:newP, cid:(localStorage.getItem("CDL_CID")||"")});
    if(r?.ok){ if(msg){ msg.textContent="Contraseña cambiada correctamente"; msg.style.color="green"; } $id("oldPass").value=""; $id("newPass").value=""; }
    else { if(msg){ msg.textContent="Error al cambiar la contraseña"; msg.style.color="red"; } }
  }catch(e){ console.error(e); if(msg){ msg.textContent="Error de red"; msg.style.color="red"; } }
}
function closeMenus(){ ["pagesPanel","userPanel"].forEach(id=>{ const p=$id(id); if(p) p.classList.add("hidden"); }); document.documentElement.classList.remove("menu-open"); document.body.classList.remove("menu-open"); }

/* ===== Router ===== */
function handleHash(){
  const h=location.hash||"";
  if (!h){ nav("tv"); return; }
  const mEq=h.match(/^#\/equipo\/(.+)$/);
  const mRp=h.match(/^#\/repuesto\/(.+)$/);
  if (mEq){ renderEquipoBySlug(mEq[1]); return; }
  if (mRp){ const ref=decodeURIComponent(mRp[1]||""); renderRepuestoByRef(ref); return; }
  const p=h.replace(/^#\/?/,"");
  const pages=Object.keys(PAGES);
  if (pages.includes(p)){ nav(p); return; }
  nav("tv");
}
window.addEventListener("hashchange", handleHash);

/* ===== QR lib (lazy) ===== */
(function loadQR(){ if (window.QRCode || document.querySelector('script[data-qrcode-lib]')) return; const s=document.createElement("script"); s.src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"; s.setAttribute("data-qrcode-lib","1"); document.head.appendChild(s); })();

/* ===== Fichas ===== */
function baseURL(){ return (location.origin + location.pathname); }
function renderEquipoBySlug(slug){
  ensureHidden(); $id("page-equipo").classList.remove("hidden"); const host=$id("equipoDetail");
  const eq=(STATE||[]).find(x => slugify(x.nombre)===slug);
  if(!host || !eq){ host.innerHTML="<div class='card'>No encontrado</div>"; return; }
  host.innerHTML = `
    <div class="card">
      <h3 style="margin:.1rem 0">${esc(eq.nombre)}</h3>
      <div class="sub">${esc(eq.grupo)}</div>
      <div style="margin:.5rem 0">Estado actual: <b>${esc(eq.estado)}</b></div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn" onclick="accionParadaProlongada(${JSON.stringify(eq.nombre)})">Parada prolongada (email)</button>
        <button class="btn" onclick="window.print()">Imprimir ficha</button>
        <button class="btn" onclick="history.back()">Volver</button>
      </div>
      <div style="margin-top:.6rem"><div id="qrficha"></div></div>
    </div>
  `;
  const qr=$id("qrficha"); if(qr && window.QRCode){ new QRCode(qr,{ text: `${baseURL()}#/equipo/${slug}`, width:96, height:96 }); }
}
function openRepuestoByRef(ref){ location.hash = `#/repuesto/${encodeURIComponent(ref)}`; renderRepuestoByRef(ref); }
function renderRepuestoByRef(ref){
  ensureHidden(); $id("page-repuesto").classList.remove("hidden"); const host=$id("repuestoDetail");
  const it=(INV||[]).find(x=>String(x.ref).toUpperCase()===String(ref).toUpperCase());
  if(!host || !it){ host.innerHTML="<div class='card'>No encontrado</div>"; return; }
  host.innerHTML = `
    <div class="card">
      <h3 style="margin:.1rem 0">${esc(it.nombre)}</h3>
      <div class="sub">Ref: <b>${esc(it.ref)}</b></div>
      <div style="margin:.5rem 0">Stock: <b>${it.stock}</b> · Mínimo: <b>${it.minimo}</b></div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn" onclick="window.print()">Imprimir etiqueta</button>
        <button class="btn" onclick="history.back()">Volver</button>
      </div>
      <div style="margin-top:.6rem"><div id="qrrep"></div></div>
    </div>
  `;
  const qr=$id("qrrep"); if(qr && window.QRCode){ new QRCode(qr,{ text: `${baseURL()}#/repuesto/${encodeURIComponent(it.ref)}`, width:96, height:96 }); }
}

/* ===== SW register ===== */
if ('serviceWorker' in navigator){
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('sw.js', { updateViaCache: 'none' });
      if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
      reg.addEventListener('updatefound', () => {
        const nw = reg.installing;
        nw && nw.addEventListener('statechange', () => {
          if (nw.state === 'installed' && navigator.serviceWorker.controller) {
            reg.waiting && reg.waiting.postMessage({ type: 'SKIP_WAITING' });
          }
        });
      });
      navigator.serviceWorker.addEventListener('controllerchange', () => location.reload());
    } catch (e) { console.error('SW register error', e); }
  });
}

/* ===== Boot ===== */
document.addEventListener("DOMContentLoaded", async ()=>{
  applyRoleUI();
  await Promise.all([ loadState(), loadIncid(), loadInv(), loadRepSol(), loadConsumibles(), loadOT() ]);
  initTV();
  if(!location.hash) nav('tv'); else handleHash();
});
</script>
</body>
</html>