<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>CDL ¬∑ Panel de control</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --brand:#E43B3B;        /* rojo corporativo */
  --ink:#0f172a;          /* texto principal */
  --muted:#475569;        /* texto suave */
  --line:#e5e7eb;         /* l√≠neas finas */
  --bg:#ffffff;           /* fondo unificado */
  --hdr-h:100px;
  --nav-w:380px;
  --radius:18px;
}

/* Reset */
*{box-sizing:border-box}
html,body{height:100%; background:#fff; overflow-x:hidden}
body{margin:0; font-family:Inter,system-ui,sans-serif; color:var(--ink)}
a{color:inherit; text-decoration:none}
img{display:block; max-width:100%}

/* ====== Cabecera ====== */
.header{position:sticky; top:0; z-index:1000; background:#fff; border-bottom:1px solid #eee}
.header::before{
  content:""; position:absolute; inset:0 0 50% 0;          /* mitad superior */
  background:url("logo_mantenimiento.png") center 12px/540px auto no-repeat;
  opacity:.12; pointer-events:none;
}
.h__in{height:var(--hdr-h); display:flex; align-items:flex-end; gap:12px; padding:10px 16px 16px}

/* Marca */
.brand{display:flex; align-items:flex-end; gap:10px}
.brand img{height:40px}                                     /* m√°s contenido */
.brand__title{font-weight:800; letter-spacing:.02em; text-transform:uppercase; white-space:nowrap}

/* Rol arriba derecha (sin p√≠ldora) */
#roleChip{position:absolute; right:16px; top:8px; font-weight:800; font-size:12px}

/* Botones cabecera sin p√≠ldora */
.hbtn{width:44px; height:44px; display:grid; place-items:center; background:transparent; border:0; padding:0; color:#0f172a}

/* Hamburguesa (compacta y est√©tica) */
#hamb .i{width:22px; height:16px; position:relative; display:inline-block}
#hamb .i:before,#hamb .i:after,#hamb .i span{
  content:""; position:absolute; left:0; right:0; height:2px; background:#0f172a; border-radius:2px;
}
#hamb .i:before{top:0} #hamb .i span{top:7px} #hamb .i:after{bottom:0}

/* Tres puntos compactos (√∫nicos) */
#moreBtn .i{display:inline-block; width:18px; text-align:center; letter-spacing:2px; font-weight:800}
#moreBtn .i::before{content:"¬∑¬∑¬∑"}

/* ====== SideNav (pantalla completa y sin tapar cabecera) ====== */
#sidenav{
  position:fixed; inset:var(--hdr-h) 0 0 0;
  background:#fff; color:#0f172a; transform:translateX(-100%);
  transition:transform .25s ease; z-index:900; box-shadow:4px 0 24px rgba(0,0,0,.08);
}
#sidenav.open{transform:none}
.sidenav__head{display:flex; align-items:center; gap:12px; padding:14px 16px}
.sidenav__head img{height:52px}                              /* logo mantenimiento grande */
#closeNav{margin-left:auto; width:40px; height:40px; background:transparent; border:0; font-size:22px; cursor:pointer}
.sidenav__search{padding:0 16px 10px}
.sidenav__search input{width:100%; padding:12px 14px; border:1px solid #e5e7eb; border-radius:12px; font-weight:600}

/* Items en MAY√öSCULAS + separadores difuminados */
.navlist{padding:6px 0}
.navlist a{display:block; padding:16px; font-weight:800; text-transform:uppercase}
.navlist a:not(:last-child){position:relative}
.navlist a:not(:last-child)::after{
  content:""; position:absolute; left:10%; right:10%; bottom:-1px; height:1.5px;
  background:linear-gradient(90deg,rgba(0,0,0,0),rgba(15,23,42,.25) 50%,rgba(0,0,0,0));
}

/* ====== Panel de usuario (debajo de cabecera) ====== */
#userPanel{
  position:fixed; right:12px; top:calc(var(--hdr-h) + 10px);
  width:360px; max-width:calc(100vw - 24px);
  background:#0f141c; color:#e6eef7;
  border:1px solid #223046; border-radius:16px;
  box-shadow:0 20px 36px rgba(0,0,0,.45); padding:14px; display:none; z-index:950;
}
#userPanel.show{display:block}
#userPanel .up__head{display:flex; align-items:center; justify-content:space-between; margin-bottom:6px}
#userPanel h3{margin:0; font-size:14px}
#closeUser{background:transparent; border:0; font-size:22px; color:#e6eef7; cursor:pointer}
#userPanel label{display:block; font-size:12px; color:#9fb0c6; margin:10px 0 6px}
#userPanel select,#userPanel input{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #243046; background:#0b101a; color:#e6eef7}

/* Ojo simple (SVG) */
.eyeBtn{position:absolute; right:12px; top:38px; width:24px; height:24px; border:0; background:transparent; cursor:pointer; padding:0}
.eyeBtn svg{width:22px; height:22px; fill:none; stroke:#cbd5e1; stroke-width:2}

/* Botones */
.btn{border:0; border-radius:999px; padding:10px 14px; font-weight:700; cursor:pointer}
.btn--primary{background:var(--brand); color:#fff}
.btn--ghost{background:#0b101a; color:#e6eef7; border:1px solid #243046}

/* ====== Tipograf√≠a / t√≠tulos con angular ====== */
h1,h2,h3{
  position:relative; margin:22px 0 12px; padding-left:46px; line-height:1.12;
  white-space:nowrap; overflow:visible; text-overflow:ellipsis;
}
h1::before,h2::before,h3::before{
  content:""; position:absolute; left:0; bottom:.58em;     /* ~2/3 de la primera letra */
  width:30px; height:30px; background:url("angular.png") left bottom/contain no-repeat;
}
.red{color:var(--brand)!important} .black{color:var(--ink)!important}

/* ====== Utilidades / layout base ====== */
.main{padding:16px; max-width:1100px; margin:0 auto}
.sep{height:1px; margin:22px 0; background:linear-gradient(90deg,rgba(15,23,42,0),rgba(15,23,42,.22) 50%,rgba(15,23,42,0))}
.card{background:#fff; border:1px solid var(--line); border-radius:18px; padding:14px; box-shadow:0 4px 12px rgba(0,0,0,.06)}
.grid{display:grid; gap:16px}
</style>
</head>
<body>

<header class="header" id="hdr">
  <span id="roleChip">Invitado</span>
  <div class="h__in">
    <button class="hbtn" id="hamb" aria-label="Abrir men√∫"><span class="i"><span></span></span></button>
    <div class="brand" aria-label="Inicio">
      <img src="logo-cdl.png" alt="CDL">
      <span class="brand__title">PANEL DE CONTROL</span>
    </div>
    <div style="flex:1"></div>
    <button class="hbtn" id="moreBtn" aria-haspopup="true" aria-expanded="false" aria-controls="userPanel"><span class="i"></span></button>
  </div>
</header>

<!-- ===== SideNav (hamburguesa) ===== -->
<aside id="sidenav" aria-hidden="true">
  <div class="sidenav__head">
    <img src="logo_mantenimiento.png" alt="CDL Mantenimiento">
    <button id="closeNav" aria-label="Cerrar">‚úï</button>
  </div>
  <div class="sidenav__search">
    <input id="globalSearch" placeholder="Buscar en la app‚Ä¶">
  </div>
  <nav class="navlist" id="navList">
    <!-- items se inyectan por JS; incluir√° ‚ÄúSOLICITUD DE REPUESTO‚Äù -->
  </nav>
</aside>

<!-- ===== Panel usuario (debajo de cabecera) ===== -->
<section id="userPanel" role="dialog" aria-modal="true" aria-labelledby="upTitle">
  <div class="up__head">
    <h3 id="upTitle">Acceso de usuario</h3>
    <button id="closeUser" aria-label="Cerrar">‚úï</button>
  </div>

  <label>Rol</label>
  <select id="roleSelect">
    <option value="invitado" selected>Invitado</option>
    <option value="administrador">Administrador</option>
    <option value="gerente">Gerente</option>
    <option value="encargado">Encargado</option>
    <option value="resp_produccion">Responsable de producci√≥n</option>
    <option value="resp_turno">Responsable de turno</option>
    <option value="externa">Empresa externa</option>
  </select>

  <label>Contrase√±a</label>
  <div style="position:relative">
    <input id="userPass" type="password" placeholder="contrase√±a (opcional)" autocomplete="current-password">
    <button class="eyeBtn" id="toggleEye" aria-label="Mostrar/Ocultar contrase√±a">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
        <circle cx="12" cy="12" r="3.5"/>
      </svg>
    </button>
  </div>

  <div style="display:flex; gap:8px; margin-top:12px">
    <button class="btn btn--primary" id="loginBtn">Acceder</button>
    <button class="btn btn--ghost" id="logoutBtn">Salir</button>
  </div>

  <h3 style="margin-top:14px">Cambiar contrase√±a</h3>
  <label>Actual</label>
  <input id="chgOld" type="password" autocomplete="current-password">
  <label>Nueva</label>
  <input id="chgNew" type="password" autocomplete="new-password">
  <button class="btn btn--ghost" id="chgBtn" style="margin-top:8px">Guardar nueva</button>
</section>

<!-- CONTINUAR√Å: Parte 2/3 (p√°ginas, tarjetas, l√≥gica JS, footer) -->
<main class="main" id="appRoot">

  <!-- ===== DASHBOARD TV (HOME) ===== -->
  <section id="dashboard" class="page active">
    <h1><span class="black">DASHBOARD</span> <span class="red">TV</span></h1>

    <div class="grid" id="dashGrid" style="gap:20px">
      <article class="card card--dash">
        <h2 class="card__title"><span class="black">EQUIPOS EN</span> <span class="red">PARADA</span>
          <span class="badge" id="countParadas">0</span>
        </h2>
        <div id="dash-paradas"></div>
      </article>

      <article class="card card--dash">
        <h2 class="card__title"><span class="black">EQUIPOS CON</span> <span class="red">RESTRICCIONES</span>
          <span class="badge" id="countRestr">0</span>
        </h2>
        <div id="dash-restr"></div>
      </article>

      <article class="card card--dash">
        <h2 class="card__title"><span class="black">ALERTAS</span> <span class="red">STOCK</span> <span class="black">M√çNIMO</span>
          <span class="badge" id="countStock">0</span>
        </h2>
        <div id="dash-stock"></div>
      </article>

      <article class="card card--dash">
        <h2 class="card__title"><span class="black">AVISOS</span> <span class="red">SUBCONTRATAS</span>
          <span class="badge" id="countExt">0</span>
        </h2>
        <div id="dash-externas"></div>
      </article>

      <article class="card card--dash">
        <h2 class="card__title"><span class="black">SOLICITUDES</span> <span class="red">PRIORITARIAS</span>
          <span class="badge" id="countReq">0</span>
        </h2>
        <div id="dash-req"></div>
      </article>
    </div>
  </section>

  <hr class="sep">

  <!-- ===== EQUIPOS ===== -->
  <section id="equipos" hidden>
    <h1><span class="black">EQUIPOS</span></h1>

    <!-- Sub-bloque L√çNEA KALTENBACH (imagen debajo del t√≠tulo general) -->
    <div class="kalt-title" style="margin:6px 0 14px">
      <img src="linea-kaltenbach.png" alt="L√çNEA KALTENBACH">
    </div>

    <div id="equiposGrid" class="grid" style="grid-template-columns:1fr; gap:14px"></div>
  </section>

  <hr class="sep">

  <!-- ===== PUENTES GR√öA ===== -->
  <section id="gruas" hidden>
    <h1><span class="black">PUENTES</span> <span class="red">GR√öA</span></h1>
    <div id="gruasList" class="grid" style="grid-template-columns:1fr; gap:14px"></div>
  </section>

  <hr class="sep">

  <!-- ===== AUXILIARES (OTROS) ===== -->
  <section id="auxiliares" hidden>
    <h1><span class="black">AUXILIARES</span> <span class="red">(OTROS)</span></h1>
    <div id="auxList" class="grid" style="grid-template-columns:1fr; gap:14px"></div>
  </section>

  <hr class="sep">

  <!-- ===== INCIDENCIAS ===== -->
  <section id="incidencias" hidden>
    <h1><span class="black">GESTI√ìN DE</span> <span class="red">INCIDENCIAS</span></h1>

    <div style="display:flex; justify-content:center; margin:10px 0 18px">
      <button class="btn btn--primary" id="btnNewInc" style="padding:12px 18px">Crear nueva incidencia</button>
    </div>

    <!-- Formulario NUEVA INCIDENCIA (colapsable con JS) -->
    <div class="card" id="incFormWrap" hidden>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <label>Equipo</label>
          <input id="incEquipo" list="equiposDatalist" placeholder="Escribe o selecciona equipo‚Ä¶">
          <datalist id="equiposDatalist"></datalist>

          <label>Tipo de fallo</label>
          <select id="incTipo">
            <option value="mecanico">Fallo mec√°nico</option>
            <option value="electrico">Fallo el√©ctrico</option>
            <option value="hidraulico">Fallo hidr√°ulico</option>
            <option value="neumatico">Fallo neum√°tico</option>
            <option value="proceso">Fallo de proceso productivo</option>
            <option value="desconocido">Origen desconocido</option>
          </select>

          <label>Descripci√≥n breve</label>
          <input id="incDesc" placeholder="Describe el problema‚Ä¶">
        </div>

        <div>
          <label>Solucionado</label>
          <select id="incSol">
            <option value="no">No</option>
            <option value="si">S√≠</option>
            <option value="restricciones">Con restricciones</option>
          </select>

          <div id="incSiWrap" hidden>
            <label>Descripci√≥n de la soluci√≥n</label>
            <input id="incSolDesc" placeholder="¬øC√≥mo se solucion√≥?">
            <label>Repuestos empleados</label>
            <input id="incSolRep" placeholder="Escribe para buscar‚Ä¶">
          </div>

          <div id="incNoWrap">
            <label>Descripci√≥n de la intervenci√≥n</label>
            <input id="incNoDesc" placeholder="¬øQu√© se ha hecho hasta ahora?">
            <label>Repuestos empleados</label>
            <input id="incNoRep" placeholder="Opcional">
          </div>

          <label>Reportado por (rol)</label>
          <select id="incReportadoPor">
            <option>administrador</option><option>gerente</option><option>encargado</option>
            <option>resp_produccion</option><option>resp_turno</option><option>externa</option>
          </select>

          <label>Intervenido por</label>
          <input id="incIntervenido" placeholder="Nombre del t√©cnico‚Ä¶">

          <div class="grid" style="grid-template-columns:1fr 1fr">
            <div>
              <label>Fecha de inicio</label>
              <input id="incIni" type="date">
            </div>
            <div>
              <label>Fecha de reparaci√≥n</label>
              <input id="incFin" type="date">
            </div>
          </div>
        </div>
      </div>
      <div style="display:flex; gap:8px; margin-top:10px">
        <button class="btn btn--primary" id="incGuardar">Guardar incidencia</button>
        <button class="btn btn--ghost" id="incCancelar">Cancelar</button>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px">
        <h2 class="card__title">√öltimas incidencias</h2>
        <input id="incFilter" placeholder="Filtrar‚Ä¶">
      </div>
      <div id="incList"></div>
    </div>
  </section>

  <hr class="sep">

  <!-- ===== INVENTARIO ===== -->
  <section id="inventario" hidden>
    <h1><span class="black">INVENTARIO DE</span> <span class="red">REPUESTOS</span></h1>

    <div class="card">
      <div id="invAlerts"></div>
    </div>

    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between">
        <h2 class="card__title">Buscar</h2>
        <div class="searchbar" style="display:flex; gap:8px">
          <input id="invSearch" placeholder="C√≥digo, referencia, nombre‚Ä¶">
          <button class="btn btn--ghost" id="invClear">Limpiar</button>
        </div>
      </div>
      <div class="catgrid" id="invCats" style="display:grid; gap:12px; grid-template-columns:repeat(auto-fill,minmax(180px,1fr))"></div>
    </div>
  </section>

  <hr class="sep">

  <!-- ===== SOLICITUD DE REPUESTO ===== -->
  <section id="solicitudes" hidden>
    <h1><span class="black">SOLICITUD</span> <span class="red">DE REPUESTO</span></h1>

    <div class="card">
      <h2 class="card__title">Nueva solicitud</h2>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <label>Repuesto</label>
          <input id="reqRef" placeholder="Ref o nombre‚Ä¶">
        </div>
        <div>
          <label>Cantidad</label>
          <input id="reqQty" type="number" min="1" value="1">
        </div>
        <div style="grid-column:1/-1">
          <label>Observaciones</label>
          <input id="reqObs" placeholder="Urgente, alternativa, etc.">
        </div>
      </div>
      <div style="margin-top:12px">
        <button class="btn btn--primary" id="reqEnviar">Enviar solicitud</button>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between">
        <h2 class="card__title">Solicitudes</h2>
        <div class="badge" id="reqCountBadge">0</div>
      </div>
      <div id="reqList"></div>
    </div>
  </section>

  <hr class="sep">

  <!-- ===== AVISOS SUBCONTRATAS ===== -->
  <section id="ot" hidden>
    <h1><span class="black">AVISOS</span> <span class="red">SUBCONTRATAS</span></h1>
    <div id="avisosList" class="grid"></div>
  </section>

  <hr class="sep">

  <!-- ===== INDICADORES (gr√°ficas visibles) ===== -->
  <section id="indicadores" hidden>
    <h1><span class="black">INDICADORES</span> <span class="red">CLAVE</span></h1>

    <div class="grid" style="grid-template-columns:1fr; gap:14px">
      <div class="card">
        <h3 class="card__title">MTBF</h3>
        <canvas id="chartMtbf" height="160"></canvas>
      </div>
      <div class="card">
        <h3 class="card__title">Disponibilidad</h3>
        <canvas id="chartDisp" height="160"></canvas>
      </div>
      <div class="card">
        <h3 class="card__title">OEE</h3>
        <canvas id="chartOee" height="160"></canvas>
      </div>
    </div>
  </section>

</main>

<!-- ===== FOOTER (negro) ===== -->
<footer style="background:#0f141c; color:#f8fafc; padding:18px 16px; margin-top:26px">
  <div style="max-width:1100px; margin:0 auto">
    <div>¬© <b>CDL</b> ‚Äî Comercial de Laminados</div>
    <div>Gesti√≥n del mantenimiento</div>
    <div style="margin-top:8px">
      <a id="reportLink" href="#" style="color:#fff; text-decoration:underline">Informar sobre un problema con la app/web</a>
    </div>
  </div>
</footer>

<!-- ===== Modal ‚ÄúVer ficha‚Äù (QR + Ver incidencias) ===== -->
<div id="fichaModal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:980; background:rgba(0,0,0,.38)">
  <div class="card" style="max-width:520px; width:92vw; border-radius:16px; position:relative">
    <button id="closeFicha" aria-label="Cerrar" style="position:absolute; right:10px; top:10px; border:0; background:transparent; font-size:22px; cursor:pointer">‚úï</button>
    <h2 class="card__title" id="fichaTitle">Ficha</h2>
    <div class="grid" style="grid-template-columns:160px 1fr; align-items:center">
      <img id="fichaQR" alt="QR" src="" style="width:160px; height:160px; object-fit:contain; border:1px solid #e5e7eb; border-radius:12px">
      <div>
        <div id="fichaNombre" style="font-weight:800; margin-bottom:8px"></div>
        <button class="btn btn--ghost" id="btnVerIncidencias">Ver incidencias</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== Modal ‚ÄúReportar problema‚Äù ===== -->
<div id="reportModal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:980; background:rgba(0,0,0,.45)">
  <div class="card" style="max-width:560px; width:92vw; border-radius:16px; position:relative">
    <button id="closeReport" aria-label="Cerrar" style="position:absolute; right:10px; top:10px; border:0; background:transparent; font-size:22px; cursor:pointer">‚úï</button>
    <h2 class="card__title">Informar problema</h2>
    <div class="grid" style="grid-template-columns:1fr">
      <label>Asunto</label>
      <input id="rpSubject" placeholder="Breve asunto‚Ä¶">
      <label>Descripci√≥n</label>
      <textarea id="rpDesc" rows="5" placeholder="Describe el problema, pasos para reproducir, pantalla, etc." style="resize:vertical; padding:10px; border:1px solid #e5e7eb; border-radius:10px"></textarea>
      <div style="display:flex; gap:8px; margin-top:10px">
        <button class="btn btn--primary" id="rpEnviar">Enviar</button>
        <button class="btn btn--ghost" id="rpCancelar">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- ====== Plantilla de tarjeta de equipo (sem√°foro + acciones) ====== -->
<template id="tplEquipo">
  <article class="card equipo">
    <div style="display:flex; gap:10px; align-items:flex-start; justify-content:space-between">
      <div>
        <div class="eq-estado" style="margin-bottom:6px; color:#64748b; font-weight:700">‚Äî</div>
        <div class="eq-nombre" style="font-weight:900; font-size:20px; letter-spacing:.2px">NOMBRE</div>
        <div class="eq-meta" style="color:#94a3b8">‚Äî</div>
      </div>

      <!-- Sem√°foro -->
      <div class="semaforo" style="display:flex; flex-direction:column; gap:8px">
        <button class="bulb bulb--ok"    data-state="marcha"        aria-label="En marcha"></button>
        <button class="bulb bulb--warn"  data-state="restricciones" aria-label="Restricciones"></button>
        <button class="bulb bulb--stop"  data-state="parada"        aria-label="Parada"></button>
      </div>
    </div>

    <div class="actions" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
      <button class="btn btn--ghost act-ficha">Ver ficha</button>
      <button class="btn btn--ghost act-prog">Parada prog.</button>
      <button class="btn btn--primary act-prolong">Parada prolongada</button>
      <button class="btn btn--ghost act-incid">Nueva incidencia</button>
    </div>
  </article>
</template>

<style>
/* Estilos sem√°foro (selecci√≥n clara) */
.bulb{
  width:24px; height:24px; border-radius:50%;
  border:2px solid rgba(0,0,0,.15); background:#e5e7eb; cursor:pointer;
  box-shadow: inset 0 0 0 6px rgba(0,0,0,.06);
}
.bulb--ok{   background:#22c55e }
.bulb--warn{ background:#f59e0b }
.bulb--stop{ background:#ef4444 }
/* estado no seleccionado ‚Äúatenuado‚Äù */
.semaforo .bulb{opacity:.45}
.semaforo .bulb.is-active{opacity:1; box-shadow:0 0 0 3px rgba(0,0,0,.12), inset 0 0 0 4px rgba(255,255,255,.45)}
/* tarjetas m√°s limpias */
.card.equipo{border-radius:18px}
.card--dash{background:transparent; border:0; box-shadow:none; padding:6px 0}
.badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-weight:800; font-size:12px; background:#eef2f7; color:#334155; border:1px solid #e2e8f0; margin-left:8px }
</style>
<script>
/* =========================
   ESTADO B√ÅSICO
========================= */
const STORE_KEY = "cdl_cache_v1";
const store = {
  state:{
    user:{rol:'invitado', nombre:'Invitado', token:''},
    equipos:[], gruas:[], auxiliares:[],
    incidencias:[], inventario:[], solicitudes:[],
    ots:[], externas:[]
  },
  save(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(this.state)); }catch{} },
  load(){ try{ Object.assign(this.state, JSON.parse(localStorage.getItem(STORE_KEY)||"{}")); }catch{} }
};

// Mocks m√≠nimos para que todo pinte aunque no haya backend a√∫n
function demoSeedIfEmpty(){
  if(!store.state.equipos?.length){
    store.state.equipos = [
      {id:'KALT-01', nombre:'SIERRA KALT 01', grupo:'L√çNEA KALTENBACH', estado:'marcha'},
      {id:'KALT-02', nombre:'TALADRO KALT 02', grupo:'L√çNEA KALTENBACH', estado:'restricciones'},
      {id:'LASER-01', nombre:'LASER TRUMP 01', grupo:'L√ÅSER TRUMP', estado:'parada'},
    ];
  }
  if(!store.state.gruas?.length){
    store.state.gruas = [
      {id:'GRUA-N1-01', nombre:'Puente Gr√∫a N1-01', nave:'NAVE 1', estado:'marcha'},
      {id:'GRUA-N2-05', nombre:'Puente Gr√∫a N2-05', nave:'NAVE 2', estado:'restricciones'},
    ];
  }
  if(!store.state.auxiliares?.length){
    store.state.auxiliares = [
      {id:'EXT-INC-01', nombre:'BIE 25mm', tipo:'CONTRA INCENDIOS', estado:'marcha'}
    ];
  }
  store.save();
}

/* =========================
   ROUTER + NAV
========================= */
const PAGES = ["dashboard","equipos","gruas","auxiliares","incidencias","inventario","solicitudes","ot","indicadores"];
const TITLES = {
  dashboard:"Dashboard TV", equipos:"Equipos", gruas:"Puentes gr√∫a", auxiliares:"Auxiliares (otros)",
  incidencias:"Incidencias", inventario:"Inventario", solicitudes:"Solicitud de repuesto",
  ot:"Avisos subcontratas", indicadores:"Indicadores"
};

function buildNav(){
  const nav = document.getElementById("navList");
  if(!nav) return;
  nav.innerHTML = PAGES.map(id=>`<a href="#${id}" data-id="${id}">${TITLES[id]}</a>`).join("");
}

function navTo(id){
  PAGES.forEach(p=>{
    const el = document.getElementById(p);
    if(el) el.hidden = (p!==id);
  });
  location.hash = "#"+id;
  render();
}

function onHash(){
  const id = (location.hash||"#dashboard").replace("#","");
  if(!PAGES.includes(id)) return navTo("dashboard");
  navTo(id);
}

/* =========================
   CABECERA / MEN√öS
========================= */
function setupHeaderInteractions(){
  const sidenav   = document.getElementById("sidenav");
  const hamb      = document.getElementById("hamb");
  const btnCloseNav = document.getElementById("btnCloseNav");
  const moreBtn   = document.getElementById("moreBtn");
  const userPanel = document.getElementById("userPanel");
  const upClose   = document.getElementById("upClose"); // ‚úï del panel usuario

  // üçî abre/cierra
  if(hamb && sidenav){
    hamb.onclick = ()=> sidenav.classList.toggle("open");
  }
  if(btnCloseNav && sidenav){
    btnCloseNav.onclick = ()=> sidenav.classList.remove("open");
  }
  // Cerrar sidenav clic fuera (backdrop) y con ESC
  document.addEventListener("click",(e)=>{
    if(e.target && e.target.id==="sidenav") sidenav?.classList.remove("open");
  });
  document.addEventListener("keydown",(e)=>{
    if(e.key==="Escape"){ sidenav?.classList.remove("open"); hideUserPanel(); hideModals(); }
  });

  // ‚ãØ panel usuario (debajo cabecera, sin taparla)
  function toggleUserPanel(){
    if(!userPanel) return;
    const show = !userPanel.classList.contains("show");
    userPanel.classList.toggle("show", show);
    moreBtn?.setAttribute("aria-expanded", show);
  }
  function hideUserPanel(){
    if(!userPanel) return;
    userPanel.classList.remove("show");
    moreBtn?.setAttribute("aria-expanded","false");
  }
  if(moreBtn && userPanel){
    moreBtn.onclick = (e)=>{ e.stopPropagation(); toggleUserPanel(); };
  }
  if(upClose){
    upClose.onclick = ()=> hideUserPanel();
  }
  // Cerrar panel usuario si clicas fuera
  document.addEventListener("click",(e)=>{
    if(!userPanel?.classList.contains("show")) return;
    const inside = e.target.closest && e.target.closest("#userPanel,#moreBtn");
    if(!inside) hideUserPanel();
  });

  // Mostrar/ocultar contrase√±a (bot√≥n ojo SVG)
  const toggleEye = document.getElementById("toggleEye");
  const userPass = document.getElementById("userPass");
  if(toggleEye && userPass){
    toggleEye.onclick = ()=>{
      userPass.type = (userPass.type === "password") ? "text" : "password";
    };
  }

  // Login simplificado (rol + contrase√±a). Campo usuario es opcional
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn= document.getElementById("logoutBtn");
  const roleChip = document.getElementById("roleChip");

  loginBtn && (loginBtn.onclick = async ()=>{
    const roleSel = document.getElementById("roleSelect");
    const pass    = userPass ? userPass.value : "";
    const role    = (roleSel?.value||"invitado").toLowerCase();
    // Validaci√≥n simple local (en producci√≥n, Apps Script)
    if(!pass){ alert("Introduce la contrase√±a."); return; }
    store.state.user = {rol: role, nombre: role.toUpperCase(), token:""};
    store.save();
    if(roleChip) roleChip.textContent = role.toUpperCase();
    hideUserPanel();
    render();
  });

  logoutBtn && (logoutBtn.onclick = ()=>{
    store.state.user = {rol:"invitado", nombre:"Invitado", token:""};
    store.save();
    if(roleChip) roleChip.textContent = "Invitado";
    render();
  });
}

/* =========================
   RENDER HELPERS
========================= */
function pill(estado){
  const s = (estado||"").toLowerCase();
  if(s.includes("parada")) return `<span class="pill pill--stop">Parada</span>`;
  if(s.includes("restr")) return `<span class="pill pill--warn">Restricciones</span>`;
  if(s.includes("marcha")) return `<span class="pill pill--ok">En marcha</span>`;
  return `<span class="pill pill--info">${estado||"‚Äî"}</span>`;
}

function equipoCardHTML(e){
  // instancia desde <template> en renderEquipos()
  return ''; // usamos template clonando (m√°s abajo)
}

/* =========================
   RENDERS POR P√ÅGINA
========================= */
function renderDashboard(){
  const eqStop   = store.state.equipos.filter(x=>(x.estado||"").toLowerCase().includes("parada"));
  const eqRestr  = store.state.equipos.filter(x=>(x.estado||"").toLowerCase().includes("restr"));
  const grStop   = store.state.gruas.filter(x=>(x.estado||"").toLowerCase().includes("parada"));
  const auxRestr = store.state.auxiliares.filter(x=>(x.estado||"").toLowerCase().includes("restr"));
  const low      = store.state.inventario.filter(i=>Number(i.stock)<Number(i.stock_min));
  const reqPend  = store.state.solicitudes.filter(r=>(r.estado||"").toLowerCase()==="pendiente");

  const setText = (id,val)=>{ const el=document.getElementById(id); if(el) el.textContent = val; };
  setText("countParadas", eqStop.length + grStop.length);
  setText("countRestr",   eqRestr.length + auxRestr.length);
  setText("countStock",   low.length);
  setText("countReq",     reqPend.length);
  setText("countExt",     store.state.externas.length||0);

  const put = (id, arr, map)=>
    { const el=document.getElementById(id); if(el) el.innerHTML = arr.map(map).join(""); };

  put("dash-paradas", eqStop.concat(grStop), x=>`<div class="line-1">${x.nombre}</div>`);
  put("dash-restr",   eqRestr.concat(auxRestr), x=>`<div class="line-1">${x.nombre}</div>`);
  put("dash-stock",   low, i=>`<div class="line-1">${i.ref||''} ¬∑ ${i.nombre||''} (${i.stock||0}/${i.stock_min||0})</div>`);
  put("dash-req",     reqPend, r=>`<div class="line-1">${r.id||''} ¬∑ ${r.nombre||''} (${r.qty||1})</div>`);
  put("dash-externas",store.state.externas||[], e=>`<div class="line-1">${e.proveedor||''} ¬∑ ${e.asunto||''}</div>`);
}

function renderEquipos(){
  const grid = document.getElementById("equiposGrid");
  if(!grid) return;
  grid.innerHTML = "";
  const tpl = document.getElementById("tplEquipo");
  (store.state.equipos||[]).forEach(e=>{
    const node = document.importNode(tpl.content, true);
    node.querySelector(".eq-estado").innerHTML = pill(e.estado);
    node.querySelector(".eq-nombre").textContent = e.nombre.toUpperCase();
    node.querySelector(".eq-meta").textContent = e.grupo||"";

    // Sem√°foro: marca activo
    const bulbs = node.querySelectorAll(".bulb");
    bulbs.forEach(b=>{
      const st = b.getAttribute("data-state");
      const active = (st==="marcha" && e.estado==="marcha")
                  || (st==="restricciones" && e.estado==="restricciones")
                  || (st==="parada" && e.estado==="parada");
      if(active) b.classList.add("is-active");
    });

    // Acciones
    node.querySelector(".act-ficha").onclick = ()=> openFicha(e);
    node.querySelector(".act-prog").onclick  = ()=> setEstadoAndIncid(e, "restricciones");
    node.querySelector(".act-prolong").onclick = ()=> setEstadoAndIncid(e, "parada");
    node.querySelector(".act-incid").onclick = ()=> openIncidFor(e);

    // Sem√°foro: click cambia estado y obliga formulario
    bulbs.forEach(b=>{
      b.onclick = ()=>{
        const st = b.getAttribute("data-state");
        setEstadoAndIncid(e, st==="marcha"?"marcha":(st==="restricciones"?"restricciones":"parada"));
      };
    });

    grid.appendChild(node);
  });
}

function renderGruas(){
  const cont = document.getElementById("gruasList");
  if(!cont) return;
  const naves = ["NAVE 1","NAVE 2","NAVE 3","NAVE 4"];
  cont.innerHTML = naves.map(n=>{
    const list = store.state.gruas.filter(x=>(x.nave||"").toUpperCase()===n);
    if(!list.length) return "";
    return `<div class="card"><h2 class="card__title">${n}</h2>${
      list.map(x=>`<div class="item"><div><div class="item__title">${x.nombre}</div>${pill(x.estado)}</div></div>`).join("")
    }</div>`;
  }).join("");
}

function renderAux(){
  const cont = document.getElementById("auxList");
  if(!cont) return;
  const list = store.state.auxiliares||[];
  cont.innerHTML = `<div class="card"><h2 class="card__title">Auxiliares</h2>${
    list.map(x=>`<div class="item"><div><div class="item__title">${x.nombre}</div>${pill(x.estado)}</div></div>`).join("")
  }</div>`;
}

function renderIncidencias(){
  const wrap = document.getElementById("incList");
  if(!wrap) return;
  const filtro = (document.getElementById("incFilter")?.value||"").toLowerCase();
  const arr = (store.state.incidencias||[])
    .filter(i=>!filtro || (i.equipo+i.tipo+i.desc).toLowerCase().includes(filtro))
    .sort((a,b)=>String(b.fecha||"").localeCompare(String(a.fecha||"")));
  wrap.innerHTML = arr.map(i=>`<div class="line-1">${i.fecha||'‚Äî'} ¬∑ ${i.equipo||'‚Äî'} ¬∑ ${i.tipo||'‚Äî'} ¬∑ ${i.desc||''}</div>`).join("");
}

function renderInventario(){
  const invAlerts = document.getElementById("invAlerts");
  const qEl = document.getElementById("invSearch");
  const clear = document.getElementById("invClear");
  const catsBox = document.getElementById("invCats");
  if(!invAlerts || !catsBox) return;

  const low = (store.state.inventario||[]).filter(i=>Number(i.stock)<Number(i.stock_min));
  invAlerts.innerHTML = low.length
    ? `<span class="pill pill--stop">‚ö† ${low.length} referencias por debajo del m√≠nimo</span>`
    : `<span class="pill pill--ok">Stock correcto</span>`;

  const q = (qEl?.value||"").toLowerCase();
  const items = (store.state.inventario||[]).filter(i=>{
    const t = ((i.ref||"")+" "+(i.nombre||"")).toLowerCase();
    return !q || t.includes(q);
  });

  const cats = {};
  items.forEach(i=>{
    const c = i.categoria || "Otros";
    (cats[c] ||= []).push(i);
  });
  catsBox.innerHTML = Object.keys(cats).sort().map(c=>{
    const n = cats[c].length;
    return `<div class="cat"><b>${c}</b><br>${n} items</div>`;
  }).join("");

  clear && (clear.onclick = ()=>{ if(qEl){ qEl.value=""; renderInventario(); } });
}

function renderSolicitudes(){
  const box = document.getElementById("reqList");
  const badge = document.getElementById("reqCountBadge");
  if(!box) return;
  const list = store.state.solicitudes||[];
  badge && (badge.textContent = list.length);
  box.innerHTML = list.map(r=>`<div class="line-1">${r.id||''} ¬∑ ${r.nombre||''} (${r.qty||1}) ¬∑ ${r.estado||'Pendiente'}</div>`).join("");
}

function renderCharts(){
  drawBarChart("chartMtbf", [8,10,7,12,11], "MTBF (h)");
  drawBarChart("chartDisp", [97,98,96,99,98], "Disponibilidad (%)");
  drawBarChart("chartOee",  [88,90,87,91,89], "OEE (%)");
}

function render(){
  // datalist equipos
  const dl = document.getElementById("equiposDatalist");
  if(dl){ dl.innerHTML = (store.state.equipos||[]).map(e=>`<option value="${e.nombre}">`).join(""); }

  renderDashboard();
  renderEquipos();
  renderGruas();
  renderAux();
  renderIncidencias();
  renderInventario();
  renderSolicitudes();
  renderCharts();
}

/* =========================
   ACCIONES / MODALES
========================= */
function openFicha(e){
  const modal = document.getElementById("fichaModal");
  if(!modal) return;
  modal.style.display = "flex";
  document.getElementById("fichaTitle").textContent = "Ficha de equipo";
  document.getElementById("fichaNombre").textContent = e.nombre;
  // QR mock (si tienes un endpoint real, sustit√∫yelo)
  const qr = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${encodeURIComponent(e.id||e.nombre)}`;
  document.getElementById("fichaQR").src = qr;

  const btnInc = document.getElementById("btnVerIncidencias");
  btnInc.onclick = ()=>{
    // Filtrado l√≥gico: podr√≠as guardar un filtro global
    navTo("incidencias");
    modal.style.display = "none";
  };

  document.getElementById("closeFicha").onclick = ()=> modal.style.display="none";
  modal.addEventListener("click",(ev)=>{ if(ev.target===modal) modal.style.display="none"; }, {once:true});
}

function hideModals(){
  const fm = document.getElementById("fichaModal");
  const rm = document.getElementById("reportModal");
  if(fm) fm.style.display = "none";
  if(rm) rm.style.display = "none";
}

function setEstadoAndIncid(e, nuevo){
  // Actualizamos estado local
  const target = store.state.equipos.find(x=>x.id===e.id);
  if(target){ target.estado = nuevo; store.save(); }
  // Abrimos formulario de incidencia para documentar el cambio
  openIncidFor(e);
}

function openIncidFor(e){
  navTo("incidencias");
  const iEq = document.getElementById("incEquipo");
  if(iEq) iEq.value = e.nombre;
  const wrap = document.getElementById("incFormWrap");
  if(wrap) wrap.hidden = false;
}

/* Reportar problema */
function setupReportModal(){
  const link = document.getElementById("reportLink");
  const modal= document.getElementById("reportModal");
  const close = document.getElementById("closeReport");
  const btnEn = document.getElementById("rpEnviar");
  const btnCa = document.getElementById("rpCancelar");

  if(!link || !modal) return;
  link.onclick = (e)=>{ e.preventDefault(); modal.style.display="flex"; };
  close && (close.onclick = ()=> modal.style.display="none");
  btnCa && (btnCa.onclick = ()=> modal.style.display="none");
  modal.addEventListener("click",(ev)=>{ if(ev.target===modal) modal.style.display="none"; });

  btnEn && (btnEn.onclick = ()=>{
    const sub = document.getElementById("rpSubject").value.trim();
    const des = document.getElementById("rpDesc").value.trim();
    if(!sub || !des){ alert("Describe el problema, por favor."); return; }
    // Aqu√≠ podr√≠as enviar a Apps Script
    alert("¬°Gracias! Hemos registrado tu aviso.");
    modal.style.display="none";
    document.getElementById("rpSubject").value="";
    document.getElementById("rpDesc").value="";
  });
}

/* =========================
   CHARTS (Canvas simple)
========================= */
function drawBarChart(id, data, label){
  const c = document.getElementById(id);
  if(!c) return;
  const ctx = c.getContext("2d");
  const W = c.width = c.clientWidth || 320;
  const H = c.height;
  ctx.clearRect(0,0,W,H);

  // Ejes
  ctx.strokeStyle = "#e5e7eb";
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(36,10); ctx.lineTo(36,H-24); ctx.lineTo(W-10,H-24); ctx.stroke();

  // Bars
  const max = Math.max(...data, 1);
  const n = data.length;
  const gap = 10;
  const barW = (W-60 - (n-1)*gap) / n;
  data.forEach((v,i)=>{
    const h = (H-50) * (v/max);
    const x = 36 + i*(barW+gap);
    const y = H-24 - h;
    ctx.fillStyle = "#ef4444"; // rojo corporativo
    ctx.fillRect(x,y,barW,h);
  });

  // Label
  ctx.fillStyle = "#64748b"; ctx.font = "12px Inter, system-ui, sans-serif";
  ctx.fillText(label, 40, 18);
}

/* =========================
   INIT
========================= */
async function refresh(){ 
  // aqu√≠ ir√≠an llamadas reales a Apps Script; de momento usamos estado local
  render();
}

document.addEventListener("DOMContentLoaded", ()=>{
  // Estado
  store.load();
  demoSeedIfEmpty();

  // Men√∫s, nav y panel usuario
  buildNav();
  setupHeaderInteractions();
  setupReportModal();

  // Navegaci√≥n
  window.addEventListener("hashchange", onHash);
  onHash();

  // Primer render + refresco cada minuto
  (async ()=>{ await refresh(); setInterval(refresh, 60000); })();

  // Service Worker (ruta relativa para GH Pages)
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }
});
</script>
</body>
</html>