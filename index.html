<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>CDL · Panel de control</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="apple-touch-icon.png">

<!-- Fuente -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
/* =========================================================
   VARIABLES
========================================================= */
:root{
  /* marca y colores base */
  --brand:#E43B3B; --ink:#0f172a; --muted:#475569; --line:#e5e7eb; --bg:#ffffff;

  /* layout */
  --hdr-h:128px;                 /* suficiente para ver "MANTENIMIENTO" entero */
  --radius:18px;
  --shadow:0 4px 12px rgba(0,0,0,.06);

  /* angular corporativo en títulos */
  --angular-size:30px;
  --angular-up:.80em;            /* sube el angular para que monte un pelín en la 1ª letra */
  --angular-gap:24px;            /* gap < size => ligero solape */
}

/* =========================================================
   RESET & BASE
========================================================= */
*{box-sizing:border-box}
html,body{height:100%; background:#fff; overflow-x:hidden}
body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif; color:var(--ink)}
a{color:inherit; text-decoration:none}
img{display:block; max-width:100%}
button{font:inherit; cursor:pointer}
:focus-visible{outline:2px solid #0ea5e9; outline-offset:2px}
@media (prefers-reduced-motion:reduce){
  *{scroll-behavior:auto; transition:none!important; animation:none!important}
}

/* =========================================================
   CABECERA
========================================================= */
.header{
  position:sticky; top:0; z-index:1000; background:#fff;
  border-bottom:1px solid #eee; transition:box-shadow .25s ease;
}
.header.scrolled{ box-shadow:0 6px 14px rgba(0,0,0,.06) }
.h__in{
  height:var(--hdr-h);
  display:grid; grid-template-columns:auto 1fr auto; align-items:end;
  gap:12px; padding:10px 16px 12px; position:relative;
}
/* Fondo degradado + imagen centrada y visible */
.header::before{
  content:""; position:absolute; inset:0;
  background:
    linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.0) 60%, rgba(255,255,255,.0) 100%),
    url("logo_mantenimiento.png") center top / 82% auto no-repeat;
  opacity:.16; pointer-events:none;
}

/* Marca CDL centrada (evita desplazamientos) */
.brand{display:flex; align-items:flex-end; gap:10px; justify-self:center}
.brand img{height:42px}

/* Chip rol minimal */
#roleChip{position:absolute; right:16px; top:8px; font-weight:800; font-size:12px; color:var(--ink)}

/* Botones cabecera */
.hbtn{width:44px; height:44px; display:grid; place-items:center; background:transparent; border:0; color:var(--ink)}
#hamb .i{width:22px; height:16px; position:relative; display:inline-block}
#hamb .i:before,#hamb .i:after,#hamb .i span{
  content:""; position:absolute; left:0; right:0; height:2px; background:var(--ink); border-radius:2px;
}
#hamb .i:before{top:0} #hamb .i span{top:7px} #hamb .i:after{bottom:0}
#moreBtn .i{display:inline-block; width:18px; text-align:center; letter-spacing:2px; font-weight:800}
#moreBtn .i::before{content:"···"}

/* =========================================================
   SIDENAV
========================================================= */
#sidenav{
  position:fixed; inset:var(--hdr-h) 0 0 0; background:#fff; color:var(--ink);
  transform:translateX(-100%); transition:transform .25s ease; z-index:900; box-shadow:4px 0 24px rgba(0,0,0,.08);
}
#sidenav.open{transform:none}
.sidenav__head{display:flex; align-items:center; gap:12px; padding:14px 16px}
.sidenav__head img{height:56px}
#closeNav{margin-left:auto; width:40px; height:40px; background:transparent; border:0; font-size:22px}
.sidenav__search{padding:0 16px 10px}
.sidenav__search input{width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:12px; font-weight:600}

/* navegación */
.navlist{padding:6px 0}
.navlist a{display:block; padding:16px; font-weight:800; text-transform:uppercase; outline:none}
.navlist a:not(:last-child){position:relative}
.navlist a:not(:last-child)::after{
  content:""; position:absolute; left:10%; right:10%; bottom:-1px; height:1.5px;
  background:linear-gradient(90deg,rgba(0,0,0,0),rgba(15,23,42,.25) 50%,rgba(0,0,0,0));
}
.navlist a[aria-current="page"]{background:#f6f8fb; box-shadow:inset 4px 0 0 var(--brand)}

/* blur fondo cuando el menú está abierto */
body.menu-open::after{
  content:""; position:fixed; inset:var(--hdr-h) 0 0 0; backdrop-filter:blur(4px); background:rgba(0,0,0,.18); z-index:800;
}

/* =========================================================
   PANEL USUARIO
========================================================= */
#userPanel{
  position:fixed; right:12px; top:calc(var(--hdr-h) + 10px);
  width:360px; max-width:calc(100vw - 24px);
  background:#0f141c; color:#e6eef7;
  border:1px solid #223046; border-radius:16px; box-shadow:0 20px 36px rgba(0,0,0,.45);
  padding:14px; display:none; z-index:950;
}
#userPanel.show{display:block}
#userPanel .up__head{display:flex; align-items:center; justify-content:space-between; margin-bottom:6px}
#userPanel h3{margin:0; font-size:14px}
#closeUser{background:transparent; border:0; font-size:22px; color:#e6eef7}
#userPanel label{display:block; font-size:12px; color:#9fb0c6; margin:10px 0 6px}
#userPanel select,#userPanel input{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #243046; background:#0b101a; color:#e6eef7}

/* ojo mostrar/ocultar password */
.eyeBtn{position:absolute; right:12px; top:38px; width:24px; height:24px; border:0; background:transparent; padding:0}
.eyeBtn svg{width:22px; height:22px; fill:none; stroke:#cbd5e1; stroke-width:2}

/* =========================================================
   TÍTULOS CON ANGULAR
========================================================= */
h1,h2,h3{
  position:relative; margin:26px 0 14px; padding-left:var(--angular-gap); line-height:1.12;
  white-space:nowrap; overflow:visible; text-overflow:ellipsis;
}
h1::before,h2::before,h3::before{
  content:""; position:absolute; left:0; bottom:var(--angular-up);
  width:var(--angular-size); height:var(--angular-size);
  background:url("angular.png") left bottom/contain no-repeat;
  z-index:1; pointer-events:none;
}
/* en tarjetas dashboard no mostramos angular */
.card .card__title{padding-left:0}
.card .card__title::before{display:none}

/* =========================================================
   UTILIDADES & COMPONENTES
========================================================= */
.main{padding:16px; max-width:1100px; margin:0 auto}
.sep{height:1px; margin:26px 0; background:linear-gradient(90deg,rgba(15,23,42,0),rgba(15,23,42,.22) 50%,rgba(15,23,42,0))}
.card{background:#fff; border:1px solid var(--line); border-radius:18px; padding:14px; box-shadow:var(--shadow)}
.grid{display:grid; gap:16px}
.badge{display:inline-block; padding:2px 8px; border-radius:999px; font-weight:800; font-size:12px; background:#eef2f7; color:#334155; border:1px solid #e2e8f0}
.red{color:var(--brand)!important}
.black{color:var(--ink)!important}

/* botones */
.btn{border:0; border-radius:999px; padding:10px 14px; font-weight:800}
.btn--primary{background:var(--brand); color:#fff}
.btn--ghost{background:#fff; color:var(--ink); border:1px solid var(--line)}
.btn:active{transform:translateY(1px)}

/* Dashboard TV “integrado” */
.dash-grid{gap:20px}
.card--dash{background:transparent; border:0; box-shadow:none; padding:6px 0}
.card__title.big{font-size:18px; font-weight:900; letter-spacing:.3px; padding-left:0}
.card__title.big .badge{margin-left:10px}
.dash-list .line-1{padding:8px 12px; border:1px dashed var(--line); border-radius:12px; margin:8px 0; font-weight:600}

/* Hero */
.hero{
  background:linear-gradient(180deg,#fff,#f8fafc);
  border:1px solid #eef2f7; padding:20px; border-radius:20px;
}
.hero h1{margin:0; padding-left:0}
.hero h1::before{display:none}
.hero .sub{color:#64748b; font-weight:800; margin-top:4px}

/* Tablas / inventario */
.table{width:100%; border-collapse:collapse}
.table th,.table td{border:1px solid var(--line); padding:8px; text-align:left; font-size:14px}
.table th{background:#f8fafc; font-weight:800}
.table tr:hover{background:#fafafa}
.badge--ok{background:#ecfdf5; color:#047857; border-color:#a7f3d0}
.badge--low{background:#fff7ed; color:#c2410c; border-color:#fed7aa}
.qr-mini{width:72px; height:72px}

/* KPI footers (explicaciones) */
.kpi-foot{color:#64748b; font-size:12px; margin-top:8px}

/* Responsivo */
@media (min-width:900px){ .dash-grid{grid-template-columns:repeat(2,1fr)} }
@media (min-width:1200px){ .dash-grid{grid-template-columns:repeat(3,1fr)} }

/* Helpers */
.visually-hidden{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0}
.touch-target{min-height:44px;min-width:44px}
</style>
</head>
<body>

<!-- =======================================================
     CABECERA
======================================================= -->
<header class="header" id="hdr" role="banner">
  <span id="roleChip">Invitado</span>
  <div class="h__in">
    <button class="hbtn" id="hamb" aria-label="Abrir menú" aria-controls="sidenav" aria-expanded="false"><span class="i"><span></span></span></button>
    <a class="brand" aria-label="Inicio" href="#dashboard">
      <img src="logo-cdl.png" alt="CDL">
    </a>
    <button class="hbtn" id="moreBtn" aria-haspopup="dialog" aria-expanded="false" aria-controls="userPanel"><span class="i"></span></button>
  </div>
</header>

<!-- =======================================================
     SIDENAV
======================================================= -->
<aside id="sidenav" aria-hidden="true" aria-label="Navegación principal">
  <div class="sidenav__head">
    <img src="logo_mantenimiento.png" alt="CDL Mantenimiento">
    <button id="closeNav" aria-label="Cerrar menú">✕</button>
  </div>
  <div class="sidenav__search">
    <input id="globalSearch" placeholder="Buscar en la app…" aria-label="Buscar">
  </div>
  <nav class="navlist" id="navList"><!-- items por JS --></nav>
</aside>

<!-- =======================================================
     PANEL USUARIO
======================================================= -->
<section id="userPanel" role="dialog" aria-modal="true" aria-labelledby="upTitle">
  <div class="up__head">
    <h3 id="upTitle">Acceso de usuario</h3>
    <button id="closeUser" aria-label="Cerrar">✕</button>
  </div>

  <label for="roleSelect">Rol</label>
  <select id="roleSelect">
    <option value="invitado" selected>Invitado</option>
    <option value="administrador">Administrador</option>
    <option value="gerente">Gerente</option>
    <option value="encargado">Encargado</option>
    <option value="resp_produccion">Responsable de producción</option>
    <option value="resp_turno">Responsable de turno</option>
    <option value="externa">Empresa externa</option>
  </select>

  <label for="userPass">Contraseña</label>
  <div style="position:relative">
    <input id="userPass" type="password" placeholder="contraseña" autocomplete="current-password" aria-describedby="pwdHelp">
    <button class="eyeBtn" id="toggleEye" aria-label="Mostrar/Ocultar contraseña">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
        <circle cx="12" cy="12" r="3.5"/>
      </svg>
    </button>
  </div>
  <div id="pwdHelp" style="color:#9fb0c6; font-size:12px; margin-top:4px">Introduce la clave según tu rol</div>

  <div style="display:flex; gap:8px; margin-top:12px">
    <button class="btn btn--primary" id="loginBtn">Acceder</button>
    <button class="btn btn--ghost" id="logoutBtn">Salir</button>
  </div>

  <h3 style="margin-top:14px">Cambiar contraseña</h3>
  <label for="chgOld">Actual</label>
  <input id="chgOld" type="password" autocomplete="current-password">
  <label for="chgNew">Nueva</label>
  <input id="chgNew" type="password" autocomplete="new-password">
  <button class="btn btn--ghost" id="chgBtn" style="margin-top:8px">Guardar nueva</button>
</section>

<!-- =======================================================
     MAIN
======================================================= -->
<main class="main" id="appRoot">

  <!-- DASHBOARD -->
  <section id="dashboard" class="page" aria-labelledby="dashTitle">
    <article class="hero">
      <h1 id="dashTitle"><span class="black">DASHBOARD</span> <span class="red">TV</span></h1>
      <div class="sub">Panel de control</div>
    </article>

    <div class="grid dash-grid" style="margin-top:10px">
      <article class="card card--dash">
        <h2 class="card__title big"><span class="black">EQUIPOS EN</span> <span class="red">PARADA</span>
          <span class="badge" id="countParadas">0</span>
        </h2>
        <div id="dash-paradas" class="dash-list"></div>
      </article>

      <article class="card card--dash">
        <h2 class="card__title big"><span class="black">EQUIPOS CON</span> <span class="red">RESTRICCIONES</span>
          <span class="badge" id="countRestr">0</span>
        </h2>
        <div id="dash-restr" class="dash-list"></div>
      </article>

      <article class="card card--dash">
        <h2 class="card__title big"><span class="black">ALERTAS</span> <span class="red">STOCK</span> <span class="black">MÍNIMO</span>
          <span class="badge" id="countStock">0</span>
        </h2>
        <div id="dash-stock" class="dash-list"></div>
      </article>

      <article class="card card--dash">
        <h2 class="card__title big"><span class="black">AVISOS</span> <span class="red">SUBCONTRATAS</span>
          <span class="badge" id="countExt">0</span>
        </h2>
        <div id="dash-externas" class="dash-list"></div>
      </article>

      <article class="card card--dash">
        <h2 class="card__title big"><span class="black">SOLICITUDES</span> <span class="red">PRIORITARIAS</span>
          <span class="badge" id="countReq">0</span>
        </h2>
        <div id="dash-req" class="dash-list"></div>
      </article>
    </div>
  </section>

  <!-- EQUIPOS -->
  <section id="equipos" class="page" hidden aria-labelledby="equipTitle">
    <h1 id="equipTitle">Equipos</h1>
    <div class="kalt-title" aria-hidden="true" style="margin-top:-6px">
      <img src="linea-kaltenbach.png" alt="LÍNEA KALTENBACH">
    </div>
    <div class="card">
      <div class="grid" style="grid-template-columns: 1fr auto; align-items:center">
        <input id="equipSearch" placeholder="Buscar equipo…">
        <datalist id="equiposDatalist"></datalist>
        <button class="btn btn--ghost" id="equipClear">Limpiar</button>
      </div>
    </div>
    <div class="grid cols-2" id="equiposList"></div>
  </section>

  <!-- GRÚAS -->
  <section id="gruas" class="page" hidden aria-labelledby="gruasTitle">
    <h1 id="gruasTitle">Puentes grúa</h1>
    <div class="card">
      <div class="grid" style="grid-template-columns: 1fr auto; align-items:center">
        <input id="gruasSearch" placeholder="Buscar por nave o referencia…">
        <button class="btn btn--ghost" id="gruasClear">Limpiar</button>
      </div>
    </div>
    <div class="grid cols-2" id="gruasList"></div>
  </section>

  <!-- AUXILIARES -->
  <section id="auxiliares" class="page" hidden aria-labelledby="auxTitle">
    <h1 id="auxTitle">Auxiliares (otros)</h1>
    <div class="card">
      <div class="grid" style="grid-template-columns: 1fr auto; align-items:center">
        <input id="auxSearch" placeholder="Buscar instalación auxiliar…">
        <button class="btn btn--ghost" id="auxClear">Limpiar</button>
      </div>
    </div>
    <div class="grid cols-2" id="auxList"></div>
  </section>

  <!-- INCIDENCIAS -->
  <section id="incidencias" class="page" hidden aria-labelledby="incTitle">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <h1 id="incTitle">Incidencias</h1>
      <button class="btn btn--primary" id="btnNewInc">Crear nueva incidencia</button>
    </div>

    <div class="card" id="incFormWrap" hidden>
      <div class="grid cols-2">
        <div>
          <label for="incEquipo">Equipo</label>
          <input id="incEquipo" list="equiposDatalist" placeholder="Escribe o selecciona…">

          <label for="incTipo">Tipo de fallo</label>
          <select id="incTipo">
            <option value="mecanico">Fallo mecánico</option>
            <option value="electrico">Fallo eléctrico</option>
            <option value="hidraulico">Fallo hidráulico</option>
            <option value="neumatico">Fallo neumático</option>
            <option value="proceso">Fallo de proceso productivo</option>
            <option value="desconocido">Origen desconocido</option>
          </select>

          <label for="incDesc">Descripción breve</label>
          <input id="incDesc" placeholder="Describe la avería…">
        </div>
        <div>
          <label for="incSol">Estado</label>
          <select id="incSol">
            <option value="no">No solucionado</option>
            <option value="si">Solucionado</option>
            <option value="restricciones">Con restricciones</option>
          </select>

          <div id="incSiWrap" hidden>
            <label for="incSolDesc">Descripción de la solución</label>
            <input id="incSolDesc" placeholder="¿Qué se hizo?">
            <label for="incSolRep">Repuestos empleados</label>
            <input id="incSolRep" placeholder="Escribe para buscar…">
          </div>

          <div id="incNoWrap">
            <label for="incNoDesc">Intervención realizada</label>
            <input id="incNoDesc" placeholder="Qué se ha hecho…">
            <label for="incNoRep">Repuestos empleados</label>
            <input id="incNoRep" placeholder="Opcional">
          </div>

          <label for="incReportadoPor">Reportado por</label>
          <select id="incReportadoPor">
            <option>administrador</option>
            <option>gerente</option>
            <option>encargado</option>
            <option>resp_produccion</option>
            <option>resp_turno</option>
            <option>externa</option>
          </select>

          <label for="incIntervenido">Intervenido por</label>
          <input id="incIntervenido" placeholder="Nombre del técnico…">

          <div class="grid cols-2">
            <div>
              <label for="incIni">Fecha de inicio</label>
              <input id="incIni" type="date">
            </div>
            <div>
              <label for="incFin">Fecha reparación</label>
              <input id="incFin" type="date">
            </div>
          </div>
        </div>
      </div>

      <div style="display:flex; gap:8px; margin-top:10px">
        <button class="btn btn--primary" id="incGuardar">Guardar</button>
        <button class="btn btn--ghost" id="incCancelar">Cancelar</button>
      </div>
    </div>

    <div class="card">
      <div class="card__hdr" style="display:flex; justify-content:space-between; align-items:center">
        <h2 class="card__title">Últimas incidencias</h2>
        <div style="display:flex; gap:8px">
          <input id="incFilter" placeholder="Filtrar por texto…">
          <button class="btn btn--ghost" id="incRecargar">Recargar</button>
        </div>
      </div>
      <div id="incList"></div>
    </div>
  </section>

  <!-- INVENTARIO -->
  <section id="inventario" class="page" hidden aria-labelledby="invTitle">
    <h1 id="invTitle">Inventario</h1>

    <div class="card">
      <div class="card__hdr" style="display:flex; justify-content:space-between; align-items:center">
        <h2 class="card__title">Estado de stock</h2>
        <div>
          <button class="btn btn--primary" id="btnAddRep">Añadir repuesto</button>
          <button class="btn btn--ghost" id="btnDelRep">Eliminar / descontar</button>
        </div>
      </div>
      <div id="invAlerts"></div>
    </div>

    <div class="card">
      <h2 class="card__title">Buscar</h2>
      <div style="display:flex; gap:8px; margin:10px 0; flex-wrap:wrap">
        <input id="invSearch" placeholder="Código, referencia, nombre…">
        <button class="btn btn--ghost" id="invClear">Limpiar</button>
        <button class="btn btn--ghost" id="btnScan">Escanear QR</button>
        <video id="scanVideo" playsinline style="display:none; width:100%; max-width:420px; border:1px solid var(--line); border-radius:12px; margin-top:8px"></video>
      </div>

      <div class="catgrid" id="invCats"><!-- categorías/contadores dinámicos --></div>
    </div>

    <div class="card">
      <h2 class="card__title">Inventario (CSV + QR)</h2>
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
        <input id="invCsvUrl" placeholder="URL CSV (ej: ./TOH_inventario_GitHubPages.csv)" style="flex:1 1 320px">
        <button class="btn btn--primary" id="invLoadCsv">Cargar CSV</button>
        <input type="file" id="invCsvFile" accept=".csv" style="display:none">
        <button class="btn btn--ghost" id="invPickCsv">Cargar archivo…</button>
        <button class="btn btn--ghost" id="invPrintQR">Imprimir QR seleccionados</button>
      </div>
      <div class="hint" style="margin-top:8px;color:#64748b;font-size:12px">
        Columnas admitidas: <strong>codigo|ref|sku</strong>, <strong>nombre|descripcion</strong>, <strong>ubicacion</strong>,
        <strong>stock|cantidad</strong>, <strong>minimo|stock_min</strong>.
      </div>
      <div id="invTableWrap" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- REPUESTOS (solicitudes) -->
  <section id="repuestos" class="page" hidden aria-labelledby="repTitle">
    <h1 id="repTitle">Repuestos</h1>
    <div class="card">
      <div class="grid cols-2">
        <div>
          <label for="reqRef">Repuesto (ref o nombre)</label>
          <input id="reqRef" placeholder="Ej. TOH-M12x60">
          <label for="reqQty">Cantidad</label>
          <input id="reqQty" type="number" min="1" value="1">
        </div>
        <div>
          <label for="reqObs">Observaciones</label>
          <input id="reqObs" placeholder="Urgente, alternativa, etc.">
          <button class="btn btn--primary" id="reqEnviar" style="margin-top:12px">Enviar solicitud</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card__hdr" style="display:flex; justify-content:space-between; align-items:center">
        <h2 class="card__title">Solicitudes</h2>
        <div class="badge" id="reqCountBadge">0</div>
      </div>
      <div id="reqList"></div>
    </div>
  </section>

  <!-- INDICADORES (gráficas en Parte 3) -->
  <section id="indicadores" class="page" hidden aria-labelledby="indTitle">
    <h1 id="indTitle">Indicadores</h1>
    <div class="grid cols-3">
      <article class="card">
        <h3 class="card__title">MTBF</h3>
        <canvas id="chMtbf" width="640" height="260"></canvas>
        <div class="kpi-foot">MTBF (Tiempo Medio Entre Fallos): horas promedio operativas entre dos fallos. Eje X: meses. Eje Y: horas.</div>
      </article>
      <article class="card">
        <h3 class="card__title">MTTR</h3>
        <canvas id="chMttr" width="640" height="260"></canvas>
        <div class="kpi-foot">MTTR (Tiempo Medio de Reparación): horas promedio desde que se inicia la intervención hasta que se finaliza. Eje Y: horas.</div>
      </article>
      <article class="card">
        <h3 class="card__title">Disponibilidad</h3>
        <canvas id="chDisp" width="640" height="260"></canvas>
        <div class="kpi-foot">Disponibilidad = Tiempo Operativo / Tiempo Total. Eje Y: % mensual.</div>
      </article>
    </div>
    <div style="margin-top:10px">
      <button class="btn btn--ghost" id="btnExpCSV">Exportar CSV</button>
    </div>
  </section>

  <!-- ÓRDENES DE TRABAJO -->
  <section id="ot" class="page" hidden aria-labelledby="otTitle">
    <h1 id="otTitle">Órdenes de trabajo</h1>
    <div class="card">
      <h2 class="card__title">Crear OT</h2>
      <div class="grid cols-3">
        <div>
          <label for="otEquipo">Equipo</label>
          <input id="otEquipo" list="equiposDatalist" placeholder="Escribe o selecciona…">
        </div>
        <div>
          <label for="otTipo">Tipo</label>
          <select id="otTipo">
            <option>Engrase</option>
            <option>Lubricación</option>
            <option>Ajuste mecánico</option>
            <option>Ajuste eléctrico</option>
          </select>
        </div>
        <div>
          <label for="otFecha">Fecha</label>
          <input id="otFecha" type="date">
        </div>
      </div>
      <label for="otTarea">Tarea</label>
      <input id="otTarea" placeholder="Describe la OT…">
      <div style="margin-top:10px">
        <button class="btn btn--primary" id="otCrear">Crear OT</button>
      </div>
    </div>

    <div class="card">
      <div class="card__hdr" style="display:flex; justify-content:space-between; align-items:center">
        <h2 class="card__title">Listado</h2>
        <div style="display:flex; gap:8px">
          <input id="otFilter" placeholder="Filtrar…">
          <button class="btn btn--ghost" id="otBorrarMode">Modo borrar</button>
        </div>
      </div>
      <div id="otList"></div>
    </div>
  </section>

</main>
<script>
/* =========================================================
   BLOQUE 3 (versión estable)
   - Helpers API (cdl*)
   - Inventario con ±1 / ±10 / ±100 / ±Paso
   - Reporte 24/48h (selector de rango)
   - Solicitar parada en Equipos/Grúas/Auxiliares
   - Dashboard: Paradas solicitadas (Aceptar/Denegar con permisos)
========================================================= */

/* ===== Config API ===== */
const API_URL = (typeof window.API_BASE==="string" && window.API_BASE)
  ? window.API_BASE
  : "https://script.google.com/macros/s/AKfycbycKrLO0jIEDXB_AZi91PopCj1uNXCOEu9zWHeqq_aK_DJo7TpWO_kKKWMs4exwyNRW/exec";

/* ===== Helpers API (prefijo cdl*) ===== */
const CDL_TOKEN_KEY = "cdl_token";

async function cdlApiGet(params){
  const qs = new URLSearchParams(params).toString();
  const res = await fetch(`${API_URL}?${qs}`, {cache:"no-store"});
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}
async function cdlApiPostAuth(body){
  const tok = localStorage.getItem(CDL_TOKEN_KEY)||"";
  const res = await fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({...body, token: tok})
  });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}
async function cdlEnsureLoginIfNeeded(){
  if(localStorage.getItem(CDL_TOKEN_KEY)) return true;
  const user = prompt("Usuario (Apps Script):","");
  const pass = prompt("Contraseña:","");
  if(!user||!pass) return false;
  const r = await cdlApiPostAuth({res:"auth",fn:"login",user,pass});
  if(r.ok && r.token){ localStorage.setItem(CDL_TOKEN_KEY, r.token); return true; }
  alert("Login fallido"); return false;
}

/* ===== Utils ===== */
function cdlSafeId(s){ return String(s).replace(/[^a-zA-Z0-9_-]/g,'_'); }

/* =========================================================
   INVENTARIO — Ajuste rápido y botones ±
========================================================= */
let cdlInvStep = 1;

function cdlInjectInventarioToolbar(){
  const sec = document.getElementById("inventario"); if(!sec) return;
  if(document.getElementById("invToolbar")) return;
  const card = document.createElement("div");
  card.className = "card";
  card.id = "invToolbar";
  card.innerHTML = `
    <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">
      <strong>Ajuste rápido</strong>
      <div style="display:flex;gap:6px;align-items:center">
        <button class="btn btn--ghost" data-step="1">±1</button>
        <button class="btn btn--ghost" data-step="10">±10</button>
        <button class="btn btn--ghost" data-step="100">±100</button>
      </div>
      <span id="invStepBadge" class="badge">Paso actual: 1</span>
    </div>`;
  const anchor = sec.querySelector(".card .card__hdr")?.parentElement || sec.firstElementChild;
  sec.insertBefore(card, anchor?.nextSibling || sec.firstChild);

  card.querySelectorAll("[data-step]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      cdlInvStep = Number(btn.getAttribute("data-step"));
      const badge = document.getElementById("invStepBadge");
      if(badge) badge.textContent = `Paso actual: ${cdlInvStep}`;
    });
  });
}

async function cdlRenderInventario(){
  cdlInjectInventarioToolbar();
  const wrap = document.getElementById("invCats"); if(!wrap) return;
  wrap.innerHTML = `<div style="padding:8px; color:#64748b">Cargando inventario…</div>`;
  try{
    const data = await cdlApiGet({res:"inv",fn:"list"});
    const items = (data.items||[]).slice().sort((a,b)=>a.nombre.localeCompare(b.nombre));
    wrap.innerHTML = items.map(it=>{
      const low = Number(it.stock)<=Number(it.minimo);
      const rid = cdlSafeId(it.ref);
      const refEnc = encodeURIComponent(it.ref);
      return `
        <div class="card" style="display:grid;grid-template-columns:1fr auto auto;align-items:center;gap:10px">
          <div>
            <div style="font-weight:800">${it.nombre}</div>
            <div style="font-size:12px;color:#64748b">Ref: <b>${it.ref}</b> · Mín.: ${it.minimo}</div>
          </div>
          <div class="badge" style="${low?'background:#fee2e2;color:#991b1b;border-color:#fecaca':''}">
            Stock: <span id="stk_${rid}">${it.stock}</span>
          </div>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <div style="display:flex;gap:4px">
              <button class="btn btn--ghost" onclick="cdlInvDelta('${refEnc}',-1)">−1</button>
              <button class="btn btn--primary" onclick="cdlInvDelta('${refEnc}',+1)">+1</button>
            </div>
            <div style="display:flex;gap:4px">
              <button class="btn btn--ghost" onclick="cdlInvDelta('${refEnc}',-10)">−10</button>
              <button class="btn btn--primary" onclick="cdlInvDelta('${refEnc}',+10)">+10</button>
            </div>
            <div style="display:flex;gap:4px">
              <button class="btn btn--ghost" onclick="cdlInvDelta('${refEnc}',-100)">−100</button>
              <button class="btn btn--primary" onclick="cdlInvDelta('${refEnc}',+100)">+100</button>
            </div>
            <div style="display:flex;gap:4px">
              <button class="btn btn--ghost" onclick="cdlInvDelta('${refEnc}',-cdlInvStep)">−Paso</button>
              <button class="btn btn--primary" onclick="cdlInvDelta('${refEnc}',+cdlInvStep)">+Paso</button>
            </div>
          </div>
        </div>`;
    }).join("") || `<div class="card">Sin datos de inventario</div>`;
  }catch(e){
    wrap.innerHTML = `<div class="card">No se pudo cargar inventario</div>`;
    console.error(e);
  }
}
async function cdlInvDelta(refEncoded,delta){
  try{
    const ok = await cdlEnsureLoginIfNeeded(); if(!ok) return;
    const ref = decodeURIComponent(refEncoded);
    const r = await cdlApiPostAuth({res:"inv",fn:"delta",ref,delta});
    if(r.ok){
      const rid = cdlSafeId(r.ref);
      const el = document.getElementById(`stk_${rid}`);
      if(el) el.textContent = r.stock;
    }else{
      alert(r.error||"Error");
    }
  }catch(e){ alert("Error actualizando"); console.error(e); }
}

/* =========================================================
   Reporte 24/48 h (solo botón visible para Admin/Gerente)
========================================================= */
function cdlShowReportButtonByRole(){
  const chip = (document.getElementById("roleChip")||{}).textContent||"Invitado";
  const role = chip.toLowerCase();
  const isManager = /administrador|gerente/.test(role);
  const hero = document.querySelector("#dashboard .hero");
  if(!hero) return;
  const id="btnRpt24";
  let btn=document.getElementById(id);
  if(btn) btn.remove();
  if(isManager){
    btn = document.createElement("button");
    btn.id=id; btn.className="btn btn--primary";
    btn.style.marginTop="10px";
    btn.textContent="Reporte 24/48 horas";
    btn.onclick=()=>location.hash="#reporte";
    hero.appendChild(btn);
  }
}
function cdlMountReportPage(){
  if(document.getElementById("reporte")) return;
  const main = document.getElementById("appRoot");
  const sec = document.createElement("section");
  sec.id="reporte"; sec.className="page"; sec.hidden=true;
  sec.setAttribute("aria-labelledby","repTitle2");
  sec.innerHTML = `
    <h1 id="repTitle2">Reporte</h1>
    <div class="card">
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <label for="repRange" class="visually-hidden">Rango</label>
        <select id="repRange" class="btn btn--ghost" style="padding:8px 10px">
          <option value="24">Últimas 24 h</option>
          <option value="48">Últimas 48 h</option>
          <option value="168">Última semana</option>
          <option value="336">Últimas 2 semanas</option>
          <option value="720">Último mes (~30d)</option>
          <option value="4320">Últimos 6 meses</option>
          <option value="8760">Último año</option>
        </select>
        <button class="btn btn--primary" id="repReload">Actualizar</button>
      </div>
    </div>
    <div class="grid" id="repGrid" style="grid-template-columns:1fr; margin-top:10px"></div>
    <p class="hint" style="margin-top:6px">Consolida incidencias, ajustes de stock, solicitudes y cambios de estado dentro del periodo.</p>
  `;
  main.appendChild(sec);
  document.getElementById("repReload").onclick = cdlLoadReport;
  document.getElementById("repRange").onchange = cdlLoadReport;
}
function cdlHoursAgoISO(h){
  const d=new Date(Date.now()-h*3600*1000);
  return d.toISOString().slice(0,19);
}
async function cdlLoadReport(){
  const grid = document.getElementById("repGrid");
  grid.innerHTML = `<div class="card">Generando…</div>`;
  const h = Number(document.getElementById("repRange").value||24);
  const since = cdlHoursAgoISO(h);

  try{
    const incid = await cdlApiGet({res:"incid",fn:"list"});
    const rep   = await cdlApiGet({res:"rep",fn:"list"});
    const logs  = await cdlApiGet({res:"logs",fn:"list"});

    const inRange = (ts)=>!ts || String(ts)>=since;

    const incR      = (incid.items||[]).filter(x=>inRange(x.created));
    const repR      = (rep.items||[]).filter(x=>inRange(x.created));
    const stateLogs = (logs.items||[]).filter(l=>l.accion==="set_state" && inRange(l.ts));
    const invLogs   = (logs.items||[]).filter(l=>l.accion==="delta_inv" && inRange(l.ts));

    grid.innerHTML = `
      <div class="card">
        <h3 class="card__title">Incidencias registradas</h3>
        ${incR.length?incR.map(i=>`
          <div class="line-1">[${i.created?.slice(0,16)||""}] <b>${i.equipo}</b> — ${i.tipo} · ${i.res} · ${i.desc||""}</div>
        `).join(""):`<div class="line-1">Sin cambios</div>`}
        <p class="hint">Nuevas/modificadas en el periodo.</p>
      </div>

      <div class="card">
        <h3 class="card__title">Solicitudes de repuestos</h3>
        ${repR.length?repR.map(r=>`
          <div class="line-1">[${r.created?.slice(0,16)||""}] <b>${r.ref}</b> ${r.nombre} — ${r.solicitante} · ${r.estado}</div>
        `).join(""):`<div class="line-1">Sin solicitudes</div>`}
        <p class="hint">Altas y estado actual.</p>
      </div>

      <div class="card">
        <h3 class="card__title">Cambios de estado de equipos</h3>
        ${stateLogs.length?stateLogs.map(s=>`
          <div class="line-1">[${String(s.ts).slice(0,16)}] ${s.obj} — ${s.detalle}</div>
        `).join(""):`<div class="line-1">Sin cambios</div>`}
        <p class="hint">Transiciones registradas en logs.</p>
      </div>

      <div class="card">
        <h3 class="card__title">Ajustes de stock</h3>
        ${invLogs.length?invLogs.map(l=>`
          <div class="line-1">[${String(l.ts).slice(0,16)}] ${l.obj}</div>
        `).join(""):`<div class="line-1">Sin ajustes</div>`}
        <p class="hint">Entradas/salidas (delta_inv).</p>
      </div>
    `;
  }catch(e){
    console.error(e);
    grid.innerHTML = `<div class="card">No se pudo generar el reporte</div>`;
  }
}

/* =========================================================
   “Solicitar parada” (Equipos/Grúas/Auxiliares)
========================================================= */
function cdlInjectSolicitarParada(pageId){
  const page = document.getElementById(pageId); if(!page) return;
  if(page.querySelector(".sol-parada")) return;
  const bar = document.createElement("div");
  bar.className="sol-parada";
  bar.innerHTML = `
    <div class="card" style="margin-bottom:12px">
      <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">
        <button class="btn btn--primary" id="btnSP_${pageId}">Solicitar parada</button>
        <input id="spSearch_${pageId}" placeholder="Buscar equipo…" style="flex:1;min-width:220px">
        <select id="spSel_${pageId}" style="padding:10px;border:1px solid var(--line);border-radius:10px;min-width:220px"></select>
        <button class="btn btn--primary" id="btnSP2_${pageId}">Enviar solicitud</button>
      </div>
      <p class="hint">Se notificará por correo a Administración (y más adelante a Producción).</p>
    </div>`;
  page.insertBefore(bar, page.firstChild);

  cdlApiGet({res:"state",fn:"list"}).then(r=>{
    const sel = document.getElementById(`spSel_${pageId}`);
    const items = (r.items||[]).slice().sort((a,b)=>a.grupo.localeCompare(b.grupo)||a.nombre.localeCompare(b.nombre));
    sel.innerHTML = items.map(i=>`<option value="${i.nombre}">[${i.grupo}] ${i.nombre}</option>`).join("");
  });

  const inp = document.getElementById(`spSearch_${pageId}`);
  const sel = document.getElementById(`spSel_${pageId}`);
  inp?.addEventListener("input", ()=>{
    const term = inp.value.toLowerCase();
    Array.from(sel.options).forEach(o=>{ o.hidden = !o.textContent.toLowerCase().includes(term); });
  });

  const send = async ()=>{
    const ok = await cdlEnsureLoginIfNeeded(); if(!ok) return;
    const equipo = sel.value;
    if(!equipo){ alert("Selecciona un equipo"); return;}
    try{
      const r = await cdlApiPostAuth({res:"alert",fn:"parada",equipo});
      if(r.ok){ alert("Solicitada la parada. Se ha notificado por correo."); }
      else    { alert(r.error||"No se pudo solicitar"); }
    }catch(e){ alert("Error de red"); console.error(e); }
  };
  document.getElementById(`btnSP_${pageId}`).onclick  = send;
  document.getElementById(`btnSP2_${pageId}`).onclick = send;
}

/* =========================================================
   DASHBOARD — Paradas solicitadas (listado + acciones)
   Permisos: administrador, gerente, encargado, resp_produccion
========================================================= */
function cdlRoleCanApprove(){
  const chip = (document.getElementById("roleChip")||{}).textContent || "Invitado";
  const raw  = chip.toLowerCase();
  const norm = raw
    .replace(/\s+/g,'_')
    .replace(/[áà]/g,'a').replace(/[éè]/g,'e')
    .replace(/[íì]/g,'i').replace(/[óò]/g,'o')
    .replace(/[úù]/g,'u');
  return /(administrador|gerente|encargado|resp_produccion|produccion)/.test(norm);
}
function cdlEnsureParadasCard(){
  const grid = document.querySelector('#dashboard .grid.dash-grid');
  if(!grid) return null;
  let card = document.getElementById('card-paradas');
  if(card) return card;

  card = document.createElement('article');
  card.className = 'card card--dash';
  card.id = 'card-paradas';
  card.innerHTML = `
    <h2 class="card__title big">
      <span class="black">PARADAS</span> <span class="red">SOLICITADAS</span>
      <span class="badge" id="stopCountBadge">0</span>
    </h2>
    <div class="grid" style="grid-template-columns:repeat(3,1fr); gap:12px">
      <div>
        <div class="badge" style="margin-bottom:6px">Pendientes · <span id="stopPendCount">0</span></div>
        <div id="stopPend"></div>
      </div>
      <div>
        <div class="badge" style="margin-bottom:6px">Aprobadas · <span id="stopOkCount">0</span></div>
        <div id="stopOk"></div>
      </div>
      <div>
        <div class="badge" style="margin-bottom:6px">Denegadas · <span id="stopNoCount">0</span></div>
        <div id="stopNo"></div>
      </div>
    </div>
  `;
  grid.appendChild(card);
  return card;
}
function cdlRenderStopList(list, hostId, emptyTxt){
  const host = document.getElementById(hostId);
  if(!host) return;

  if(!list.length){
    host.innerHTML = `<div class="line-1" style="color:#64748b">${emptyTxt}</div>`;
    return;
  }
  const canApprove = cdlRoleCanApprove();
  host.innerHTML = list.map(it=>{
    const ts = String(it.created||'').slice(0,16);
    const actions = canApprove && (String(it.estado||'').toLowerCase()==='pendiente')
      ? `<div style="display:flex;gap:6px;margin-top:6px">
           <button class="btn btn--primary"  onclick="cdlStopSet('${it.id}','Aprobada')">Aceptar</button>
           <button class="btn btn--ghost"    onclick="cdlStopSet('${it.id}','Denegada')">Denegar</button>
         </div>`
      : '';
    return `<div class="line-1" style="padding:8px 10px; border:1px dashed var(--line); border-radius:10px; margin:6px 0">
              [${ts}] <b>${it.equipo}</b> — ${it.solicitante||'—'} · <i>${it.estado}</i>
              ${actions}
            </div>`;
  }).join('');
}
async function cdlLoadParadas(){
  const card = cdlEnsureParadasCard();
  if(!card) return;
  try{
    const r = await cdlApiGet({res:'stop', fn:'list'});
    const items = r.items || [];
    const pend = items.filter(x=>/pend/i.test(x.estado||''));
    const ok   = items.filter(x=>/aprob/i.test(x.estado||''));
    const no   = items.filter(x=>/deneg/i.test(x.estado||''));

    const setTxt = (id, v)=>{ const el=document.getElementById(id); if(el) el.textContent=v; };
    setTxt('stopCountBadge', items.length);
    setTxt('stopPendCount',  pend.length);
    setTxt('stopOkCount',    ok.length);
    setTxt('stopNoCount',    no.length);

    cdlRenderStopList(pend, 'stopPend', 'Sin solicitudes pendientes');
    cdlRenderStopList(ok,   'stopOk',   'Sin aprobadas');
    cdlRenderStopList(no,   'stopNo',   'Sin denegadas');
  }catch(e){
    console.error(e);
    ['stopPend','stopOk','stopNo'].forEach(id=>{
      const host=document.getElementById(id);
      if(host) host.innerHTML=`<div class="line-1">No se pudo cargar</div>`;
    });
  }
}
async function cdlStopSet(id, estado){
  try{
    const ok = await cdlEnsureLoginIfNeeded(); if(!ok) return;
    const r = await cdlApiPostAuth({res:'stop', fn:'set', id, estado, comentario:''});
    if(!r.ok){ alert(r.error||'Error'); return; }
    await cdlLoadParadas();
  }catch(err){
    console.error(err);
    alert('Error de red');
  }
}

/* =========================================================
   Hook de navegación (monta todo y reactiva en cada hash)
========================================================= */
function cdlAfterNavigation(){
  cdlShowReportButtonByRole();
  cdlMountReportPage();
  if(location.hash==="#reporte"){ cdlLoadReport(); }
  ["equipos","gruas","auxiliares"].forEach(cdlInjectSolicitarParada);
  if(!document.getElementById("inventario")?.hidden) cdlRenderInventario();
}
window.addEventListener("hashchange", cdlAfterNavigation);
document.addEventListener("DOMContentLoaded", cdlAfterNavigation);
setTimeout(cdlAfterNavigation, 300);
</script>
<script>
/* ===== NAV + PANEL USUARIO (abrir/cerrar + routing hash) ===== */
(function(){
  const body = document.body;
  const hdr  = document.getElementById('hdr');
  const sidenav   = document.getElementById('sidenav');
  const navList   = document.getElementById('navList');
  const hamb      = document.getElementById('hamb');
  const closeNav  = document.getElementById('closeNav');
  const moreBtn   = document.getElementById('moreBtn');
  const userPanel = document.getElementById('userPanel');
  const closeUser = document.getElementById('closeUser');

  const openNav = () => {
    sidenav.classList.add('open');
    body.classList.add('menu-open');
    hamb?.setAttribute('aria-expanded','true');
    sidenav?.setAttribute('aria-hidden','false');
  };
  const closeNavFn = () => {
    sidenav.classList.remove('open');
    body.classList.remove('menu-open');
    hamb?.setAttribute('aria-expanded','false');
    sidenav?.setAttribute('aria-hidden','true');
  };

  hamb?.addEventListener('click', (e)=>{ e.stopPropagation(); openNav(); });
  closeNav?.addEventListener('click', closeNavFn);
  // Cierre al tocar fuera del menú
  document.addEventListener('click', (e)=>{
    if (body.classList.contains('menu-open') && !sidenav.contains(e.target) && !hamb.contains(e.target)) {
      closeNavFn();
    }
  });

  // Panel usuario (… botón de tres puntos)
  const toggleUser = () => {
    const show = !userPanel.classList.contains('show');
    userPanel.classList.toggle('show', show);
    moreBtn?.setAttribute('aria-expanded', String(show));
  };
  moreBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); toggleUser(); });
  closeUser?.addEventListener('click', ()=> userPanel.classList.remove('show'));
  document.addEventListener('click', (e)=>{
    if (userPanel.classList.contains('show') && !userPanel.contains(e.target) && !moreBtn.contains(e.target)) {
      userPanel.classList.remove('show');
      moreBtn?.setAttribute('aria-expanded','false');
    }
  });

  // Sombra cabecera al desplazar
  window.addEventListener('scroll', ()=>{ hdr?.classList.toggle('scrolled', window.scrollY > 6); });

  // Construir navegación y routing por hash
  if (navList) {
    const items = [
      ['#dashboard','Dashboard'],
      ['#equipos','Equipos'],
      ['#gruas','Puentes grúa'],
      ['#auxiliares','Auxiliares'],
      ['#incidencias','Incidencias'],
      ['#inventario','Inventario'],
      ['#repuestos','Repuestos'],
      ['#indicadores','Indicadores'],
      ['#ot','Órdenes de trabajo'],
    ];
    navList.innerHTML = items.map(([href,label])=> `<a href="${href}">${label}</a>`).join('');
  }

  function markCurrent(){
    const hash = location.hash || '#dashboard';
    // marcar enlace activo
    navList?.querySelectorAll('a').forEach(a=>{
      a.setAttribute('aria-current', a.getAttribute('href') === hash ? 'page' : 'false');
    });
    // mostrar/ocultar secciones
    document.querySelectorAll('.page').forEach(sec=>{
      sec.hidden = ('#' + sec.id) !== hash;
    });
    // cerrar menú al navegar
    closeNavFn();
  }
  window.addEventListener('hashchange', markCurrent);
  document.addEventListener('DOMContentLoaded', markCurrent);
  markCurrent();

  // Ajuste iPhone SE: header menos alto
  const mqSE = window.matchMedia('(max-width: 360px)');
  const applySE = () => {
    if (mqSE.matches) document.documentElement.style.setProperty('--hdr-h','100px');
  };
  applySE(); mqSE.addEventListener?.('change', applySE);
})();
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js', { scope: './' }).then(reg => {
      reg.addEventListener('updatefound', () => {
        const nw = reg.installing;
        nw?.addEventListener('statechange', () => {
          if (nw.state === 'installed' && navigator.serviceWorker.controller) {
            // Mostrar prompt y forzar actualizar
            if (confirm('Hay una nueva versión. ¿Actualizar ahora?')) {
              nw.postMessage({ type: 'SKIP_WAITING' });
            }
          }
        });
      });
    });

    // Recarga al cambiar el controlador (tras skipWaiting/clientsClaim)
    let refreshing = false;
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      if (!refreshing) { refreshing = true; location.reload(); }
    });
  });
}
</script>
</body>
</html>